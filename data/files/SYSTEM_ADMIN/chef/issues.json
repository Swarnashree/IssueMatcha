[{"title":"Deprecate osx_profile resource since it can longer silently install profiles","body":"## Context\r\n\r\nIn 2020, Apple dropped support for non-interactively installing configuration profiles. The final macOS version to support this was macOS Catalina (version 10.15), which was released in 2019 and [stopped receiving security updates in 2022](https:\/\/support.apple.com\/en-us\/HT201222).\r\n\r\nThis change was only really documented in the man page for the `profiles` tool:\r\n\r\n```\r\nDESCRIPTION\r\n     profiles is used to handle various profile types on macOS.   Starting with macOS 11.0 (profiles tool 8.0 or later), this tool cannot be\r\n         used to install configuration profiles.  You should add your profiles using the System Settings Profiles\r\n         preference pane.    Additionally, startup profiles are no longer supported.\r\n```\r\n\r\nFrustratingly, this requires access to a macOS device because [Apple doesn't publish man pages online](https:\/\/apple.stackexchange.com\/questions\/239484\/does-apple-provide-a-web-site-with-content-of-man-pages-for-the-command-line-c) and the `profiles` tool is nonfree\/proprietary so there's no public source code to link as documentation.\r\n\r\nThis line in a video transcript of a June 2020 dev talk is the closest I can get to an Apple statement on the subject:\r\n\r\n> As of macOS Big Sur, you will no longer be able to completely install profiles using Terminal.\r\n\r\nhttps:\/\/developer.apple.com\/videos\/play\/wwdc2020\/10639\/?time=629\r\n\r\n## Motivation\r\n\r\n```\r\nAs a Chef user,\r\nI want Chef core resources to match my expectations,\r\nso that using Chef is easier.\r\n```\r\n(copied from [RFC-98 Deprecate deploy and erl_call](https:\/\/github.com\/chef-boneyard\/chef-rfc\/blob\/master\/rfc098-deprecate-deploy-and-erlcall-resources.md))\r\n\r\n## Specification\r\n\r\nSince this resource can't install new profiles, it [doesn't really do anything useful](https:\/\/github.com\/chef\/chef\/issues\/10075) on currently-supported versions of macOS.\r\n\r\nAnyone who was using this resource has almost certainly replaced it with MDM-managed profiles a long time ago, since the overlap between having an MDM server and needing config profiles on nodes should be near 1:1. This could be marked as deprecated in the next Chef Infra 18 release and eventually removed in either Chef Infra 19 or 20.\r\n\r\n## Downstream Impact\r\n\r\nI searched Github for repos referencing `osx_profile` and didn't find any repos that were updated in the last five years.","comments":["I would be so bold and say it should be **fully removed without any deprecation notice**, since Chef currently only supports macOS 12 and higher. https:\/\/docs.chef.io\/platforms\/\r\n\r\n```\r\nPlatform and Version | Vendor End-of-Life Date | Chef End-of-Life Date\r\n-- | -- | --\r\nApple macOS 11 | Sep 26, 2023 | Sep 26, 2023\r\n-- | -- | --\r\n```\r\n\r\nIf you attempt to use this resource on a support version of macOS, chef will fail without explicitly marking as `ignore_failure true`"],"labels":["Status: Untriaged"]},{"title":"Bump omnibus-software from `40ca2a9` to `842b603` in \/omnibus","body":"Bumps [omnibus-software](https:\/\/github.com\/chef\/omnibus-software) from `40ca2a9` to `842b603`.\n<details>\n<summary>Commits<\/summary>\n<ul>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/842b603cf83fb82b5c6cf69763a3ac9db9790a35\"><code>842b603<\/code><\/a> Merge pull request <a href=\"https:\/\/redirect.github.com\/chef\/omnibus-software\/issues\/1865\">#1865<\/a> from chef\/CHEF-8427-gtar-version-update<\/li>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/70d6b70d62a96f8235b77ec5c372c5147d1279d4\"><code>70d6b70<\/code><\/a> added version 1.35 to version list<\/li>\n<li>See full diff in <a href=\"https:\/\/github.com\/chef\/omnibus-software\/compare\/40ca2a902ff20905aaa36ca35b1701fba8812160...842b603cf83fb82b5c6cf69763a3ac9db9790a35\">compare view<\/a><\/li>\n<\/ul>\n<\/details>\n<br \/>\n\n\nDependabot will resolve any conflicts with this PR as long as you don't alter it yourself. You can also trigger a rebase manually by commenting `@dependabot rebase`.\n\n[\/\/]: # (dependabot-automerge-start)\n[\/\/]: # (dependabot-automerge-end)\n\n---\n\n<details>\n<summary>Dependabot commands and options<\/summary>\n<br \/>\n\nYou can trigger Dependabot actions by commenting on this PR:\n- `@dependabot rebase` will rebase this PR\n- `@dependabot recreate` will recreate this PR, overwriting any edits that have been made to it\n- `@dependabot merge` will merge this PR after your CI passes on it\n- `@dependabot squash and merge` will squash and merge this PR after your CI passes on it\n- `@dependabot cancel merge` will cancel a previously requested merge and block automerging\n- `@dependabot reopen` will reopen this PR if it is closed\n- `@dependabot close` will close this PR and stop Dependabot recreating it. You can achieve the same result by closing it manually\n- `@dependabot show <dependency name> ignore conditions` will show all of the ignore conditions of the specified dependency\n- `@dependabot ignore this major version` will close this PR and stop Dependabot creating any more for this major version (unless you reopen the PR or upgrade to it yourself)\n- `@dependabot ignore this minor version` will close this PR and stop Dependabot creating any more for this minor version (unless you reopen the PR or upgrade to it yourself)\n- `@dependabot ignore this dependency` will close this PR and stop Dependabot creating any more for this dependency (unless you reopen the PR or upgrade to it yourself)\n\n\n<\/details>","comments":["## [![Quality Gate Passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/qg-passed-20px.png 'Quality Gate Passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14268) **Quality Gate passed**  \nIssues  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0 New issues](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14268&resolved=false&inNewCodePeriod=true)  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/accepted-16px.png '') [0 Accepted issues](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14268&metric=new_accepted_issues&view=list)\n\nMeasures  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14268&resolved=false&inNewCodePeriod=true)  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/no-data-16px.png '') No data about Coverage  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/no-data-16px.png '') No data about Duplication  \n  \n[See analysis details on SonarCloud](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14268)\n\n"],"labels":["Type: Chore"]},{"title":"Bump omnibus-software from `86649fa` to `842b603` in \/omnibus","body":"Bumps [omnibus-software](https:\/\/github.com\/chef\/omnibus-software) from `86649fa` to `842b603`.\n<details>\n<summary>Commits<\/summary>\n<ul>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/842b603cf83fb82b5c6cf69763a3ac9db9790a35\"><code>842b603<\/code><\/a> Merge pull request <a href=\"https:\/\/redirect.github.com\/chef\/omnibus-software\/issues\/1865\">#1865<\/a> from chef\/CHEF-8427-gtar-version-update<\/li>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/70d6b70d62a96f8235b77ec5c372c5147d1279d4\"><code>70d6b70<\/code><\/a> added version 1.35 to version list<\/li>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/40ca2a902ff20905aaa36ca35b1701fba8812160\"><code>40ca2a9<\/code><\/a> Merge pull request <a href=\"https:\/\/redirect.github.com\/chef\/omnibus-software\/issues\/1876\">#1876<\/a> from chef\/CHEF-10219-update-open-jre-to-11-0-21<\/li>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/fff30b0ffb78f1becf2f7c5e31888e2826986f77\"><code>fff30b0<\/code><\/a> Update open-jre-11.0.21<\/li>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/8e647fec6cd592628f6914ab96a2b1404543a303\"><code>8e647fe<\/code><\/a> Executed '.expeditor\/determine_version.sh'<\/li>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/6d0b9ac13cad1b2e9a51491cdd3cc7d311dbbb8f\"><code>6d0b9ac<\/code><\/a> Merge pull request <a href=\"https:\/\/redirect.github.com\/chef\/omnibus-software\/issues\/1877\">#1877<\/a> from chef\/dummypr\/muthuja<\/li>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/76c8e6d1340c71fdc8f435b6745498a4d0c01124\"><code>76c8e6d<\/code><\/a> it is just dummy pr to check bump version<\/li>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/57d57bc1ab469d0f9d4910b9e9d9944fa10eb986\"><code>57d57bc<\/code><\/a> Merge pull request <a href=\"https:\/\/redirect.github.com\/chef\/omnibus-software\/issues\/1873\">#1873<\/a> from chef\/Add\/openssl_3.0.9_to_versionlist\/muthuja<\/li>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/7388b00a14205dd0ef8aec6608a7f65c25859d81\"><code>7388b00<\/code><\/a> Build OpenSSL 3.x and Ruby &lt; 3.1<\/li>\n<li><a href=\"https:\/\/github.com\/chef\/omnibus-software\/commit\/9d0fd56137fd5c790cd07c340dfc5ba30e554968\"><code>9d0fd56<\/code><\/a> Executed '.expeditor\/determine_version.sh'<\/li>\n<li>Additional commits viewable in <a href=\"https:\/\/github.com\/chef\/omnibus-software\/compare\/86649fa63c1c1ef83371404d5dd08b095ef9cbd8...842b603cf83fb82b5c6cf69763a3ac9db9790a35\">compare view<\/a><\/li>\n<\/ul>\n<\/details>\n<br \/>\n\n\nDependabot will resolve any conflicts with this PR as long as you don't alter it yourself. You can also trigger a rebase manually by commenting `@dependabot rebase`.\n\n[\/\/]: # (dependabot-automerge-start)\n[\/\/]: # (dependabot-automerge-end)\n\n---\n\n<details>\n<summary>Dependabot commands and options<\/summary>\n<br \/>\n\nYou can trigger Dependabot actions by commenting on this PR:\n- `@dependabot rebase` will rebase this PR\n- `@dependabot recreate` will recreate this PR, overwriting any edits that have been made to it\n- `@dependabot merge` will merge this PR after your CI passes on it\n- `@dependabot squash and merge` will squash and merge this PR after your CI passes on it\n- `@dependabot cancel merge` will cancel a previously requested merge and block automerging\n- `@dependabot reopen` will reopen this PR if it is closed\n- `@dependabot close` will close this PR and stop Dependabot recreating it. You can achieve the same result by closing it manually\n- `@dependabot show <dependency name> ignore conditions` will show all of the ignore conditions of the specified dependency\n- `@dependabot ignore this major version` will close this PR and stop Dependabot creating any more for this major version (unless you reopen the PR or upgrade to it yourself)\n- `@dependabot ignore this minor version` will close this PR and stop Dependabot creating any more for this minor version (unless you reopen the PR or upgrade to it yourself)\n- `@dependabot ignore this dependency` will close this PR and stop Dependabot creating any more for this dependency (unless you reopen the PR or upgrade to it yourself)\n\n\n<\/details>","comments":["## [![Quality Gate Passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/qg-passed-20px.png 'Quality Gate Passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14265) **Quality Gate passed**  \nIssues  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0 New issues](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14265&resolved=false&inNewCodePeriod=true)  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/accepted-16px.png '') [0 Accepted issues](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14265&metric=new_accepted_issues&view=list)\n\nMeasures  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14265&resolved=false&inNewCodePeriod=true)  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/no-data-16px.png '') No data about Coverage  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/no-data-16px.png '') No data about Duplication  \n  \n[See analysis details on SonarCloud](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14265)\n\n"],"labels":["Type: Chore"]},{"title":"OpenSSL 3.0.9 upgrade - merge after 17.11.x","body":"<!--- Provide a short summary of your changes in the Title above -->\r\n\r\n## Description\r\n<!--- Describe your changes in detail, what problems does it solve? -->\r\n\r\n## Related Issue\r\n<!--- If you are suggesting a new feature or change, please create an issue first -->\r\n<!--- Please link to the issue, discourse, or stackoverflow here: -->\r\n\r\n## Types of changes\r\n<!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: -->\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [ ] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n<!--- If you're unsure about any of these, don't hesitate to ask. We're here to help! -->\r\n- [ ] I have read the **CONTRIBUTING** document.\r\n- [ ] I have run the pre-merge tests locally and they pass.\r\n- [ ] I have updated the documentation accordingly.\r\n- [ ] I have added tests to cover my changes.\r\n- [ ] If `Gemfile.lock` has changed, I have used `--conservative` to do it and included the full output in the Description above.\r\n- [ ] All new and existing tests passed.\r\n- [ ] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["## [![Quality Gate Passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/qg-passed-20px.png 'Quality Gate Passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14263) **Quality Gate passed**  \nIssues  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0 New issues](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14263&resolved=false&inNewCodePeriod=true)  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/accepted-16px.png '') [0 Accepted issues](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14263&metric=new_accepted_issues&view=list)\n\nMeasures  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14263&resolved=false&inNewCodePeriod=true)  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/no-data-16px.png '') No data about Coverage  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0.0% Duplication on New Code](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14263&metric=new_duplicated_lines_density&view=list)  \n  \n[See analysis details on SonarCloud](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14263)\n\n"],"labels":["Do Not Merge","Status: Waiting on Release","Chef 17.12"]},{"title":"apt_repository should not use deprecated apt-key anymore","body":"### Describe the Enhancement:\r\nThe `apt_repository` ressource (as of Chef 18 as well as on `master`) [leverages `apt-key add`](https:\/\/github.com\/chef\/chef\/blob\/718b2ef032da1cfd0132934707cb4abb1d292930\/lib\/chef\/resource\/apt_repository.rb#L303=) to import the repository signing key.\r\nThis way of importing the key has been deprecated for security reason (it trusts all packages from the repository instead of only the installed package) and will be last available in Debian 11 and Ubuntu 22.04.\r\nSources:\r\n- https:\/\/itsfoss.com\/apt-key-deprecated\/\r\n- https:\/\/www.linuxuprising.com\/2021\/01\/apt-key-is-deprecated-how-to-add.html\r\n\r\n### Describe the Need:\r\nWe need to refactor the  `apt_repository` to use this more complex method instead:\r\n```\r\nwget -O- <https:\/\/example.com\/key\/repo-key.gpg> | gpg --dearmor | sudo tee \/usr\/share\/keyrings\/<myrepository>-archive-keyring.gpg\r\n```\r\n\r\n### Current Alternative\r\nAs a workaround, one can use the `execute` resource to import the key before `apt_repository`\r\n\r\n### Can We Help You Implement This?:\r\nI'm willing to prepare a pull request. Let me know you opinion and if you think it's needed to keep `apt-key add` as a fallback method for older Ubuntu\/Debian releases (I'm testing on Ubuntu 22.04)","comments":[],"labels":["Status: Untriaged"]},{"title":"chef_client_config errors out for bool property","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nWhen I tried to set a bool property inside chef_client_config resource, like \r\n\r\n- policy_persist_run_list\r\n- minimal_ohai\r\n\r\nthe chef compilation fails with the following error:\r\n\r\n```\r\n        template(\"\/etc\/cinc\/client.rb\") do\r\n        action [:create]\r\n        default_guard_interpreter :default\r\n        source \"\/opt\/cinc\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.16.13\/lib\/chef\/resource\/support\/client.erb\"\r\n        declared_type :template\r\n        cookbook_name \"system-base\"\r\n        owner \"root\"\r\n        group \"root\"\r\n        local true\r\n        variables {:chef_license=>\"accept\", :chef_server_url=>\"chefzero:\/\/localhost:1\", :event_loggers=>[], :exception_handlers=>[], :file_backup_path=>\"\/var\/lib\/chef\", :file_cache_path=>\"\/var\/chef\/cache\", :file_staging_uses_destdir=>nil, :formatters=>[], :http_proxy=>nil, :https_proxy=>nil, :ftp_proxy=>nil, :log_level=>:info, :log_location=>\"\/var\/log\/chef\/client.log\", :minimal_ohai=>false, :named_run_list=>nil, :no_proxy=>\"\", :node_name=>\"wgao-redhat-79\", :ohai_disabled_plugins=>[], :ohai_optional_plugins=>[], :pid_file=>\"var\/run\/chef\/client.pid\", :policy_group=>nil, :policy_name=>nil, :report_handlers=>[], :ssl_verify_mode=>:verify_none, :start_handlers=>[], :additional_config=>nil}\r\n        mode \"0640\"\r\n        path \"\/etc\/cinc\/client.rb\"\r\n        verifications []\r\n             end\r\n             \r\n             Template Context:\r\n             -----------------\r\n             on line #22\r\n       20:       @policy_name\r\n       21:       @ssl_verify_mode).each do |prop| -%>\r\n       22: <% next if instance_variable_get(prop).nil? || instance_variable_get(prop).empty? -%>\r\n       23: <%=prop.delete_prefix(\"@\") %> <%= instance_variable_get(prop).inspect %>\r\n       24: <% end -%>\r\n             \r\n             System Info:\r\n             ------------\r\n             chef_version=16.16.13\r\n             platform=redhat\r\n             platform_version=7.9\r\n             ruby=ruby 2.7.4p191 (2021-07-07 revision a21a3b7d23) [x86_64-linux]\r\n             program_name=\/opt\/cinc\/bin\/cinc-client\r\n             executable=\/opt\/cinc\/bin\/cinc-client\r\n             \r\n           \r\n           ================================================================================\r\n           Error executing action `create` on resource 'chef_client_config[Create client.rb]'\r\n           ================================================================================\r\n           \r\n           Chef::Mixin::Template::TemplateError\r\n           ------------------------------------\r\n           undefined method `empty?' for false:FalseClass\r\n```\r\n\r\nThis code looks like is from \r\nhttps:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource\/support\/client.erb#L22\r\n\r\n```\r\n<% next if instance_variable_get(prop).nil? || instance_variable_get(prop).empty? -%>\r\n```\r\n\r\nQuick Ruby testing\r\n\r\n```\r\nirb(main):001:0> false.nil?\r\n=> false\r\nirb(main):002:0> false.empty?\r\nNoMethodError: undefined method `empty?' for false:FalseClass\r\n\tfrom (irb):2\r\n\tfrom \/bin\/irb:12:in `<main>'\r\nirb(main):003:0> \r\n```\r\n \r\n## Chef Version\r\n16.16.13\r\n\r\n## Platform Version\r\nRHEL 7.9\r\n\r\n## Replication Case\r\nSee above Ruby test\r\n\r\n## Client Output\r\nSee above inside issue description\r\n\r\n## Stacktrace\r\nSee above inside issue description\r\n","comments":[],"labels":["Status: Waiting on Release","Chef 18.5"]},{"title":"'log' resource ignores the 'message' attribute, and will always use the name of the resource as the message","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nThe 'log' resource, when used in a recipe, ignores the 'message' attribute and instead will use whatever the name of the log resource is as its message.\r\n\r\nThe following will always spit out \"message\"\r\n```\r\nlog 'message' do\r\n  message 'This is the message that should be added to the log.'\r\n  level :info\r\nend\r\n```\r\n\r\nI discovered this while trying to do something with lazy evaluation:\r\n\r\n```\r\nlog 'dummy message' do  # ignores the 'message' value and always spits out 'dummy message'\r\n  message lazy { node.run_state[:dump_master_log_file] }\r\nend\r\n```\r\n\r\n## Chef Version\r\n18.4.2\r\n\r\n## Platform Version\r\nUbuntu 20.04 LTS\r\n\r\n## Replication Case\r\n\r\nThe most minimal example I can think of would be:\r\n```\r\nlog 'dummy message' do\r\n  message 'this is a much better message'\r\nend\r\n```\r\n\r\nExpected output should be 'this is a much better message'\r\n\r\n## Client Output\r\n\r\n```\r\nlog[dummy message] action write\r\n```\r\n\r\n## Stacktrace\r\nN\/A","comments":[],"labels":["Status: Untriaged"]},{"title":"Bump kitchen-vagrant from 1.14.1 to 2.0.0 in \/omnibus","body":"Bumps [kitchen-vagrant](https:\/\/github.com\/opscode\/kitchen-vagrant) from 1.14.1 to 2.0.0.\n<details>\n<summary>Release notes<\/summary>\n<p><em>Sourced from <a href=\"https:\/\/github.com\/opscode\/kitchen-vagrant\/releases\">kitchen-vagrant's releases<\/a>.<\/em><\/p>\n<blockquote>\n<h2>v1.14.2<\/h2>\n<h2><a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/compare\/v1.14.1...v1.14.2\">1.14.2<\/a> (2023-11-27)<\/h2>\n<h3>Bug Fixes<\/h3>\n<ul>\n<li>Add New lint and publish workflows (<a href=\"https:\/\/redirect.github.com\/test-kitchen\/kitchen-vagrant\/issues\/488\">#488<\/a>) (<a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/commit\/744fdc93d006ad32f80994b371c198e5a2a9deb6\">744fdc9<\/a>)<\/li>\n<\/ul>\n<\/blockquote>\n<\/details>\n<details>\n<summary>Changelog<\/summary>\n<p><em>Sourced from <a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/blob\/main\/CHANGELOG.md\">kitchen-vagrant's changelog<\/a>.<\/em><\/p>\n<blockquote>\n<h2><a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/compare\/v1.14.2...v2.0.0\">2.0.0<\/a> (2024-02-14)<\/h2>\n<ul>\n<li>Require Vagrant 2.4 or later<\/li>\n<li>Drop support for EOL Ruby 2.7 release<\/li>\n<li>Add a new <code>box_arch<\/code> configuration option for defining the architecture to use<\/li>\n<li>Eliminate the need for the vagrant-winrm plugin on Windows boxes<\/li>\n<\/ul>\n<h2><a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/compare\/v1.14.1...v1.14.2\">1.14.2<\/a> (2023-11-27)<\/h2>\n<h3>Bug Fixes<\/h3>\n<ul>\n<li>Add New lint and publish workflows (<a href=\"https:\/\/redirect.github.com\/test-kitchen\/kitchen-vagrant\/issues\/488\">#488<\/a>) (<a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/commit\/744fdc93d006ad32f80994b371c198e5a2a9deb6\">744fdc9<\/a>)<\/li>\n<\/ul>\n<\/blockquote>\n<\/details>\n<details>\n<summary>Commits<\/summary>\n<ul>\n<li><a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/commit\/098e5c66e50f3c8e3703c75c01e65463d63f11cc\"><code>098e5c6<\/code><\/a> Release 2.0.0 (<a href=\"https:\/\/redirect.github.com\/opscode\/kitchen-vagrant\/issues\/492\">#492<\/a>)<\/li>\n<li><a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/commit\/cdd899908ddbfafb1c7e8068602ffcf3e0460d53\"><code>cdd8999<\/code><\/a> add vagrant architecture support (<a href=\"https:\/\/redirect.github.com\/opscode\/kitchen-vagrant\/issues\/491\">#491<\/a>)<\/li>\n<li><a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/commit\/3b7c4b5b8508232e7a1e4b630feac2bc60b48224\"><code>3b7c4b5<\/code><\/a> chore(deps): update google-github-actions\/release-please-action action to v4 ...<\/li>\n<li><a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/commit\/ad99627151b86184434bcae4c6fc3a0e7f86b549\"><code>ad99627<\/code><\/a> chore(main): release 1.14.2 (<a href=\"https:\/\/redirect.github.com\/opscode\/kitchen-vagrant\/issues\/489\">#489<\/a>)<\/li>\n<li><a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/commit\/00be941e364e9a34af7e32b7683e1f4378318e1b\"><code>00be941<\/code><\/a> Configure renovate<\/li>\n<li><a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/commit\/744fdc93d006ad32f80994b371c198e5a2a9deb6\"><code>744fdc9<\/code><\/a> fix: Add New lint and publish workflows (<a href=\"https:\/\/redirect.github.com\/opscode\/kitchen-vagrant\/issues\/488\">#488<\/a>)<\/li>\n<li><a href=\"https:\/\/github.com\/test-kitchen\/kitchen-vagrant\/commit\/a3707d6d07b412b1cbb30cf6e0bc75f089ed88b1\"><code>a3707d6<\/code><\/a> Update chefstyle requirement from 2.2.2 to 2.2.3 (<a href=\"https:\/\/redirect.github.com\/opscode\/kitchen-vagrant\/issues\/486\">#486<\/a>)<\/li>\n<li>See full diff in <a href=\"https:\/\/github.com\/opscode\/kitchen-vagrant\/compare\/v1.14.1...v2.0.0\">compare view<\/a><\/li>\n<\/ul>\n<\/details>\n<br \/>\n\n\n[![Dependabot compatibility score](https:\/\/dependabot-badges.githubapp.com\/badges\/compatibility_score?dependency-name=kitchen-vagrant&package-manager=bundler&previous-version=1.14.1&new-version=2.0.0)](https:\/\/docs.github.com\/en\/github\/managing-security-vulnerabilities\/about-dependabot-security-updates#about-compatibility-scores)\n\nYou can trigger a rebase of this PR by commenting `@dependabot rebase`.\n\n[\/\/]: # (dependabot-automerge-start)\n[\/\/]: # (dependabot-automerge-end)\n\n---\n\n<details>\n<summary>Dependabot commands and options<\/summary>\n<br \/>\n\nYou can trigger Dependabot actions by commenting on this PR:\n- `@dependabot rebase` will rebase this PR\n- `@dependabot recreate` will recreate this PR, overwriting any edits that have been made to it\n- `@dependabot merge` will merge this PR after your CI passes on it\n- `@dependabot squash and merge` will squash and merge this PR after your CI passes on it\n- `@dependabot cancel merge` will cancel a previously requested merge and block automerging\n- `@dependabot reopen` will reopen this PR if it is closed\n- `@dependabot close` will close this PR and stop Dependabot recreating it. You can achieve the same result by closing it manually\n- `@dependabot show <dependency name> ignore conditions` will show all of the ignore conditions of the specified dependency\n- `@dependabot ignore this major version` will close this PR and stop Dependabot creating any more for this major version (unless you reopen the PR or upgrade to it yourself)\n- `@dependabot ignore this minor version` will close this PR and stop Dependabot creating any more for this minor version (unless you reopen the PR or upgrade to it yourself)\n- `@dependabot ignore this dependency` will close this PR and stop Dependabot creating any more for this dependency (unless you reopen the PR or upgrade to it yourself)\n\n\n<\/details>\n\n> **Note**\n> Automatic rebases have been disabled on this pull request as it has been open for over 30 days.\n","comments":["## [![Quality Gate Passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/qg-passed-20px.png 'Quality Gate Passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14240) **Quality Gate passed**  \nIssues  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0 New issues](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14240&resolved=false&inNewCodePeriod=true)  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/accepted-16px.png '') [0 Accepted issues](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14240&metric=new_accepted_issues&view=list)\n\nMeasures  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14240&resolved=false&inNewCodePeriod=true)  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/no-data-16px.png '') No data about Coverage  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/no-data-16px.png '') No data about Duplication  \n  \n[See analysis details on SonarCloud](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14240)\n\n"],"labels":["Type: Chore"]},{"title":"18.4.2 windows_service property \"description\": NoMethodError","body":"## Description\r\n\r\nAs of 18.4.2, the `windows_service` resource does not process the `description` property\/argument correctly. Example code:\r\n```\r\nwindows_service service_name do\r\n  binary_path_name startup_command\r\n   name new_resource.agent_name\r\n   description \"#{new_resource.agent_name} agent\"\r\n   delayed_start false\r\n   timeout 30\r\n   action %i[create enable start]\r\n end\r\n```\r\n\r\nThe error is:\r\n\r\n```\r\nNoMethodError\r\n-------------\r\nundefined method `description' for #<struct Struct::ServiceConfigInfo service_type=\"own process\",\r\n start_type=\"auto start\", error_control=\"normal\", binary_path_name=\"C:\/vault\/vault.exe agent \r\n-config=C:\/vault\/config\/agent.hcl \", load_order_group=\"\", tag_id=0, dependencies=[], \r\nservice_start_name=\"LocalSystem\", display_name=\"vault\">\r\n\r\n            current_resource.description(config_info.description)           if new_resource.description\r\n                                                    ^^^^^^^^^^^^\r\n```\r\n\r\nRemoving the `description` property from the resource works around the problem.\r\n\r\n## Chef Version\r\n18.4.2 (was working in 18.3.0)\r\n\r\n## Platform Version\r\n```\r\n      System Info:\r\n      ------------\r\n      chef_version=18.4.2\r\n      platform=windows\r\n      platform_version=10.0.17763\r\n      ruby=ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x64-mingw-ucrt]\r\n```\r\n\r\n## Stacktrace\r\n```\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.4.2-x64-mingw-ucrt\/lib\/chef\/provider\/service\/windows.rb:77:in `load_current_resource'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.4.2-x64-mingw-ucrt\/lib\/chef\/provider.rb:228:in `run_action'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.4.2-x64-mingw-ucrt\/lib\/chef\/resource.rb:601:in `block in run_action'\r\n```","comments":[],"labels":["Status: Untriaged"]},{"title":"Cloud helper functions return incorrect results after nodes are moved between clouds (Azure -> AWS)","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nWe sometimes move nodes between different clouds and end up with situations where the cloud helper functions return erroneous results. For example, when a node was moved from Azure to AWS, `ohai` reports `azure` is present, but `azure.metadata` is null\r\n\r\n```json\r\n{\r\n  \"azure\": {\r\n    \"metadata\": null\r\n  },\r\n  \"ec2\": {\r\n    \"account_id\": \"...\"\r\n  }\r\n}\r\n```\r\n\r\nAlso note `cloud` key is missing for the attributes in the example. And to be clear the node can be seen still running in the EC2 console, all the AWS attributes are valid.\r\n\r\nResult of helpers for above node:\r\n\r\n```\r\nchef (17.10.3)> ec2?\r\n=> true\r\nchef (17.10.3)> azure?\r\n=> true\r\nchef (17.10.3)> cloud?\r\n=> false\r\n```\r\n\r\nWe expected `true`, `false` and `true` in this case. The node is still running in ECS. Also we don't understand how `cloud?` can ever be false if one of the cloud provider helpers is true.\r\n\r\nSometimes the `cloud` metadata is missing too, even though the node is running in EC2 or similar. We think this may have to do with moving a node from on-prem to the cloud.\r\n\r\nChecking the helper methods, it looks like they only check for the presence of the `azure` key and such. Maybe more robust checking is needed for edge cases like these.\r\n\r\n## Chef Version\r\n`17.10.3`\r\n\r\n## Platform Version\r\nWSL Ubuntu 22.04.03 LTS\r\n\r\n## Replication Case\r\n1. Transfer node from Azure to AWS, or on-prem to Azure to AWS\r\n2. Observe metadata that retains\/misses `azure` or `cloud` attributes\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Add `start_after_enable` property to `systemd_unit` resource","body":"## Description\r\n\r\nIt's a common operational task is to start a service after enabling it. systemd has a flag for this (--now). I didn't see a way to cleanly add that flag in the implementation so I added an explicit start.\r\n\r\nNote this feature is different than the `:start` action which always starts a service.\r\n\r\nA `stop_after_disable` property may also be useful.\r\n\r\n## Related Issue\r\n\r\nhttps:\/\/github.com\/chef\/chef\/issues\/14187\r\n\r\n## Types of changes\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [x] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n- [x] I have read the **CONTRIBUTING** document.\r\n- [x] I have run the pre-merge tests locally and they pass.\r\n- [ ] I have updated the documentation accordingly.\r\n- [x] I have added tests to cover my changes.\r\n- [ ] If `Gemfile.lock` has changed, I have used `--conservative` to do it and included the full output in the Description above.\r\n- [ ] All new and existing tests passed.\r\n- [x] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["## [![Quality Gate Passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/qg-passed-20px.png 'Quality Gate Passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14188) **Quality Gate passed**  \nKudos, no new issues were introduced!\n\n[0 New issues](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14188&resolved=false&inNewCodePeriod=true)  \n[0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14188&resolved=false&inNewCodePeriod=true)  \nNo data about Coverage  \n[0.0% Duplication on New Code](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14188&metric=new_duplicated_lines_density&view=list)  \n  \n[See analysis details on SonarCloud](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14188)\n\n","@adsr Hi, can you please add a DCO to this. This looks great, thanks for the feature. We're going to review this at the community meeting next week. Can you attend? It's at 1 PST on Tuesdays. https:\/\/progress.zoom.us\/j\/94141161621?from=addon","@dafyddcrosby May have some suggestions on the `--now` flag inclusion.","Glad others are also thinking about this! :-D\r\n\r\nYou'd mentioned the `--now` flag, which came about in [systemd 220](https:\/\/github.com\/systemd\/systemd\/blob\/main\/NEWS#L12217-L12220), so it's not new, but I don't know if that's the version on all supported Infra Client platforms, either. Even if it is, what I'll suggest next won't be rendered moot either way.\r\n\r\nWhat I like about `--now` is that we get a single atomic operation where we used to need 2, and can nearly halve `systemctl` shellouts. In the case of bootstrapping new hosts, that can be a nice speedup \u2764\ufe0f \r\n\r\nOne way to sidestep the systemd version issue, **AND** get the intended atomicity, **AND** save an extra resource would be to create `:enable_and_start` and `:disable_and_stop` (and maybe `:mask_and_stop`, too) *actions*. Creating new actions also means we don't have to muddy the semantics about the existing `enable` behavior, which keeps it easy to reason about if other neat `systemsctl` flags pop up. We'd probably want to check pre-220 behavior with `--now` to see if we can catch it for error handling (maybe @tpowell-progress has access to some ancient VMs to do this ;-)"],"labels":["documentation"]},{"title":"Start a service after enabling it","body":"### Describe the Enhancement:\r\n\r\nAdd the ability to start a systemd unit but only after enabling it.\r\n\r\n### Describe the Need:\r\n\r\nIt's a common operational task is to start a service after enabling it. systemd has a flag for this (`--now`) which also handles the opposite direction (stopping a service when disabling it).\r\n\r\n### Current Alternative\r\n\r\nAn `execute` resource","comments":["Maybe I'm confused about what the problem is, but what you describe \r\n\r\n> a common operational task is to start a service after enabling it\r\n\r\nis something we do all the time:\r\n\r\n```\r\nservice 'vault' do\r\n  action %i[enable start]\r\nend\r\n```","The distinction is \"starting a service unconditionally\" vs \"starting a service only when it transitions to enabled\"."],"labels":["Status: Untriaged"]},{"title":"[WIP]Update chef-foundation to pull in openssl 3.0.9","body":"<!--- Provide a short summary of your changes in the Title above -->\r\n`chef-foundation` 3.1.21 pulls in openssl 3.0.9. \r\n\r\n## Description\r\n<!--- Describe your changes in detail, what problems does it solve? -->\r\n\r\n## Related Issue\r\n<!--- If you are suggesting a new feature or change, please create an issue first -->\r\n<!--- Please link to the issue, discourse, or stackoverflow here: -->\r\n\r\n## Types of changes\r\n<!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: -->\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [ ] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n<!--- If you're unsure about any of these, don't hesitate to ask. We're here to help! -->\r\n- [ ] I have read the **CONTRIBUTING** document.\r\n- [ ] I have run the pre-merge tests locally and they pass.\r\n- [ ] I have updated the documentation accordingly.\r\n- [ ] I have added tests to cover my changes.\r\n- [ ] If `Gemfile.lock` has changed, I have used `--conservative` to do it and included the full output in the Description above.\r\n- [ ] All new and existing tests passed.\r\n- [ ] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["Testing adhoc build https:\/\/buildkite.com\/chef\/chef-chef-main-validate-adhoc\/builds\/998","Waiting on Release of 18.4. I think we want to at least bump the minor version again prior and we definitely don't want to delay the readiness status of 18.4 with a bump yet.","Testing new adhoc build https:\/\/buildkite.com\/chef\/chef-chef-main-validate-adhoc\/builds\/1080","@neha-p6  I and @tpowell-progress  had a chat. Chef foundation 3.1.17 has the open ssl upgrade but not 3.1.20 . We had to rollback that change and regenerate chef foundation to get a chef 18 release. However for all testing purposes we can use 3.1.17. ","> @neha-p6 I and @tpowell-progress had a chat. Chef foundation 3.1.17 has the open ssl upgrade but not 3.1.20 . We had to rollback that change and regenerate chef foundation to get a chef 18 release. However for all testing purposes we can use 3.1.17.\r\n\r\nNoted. Thanks for the update.\r\n","Adhoc build with chef-foundation pinned at `3.1.17`https:\/\/buildkite.com\/chef\/chef-chef-main-validate-adhoc\/builds\/1082","@neha-p6 chef-foundation 3.1.21 should be ready for testing OpenSSL 3.0.0","OpenSSL 3.0.9 https:\/\/buildkite.com\/chef\/chef-chef-main-validate-adhoc\/builds\/1252","## [![Quality Gate Passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/qg-passed-20px.png 'Quality Gate Passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14167) **Quality Gate passed**  \nIssues  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0 New issues](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14167&resolved=false&inNewCodePeriod=true)  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/accepted-16px.png '') [0 Accepted issues](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14167&metric=new_accepted_issues&view=list)\n\nMeasures  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14167&resolved=false&inNewCodePeriod=true)  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/no-data-16px.png '') No data about Coverage  \n![](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/passed-16px.png '') [0.0% Duplication on New Code](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14167&metric=new_duplicated_lines_density&view=list)  \n  \n[See analysis details on SonarCloud](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14167)\n\n"],"labels":["WIP","Status: Waiting on Release"]},{"title":"Release schedule documentation is out of date","body":"## Description\r\n\r\n[Release schedule documentation](https:\/\/github.com\/chef\/chef\/blob\/main\/docs\/dev\/policy\/release_and_support_schedule.md#generally-available-release-schedule), which resides in this repository, is out of date. It says\r\n\r\n> Generally Available Release Schedule\r\n>  Minor releases: 2nd week of each month\r\n>  Major releases: Once a year in April\r\n\r\nBut looking at [the actual releases of, for example, Chef Infra Client](https:\/\/discourse.chef.io\/c\/chef-release\/9), shows that there aren't minor releases each month, nor major releases in April of each year (last major release of [Chef Infra Client 18 was October 2022](https:\/\/discourse.chef.io\/t\/chef-infra-client-18-0-169-released\/21570))\r\n\r\nMaybe best to just remove that part of the documentation.\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Lazy node attributes aren't \"un-lazied\" in some contexts","body":"## Description\r\n\r\nAfter #10345, it is possible to use `lazy` in node attributes and they are \"un-lazied\" when accessed. Unfortunately there are some cases where cookbooks may access attributes in such a way that they are not evaluated automatically, and so we'll see things like `#<Chef::DelayedEvaluator:0x000000010813cbb8 ...` in rendered templates, files, etc., instead of the evaluated value.\r\n\r\nSome examples that may trigger this behavior include: calling `Enumerable` methods like `node['foo'].map`, calling `node['foo'].to_h`, or calling `JSON.pretty_generate(node['foo'])`. These methods may be invoked by third-party cookbooks, so we have little control over changing their behavior without forking the cookbook entirely, which is undesirable.\r\n\r\nI'm filing this as a bug as I believe that the spirit of #10345 is to allow `lazy` attributes to work transparently, since the `[]` methods were implemented so that cookbooks that use `[]` to access node attributes did not need to be modified to \"un-lazy\" the value. That said, I realize that might not be straightforward to achieve - there are a lot of ways to access node attributes - so I'm happy to discuss it.\r\n\r\nI've brainstormed some things that we could consider:\r\n\r\n- Add `to_h`, `to_json`, `map`, etc. methods on `ImmutableMash` and `ImmutableArray` that evaluate any `Chef::DelayedEvaluator`s before returning. This may be annoying as there are a lot of methods to cover.\r\n- Walk the entire `Node` object and evaluate all `Chef::DelayedEvaluator`s present after the compilation phase, but before convergence. Maybe this would be too slow?\r\n- Add `to_s`, `to_json`, methods on `Chef::DelayedEvaluator`. This may have unintended consequences.\r\n\r\n## Chef Version\r\n\r\nI believe this happens in all versions of Chef client version, but I'm able to reproduce this locally with:\r\n\r\n```\r\n$  chef-client --version\r\nChef Infra Client: 18.2.7\r\n```\r\n\r\n## Platform Version\r\n\r\nI've reproduced this on:\r\n\r\n- Ubuntu 22.04\r\n- MacOS Monterey\r\n\r\n## Replication Case\r\n\r\nI'm including a couple of the examples that I mentioned above, but essentially anything you can think of that accesses the node attribute values without invoking `[]` will trigger the behavior:\r\n\r\nIn `attributes\/default.rb`:\r\n\r\n```ruby\r\nnode.default['foo'] = {\r\n  'bar' => 'baz',\r\n  'qux' => lazy { \"qux-#{node['foo']['bar']}\" },\r\n}\r\n\r\n```\r\n\r\nIn `recipes\/default.rb`:\r\n\r\n```ruby\r\ndef convert_to_flags(h)\r\n  h.map { |k, v| \"-#{k}=#{v}\" }.join(' ')\r\nend\r\n\r\n# works\r\nChef::Log.info \"node['foo']['qux']: #{node['foo']['qux']}\"\r\n\r\n# prints out `#<Chef::DelayedEvaluator ...`\r\nChef::Log.info \"JSON.pretty_generate(node['foo']): #{JSON.pretty_generate(node['foo'])}\"\r\n\r\n# prints out `#<Chef::DelayedEvaluator ...`\r\nChef::Log.info \"convert_to_flags(node['foo']: #{convert_to_flags(node['foo'])}\"\r\n```\r\n\r\n## Client Output\r\n\r\n```\r\n[2024-01-02T12:48:18-05:00] INFO: node['foo']['qux']: qux-baz\r\n[2024-01-02T12:48:18-05:00] INFO: JSON.pretty_generate(node['foo']): {\r\n  \"bar\": \"baz\",\r\n  \"qux\": \"#<Chef::DelayedEvaluator:0x0000000107e45658 .chef\/local-mode-cache\/cache\/cookbooks\/scratch\/attributes\/default.rb:3>\"\r\n}\r\n[2024-01-02T12:48:18-05:00] INFO: convert_to_flags(node['foo']: -bar=baz -qux=#<Chef::DelayedEvaluator:0x0000000107e45658 .chef\/local-mode-cache\/cache\/cookbooks\/scratch\/attributes\/default.rb:3>\r\n```\r\n\r\n## Stacktrace\r\n\r\nN\/A\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"feat: Support Signed-By option for apt repository","body":"If it is used, it will avoid using the deprecated apt-key command.\r\n\r\nFixes: #13168\r\n\r\n<!--- Provide a short summary of your changes in the Title above -->\r\n\r\n## Description\r\nAdd support for a `signed_by` property for apt_repository. \r\n\r\nIf true, and a key is supplied, it will install the key in a repo-specific keyring, and reference that in the Signed-By option. \r\nIf a string, it will pass that string to the Signed-By option. \r\n\r\nI'm not sure what the behavior should be if signed_by is a string, and a key is also supplied. Currently it will install the key in a repo-specific location, but use the value of the string in the signed-by field. \r\n\r\nOther options for the case where key and signed-by are both specified could be:\r\n1. install the key in \/etc\/apt\/trusted.gpg.d, and use signed-by as is\r\n2. try to interpret the first entry (comma seprated) as a file path, and install the key at that location\r\n3. prepend the generated location to the list of signed-by values if it isn't already included\r\n\r\nThis still needs testing and documentation. But I wanted to see if this was a good approach before polishing it.\r\n\r\n## Related Issue\r\n#13168 \r\n\r\n## Types of changes\r\n<!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: -->\r\n- [x] Bug fix (non-breaking change which fixes an issue)\r\n- [x] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n<!--- If you're unsure about any of these, don't hesitate to ask. We're here to help! -->\r\n- [x] I have read the **CONTRIBUTING** document.\r\n- [x] I have run the pre-merge tests locally and they pass.\r\n- [ ] I have updated the documentation accordingly.\r\n- [x] I have added tests to cover my changes.\r\n- [x] If `Gemfile.lock` has changed, I have used `--conservative` to do it and included the full output in the Description above.\r\n- [x] All new and existing tests passed.\r\n- [x] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["## [![Quality Gate Passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/qg-passed-20px.png 'Quality Gate Passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14131) **Quality Gate passed**  \nThe SonarCloud Quality Gate passed, but some issues were introduced.\n\n[5 New issues](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14131&resolved=false&inNewCodePeriod=true)  \n[0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14131&resolved=false&inNewCodePeriod=true)  \nNo data about Coverage  \n[0.0% Duplication on New Code](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14131&metric=new_duplicated_lines_density&view=list)  \n  \n[See analysis details on SonarCloud](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14131)\n\n"],"labels":["documentation"]},{"title":"Initial stab at an expected platform list","body":"<!--- Provide a short summary of your changes in the Title above -->\r\n\r\n## Description\r\nStarting with a list of expected platforms that we should be generating artifacts for. Initial list is from 18.3.x current channel list from omnitruck.\r\n\r\n## Related Issue\r\n<!--- If you are suggesting a new feature or change, please create an issue first -->\r\n<!--- Please link to the issue, discourse, or stackoverflow here: -->\r\n\r\n## Types of changes\r\n<!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: -->\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [X] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [X] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n<!--- If you're unsure about any of these, don't hesitate to ask. We're here to help! -->\r\n- [ ] I have read the **CONTRIBUTING** document.\r\n- [ ] I have run the pre-merge tests locally and they pass.\r\n- [ ] I have updated the documentation accordingly.\r\n- [ ] I have added tests to cover my changes.\r\n- [ ] If `Gemfile.lock` has changed, I have used `--conservative` to do it and included the full output in the Description above.\r\n- [ ] All new and existing tests passed.\r\n- [X] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["> Should Rocky by listed after Windows or should it be in with the other Linuces* I suggest that to keep platform families together for readability and clarity\r\n\r\n@johnmccrae it *can* be, this was just generated from current omnitruck.","## [![Quality Gate Passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/qg-passed-20px.png 'Quality Gate Passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14130) **Quality Gate passed**  \nKudos, no new issues were introduced!\n\n[0 New issues](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14130&resolved=false&inNewCodePeriod=true)  \n[0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14130&resolved=false&inNewCodePeriod=true)  \nNo data about Coverage  \nNo data about Duplication  \n  \n[See analysis details on SonarCloud](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14130)\n\n"],"labels":["Expeditor: Bump Version Minor"]},{"title":"Document osx_profile OS version restrictions.","body":"Basically #10471\r\n\r\n## Description\r\nIn 2020, Apple dropped support for non-interactively installing configuration profiles. This commit more prominently documents that change.\r\n\r\n## Related Issue\r\nhttps:\/\/github.com\/chef\/chef\/issues\/10075\r\n\r\n## Types of changes\r\n<!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: -->\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [ ] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [x] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n<!--- If you're unsure about any of these, don't hesitate to ask. We're here to help! -->\r\n- [x] I have read the **CONTRIBUTING** document.\r\n- [x] I have run the pre-merge tests locally and they pass.\r\n- [x] I have updated the documentation accordingly.\r\n- [x] I have added tests to cover my changes.\r\n- [x] If `Gemfile.lock` has changed, I have used `--conservative` to do it and included the full output in the Description above.\r\n- [x] All new and existing tests passed.\r\n- [x] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14128)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14128&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14128&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14128&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14128&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14128&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14128&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14128&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14128&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14128&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14128&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14128&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14128&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14128) No Coverage information  \n[![0.0%](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/3-16px.png '0.0%')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14128&metric=new_duplicated_lines_density&view=list) [0.0% Duplication](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14128&metric=new_duplicated_lines_density&view=list)\n\n","@williamtheaker can you add the exact version and possibly a link to the Apple source inside the description for completeness?","> @williamtheaker can you add the exact version and possibly a link to the Apple source inside the description for completeness?\r\n\r\nIt's only really documented in the man page for the `profiles` tool:\r\n\r\n```\r\nDESCRIPTION\r\n     profiles is used to handle various profile types on macOS.   Starting with macOS 11.0 (profiles tool 8.0 or later), this tool cannot be\r\n         used to install configuration profiles.  You should add your profiles using the System Settings Profiles\r\n         preference pane.    Additionally, startup profiles are no longer supported.\r\n```\r\n\r\nFrustratingly, this requires access to a macOS device because [Apple doesn't publish man pages online](https:\/\/apple.stackexchange.com\/questions\/239484\/does-apple-provide-a-web-site-with-content-of-man-pages-for-the-command-line-c) and the `profiles` tool is nonfree\/proprietary so there's no public source code to link as documentation.\r\n\r\nThis line in a video transcript is the closest I can get to an Apple statement on the subject:\r\n\r\n> As of macOS Big Sur, you will no longer be able to completely install profiles using Terminal.\r\n\r\nhttps:\/\/developer.apple.com\/videos\/play\/wwdc2020\/10639\/?time=629","@williamtheaker upon further review, perhaps this functionality should go straight to getting a deprecation warning instead so that you will get a direct admonition when using. macOS 11 is EOL as of September 2023.","> @williamtheaker upon further review, perhaps this functionality should go straight to getting a deprecation warning instead so that you will get a direct admonition when using. macOS 11 is EOL as of September 2023.\r\n\r\nAdd a deprecation warning to the action or deprecate the whole resource? Anyone who was using this resource has almost certainly replaced it with MDM profiles a long time ago, since the overlap between having an MDM server and needing config profiles on nodes should be near 1:1.","> > @williamtheaker upon further review, perhaps this functionality should go straight to getting a deprecation warning instead so that you will get a direct admonition when using. macOS 11 is EOL as of September 2023.\r\n> \r\n> Add a deprecation warning to the action or deprecate the whole resource? Anyone who was using this resource has almost certainly replaced it with MDM profiles a long time ago, since the overlap between having an MDM server and needing config profiles on nodes should be near 1:1.\r\n\r\nSounds like the whole resource? Just to give fair warning to retire the code.\r\n","I couldn't find any examples of previously retired resources for reference. Should I just add `Chef::Log.warn(\"This resource is deprecated and will be removed in a future #{ChefUtils::Dist::Infra::PRODUCT} release.\")` to the beginning of each action?","> I couldn't find any examples of previously retired resources for reference. Should I just add `Chef::Log.warn(\"This resource is deprecated and will be removed in a future #{ChefUtils::Dist::Infra::PRODUCT} release.\")` to the beginning of each action?\r\n\r\nLooks like `unified_mode` is the closest example... https:\/\/github.com\/chef\/chef\/pull\/11453\/files ","I realized [previous resource deprecations](https:\/\/docs.chef.io\/chef_deprecations_client\/#all-deprecations) required RFCs (now design proposals) so I've opened one to deprecate this resource in #14278 and will update this PR when (\ud83e\udd1e) the proposal is approved.","> I realized [previous resource deprecations](https:\/\/docs.chef.io\/chef_deprecations_client\/#all-deprecations) required RFCs (now design proposals) so I've opened one to deprecate this resource in #14278 and will update this PR when (\ud83e\udd1e) the proposal is approved.\r\n\r\nGoing to revisit this next week based on @erikng's comment https:\/\/github.com\/chef\/chef\/issues\/14278#issuecomment-1984688622 (there were other things making my brain think older macOSes were on the supported list for some reason."],"labels":["documentation","Focus: Community PR Review"]},{"title":"windows_security_policy incorrectly reporting updates","body":"## Description\r\nWhen converging a recipe with 3 or more `windows_security_policy` resources that require changes, one or more resources will converge correctly, and apply the proper changes, but show in the log as `(up to date)`. The final report line also does not include the resources as having updated. Which resources report incorrectly is inconsistent between runs. \r\n\r\n## Chef Version\r\n18.3.0\r\n\r\n## Platform Version\r\nObserved on Windows 10\r\n\r\n## Replication Case\r\nUsing the Security Policy MMC snap-in (secpol.msc) or `net accounts`, set the following values:\r\n| Setting | Value |\r\n|--------|--------|\r\n| Minimum password age | anything other than 1 |\r\n| Maximum password age | anything other than 30 and greater than 1 |\r\n| Password must meet complexity requirements | Disabled | \r\n\r\nConverge the following resources:\r\n\r\n```ruby\r\nwindows_security_policy 'MinimumPasswordAge' do\r\n  secvalue '1'\r\n  action :set\r\nend\r\nwindows_security_policy 'MaximumPasswordAge' do\r\n  secvalue '30'\r\n  action :set\r\nend\r\nwindows_security_policy 'PasswordComplexity' do\r\n  secvalue '1'\r\n  action :set\r\nend\r\n```\r\nAgain using `net accounts` or the Security Policy snap-in, examine the three settings. Note that all three have updated.\r\nNB these resources are not specific triggers of the bug and only just examples. In testing, the bug has been observed with any setting.\r\n\r\n## Client Output\r\n\r\n```\r\nRecipe: windows_secpol_test::default\r\n  * windows_security_policy[MinimumPasswordAge] action set[2023-12-01T09:43:30-08:00] INFO: Processing windows_security_policy[MinimumPasswordAge] action set (windows_secpol_test::default line 7)\r\n\r\n    - update MinimumPasswordAge\r\n    -   set secvalue to \"1\" (was \"2\")\r\n  * windows_security_policy[LockoutBadCount] action set[2023-12-01T09:43:32-08:00] INFO: Processing windows_security_policy[LockoutBadCount] action set (windows_secpol_test::default line 11)\r\n\r\n    - update LockoutBadCount\r\n    -   set secvalue to \"10\" (was \"4\")\r\n  * windows_security_policy[PasswordComplexity] action set[2023-12-01T09:43:33-08:00] INFO: Processing windows_security_policy[PasswordComplexity] action set (windows_secpol_test::default line 15)\r\n (up to date)\r\n[2023-12-01T09:43:34-08:00] WARN: Skipping final node save because override_runlist was given\r\n[2023-12-01T09:43:34-08:00] INFO: Chef Infra Client Run complete in 10.2564524 seconds\r\n[2023-12-01T09:43:34-08:00] INFO: Skipping removal of unused files from the cache\r\n\r\nRunning handlers:\r\n[2023-12-01T09:43:34-08:00] INFO: Running report handlers\r\nRunning handlers complete\r\n[2023-12-01T09:43:34-08:00] INFO: Report handlers complete\r\nInfra Phase complete, 2\/3 resources updated in 25 seconds\r\n```\r\n\r\n## Stacktrace\r\nN\/A\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Sensitive properties of custom resources leaked via failed regex constraints","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n\r\nWhen a custom resource has a `property` that is flagged as `sensitive` **and** guarded by a `regex` its content will be printed to STDOUT if it does not match the given regex.\r\n\r\n## Chef Version\r\nCinc Client: 18.2.7\r\n\r\n## Platform Version\r\nDebian 11\r\n\r\n## Replication Case\r\n\r\nDefine a custom resource with:\r\n```\r\nproperty :my_property, String, sensitive: true, regex: %r{^foobar$}\r\n```\r\nCall that resource with `my_property` set to something other than `foobar`.\r\n\r\n## Client Output\r\n\r\n```\r\nFATAL: Chef::Exceptions::ValidationFailed: Property my_property's value SuperSecretPassword does not match regular expression \/^foobar$\/\r\n```","comments":[],"labels":["Status: Untriaged"]},{"title":"Cannot build chef from source using `omnibus`","body":"## Description\r\nSince 18th version chef cannot be built from source using `Omnibus`.\r\nIt complains that `chef-foundation` cannot be found:\r\n\r\n```\r\n# \/tmp\/sre-ruby\/bin\/bundle exec omnibus build chef\r\n                    [CLI] I | 2023-11-28T14:15:15+00:00 | Using config from 'omnibus.rb'\r\nBuilding chef 18.3.58-20231128141515...\r\n[Software: chef-foundation] I | 2023-11-28T14:15:15+00:00 | Resolving manifest entry for chef-foundation\r\n         [Software: chef] I | 2023-11-28T14:15:15+00:00 | Resolving manifest entry for chef\r\n[PathFetcher: chef-foundation] I | 2023-11-28T14:15:15+00:00 | Digesting \/var\/cache\/omnibus\/src\/chef-foundation\/chef-foundation with sha256\r\n      [PathFetcher: chef] I | 2023-11-28T14:15:15+00:00 | Digesting \/var\/cache\/omnibus\/src\/chef\/chef with sha256\r\n[PathFetcher: chef-foundation] I | 2023-11-28T14:15:15+00:00 | Digesting \/opt\/chef with sha256\r\n      [PathFetcher: chef] I | 2023-11-28T14:15:15+00:00 | Digesting \/root\/chef\/omnibus\/files\/..\/.. with sha256\r\n[Software: shebang-cleanup] I | 2023-11-28T14:15:15+00:00 | Resolving manifest entry for shebang-cleanup\r\n[NullFetcher: shebang-cleanup] I | 2023-11-28T14:15:15+00:00 | Fetching `shebang-cleanup' (nothing to fetch)\r\n [Software: ruby-cleanup] I | 2023-11-28T14:15:15+00:00 | Resolving manifest entry for ruby-cleanup\r\n[NullFetcher: ruby-cleanup] I | 2023-11-28T14:15:15+00:00 | Fetching `ruby-cleanup' (nothing to fetch)\r\n[Software: more-ruby-cleanup] I | 2023-11-28T14:15:15+00:00 | Resolving manifest entry for more-ruby-cleanup\r\n[PathFetcher: more-ruby-cleanup] I | 2023-11-28T14:15:15+00:00 | Digesting \/var\/cache\/omnibus\/src\/more-ruby-cleanup with sha256\r\n[PathFetcher: more-ruby-cleanup] I | 2023-11-28T14:15:15+00:00 | Digesting \/root\/chef\/omnibus\/files\/more-ruby-cleanup with sha256\r\n         [Software: zlib] I | 2023-11-28T14:15:15+00:00 | Resolving manifest entry for zlib\r\n       [NetFetcher: zlib] I | 2023-11-28T14:15:15+00:00 | Downloading from `https:\/\/zlib.net\/fossils\/zlib-1.2.13.tar.gz'\r\n      [PathFetcher: chef] I | 2023-11-28T14:15:16+00:00 | Copying from `\/root\/chef\/omnibus\/files\/..\/..'\r\n      [PathFetcher: chef] I | 2023-11-28T14:15:17+00:00 | Digesting \/var\/cache\/omnibus\/src\/chef\/chef with sha256\r\nTime: 00:00:01 ================================================================= 100% (1462 KB\/sec)\r\n       [NetFetcher: zlib] I | 2023-11-28T14:15:17+00:00 | Verifying checksum\r\n              [Licensing] I | 2023-11-28T14:15:18+00:00 | Project 'chef' is using 'Chef EULA' which is not one of the standard licenses identified in https:\/\/opensource.org\/licenses\/alphabetical. Consider using one of the standard licenses.\r\n[Software: chef-foundation] I | 2023-11-28T14:15:18+00:00 | Could not restore from cache\r\n[Builder: chef-foundation] I | 2023-11-28T14:15:18+00:00 | Starting build\r\n[Builder: chef-foundation] I | 2023-11-28T14:15:18+00:00 | sync `\/var\/cache\/omnibus\/src\/chef-foundation\/chef-foundation' to `\/opt\/chef': 0.0001s\r\n[Builder: chef-foundation] I | 2023-11-28T14:15:18+00:00 | Build chef-foundation: 0.0004s\r\nbundler: failed to load command: omnibus (\/tmp\/sre-ruby\/lib\/ruby\/gems\/3.1.0\/bin\/omnibus)\r\n\/tmp\/sre-ruby\/lib\/ruby\/gems\/3.1.0\/bundler\/gems\/omnibus-82dae896a066\/lib\/omnibus\/builder.rb:753:in `chdir': No such file or directory @ dir_chdir - \/var\/cache\/omnibus\/src\/chef-foundation\/chef-foundation (Errno::ENOENT)\r\n\tfrom \/tmp\/sre-ruby\/lib\/ruby\/gems\/3.1.0\/bundler\/gems\/omnibus-82dae896a066\/lib\/omnibus\/builder.rb:753:in `block in sync'\r\n\tfrom \/tmp\/sre-ruby\/lib\/ruby\/gems\/3.1.0\/bundler\/gems\/omnibus-82dae896a066\/lib\/omnibus\/builder.rb:1101:in `instance_eval'\r\n\tfrom \/tmp\/sre-ruby\/lib\/ruby\/gems\/3.1.0\/bundler\/gems\/omnibus-82dae896a066\/lib\/omnibus\/builder.rb:1101:in `run'\r\n```\r\n\r\n## Chef Version\r\n18.3.0 (and also master branch)\r\n\r\n## Platform Version\r\nlatest Ubuntu, also CentOS\r\n\r\n## Replication Case\r\nSimply following steps from https:\/\/github.com\/chef\/chef\/tree\/main\/omnibus\r\nExecuting `bundle exec omnibus build chef` produces the trace above.\r\n","comments":["Answering myself, \r\naccording to this script we have to install chef-foundation and omnibus-toolchain as in https:\/\/github.com\/chef\/chef\/blob\/main\/.expeditor\/scripts\/omnibus_chef_build.sh \r\nbefore the actual build.\r\nActual versions of packages to be installed can be found in https:\/\/github.com\/chef\/chef\/blob\/main\/.buildkite-platform.json\r\nI believe that has to be included in https:\/\/github.com\/chef\/chef\/blob\/main\/omnibus\/README.md docs.\r\ne.g.\r\n```\r\ncurl -fsSL https:\/\/omnitruck.chef.io\/chef\/install.sh | bash -s -- -c \"current\" -P \"chef-foundation\" -v 3.1.7\r\n```"],"labels":["Status: Untriaged"]},{"title":"Chef fails with inspect 6.6","body":"## Description\r\nchef-client run fails with inspect 6.6 (works with 5.22.3 version).\r\n\r\n## Chef Version\r\n18.3\r\n\r\n## Platform Version\r\ndebian stable\r\n\r\n## Replication Case\r\ninstall chef (gem install chef-bin), run chef-client --local-mode\r\n\r\n## Client Output\r\n\r\n```\r\nffi-libarchive could not be loaded, libarchive is probably not installed on system, archive_file will not be available\r\n[2023-11-28T14:31:18+01:00] WARN: No config file found or specified on command line. Using command line options instead.\r\nChef Infra Client, version 18.3.0\r\nPatents: https:\/\/www.chef.io\/patents\r\nInfra Phase starting\r\nResolving cookbooks for run list: [...]\r\nSynchronizing cookbooks:...\r\nInstalling cookbook gem dependencies:\r\nCompiling cookbooks...\r\n\r\nRunning handlers:\r\n[2023-11-28T14:31:19+01:00] ERROR: Running exception handlers\r\nRunning handlers complete\r\n[2023-11-28T14:31:19+01:00] ERROR: Exception handlers complete\r\nInfra Phase failed. 0 resources updated in 01 seconds\r\n[2023-11-28T14:31:19+01:00] FATAL: LoadError: cannot load such file -- ast\r\n```\r\n\r\n## Stacktrace\r\n```\r\n[2023-11-28T14:31:19+01:00] FATAL: LoadError: cannot load such file -- ast\r\n<internal:\/usr\/lib\/ruby\/vendor_ruby\/rubygems\/core_ext\/kernel_require.rb>:85:in `require'\r\n<internal:\/usr\/lib\/ruby\/vendor_ruby\/rubygems\/core_ext\/kernel_require.rb>:85:in `require'\r\n\/var\/lib\/gems\/3.1.0\/gems\/inspec-core-6.6.0\/lib\/inspec\/utils\/profile_ast_helpers.rb:1:in `<top (required)>'\r\n<internal:\/usr\/lib\/ruby\/vendor_ruby\/rubygems\/core_ext\/kernel_require.rb>:85:in `require'\r\n<internal:\/usr\/lib\/ruby\/vendor_ruby\/rubygems\/core_ext\/kernel_require.rb>:85:in `require'\r\n\/var\/lib\/gems\/3.1.0\/gems\/inspec-core-6.6.0\/lib\/inspec\/profile.rb:18:in `<top (required)>'\r\n<internal:\/usr\/lib\/ruby\/vendor_ruby\/rubygems\/core_ext\/kernel_require.rb>:85:in `require'\r\n<internal:\/usr\/lib\/ruby\/vendor_ruby\/rubygems\/core_ext\/kernel_require.rb>:85:in `require'\r\n\/var\/lib\/gems\/3.1.0\/gems\/inspec-core-6.6.0\/lib\/inspec.rb:10:in `<top (required)>'\r\n<internal:\/usr\/lib\/ruby\/vendor_ruby\/rubygems\/core_ext\/kernel_require.rb>:85:in `require'\r\n<internal:\/usr\/lib\/ruby\/vendor_ruby\/rubygems\/core_ext\/kernel_require.rb>:85:in `require'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/compliance\/runner.rb:26:in `enabled?'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/compliance\/runner.rb:81:in `run_failed'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/event_dispatch\/dispatcher.rb:78:in `call'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/event_dispatch\/dispatcher.rb:78:in `block in call_subscribers'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/event_dispatch\/dispatcher.rb:68:in `each'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/event_dispatch\/dispatcher.rb:68:in `call_subscribers'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/event_dispatch\/dispatcher.rb:91:in `process_events_until_done'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/event_dispatch\/dispatcher.rb:38:in `enqueue'\r\n(eval):2:in `run_failed'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/client.rb:321:in `rescue in run'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/client.rb:312:in `run'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/application.rb:264:in `run_chef_client'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/application\/base.rb:354:in `run_application'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/application.rb:67:in `run'\r\n\/var\/lib\/gems\/3.1.0\/gems\/chef-bin-18.3.0\/bin\/chef-client:25:in `<top (required)>'\r\n\/usr\/local\/bin\/chef-client:25:in `load'\r\n\/usr\/local\/bin\/chef-client:25:in `<main>\r\n```","comments":["Experienced same issue on OpenBSD 7.4.\r\nBoth inspec-core 6.6 and 5.22.36 caused this error.\r\n\r\nUsing 5.22.29 seems to work without issue.\r\n"],"labels":["Status: Untriaged"]},{"title":"Refactor macos_pkg to use provider pattern.","body":"Attempting to implement the suggestions from #13685\r\n\r\n## Description\r\n\r\nRefactors `macos_pkg` to use the `Chef::Resource::Package` pattern.\r\n\r\n## Types of changes\r\n\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [ ] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [x] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n- [x] I have read the **CONTRIBUTING** document.\r\n- [x] I have run the pre-merge tests locally and they pass.\r\n- [x] I have updated the documentation accordingly.\r\n- [x] I have added tests to cover my changes.\r\n- [x] If `Gemfile.lock` has changed, I have used `--conservative` to do it and included the full output in the Description above.\r\n- [x] All new and existing tests passed.\r\n- [x] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14089)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14089&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14089&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14089&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14089&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14089&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14089&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14089&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14089&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14089&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14089&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14089&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14089&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14089) No Coverage information  \n[![0.0%](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/3-16px.png '0.0%')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14089&metric=new_duplicated_lines_density&view=list) [0.0% Duplication](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14089&metric=new_duplicated_lines_density&view=list)\n\n"],"labels":["Status: Waiting on Contributor","documentation","Focus: Community PR Review"]},{"title":"Update input validation for openssl_x509_certificate.","body":"<!--- Provide a short summary of your changes in the Title above -->\r\nFixes https:\/\/github.com\/chef\/chef\/issues\/14079.\r\n\r\n## Description\r\n<!--- Describe your changes in detail, what problems does it solve? -->\r\nTL;DR, as I understand it, you must have one of common_name or a subject_alt_name entry. If you have a common_name entry, it must match the subject_alt_name entry. But common_name is not required.\r\n\r\nCurrently, the resource implicitly requires common_name to be specified: https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource\/openssl_x509_certificate.rb#L221. Implicit because common_name isn't marked as required: https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource\/openssl_x509_certificate.rb#L101.\r\n\r\nI believe the correct solution is to leave the common_name and subject_alt_name property definitions as-is, add an unless check on the nilness of common_name, and require that one of subject_alt_name or common_name be set.\r\n\r\n## Related Issue\r\n<!--- If you are suggesting a new feature or change, please create an issue first -->\r\n<!--- Please link to the issue, discourse, or stackoverflow here: -->\r\nhttps:\/\/github.com\/chef\/chef\/issues\/14079\r\n## Types of changes\r\n<!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: -->\r\n- [x] Bug fix (non-breaking change which fixes an issue)\r\n- [ ] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n<!--- If you're unsure about any of these, don't hesitate to ask. We're here to help! -->\r\n- [x] I have read the **CONTRIBUTING** document.\r\n- [ ] I have run the pre-merge tests locally and they pass.\r\n- [ ] I have updated the documentation accordingly.\r\n- [ ] I have added tests to cover my changes.\r\n- [x] If `Gemfile.lock` has changed, I have used `--conservative` to do it and included the full output in the Description above.\r\n- [x] All new and existing tests passed.\r\n- [x] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=14080)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14080&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14080&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14080&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14080&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14080&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14080&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14080&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14080&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=14080&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14080&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14080&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=14080&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14080) No Coverage information  \n[![0.0%](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/3-16px.png '0.0%')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14080&metric=new_duplicated_lines_density&view=list) [0.0% Duplication](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=14080&metric=new_duplicated_lines_density&view=list)\n\n","I'm not 100% sure on how to resolve the last three bullet points in the checklist, and could use some assistance\/advice in doing so. I assume that the documentation is generated by updating the property definition?"],"labels":["Status: Waiting on Contributor","documentation","Focus: Community PR Review"]},{"title":"`openssl_x509_certificate` handles CN in a way that violates the x509 spec","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\n\r\n[RFC5280 subsection 4.1.2.6](https:\/\/datatracker.ietf.org\/doc\/html\/rfc5280#section-4.1.2.6) sez:\r\n```\r\nThe subject field identifies the entity associated with the public\r\n   key stored in the subject public key field.  The subject name MAY be\r\n   carried in the subject field and\/or the subjectAltName extension.  If\r\n   the subject is a CA (e.g., the basic constraints extension, as\r\n   discussed in [Section 4.2.1.9](https:\/\/datatracker.ietf.org\/doc\/html\/rfc5280#section-4.2.1.9), is present and the value of cA is\r\n   TRUE), then the subject field MUST be populated with a non-empty\r\n   distinguished name matching the contents of the issuer field ([Section](https:\/\/datatracker.ietf.org\/doc\/html\/rfc5280#section-4.1.2.4)\r\n   [4.1.2.4](https:\/\/datatracker.ietf.org\/doc\/html\/rfc5280#section-4.1.2.4)) in all certificates issued by the subject CA.  If the\r\n   subject is a CRL issuer (e.g., the key usage extension, as discussed\r\n   in [Section 4.2.1.3](https:\/\/datatracker.ietf.org\/doc\/html\/rfc5280#section-4.2.1.3), is present and the value of cRLSign is TRUE),\r\n   then the subject field MUST be populated with a non-empty\r\n   distinguished name matching the contents of the issuer field ([Section](https:\/\/datatracker.ietf.org\/doc\/html\/rfc5280#section-5.1.2.3)\r\n   [5.1.2.3](https:\/\/datatracker.ietf.org\/doc\/html\/rfc5280#section-5.1.2.3)) in all CRLs issued by the subject CRL issuer.  If subject\r\n   naming information is present only in the subjectAltName extension\r\n   (e.g., a key bound only to an email address or URI), then the subject\r\n   name MUST be an empty sequence and the subjectAltName extension MUST\r\n   be critical.\r\n```\r\n\r\nTL;DR, as I understand it, you must have one of common_name or a subject_alt_name entry. If you have a common_name entry, it *must* match the subject_alt_name entry. But common_name is not required. \r\n\r\nCurrently, the resource implicitly requires common_name to be specified: https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource\/openssl_x509_certificate.rb#L221. Implicit because common_name isn't marked as required: https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource\/openssl_x509_certificate.rb#L101. \r\n\r\nI believe the correct solution is to leave the common_name and subject_alt_name property definitions as-is, add an `unless` check on the nilness of common_name, and require that one of `subject_alt_name` or `common_name` be set.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nI'm using CINC version 15.7.32, but the bug applies to the main branch.\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nI'm running on Ubuntu 20.04, but the bug applies to all platforms.\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\nAttempt to create a certificate that does not specify common_name.\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n ================================================================================\r\n             Error executing action `create` on resource 'openssl_x509_certificate[\/tmp\/elastic-test.pem]'\r\n ================================================================================\r\n             \r\n             TypeError\r\n             ---------\r\n             no implicit conversion of nil into String\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Hostname resource does not set fqdn on MacOS\/Darwin","body":"Hostname, Domain name, and FQDNs should always be considered 3 separate values but I seem to run into this type of problem everywhere \ud83d\ude2d\ud83e\udd74\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/4ce99c419028c169aeb3e68ec954b79f20e654c5\/lib\/chef\/resource\/hostname.rb#L164-L181\r\n\r\n\r\nThe code for the resource always uses \"hostname\" for all values passed to `scutil` and ignores the existence of `fqdn` in the recipe. It is written to assume that the \"hostname\" value is the FQDN (which it is not, and should not be). You can see that by the \"shortname\" variable created by trying to split off the first label of the hostname which it thinks is the FQDN...\r\n\r\ne.g.,\r\n\r\n```\r\nhostname macbook do\r\n  fqdn macbook.example.com\r\nend\r\n```\r\n\r\nWill always force the MacOS client to have a hostname of `macbook` and the FQDN is never applied. This does behave correctly on Linux hosts, for example.","comments":[],"labels":["Status: Untriaged"]},{"title":"only_if \/ not_if command guard with lazy behavior","body":"### Describe the Enhancement:\r\n\r\nWhen using `only_if` \/ `not_if` with a `String`, i.e. passing in a command instead of Ruby code, it does not appear easily possible to lazily evaluate node attributes.\r\n\r\nFor example, the following code will evaluate the value of `node['some-attribute']` at compile-time:\r\n\r\n```ruby\r\nfile \"foo\" do\r\n  content \"bar\"\r\n  only_if \"some-command #{node['some-attribute']}\"\r\nend\r\n```\r\n\r\nIt'd be nice to have something _like_ the following, but I realize that implementing this literally may be confusing since `only_if` already lazily evaluates Ruby code (see also https:\/\/github.com\/chef\/chef\/issues\/10243).\r\n\r\n```ruby\r\nfile \"foo\" do\r\n  content \"bar\"\r\n  only_if lazy { \"some-command #{node['some-attribute']}\" }\r\nend\r\n```\r\n\r\n### Describe the Need:\r\n\r\nI don't know exactly how common this need is, but it seems like there's an opportunity for syntactic sugar here that would make writing these kinds of things more pleasant.\r\n\r\n### Current Alternative\r\n\r\nIt is possible for a user to define a custom resource, or do something like `only_if { shell_out(\"some-command #{node['some-attribute']}\").status.success? }`.\r\n\r\n### Can We Help You Implement This?:\r\n\r\nSure, I think the relevant code is here: https:\/\/github.com\/chef\/chef\/blob\/4ce99c419028c169aeb3e68ec954b79f20e654c5\/lib\/chef\/resource\/conditional.rb#L56-L77\r\n\r\nThe tough part would be deciding what the syntax should be, because `lazy` might not be a good fit since it could be confusing. I imagine one way might be to have the user pass an `Array`, and have the guard_interpreter first de-lazy any array elements that are lazy, for example:\r\n\r\n```ruby\r\nfile \"foo\" do\r\n  content \"bar\"\r\n  only_if ['some-command', lazy { node['some-attribute'] }]\r\nend\r\n```","comments":[],"labels":["Status: Untriaged"]},{"title":"Mount resource failing to execute after first run.","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nWhen using action `:mount` on mount resource is failing future runs because previous runs have already mounted the drive.\r\n\r\n## Chef Version\r\n17.10.3\r\n\r\n## Platform Version\r\nrhel8\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\nUsing something like this:\r\n\r\nmount '\/my\/mount' do\r\n  device '\/dev\/my_mount'\r\n  device_type :device\r\n  fstype 'xfs'\r\n  options %w(defaults)\r\n  dump 1\r\n  pass 1\r\n  enabled true\r\n  action [ :mount, :enable ]\r\nend\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n================================================================================\r\n    Error executing action `mount` on resource 'mount[\/var\/lib\/containers]'\r\n    ================================================================================\r\n\r\n    Mixlib::ShellOut::ShellCommandFailed\r\n    ------------------------------------\r\n    Expected process to exit with [0], but received '32'\r\n    ---- Begin output of [\"mount\", \"-t\", \"xfs\", \"-o\", \"defaults\", \"\/dev\/my_mount\", \"\/var\/lib\/containers\"] ----\r\n    STDOUT:\r\n    STDERR: mount: \/var\/lib\/containers: \/dev\/mapper\/my_mount already mounted on \/var\/lib\/containers.\r\n    ---- End output of [\"mount\", \"-t\", \"xfs\", \"-o\", \"defaults\", \"\/dev\/my_mount\", \"\/var\/lib\/containers\"] ----\r\n    Ran [\"mount\", \"-t\", \"xfs\", \"-o\", \"defaults\", \"\/dev\/my_mount\", \"\/var\/lib\/containers\"] returned 32\r\n\r\n    Resource Declaration:\r\n    ---------------------\r\n    # In \/var\/chef\/cache\/cookbooks\/podman\/recipes\/default.rb\r\n\r\n     11: mount <obfuscated>[:mount_point] do\r\n     12:   device <obfuscated>[:device]\r\n     13:   device_type <obfuscated>[:device_type]\r\n     14:   fstype <obfuscated>[:fstype]\r\n     15:   options <obfuscated>[:options]\r\n     16:   dump <obfuscated>[:dump]\r\n     17:   pass <obfuscated>[:pass]\r\n     18:   enabled <obfuscated>[:enabled]\r\n     19:   action [ :mount, :enable ]\r\n     20:   only_if { <obfuscated>[:enabled] == true }\r\n     21: end\r\n     22:\r\n\r\n    Compiled Resource:\r\n    ------------------\r\n    # Declared in \/var\/chef\/cache\/cookbooks\/podman\/recipes\/default.rb:11:in `from_file'\r\n\r\n    mount(\"\/var\/lib\/containers\") do\r\n      action [:mount, :enable]\r\n      default_guard_interpreter :default\r\n      declared_type :mount\r\n      cookbook_name \"podman\"\r\n      recipe_name \"default\"\r\n      device \"\/dev\/my_mount\"\r\n      device_type :device\r\n      fstype \"xfs\"\r\n      options [\"defaults\"]\r\n      dump 1\r\n      pass 1\r\n      enabled true\r\n      mount_point \"\/var\/lib\/containers\"\r\n      supports {:remount=>false}\r\n      fsck_device \"-\"\r\n      only_if { #code block }\r\n    end\r\n\r\n    System Info:\r\n    ------------\r\n    chef_version=17.10.3\r\n    platform=redhat\r\n    platform_version=8.8\r\n    ruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x86_64-linux]\r\n    program_name=\/usr\/bin\/chef-client\r\n    executable=\/opt\/chef\/bin\/chef-client\r\n\r\n\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\nSee above\r\n","comments":["Running in trace I also see that Chef reconizes that its already mounted during some evaulation.\r\n\r\n[2023-10-25T11:56:05-04:00] TRACE: Found mount \/dev\/mapper\/my_mount to \/var\/lib\/containers in \/etc\/fstab\r\n"],"labels":["Status: Untriaged"]},{"title":"Expose \"--filter-waived-controls\" option to chef client compliance phase","body":"### Describe the Enhancement:\r\n\r\nIn order to address EPIC: [#5068 Fix skipping of controls to actually do what it says](https:\/\/github.com\/inspec\/inspec\/issues\/5068), the pull request [PR#5327](https:\/\/github.com\/inspec\/inspec\/pull\/5327) has been merged into Inspec. It adds the  ```--filter-waived-controls``` to help honour the waived controls.\r\n\r\nAs a chef-client user, I would like to have an homologous option available in the chef client compliance phase.\r\n\r\n### Describe the Need:\r\n\r\nAny user running chef-client compliance phase who wants to use waivers.\r\n\r\n### Current Alternative\r\n\r\nThe only alternative is to run inspec via CLI using the aforementioned option.\r\n\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Omnitruck artifact does not exist for Rocky Linux","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<https:\/\/omnitruck.chef.io\/install.sh> is now setting platform to \"rocky\" for rocky linux.  Previously it was setting platform to \"el\".\r\n\r\nThe download url created by `install.sh` is now (notice the p=rocky)\r\n<https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=17.10&p=rocky&pv=8.8&m=x86_64>\r\nunfortunately that url returns a 404\r\n\r\nPreviously(2023-Oct-13) the url created by `install.sh` for rocky linux was\r\n<https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=17.10&p=el&pv=8&m=x86_64>\r\nnotice p=el and pv=8\r\n\r\nIt looks like `install.sh` was recently updated to better account for the contents of rocky linux's `\/etc\/os-release` but <https:\/\/omnitruck.chef.io\/stable\/chef\/metadata> wasn't updated for the new values returned from the updated `install.sh`\r\n\r\n## Chef Version\r\nChef Infra Client: ALL\r\n\r\n## Platform Version\r\nRocky Linux 8\r\n\r\n## Replication Case\r\n\r\nThese rocky specific values return 404\r\n```\r\ncurl -v \"https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=17.10&p=rocky&pv=8.8&m=x86_64\"\r\ncurl -v \"https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=17&p=rocky&pv=8.8&m=x86_64\"\r\ncurl -v \"https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18.2&p=rocky&pv=8.8&m=x86_64\"\r\ncurl -v \"https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18.3&p=rocky&pv=8.8&m=x86_64\"\r\ncurl -v \"https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18&p=rocky&pv=8.8&m=x86_64\"\r\n```\r\n\r\nThese generic \"el\" values return valid data\r\n```\r\ncurl -v \"https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=17.10&p=el&pv=8.8&m=x86_64\"\r\ncurl -v \"https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=17&p=el&pv=8.8&m=x86_64\"\r\ncurl -v \"https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18.2&p=el&pv=8.8&m=x86_64\"\r\n\r\n# notice these return a url for el7, not el8.  this should probably also be fixed\r\ncurl -v \"https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18.3&p=el&pv=8.8&m=x86_64\"\r\ncurl -v \"https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18&p=el&pv=8.8&m=x86_64\"\r\n```\r\n\r\n\r\n## Client Output\r\noutput from broken attempt (2023-Oct-18]\r\nnotice the platform is being set to `rocky`\r\n```\r\n[2023-10-18T03:26:42.629Z]     amazon-ebs: Now we can run chef-colo version 17.10\r\n[2023-10-18T03:26:42.629Z]     amazon-ebs:\r\n[2023-10-18T03:26:42.629Z] ==> amazon-ebs: Provisioning with chef-solo\r\n[2023-10-18T03:26:42.629Z]     amazon-ebs: Installing Chef...\r\n[2023-10-18T03:26:42.629Z] ==> amazon-ebs:   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n[2023-10-18T03:26:42.629Z] ==> amazon-ebs:                                  Dload  Upload   Total   Spent    Left  Speed\r\n[2023-10-18T03:26:42.629Z] ==> amazon-ebs: 100 23710  100 23710    0     0  1218k      0 --:--:-- --:--:-- --:--:-- 1218k\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: rocky 8.8 x86_64\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: Getting information for chef stable 17.10 for rocky...\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: downloading https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=17.10&p=rocky&pv=8.8&m=x86_64\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs:   to file \/tmp\/install.sh.5941\/metadata.txt\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: trying wget...\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: ERROR 404\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: Omnitruck artifact does not exist for version 17.10 on platform rocky\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs:\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: Either this means:\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs:    - We do not support rocky\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs:    - We do not have an artifact for 17.10\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs:\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: This is often the latter case due to running a prerelease or RC version of Chef\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: or a gem version which was only pushed to rubygems and not omnitruck.\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs:\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: You may be able to set your knife[:bootstrap_version] to the most recent stable\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: release of Chef to fix this problem (or the most recent stable major version number).\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs:\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: In order to test the version parameter, adventurous users may take the Metadata URL\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: below and modify the '&v=<number>' parameter until you successfully get a URL that\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: does not 404 (e.g. via curl or wget).  You should be able to use '&v=11' or '&v=12'\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: successfully.\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs:\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: If you cannot fix this problem by setting the bootstrap_version, it probably means\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: that rocky is not supported.\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs:\r\n[2023-10-18T03:26:42.630Z]     amazon-ebs: Metadata URL: https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=17.10&p=rocky&pv=8.8&m=x86_64\r\n```\r\n\r\n\r\noutput from successful attempt (2023-Oct-13)\r\nnotice the platform is being set to `el`\r\n```\r\n[2023-10-13T17:26:50.210Z] ==> amazon-ebs: Provisioning with chef-solo\r\n[2023-10-13T17:26:50.210Z]     amazon-ebs: Installing Chef...\r\n[2023-10-13T17:26:50.210Z] ==> amazon-ebs:   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n[2023-10-13T17:26:50.210Z] ==> amazon-ebs:                                  Dload  Upload   Total   Spent    Left  Speed\r\n[2023-10-13T17:26:50.210Z] ==> amazon-ebs: 100 23526  100 23526    0     0   522k      0 --:--:-- --:--:-- --:--:--  522k\r\n[2023-10-13T17:26:50.210Z]     amazon-ebs: el 8 x86_64\r\n[2023-10-13T17:26:50.210Z]     amazon-ebs: Getting information for chef stable 17.10 for el...\r\n[2023-10-13T17:26:50.210Z]     amazon-ebs: downloading https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=17.10&p=el&pv=8&m=x86_64\r\n[2023-10-13T17:26:50.210Z]     amazon-ebs:   to file \/tmp\/install.sh.5906\/metadata.txt\r\n[2023-10-13T17:26:50.210Z]     amazon-ebs: trying wget...\r\n[2023-10-13T17:26:50.771Z]     amazon-ebs: sha1\t25ba625102b3d8d0200f923afe7ccc296945f20a\r\n[2023-10-13T17:26:50.771Z]     amazon-ebs: sha256\tc02dea79437b38a8b9e6f4c8d984318b16005ee8ade724708d4312e267d98dbb\r\n[2023-10-13T17:26:50.771Z]     amazon-ebs: url\thttps:\/\/packages.chef.io\/files\/stable\/chef\/17.10.3\/el\/8\/chef-17.10.3-1.el8.x86_64.rpm\r\n[2023-10-13T17:26:50.771Z]     amazon-ebs: version\t17.10.3\r\n[2023-10-13T17:26:50.771Z]     amazon-ebs: downloaded metadata file looks valid...\r\n[2023-10-13T17:26:50.771Z]     amazon-ebs: downloading https:\/\/packages.chef.io\/files\/stable\/chef\/17.10.3\/el\/8\/chef-17.10.3-1.el8.x86_64.rpm\r\n[2023-10-13T17:26:50.771Z]     amazon-ebs:   to file \/tmp\/install.sh.5906\/chef-17.10.3-1.el8.x86_64.rpm\r\n[2023-10-13T17:26:50.771Z]     amazon-ebs: trying wget...\r\n[2023-10-13T17:26:51.026Z]     amazon-ebs: Comparing checksum with sha256sum...\r\n[2023-10-13T17:26:51.026Z]     amazon-ebs: Installing chef 17.10\r\n[2023-10-13T17:26:51.027Z]     amazon-ebs: installing with rpm...\r\n```\r\n\r\nSomething changed with `install.sh` between 2023-Oct-13 and 2023-Oct-18.\r\n\r\n## additional info\r\n\r\nHere are the contents of `\/etc\/os-release` from my rocky 8 box\r\n```\r\nNAME=\"Rocky Linux\"\r\nVERSION=\"8.8 (Green Obsidian)\"\r\nID=\"rocky\"\r\nID_LIKE=\"rhel centos fedora\"\r\nVERSION_ID=\"8.8\"\r\nPLATFORM_ID=\"platform:el8\"\r\nPRETTY_NAME=\"Rocky Linux 8.8 (Green Obsidian)\"\r\nANSI_COLOR=\"0;32\"\r\nLOGO=\"fedora-logo-icon\"\r\nCPE_NAME=\"cpe:\/o:rocky:rocky:8:GA\"\r\nHOME_URL=\"https:\/\/rockylinux.org\/\"\r\nBUG_REPORT_URL=\"https:\/\/bugs.rockylinux.org\/\"\r\nSUPPORT_END=\"2029-05-31\"\r\nROCKY_SUPPORT_PRODUCT=\"Rocky-Linux-8\"\r\nROCKY_SUPPORT_PRODUCT_VERSION=\"8.8\"\r\nREDHAT_SUPPORT_PRODUCT=\"Rocky Linux\"\r\nREDHAT_SUPPORT_PRODUCT_VERSION=\"8.8\"\r\n```\r\n\r\nContents of `\/etc\/os-release` have **not** change between 2023-Oct-13 and 2023-Oct-18.\r\n","comments":["this patch fixes `install.sh` found at <https:\/\/omnitruck.chef.io\/install.sh>\r\n\r\n```\r\n--- install.sh.orig     2023-10-19 13:45:24.733410719 -0500\r\n+++ install.sh  2023-10-19 13:45:56.159421315 -0500\r\n@@ -440,7 +440,7 @@\r\n        source \/etc\/os-release\r\n        os=\"${REDHAT_SUPPORT_PRODUCT}\"\r\n        platform_version=\"${ROCKY_SUPPORT_PRODUCT_VERSION}\"\r\n-        platform=$ID\r\n+        platform=\"redhat\"\r\n\r\n   elif test \"$platform\" = \"xenserver\"; then\r\n     # Current XenServer 6.2 is based on CentOS 5, platform is not reset to \"el\" server should handle response\r\n```","Argh, bitten by the same issue here... Thank you for the write-up @gpanula!\r\nWould it make sense to open an issue over at https:\/\/github.com\/chef\/omnitruck ?","Thanks @gpanula for details. I am blocked because of the same, was wondering if there is way to get the older install.sh while the current one gets fixed","> Argh, bitten by the same issue here... Thank you for the write-up @gpanula! Would it make sense to open an issue over at https:\/\/github.com\/chef\/omnitruck ?\r\n\r\nThanks, I wasn't aware of the omnitruck repo.\r\nI've opened <https:\/\/github.com\/chef\/omnitruck\/issues\/600>  for this issue in that repo.\r\n","Running this sed command on the rocky linux machine will work-around the issue\r\n```\r\nsed -e 's\/^ID=\"[^\"]*\"\/ID=\"redhat\"\/' -i \/etc\/os-release\r\n```","@gpanula , thanks for reporting the issue, the install.sh changes that generated the issue have been reverted now.\r\nFeel free to verify again an report back if the issue still persists.","https:\/\/omnitruck.chef.io\/install.sh works for me as it has parameter `p=el`\r\n\r\nBut test kitchen fails. My kitchen.yml contains this:\r\n\r\n```yml\r\n  - name: rocky8\r\n    driver:\r\n      image_urn: center-for-internet-security-inc:cis-rocky:cis-rockylinux-8-l1-gen2:latest\r\n      plan:\r\n        name: \"cis-rockylinux-8-l1-gen2\"\r\n        product: \"cis-rocky\"\r\n        publisher: \"center-for-internet-security-inc\"\r\n    transport:\r\n      name: ssh\r\n      elevated: true\r\n    provisioner:\r\n      name: chef_infra\r\n      product_name: chef\r\n      # product_version: 17.10.95 # https:\/\/github.com\/chef\/omnitruck\/issues\/600\r\n      product_version: 18.3.0\r\n      always_update_cookbooks: true\r\n      chef_license: accept-no-persist\r\n      root_path: \/home\/azure\/test-kitchen # default \/tmp has noexec on CIS hardened images\r\n```\r\n\r\nerror is\r\n\r\n```\r\n       Preparing client.rb\r\n       rocky 8.7 x86_64\r\n       Getting information for chef stable 18.3.0 for rocky...\r\n       downloading https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18.3.0&p=rocky&pv=8.7&m=x86_64\r\n         to file \/home\/azure\/test-kitchen\/metadata.txt\r\n       trying curl...\r\n       Unable to retrieve a valid package!\r\n       Version: 18.3.0\r\n```\r\n\r\nNote `p=rocky` in the URL.\r\n\r\nThere is no problem with 17.10.95\r\n\r\nWorkaround is to add:\r\n\r\n```\r\n    lifecycle:\r\n      pre_converge:\r\n        remote: mkdir -p \/home\/azure\/test-kitchen && cd \/home\/azure\/test-kitchen && curl -Os https:\/\/omnitruck.chef.io\/install.sh && chmod +x install.sh && sudo .\/install.sh -d \/home\/azure\/test-kitchen\r\n```","In 18.4.2 `https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18.4.2&p=rocky&pv=8.7&m=x86_64` seems to be good now.","Well...\r\n\r\nhttps:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18.2.7&p=rocky&pv=8.8&m=x86_64 had been working fine for us for months, until it seems to have fallen off the bandwagon today. We'd only do the `\"sudo sed -e 's\/^ID=\\\"[^\\\"]*\\\"\/ID=\\\"redhat\\\"\/' -i \/etc\/os-release\"` hack on < 18.2.7, but have now had to extend that to 18.2.7 as well.\r\n\r\nhttps:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18.4.2&p=rocky&pv=8.8&m=x86_64 is fine, but is it a \"feature\" that previous artifacts evaporate all of a sudden?\r\n\r\nThanks!","\ud83d\udc40 ","There are no artifacts for ARM64(aarch64) either."],"labels":["Status: Untriaged"]},{"title":"homebrew_update TypeError when running under launchd","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nI've been seeing an increase of failures in the `homebrew_update` resource when Chef is being ran under launchd on macOS.\r\n\r\nThe error is this:\r\n```\r\n      ================================================================================\r\n      Error executing action `periodic` on resource 'homebrew_update[macOS]'\r\n      ================================================================================\r\n\r\n      TypeError\r\n      ---------\r\n      no implicit conversion of false into String\r\n\r\n      Cookbook Trace: (most recent call first)\r\n      ----------------------------------------\r\n      \/var\/chef\/cache\/cookbooks\/cpe_homebrew\/resources\/cpe_homebrew_manage.rb:40:in `block in class_from_file'\r\n\r\n      Resource Declaration:\r\n      ---------------------\r\n      # In \/var\/chef\/cache\/cookbooks\/cpe_homebrew\/resources\/cpe_homebrew_manage.rb\r\n\r\n       40:     homebrew_update 'macOS' do\r\n       41:       frequency 86400\r\n       42:       action :periodic\r\n       43:       ignore_failure true\r\n       44:       retries 1\r\n       45:     end\r\n       46:   end\r\n       \r\n```\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n18.3.0\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nmacOS\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\nAdd the `homebrew_update` resource to a recipe and run Chef job via launchd. \r\n\r\n(i.e. `sudo launchctl unload \/Library\/LaunchDaemon\/com.chef.chef-client.plist && sudo launchctl load \/Library\/LaunchDaemon\/com.chef.chef-client.plist`)\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n[2023-10-19T10:46:37-05:00] ERROR: homebrew_update[macOS] (cpe_homebrew::default line 40) had an error: TypeError: no implicit conversion of false into String; ignore_failure is set, continuing\r\n\r\n      ================================================================================\r\n      Error executing action `periodic` on resource 'homebrew_update[macOS]'\r\n      ================================================================================\r\n\r\n      TypeError\r\n      ---------\r\n      no implicit conversion of false into String\r\n\r\n      Cookbook Trace: (most recent call first)\r\n      ----------------------------------------\r\n      \/var\/chef\/cache\/cookbooks\/cpe_homebrew\/resources\/cpe_homebrew_manage.rb:40:in `block in class_from_file'\r\n\r\n      Resource Declaration:\r\n      ---------------------\r\n      # In \/var\/chef\/cache\/cookbooks\/cpe_homebrew\/resources\/cpe_homebrew_manage.rb\r\n\r\n       40:     homebrew_update 'macOS' do\r\n       41:       frequency 86400\r\n       42:       action :periodic\r\n       43:       ignore_failure true\r\n       44:       retries 1\r\n       45:     end\r\n       46:   end\r\n\r\n      Compiled Resource:\r\n      ------------------\r\n      # Declared in \/var\/chef\/cache\/cookbooks\/cpe_homebrew\/resources\/cpe_homebrew_manage.rb:40:in `block in class_from_file'\r\n\r\n      homebrew_update(\"macOS\") do\r\n        action [:periodic]\r\n        default_guard_interpreter :default\r\n        declared_type :homebrew_update\r\n        cookbook_name \"cpe_homebrew\"\r\n        recipe_name \"default\"\r\n        frequency 86400\r\n        ignore_failure true\r\n        retries 1\r\n      end\r\n\r\n      System Info:\r\n      ------------\r\n      chef_version=18.3.0\r\n      platform=mac_os_x\r\n      platform_version=14.0\r\n      ruby=ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [arm64-darwin20]\r\n      program_name=\/opt\/chef\/bin\/chef-client\r\n      executable=\/opt\/chef\/bin\/chef-client\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":["Possibly related to changes in https:\/\/github.com\/chef\/chef\/pull\/13669 ?\r\n\r\nI'm puzzled how `false` is being surfaced here when I clearly have the right types for the resource."],"labels":["Status: Untriaged"]},{"title":"reset_property raising NoMethodError exception","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nCustom resource reset_property raising NoMethodError\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nI tried with 17.10.3 as well as 18.2.7\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nOracle Linux 8\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\nI can't quite put my custom resource code here but essentially it is working fine except for when I add reset_property anywhere in my code. It can be inside or outside of action block. I tried in action_class block as well and all is failing with no method error exception.\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\nThis the debug output for the failure, \r\n```\r\nI, [2023-10-11T17:20:25.794709 #3277240]  INFO -- standard-oraclelinux-8:   * podman_registry[<removed>] action create[2023-10-11T22:20:25+00:00] INFO: Processing podman_registry[dockerhub-ilcb.travelclick.net] action create (cookbook_podman::default line 47)\r\nI, [2023-10-11T17:20:25.929847 #3277240]  INFO -- standard-oraclelinux-8: \r\nI, [2023-10-11T17:20:25.930361 #3277240]  INFO -- standard-oraclelinux-8:     \r\nI, [2023-10-11T17:20:25.930724 #3277240]  INFO -- standard-oraclelinux-8:     ================================================================================\r\nI, [2023-10-11T17:20:25.931010 #3277240]  INFO -- standard-oraclelinux-8:     Error executing action `create` on resource 'podman_registry[<removed>]'\r\nI, [2023-10-11T17:20:25.931278 #3277240]  INFO -- standard-oraclelinux-8:     ================================================================================\r\nI, [2023-10-11T17:20:25.931541 #3277240]  INFO -- standard-oraclelinux-8:     \r\nI, [2023-10-11T17:20:25.931820 #3277240]  INFO -- standard-oraclelinux-8:     NoMethodError\r\nI, [2023-10-11T17:20:25.932105 #3277240]  INFO -- standard-oraclelinux-8:     -------------\r\nI, [2023-10-11T17:20:25.998135 #3277240]  INFO -- standard-oraclelinux-8:     undefined method `reset_property' for #<#<Class:0x00007f2dcf139d78>:0x00007f2dd09c1c38 \r\n```\r\n\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Mutating operations on Node attribute Arrays are not triggering \"attribute_changed\" event","body":"## Description\r\n\r\nUpdating in place a Node attribute Array does not trigger the `attribute_changed` event.\r\n\r\n## Chef Version\r\n17.9.46\r\n\r\n## Platform Version\r\n- CentOS 7\r\n- CentOS Stream 8\r\n- Windows Server 2016\r\n\r\n## Replication Case\r\n\r\nIn an attribute file put the following code:\r\n\r\n```ruby\r\ndefault['attribute_changed'] = false\r\ndefault['array'] = []\r\n::Chef.event_handler do\r\n  on :attribute_changed do |_precedence, path, _value|\r\n    ::Chef.node.default['attribute_changed'] = true if path == ['array']\r\n  end\r\nend\r\ndefault['array'] << 1\r\n\r\nraise 'It does not work!' unless node['attribute_changed']\r\n```\r\n\r\nNote: this does not work in `chef-shell` - I guess there is a tiny difference in the way event handlers are set and my hack (for the repro) does not work...\r\n\r\n## Client Output\r\n\r\n```\r\nRuntimeError\r\n------------\r\nIt does not work!\r\n\r\nCookbook Trace: (most recent call first)\r\n----------------------------------------\r\n  \/var\/chef\/cache\/cookbooks\/test_cookbook\/attributes\/default.rb:10:in `from_file'\r\n\r\nRelevant File Content:\r\n----------------------\r\n\/var\/chef\/cache\/cookbooks\/test_cookbook\/attributes\/default.rb:\r\n\r\n  4:    on :attribute_changed do |precedence, path, value|\r\n  5:      ::Chef.node.default['attribute_changed'] = true if path == ['array']\r\n  6:    end\r\n  7:  end\r\n  8:  default['array'] << 1\r\n  9:\r\n 10>> raise 'It does not work!' unless node['attribute_changed']\r\n```\r\n\r\n## Expected behaviour\r\n\r\nNo error, and `node['attribute_changed'] == true`","comments":[],"labels":["Status: Untriaged"]},{"title":"Node object has tag but no untag","body":"### Describe the Enhancement:\r\nyou can call `node.tag(\"new_tag\")` but not `node.untag(\"removed_tag\")` this is not a consistent behavior\r\n\r\n### Describe the Need:\r\nThis just brings the functionality in line, the old method is linked to the new one for compatibility reason\r\n\r\n### Current Alternative\r\nAlternative is to call delete on the node.tags directly \r\n\r\n### Can We Help You Implement This?:\r\nThe issue is being created to link to already existing PR\r\n","comments":[],"labels":["Status: Waiting on Release"]},{"title":"SonarQube config broken for internal contributors","body":"## Description\r\n[PR #13672](https:\/\/github.com\/chef\/chef\/pull\/13672) introduced SonarQube to the PR process, but it returns `ERROR: You're not authorized to run analysis. Please contact the project administrator.` \r\n\r\nWe're disabling it with [#13985](https:\/\/github.com\/chef\/chef\/pull\/13985) until it can be fixed, so that we can have top level visibility of failures of working validations.","comments":[],"labels":["Status: Untriaged"]},{"title":"\"can't modify frozen Chef::Node::ImmutableMash\" when reading node attributes","body":"## Description\r\nCopying from chef-infra-dev slack channel from report from fretb\r\n\r\n> We use the value of another attribute for the default of nginx_ports, maybe that\u2019s the cause.\r\n\r\nI've written a bunch of unit tests trying to repro the issue on my end (tests in a branch at https:\/\/github.com\/dafyddcrosby\/chef\/tree\/13981_regression), but I think we'll need a smaller repro that can be shared to fish this one out.\r\n\r\n## Chef Version\r\nRegression occurs from 18.2.7 to 18.3.0\r\n\r\n## Client Output\r\nIssue is on cinc build, but given the problem it's possible this surfaced due to https:\/\/github.com\/chef\/chef\/commit\/42a076b15384dc4451dfbd0026c6b8d31d0774c1 (or less likely https:\/\/github.com\/chef\/chef\/commit\/2d3c0d34b135c8a4e42b8f55531df2219edb96dd).  \r\n\r\n```\r\n         ================================================================================\r\n         Recipe Compile Error in \/var\/tmp\/kitchen\/cache\/cookbooks\/nginx\/recipes\/default.rb\r\n         ================================================================================\r\n         \r\n         FrozenError\r\n         -----------\r\n         can't modify frozen Chef::Node::ImmutableMash: {\"http\"=>{\"port\"=>nil, \"enabled\"=>false}, \"https\"=>{\"port\"=>443, \"enabled\"=>true}}\r\n         \r\n         Cookbook Trace: (most recent call first)\r\n         ----------------------------------------\r\n           \/var\/tmp\/kitchen\/cache\/cookbooks\/nginx\/recipes\/default.rb:12:in `https_active?'\r\n         \r\n         Relevant File Content:\r\n         ----------------------\r\n         \/var\/tmp\/kitchen\/cache\/cookbooks\/nginx\/recipes\/default.rb:\r\n         \r\n          11:  def https_active?\r\n          12>>   return true if node.read(\"nginx\", \"ports\", \"https\", \"enabled\")\r\n          13:    false\r\n          14:  end\r\n```\r\n\r\n```\r\n18.3.0\r\n[7] pry(#<Chef::Recipe>)> node.read(\"nginx\").dup[\"ports\"]\r\n=> {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\n[8] pry(#<Chef::Recipe>)> node.read(\"nginx\")[\"ports\"]\r\nFrozenError: can't modify frozen Chef::Node::ImmutableMash: {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\nfrom \/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/node\/mixin\/state_tracking.rb:56:in `__path__='\r\n[9] pry(#<Chef::Recipe>)> node.read(\"nginx\", \"ports\")\r\nFrozenError: can't modify frozen Chef::Node::ImmutableMash: {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\nfrom \/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/node\/mixin\/state_tracking.rb:56:in `__path__='\r\n[10] pry(#<Chef::Recipe>)> node[\"nginx\"][\"ports\"]\r\nFrozenError: can't modify frozen Chef::Node::ImmutableMash: {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\nfrom \/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/node\/mixin\/state_tracking.rb:56:in `__path__='\r\n[11] pry(#<Chef::Recipe>)> node[\"nginx\"].dup[\"ports\"]\r\n=> {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\n18.2.7\r\n[1] pry(#<Chef::Recipe>)> node.read(\"nginx\").dup[\"ports\"]\r\n=> {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\n[2] pry(#<Chef::Recipe>)> node.read(\"nginx\")[\"ports\"]\r\n=> {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\n[3] pry(#<Chef::Recipe>)> node.read(\"nginx\", \"ports\")\r\n=> {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\n[4] pry(#<Chef::Recipe>)> node[\"nginx\"][\"ports\"]\r\n=> {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\n[5] pry(#<Chef::Recipe>)> node[\"nginx\"].dup[\"ports\"]\r\n=> {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\n[6] pry(#<Chef::Recipe>)>\r\n```\r\n\r\n## Stacktrace\r\n```\r\nGenerated at 2023-10-03 07:21:51 +0200\r\nFrozenError: can't modify frozen Chef::Node::ImmutableMash: {\"http\"=>{\"port\"=>8000, \"enabled\"=>true}, \"https\"=>{\"port\"=>443, \"enabled\"=>false}}\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/node\/mixin\/state_tracking.rb:56:in `__path__='\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/node\/mixin\/state_tracking.rb:86:in `copy_state_to'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/node\/mixin\/state_tracking.rb:41:in `[]'\r\n\/var\/tmp\/kitchen\/cache\/cookbooks\/nginx\/recipes\/default.rb:12:in `https_active?'\r\n\/var\/tmp\/kitchen\/cache\/cookbooks\/nginx\/recipes\/sock.rb:18:in `from_file'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/mixin\/from_file.rb:34:in `instance_eval'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/mixin\/from_file.rb:34:in `from_file'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook_version.rb:233:in `load_ruby_recipe'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook_version.rb:203:in `load_recipe'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/run_context.rb:429:in `load_recipe'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/run_context.rb:385:in `block in include_recipe'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/run_context.rb:384:in `each'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/run_context.rb:384:in `include_recipe'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/dsl\/include_recipe.rb:26:in `include_recipe'\r\n\/var\/tmp\/kitchen\/cache\/cookbooks\/nginx\/recipes\/default.rb:5:in `from_file'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/mixin\/from_file.rb:34:in `instance_eval'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/mixin\/from_file.rb:34:in `from_file'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook_version.rb:233:in `load_ruby_recipe'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook_version.rb:203:in `load_recipe'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/run_context.rb:429:in `load_recipe'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/run_context\/cookbook_compiler.rb:228:in `block in compile_recipes'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/run_context\/cookbook_compiler.rb:225:in `each'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/run_context\/cookbook_compiler.rb:225:in `compile_recipes'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/run_context\/cookbook_compiler.rb:109:in `compile'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/run_context.rb:259:in `load'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/policy_builder\/expand_node_object.rb:103:in `setup_run_context'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/3.1.0\/forwardable.rb:238:in `setup_run_context'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/client.rb:508:in `setup_run_context'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/client.rb:294:in `run'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/application.rb:264:in `run_chef_client'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/application\/base.rb:354:in `run_application'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/application.rb:67:in `run'\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-bin-18.3.0\/bin\/cinc-client:25:in `<top (required)>'\r\n\/opt\/cinc\/bin\/cinc-client:180:in `load'\r\n\/opt\/cinc\/bin\/cinc-client:180:in `<main>'\r\n```","comments":["Ok, so this is interesting, I found out this happens due to the attribute being used as a default value for a property in a resource:\n\n`property :ports, Hash, default: node[\"nginx\"][\"ports\"]`\n\nWhen changing this to `property :ports, Hash, default: node[\"nginx\"][\"ports\"].dup`, the error is not triggered anymore."],"labels":["Status: Untriaged"]},{"title":"Current Chef RPM gpg key (https:\/\/packages.chef.io\/chef.asc) is failing validation with Sequoia","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n## Description\r\nThe current Chef RPM gpg key (https:\/\/packages.chef.io\/chef.asc) is failing validation with Sequoia:\r\n$ curl -s https:\/\/packages.chef.io\/chef.asc | sq-keyring-linter -\r\n\r\n## Chef Version\r\nThis issue is not version specific, but 14 and 17\r\n\r\n## Platform Version\r\nThis causes failures in Fedora 38 and later, Fedora ELN and CentOS Stream 10 and later\r\n\r\n## Replication Case\r\n 1) Get the sq-keyring-linter from https:\/\/crates.io\/crates\/sequoia-keyring-linter. \r\n 2) run the key through the linter: curl -s https:\/\/packages.chef.io\/chef.asc | sq-keyring-linter - \r\n 3) Fix this by using the --fix command in the linter (see the manpages for questions about this) \r\n\r\n## Output\r\nLinter output: Certificate is not valid under the standard policy + SHA-1: Policy rejected asymmetric algorithm\r\nExamined 1 certificate.\r\n  1 certificate is invalid and was not linted. (BAD)\r\n\r\n```\r\n\r\n```\r\n\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Chef client bug report template still references ChefDK","body":"## Description\r\nChefDK is super gone now, replaced by Chef Workstation https:\/\/github.com\/chef\/chef-workstation\r\n\r\nFile is here:\r\nhttps:\/\/github.com\/chef\/chef\/blob\/main\/.github\/ISSUE_TEMPLATE\/BUG_TEMPLATE.md?plain=1#L15\r\n\r\nEasy task for a first-time committer","comments":[],"labels":["Status: Untriaged"]},{"title":"Create target_mode.md","body":"Signed-off-by: honasagere <prashanth.hn@progress.com>\r\nDate:   Wed Sep 27 2023 \r\n\r\nCreated a placeholder documentation for target mode design document\r\n\r\n<!--- Provide a short summary of your changes in the Title above -->\r\n\r\n## Description\r\n<!--- Describe your changes in detail, what problems does it solve? -->\r\n\r\n## Related Issue\r\n<!--- If you are suggesting a new feature or change, please create an issue first -->\r\n<!--- Please link to the issue, discourse, or stackoverflow here: -->\r\n\r\n## Types of changes\r\n<!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: -->\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [ ] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n<!--- If you're unsure about any of these, don't hesitate to ask. We're here to help! -->\r\n- [x] I have read the **CONTRIBUTING** document.\r\n- [x] I have run the pre-merge tests locally and they pass.\r\n- [x] I have updated the documentation accordingly.\r\n- [x] I have added tests to cover my changes.\r\n- [x] All new and existing tests passed.\r\n- [x] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=13960)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13960&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13960&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13960&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13960&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13960&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13960&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13960&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13960&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13960&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13960&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13960&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13960&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13960) No Coverage information  \n[![No Duplication information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/NoDuplicationInfo-16px.png 'No Duplication information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13960&metric=duplicated_lines_density&view=list) No Duplication information\n\n"],"labels":["Status: Waiting on Contributor"]},{"title":"Chef shell broken in 18.3.0","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\n\r\nchef-shell fails to launch when using the infra client session switch (-z) after updating to infra client 18.3.0, this did not happen before. \r\n\r\nSuspect PR https:\/\/github.com\/chef\/chef\/pull\/13766\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n18.3.0\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nAny platform, issues seen on MacOS, Windows, Linux, of various flavours\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\nRun chef-shell -z when a node contains a cookbook with attributes\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\nloading configuration: \/etc\/chef\/client.rb\r\ntrue\r\nSession type: client\r\nLoading.......Resolving cookbooks for run list: [\"systems\", \"icinga2\", \"icinga2_master\", \"icinga2_web\"]\r\n.\r\n================================================================================\r\nError Syncing Cookbooks:\r\n================================================================================\r\n\r\nUnexpected Error:\r\n-----------------\r\nNoMethodError: undefined method `to_set' for [\"attributes\/default.rb\"]:Array\r\n\r\nSystem Info:\r\n------------\r\nchef_version=18.3.0\r\nplatform=centos\r\nplatform_version=7.8.2003\r\nruby=ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\nprogram_name=\/usr\/bin\/chef-shell\r\nexecutable=\/opt\/chef\/bin\/chef-shell\r\n\r\n\r\n```\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n```\r\nepic fail!\r\n\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook\/synchronizer.rb:243:in `block (2 levels) in remove_deleted_files': undefined method `to_set' for [\"attributes\/default.rb\"]:Array (NoMethodError)\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook\/synchronizer.rb:241:in `each_key'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook\/synchronizer.rb:241:in `block in remove_deleted_files'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook\/synchronizer.rb:240:in `each_key'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook\/synchronizer.rb:240:in `remove_deleted_files'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook\/synchronizer.rb:268:in `clear_obsoleted_cookbooks'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/cookbook\/synchronizer.rb:169:in `sync_cookbooks'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/policy_builder\/expand_node_object.rb:205:in `sync_cookbooks'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/3.1.0\/forwardable.rb:238:in `sync_cookbooks'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/client.rb:496:in `sync_cookbooks'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/shell\/shell_session.rb:213:in `rebuild_context'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/shell\/shell_session.rb:61:in `block in reset!'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/shell\/shell_session.rb:105:in `loading'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/shell\/shell_session.rb:56:in `reset!'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/shell.rb:155:in `session'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/shell.rb:164:in `init'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.3.0\/lib\/chef\/shell.rb:83:in `start'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-bin-18.3.0\/bin\/chef-shell:31:in `<top (required)>'\r\n\tfrom \/usr\/bin\/chef-shell:180:in `load'\r\n\tfrom \/usr\/bin\/chef-shell:180:in `<main>'\r\n```","comments":["@dafyddcrosby do you have any bandwidth to follow-up with this issue that seems to have been introduced by the `.to_set` changes? I did a quick test and it *looks* like `Set` and the `#to_set` patch to `Array` should by default exist on 18's Ruby version.  (And you `require` it just in case, anyway)\r\n\r\n","I can sort it out today, will move it back to the earlier Hash implementation from that PR. Not sure why to_set isn't available, but I'll figure out why this wasn't found in the tests. Sorry about the regression @cisco-abrandel (also hi! \ud83d\udc4b)","Ok, we'll line this fix up for the next promotion to stable, but it should be available in the current channel relatively soon after merge (there's a current blocker on releases, but that may likely be resolved about the same time as this PR merges)","Thanks for the report @cisco-abrandel! \r\n\r\nIf you happen to run across signs why `require \"set\"` didn't load in this case, please tag it in here to help us chase down the cause of the regression."],"labels":["Type: Regression","Status: Waiting on Release"]},{"title":"About Monkey patch ruby for net\/http added verbosity in #13745","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nSince 18.3.0 merging and releasing https:\/\/github.com\/chef\/chef\/pull\/13745, these outputs started showing up as part of the monkey patch added in the given PR. Perhaps the `puts` should be moved to `Chef::Log.info` or `Chef::Log.debug`? \r\n\r\n## Chef Version\r\n18.3.0\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nhttps:\/\/github.com\/chef\/chef\/pull\/13745\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\nJust running chef-client in any affected env\/platform\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n$ sudo chef-client --format min\r\nChef Infra Client, version 18.3.0\r\nPatents: https:\/\/www.chef.io\/patents\r\nInfra Phase starting\r\nopening connection to chef.example.com:443...\r\nopened\r\nstarting SSL for chef.example.com:443...\r\nSSL established, protocol: TLSv1.2, cipher: ECDHE-ECDSA-AES256-GCM-SHA384\r\nopening connection to chef.example.com:443...\r\nopened\r\nstarting SSL for chef.example.com:443...\r\nSSL established, protocol: TLSv1.2, cipher: ECDHE-ECDSA-AES256-GCM-SHA384\r\nopening connection to chef.example.com:443...\r\nopened\r\n...\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\nN\/A\r\n","comments":["I vote for `Chef::Log.debug` as in the net\/http gem these are debug logs https:\/\/github.com\/ruby\/ruby\/blob\/v3_1_2\/lib\/net\/http.rb#L1702","I vote for `Chef:Log.debug`, we will do a downgrade on our clients for a while, in order to make the debug process less annoying ; which  truly is, with this noise around the logs . \r\n\r\nHope you can fix this soon.\r\n\r\nThanks!","This will catch the next Chef 18 promotion to stable. Still wrapping up Windows building issue but it will also be in any \"current\" channel release >= 18.3.0","Any news about removing those \"puts\" statements from the net\/http monkey patch?","This should be fixed in the next 18.4.x release that should be coming soon.","You should really focus more on QA as this issue is not the first one, which requires monkey patching a monkey patch","> You should really focus more on QA as this issue is not the first one, which requires monkey patching a monkey patch\r\n\r\nAgreed, but that's an \ud83c\udf32 problem in software engineering, compounded by the fact that there 20+ OS+architecture builds for each Chef version _and_ that, while extremely annoying, extraneous output to STDOUT is not in itself a functional breakage (and even in manual testing I can identify plenty of times where such obvious errors have slapped me in the face but I had tunnel vision on a different problem).\r\n\r\nPerhaps we need a scaffolding to validate output... or maybe even fail automated tests if `STDOUT.puts` is called?  I think something like `expect(STDOUT).not_to receive(:puts)` could do that, but it would have to be only for a subset of test cases, since we have legitimate uses of `STDOUT.puts` in shell and some other areas.\r\n\r\nOpen to ideas from the community to detect similar classes of errors.","@jkimalane I find your comment a bit harsh in its wording.\r\n\r\n@tpowell-progress naive idea: have a dumb run with a simple file resource against zero server and expect its stdout to exactly match something curated by a human (excluding the first line with the client version which couldn't match obvisouly). This should catch any extraneous output but will likely need update when wording change somewhere in the codebase but should catch unwanted things. I guess this could be extended to solo without zero with and withou dry-run enabled.\r\n\r\nFor the record a workaround is that you can dump the fixed file in the linked PR in a \"temp-fix\" cookbook `libraries` directory to cut the extra output to only early calls (before the cookbook is loaded) for test purposes and have a recipe with a file resource updating the 18.4 client file in place while waiting for the next release.\r\n\r\nLet me know if this is something getting traction, I'll author the cookbook if needed.","@Tensibai I think breakage on wording changes is acceptable, as long as the test failure and description itself indicates that wording changes need to be checked as possible \"false positives\""],"labels":["Status: Waiting on Release"]},{"title":"knife bootstrap is not working always giving this error kindly helpful","body":"ERROR: Train::Transports::SSHFailed: SSH session could not be established","comments":["@Bharatpg can you provide more details about:\r\n\r\n* Operating System\r\n* Installation Method\r\n* Details of files that you're attempting to run and a directory tree from there\r\n* Command that you're invoking\r\n\r\n"],"labels":["Triage: Needs Information"]},{"title":"Fix chef_client_config resource handlers","body":"Hello,\r\n\r\nWithout this change the handlers for chef_client_config resource do not work at all.","comments":["Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=13915)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13915&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13915&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13915&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13915&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13915&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13915&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13915&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13915&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13915&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13915&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13915&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13915&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13915) No Coverage information  \n[![0.0%](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/3-16px.png '0.0%')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13915&metric=new_duplicated_lines_density&view=list) [0.0% Duplication](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13915&metric=new_duplicated_lines_density&view=list)\n\n","@feld Thanks for your contribution... great catch!","@tpowell-progress We need to look into adding `test\/integration\/end-to-end\/_chef_client_config.rb` case for this and other options.","@feld can you add DCO sign-off to your commit (amend\/rebase with `-s` on `git commit`)"],"labels":["Status: Waiting on Contributor","documentation"]},{"title":"Slack invite tells people they need an @progress.com address","body":"Invite from https:\/\/community.chef.io\/slack\r\n\r\ntakes you to https:\/\/chefcommunity.slack.com\/signup#\/domain-signup\r\n\r\nwhich says:\r\n\r\n> Don't have an @progress.com email address? Contact the workspace administrator at Chef Community for an invitation.\r\n\r\nIt turns out there's a small link to get around it, but it's not clear.\r\n\r\nSee the thread here for more details and screenshots: https:\/\/app.slack.com\/client\/T0M1PBN4E\/C042KK33E8K\/thread\/C042KK33E8K-1693837893.033029\r\n\r\n","comments":["Hi @jaymzh \ud83d\udc4b, thanks for rising this. I've struggled with this yesterday, may I ask how I can ask for an invitation meanwhile?","Hi, @san983, email me at jeff.strauss@progress.com. Slack automatically refreshes public invite links every thirty days, and then the link on our community website goes stale. Kiah Tolliver used to update, and i'm working on getting access to the site's backend so I can make the edits myself.\r\n\r\nIn the meantime, if you email me private with your desired email address for Slack, I'll add you. Sorry for the headache.","> Hi, @san983, email me at [jeff.strauss@progress.com](mailto:jeff.strauss@progress.com). Slack automatically refreshes public invite links every thirty days, and then the link on our community website goes stale. Kiah Tolliver used to update, and i'm working on getting access to the site's backend so I can make the edits myself.\r\n> \r\n> In the meantime, if you email me private with your desired email address for Slack, I'll add you. Sorry for the headache.\r\n\r\nNo problem at all! Just sent you an email, thanks!","Hi @jstrauss , shall i send an email to jeff.strauss@progress.com ?,stuck at the same step for email with @progress email domain.","Quick update. We (finally!) got the access we needed to update the Chef Community webpage with the Slack public invite link. As of this past Friday (Deember 15), it should now be working. Keep in mind that Slack does auto-expire public invites after no more than 30 days. But we've set a calendar reminder to update it moving forward. Hopefully issues like this will be rare moving forward.","Great news! Nice work everyone.\r\n\r\nA few thoughts:\r\n* Is there [at least internal] documentation on how to get a new invite URL and update the site? If you and Heather win the lottery tomorrow, it'd be great if it was clear for the next folks to have a running headstart\r\n* Is there any possibility of automation here? I don't think much of the Slack API is exposed to free tiers, unfortunately, so this may not be possible, but figured I'd ask."],"labels":["Status: Untriaged","community-blockers"]},{"title":"Also host Chef docker images on GitHub Container Registry","body":"### Describe the Enhancement:\r\n[Docker Hub introduced usage limits](https:\/\/docs.docker.com\/docker-hub\/download-rate-limit\/), many projects now also host their docker images on [GitHub Container Registry (GHCR)](https:\/\/docs.github.com\/en\/packages\/working-with-a-github-packages-registry\/working-with-the-container-registry) to improve availability and increased speed for access by Github Actions which has unlimited read access to GHCR.\r\n\r\n### Describe the Need:\r\nThe system which pushes images to [Docker Hub](https:\/\/hub.docker.com\/r\/chef\/chef) should be updated to also push images to GHCR. \r\n\r\nRough outline:\r\n1) Enable GHCR \/ GitHub Packages on [chef](https:\/\/github.com\/chef) GitHub organisation. Allow public access.\r\n2) [GHCR login](https:\/\/docs.github.com\/en\/packages\/working-with-a-github-packages-registry\/working-with-the-container-registry#authenticating-to-the-container-registry)\r\n3) `docker tag chef[:TAG] ghcr.io\/chef\/[:TAG]`\r\n4) `docker push ghcr.io\/chef\/[:TAG]`\r\n\r\n### Current Alternative\r\nN\/A\r\n\r\n### Can We Help You Implement This?:\r\nYes, I am happy to attempt a PR if desired. I'd be new to expeditor.","comments":[],"labels":["Status: Untriaged"]},{"title":"Support OpenEuler OS in chef-client","body":"[openEuler](https:\/\/www.openeuler.org\/en\/ ) OS is based on [CentOS](https:\/\/www.centos.org\/) but is further developed by Huawei Technologies for enterprise applications.","comments":[],"labels":["Status: Untriaged"]},{"title":"chef_client_launchd resource accepts a splay of 0, but underlying rand call raises ArgumentError","body":"## Description\r\nIn #13095 the splay property of the `chef_client_launchd` resource was changed to allow for passing `0`, but when anyone actually uses it, the underlying call to `random.rand(splay)` in `splay_sleep_time` will throw an error.\r\n>           ArgumentError\r\n>           -------------\r\n>           invalid argument - 0\r\n\r\n\r\n## Chef Version\r\n18.1.0\r\n\r\n## Platform Version\r\nmacOS 11+ (issue found on 11.4, but should repro on all)\r\n\r\n## Replication Case\r\nCreate a policy that uses the chef_client_launchd resource in macOS\r\n```\r\nchef_client_launchd 'Setup the Chef Infra Client to run every 3 minutes' do\r\n  splay 0\r\n  action :enable\r\nend\r\n```\r\n\r\nTry to execute that policy.\r\n\r\n---\r\n\r\nBecause the underlying error is a case of passing invalid arguments to the `rand` function, it can repro'd with this ruby snippet in a terminal\r\nNo error when passing `1`:\r\n```\r\nruby -e 'puts Random.new(12345).rand(1)'\r\n0\r\n```\r\nArgumentError when passing `0`\r\n```\r\nruby -e 'puts Random.new(12345).rand(0)'\r\n-e:1:in `rand': invalid argument - 0 (ArgumentError)\r\n\tfrom -e:1:in `<main>'\r\n```\r\n\r\n## Client Output\r\nOutput from kitchen:\r\n```\r\n         * chef_client_launchd[Setup the Chef Infra Client to run every 3 minutes] action enable\r\n           \r\n           ================================================================================\r\n           Error executing action `enable` on resource 'chef_client_launchd[Setup the Chef Infra Client to run every 3 minutes]'\r\n           ================================================================================\r\n           \r\n           ArgumentError\r\n           -------------\r\n           invalid argument - 0\r\n           \r\n           Resource Declaration:\r\n           ---------------------\r\n           # In \/Users\/vagrant\/kitchen\/cache\/cookbooks\/redacted_name\/recipes\/chef_client.rb\r\n           \r\n             9: chef_client_launchd 'Setup the Chef Infra Client to run every 3 minutes' do\r\n            10:   accept_chef_license true\r\n            11:   interval 3\r\n            12:   splay 0\r\n            13:   action :enable\r\n            14: end\r\n            15: \r\n           \r\n           Compiled Resource:\r\n           ------------------\r\n           # Declared in \/Users\/vagrant\/kitchen\/cache\/cookbooks\/redacted_name\/recipes\/chef_client.rb:9:in `from_file'\r\n           \r\n           chef_client_launchd(\"Setup the Chef Infra Client to run every 3 minutes\") do\r\n             action [:enable]\r\n             default_guard_interpreter :default\r\n             declared_type :chef_client_launchd\r\n             cookbook_name \"redacted_name\"\r\n             recipe_name \"chef_client\"\r\n             accept_chef_license true\r\n             interval 3\r\n             splay 0\r\n             log_directory \"\/Library\/Logs\/Chef\"\r\n             user \"root\"\r\n             working_directory \"\/var\/root\"\r\n           end\r\n           \r\n           System Info:\r\n           ------------\r\n           chef_version=18.1.0\r\n           platform=mac_os_x\r\n           platform_version=11.4\r\n           ruby=ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-darwin19]\r\n           program_name=\/opt\/chef\/bin\/chef-client\r\n           executable=\/opt\/chef\/bin\/chef-client\r\n           \r\n       \r\n       Running handlers:\r\n       [2023-08-25T19:04:57-07:00] ERROR: Running exception handlers\r\n       Running handlers complete\r\n       [2023-08-25T19:04:57-07:00] ERROR: Exception handlers complete\r\n       Infra Phase failed. 0 resources updated in 07 seconds\r\n       [2023-08-25T19:04:57-07:00] FATAL: Stacktrace dumped to \/Users\/vagrant\/kitchen\/cache\/chef-stacktrace.out\r\n```\r\n\r\n\r\n\r\n## Stacktrace\r\nchef-stacktrace.out:\r\n```\r\nGenerated at 2023-08-25 19:04:57 -0700\r\nArgumentError: chef_client_launchd[Setup the Chef Infra Client to run every 3 minutes] (redacted_name::chef_client line 9) had an error: ArgumentError: invalid argument - 0\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource\/chef_client_launchd.rb:173:in `rand'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource\/chef_client_launchd.rb:173:in `splay_sleep_time'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource\/chef_client_launchd.rb:183:in `client_command'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource.rb:1342:in `method_missing'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource\/chef_client_launchd.rb:116:in `block (2 levels) in <class:ChefClientLaunchd>'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_builder.rb:72:in `instance_exec'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_builder.rb:72:in `build'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/dsl\/declare_resource.rb:313:in `build_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/dsl\/declare_resource.rb:265:in `declare_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/dsl\/resources.rb:36:in `launchd'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource\/chef_client_launchd.rb:112:in `block in <class:ChefClientLaunchd>'\r\n(eval):2:in `block in action_enable'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/provider.rb:304:in `instance_eval'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/provider.rb:304:in `compile_and_converge_action'\r\n(eval):2:in `action_enable'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/provider.rb:245:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource.rb:601:in `block in run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource.rb:628:in `with_umask'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource.rb:600:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:74:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:108:in `block in run_all_actions'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:108:in `each'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:108:in `run_all_actions'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:132:in `block in converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/resource_list.rb:96:in `block in execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/stepable_iterator.rb:114:in `call_iterator_block'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/stepable_iterator.rb:85:in `step'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/stepable_iterator.rb:103:in `iterate'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/stepable_iterator.rb:54:in `each_with_index'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/resource_list.rb:94:in `execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.1.0\/forwardable.rb:238:in `execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:130:in `converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/client.rb:852:in `block in converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/client.rb:847:in `catch'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/client.rb:847:in `converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/client.rb:871:in `converge_and_save'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/client.rb:289:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application.rb:264:in `run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application\/base.rb:352:in `run_application'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application.rb:67:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-bin-18.1.0\/bin\/chef-client:25:in `<top (required)>'\r\n\/opt\/chef\/bin\/chef-client:184:in `load'\r\n\/opt\/chef\/bin\/chef-client:184:in `<main>'\r\n\r\n>>>> Caused by ArgumentError: invalid argument - 0\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource\/chef_client_launchd.rb:173:in `rand'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource\/chef_client_launchd.rb:173:in `splay_sleep_time'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource\/chef_client_launchd.rb:183:in `client_command'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource.rb:1342:in `method_missing'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource\/chef_client_launchd.rb:116:in `block (2 levels) in <class:ChefClientLaunchd>'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_builder.rb:72:in `instance_exec'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_builder.rb:72:in `build'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/dsl\/declare_resource.rb:313:in `build_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/dsl\/declare_resource.rb:265:in `declare_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/dsl\/resources.rb:36:in `launchd'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource\/chef_client_launchd.rb:112:in `block in <class:ChefClientLaunchd>'\r\n(eval):2:in `block in action_enable'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/provider.rb:304:in `instance_eval'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/provider.rb:304:in `compile_and_converge_action'\r\n(eval):2:in `action_enable'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/provider.rb:245:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource.rb:601:in `block in run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource.rb:628:in `with_umask'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource.rb:600:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:74:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:108:in `block in run_all_actions'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:108:in `each'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:108:in `run_all_actions'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:132:in `block in converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/resource_list.rb:96:in `block in execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/stepable_iterator.rb:114:in `call_iterator_block'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/stepable_iterator.rb:85:in `step'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/stepable_iterator.rb:103:in `iterate'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/stepable_iterator.rb:54:in `each_with_index'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/resource_collection\/resource_list.rb:94:in `execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.1.0\/forwardable.rb:238:in `execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/runner.rb:130:in `converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/client.rb:852:in `block in converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/client.rb:847:in `catch'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/client.rb:847:in `converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/client.rb:871:in `converge_and_save'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/client.rb:289:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application.rb:264:in `run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application\/base.rb:352:in `run_application'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application.rb:67:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-bin-18.1.0\/bin\/chef-client:25:in `<top (required)>'\r\n\/opt\/chef\/bin\/chef-client:184:in `load'\r\n\/opt\/chef\/bin\/chef-client:184:in `<main>'\r\n```","comments":["@aaronclarke do you have any capacity to propose better error handling and\/or documentation in a PR? Seems like a beneficial fix, but might also get lost in the priority shuffle otherwise."],"labels":["Status: Adopted"]},{"title":"'knife bootstrap --policy_name' doesn't play nicely with 'knife node policy set'","body":"## Description\r\nAfter bootstrapping a node, the policy_name\/group are set in two places (top-level and under `normal`), but when updating policies via knife, only the top-level is updated, leaving the `normal` value with the old policy name.\r\n\r\n## Chef Version\r\n```\r\n\u00bb knife --version\r\nChef Infra Client: 18.2.7\r\n```\r\n\r\n## Platform Version\r\nmacOS 13.5.1 (22G90)\r\n\r\n## Replication Case\r\n1. Bootstrap node, providing `--policy_name` and `--policy_group` args.\r\n2. Modify the node's policy via `knife node policy set ....`\r\n3. View output with both old and new policy names with `knife node show ...`\r\n\r\n## Client Output\r\n\r\n```bash\r\nknife bootstrap 10.10.10.10 -U ubuntu --sudo \\\r\n   -N my-new-hostname \\\r\n   --policy-name guest-pending-assignment --policy-group default\r\n\r\nknife node policy set my-new-hostname default my-policy-name\r\n\r\nknife node show my-new-hostname -F json\r\n{\r\n  \"name\": \"my-new-hostname\",\r\n  \"policy_name\": \"my-policy-name\",                  # \u2190 YAY\r\n  \"policy_group\": \"default\",\r\n  \"run_list\": [\r\n  \"recipe[my_cookbook::recipe_01]\"\r\n]\r\n,\r\n  \"normal\": {\r\n    \"policy_name\": \"guest-pending-assignment\",      # \u2190 WTH\r\n    \"policy_group\": \"default\",\r\n    \"tags\": [\r\n\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"reactivate libarchive tests","body":"<!--- Provide a short summary of your changes in the Title above -->\r\n\r\n## Description\r\n<!--- Describe your changes in detail, what problems does it solve? -->\r\n\r\n## Related Issue\r\n<!--- If you are suggesting a new feature or change, please create an issue first -->\r\n<!--- Please link to the issue, discourse, or stackoverflow here: -->\r\n\r\n## Types of changes\r\n<!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: -->\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [ ] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n<!--- If you're unsure about any of these, don't hesitate to ask. We're here to help! -->\r\n- [ ] I have read the **CONTRIBUTING** document.\r\n- [ ] I have run the pre-merge tests locally and they pass.\r\n- [ ] I have updated the documentation accordingly.\r\n- [ ] I have added tests to cover my changes.\r\n- [ ] All new and existing tests passed.\r\n- [ ] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=13886)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13886&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13886&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13886&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13886&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13886&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13886&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13886&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13886&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13886&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13886&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13886&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13886&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13886) No Coverage information  \n[![0.0%](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/3-16px.png '0.0%')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13886&metric=new_duplicated_lines_density&view=list) [0.0% Duplication](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13886&metric=new_duplicated_lines_density&view=list)\n\n"],"labels":["documentation"]},{"title":"De-dupe tests across actions+buildkite","body":"Currently unit tests, integration tests, and functional tests are all duped across *Actions* and *Buildkite*.\r\n\r\nThis is confusing for contributors and internal users alike. We should pick one and de-dupe these.\r\n\r\nFurther, it's really expensive for Progress.","comments":["following"],"labels":["Status: Untriaged","community-blockers"]},{"title":"Error on first run after installing chef infra client 18.2.7","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nI'm using chef-solo to provision AWS servers. I have a user data script for the instances that install chef using the omnitruck (`bash <(curl -SsL https:\/\/omnitruck.chef.io\/install.sh) -v 18.2.7`), pull the cookbooks from S3 and executes chef-solo afterwards.\r\n\r\nWith the latest chef infra client release (18.2.7) on the first run it can't get past the \"Installing cookbook gem dependencies\" stage. The error message is: `Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received ''`.\r\n\r\nAfterwards if I start chef-solo again, it runs without a problem. Probably because the gems are already installed. I've checked and the problem does not exist on version 18.1.0.\r\n\r\n## Chef Version\r\nChef infra client: 18.2.7\r\n\r\n## Platform Version\r\nDebian 11.7\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\nProbably any cookbook with a gem dependency will work. My metadata.rb and metadata.json look like this:\r\n\r\n```ruby\r\nname 'foo'\r\nmaintainer 'Bar LTD'\r\nmaintainer_email 'contact@example.com'\r\nlicense 'All Rights Reserved'\r\ndescription 'foo bar'\r\nversion '1.0.0'\r\nchef_version '>= 16.0'\r\n\r\ndepends 'aws', '~> 9.0.16'\r\ndepends 'filesystem', '~> 4.0.8'\r\ngem 'resolv'\r\n```\r\n\r\n```json\r\n{\r\n  \"name\": \"foo\",\r\n  \"description\": \"foo bar\",\r\n  \"long_description\": \"\",\r\n  \"maintainer\": \"Bar LTD\",\r\n  \"maintainer_email\": \"contact@example.com\",\r\n  \"license\": \"All Rights Reserved\",\r\n  \"platforms\": {\r\n\r\n  },\r\n  \"dependencies\": {\r\n    \"aws\": \"~> 9.0.16\",\r\n    \"filesystem\": \"~> 4.0.8\"\r\n  },\r\n  \"providing\": {\r\n\r\n  },\r\n  \"recipes\": {\r\n\r\n  },\r\n  \"version\": \"1.0.0\",\r\n  \"source_url\": \"\",\r\n  \"issues_url\": \"\",\r\n  \"privacy\": false,\r\n  \"chef_versions\": [\r\n    [\r\n      \">= 16.0\"\r\n    ]\r\n  ],\r\n  \"ohai_versions\": [\r\n\r\n  ],\r\n  \"gems\": [\r\n    [\r\n      \"resolv\"\r\n    ]\r\n  ],\r\n  \"eager_load_libraries\": true\r\n}\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\nInstalling chef\r\ndebian 11 x86_64\r\nGetting information for chef stable 18.2.7 for debian...\r\ndownloading https:\/\/omnitruck.chef.io\/stable\/chef\/metadata?v=18.2.7&p=debian&pv=11&m=x86_64\r\n  to file \/tmp\/install.sh.650\/metadata.txt\r\ntrying wget...\r\nsha1\t7462bffd901d85f4d9f6c54c15084a47732959d8\r\nsha256\ta4461840de71f08f11f3c65a6d2f40f41d394e98f84979f7a8388ed0b578c666\r\nurl\thttps:\/\/packages.chef.io\/files\/stable\/chef\/18.2.7\/debian\/11\/chef_18.2.7-1_amd64.deb\r\nversion\t18.2.7\r\ndownloaded metadata file looks valid...\r\ndownloading https:\/\/packages.chef.io\/files\/stable\/chef\/18.2.7\/debian\/11\/chef_18.2.7-1_amd64.deb\r\n  to file \/tmp\/install.sh.650\/chef_18.2.7-1_amd64.deb\r\ntrying wget...\r\nComparing checksum with sha256sum...\r\nInstalling chef 18.2.7\r\ninstalling with dpkg...\r\nSelecting previously unselected package chef.\r\n(Reading database ... 28325 files and directories currently installed.)\r\nPreparing to unpack ...\/chef_18.2.7-1_amd64.deb ...\r\nUnpacking chef (18.2.7-1) ...\r\nSetting up chef (18.2.7-1) ...\r\nThank you for installing Chef Infra Client! For help getting started visit https:\/\/learn.chef.io\r\n+---------------------------------------------+\r\n\u2714 2 product licenses accepted.\r\n+---------------------------------------------+\r\nChef Infra Client, version 18.2.7\r\nPatents: https:\/\/www.chef.io\/patents\r\nInfra Phase starting\r\n[2023-07-28T07:21:28+00:00] ERROR: shard_seed: Failed to get dmi property serial_number: is dmidecode installed?\r\n[2023-07-28T07:21:28+00:00] WARN: Run List override has been provided.\r\n[2023-07-28T07:21:28+00:00] WARN: Original Run List: []\r\n[2023-07-28T07:21:28+00:00] WARN: Overridden Run List: [role[zookeeper]]\r\nResolving cookbooks for run list: [\"foo::default\"]\r\nSynchronizing cookbooks:\r\n  - foo (1.0.0)\r\n  - aws (9.0.16)\r\n  - filesystem (4.0.8)\r\n  - lvm (6.1.14)\r\nInstalling cookbook gem dependencies:\r\n\r\nRunning handlers:\r\n[2023-07-28T07:22:26+00:00] ERROR: Running exception handlers\r\nRunning handlers complete\r\n[2023-07-28T07:22:26+00:00] ERROR: Exception handlers complete\r\nInfra Phase failed. 0 resources updated in 01 minutes 00 seconds\r\n[2023-07-28T07:22:27+00:00] FATAL: Stacktrace dumped to \/root\/chef\/local-mode-cache\/cache\/chef-stacktrace.out\r\n[2023-07-28T07:22:27+00:00] FATAL: ---------------------------------------------------------------------------------------\r\n[2023-07-28T07:22:27+00:00] FATAL: PLEASE PROVIDE THE CONTENTS OF THE stacktrace.out FILE (above) IF YOU FILE A BUG REPORT\r\n[2023-07-28T07:22:27+00:00] FATAL: ---------------------------------------------------------------------------------------\r\n[2023-07-28T07:22:27+00:00] FATAL: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received ''\r\n---- Begin output of [\"bundle\", \"install\"] ----\r\nSTDOUT: Fetching gem metadata from https:\/\/rubygems.org\/.............\r\nResolving dependencies...\r\nFetching aws-eventstream 1.0.3\r\nFetching aws-partitions 1.239.0\r\nInstalling aws-eventstream 1.0.3\r\nInstalling aws-partitions 1.239.0\r\nUsing jmespath 1.6.2\r\nUsing bundler 2.3.7\r\nFetching resolv 0.2.2\r\nFetching aws-sigv4 1.1.4\r\nInstalling aws-sigv4 1.1.4\r\nFetching aws-sdk-core 3.109.3\r\nInstalling resolv 0.2.2\r\nInstalling aws-sdk-core 3.109.3\r\nFetching aws-sdk-cloudformation 1.21.0\r\nFetching aws-sdk-cloudwatch 1.22.0\r\nInstalling aws-sdk-cloudwatch 1.22.0\r\nInstalling aws-sdk-cloudformation 1.21.0\r\nFetching aws-sdk-dynamodb 1.28.0\r\nFetching aws-sdk-ec2 1.214.0\r\nInstalling aws-sdk-dynamodb 1.28.0\r\nInstalling aws-sdk-ec2 1.214.0\r\nFetching aws-sdk-elasticloadbalancing 1.14.0\r\nInstalling aws-sdk-elasticloadbalancing 1.14.0\r\nFetching aws-sdk-iam 1.22.0\r\nInstalling aws-sdk-iam 1.22.0\r\nFetching aws-sdk-kinesis 1.15.0\r\nFetching aws-sdk-kms 1.39.0\r\nInstalling aws-sdk-kinesis 1.15.0\r\nInstalling aws-sdk-kms 1.39.0\r\nFetching aws-sdk-route53 1.24.0\r\nFetching aws-sdk-ssm 1.46.0\r\nInstalling aws-sdk-route53 1.24.0\r\nInstalling aws-sdk-ssm 1.46.0\r\nSTDERR: \r\n---- End output of [\"bundle\", \"install\"] ----\r\nRan [\"bundle\", \"install\"] returned\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n```\r\nGenerated at 2023-07-28 07:22:27 +0000\r\nMixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received ''\r\n---- Begin output of [\"bundle\", \"install\"] ----\r\nSTDOUT: Fetching gem metadata from https:\/\/rubygems.org\/.............\r\nResolving dependencies...\r\nFetching aws-eventstream 1.0.3\r\nFetching aws-partitions 1.239.0\r\nInstalling aws-eventstream 1.0.3\r\nInstalling aws-partitions 1.239.0\r\nUsing jmespath 1.6.2\r\nUsing bundler 2.3.7\r\nFetching resolv 0.2.2\r\nFetching aws-sigv4 1.1.4\r\nInstalling aws-sigv4 1.1.4\r\nFetching aws-sdk-core 3.109.3\r\nInstalling resolv 0.2.2\r\nInstalling aws-sdk-core 3.109.3\r\nFetching aws-sdk-cloudformation 1.21.0\r\nFetching aws-sdk-cloudwatch 1.22.0\r\nInstalling aws-sdk-cloudwatch 1.22.0\r\nInstalling aws-sdk-cloudformation 1.21.0\r\nFetching aws-sdk-dynamodb 1.28.0\r\nFetching aws-sdk-ec2 1.214.0\r\nInstalling aws-sdk-dynamodb 1.28.0\r\nInstalling aws-sdk-ec2 1.214.0\r\nFetching aws-sdk-elasticloadbalancing 1.14.0\r\nInstalling aws-sdk-elasticloadbalancing 1.14.0\r\nFetching aws-sdk-iam 1.22.0\r\nInstalling aws-sdk-iam 1.22.0\r\nFetching aws-sdk-kinesis 1.15.0\r\nFetching aws-sdk-kms 1.39.0\r\nInstalling aws-sdk-kinesis 1.15.0\r\nInstalling aws-sdk-kms 1.39.0\r\nFetching aws-sdk-route53 1.24.0\r\nFetching aws-sdk-ssm 1.46.0\r\nInstalling aws-sdk-route53 1.24.0\r\nInstalling aws-sdk-ssm 1.46.0\r\nSTDERR: \r\n---- End output of [\"bundle\", \"install\"] ----\r\nRan [\"bundle\", \"install\"] returned \r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/mixlib-shellout-3.2.7\/lib\/mixlib\/shellout.rb:300:in `invalid!'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/mixlib-shellout-3.2.7\/lib\/mixlib\/shellout.rb:287:in `error!'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/mixlib-shellout-3.2.7\/lib\/mixlib\/shellout\/helper.rb:130:in `shell_out_compacted!'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/mixlib-shellout-3.2.7\/lib\/mixlib\/shellout\/helper.rb:54:in `shell_out!'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/cookbook\/gem_installer.rb:77:in `block (2 levels) in install'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/cookbook\/gem_installer.rb:59:in `open'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/cookbook\/gem_installer.rb:59:in `block in install'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.1.0\/tmpdir.rb:96:in `mktmpdir'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/cookbook\/gem_installer.rb:58:in `install'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/cookbook\/cookbook_collection.rb:59:in `install_gems'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/policy_builder\/expand_node_object.rb:94:in `setup_run_context'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.1.0\/forwardable.rb:238:in `setup_run_context'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/client.rb:508:in `setup_run_context'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/client.rb:294:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/application.rb:264:in `run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/application\/base.rb:352:in `run_application'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/application.rb:67:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7\/lib\/chef\/application\/solo.rb:60:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-bin-18.2.7\/bin\/chef-solo:24:in `<top (required)>'\r\n\/usr\/bin\/chef-solo:180:in `load'\r\n\/usr\/bin\/chef-solo:180:in `<main>'\r\n```","comments":[],"labels":["Status: Untriaged"]},{"title":"chef-client can sometimes not be run as PID 1","body":"## Description\r\nWhen chef-client is run as PID 1, and when it's running a recipe that uses a `yum_package` resource, it delivers a cryptic `EOFError`. This happens when you run chef-client as a step in a Dockerfile.\r\n\r\nAfter a LOT of debugging, I've established that the cause is this line https:\/\/github.com\/chef\/chef\/blob\/b495c2d065ca9a9530c1e8dcf6d3004c7fdbaa79\/lib\/chef\/provider\/package\/yum\/yum_helper.py#L156-L159\r\n\r\nThe logic is basically the same way back in 14.15.6, and also seems to be repeated in some of the other package helpers.\r\n\r\nSo when you get to the step in the Dockerfile that runs chef-client, the helper is (intentionally) the child of PID 1, which it treats as a failure condition. It exits, and the calling ruby stuff rightfully detects that the pipe it spawned is now closed.\r\n\r\nIt's unclear to me why it's necessary to special case being orphaned like this. At the very least it's a pretty big foot gun. Luckily you can work around it by doing anything that causes something else to be the parent of chef-client for that step, e.g.\r\n\r\n```\r\nRUN chef-client --recipe \"recipe[install_git]\" && true\r\n```\r\n\r\n## Chef Version\r\n14.15.6, but I've confirmed that logic is still there on master.\r\n\r\n## Platform Version\r\ncentos:7 docker container\r\n\r\n## Replication Case\r\n```\r\nFROM centos:7\r\nRUN chef-client --recipe \"recipe[install_git]\"\r\n```\r\nWhere the default recipe contains\r\n```\r\npackage \"git\"\r\n```\r\n\r\n## Client Output\r\n```\r\nRecipe: install_git::default\r\n  * yum_package[git] action install\r\n\r\n    ================================================================================\r\n    Error executing action `install` on resource 'yum_package[git]'\r\n    ================================================================================\r\n\r\n    EOFError\r\n    --------\r\n    end of file reached\r\n\r\n    Resource Declaration:\r\n    ---------------------\r\n    # In \/var\/chef\/cache\/cookbooks\/scm_tools\/recipes\/default.rb\r\n\r\n      9: package 'git'\r\n```\r\n\r\n\r\n## Stacktrace\r\n```\r\nGenerated at 2023-07-21 17:07:21 +0000\r\nEOFError: yum_package[git] (install_git::default line 9) had an error: EOFError: end of file reached\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum\/python_helper.rb:155:in `sysread'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum\/python_helper.rb:155:in `block in query'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum\/python_helper.rb:198:in `block in with_helper'\r\n\/opt\/chef\/embedded\/lib\/ruby\/2.5.0\/timeout.rb:93:in `block in timeout'\r\n\/opt\/chef\/embedded\/lib\/ruby\/2.5.0\/timeout.rb:33:in `block in catch'\r\n\/opt\/chef\/embedded\/lib\/ruby\/2.5.0\/timeout.rb:33:in `catch'\r\n\/opt\/chef\/embedded\/lib\/ruby\/2.5.0\/timeout.rb:33:in `catch'\r\n\/opt\/chef\/embedded\/lib\/ruby\/2.5.0\/timeout.rb:108:in `timeout'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum\/python_helper.rb:196:in `with_helper'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum\/python_helper.rb:151:in `query'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum\/python_helper.rb:117:in `package_query'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum.rb:242:in `installed_version'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum.rb:85:in `block in get_current_versions'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum.rb:84:in `each'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum.rb:84:in `each_with_index'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum.rb:84:in `each'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum.rb:84:in `map'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum.rb:84:in `get_current_versions'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider\/package\/yum.rb:62:in `load_current_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/provider.rb:165:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/resource.rb:578:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/runner.rb:74:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/runner.rb:108:in `block in run_all_actions'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/runner.rb:108:in `each'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/runner.rb:108:in `run_all_actions'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/runner.rb:132:in `block in converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/resource_collection\/resource_list.rb:94:in `block in execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/resource_collection\/stepable_iterator.rb:114:in `call_iterator_block'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/resource_collection\/stepable_iterator.rb:85:in `step'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/resource_collection\/stepable_iterator.rb:103:in `iterate'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/resource_collection\/stepable_iterator.rb:55:in `each_with_index'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/resource_collection\/resource_list.rb:92:in `execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/runner.rb:130:in `converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/client.rb:720:in `block in converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/client.rb:715:in `catch'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/client.rb:715:in `converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/client.rb:754:in `converge_and_save'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/client.rb:286:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/application.rb:303:in `run_with_graceful_exit_option'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/application.rb:279:in `block in run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/local_mode.rb:44:in `with_server_connectivity'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/application.rb:261:in `run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/application\/client.rb:449:in `run_application'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/lib\/chef\/application.rb:66:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.15.6\/bin\/chef-client:25:in `<top (required)>'\r\n\/usr\/bin\/chef-client:81:in `load'\r\n\/usr\/bin\/chef-client:81:in `<main>'\r\n```","comments":[],"labels":["Status: Untriaged"]},{"title":"Allow global configuration for `backup` option for file and remote_file","body":"### Describe the Enhancement:\r\nAdd a way to configure the default for the `backup` option globally instead of having to specify it in every occurance.\r\n\r\n### Describe the Need:\r\n\r\nBy default the `file` and `remote_file` resources keep 5 backups of previous versions of the file. I don't really have need for these backups anywhere, and would like to be able to disable it altogether, or at least reduce how many backups are kept. It would be really nice if I could reduce disk usage by disabling this in a single place instead of having to add `backup false` to every occurrence of these resource types.\r\n\r\n### Current Alternative\r\nManually specify an override for the `backup` option for every occurrence of `file` or `remote_file`. \r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\n\r\nI could help implement this. I'm just not sure how to use a global configuration for a default of a property in the resource definitions\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Debian 12 \"Bookworm\" Support","body":"### Describe the Enhancement:\r\nDebian 12 \"Bookworm\" was released on June 10, 2023 and ideally should have a targeted build for it.\r\n\r\nhttps:\/\/www.debian.org\/News\/2023\/20230610\r\n\r\n### Describe the Need:\r\nWe were looking to POC our Chef utilization against our potentially next OS flavor and noticed a build was not available for Debian 12.\r\n\r\n### Current Alternative\r\nN\/A\r\n\r\n### Can We Help You Implement This?:\r\n","comments":["Up!","For what it's worth, I pointed my apt sources to the bullseye repository on a fresh bookworm install and it worked fine. This should mean that oldstable will work just as well","It would awesome to also get ARM64 support for Debian."],"labels":["Status: Untriaged"]},{"title":"chef-client hardcoded aws-sdk-core causing gem activation conflict","body":"Internal issue link [CHEF-5464](https:\/\/chefio.atlassian.net\/browse\/CHEF-5464)\r\n\r\n<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\n\r\nOn May-31 there was change introduced in aws-sdk-cloudformation and other packages\r\nhttps:\/\/github.com\/aws\/aws-sdk-ruby\/blob\/version-3\/gems\/aws-sdk-cloudformation\/aws-sdk-cloudformation.gemspec#L28\r\n\r\n$ md5sum chef_18.2.7-1_amd64.deb \r\n5915e85e520fbe35b4d38f04e91bbc79  chef_18.2.7-1_amd64.deb\r\n\r\nthere **opt\/chef\/bin\/chef-client** file contains line\r\n`gem \"aws-sdk-core\", \"= 3.171.0\"`\r\n\r\nIf we tried in our system to use aws-sdk-core 3.174.0 then we got message mentioned in Output section\r\n\r\nIf we tried to fix on 3.171.0, then also packages like aws-sdk-lambda, aws-sdk-ec2, aws-sdk-autoscaling and aws-sdk-cloudformation needed downgraded fixed versions.\r\n\r\n## Current workaround\r\nAfter installing chef and aws-sdk-core and before chef executions we changed hardcoded version in bin\/chef-client:\r\n`sudo sed -i \"s\/3.171.0\/3.174.0\/g\" \/opt\/chef\/bin\/chef-client`\r\nafter that we were able to execute cloudformation ami build.\r\n\r\n## Suggestion\r\nUpdate chef-client to use aws-sdk-core version 3.174.0 (or maybe even better if it would not have hardcoded version at all)\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nInitially 18.1.0 but repeatable also with 18.2.7\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nUbuntu 20.04.6 LTS\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n[   65.255520] cloud-init[1224]: [2023-06-14T12:02:57+00:00] FATAL: Gem::ConflictError: Unable to activate aws-sdk-cloudformation-1.80.0, because aws-sdk-core-3.171.0 conflicts with aws-sdk-core (~> 3, >= 3.174.0)\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n```\r\n: Installing cookbook gem dependencies:\r\n: Compiling cookbooks...\r\n: Loading Chef InSpec profile files:\r\n: Loading Chef InSpec input files:\r\n: Loading Chef InSpec waiver files:\r\n: --- ERROR[#get_meta_data]: Request to metadata endpoint public-ipv4 failed. The function will return empty string.\r\n: [2023-06-14T12:02:56+00:00] WARN: Resource apt_preference built into Chef Infra Client is being overridden by the resource from a cookbook. Please upgrade your cookbook or remove the cookbook from your run_list.\r\n: Recipe: provision::monitoring-worker\r\n:   * chef_gem[aws-sdk-cloudformation] action install (up to date)\r\n:   * chef_gem[aws-sdk-kms] action install (up to date)\r\n:\r\n:   ================================================================================\r\n:   Recipe Compile Error in \/etc\/chef\/local-mode-cache\/cache\/cookbooks\/provision\/recipes\/monitoring-worker.rb\r\n:   ================================================================================\r\n:\r\n:   Gem::ConflictError\r\n:   ------------------\r\n:   Unable to activate aws-sdk-cloudformation-1.80.0, because aws-sdk-core-3.171.0 conflicts with aws-sdk-core (~> 3, >= 3.174.0)\r\n:\r\n:   Cookbook Trace: (most recent call first)\r\n:   ----------------------------------------\r\n:     \/etc\/chef\/local-mode-cache\/cache\/cookbooks\/provision\/recipes\/monitoring-worker.rb:11:in `from_file'\r\n:\r\n:   Relevant File Content:\r\n:   ----------------------\r\n:   \/etc\/chef\/local-mode-cache\/cache\/cookbooks\/provision\/recipes\/monitoring-worker.rb:\r\n:\r\n:     4:  chef_gem \"aws-sdk-cloudformation\" do\r\n:     5:    compile_time true\r\n:     6:  end\r\n:     7:  chef_gem \"aws-sdk-kms\" do\r\n:     8:    compile_time true\r\n:     9:  end\r\n:    10:  require \"aws-sdk-kms\"\r\n:    11>> require \"aws-sdk-cloudformation\"\r\n:    12:\r\n:    13:  #======= SET CONSTANTS ====================================\r\n:    14:  REGION = EC2MetaData.get(\"placement\/region\")\r\n:    15:  LOGICAL_RECOURCE_ID = \"EC2Instance\".freeze\r\n:    16:  STACK_NAME = ENV[\"STACK_NAME\"]\r\n:    17:  UNIQUE_ID = EC2MetaData.get(\"instance-id\")\r\n:    18:  PARAMETER_PREFIX = ENV[\"PARAMETER_PREFIX\"]\r\n:    19:\r\n:    20:  cfn_message = {\r\n:\r\n:   System Info:\r\n:   ------------\r\n:   chef_version=18.2.7\r\n:   platform=ubuntu\r\n:   platform_version=20.04\r\n:   ruby=ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n:   program_name=\/usr\/bin\/chef-client\r\n:   executable=\/opt\/chef\/bin\/chef-client\r\n:\r\n:\r\n:   Running handlers:\r\n: [2023-06-14T12:02:57+00:00] ERROR: Running exception handlers\r\n:   Running handlers complete\r\n: [2023-06-14T12:02:57+00:00] ERROR: Exception handlers complete\r\n:   Infra Phase failed. 0 resources updated in 08 seconds\r\n: [2023-06-14T12:02:57+00:00] FATAL: Stacktrace dumped to \/etc\/chef\/local-mode-cache\/cache\/chef-stacktrace.out\r\n: [2023-06-14T12:02:57+00:00] FATAL: ---------------------------------------------------------------------------------------\r\n: [2023-06-14T12:02:57+00:00] FATAL: PLEASE PROVIDE THE CONTENTS OF THE stacktrace.out FILE (above) IF YOU FILE A BUG REPORT\r\n: [2023-06-14T12:02:57+00:00] FATAL: ---------------------------------------------------------------------------------------\r\n: [2023-06-14T12:02:57+00:00] FATAL: Gem::ConflictError: Unable to activate aws-sdk-cloudformation-1.80.0, because aws-sdk-core-3.171.0 conflicts with aws-sdk-core (~> 3, >= 3.174.0)\r\n```\r\n\n\n[CHEF-5464]: https:\/\/chefio.atlassian.net\/browse\/CHEF-5464?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","comments":["I'm also impacted by this. The aws gemfiles specifying a version conflicts with the chef gem version making it a bit of a hassle to track down the correct version of each aws sdk gem so it doesn't cause a conflict with chef's aws-sdk-core bundled version.","[#13925](https:\/\/github.com\/chef\/chef\/pull\/13925) will resolve this.","The next stable release of Chef (>18.3.x) will fix."],"labels":["Status: Adopted","Status: Waiting on Release"]},{"title":"Support setting apt allow_downgrade: false","body":"## Description\r\nSupport setting allow_downgrade: false in apt to disable passing --allow-downgrades.\r\n\r\nThis could be used to prevent Chef from inadvertently downgrading a manually upgrade package.\r\n\r\n## Related Issue\r\nhttps:\/\/github.com\/chef\/chef\/issues\/13788\r\n\r\n## Types of changes\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [x] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n- [x] I have read the **CONTRIBUTING** document.\r\n- [ ] I have run the pre-merge tests locally and they pass.\r\n- [ ] I have updated the documentation accordingly.\r\n- [x] I have added tests to cover my changes.\r\n- [ ] All new and existing tests passed.\r\n- [x] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).","comments":["Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=13789)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13789&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13789&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13789&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13789&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13789&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13789&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13789&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13789&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13789&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13789&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13789&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13789&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13789) No Coverage information  \n[![No Duplication information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/NoDuplicationInfo-16px.png 'No Duplication information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13789&metric=duplicated_lines_density&view=list) No Duplication information\n\n","Hey - are you looking for a review @mdkent ? If so, remove this from draft and we'll review it. Otherwise, next week we'll close it."],"labels":["documentation"]},{"title":"Support setting allow_downgrade: false in apt","body":"### Describe the Enhancement:\r\nI ran a manual package upgrade of a database, then ran Chef before updating it to the same version. This triggered a downgrade of the database package:\r\n```\r\nCommandline: apt-get -q -y --allow-downgrades -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold install percona-server-server=8.0.30-22-1.bionic\r\n```\r\nTotally my fault, but I'd like the option to set `allow_downgrade:` false to prevent this possibility, like:\r\n```\r\n package \"percona-server-server\" do\r\n   version \"8.0.30-22-1.bionic\"\r\n   allow_downgrade false # Make sure we don't pass --allow-downgrades during a manual version upgrade\r\n   action [ :install, :lock ] # Keep from any inadvertent upgrades\r\n end\r\n```\r\n\r\n### Describe the Need:\r\nThis is additional flexibility for those of us that don't want Chef to be able to downgrade key packages. I'd rather the Chef run just fail.\r\n\r\n### Current Alternative\r\nNo workarounds. `allow_downgrade` isn't available in the apt provider.\r\n\r\n### Can We Help You Implement This?:\r\nPR incoming!","comments":[],"labels":["Status: Untriaged"]},{"title":"Knife fails when running as non-administrative user on Windows","body":"## Description\r\nWhen running `knife` from the latest Chef Workstation (23.5.1040) as a non-administrative user on Windows, the `knife` command fails with the following error:\r\n\r\n```console\r\n> knife status\r\nERROR: Win32::Registry::Error: Access is denied.\r\n```\r\n\r\nIt looks like it's trying to create a registry key at `HKEY_LOCAL_MACHINE\\Software\\Progress\\Authentication`, which will not work for a non-admin user.\r\n\r\n## Chef Version\r\n\r\n```console\r\n> chef -v\r\nChef Workstation version: 23.5.1040\r\nChef InSpec version: 5.21.29\r\nChef CLI version: 5.6.11\r\nChef Habitat version: 1.6.652\r\nTest Kitchen version: 3.5.0\r\nCookstyle version: 7.32.2\r\nChef Infra Client version: 18.2.7\r\n```\r\n\r\n## Platform Version\r\n\r\n`Windows Server 2022`\r\n\r\n## Stacktrace\r\n\r\n```console\r\n> knife status -VV\r\nINFO: Sending query: *:*\r\nC:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/3.1.0\/win32\/registry.rb:296:in `CreateKey': Access is denied. (Win32::Registry::Error)\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/3.1.0\/win32\/registry.rb:458:in `create'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/3.1.0\/win32\/registry.rb:549:in `create'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/win32\/registry.rb:370:in `block in create_missing'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/win32\/registry.rb:366:in `each'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/win32\/registry.rb:366:in `create_missing'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/win32\/registry.rb:112:in `create_key'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:205:in `rescue in get_cert_password'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:175:in `get_cert_password'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:303:in `retrieve_certificate_key'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:98:in `retrieve_certificate_key'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:149:in `load_signing_key'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:45:in `initialize'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:104:in `new'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:104:in `block in initialize'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:103:in `each'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:103:in `initialize'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/server_api.rb:40:in `initialize'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/search\/query.rb:40:in `new'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/search\/query.rb:40:in `rest'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/search\/query.rb:153:in `call_rest_service'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/search\/query.rb:80:in `search'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/lib\/chef\/knife\/status.rb:83:in `run'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/lib\/chef\/knife.rb:494:in `block in run_with_pretty_exceptions'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/lib\/chef\/knife.rb:493:in `run_with_pretty_exceptions'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/lib\/chef\/knife.rb:233:in `run'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/lib\/chef\/application\/knife.rb:165:in `run'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/bin\/knife:24:in `<top (required)>'\r\n        from C:\/opscode\/chef-workstation\/bin\/knife:423:in `load'\r\n        from C:\/opscode\/chef-workstation\/bin\/knife:423:in `<main>'\r\nC:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/win32\/registry.rb:164:in `key_exists!': Registry key HKEY_LOCAL_MACHINE\\\\Software\\\\Progress\\\\Authentication does not exist (Chef::Exceptions::Win32RegKeyMissing)\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/win32\/registry.rb:58:in `get_values'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:181:in `get_cert_password'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:303:in `retrieve_certificate_key'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:98:in `retrieve_certificate_key'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:149:in `load_signing_key'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:45:in `initialize'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:104:in `new'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:104:in `block in initialize'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:103:in `each'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:103:in `initialize'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/server_api.rb:40:in `initialize'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/search\/query.rb:40:in `new'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/search\/query.rb:40:in `rest'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/search\/query.rb:153:in `call_rest_service'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/search\/query.rb:80:in `search'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/lib\/chef\/knife\/status.rb:83:in `run'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/lib\/chef\/knife.rb:494:in `block in run_with_pretty_exceptions'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/lib\/chef\/knife.rb:493:in `run_with_pretty_exceptions'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/lib\/chef\/knife.rb:233:in `run'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/lib\/chef\/application\/knife.rb:165:in `run'\r\n        from C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/knife-18.2.7\/bin\/knife:24:in `<top (required)>'\r\n        from C:\/opscode\/chef-workstation\/bin\/knife:423:in `load'\r\n        from C:\/opscode\/chef-workstation\/bin\/knife:423:in `<main>'\r\n```\r\n","comments":["This is confirmed and the chef-workstation team is looking into it.","Still an issue as of Chef Workstation `23.12.105`, can be worked around by running `knife` in Administrator shell a single time."],"labels":["Triage: Confirmed"]},{"title":"delayed_action is not documented","body":"This functionality is extremely useful for guaranteeing execution at the very end of the Chef client run when there's nothing that should trigger this with a :notifies, but it's absent from all documentation.\r\n\r\nhttps:\/\/www.rubydoc.info\/gems\/chef\/Chef\/Resource:delayed_action\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Buildkite migration is not accessible to external contributors","body":"@PrajaktaPurohit and I spoke about this in meetings in February, but I think it fell off the radar, so I'm putting it in an Issue.\r\n\r\nThe old `chef-chef-main-verify` is still visible by everyone, but `chef-chef-main-verify-release`, `chef-chef-main-verify-adhoc`, and `chef-chef-main-verify-adhoc-canary` are all NOT visible.\r\n\r\nThis means we cannot debug issues on PRs we or other contribute. Here's specific link examples:\r\n\r\nCAN see: https:\/\/buildkite.com\/chef-oss\/chef-chef-main-verify\/builds\/14190\r\n\r\nCANNOT see:\r\nhttps:\/\/buildkite.com\/chef-canary\/chef-chef-main-verify-adhoc-canary\/builds\/5\r\nhttps:\/\/buildkite.com\/chef\/chef-chef-main-verify-adhoc\/builds\/5\r\nhttps:\/\/buildkite.com\/chef\/chef-chef-main-verify-release\/builds\/7\r\n\r\n![image](https:\/\/github.com\/chef\/chef\/assets\/938467\/97dcc2f0-a725-4e4d-bf7e-1556d20daad3)\r\n","comments":["@jaymzh @dafyddcrosby Are you able to see the pipelines mentioned in the description now?","I'm still not able to yet, same SSO sign-in pages"],"labels":["Status: Untriaged","community-blockers"]},{"title":"gem_package resource broken and behaves like chef_gem in Ubuntu 22","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n\r\nIn the latest version of Chef Infra Client on Ubuntu 22, the `gem_package` resource is broken. It behaves the same as `chef_gem`, i.e., it installs gems into Chef's embedded ruby environment and not the system environment.\r\n\r\n## Chef Version\r\nChef Infra Client 18.2.7\r\n\r\n## Platform Version\r\nUbuntu 22.04\r\n\r\n## Replication Case\r\n\r\n```\r\ngem_package 'example' do\r\n  version '1.0.0'\r\nend\r\n```\r\n\r\nAfter chef converges, verify gem has not been installed in the system ruby environment:\r\n\r\n```\r\ngem list | grep example\r\n```\r\n\r\nInstead, gem is installed in chef's embedded ruby:\r\n\r\n```\r\n# \/opt\/chef\/embedded\/bin\/gem list | grep example\r\nexample (1.0.0)\r\n```\r\n\r\n## Client Output\r\n\r\n```\r\nRecipe: example::default\r\n  * gem_package[example] action install\r\n    - install version 1.0.0 of package example\r\n...\r\nInfra Phase complete, 1\/5 resources updated in 10 seconds\r\n```\r\n\r\n## Additional details\r\n\r\nUsing `execsnoop` we can see that under the hood chef is running the following:\r\n\r\n```\r\n# execsnoop | grep example\r\nsh               255198 254898   0 \/bin\/sh -c \/usr\/bin\/gem install example -q --no-document -v \"1.0.0\"\r\ngem              255199 255198   0 \/usr\/bin\/gem install example -q --no-document -v 1.0.0\r\nruby             255199 255198   0 \/opt\/chef\/embedded\/bin\/ruby \/usr\/bin\/gem install example -q --no-document -v 1.0.0\r\n```\r\n\r\nIn the `ruby` apt package for ubuntu 22, it creates `\/usr\/bin\/gem` with an env shebang `#!\/usr\/bin\/env ruby`. In Ubuntu 20, it used a hardcoded shebang `#!\/usr\/bin\/ruby2.7`.\r\n\r\nThis new shebang means the returned value of `gem env gempath` will be different, depending on whether or not it is run from chef:\r\n\r\n**Chef:**\r\n```\r\n# \/opt\/chef\/embedded\/bin\/ruby \/usr\/bin\/gem env gempath\r\n\/root\/.local\/share\/gem\/ruby\/3.1.0:\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\r\n```\r\n\r\n**System:**\r\n```\r\n# \/usr\/bin\/ruby \/opt\/chef\/embedded\/bin\/gem env gempath\r\n\/root\/.local\/share\/gem\/ruby\/3.0.0:\/var\/lib\/gems\/3.0.0:\/usr\/local\/lib\/ruby\/gems\/3.0.0:\/usr\/lib\/ruby\/gems\/3.0.0:\/usr\/lib\/x86_64-linux-gnu\/ruby\/gems\/3.0.0:\/usr\/share\/rubygems-integration\/3.0.0:\/usr\/share\/rubygems-integration\/all:\/usr\/lib\/x86_64-linux-gnu\/rubygems-integration\/3.0.0\r\n```\r\n\r\nThis is likely the root cause of https:\/\/github.com\/chef\/chef\/issues\/12879\r\n\r\n## Stacktrace\r\n\r\nNo stacktrace; chef believes it installed the gem successfully.","comments":["Same behavior on Debian 11 and up.\r\n\r\nHere's the [minimal cookbook](https:\/\/github.com\/drdev\/gem-package-cookbook-test) with inspec test to check behaviour.","Specifying versioned `gem_binary` (e.g. `\/usr\/bin\/gem2.7`) solves the issue (see [PR](https:\/\/github.com\/drdev\/gem-package-cookbook-test\/pull\/1)). But this looks weird.\r\n\r\nAny suggestions?","@drdev and others facing this problem... here's another workaround (just modify for Debian accordingly).\r\n\r\nYou can monkey patch the `gem_package` resource by throwing this in `<cookbook>\/libraries\/gem_package_patch.rb`\r\n\r\nI've only tested on Chef Client 14 and Cinc Infra Client 18, but everything seems to work as expected now.\r\n\r\n```ruby\r\n# Author:: Adam Jacob (<adam@chef.io>)\r\n# Copyright:: Copyright (c) Chef Software Inc.\r\n# License:: Apache License, Version 2.0\r\n#\r\n# Licensed under the Apache License, Version 2.0 (the \"License\");\r\n# you may not use this file except in compliance with the License.\r\n# You may obtain a copy of the License at\r\n#\r\n#     http:\/\/www.apache.org\/licenses\/LICENSE-2.0\r\n#\r\n# Unless required by applicable law or agreed to in writing, software\r\n# distributed under the License is distributed on an \"AS IS\" BASIS,\r\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n# See the License for the specific language governing permissions and\r\n# limitations under the License.\r\n\r\nclass Chef\r\n  class Resource\r\n    class GemPackage < Chef::Resource::Package\r\n      property :gem_binary, String, desired_state: false, default: lazy { default_gem_binary }\r\n\r\n      def default_gem_binary\r\n        if node['platform'] == 'ubuntu' && node['platform_version'].to_f >= 22.04 && ::File.exist?('\/usr\/bin\/ruby')\r\n          '\/usr\/bin\/ruby \/usr\/bin\/gem'\r\n        else\r\n          'gem'\r\n        end\r\n      end\r\n    end\r\n  end\r\nend\r\n```","Hey all,\r\n\r\nWe chatted about this in the PR Review meeting this week. There's two possible solutions:\r\n\r\n1. We can add code similar to the above to set a default `gem_binary` in the GemPackage resource (but we'd need to do it differently, more on that below). If we do that then **both** `gem_package` and `chef_gem` will both provide defaults which will render most of the code in [rubygems.rb#initialize](https:\/\/github.com\/chef\/chef\/blob\/chef-14\/lib\/chef\/provider\/package\/rubygems.rb#L386) dead and we should clean it up - it'll be about 3 lines when we're done (the first `if`). If we do this we should add copious comments to rubygems.rb since it'll be very unclear why it all works when viewing the provider.\r\n2. We can drop the defaults from both `GemPackage` and `ChefGem` resources, and then update `rubygems.rb#initialize` to do all the logic there. If we go this route, I'd change the flow to be `if ChefGem ...  elsif GemPackage ... else raise end` to make this all MUCH clearer.\r\n\r\nRegardless of which way we go, the way we determine if we can trust `\/usr\/bin\/gem` needs to be more resilient and future proof. For example, my Debian machine's `\/usr\/bin\/gem` is an `env` version. So something along the lines of:\r\n\r\n```ruby\r\nif File.exist?('\/usr\/bin\/gem') && File.open('\/usr\/bin\/gem', &:gets).include?('bin\/env')\r\n  '\/usr\/bin\/ruby \/usr\/bin\/gem'\r\nelse\r\n  'gem'\r\nend\r\n```\r\n\r\nFinally, we'll want to massively update the tests. We'll want one set of tests with a `context` of `omnibus`  one of `not omnibus`, in each of which we test both `chef_gem` and `gem_package` where `\/usr\/bin\/gem` is and is not the `env` variety.\r\n\r\nGetting back to solution # 1 vs # 2... arguably `chef_gem` shouldn't HAVE a `gem_binary` option to it, that defeats the whole purpose. We're currently _implicitly_ making chef_gem chef_gem with a path which seems odd to me. So I'd rather we nuke all the default-calculations from the resources, and make the provider very clear. But it's a mild preference, I'm OK with either.","Drew's code above (https:\/\/github.com\/chef\/chef\/issues\/13754#issuecomment-1688757588)  is a workaround.\r\nLoading it as usual library in custom client cookbook, it makes it possible to override original GemPackage resource defaults on-the-fly, _without changing original chef-client files_.\r\n\r\nPoint # 2 is definitely more preferable, because normally you expect all the logic in provider code, like for all other resources.\r\n"],"labels":["Status: Untriaged"]},{"title":"client install.ps1 ignores proxy credentials","body":"## Description\r\nThe chef client [`install.ps1`](https:\/\/omnitruck.chef.io\/install.ps1) script ignores proxy authentication parameters, whether embedded in the proxy URL or set as env vars.\r\n\r\n## Chef Version\r\nn\/a\r\n\r\n## Platform Version\r\nWindows\r\n\r\n## Replication Case\r\nTry using the `install.ps1` script behind a forward proxy that requires authentication, and it will fail HTTP\/407.\r\n\r\n## Proposed Solution\r\n\r\nThe fix is fairly straight-forward. The script needs an additional function to pick up the credentials from either the URL - `http:\/\/<user>@<pass>:proxyserver:3128` or environment variables `http_proxy_user`\/`http_proxy_pass`:\r\n\r\n```ps1\r\nfunction Get-ProxyCredential\r\n{\r\n    if ($Env:http_proxy -eq $null)\r\n    {\r\n        return $null\r\n    }\r\n\r\n    # credentials in the URL take precedence over user\/pass env vars\r\n    $proxy_credentials = Select-String \"^http[s]*:\/\/(\\w.*):(\\w.*)@\" -InputObject $Env:http_proxy\r\n    $proxy_user = $proxy_credentials.Matches.Groups[1]\r\n    $proxy_pass = $proxy_credentials.Matches.Groups[2]\r\n\r\n    # if we have no credential, try some env vars\r\n    if ($proxy_user -eq $null)\r\n    {\r\n        $proxy_user = $Env:http_proxy_user\r\n    }\r\n    if ($proxy_pass -eq $null)\r\n    {\r\n        $proxy_pass = $Env:http_proxy_pass\r\n    }\r\n\r\n    # if we still have no credential we have nothing to return\r\n    if ($proxy_user -eq $null -Or $proxy_pass -eq $null)\r\n    {\r\n        return $null\r\n    }\r\n\r\n    $ps_password = ConvertTo-SecureString $proxy_pass -AsPlainText -Force\r\n    $ps_credential = New-Object System.Management.Automation.PSCredential($proxy_user, $ps_password)\r\n\r\n    return $ps_credential\r\n}\r\n```\r\n\r\nThis function should be called from within `Get-WebContentOnFullNet`:\r\n\r\n```\r\n         $proxy.Address = $env:http_proxy\r\n+        $proxy.Credentials = Get-ProxyCredential\r\n         $bypassList = $env:no_proxy\r\n```","comments":[],"labels":["Status: Untriaged"]},{"title":"[apt_repository] install_key_from_uri throws errors on cleanup when keys are re-used","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nWhen having more than one `apt_repository` block in a chef-client run, that use the same GPG-Key, then at the end of the chef-run the cleanup fails, as it tries to delete the same file twice\r\n\r\n## Chef Version\r\n17.10.0\r\n\r\n## Platform Version\r\nUbuntu 22.04\r\n\r\n## Replication Case\r\nHave more than once `apt_repository`resource usage, that use the same key, like:\r\n\r\n```\r\n  apt_repository 'MyRepoForToolA' do\r\n    uri 'http:\/\/mirror.example.com\/aptly\/toola\/' + node['lsb']['codename']\r\n    distribution node['lsb']['codename']\r\n    components ['main']\r\n    action :add\r\n    cache_rebuild true\r\n    key 'http:\/\/mirror.example.com\/aptly\/aptly.gpg'\r\n  end\r\n\r\n  apt_repository 'MyRepoForToolB' do\r\n    uri 'http:\/\/mirror.example.com\/aptly\/toolb\/' + node['lsb']['codename']\r\n    distribution node['lsb']['codename']\r\n    components ['main']\r\n    action :add\r\n    cache_rebuild true\r\n    key 'http:\/\/mirror.example.com\/aptly\/aptly.gpg'\r\n  end\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n - As the chef-client run succeeds and creates the apt repository successfully, there is no interesting output here.\r\n```\r\n\r\n## Stacktrace\r\n```\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `unlink': No such file or directory @ apply2files - \/tmp\/.gpg20230317-23320-7qzs7t (Errno::ENOENT)\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `block in remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1471:in `platform_support'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1465:in `remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1454:in `remove'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:783:in `block in remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1509:in `postorder_traverse'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:781:in `remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.0\/lib\/chef\/resource\/apt_repository.rb:259:in `block in install_key_from_uri'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `unlink': No such file or directory @ apply2files - \/tmp\/.gpg20230317-23320-2ldde3 (Errno::ENOENT)\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `block in remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1471:in `platform_support'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1465:in `remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1454:in `remove'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:783:in `block in remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1509:in `postorder_traverse'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:781:in `remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.0\/lib\/chef\/resource\/apt_repository.rb:259:in `block in install_key_from_uri'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `unlink': No such file or directory @ apply2files - \/tmp\/.gpg20230317-23320-mna9d1 (Errno::ENOENT)\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `block in remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1471:in `platform_support'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1465:in `remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1454:in `remove'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:783:in `block in remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1509:in `postorder_traverse'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:781:in `remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.0\/lib\/chef\/resource\/apt_repository.rb:259:in `block in install_key_from_uri'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `unlink': No such file or directory @ apply2files - \/tmp\/.gpg20230317-23320-g2v0f7 (Errno::ENOENT)\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `block in remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1471:in `platform_support'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1465:in `remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1454:in `remove'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:783:in `block in remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1509:in `postorder_traverse'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:781:in `remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.0\/lib\/chef\/resource\/apt_repository.rb:259:in `block in install_key_from_uri'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `unlink': No such file or directory @ apply2files - \/tmp\/.gpg20230317-23320-dr8aqv (Errno::ENOENT)\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `block in remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1471:in `platform_support'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1465:in `remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1454:in `remove'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:783:in `block in remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1509:in `postorder_traverse'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:781:in `remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.0\/lib\/chef\/resource\/apt_repository.rb:259:in `block in install_key_from_uri'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `unlink': No such file or directory @ apply2files - \/tmp\/.gpg20230317-23320-rv9pih (Errno::ENOENT)\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `block in remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1471:in `platform_support'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1465:in `remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1454:in `remove'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:783:in `block in remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1509:in `postorder_traverse'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:781:in `remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.0\/lib\/chef\/resource\/apt_repository.rb:259:in `block in install_key_from_uri'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `unlink': No such file or directory @ apply2files - \/tmp\/.gpg20230317-23320-o1n07d (Errno::ENOENT)\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1466:in `block in remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1471:in `platform_support'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1465:in `remove_file'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1454:in `remove'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:783:in `block in remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:1509:in `postorder_traverse'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/fileutils.rb:781:in `remove_entry'\r\n  from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.0\/lib\/chef\/resource\/apt_repository.rb:259:in `block in install_key_from_uri'\r\n```\r\n","comments":[],"labels":["Status: Needs Replication"]},{"title":"Multiple supports in metadata.rb","body":"Related:\r\n\r\n- 2015-2020 https:\/\/github.com\/chef\/chef\/issues\/3924 (closed but unfinished)\r\n- 2015-2020 https:\/\/github.com\/chef\/chef\/issues\/3124 (closed as \"dup\" of 2457 and 3924)\r\n- 2014-2020 https:\/\/github.com\/chef\/chef\/issues\/2457 (closed as \"dup\" of 3924)\r\n- 2014-2020 https:\/\/github.com\/chef\/chef-server\/issues\/31 (It's not completed but closed with the justification of closed 2457)\r\n- https:\/\/tickets.opscode.com\/browse\/CHEF-4727 (dead link)\r\n\r\n### Describe the Enhancement:\r\n\r\nMultiple supports in metadata.rb\r\n\r\n### Describe the Need:\r\n\r\nPotentially validate `supports` at upload time and\/or converge time \r\n\r\n### Current Alternative\r\n\r\nThere is no alternative.\r\n\r\n\r\n### Can We Help You Implement This?:\r\n\r\nThere should be 2 extensions:\r\n\r\n1. \r\n```ruby\r\nsupports 'centos', '~> 7.0'\r\nsupports 'centos', '~> 8.0'\r\nsupports 'centos', '~> 9.0'\r\n```\r\n2. `supports 'centos', '>= 7.0', '<= 9.0'`","comments":[],"labels":["Type: Enhancement","Triage: Feature Request","Status: Help Wanted"]},{"title":" [In Progress]INFC-405: Fix mount linux idempotent issue","body":"<!--- Provide a short summary of your changes in the Title above -->\r\n\r\n## Description\r\nFix mount linux idempotent issue\r\n\r\n## Related Issue\r\nhttps:\/\/chefio.atlassian.net\/browse\/INFC-405\r\nhttps:\/\/github.com\/chef\/chef\/issues\/13494\r\n\r\n## Types of changes\r\n<!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: -->\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [ ] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n<!--- If you're unsure about any of these, don't hesitate to ask. We're here to help! -->\r\n- [ ] I have read the **CONTRIBUTING** document.\r\n- [ ] I have run the pre-merge tests locally and they pass.\r\n- [ ] I have updated the documentation accordingly.\r\n- [ ] I have added tests to cover my changes.\r\n- [ ] All new and existing tests passed.\r\n- [ ] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=13626)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13626&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13626&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13626&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13626) No Coverage information  \n[![0.0%](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/3-16px.png '0.0%')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13626&metric=new_duplicated_lines_density&view=list) [0.0% Duplication](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13626&metric=new_duplicated_lines_density&view=list)\n\n","Is this still WIP?","> Is this still WIP?\r\n\r\nHi @jaymzh, Yes its still WIP as we have kept this work on hold due to compliance work .. so currently we are pending with unit spec which we would be start working soon.\r\n","Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=13626)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13626&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13626&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13626&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13626) No Coverage information  \n[![0.0%](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/3-16px.png '0.0%')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13626&metric=new_duplicated_lines_density&view=list) [0.0% Duplication](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13626&metric=new_duplicated_lines_density&view=list)\n\n","Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=13626)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13626&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13626&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13626&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13626&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13626) No Coverage information  \n[![0.0%](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/3-16px.png '0.0%')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13626&metric=new_duplicated_lines_density&view=list) [0.0% Duplication](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13626&metric=new_duplicated_lines_density&view=list)\n\n","@NAshwini Do you have time to update this?"],"labels":["Status: Waiting on Contributor","Do Not Merge"]},{"title":"Support to pass non-default path\/route","body":"Right now, per the code at\r\nhttps:\/\/github.com\/chef\/chef\/blob\/b12e038a577f12bede63eeffe876a0b40ab762dc\/lib\/chef\/secret_fetcher\/hashi_vault.rb#L115\r\nI only get an option to pass role_name and vault_address. But in case I have to use a non-default path\/route, I don't have the option to pass that parameter. \r\nCan you please add support to pass and accept path\/route variable needed for aws auth as documented [here](https:\/\/www.rubydoc.info\/github\/hashicorp\/vault-ruby\/Vault%2FAuthenticate:aws_iam)","comments":[],"labels":["Triage: Feature Request"]},{"title":"Amazon Linux 2023 Support","body":"### Describe the Enhancement:\r\nAccording to Chef Infra release notes, the latest stable version should support Amazon Linux 2022 already (18.x), but I can\u2019t find a build for it.\r\nIt was introduced in PR #12437 and later removed in PR #13169\r\n\r\nAmazon Linux 2022 is a release candidate and should be GA soon (hopefully)\r\nhttps:\/\/docs.aws.amazon.com\/linux\/al2022\/release-notes\/relnotes-20230118.html\r\n\r\nEDIT:\r\nAmazon Linux 2023 is now GA and has replaced any reference to Amazon Linux 2022\r\nhttps:\/\/docs.aws.amazon.com\/linux\/al2023\/ug\/release-cadence.html\r\n\r\n<!---  What you are trying to achieve that you can't? -->\r\n\r\n### Describe the Need:\r\n<!---  What kind of user do you believe would utilize this enhancement, and how many users might want this functionality -->\r\nRemove Amazon Linux 2022 as a supported OS from the documentation, or make it available.\r\n\r\n### Current Alternative\r\n<!--- Is there a current alternative that you can utilize to workaround the lack of this enhancement -->\r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\n","comments":["Looking into this - current change to revert the commented builders is in [praj\/add_amazon_linux_2022](https:\/\/buildkite.com\/chef\/chef-chef-main-validate-adhoc\/builds?branch=praj%2Fadd_amazon_linux_2022). Testing that out internally.","Build succeeded, does that means it worked ?","@PrajaktaPurohit any updates ?","Looks like Amazon Linux 2022 is renamed to Amazon Linux 2023. \r\nAmazon Linux 2023 is in preview release and is subject to change.\r\nhttps:\/\/docs.aws.amazon.com\/linux\/al2023\/ug\/release-cadence.html","The build is successful, but it was not able to find the builders for Amazon Linux 2022. Still looking.","FYI, Amazon Linux 2023 went GA today: https:\/\/aws.amazon.com\/about-aws\/whats-new\/2023\/03\/amazon-linux-2023\/","@PrajaktaPurohit Any updates ?","Curious if there's any updates on this?","@PrajaktaPurohit any updates ? This was opened almost 3 months ago and no actions yet.","@PrajaktaPurohit Now 4 months since it was requested, a year after it was apparently supported and still no update ?","I think everyone here would highly appreciate if you provide ETA for AL2023 support. I can not install Chef on AL2023 and ETA for support would help to understand how to move further.","It is possible to work around this by installing libxcrypt-compat.\r\n\r\nsudo yum install -y libxcrypt-compat","Hey folks, sorry for the delay on this one. We are currently in the process of prioritizing the addition of builders for Amazon Linux 2023 as a part of the PI planning process for the iteration beginning on the 1st of August. I will post an update based on the outcome of the planning by the end of July 23.","@PrajaktaPurohit - Any updates on this?","@PrajaktaPurohit - Any updates on this?","Are there any new updates on this issue? Thank you. ","@PrajaktaPurohit are you able to comment on whether there are any workarounds for use with amazon Linux 2023? ","Although we don't seem to have a request on the [AL2023 GitHub project](https:\/\/github.com\/amazonlinux\/amazon-linux-2023\/issues?q=is%3Aissue+chef) for `chef`, I can say that we are getting customer requests for Chef support for AL2023 through the non-GitHub channels available to customers.\r\n\r\nAm happy to sync up out of band on possible options for those looking for Chef on Amazon Linux if that's preferred.","I am now using Ansible as Chef was taking too long.","Hey @stewartsmith \ud83d\udc4b\ud83c\udffb \r\nWhat would be the best way to reach out to you? Should we go through our AWS TAM?","> Hey @stewartsmith \ud83d\udc4b\ud83c\udffb \n> \n> What would be the best way to reach out to you? Should we go through our AWS TAM?\n\nTAMs are great because they're good at following up when devs and PMs are busy \ud83d\ude00 \n\ni.e. AWS customers should reach out to their TAM for best\/most reliable results.\n\nFor the Chef product team, and chatting about how we can work together to help our mutual customers: you can either shot me an email, or connect through the normal AWS channels.","Hello! I'm trying to use Chef InSpec on Amazon Linux 2023 and came across the issue discussed here. Is there any update on compatibility or any recommended workaround that we can use in the meantime? The ability to effectively use Chef InSpec on Amazon Linux 2023 is crucial for our workflow. Thank you, any additional information would be greatly appreciated!"],"labels":["Type: Regression","Triage: Confirmed","Status: Waiting on Release","Chef 18.5"]},{"title":"aws-sdk-ec2 gem broken in infra client 17.x","body":"Internal issue link [CHEF-5464](https:\/\/chefio.atlassian.net\/browse\/CHEF-5464)\r\n\r\n## Description\r\n\r\nIn chef infra client 17.x, it is no longer possible to use the latest version of the `aws-sdk-ec2` gem because it conflicts with a pinned dependency in chef-client.\r\n\r\nIt looks like AWS had to bump the dependency constraints to fix a backwards compatibility problem here https:\/\/github.com\/aws\/aws-sdk-ruby\/issues\/2774\r\n\r\n## Chef Version\r\n\r\nChef Infra Client 17.10.3\r\n\r\n## Platform Version\r\n\r\nUbuntu 20.04.5 LTS\r\n\r\n## Replication Case\r\n\r\nIn a recipe:\r\n\r\n```ruby\r\nchef_gem 'aws-sdk-ec2' do\r\n  compile_time true\r\nend\r\n\r\nrequire 'aws-sdk-ec2'\r\n```\r\n\r\n## Client Output\r\n\r\n```\r\nGem::ConflictError\r\n------------------\r\nUnable to activate aws-sdk-ec2-1.364.0, because aws-sdk-core-3.130.0 conflicts with aws-sdk-core (~> 3, >= 3.165.0)\r\n```\r\n\r\n## Stacktrace\r\n\r\n```\r\nGem::ConflictError: Unable to activate aws-sdk-ec2-1.364.0, because aws-sdk-core-3.130.0 conflicts with aws-sdk-core (~> 3, >= 3.165.0)\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/rubygems\/specification.rb:2237:in `raise_if_conflicts'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/rubygems\/specification.rb:1368:in `activate'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/rubygems.rb:221:in `rescue in try_activate'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/rubygems.rb:214:in `try_activate'\r\n<internal:\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/rubygems\/core_ext\/kernel_require.rb>:153:in `rescue in require'\r\n<internal:\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/rubygems\/core_ext\/kernel_require.rb>:149:in `require'\r\n\/var\/chef\/cache\/cookbooks\/example\/recipes\/test.rb:5:in `from_file'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/mixin\/from_file.rb:34:in `instance_eval'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/mixin\/from_file.rb:34:in `from_file'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/cookbook_version.rb:233:in `load_ruby_recipe'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/cookbook_version.rb:203:in `load_recipe'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/run_context.rb:417:in `load_recipe'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/run_context\/cookbook_compiler.rb:228:in `block in compile_recipes'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/run_context\/cookbook_compiler.rb:225:in `each'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/run_context\/cookbook_compiler.rb:225:in `compile_recipes'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/run_context\/cookbook_compiler.rb:109:in `compile'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/run_context.rb:247:in `load'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/policy_builder\/expand_node_object.rb:103:in `setup_run_context'\r\n\/opt\/chef\/embedded\/lib\/ruby\/3.0.0\/forwardable.rb:238:in `setup_run_context'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/client.rb:495:in `setup_run_context'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/client.rb:281:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/application.rb:264:in `run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/application\/base.rb:352:in `run_application'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/application.rb:67:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-bin-17.10.3\/bin\/chef-client:25:in `<top (required)>'\r\n\/opt\/chef\/bin\/chef-client:160:in `load'\r\n\/opt\/chef\/bin\/chef-client:160:in `<main>'\r\n```\n\n[CHEF-5464]: https:\/\/chefio.atlassian.net\/browse\/CHEF-5464?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","comments":["This will be resolved in the next release of Chef 17 (>17.10.80)\r\n\r\n"],"labels":["Status: Adopted","Backport: 17"]},{"title":"ifconfig resource does not work on RHEL 9","body":"### Describe the Enhancement:\r\nConfigure network interfaces on RHEL 9 using ifconfig resource OR provide a new resource that allows configuration of network interfaces with NetworkManager on RHEL 9.\r\n\r\n### Describe the Need:\r\nBasic network configuration is fundamental for an operative system.\r\n\r\n### Current Alternative\r\nNone (at least with ifconfig resource).","comments":["The current work around is to install `NetworkManager-initscripts-updown` and then make sure you do not create conflicting interfaces with the nm API\/CLI\/GUI (and make sure there's no keyfile for your interface). See https:\/\/www.redhat.com\/en\/blog\/rhel-9-networking-say-goodbye-ifcfg-files-and-hello-keyfiles"],"labels":["Status: Untriaged"]},{"title":"File Resource should have a property for Setting Permissions Using Letter Notation","body":"### Describe the Enhancement:\r\nFile resource required to set a permission in letter notation format.\r\n\r\n**Setting Permissions Using Letter Notation**\r\n\r\n_The syntax for using letter notation is:_\r\n`chmod [access class][operator][letter permission] file`\r\n\r\n_Access classes are indicated using initials, as follows:_\r\n1. u for user\r\n2. g for group\r\n3. o for other\r\n4. a for all three: user and group and other\r\nYou can combine initials together. For example, `uo` would stand for user and other.\r\n\r\n_The operators are the following:_\r\n1. '+' to add a permission\r\n2. '-' to remove a permission\r\n3. '=' to set a permission\r\nThe permission types being manipulated are indicated using [letter notation](https:\/\/www.pair.com\/support\/kb\/file-permissions\/#letters) as described above.\r\n\r\n_chmod Numeric Notation Example:_\r\nTo add execute permission to user for the file example.html, you would use the following command:\r\n`chmod u+x example.html`\r\n\r\n### Describe the Need:\r\nWe have few CIS controls which has not a complete details for one of the access class so we could not use `mode` property \r\neg:\r\nhttps:\/\/github.com\/chef\/improvised_cookbooks\/pull\/1\/files#diff-4eb1f94dfc9cba81c26467ba2dc078f1bd8b44c0a31e032db70866e6bef9c280R333\r\n```\r\n  execute \"Ensures  users' dot files are not group or world writable\" do\r\n     command \"chmod go-w #{file}\"\r\n   end\r\n```\r\n\r\n### Current Alternative\r\n<!--- Is there a current alternative that you can utilize to workaround the lack of this enhancement -->\r\nCurrently we are using `execute` resource.\r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\n","comments":[],"labels":["Status: Help Wanted"]},{"title":"Allow more train plugins for the knife bootstrap command","body":"## Description\r\n\r\nThese changes supported protocols for `knife bootstrap` to dynamic detection of installed Train transports instead of just static `ssh` and `winrm`.\r\n\r\nWith this,  alternative connection options such as AWS Systems Manager, Telnet, Serial\/USB, and others get viable for easy onboarding of Chef nodes.\r\n\r\n## Types of changes\r\n- [ ] Bug fix (non-breaking change which fixes an issue)\r\n- [x] New feature (non-breaking change which adds functionality)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Chore (non-breaking change that does not add functionality or fix an issue)\r\n\r\n## Checklist:\r\n- [x] I have read the **CONTRIBUTING** document.\r\n- [x] I have run the pre-merge tests locally, and they pass.\r\n- [x] I have added tests to cover my changes.\r\n- [x] All new and existing tests passed.\r\n- [x] All commits have been signed-off for [the Developer Certificate of Origin](https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#developer-certification-of-origin-dco).\r\n","comments":["Concerning the unit test failure: that particular test works with `rake spec` but not with `bundle exec rake spec`.\r\n\r\nI am somewhat out of my depth here, as I don't know the difference between both or how to update my faked `Gem::Specification` to work inside `bundle exec`.\r\n\r\nSome advice would be appreciated :-)","Wow, that was an embarrassing typo you found there :sweat:","Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=13534)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13534&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13534&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13534&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13534) No Coverage information  \n[![0.0%](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/3-16px.png '0.0%')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13534&metric=new_duplicated_lines_density&view=list) [0.0% Duplication](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13534&metric=new_duplicated_lines_density&view=list)\n\n","Your specs are failing:\r\n\r\n>   1) Chef::Knife::Bootstrap#validate_protocol! when additional Train transports are present and their usage is supported accepts the transport as protocol","See my comment. Why the two commands behave differently is unclear to me - and as such I have no idea how to fix ","If you think about it, it is obvious: Bundler creates sort of a \"clean room\" for Gems and overrides some of the methods which usually access them.\r\n\r\nThis also means my approach of injecting a fictional transport will not work. Additionally, the Bundler internals are not very friendly to external mocking\/stubing\/faking\/whatever. It would couple the test closely to the internal implementation of Bundler, which seems like the textbook anti-pattern of testing.\r\n\r\nUnder these circumstances, I do not see a viable way to test the correct behavior on including plugin-based transports to check for correct behavior. The behavior on inexistent transports will, of course, still be valid.\r\n\r\nProposition: As the use case of including Train-based transports for bootstrapping is very limited and writing a test for this case is hard, I would remove the implementation of the test (make it green on purpose) but add a comment inside describing the core problem.\r\n\r\nThis would signal that an effort has been made to make it testable but mark it as out of scope\/future task.\r\n\r\nOpinions?","OK, yeah that makes sense. But lets:\r\n1. Keep the hard-coded tests for `winrm` and `ssh`, those should work fine without the gemspec mocks\r\n2. For the dynamic test, do as you described, an empty test with a comment. Also, lets create an issue for it, and reference the issue in the comment","@tecracer-theinen - any update here? If we can get those last bit done, we can merge and backport.","Apologies, I currently have no active Chef project and things went out of sight. I replaced the misfunctioning test with a `skip` and the comment as discussed","I'm good with the changes, but this needs a rebase (for all the buildkite tests) and a sign-off (DCO) please","Kudos, SonarCloud Quality Gate passed!&nbsp; &nbsp; [![Quality Gate passed](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/QualityGateBadge\/passed-16px.png 'Quality Gate passed')](https:\/\/sonarcloud.io\/dashboard?id=chef_chef&pullRequest=13534)\n\n[![Bug](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/bug-16px.png 'Bug')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=BUG) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=BUG) [0 Bugs](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=BUG)  \n[![Vulnerability](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/vulnerability-16px.png 'Vulnerability')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=VULNERABILITY) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=VULNERABILITY) [0 Vulnerabilities](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=VULNERABILITY)  \n[![Security Hotspot](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/security_hotspot-16px.png 'Security Hotspot')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13534&resolved=false&types=SECURITY_HOTSPOT) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13534&resolved=false&types=SECURITY_HOTSPOT) [0 Security Hotspots](https:\/\/sonarcloud.io\/project\/security_hotspots?id=chef_chef&pullRequest=13534&resolved=false&types=SECURITY_HOTSPOT)  \n[![Code Smell](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/common\/code_smell-16px.png 'Code Smell')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=CODE_SMELL) [![A](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/RatingBadge\/A-16px.png 'A')](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=CODE_SMELL) [0 Code Smells](https:\/\/sonarcloud.io\/project\/issues?id=chef_chef&pullRequest=13534&resolved=false&types=CODE_SMELL)\n\n[![No Coverage information](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/CoverageChart\/NoCoverageInfo-16px.png 'No Coverage information')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13534) No Coverage information  \n[![0.6%](https:\/\/sonarsource.github.io\/sonarcloud-github-static-resources\/v2\/checks\/Duplications\/3-16px.png '0.6%')](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13534&metric=new_duplicated_lines_density&view=list) [0.6% Duplication](https:\/\/sonarcloud.io\/component_measures?id=chef_chef&pullRequest=13534&metric=new_duplicated_lines_density&view=list)\n\n","Rebased and DCO passes now","@thheinen do you have an opportunity for one last rebase? I think the above unsuccessful checks should all be fixed.","> @thheinen do you have an opportunity for one last rebase? I think the above unsuccessful checks should all be fixed.\r\n\r\nFollowing up... do you have an opportunity to do one last rebase so we can merge?","Somehow this branch got nuked. Moving the code to a new PR"],"labels":["Status: Waiting on Contributor","Backport: 17"]},{"title":"`recipe-url` parameter fails accessing S3 from EC2 instances","body":"## Description\r\n\r\nTrying to fetch a bundled cookbook via S3 fails if it is supposed to use EC2 instance credentials.\r\n\r\n## Chef Version\r\n\r\n18.1.0\r\n\r\n## Platform Version\r\n\r\nAmazon Linux 2 (x86)\r\n\r\n## Replication Case\r\n\r\nStart EC2 instance, attach IAM role with S3 read access, and deploy cookbook bundle.\r\nRun Chef Infra:\r\n\r\n```shell\r\nchef-client --local-mode --recipe-url s3:\/\/bucketname\/bundlename.tgz --runlist 'recipe[cookbookname]'\r\n```\r\n\r\n## Client Output\r\n\r\n```\r\n[2023-01-23T11:26:58+00:00] WARN: No config file found or specified on command line. Using command line options instead.\r\n[2023-01-23T11:26:58+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming \/opt\/chef\/embedded\/bin.\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/aws-sdk-core-3.168.4\/lib\/aws-sdk-core\/plugins\/regional_endpoint.rb:92:in `after_initialize': No region was provided. Configure the `:region` option or export the region name to ENV['AWS_REGION'] (Aws::Errors::MissingRegionError)\r\n        from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/aws-sdk-core-3.168.4\/lib\/seahorse\/client\/base.rb:81:in `block in after_initialize'\r\n        from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/aws-sdk-core-3.168.4\/lib\/seahorse\/client\/base.rb:80:in `each'\r\n        from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/aws-sdk-core-3.168.4\/lib\/seahorse\/client\/base.rb:80:in `after_initialize'\r\n        from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/aws-sdk-core-3.168.4\/lib\/seahorse\/client\/base.rb:24:in `initialize'\r\n        from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/aws-sdk-s3-1.117.2\/lib\/aws-sdk-s3\/client.rb:452:in `initialize'\r\n        from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/aws-sdk-core-3.168.4\/lib\/seahorse\/client\/base.rb:102:in `new'\r\n        from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application\/base.rb:389:in `fetch_recipe_tarball'\r\n        from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application\/client.rb:108:in `reconfigure'\r\n        from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.1.0\/lib\/chef\/application.rb:64:in `run'\r\n        from \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-bin-18.1.0\/bin\/chef-client:25:in `<top (required)>'\r\n        from \/bin\/chef-client:184:in `load'\r\n        from \/bin\/chef-client:184:in `<main>'\r\n```\r\n\r\nThe current implementation assumes a configured AWS profile in `~\/.aws\/config`, containing a `region` statement.\r\n\r\nRunning Chef Infra on a fresh instance (installing via user-data) does not have this, so a region is unavailable, and the message above is thrown.\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"bundler failed to load command knife with Ruby3.2","body":"Hey\r\n\r\nI come cross an error when trying to upgrade chef client from 17.10.3 (Ruby 3.0)  to 18.1.0 (Ruby 3.2).\r\n\r\n## Description\r\nbundler: failed to load command: knife (\/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/bin\/knife)\r\n\r\n## Chef Version\r\nChef 18.1.0\r\n\r\n## Platform Version\r\nruby:3.2.0-alpine3.17\r\n\r\n## Replication Case\r\nStart a container from Ruby 3.2 docker image 'ruby:3.2.0-alpine3.17', install bundler, chef etc. Run command 'bundle exec knife cookbook list'. \r\n\r\n## Client Output\r\n```\r\n[2023-01-16T22:56:17.501Z] + bundle exec knife ssl_fetch https:\/\/xxxxxxxx.xxxx.xx\/ --trace\r\n\r\n[2023-01-16T22:56:18.080Z] bundler: failed to load command: knife (\/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/bin\/knife)\r\n\r\n[2023-01-16T22:56:18.080Z] \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife\/core\/gem_glob_loader.rb:81:in `block in find_files_latest_gems': undefined method `untaint' for \"\/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife\/acl_add.rb\":String (NoMethodError)\r\n\r\n[2023-01-16T22:56:18.080Z] \r\n\r\n[2023-01-16T22:56:18.080Z]             end.flatten.select { |file| File.file? file.untaint }\r\n\r\n[2023-01-16T22:56:18.080Z]                                                        ^^^^^^^^\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife\/core\/gem_glob_loader.rb:81:in `select'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife\/core\/gem_glob_loader.rb:81:in `find_files_latest_gems'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife\/core\/gem_glob_loader.rb:49:in `find_subcommands_via_rubygems'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife\/core\/gem_glob_loader.rb:43:in `gem_and_builtin_subcommands'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife\/core\/gem_glob_loader.rb:29:in `subcommand_files'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife\/core\/subcommand_loader.rb:106:in `load_commands'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife\/core\/subcommand_loader.rb:116:in `load_command'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife\/core\/subcommand_loader.rb:130:in `command_class_from'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife.rb:165:in `subcommand_class_from'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/knife.rb:228:in `run'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/lib\/chef\/application\/knife.rb:165:in `run'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/gems\/knife-18.1.0\/bin\/knife:24:in `<top (required)>'\r\n\r\n[2023-01-16T22:56:18.080Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/bin\/knife:25:in `load'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/home\/jenkins\/.bundle\/vendor\/ruby\/3.2.0\/bin\/knife:25:in `<top (required)>'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/cli\/exec.rb:58:in `load'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/cli\/exec.rb:58:in `kernel_load'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/cli\/exec.rb:23:in `run'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/cli.rb:491:in `exec'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/vendor\/thor\/lib\/thor\/command.rb:27:in `run'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/vendor\/thor\/lib\/thor\/invocation.rb:127:in `invoke_command'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/vendor\/thor\/lib\/thor.rb:392:in `dispatch'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/cli.rb:34:in `dispatch'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/vendor\/thor\/lib\/thor\/base.rb:485:in `start'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/cli.rb:28:in `start'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/exe\/bundle:45:in `block in <top (required)>'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/lib\/bundler\/friendly_errors.rb:117:in `with_friendly_errors'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/gems\/bundler-2.4.3\/exe\/bundle:33:in `<top (required)>'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/bin\/bundle:25:in `load'\r\n\r\n[2023-01-16T22:56:18.081Z] \tfrom \/usr\/local\/bundle\/bin\/bundle:25:in `<main>'\r\n\r\nscript returned exit code 1\r\n```\r\n\r\n","comments":["A bit of further info, seems that taint checking was removed from Ruby 3.2 https:\/\/bugs.ruby-lang.org\/issues\/16131","can confirm this bug still exists with Chef 18.3.0 and Ruby 3.2.2"],"labels":["Status: Untriaged"]},{"title":"homebrew_package resource doesn't respect timeout value","body":"## Description\r\nThe homebrew_package resource doesn't respect the `timeout` property value. The install execution is hardcoded to 1800s: https:\/\/github.com\/chef\/chef\/blob\/61a11902ab814aad3625eb4da7e3345d63ee7c09\/lib\/chef\/provider\/package\/homebrew.rb#L194\r\n\r\nIt appears at one point there was a [shell_out_with_timeout](https:\/\/github.com\/chef\/chef\/commit\/23e3c799803ac1800149e27271c6168539cea25e#diff-1014d6bb851bfab276af22ca20913d8dda2401512d76de8d095e54c5c77ea844) method, but not sure if that's deprecated now (maybe @lamont-granquist knows?). \r\n\r\nAlternatively, if fixing this will take awhile, can we at least hardcode a longer timeout? \r\n\r\n## Chef Version\r\n18.x, 17.x, 16.x\r\n\r\n## Platform Version\r\nmacOS 13.x, 12.x, 11.x, 10.15.x\r\n\r\n## Replication Case\r\n```\r\nhomebrew_package 'package-with-install-time-of-45min' do\r\n  timeout 3600\r\nend\r\n```\r\n\r\n## Client Output\r\n```\r\nRecipe: cookbook::homebrew\r\n         * homebrew_package[package-with-install-time-of-45min] action install\r\n           \r\n           ================================================================================\r\n           Error executing action `install` on resource 'homebrew_package[package-with-install-time-of-45min]'\r\n           ================================================================================\r\n           \r\n           Mixlib::ShellOut::CommandTimeout\r\n           --------------------------------\r\n           Command timed out after 1800s:\r\n           Command exceeded allowed execution time, process terminated\r\n           ---- Begin output of [\"brew\", \"install\", \"package-with-install-time-of-45min\"] ----\r\n\r\n```\r\n\r\n## Stacktrace\r\n```\r\nError: SIGTERM\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:83:in `read'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:83:in `block (3 levels) in safe_fork'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/utils.rb:420:in `ignore_interrupts'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:73:in `block (2 levels) in safe_fork'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:34:in `open'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:34:in `block in safe_fork'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/vendor\/portable-ruby\/2.6.8_1\/lib\/ruby\/2.6.0\/tmpdir.rb:93:in `mktmpdir'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:33:in `safe_fork'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:906:in `build'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:453:in `install'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:739:in `install_dependency'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:659:in `block in install_dependencies'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:659:in `each'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:659:in `install_dependencies'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:403:in `install'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/upgrade.rb:203:in `install_formula'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:350:in `install_formula'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:340:in `block in install_formulae'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:339:in `each'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:339:in `install_formulae'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/cmd\/install.rb:230:in `install'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/brew.rb:98:in `<main>'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:65:in `write': Broken pipe (Errno::EPIPE)\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:65:in `puts'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:65:in `rescue in block (3 levels) in safe_fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:39:in `block (3 levels) in safe_fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:37:in `fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:37:in `block (2 levels) in safe_fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:34:in `open'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:34:in `block in safe_fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/vendor\/portable-ruby\/2.6.8_1\/lib\/ruby\/2.6.0\/tmpdir.rb:93:in `mktmpdir'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:33:in `safe_fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:906:in `build'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:453:in `install'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:739:in `install_dependency'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:659:in `block in install_dependencies'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:659:in `each'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:659:in `install_dependencies'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:403:in `install'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/upgrade.rb:203:in `install_formula'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:350:in `install_formula'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:340:in `block in install_formulae'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:339:in `each'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:339:in `install_formulae'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/cmd\/install.rb:230:in `install'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/brew.rb:98:in `<main>'\r\n\/usr\/local\/Homebrew\/Library\/Homebrew\/sandbox.rb:132:in `each_char': SIGTERM (SignalException)\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/sandbox.rb:132:in `block (2 levels) in exec'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/sandbox.rb:154:in `block in exec'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/sandbox.rb:104:in `spawn'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/sandbox.rb:104:in `exec'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:918:in `block in build'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:45:in `block (3 levels) in safe_fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:37:in `fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:37:in `block (2 levels) in safe_fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:34:in `open'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:34:in `block in safe_fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/vendor\/portable-ruby\/2.6.8_1\/lib\/ruby\/2.6.0\/tmpdir.rb:93:in `mktmpdir'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/utils\/fork.rb:33:in `safe_fork'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:906:in `build'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:453:in `install'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:739:in `install_dependency'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:659:in `block in install_dependencies'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:659:in `each'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:659:in `install_dependencies'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/formula_installer.rb:403:in `install'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/upgrade.rb:203:in `install_formula'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:350:in `install_formula'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:340:in `block in install_formulae'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:339:in `each'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/install.rb:339:in `install_formulae'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/cmd\/install.rb:230:in `install'\r\n\tfrom \/usr\/local\/Homebrew\/Library\/Homebrew\/brew.rb:98:in `<main>'\r\n---- End output of [\"brew\", \"install\", \"package-with-install-time-of-45min\"] ----\r\nRan [\"brew\", \"install\", \"package-with-install-time-of-45min\"] returned 1\r\n```\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"missing functionality from chef-sugar port","body":"hi,\r\nafter some code review it was noticed that the core_extensions from chef-sugar[1] were not ported into chef-client. Is there a reason for this? Can it be added on an opt-in basis? I understand mixing into String by default would be undesirable, but on an opt-in basis I don't see any reason to not provide similar functionality.\r\n[1] https:\/\/github.com\/chef-boneyard\/chef-sugar#core-extensions\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"action :remount in mount resource is not idempotent. ","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nFor action `:remount`, `mount` resource  is not idempotent by default.\r\n\r\nNote: \r\nThis is the way it should work:\r\nIf remount then it should check if mounted or not. \r\nIf not then it need to remount else do nothing but a log message.\r\n\r\n\r\n## Chef Version\r\nChef Infra Client: 17.10.3\r\n\r\n## Platform Version\r\nAlma Linux 8\r\n\r\n## Replication Case\r\nExample\r\nmy code:\r\n```ruby\r\nmount tmp do\r\n    fstype 'tmpfs'\r\n    device tmp\r\n    options 'nosuid,nodev,noexec'\r\n    action :remount\r\n    not_if 'mount | grep \/tmp | grep nosuid,nodev,noexec'\r\n end\r\n```\r\n\r\nCookbook Result on 1st run:\r\n\r\n```\r\nmount[\/tmp] action remount\r\nunmount \/tmp\r\nmount \/tmp\r\n```\r\n\r\nCookbook Result on 2nd run:\r\n\r\n```\r\nmount[\/tmp] action remount\r\nunmount \/tmp\r\nmount \/tmp\r\n```\r\n\r\nNote:  Currently to male it idempotent I am adding not_if guard.\r\n\r\n## Client Output\r\n```\r\nmount[\/tmp] action remount\r\nunmount \/tmp\r\nmount \/tmp\r\n```\r\n\r\n## Stacktrace\r\n\r\n","comments":["The recipe used here is incorrect. \r\n\r\nThe `mount` resource has a property named supports which sets {remount: false} by default. Ref  doc [mount Resource](https:\/\/docs.chef.io\/resources\/mount\/#properties) , and by definition of this resource if this flag is not set for action remount , it does the unmounting and then mounting of the endpoint.\r\nHere\u2019s action remount https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/provider\/mount.rb#L62, if it does not find property `supports` to be set to true, it will perform the recipe by first unmounting and then mounting the endpoint(which is what is seen example mentioned above). So recipe rather needs to set this property for the mount resource to be able to do a remount Once the property is set, the resource will continue with the remount_fs call [here](https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/provider\/mount\/mount.rb#L140) and perform the mount -o remount... command which is not happening due to the missing property.\r\n\r\nSo in conclusion, it is not an issue in the mount resource but the recipe is incorrect. The expected recipe for action remount to perform remounting of an existing endpoint is to set the property `supports remount: true` in the recipe."],"labels":["Status: Untriaged"]},{"title":"Inspec test failing on virtualization.virtual_system","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nIn a cookbook compliance\/inspec test, \"virtualization.virtual_system?\" is failing. Appears to be returning nothing (nil) on Redhat\r\nCode works fine in chef-client-17 but is failing on chef-client-18\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n18.1.0\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nRunning on vmware: Redhat 6.10, Redhat 7.9, & Redhat 8.4\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\nI've a cookbook compliance test that works fine via chef-client-17 but suddenly failing on chef-client-18\r\n\r\nFor debugging, I put in code into my test.rb file:\r\n  if virtualization.virtual_system? \r\n    puts \"============== YES virtualization.virtual_system? \"\r\n  else\r\n    puts \"============== NOT virtualization.virtual_system? \"\r\n  end\r\nputs \"NAME=\" + virtualization.system\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\nOutput from my debug lines running chef-client-18 are:\r\n============== NOT virtualization.virtual_system? \r\nno implicit conversion of nil into String\r\n\r\nwhen I run the same code on chef-client-17.10.3 I see what I expect to see of:\r\n============== YES virtualization.virtual_system? \r\nNAME=vmware\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Knife bootstrap identity file is not picking up","body":"I am able to ssh to server with same key, but knife command is not using identity file but asking for password.\r\n\r\nTried on windows-11 and ubuntu 22.04\r\n\r\nknife bootstrap ip -p 22 -U ubuntu --sudo -i test.pem -N test  --bootstrap-version 18.1.0 -VV\r\n\r\nWARNING: No knife configuration file found. See https:\/\/docs.chef.io\/config_rb\/ for details.\r\nDEBUG: Checking if we need to accept Chef license to bootstrap node\r\nDEBUG: Reading products and relationships...\r\nDEBUG: Successfully read products and relationships\r\nDEBUG: License acceptance required for chef version: 18.1.0\r\nDEBUG: Searching for the following licenses: [\"infra-client\", \"inspec\"]\r\nDEBUG: Found license chef_infra_client at \/home\/ubuntu\/.chef\/accepted_licenses\/chef_infra_client\r\nDEBUG: Found license inspec at \/home\/ubuntu\/.chef\/accepted_licenses\/inspec\r\nDEBUG: Missing licenses remaining: []\r\nDEBUG: All licenses present\r\nConnecting to 15.206.203.164 using ssh\r\nDEBUG: [SSH] opening connection to ubuntu@15.206.203.164\r\nDEBUG: [SSH] using options {:user_known_hosts_file=>\"\/dev\/null\", :port=>\"22\", :compression=>false, :compression_level=>0, :keepalive=>true, :keepalive_interval=>60, :timeout=>60, :auth_methods=>[\"none\", \"publickey\"], :keys_only=>true, :keys=>[\"vikrant.pem\"], :password=>\"<hidden>\", :forward_agent=>false, :non_interactive=>true, :append_all_supported_algorithms=>true, :verify_host_key=>:always}\r\nThe authenticity of host '[15.206.203.164]:22 ()' can't be established.\r\nfingerprint is SHA256:2CV1pe0kHqdp7OXC3gf6WUJxJNPOKC1IgNlumGasDbM.\r\n\r\nAre you sure you want to continue connecting\r\n? (Y\/N) Y\r\nConnecting to 15.206.203.164 using ssh\r\nDEBUG: [SSH] opening connection to ubuntu@15.206.203.164\r\nDEBUG: [SSH] using options {:user_known_hosts_file=>\"\/dev\/null\", :port=>\"22\", :compression=>false, :compression_level=>0, :keepalive=>true, :keepalive_interval=>60, :timeout=>60, :auth_methods=>[\"none\", \"publickey\"], :keys_only=>true, :keys=>[\"vikrant.pem\"], :password=>\"<hidden>\", :forward_agent=>false, :non_interactive=>true, :append_all_supported_algorithms=>true, :verify_host_key=>:accept_new}\r\nINFO: [SSH] connection failed, retrying in 1 seconds (#<Net::SSH::AuthenticationFailed: Authentication failed for user ubuntu@15.206.203.164>)\r\nDEBUG: [SSH] opening connection to ubuntu@15.206.203.164\r\nDEBUG: [SSH] using options {:user_known_hosts_file=>\"\/dev\/null\", :port=>\"22\", :compression=>false, :compression_level=>0, :keepalive=>true, :keepalive_interval=>60, :timeout=>60, :auth_methods=>[\"none\", \"publickey\"], :keys_only=>true, :keys=>[\"vikrant.pem\"], :password=>\"<hidden>\", :forward_agent=>false, :non_interactive=>true, :append_all_supported_algorithms=>true, :verify_host_key=>:accept_new}\r\nINFO: [SSH] connection failed, retrying in 1 seconds (#<Net::SSH::AuthenticationFailed: Authentication failed for user ubuntu@15.206.203.164>)\r\nDEBUG: [SSH] opening connection to ubuntu@15.206.203.164\r\nDEBUG: [SSH] using options {:user_known_hosts_file=>\"\/dev\/null\", :port=>\"22\", :compression=>false, :compression_level=>0, :keepalive=>true, :keepalive_interval=>60, :timeout=>60, :auth_methods=>[\"none\", \"publickey\"], :keys_only=>true, :keys=>[\"vikrant.pem\"], :password=>\"<hidden>\", :forward_agent=>false, :non_interactive=>true, :append_all_supported_algorithms=>true, :verify_host_key=>:accept_new}\r\nINFO: [SSH] connection failed, retrying in 1 seconds (#<Net::SSH::AuthenticationFailed: Authentication failed for user ubuntu@15.206.203.164>)\r\nDEBUG: [SSH] opening connection to ubuntu@15.206.203.164\r\nDEBUG: [SSH] using options {:user_known_hosts_file=>\"\/dev\/null\", :port=>\"22\", :compression=>false, :compression_level=>0, :keepalive=>true, :keepalive_interval=>60, :timeout=>60, :auth_methods=>[\"none\", \"publickey\"], :keys_only=>true, :keys=>[\"vikrant.pem\"], :password=>\"<hidden>\", :forward_agent=>false, :non_interactive=>true, :append_all_supported_algorithms=>true, :verify_host_key=>:accept_new}\r\nINFO: [SSH] connection failed, retrying in 1 seconds (#<Net::SSH::AuthenticationFailed: Authentication failed for user ubuntu@15.206.203.164>)\r\nDEBUG: [SSH] opening connection to ubuntu@15.206.203.164\r\nDEBUG: [SSH] using options {:user_known_hosts_file=>\"\/dev\/null\", :port=>\"22\", :compression=>false, :compression_level=>0, :keepalive=>true, :keepalive_interval=>60, :timeout=>60, :auth_methods=>[\"none\", \"publickey\"], :keys_only=>true, :keys=>[\"vikrant.pem\"], :password=>\"<hidden>\", :forward_agent=>false, :non_interactive=>true, :append_all_supported_algorithms=>true, :verify_host_key=>:accept_new}\r\nWARN: [SSH] connection failed, terminating (#<Net::SSH::AuthenticationFailed: Authentication failed for user ubuntu@15.206.203.164>)\r\nWARNING: Failed to authenticate ubuntu to 15.206.203.164 - trying password auth\r\nEnter password for ubuntu@15.206.203.164:","comments":[],"labels":["Status: Untriaged"]},{"title":"bash resource breaks on integer umask from chef 16 and up - string umask is required","body":"## Description\r\n\r\nUpgraded chef-client from 13 and 14 to (cinc-client) 17.  A previously working bash resource started failing with these error messages in the stack trace:\r\n\r\n```\r\nTypeError: no implicit conversion from nil to integer. \r\n>>>> Caused by NoMethodError: undefined method `oct' for 151:Integer\r\n```\r\n\r\nDowngrading to 15 made it work again.\r\n \r\n## Chef Version\r\nAll versions from 16.0 and up.\r\n\r\n## Platform Version\r\nDebian 10.\r\n\r\n## Replication Case\r\n\r\n```\r\nbash 'Replication SSL key and csr' do\r\n  cwd node[:mongodb][:cadir]\r\n  user 'root'\r\n  group filegroup\r\n  umask 0o227\r\n  code <<~SHELL\r\n    true\r\n  SHELL\r\n  creates nodekey\r\nend\r\n```\r\n\r\nThe `151:Integer`  in the stack trace derives from `umask 0o227`.\r\n\r\nWhen I change the umask statement to `umask '0227'` the resource works again.  This property has traditionally accepted both integers and strings, and still does, but breaks if a integer is given.\r\n\r\n## Client Output\r\n\r\nhttps:\/\/gist.github.com\/niclan\/5e6b0578a69567e632f86d70bd05f1f8\r\n\r\n## Stacktrace\r\n\r\nhttps:\/\/gist.github.com\/niclan\/5e6b0578a69567e632f86d70bd05f1f8\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Policyfile compliance phase with audit cookbook is not being skipped","body":"## Description\r\nWhen using the audit cookbook due to old dependency with newer chef-client with compliance phase a CB with a policyfile is not honoring compliance_phase false normal attribute from kitchen.yml file. Works fine when using berksfile but not policyfile. When logging into the kitchen instance you can find \/tmp\/kitchen\/dna.json has the audit: compliance_phase: false attribute and when viewing the \/tmp\/kitchen\/nodes\/default-centos-7.json you can see at the top the node normal attribute is showing audit: compliance_phase: false and the node default attributes are showing audit: compliance_phase: true\r\n\r\nNote: without the audit cookbook present this works as expected and compliance phase doesn't run\r\n\r\n## Chef Version\r\n18.0.185\r\n\r\n## Platform Version\r\ncentos-7\r\n\r\n## Replication Case\r\nusing cookbook attached run `kitchen converge` you'll get an error due to profiles unable to be downloaded\r\n\r\n## Client Output\r\nerror due to inspec profile unable to be downloaded from automate\r\n\r\n## Expected Output\r\nNormal chef-client run finishing successfully and not running compliance phase\r\n[test.zip](https:\/\/github.com\/chef\/chef\/files\/10346884\/test.zip)\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"selinux_fcontext resource, current_file_context is slow","body":"### Describe the Enhancement:\r\nselinux_fcontext is slow, which I believe is due to calling semanage fcontext -l multiple times.\r\n* In our case, we were adding about 10-15 contexts for \/var\/spool\/postfix.queuename, for 4 email different queues.  Went from 180sec to 450sec.\r\n\r\nFor our own use, I opted to store the semanage fcontext in a class variable (so it only runs once), and this brought the time back to what we were originally used to.  (Probably wrong place to store it if this is taken upstream, but doing one run of semanage fcontext -l vs many does help with speed\r\n<pre>\r\n lib\/chef\/resource\/selinux_fcontext.rb\r\n        def current_file_context\r\n           -contexts = shell_out!(\"semanage fcontext -l\").stdout.split(\"\\n\")\r\n           +contexts =  @@contexts ||= shell_out!(\"semanage fcontext -l\").stdout.split(\"\\n\")\r\n<\/pre>\r\n\r\n### Describe the Need:\r\nUsers with a high number of selinux_fcontext resources defined will have longer chef runs\r\n\r\n### Current Alternative\r\n\r\n### Can We Help You Implement This?:\r\nWe locally patch it using the following: (but more clear above)\r\n<pre>\r\nf=File.join(\"\/usr\/lib\/rvm\/gems\/#{node['chef_client']['rvm_ruby']}\/gems\/chef-#{node['chef_client']['rvm_chef']}\", 'lib\/chef\/resource\/selinux_fcontext.rb')\r\nfile f do\r\n    content IO.read(f).gsub(\r\n      \/contexts = shell_out\/, \"contexts = @@contexts ||= shell_out\")\r\nend if File.exists?(f)\r\n<\/pre>","comments":[],"labels":["Status: Untriaged"]},{"title":"`remote_file` does not preserve last modified time correctly","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n\r\n`remote_file` attempts to save the `Last-Modified` response header, with a fallback to the `Date` header and then use that for future conditional gets but a typo means it fails.\r\n\r\nThe code at https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/provider\/remote_file\/http.rb#L115 which fetches the date to save wrongly uses `last_modified` instead of `last-modified` when fetching the date, which doesn't work:\r\n\r\n```\r\nirb(main):003:0> res = Net::HTTP.get_response(URI(\"...\"))\r\n=> #<Net::HTTPOK 200 OK readbody=true>\r\nirb(main):004:0> res[\"last_modified\"]\r\n=> nil\r\nirb(main):005:0> res[\"date\"]\r\n=> \"Mon, 19 Dec 2022 16:03:01 GMT\"\r\nirb(main):006:0> res[\"last-modified\"]\r\n=> \"Fri, 18 Nov 2022 12:54:15 GMT\"\r\n```\r\n\r\n## Chef Version\r\n\r\n18.0.169\r\n\r\n## Platform Version\r\n\r\nUbuntu 22.04\r\n","comments":["This will be available with the next release of Infra Chef, version 18.3."],"labels":["Triage: Confirmed"]},{"title":"Chef Infra Client 17.10.3 displays passwords despite sensitive true being set","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nChef Infra Client 17.10.3 displays passwords despite sensitive true being set. This happens when there is an error. The password is displayed in the logs even though sensitive true is enabled. \r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nChef Infra Client, version 17.10.3\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nAmazon Linux and Windows\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n```\r\njenkins_windows_slave node['jenkins']['agent_name'] do\r\n    description node['jenkins']['agent_desc']\r\n    user 'Administrator'\r\n    executors node['jenkins']['executors']\r\n    usage_mode node['jenkins']['usage_mode']\r\n    availability node['jenkins']['availability']\r\n    in_demand_delay node['jenkins']['in_demand_delay']\r\n    idle_delay node['jenkins']['idle_delay']\r\n    labels lazy { get_labels(node.run_state['environment']) }\r\n    service_name node['jenkins']['service_name']\r\n    remote_fs node['jenkins']['remote_fs']\r\n    sensitive true\r\n  end\r\n```\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\nError: Mixlib::ShellOut::CommandTimeout\r\nMessage: jenkins_windows_slave[i-0fe6860968f8991be] (InfraJenkinsAgentJnlp::jenkins_install line 155) had an error: Mixlib::ShellOut::CommandTimeout: command timed out:\r\n---- Begin output of \"C:\\Program Files\\Amazon Corretto\\jdk11.0.16_9\/bin\/java\" -jar \"C:\\chef\\cache\/jenkins-cli.jar\" -s http:\/\/jenkins-controller.shared.aws-priv.calpoly.edu:8080\/ -http -auth \"username_redacted\":\"password_redacted\" groovy = ----\r\nSTDOUT: \r\nSTDERR:\r\n\r\n```\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":[],"labels":["Triage: Confirmed"]},{"title":"ConvertTo-SecureString can't find specified path","body":"Running chef-client from Scheduled Task with chef_client_scheduled_task resource. Able to run chef client normally with chef-client.bat, but when run as scheduled task get below error. I get \r\n\r\nLastTaskResult of 1, \r\n\r\n```\r\nPS C:\\Windows\\system32> Get-ScheduledTask -TaskName chef_run | Get-ScheduledTaskInfo\r\n\r\n\r\nLastRunTime        : 11\/10\/2022 10:49:49 PM\r\nLastTaskResult     : 1\r\nNextRunTime        : 11\/10\/2022 11:04:04 PM\r\nNumberOfMissedRuns : 0\r\nTaskName           : chef_run\r\nTaskPath           : \\\r\nPSComputerName     :\r\n```\r\n\r\nCan run manually, but when run as task, either time based or on-demand get below stacktrace. \r\n```\r\nChefPowerShell::PowerShellExceptions::PowerShellCommandFailed: Unexpected exit in PowerShell command: [\"ConvertTo-SecureString: The system cannot find the path specified.\\r\\n\\nAt line:1 char:363\\r\\n+ ... 0004eceb625b9fe69b03ea\r\n837c8c2ea29a6e677d30d\\\" | ConvertTo-SecureString\\r\\n+                                                    ~~~~~~~~~~~~~~~~~~~~~~\", \": Exception calling \\\"SecureStringToBSTR\\\" with \\\"1\\\" argument(s): \\\"Value cannot be null.\\r\\nP\r\narameter name: s\\\"\\nAt line:2 char:1\\r\\n+ $string = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime ...\\r\\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\"]\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-powershell-1.0.13\/lib\/chef-powershell\/powershell.rb:63:in `error!'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-powershell-1.0.13\/lib\/chef-powershell\/powershell_exec.rb:128:in `powershell_exec!'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:215:in `decrypt_pfx_pass'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:177:in `block in get_cert_password'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:175:in `each'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:175:in `get_cert_password'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:222:in `retrieve_certificate_key'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:98:in `retrieve_certificate_key'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:140:in `load_signing_key'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:45:in `initialize'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http.rb:104:in `new'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http.rb:104:in `block in initialize'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http.rb:103:in `each'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/http.rb:103:in `initialize'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/server_api.rb:40:in `initialize'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/client.rb:393:in `new'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/client.rb:393:in `rest'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/client.rb:266:in `run'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/application.rb:264:in `run_chef_client'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/application\/base.rb:352:in `run_application'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169-x64-mingw-ucrt\/lib\/chef\/application.rb:67:in `run'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-bin-18.0.169\/bin\/chef-client:25:in `<top (required)>'\r\nC:\/opscode\/chef\/bin\/chef-client:197:in `load'\r\nC:\/opscode\/chef\/bin\/chef-client:197:in `<main>'\r\n```","comments":["This is on Chef Client v 18.0.169. \r\n\r\n```\r\nPS C:\\Windows\\system32> chef-client --version\r\nChef Infra Client: 18.0.169\r\n```\r\n\r\nWorks properly on Chef Client v 17.10.3","As of today, this is still happening. We changed to Cinc, but I assume this persists still in Chef Client as well. \r\n\r\n```\r\nPS C:\\Windows\\System32> Get-Content C:\\cinc\\cache\\cinc-stacktrace.out\r\nGenerated at 2023-05-04 08:27:27 -0700\r\nChefPowerShell::PowerShellExceptions::PowerShellCommandFailed: Unexpected exit in PowerShell command: [\"ConvertTo-SecureString: The system cannot find the path specified.\\r\\n\\nAt line:1 char:363\\r\\n+ ... 0005c866c4a88ac893eb4db48af1fefd9ffed5b9350\\\" | ConvertTo-SecureString\\r\\n+                                                    ~~~~~~~~~~~~~~~~~~~~~~\", \": Exception calling \\\"SecureStringToBSTR\\\" with \\\"1\\\" argument(s): \\\"Value cannot be null.\\r\\nParameter name: s\\\"\\nAt line:2 char:1\\r\\n+ $string = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime ...\\r\\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\"]\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-powershell-18.0.1\/lib\/chef-powershell\/powershell.rb:63:in `error!'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-powershell-18.0.1\/lib\/chef-powershell\/powershell_exec.rb:128:in `powershell_exec!'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:261:in `decrypt_pfx_pass_with_password'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:192:in `get_cert_password'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:303:in `retrieve_certificate_key'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:98:in `retrieve_certificate_key'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:149:in `load_signing_key'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http\/authenticator.rb:45:in `initialize'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:104:in `new'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:104:in `block in initialize'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:103:in `each'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/http.rb:103:in `initialize'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/server_api.rb:40:in `initialize'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/client.rb:402:in `new'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/client.rb:402:in `rest'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/client.rb:275:in `run'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/application.rb:264:in `run_chef_client'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/application\/base.rb:352:in `run_application'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.2.7-x64-mingw-ucrt\/lib\/chef\/application.rb:67:in `run'\r\nC:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-bin-18.2.7\/bin\/cinc-client:25:in `<top (required)>'\r\nC:\/cinc-project\/cinc\/bin\/cinc-client:193:in `load'\r\nC:\/cinc-project\/cinc\/bin\/cinc-client:193:in `<main>'\r\nPS C:\\Windows\\System32> chef-client --version\r\nRedirecting to cinc-client\r\nCinc Client: 18.2.7\r\n```"],"labels":["Status: Untriaged"]},{"title":"rhsm_register fails when release is not set","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nrhsm_register fails when release is not set\r\n\r\n## Chef Version\r\nchef-18.0.169\r\n\r\n## Platform Version\r\nRHEL9\r\n\r\n## Replication Case\r\nCreate an activation key using RedHat EUS repos only\r\nDo not specify the release version in the key\r\nRegister using rhsm_register\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\nRecipe: COOKBOOKNAME::configure\r\n         * rhsm_register[name] action register[2022-11-10T20:43:32+00:00] INFO: Processing rhsm_register[name] action register (COOKBOOKNAME::configure line 139)\r\n       \r\n           * dnf_package[subscription-manager] action install[2022-11-10T20:43:32+00:00] INFO: Processing dnf_package[subscription-manager] action install (COOKBOOKNAME::configure line 99)\r\n        (up to date)\r\n           * dnf_package[rhsm_register-name-flush_cache] action nothing[2022-11-10T20:43:34+00:00] INFO: Processing dnf_package[rhsm_register-name-flush_cache] action nothing (COOKBOOKNAME::configure line 120)\r\n        (skipped due to action :nothing)\r\n           * execute[Register to RHSM] action run[2022-11-10T20:43:34+00:00] INFO: Processing execute[Register to RHSM] action run (COOKBOOKNAME::configure line 124)\r\n       \r\n             [execute] The system has been registered with ID: 11df3736-718b-4f35-b9de-b12f4bd24968\r\n                The registered system name is: kitchen-satellite-obm-rhel9.vagrantup.com\r\n                Installed Product Current Status:\r\n                Product Name: Red Hat Enterprise Linux for x86_64\r\n                Status:       Subscribed\r\n                \r\n       [2022-11-10T20:43:39+00:00] INFO: execute[Register to RHSM] ran successfully\r\n             - execute subscription-manager register --activationkey=ACTIVATION_KEY --org=ORGNAME\r\n       [2022-11-10T20:43:39+00:00] INFO: execute[Register to RHSM] sending flush_cache action to dnf_package[rhsm_register-name-flush_cache] (immediate)\r\n           * dnf_package[rhsm_register-name-flush_cache] action flush_cache[2022-11-10T20:43:39+00:00] INFO: Processing dnf_package[rhsm_register-name-flush_cache] action flush_cache (COOKBOOKNAME::configure line 120)\r\n        (up to date)\r\n           \r\n           ================================================================================\r\n           Error executing action `flush_cache` on resource 'dnf_package[rhsm_register-name-flush_cache]'\r\n           ================================================================================\r\n           \r\n           RuntimeError\r\n           ------------\r\n           dnf-helper.py had stderr\/stdout output:\r\n           \r\n           Errors during downloading metadata for repository 'codeready-builder-for-rhel-9-x86_64-eus-rpms':\r\n             - Status code: 404 for https:\/\/SATELLITENAME.DOMAIN.ORGNAME.com.au\/pulp\/content\/ORGNAME\/Production\/CV_NAME\/content\/eus\/rhel9\/9\/x86_64\/codeready-builder\/os\/repodata\/repomd.xml (IP: IPADDR)\r\n           Traceback (most recent call last):\r\n             File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/repo.py\", line 573, in load\r\n        ret = self._repo.load()\r\n             File \"\/usr\/lib64\/python3.9\/site-packages\/libdnf\/repo.py\", line 331, in load\r\n        return _repo.Repo_load(self)\r\n           libdnf._error.Error: Failed to download metadata for repo 'codeready-builder-for-rhel-9-x86_64-eus-rpms': Cannot download repomd.xml: Cannot download repodata\/repomd.xml: All mirrors were tried\r\n           \r\n           During handling of the above exception, another exception occurred:\r\n           \r\n           Traceback (most recent call last):\r\n             File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 182, in <module>\r\n        query(command)\r\n             File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 89, in query\r\n        sack = get_sack()\r\n             File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 44, in get_sack\r\n        base.fill_sack(load_system_repo='auto')\r\n             File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/base.py\", line 399, in fill_sack\r\n        self._add_repo_to_sack(r)\r\n             File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/base.py\", line 139, in _add_repo_to_sack\r\n        repo.load()\r\n             File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/repo.py\", line 580, in load\r\n        raise dnf.exceptions.RepoError(str(e))\r\n           dnf.exceptions.RepoError: Failed to download metadata for repo 'codeready-builder-for-rhel-9-x86_64-eus-rpms': Cannot download repomd.xml: Cannot download repodata\/repomd.xml: All mirrors were tried\r\n           \r\n           Resource Declaration:\r\n           ---------------------\r\n           # In \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/resource\/rhsm_register.rb\r\n           \r\n           120:         package flush_package_cache_name do\r\n           121:           action :nothing\r\n           122:         end\r\n           123: \r\n           \r\n           Compiled Resource:\r\n           ------------------\r\n           # Declared in \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/resource\/rhsm_register.rb:120:in `block in <class:RhsmRegister>'\r\n           \r\n           dnf_package(\"rhsm_register-name-flush_cache\") do\r\n             package_name \"rhsm_register-name-flush_cache\"\r\n             action [:nothing]\r\n             default_guard_interpreter :default\r\n             declared_type :package\r\n             cookbook_name \"COOKBOOKNAME\"\r\n             recipe_name \"configure\"\r\n             flush_cache {:before=>false, :after=>false}\r\n           end\r\n           \r\n           System Info:\r\n           ------------\r\n           chef_version=18.0.169\r\n           platform=redhat\r\n           platform_version=9.0\r\n           ruby=ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n           program_name=\/opt\/chef\/bin\/chef-client\r\n           executable=\/opt\/chef\/bin\/chef-client\r\n           \r\n       [2022-11-10T20:43:44+00:00] INFO: Retrying execution of rhsm_register[name], 0 attempt left\r\n         * dnf_package[subscription-manager] action install[2022-11-10T20:43:46+00:00] INFO: Processing dnf_package[subscription-manager] action install (COOKBOOKNAME::configure line 99)\r\n       \r\n           \r\n           ================================================================================\r\n           Error executing action `install` on resource 'dnf_package[subscription-manager]'\r\n           ================================================================================\r\n           \r\n           RuntimeError\r\n           ------------\r\n           dnf-helper.py had stderr\/stdout output:\r\n           \r\n           Errors during downloading metadata for repository 'codeready-builder-for-rhel-9-x86_64-eus-rpms':\r\n             - Status code: 404 for https:\/\/SATELLITENAME.DOMAIN.ORGNAME.com.au\/pulp\/content\/ORGNAME\/Production\/CV_NAME\/content\/eus\/rhel9\/9\/x86_64\/codeready-builder\/os\/repodata\/repomd.xml (IP: IPADDR)\r\n           Traceback (most recent call last):\r\n             File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/repo.py\", line 573, in load\r\n        ret = self._repo.load()\r\n             File \"\/usr\/lib64\/python3.9\/site-packages\/libdnf\/repo.py\", line 331, in load\r\n        return _repo.Repo_load(self)\r\n           libdnf._error.Error: Failed to download metadata for repo 'codeready-builder-for-rhel-9-x86_64-eus-rpms': Cannot download repomd.xml: Cannot download repodata\/repomd.xml: All mirrors were tried\r\n           \r\n           During handling of the above exception, another exception occurred:\r\n           \r\n           Traceback (most recent call last):\r\n             File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 182, in <module>\r\n        query(command)\r\n             File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 89, in query\r\n        sack = get_sack()\r\n             File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 44, in get_sack\r\n        base.fill_sack(load_system_repo='auto')\r\n             File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/base.py\", line 399, in fill_sack\r\n        self._add_repo_to_sack(r)\r\n             File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/base.py\", line 139, in _add_repo_to_sack\r\n        repo.load()\r\n             File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/repo.py\", line 580, in load\r\n        raise dnf.exceptions.RepoError(str(e))\r\n           dnf.exceptions.RepoError: Failed to download metadata for repo 'codeready-builder-for-rhel-9-x86_64-eus-rpms': Cannot download repomd.xml: Cannot download repodata\/repomd.xml: All mirrors were tried\r\n           \r\n           Resource Declaration:\r\n           ---------------------\r\n           # In \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/resource\/rhsm_register.rb\r\n           \r\n            99:         package \"subscription-manager\"\r\n           100: \r\n           \r\n           Compiled Resource:\r\n           ------------------\r\n           # Declared in \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/resource\/rhsm_register.rb:99:in `block in <class:RhsmRegister>'\r\n           \r\n           dnf_package(\"subscription-manager\") do\r\n             package_name \"subscription-manager\"\r\n             action [:install]\r\n             default_guard_interpreter :default\r\n             declared_type :package\r\n             cookbook_name \"COOKBOOKNAME\"\r\n             recipe_name \"configure\"\r\n             flush_cache {:before=>false, :after=>false}\r\n           end\r\n           \r\n           System Info:\r\n           ------------\r\n           chef_version=18.0.169\r\n           platform=redhat\r\n           platform_version=9.0\r\n           ruby=ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n           program_name=\/opt\/chef\/bin\/chef-client\r\n           executable=\/opt\/chef\/bin\/chef-client\r\n           \r\n         \r\n         ================================================================================\r\n         Error executing action `register` on resource 'rhsm_register[name]'\r\n         ================================================================================\r\n         \r\n         RuntimeError\r\n         ------------\r\n         dnf_package[subscription-manager] (COOKBOOKNAME::configure line 99) had an error: RuntimeError: dnf-helper.py had stderr\/stdout output:\r\n         \r\n         Errors during downloading metadata for repository 'codeready-builder-for-rhel-9-x86_64-eus-rpms':\r\n           - Status code: 404 for https:\/\/SATELLITENAME.DOMAIN.ORGNAME.com.au\/pulp\/content\/ORGNAME\/Production\/CV_NAME\/content\/eus\/rhel9\/9\/x86_64\/codeready-builder\/os\/repodata\/repomd.xml (IP: IPADDR)\r\n         Traceback (most recent call last):\r\n           File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/repo.py\", line 573, in load\r\n             ret = self._repo.load()\r\n           File \"\/usr\/lib64\/python3.9\/site-packages\/libdnf\/repo.py\", line 331, in load\r\n             return _repo.Repo_load(self)\r\n         libdnf._error.Error: Failed to download metadata for repo 'codeready-builder-for-rhel-9-x86_64-eus-rpms': Cannot download repomd.xml: Cannot download repodata\/repomd.xml: All mirrors were tried\r\n         \r\n         During handling of the above exception, another exception occurred:\r\n         \r\n         Traceback (most recent call last):\r\n           File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 182, in <module>\r\n             query(command)\r\n           File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 89, in query\r\n             sack = get_sack()\r\n           File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 44, in get_sack\r\n             base.fill_sack(load_system_repo='auto')\r\n           File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/base.py\", line 399, in fill_sack\r\n             self._add_repo_to_sack(r)\r\n           File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/base.py\", line 139, in _add_repo_to_sack\r\n             repo.load()\r\n           File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/repo.py\", line 580, in load\r\n             raise dnf.exceptions.RepoError(str(e))\r\n         dnf.exceptions.RepoError: Failed to download metadata for repo 'codeready-builder-for-rhel-9-x86_64-eus-rpms': Cannot download repomd.xml: Cannot download repodata\/repomd.xml: All mirrors were tried\r\n         \r\n         Resource Declaration:\r\n         ---------------------\r\n         # In \/tmp\/kitchen\/cache\/cookbooks\/COOKBOOKNAME\/recipes\/configure.rb\r\n         \r\n         139: rhsm_register 'name' do\r\n         140:   activation_key combined_key\r\n         141:   organization node[ATTR]['organization']\r\n         142:   install_katello_agent false\r\n         143:   retries node[ATTR]['retries']\r\n         144:   ignore_failure node[ATTR]['ignore_registration_failure'].to_s.downcase == 'true'\r\n         145:   action :register\r\n         146:   only_if { node['packages'].key?(required_package_name) }\r\n         147: end\r\n         148: \r\n         \r\n         Compiled Resource:\r\n         ------------------\r\n         # Declared in \/tmp\/kitchen\/cache\/cookbooks\/COOKBOOKNAME\/recipes\/configure.rb:139:in `from_file'\r\n         \r\n         rhsm_register(\"name\") do\r\n           action [:register]\r\n           updated true\r\n           updated_by_last_action true\r\n           default_guard_interpreter :default\r\n           declared_type :rhsm_register\r\n           cookbook_name \"COOKBOOKNAME\"\r\n           recipe_name \"configure\"\r\n           activation_key [\"ACTIVATION_KEY\"]\r\n           organization \"ORGNAME\"\r\n           retries 1\r\n           only_if { #code block }\r\n         end\r\n         \r\n         System Info:\r\n         ------------\r\n         chef_version=18.0.169\r\n         platform=redhat\r\n         platform_version=9.0\r\n         ruby=ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n         program_name=\/opt\/chef\/bin\/chef-client\r\n         executable=\/opt\/chef\/bin\/chef-client\r\n         \r\n       [2022-11-10T20:43:51+00:00] INFO: Running queued delayed notifications before re-raising exception\r\n       \r\n       Running handlers:\r\n       [2022-11-10T20:43:51+00:00] ERROR: Running exception handlers\r\n       Running handlers complete\r\n       [2022-11-10T20:43:51+00:00] ERROR: Exception handlers complete\r\n       Infra Phase failed. 1 resources updated in 21 seconds\r\n       [2022-11-10T20:43:51+00:00] FATAL: Stacktrace dumped to \/tmp\/kitchen\/cache\/chef-stacktrace.out\r\n       [2022-11-10T20:43:51+00:00] FATAL: ---------------------------------------------------------------------------------------\r\n       [2022-11-10T20:43:51+00:00] FATAL: PLEASE PROVIDE THE CONTENTS OF THE stacktrace.out FILE (above) IF YOU FILE A BUG REPORT\r\n       [2022-11-10T20:43:51+00:00] FATAL: ---------------------------------------------------------------------------------------\r\n       [2022-11-10T20:43:51+00:00] FATAL: RuntimeError: rhsm_register[name] (COOKBOOKNAME::configure line 139) had an error: RuntimeError: dnf_package[subscription-manager] (COOKBOOKNAME::configure line 99) had an error: RuntimeError: dnf-helper.py had stderr\/stdout output:\r\n       \r\n       Errors during downloading metadata for repository 'codeready-builder-for-rhel-9-x86_64-eus-rpms':\r\n         - Status code: 404 for https:\/\/SATELLITENAME.DOMAIN.ORGNAME.com.au\/pulp\/content\/ORGNAME\/Production\/CV_NAME\/content\/eus\/rhel9\/9\/x86_64\/codeready-builder\/os\/repodata\/repomd.xml (IP: IPADDR)\r\n       Traceback (most recent call last):\r\n         File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/repo.py\", line 573, in load\r\n           ret = self._repo.load()\r\n         File \"\/usr\/lib64\/python3.9\/site-packages\/libdnf\/repo.py\", line 331, in load\r\n           return _repo.Repo_load(self)\r\n       libdnf._error.Error: Failed to download metadata for repo 'codeready-builder-for-rhel-9-x86_64-eus-rpms': Cannot download repomd.xml: Cannot download repodata\/repomd.xml: All mirrors were tried\r\n       \r\n       During handling of the above exception, another exception occurred:\r\n       \r\n       Traceback (most recent call last):\r\n         File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 182, in <module>\r\n           query(command)\r\n         File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 89, in query\r\n           sack = get_sack()\r\n         File \"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.169\/lib\/chef\/provider\/package\/dnf\/dnf_helper.py\", line 44, in get_sack\r\n           base.fill_sack(load_system_repo='auto')\r\n         File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/base.py\", line 399, in fill_sack\r\n           self._add_repo_to_sack(r)\r\n         File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/base.py\", line 139, in _add_repo_to_sack\r\n           repo.load()\r\n         File \"\/usr\/lib\/python3.9\/site-packages\/dnf\/repo.py\", line 580, in load\r\n           raise dnf.exceptions.RepoError(str(e))\r\n       dnf.exceptions.RepoError: Failed to download metadata for repo 'codeready-builder-for-rhel-9-x86_64-eus-rpms': Cannot download repomd.xml: Cannot download repodata\/repomd.xml: All mirrors were tried\r\n       \r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":["https:\/\/github.com\/chef\/chef\/pull\/13352\r\n"],"labels":["Status: Untriaged"]},{"title":"Multiple IdentityFile ssh\/config not use","body":"## Description\r\n\r\nWe need to use ssh access via CA-signed keys.\r\n\r\nConfiguring the ``` .ssh \/ config``` file by inserting two IdentityFiles as below:\r\n\r\n```\r\nHost name_host.com\r\n    User ec2-user\r\n    IdentityFile \/home\/chefw\/.ssh\/id_rsa_ec2-user\r\n    IdentityFile \/home\/chefw\/.ssh\/id_rsa_ec2-user.signed.pub\r\n```\r\n\r\nconnecting via ssh client works fine, while using ```chef-run``` doesn't work.\r\n\r\n## Chef Version\r\n```\r\nChef Workstation version: 0.18.3\r\nChef Infra Client version: 15.10.12\r\nChef InSpec version: 4.18.111\r\nChef CLI version: 2.0.10\r\nTest Kitchen version: 2.5.0\r\nCookstyle version: 6.3.4\r\n```\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\n## Client Output\r\n\r\n```\r\nchef-run   name_host.com chef-run\/path\/\r\n[\u2714] Packaging cookbook... done!\r\n[\u2714] Generating local policyfile... exporting... done!\r\n[\u2716] Applying ns6060::default from \/home\/chefw\/chef-run\/path\/ to target.\r\n\u2514\u2500\u2500 [\u2716] [name_host.com] No authentication methods available.\r\n\r\nNo authentication methods available.\r\n\r\nTry...\r\n- Provide a password with \"--password PASSWORD\"\r\n- Provide a key with \"-identity-file PATH\/TO\/FILE\"\r\n- Enable ssh-agent and add keys\r\n- Add a host entry to your ssh configuration\r\n\r\nAdditional instructions can be found in the troubleshooting documentation:\r\n\r\nhttps:\/\/www.chef.sh\/docs\/chef-workstation\/troubleshooting\/#error-code-cheftrn007\r\n```\r\n\r\n```\r\nchef-run --identity-file=\"\/home\/chefw\/.ssh\/id_rsa_ec2-user\" --identity-file=\"\/home\/chefw\/.ssh\/id_rsa_ec2-user.signed.pub\" name_host.com chef-run\/path\/\r\n[\u2714] Packaging cookbook... done!\r\n[\u2714] Generating local policyfile... exporting... done!\r\n[\u2716] Applying ns6060::default from \/home\/chefw\/chef-run\/path\/ to target.\r\n\u2514\u2500\u2500 [\u2716] [name_host.com] Connection failed: Authentication failed for user ec2-user@name_host.com\r\n\r\nConnection failed: Authentication failed for user ec2-user@name_host.com\r\n\r\nThe following error occured while attempting to connect and authenticate to the target.\r\n\r\nAuthentication failed for user ec2-user@name_host.com\r\n```\r\n\r\n\r\n## Stacktrace\r\n\r\n```\r\n2022-11-03 14:36:06 +0100: Error encountered while running the following:\r\n  name_host.com  \/home\/chefw\/chef-run\/path\/\r\nBacktrace:\r\nChefApply::TargetHost::ConnectionFailure: ChefApply::TargetHost::ConnectionFailure\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/target_host.rb:131:in `rescue in connect!'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/target_host.rb:114:in `connect!'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/cli.rb:332:in `do_connect'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/cli.rb:178:in `connect_target'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/cli.rb:163:in `block (2 levels) in render_converge'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/ui\/terminal\/job.rb:31:in `run'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/ui\/terminal.rb:60:in `block (2 levels) in render_parallel_jobs'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/tty-spinner-0.9.3\/lib\/tty\/spinner.rb:225:in `execute_job'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/tty-spinner-0.9.3\/lib\/tty\/spinner\/multi.rb:150:in `block (2 levels) in auto_spin'\r\nCaused by: Train::ClientError: Your SSH Agent has no keys added, and you have not specified a password or a key file\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh.rb:106:in `validate_options'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh.rb:76:in `connection'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/target_host.rb:118:in `connect!'\r\n\t... 7 more\r\n\r\n--------------------------------------------------------------------------------\r\n2022-11-03 14:38:03 +0100: Error encountered while running the following:\r\n  --identity-file=\/home\/chefw\/.ssh\/id_rsa_ec2-user --identity-file=\/home\/chefw\/.ssh\/id_rsa_ec2-user.signed.pub name_host.com  \/home\/chefw\/chef-run\/path\/\r\nBacktrace:\r\nChefApply::TargetHost::ConnectionFailure: ChefApply::TargetHost::ConnectionFailure\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/target_host.rb:131:in `rescue in connect!'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/target_host.rb:114:in `connect!'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/cli.rb:332:in `do_connect'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/cli.rb:178:in `connect_target'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/cli.rb:163:in `block (2 levels) in render_converge'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/ui\/terminal\/job.rb:31:in `run'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/ui\/terminal.rb:60:in `block (2 levels) in render_parallel_jobs'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/tty-spinner-0.9.3\/lib\/tty\/spinner.rb:225:in `execute_job'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/tty-spinner-0.9.3\/lib\/tty\/spinner\/multi.rb:150:in `block (2 levels) in auto_spin'\r\nCaused by: Train::Transports::SSHFailed: SSH session could not be established\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh_connection.rb:209:in `rescue in establish_connection'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh_connection.rb:198:in `establish_connection'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh_connection.rb:274:in `session'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh_connection.rb:242:in `run_command_via_connection'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/plugins\/base_connection.rb:136:in `run_command'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect\/helpers\/os_windows.rb:9:in `check_cmd'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect\/helpers\/os_windows.rb:4:in `detect_windows'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect\/specifications\/os.rb:20:in `block in load_windows'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect\/scanner.rb:46:in `instance_eval'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect\/scanner.rb:46:in `block in scan_children'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect\/scanner.rb:45:in `each'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect\/scanner.rb:45:in `scan_children'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect\/scanner.rb:33:in `block in scan'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect\/scanner.rb:27:in `each'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect\/scanner.rb:27:in `scan'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/platforms\/detect.rb:9:in `scan'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/plugins\/base_connection.rb:124:in `platform'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/extras\/command_wrapper.rb:188:in `load'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh_connection.rb:57:in `initialize'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh.rb:240:in `new'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh.rb:240:in `create_new_connection'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh.rb:82:in `connection'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-apply-0.4.16\/lib\/chef_apply\/target_host.rb:118:in `connect!'\r\n\t... 7 more\r\nCaused by: Net::SSH::AuthenticationFailed: Authentication failed for user ec2-user@name_host.com\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/net-ssh-5.2.0\/lib\/net\/ssh.rb:263:in `start'\r\n\t\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/train-core-3.2.28\/lib\/train\/transports\/ssh_connection.rb:205:in `establish_connection'\r\n\t... 28 more\r\n```\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Chef 18 & Data Collector URL","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nChef 18 is having an issue reporting back to Automate when a data_collector is configured.  Same config works fine with latest stable 17.\r\n\r\n## Chef Version\r\nChef 18.0.169\r\nAutomate Build 20220121191356\r\n\r\n## Platform Version\r\nWindows Server 2022\r\n\r\n## Replication Case\r\nRunning chef in standalone mode (-z) with a data_collector configured.\r\n\r\nhttps:\/\/docs.chef.io\/automate\/data_collection\/#configure-chef-infra-client-to-use-the-data-collector-endpoint-in-chef-automate\r\n\r\n```\r\ndata_collector.server_url 'https:\/\/automate.my.org\/data-collector\/v0\/'\r\ndata_collector.token 'ABC123'\r\ndata_collector.organization 'my-org-solo'\r\ndata_collector.raise_on_failure true\r\n```\r\n\r\n## Client Output\r\n`ERROR: Error while reporting run start back to Data Collector. URL: https:\/\/automate.my.org\/data-collector\/v0\/`\r\n\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"GitHub Actions Kitchen tests show success when end_to_end cookbook fails","body":"## Description\r\n\r\nThere's a problem with the [GitHub Actions triggered Chef Kitchen tests](https:\/\/github.com\/chef\/chef\/blob\/2775983b7003933dd3e952680f0ef836e65e30d4\/.github\/workflows\/kitchen.yml) that results in failures in the end-to-end cookbook returning a zero exit code which indicates to [GitHub Actions that the step was a `success`](https:\/\/docs.github.com\/en\/actions\/creating-actions\/setting-exit-codes-for-actions) when it should be a `failure`.\r\n\r\nUsing the Linux tests as an example, GitHub Actions initiates a Chef Kitchen run [in the `.github\/workflows\/kitchen.yml`](https:\/\/github.com\/chef\/chef\/blob\/2775983b7003933dd3e952680f0ef836e65e30d4\/.github\/workflows\/kitchen.yml#L215-L226) file.\r\n\r\nThis runs Kitchen, for example with Ubuntu 20.04, using the command\r\n\r\n```\r\nbundle exec kitchen test end-to-end-ubuntu-2004\r\n```\r\n\r\nThis caues a [`kitchen test`](https:\/\/docs.chef.io\/workstation\/ctl_kitchen\/#kitchen-test) run.\r\n\r\nThis run does some setup and [then runs the `end_to_end` cookbook](https:\/\/github.com\/chef\/chef\/blob\/2775983b7003933dd3e952680f0ef836e65e30d4\/kitchen-tests\/kitchen.yml#L168-L171)\r\n\r\nI'm not a kitchen expert, but I believe the issue is that regardless of what happens in the chef run of the `end_to_end` cookbook, whether chef returns a zero or non-zero exit code, kitchen then continues to perform the `Verifying` step of the run by running the [tests in `kitchen-tests\/test\/integration\/end-to-end\/`](https:\/\/github.com\/chef\/chef\/tree\/main\/kitchen-tests\/test\/integration\/end-to-end).\r\n\r\nThese tests check only the content of `client.rb` and the an OpenSSL cert in a quick 3 second test.\r\n\r\nThe final output from the Kitchen run is then based on only the result of the tests around `client.rb` and OpenSSL and ignore the result of executing the giant collection of unit tests in the `end_to_end` cookbook.\r\n\r\nI believe this is why the unit tests in the `end_to_end` cookbook can show problems, but GitHub Actions shows the kitchen run as green.\r\n\r\nThe thing I don't understand is that [the Kitchen docs about `kitchen test`](https:\/\/kitchen.ci\/docs\/getting-started\/running-test\/) say\r\n\r\n> Test Kitchen will abort the run on the instance at the first sign of trouble. This means that if your Chef Infra Client run fails then Chef InSpec won\u2019t be run and the instance won\u2019t be destroyed. This gives you a chance to inspect the state of the instance and fix any issues.\r\n\r\nThis implies that a failed Chef Infra Client run really shouldn't return a zero exit code. I'm missing something.\r\n\r\n## Example\r\n\r\nHere's an example of a GitHub Actions triggered kitchen test for a PR that shows the `end_to_end` cookbook throwing an exception, but the Kitchen verification tests succeeding which results in GitHub Actions thinking the whole kitchen test was a success. I've snipped out some lines of the stack traces for brevity.\r\n\r\n```\r\n2022-11-01T20:47:22.9974348Z        Running handlers:\r\n2022-11-01T20:47:22.9977531Z        [2022-11-01T13:47:22-07:00] ERROR: Running exception handlers\r\n2022-11-01T20:47:22.9980664Z        Running handlers complete\r\n2022-11-01T20:47:22.9984718Z        [2022-11-01T13:47:22-07:00] ERROR: Exception handlers complete\r\n2022-11-01T20:47:22.9988162Z        Infra Phase failed. 295 resources updated in 05 minutes 18 seconds\r\n2022-11-01T20:47:22.9992367Z        [2022-11-01T13:47:22-07:00] FATAL: Stacktrace dumped to \/opt\/kitchen\/cache\/chef-stacktrace.out\r\n2022-11-01T20:47:22.9996064Z        [2022-11-01T13:47:22-07:00] FATAL: ---------------------------------------------------------------------------------------\r\n2022-11-01T20:47:23.0000341Z        [2022-11-01T13:47:22-07:00] FATAL: PLEASE PROVIDE THE CONTENTS OF THE stacktrace.out FILE (above) IF YOU FILE A BUG REPORT\r\n2022-11-01T20:47:23.0004438Z        [2022-11-01T13:47:22-07:00] FATAL: ---------------------------------------------------------------------------------------\r\n2022-11-01T20:47:23.0035876Z        [2022-11-01T13:47:22-07:00] FATAL: Chef::Exceptions::Package: snap_package[hello, black] (end_to_end::_snap line 39) had an error: Chef::Exceptions::Package: No version of black in channel stable\r\n2022-11-01T20:47:23.0041709Z        \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.172\/lib\/chef\/provider\/package\/snap.rb:100:in `available_version'\r\n...SNIP...\r\n2022-11-01T20:47:23.0245899Z        \/opt\/chef\/bin\/chef-client:188:in `<main>'\r\n2022-11-01T20:47:23.0277004Z        \r\n2022-11-01T20:47:23.0277371Z        >>>> Caused by Chef::Exceptions::Package: No version of black in channel stable\r\n2022-11-01T20:47:23.0278018Z        \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.172\/lib\/chef\/provider\/package\/snap.rb:100:in `available_version'\r\n...SNIP...\r\n2022-11-01T20:47:23.0314703Z        \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-bin-18.0.172\/bin\/chef-client:25:in `<top (required)>'\r\n2022-11-01T20:47:23.0315116Z        \/opt\/chef\/bin\/chef-client:188:in `load'\r\n2022-11-01T20:47:23.0315446Z        \/opt\/chef\/bin\/chef-client:188:in `<main>'\r\n2022-11-01T20:47:23.0316212Z        [2022-11-01T13:47:22-07:00] FATAL: Chef::Exceptions::Package: snap_package[hello, black] (end_to_end::_snap line 39) had an error: Chef::Exceptions::Package: No version of black in channel stable\r\n2022-11-01T20:47:23.0316884Z        \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.1.0\/gems\/chef-18.0.172\/lib\/chef\/provider\/package\/snap.rb:100:in `available_version'\r\n...SNIP...\r\n2022-11-01T20:47:23.0353513Z        \/opt\/chef\/bin\/chef-client:188:in `<main>'\r\n2022-11-01T20:47:23.0374097Z        Finished converging <end-to-end-ubuntu-2004> (5m27.96s).\r\n2022-11-01T20:47:23.0374734Z -----> Setting up <end-to-end-ubuntu-2004>...\r\n2022-11-01T20:47:23.0461407Z        Finished setting up <end-to-end-ubuntu-2004> (0m0.00s).\r\n2022-11-01T20:47:23.0461855Z -----> Verifying <end-to-end-ubuntu-2004>...\r\n2022-11-01T20:47:26.0240483Z        Loaded tests from {:path=>\".home.runner.work.chef.chef.kitchen-tests.test.integration.end-to-end\"} \r\n2022-11-01T20:47:26.4570110Z \r\n2022-11-01T20:47:26.4571319Z Profile:   tests from {:path=>\"\/home\/runner\/work\/chef\/chef\/kitchen-tests\/test\/integration\/end-to-end\"} (tests from {:path=>\".home.runner.work.chef.chef.kitchen-tests.test.integration.end-to-end\"})\r\n2022-11-01T20:47:26.4571863Z Version:   (not specified)\r\n2022-11-01T20:47:26.4572211Z Target:    docker:\/\/839780b2b0602d64ca3d3209887a9c2853c5aeaa15a4493903fd4e22984a066b\r\n2022-11-01T20:47:26.4572656Z Target ID: 1ac1304b-f6dc-5b0b-b192-311e18f53536\r\n2022-11-01T20:47:26.4572822Z \r\n2022-11-01T20:47:26.4572914Z   File \/etc\/chef\/client.rb\r\n2022-11-01T20:47:26.4573481Z      \u2714  content is expected to match \/chef_server_url \"https:\\\/\\\/localhost\"\/\r\n2022-11-01T20:47:26.4574248Z      \u2714  content is expected to match \/chef_license \"accept\"\/\r\n2022-11-01T20:47:26.4574696Z      \u2714  content is expected to match \/rubygems_url \"https:\\\/\\\/rubygems.org\\\/\"\/\r\n2022-11-01T20:47:26.4575381Z      \u2714  content is expected to match \/require 'aws-sdk'\/\r\n2022-11-01T20:47:26.4576254Z   Command: `\/opt\/chef\/embedded\/bin\/openssl verify -CAfile \/etc\/ssl_test\/my_ca.crt \/etc\/ssl_test\/my_signed_cert.crt`\r\n2022-11-01T20:47:26.4576917Z      \u2714  stdout is expected to match \/my_signed_cert.*OK\/\r\n2022-11-01T20:47:26.4577388Z      \u2714  stderr is expected to be empty\r\n2022-11-01T20:47:26.4577635Z \r\n2022-11-01T20:47:26.4578090Z Test Summary: 6 successful, 0 failures, 0 skipped\r\n2022-11-01T20:47:26.4635871Z        Finished verifying <end-to-end-ubuntu-2004> (0m3.41s).\r\n2022-11-01T20:47:26.4677763Z -----> Destroying <end-to-end-ubuntu-2004>...\r\n2022-11-01T20:47:38.2874775Z        Deleting kitchen sandbox at \/home\/runner\/.dokken\/kitchen_sandbox\/65f10697dd-end-to-end-ubuntu-2004\r\n2022-11-01T20:47:38.3107517Z        Deleting verifier sandbox at \/home\/runner\/.dokken\/verifier_sandbox\/65f10697dd-end-to-end-ubuntu-2004\r\n2022-11-01T20:47:38.3163476Z        Finished destroying <end-to-end-ubuntu-2004> (0m11.84s).\r\n2022-11-01T20:47:38.3167161Z        Finished testing <end-to-end-ubuntu-2004> (7m43.75s).\r\n2022-11-01T20:47:38.3171406Z -----> Test Kitchen is finished. (7m45.29s)\r\n2022-11-01T20:47:38.3758783Z Post job cleanup.\r\n2022-11-01T20:47:38.5199195Z [command]\/usr\/bin\/git version\r\n2022-11-01T20:47:38.5247516Z git version 2.38.1\r\n2022-11-01T20:47:38.5312172Z Temporarily overriding HOME='\/home\/runner\/work\/_temp\/15daa5ee-470c-4ba6-abf9-fa7be7493e2e' before making global git config changes\r\n2022-11-01T20:47:38.5312937Z Adding repository directory to the temporary git global config as a safe directory\r\n2022-11-01T20:47:38.5318978Z [command]\/usr\/bin\/git config --global --add safe.directory \/home\/runner\/work\/chef\/chef\r\n2022-11-01T20:47:38.5368327Z [command]\/usr\/bin\/git config --local --name-only --get-regexp core\\.sshCommand\r\n2022-11-01T20:47:38.5409973Z [command]\/usr\/bin\/git submodule foreach --recursive git config --local --name-only --get-regexp 'core\\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :\r\n2022-11-01T20:47:38.5724844Z [command]\/usr\/bin\/git config --local --name-only --get-regexp http\\.https\\:\\\/\\\/github\\.com\\\/\\.extraheader\r\n2022-11-01T20:47:38.5753720Z http.https:\/\/github.com\/.extraheader\r\n2022-11-01T20:47:38.5777581Z [command]\/usr\/bin\/git config --local --unset-all http.https:\/\/github.com\/.extraheader\r\n2022-11-01T20:47:38.5823466Z [command]\/usr\/bin\/git submodule foreach --recursive git config --local --name-only --get-regexp 'http\\.https\\:\\\/\\\/github\\.com\\\/\\.extraheader' && git config --local --unset-all 'http.https:\/\/github.com\/.extraheader' || :\r\n2022-11-01T20:47:38.6457191Z Cleaning up orphan processes\r\n```\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"chef-config and chef-utils gems are not synchronized","body":"The latest version of `chef-config` for the 17 release train is `17.10.26` https:\/\/rubygems.org\/gems\/chef-config\/versions\/17.10.26\r\n\r\nchef-config depends on `chef-utils=17.10.26`. But looking at the list of released versions here https:\/\/rubygems.org\/gems\/chef-utils I do not see `17.10.26` there, only `17.10.25`.\r\n\r\nPlease keep `chef-utils` in sync with the rest of the packages and release `chef-utils=17.10.26`.","comments":["Is there any reason this issue is still not fixed?"],"labels":["Status: Untriaged"]},{"title":"Version 17.10.26 not avilable in Rubygems","body":"## Description\r\n\r\nIt seems the version 17.10.26, which was cut in https:\/\/github.com\/chef\/chef\/commit\/c2c4e6e526655f278a48d6db5015bb2a7fd4609d has not been pushed to Rubygems (or was pushed and pulled, but Rubygems still has it on cache). This gets resolved as the latest version in `17.10.x` series, but the version itself can't be found on Rubygems. This causes issues like https:\/\/github.com\/chef\/ohai\/issues\/1771.","comments":[],"labels":["Status: Untriaged"]},{"title":"ohai not updated on package removal","body":"## Description\r\nOhai is not updated on package removal and ohai reload doesn't remove the package definition.\r\n\r\n\r\n## Chef Version\r\nChef Infra Client: 17.10.3\r\n\r\n## Platform Version\r\nRed Hat Enterprise Linux release 9.0 (Plow)\r\n\r\nNote: Observed also on RHEL7\r\n\r\n## Replication Case\r\n1. Create a recipe like this one:\r\n```\r\npackage 'tree' do\r\n  package_name 'tree'\r\nend\r\n\r\nfile '\/tmp\/print_attribute' do\r\n  content \"#{node['packages']['tree']}\"\r\nend\r\n\r\nohai 'packages' do\r\n  action :reload\r\nend\r\n\r\nfile '\/tmp\/print_attribute_after_install_and_reload' do\r\n  content \"#{node['packages']['tree']}\"\r\nend\r\n\r\npackage 'tree' do\r\n  package_name 'tree'\r\n  action :remove\r\nend\r\n\r\nohai 'packages' do\r\n  action :reload\r\nend\r\n\r\nfile '\/tmp\/print_attribute_after_remove_and_reload' do\r\n  content \"#{node['packages']['tree']}\"\r\nend\r\n```\r\n\r\n2. Execute\r\n\r\n## Expected output:\r\n\/tmp\/print_attribute -> empty as we don't have the rpm\r\n\/tmp\/print_attribute_after_install_and_reload -> details of the package as ohai sees it\r\n\/tmp\/print_attribute_after_remove_and_reload -> empty as we removed the package and reloaded ohai\r\n\r\n\r\n## Stacktrace\r\nNo stacktraces - the code works quite fine, yet ohai has stale data.","comments":[],"labels":["Status: Needs JIRA"]},{"title":"Switch cookbook checksums from MD5 to SHA256","body":"### When a Change Needs a Design Proposal\r\n\r\nA design proposal should be opened any time a change meets one of the following qualifications:\r\n\r\n- Significantly changes the user experience of a project in a way that impacts users.\r\n- Significantly changes the underlying architecture of the project in a way that impacts other developers.\r\n- Changes the development or testing process of the project such as a change of CI systems or test frameworks.\r\n\r\n### Why We Use This Process\r\n\r\n- Allows all interested parties (including any community member) to discuss large impact changes to a project.\r\n- Serves as a durable paper trail for discussions regarding project architecture.\r\n- Forces design discussions to occur before PRs are created.\r\n- Reduces PR refactoring and rejected PRs.\r\n\r\n---\r\n\r\n## Motivation\r\n\r\n\r\nOn FIPS systems, Ruby may be compiled with the OpenSSL MD5 implementation, which disables MD5 outright. As stated in https:\/\/github.com\/chef\/chef\/pull\/13186#issuecomment-1252799655:\r\n\r\n> Specifically, these checksums are used to compare to the checksums sent by the server to determine new items to download. And since different versions of servers and clients will talk to each other for years, this would need to be backwards compatible and forwards compatible between this and the server, as well as other clients like chef-zero.\r\n\r\n> So it would have to go something like:\r\n\r\n>    server and client agree on algo, with fallback for either side not knowing about such a negotiation\r\n>    server sends the appropriate sums, client knows how to use them\r\n\r\n> Likely both sides would want to keep both sums, always, for easy comparison.\r\n## Specification\r\n\r\n<!---  A detailed description of the planned implementation. -->\r\n\r\n## Downstream Impact\r\n\r\n<!---  Which other tools will be impacted by this work?  -->\r\n","comments":["Checksums have been changed to use `::Digest::MD5` as of https:\/\/github.com\/chef\/chef\/pull\/10058\/files \r\n\r\nAre there additional reasons for wanting to move cookbook checksums to SHA256 beyond the FIPS\/OpenSSL breakage of `OpenSSL::Digest.new(\"MD5\")`?"],"labels":["Status: Waiting on Contributor"]},{"title":"apt-key is deprecated since Ubuntu 22.04 and Debian 11","body":"Use of ``apt-key`` is deprecated, the man pages[0] mention it will last be available in Debian 11 and Ubuntu 22.04\r\nImplementation[1] of the ``key`` property in ``apt_repository`` resource will break by a future release of these OSes due to this deprecation.\r\n\r\n[0] https:\/\/manpages.ubuntu.com\/manpages\/jammy\/man8\/apt-key.8.html\r\n[1] https:\/\/github.com\/chef\/chef\/blob\/af2813a5fe1ce014967ad7833075ac5bf831b8d4\/lib\/chef\/resource\/apt_repository.rb#L268\r\n","comments":["+1\r\n\r\nAny update on this issue?","Using the current chef `apt_repository` resource (which uses `apt-key`) will cause these types of deprecation notices in Ubuntu 22.04 when running `apt update` because it's storing keys in `trusted.gpg`\r\n\r\n> `W: http:\/\/download.virtualbox.org\/virtualbox\/debian\/dists\/jammy\/InRelease: Key is stored in legacy trusted.gpg keyring (\/etc\/apt\/trusted.gpg), see the DEPRECATION section in apt-key(8) for details.`","Anyone had a chance yet to test this on Bookworm?","@TimRots, yes, I just found this issue because I was getting the same warning after upgrading to Bookworm.","> @TimRots, yes, I just found this issue because I was getting the same warning after upgrading to Bookworm.\r\n\r\nThank you for reaching out @haimgel, appreciated.\r\n\r\n@tpowell-progress Is help needed with this issue?"],"labels":["Status: Needs JIRA"]},{"title":"ignore_failure is not working on kernel_module resource","body":"## Description\r\nWhen running dokken tests the ignore_failure is not set on `execute[update initramfs]`\r\n\r\nMy workaround was to edit the resource:\r\n\r\n```\r\n    if ENV['TEST_KITCHEN']\r\n      edit_resource(:execute, 'update initramfs') do\r\n        ignore_failure true\r\n      end\r\n    end\r\n```\r\n\r\n## Chef Version\r\n```\r\nChef Workstation version: 22.1.778\r\nChef Infra Client version: 17.9.26\r\nChef InSpec version: 4.52.9\r\nChef CLI version: 5.5.6\r\nChef Habitat version: 1.6.420\r\nTest Kitchen version: 3.2.2\r\nCookstyle version: 7.31.1\r\n```\r\n\r\n## Platform Version\r\nCentOS 7\r\n\r\n## Client Output\r\n```\r\n           * kernel_module[sctp] action enable\r\n             * file[\/etc\/modprobe.d\/disable_sctp.conf] action delete\r\n        - delete file \/etc\/modprobe.d\/disable_sctp.conf\r\n\r\n         * execute[update initramfs] action run\r\n\r\n           ================================================================================\r\n           Error executing action `run` on resource 'execute[update initramfs]'\r\n           ================================================================================\r\n\r\n           Mixlib::ShellOut::ShellCommandFailed\r\n           ------------------------------------\r\n           Expected process to exit with [0], but received '1'\r\n           ---- Begin output of dracut -f ----\r\n           STDOUT:\r\n           STDERR: Kernel version 3.10.0-1062.1.2.el7.x86_64 has no module directory \/lib\/modules\/3.10.0-1062.1.2.el7.x86_64\r\n           Can't write to \/boot: Directory \/boot does not exist or is not accessible.\r\n           ---- End output of dracut -f ----\r\n           Ran dracut -f returned 1\r\n\r\n           Resource Declaration:\r\n           ---------------------\r\n           # In \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/dsl\/declare_resource.rb\r\n\r\n           233:           declare_resource(type, name, created_at: created_at, run_context: run_context, &resource_attrs_block)\r\n           234:         end # returns nil otherwise\r\n\r\n           Compiled Resource:\r\n           ------------------\r\n           # Declared in \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.10.3\/lib\/chef\/dsl\/declare_resource.rb:233:in `rescue in find_resource'\r\n\r\n           execute(\"update initramfs\") do\r\n             action [:nothing]\r\n             default_guard_interpreter :execute\r\n             command \"dracut -f\"\r\n             declared_type :execute\r\n             cookbook_name \"kernel_security\"\r\n             recipe_name \"setup\"\r\n             domain nil\r\n             user nil\r\n           end\r\n\r\n           System Info:\r\n           ------------\r\n           chef_version=17.10.3\r\n           platform=centos\r\n           platform_version=7.9.2009\r\n           ruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x86_64-linux]\r\n           program_name=\/opt\/chef\/bin\/chef-client\r\n           executable=\/opt\/chef\/bin\/chef-client\r\n```","comments":["@nicutor Can you share with us the execute code block that actually has the \"ignore_failure\" property in it? The default for that property is false. Were you expecting it to automatically ignore the error? Can you elaborate?"],"labels":["Status: Waiting on Contributor"]},{"title":"17.10.3 and LetsEncrypt issues","body":"## Description\r\nBootstrapping nodes with 17.10.3 is once again having issues with the DST Root CA X3 root certificate.  New clients must have the cert ripped out of the following files before they can connect to a server using an updated LetsEncrypt cert:\r\n\r\n- C:\\opscode\\chef\\embedded\\ssl\\cert.pem\r\n- C:\\opscode\\chef\\embedded\\ssl\\certs\\cacert.pem\r\n\r\n## Chef Version\r\nChef-Client 17.10.3\r\n\r\n## Platform Version\r\nTested on Windows\r\n\r\n## Client Output\r\nUnexpected Error:\r\n     -----------------\r\n     OpenSSL::SSL::SSLError: SSL Error connecting to https:\/\/redacted - SSL_connect returned=1 errno=0 state=error: certificate verify failed (unable to get issuer certificate)\r\n\r\n     System Info:\r\n     ------------\r\n     chef_version=17.10.3\r\n     ruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x64-mingw32]\r\n     program_name=C:\/opscode\/chef\/bin\/chef-client\r\n     executable=C:\/opscode\/chef\/bin\/chef-client\r\n","comments":["@mgwall1 can you confirm the edit that you're making on the `*cert.pem` files? Is this the ISRG Root X1 certificate section that you're having to remove?\r\n\r\nAlso, if you can provide detailed steps for reproduction including the important server and bootstrap configs, that will help us validate any fix we apply."],"labels":["Status: Waiting on Contributor","Status: Untriaged"]},{"title":"chef_vault_item does not work in test kitchen.","body":"Internal issue [https:\/\/chefio.atlassian.net\/browse\/CHEF-1254](https:\/\/chefio.atlassian.net\/browse\/CHEF-1254)\r\n\r\n## Description\r\nWhen chef_vault_item was moved into chef client in https:\/\/github.com\/chef\/chef\/issues\/9369 the node attributes [chef-vault and databag_fallback ](https:\/\/github.com\/chef\/chef\/blob\/61a11902ab814aad3625eb4da7e3345d63ee7c09\/lib\/chef\/dsl\/chef_vault.rb#L42) were never set. Any call to chef_vault_item in test kitchen will result in `undefined method '[]' for nil:NilClass` for [node[\"chef-vault\"][\"databag_fallback\"]](https:\/\/github.com\/chef\/chef\/blob\/61a11902ab814aad3625eb4da7e3345d63ee7c09\/lib\/chef\/dsl\/chef_vault.rb#L42).\r\n\r\n## Chef Version\r\nChef client 16.x-17.x\r\n\r\n## Platform Version\r\n* All\r\n### tested on:\r\n* rhel8\r\n* win2019\r\n\r\n## Replication Case\r\n\r\nrecipe\r\n```\r\nvalue = chef_vault_item('test', 'test')['key']\r\nlog \"key has value: #{value}\"\r\n```\r\n\r\ntest data_bag\r\n```\r\n{\r\n  \"id\": \"test\",\r\n  \"key\": \"value\"\r\n}\r\n```\r\n\r\n## Workaround\r\n\r\nAdding the following to the kitchen.yml suite fixes this issue:\r\n\r\n```\r\n  attributes:\r\n     # workaround for chef_vault_item in test kitchen\r\n    chef-vault:\r\n      databag_fallback: true\r\n```\r\n\r\n## Client Output\r\n\r\n```       \r\n       ================================================================================\r\n       Recipe Compile Error in \/tmp\/kitchen\/cache\/cookbooks\/vault_testing\/recipes\/default.rb\r\n       ================================================================================\r\n       \r\n       NoMethodError\r\n       -------------\r\n       undefined method `[]' for nil:NilClass\r\n       \r\n       Cookbook Trace: (most recent call first)\r\n       \/tmp\/kitchen\/cache\/cookbooks\/vault_testing\/recipes\/default.rb:\r\n\r\n         1:  #\r\n         2:  # Cookbook:: vault_testing\r\n         3:  # Recipe:: default\r\n         4:  #\r\n         5:  # \r\n         6:\r\n         7>> value = chef_vault_item('test', 'test')['key']\r\n         8:  log \"key has value: #{value}\"\r\n         9:\r\n\r\n       System Info:\r\n       ------------\r\n       chef_version=17.10.3\r\n       platform=redhat\r\n       platform_version=8.6\r\n       ruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x86_64-linux]\r\n       program_name=\/opt\/chef\/bin\/chef-client\r\n       executable=\/opt\/chef\/bin\/chef-client\r\n```","comments":["Seeing that @clintoncwolfe is assigned to the internal issue."],"labels":["Type: Bug","Status: Good First Issue"]},{"title":"windows_defender Realtime Protection setting changes the Tamper Protection setting instead of Real Time Monitoring","body":"## Userstory\r\n\r\nAs a user of Chef and the Defender resource, the item that this resource changes should be `DisableRealtimeMonitoring` and not `DisableIOAVProtection` so that my cookbook can turn off Realtime Monitoring. \r\n\r\n## More Details and some opinionate input\r\n\r\nWhat I am trying to do is disable the Defender Realtime Monitoring wrapped around an install that is quite intensive. The command in Powershell to do this is `Set-MpPreference -DisableRealtimeMonitoring 1` \r\n\r\nI think some of this is a word mapping issue. As we call it in our resource `realtime_protection` and as it is called in Windows, either `DisableRealtimeMonitoring` or `DisableIOAVProtection` . The former will stop Defender (Microsoft Security) from realtime scanning of the happening on the OS. The latter changes the [Tamper Protection](https:\/\/support.microsoft.com\/en-us\/windows\/prevent-changes-to-security-settings-with-tamper-protection-31d51aaa-645d-408e-6ce7-8d7f8e593f87) settings. \r\n\r\nBecause `realtime_protection` has been a thing already, I'm not sure that we can actually change what it actually does so maybe I'd propose adding a new function of the resource called `realtime_monitoring` and align that with `DisableRealtimeMonitoring`. \r\n\r\n## Line Reference\r\nhttps:\/\/github.com\/chef\/chef\/blob\/eca272d679b7cd0c5b155c641945e1c852776e28\/lib\/chef\/resource\/windows_defender.rb#L102\r\nhttps:\/\/github.com\/chef\/chef\/blob\/eca272d679b7cd0c5b155c641945e1c852776e28\/lib\/chef\/resource\/windows_defender.rb#L136\r\n\r\nas documented:\r\n\r\nhttps:\/\/docs.microsoft.com\/en-us\/microsoft-365\/security\/defender-endpoint\/prevent-changes-to-security-settings-with-tamper-protection?view=o365-worldwide\r\n\r\n## DISCUSS\r\n\r\nI'd love to have a discussion on this with folks if it would help. Please reach out in Comments!","comments":["Looking at the original [Enhancement Issue](https:\/\/github.com\/chef\/chef\/issues\/7865) - it was called out to configure both but it wasn't implemented that way. ","Ok.. The more I look at this.. The command `DisableIOAVProtection` relates to [IOfficeAntivirus](https:\/\/docs.microsoft.com\/en-us\/previous-versions\/windows\/internet-explorer\/ie-developer\/platform-apis\/ms537369(v=vs.85)) which seems to relate more to Internet Explorer and other Office apps that utilize Defender as the AV tool. I do not see how anyone that is implementing this as an option is getting the output that they desire. I'd almost go as far and say it's a bug.\r\n"],"labels":["Platform: Windows"]},{"title":"Inconsistent behavior in yum_package module when specified with Epoch","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nRecently upgraded chef-client from 16.x to 17.x and I see an inconsistent behavior in yum_package module while trying to install packages with EVR (epoch version and release) mentioned. It installs few packages where it doesnt converges few other packages.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n17.10.3\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nchef_version=17.10.3\r\nplatform=centos\r\nplatform_version=7.9.2009\r\nruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x86_64-linux]\r\nprogram_name=\/usr\/bin\/chef-client\r\nexecutable=\/opt\/chef\/bin\/chef-client\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\nInstall lower versions of erlang and rabbitmq in my case erlang-23.3.4.5-1.el7.x86_64.rpm rabbitmq-server-3.8.18-1.el7.noarch.rpm and try to update this packages to higher versions via the recipe. Configured yum repos to have this versions available.\r\n![image](https:\/\/user-images.githubusercontent.com\/13515573\/176892620-eaa76e49-18b4-415e-bd74-72d7c11ed6dd.png)\r\n\r\npackages.rb contents\r\n\r\n```\r\nyum_package 'erlang' do\r\n  version '0:23.3.4.11-1.el7'\r\n  allow_downgrade false\r\n  action :install\r\nend\r\n\r\nyum_package 'rabbitmq-server' do\r\n  version '0:3.9.13-1.el7'\r\n  allow_downgrade false\r\n  action :uninstall\r\nend\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\nThe yum_package dint install erlang of specified version and wrongly displaying its up to date even though higher version of erlang is available for upgrade. However rabbitmq-server of higher version is installed. behavior is inconsistent. Its same with java and mongodb package too. \r\n**Please NOTE: Both versions has epoch, version and release mentioned but the way it is handled by chef internally is different.** \r\n```\r\nRecipe: nw-rabbitmq::packages\r\n  * yum_package[erlang] action install[2022-07-01T12:23:04+00:00] INFO: Processing yum_package[erlang] action install (nw-rabbitmq::packages line 8)\r\n (up to date)\r\n  * yum_package[rabbitmq-server] action install[2022-07-01T12:23:05+00:00] INFO: Processing yum_package[rabbitmq-server] action install (nw-rabbitmq::packages line 14)\r\n[2022-07-01T12:23:09+00:00] INFO: yum_package[rabbitmq-server] installed rabbitmq-server at 0:3.9.13-1.el7.noarch\r\n\r\n    - install version 0:3.9.13-1.el7.noarch of package rabbitmq-server\r\n[2022-07-01T12:23:09+00:00] INFO: Blocking override node attributes for save\r\n[2022-07-01T12:23:09+00:00] WARN: Removing item global\r\n[2022-07-01T12:23:09+00:00] WARN: Could not find blocklist attribute global.\r\n[2022-07-01T12:23:09+00:00] INFO: Chef Infra Client Run complete in 8.237693124 seconds\r\n\r\nRunning handlers:\r\n[2022-07-01T12:23:09+00:00] INFO: Running report handlers\r\nRunning handlers complete\r\n[2022-07-01T12:23:09+00:00] INFO: Report handlers complete\r\nInfra Phase complete, 1\/2 resources updated in 15 seconds\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\nErlang trace logs:\r\n![image](https:\/\/user-images.githubusercontent.com\/13515573\/176894442-87f3e551-4453-40b9-a111-a05af36e8f58.png)\r\n\r\nrabbitmq trace logs:\r\n![image](https:\/\/user-images.githubusercontent.com\/13515573\/176892409-2b46d81e-9bdc-489f-9e71-52e633508c43.png)\r\n\r\nWays tried to resolve the issue:\r\n1) Remove EPOCH from version - erlang  and rabbitmq-server install went fine. However when I made the changes across the suite to versions removing epoch(23.23.4.11-1.el7 instead of 0:23.3.4.11-1.el7) I see issue on few other packages it is wrongly comparing versions.\r\ncode:\r\n```\r\nyum_package 'erlang' do\r\n  version '23.3.4.11-1.el7'\r\n  allow_downgrade false\r\n  action :install\r\nend\r\n\r\nyum_package 'rabbitmq-server' do\r\n  version '3.9.13-1.el7'\r\n  allow_downgrade false\r\n  action :install\r\nend\r\n```\r\noutput:\r\n![image](https:\/\/user-images.githubusercontent.com\/13515573\/176895356-6136e944-380f-48e8-be89-d5873e62de74.png)\r\n\r\nWrongly comparing versions and warning without EPOCH in package version:\r\n![image](https:\/\/user-images.githubusercontent.com\/13515573\/176896662-79bb7e3e-f841-4aeb-b8a9-6b3213973a44.png)\r\n\r\nNoticed an comment from @lamont-granquist that epochs are necessary and important for chef to maintain idempotency here https:\/\/github.com\/chef\/chef\/issues\/8883#issuecomment-531337652 and we would want to continue using EPOCH for all our packages. This is concerning, We usually dont prefer yum_package upgrade since we explicitly want to version control the packages in our tech suite.\r\nIs there a way or hack to fix this issue in 17.x since 16.x is EOL this November 2022 its causing issues while migrations. \r\nAny help or suggestions is appreciated.\r\n\r\nThanks in Advance","comments":["This appears to be addressed with https:\/\/github.com\/chef\/chef\/pull\/12657 and would just need to be backported to 17.","> This appears to be addressed with #12657 and would just need to be backported to 17.\r\n\r\nIt's now part of [17.10.0](https:\/\/docs.chef.io\/release_notes_client\/#17.10.0)","@tpowell-progress maybe to make it a little bit more clear the version in use includes the proposed fix. So it's not fixed.\r\n\r\nI did a little bit testing on my own with `17.10.0` and I can confirm that a simple\r\n```\r\nyum_package 'docker-ce' do\r\n  version '3:20.10.21-3.el7'\r\nend\r\n```\r\non a CentOS 7 won't upgrade the package:\r\n```\r\n$ rpm -qa docker-ce\r\ndocker-ce-20.10.7-3.el7.x86_64\r\n[\u2026]\r\nRecipe: docker-platform::package\r\n  * yum_package[docker-ce] action install (up to date)\r\n[\u2026]\r\n```\r\nFTR: Downgrade works neither. `action :upgrade` works fine.","Ok I did some digging and the source seems to be [located in these cases](https:\/\/github.com\/chef\/chef\/blob\/0cefcaa319b0d2f07241b78bf7d6f06de03d07ef\/lib\/chef\/provider\/package.rb#L486).  \r\nThere is simply no path for the case where the package is already installed but with a different version. `magic_version` will not be nil in these cases and so not installing. I'll try to come up with a patch.","@sepek I've assigned this to myself just to track for our next triage.","So I dug a bit deeper and got some nightmares ;) but even through here my findings & conclusions. First the issue does not appear if you do not specify the epoch - so `20.10.21-3.el7` works fine but `3:20.10.21-3.el7` does not. Here a bit of trace, first the not working case:\r\n```\r\n[2022-12-07T11:51:29+00:00] TRACE: sending '{\"action\":\"whatinstalled\",\"provides\":\"docker-ce\",\"epoch\":\"3\",\"version\":\"20.10.21\",\"release\":\"3.el7\"}' to python helper\r\n[2022-12-07T11:51:29+00:00] TRACE: got 'docker-ce 3:20.10.7-3.el7 x86_64' from python helper\r\n[2022-12-07T11:51:29+00:00] TRACE: parsed docker-ce-3:20.10.7-3.el7.x86_64 from python helper\r\n[2022-12-07T11:51:29+00:00] TRACE: yum_package[docker-ce] docker-ce 3:20.10.7-3.el7.x86_64 already installed\r\n```\r\nFor comparison the working case:\r\n```\r\n[2022-12-07T12:01:14+00:00] TRACE: parsed docker-ce-3:20.10.7-3.el7.x86_64 from python helper\r\n[2022-12-07T12:01:14+00:00] TRACE: sending '{\"action\":\"whatinstalled\",\"provides\":\"docker-ce-20.10.21-3.el7\"}' to python helper\r\n[2022-12-07T12:01:14+00:00] TRACE: got 'docker-ce-20.10.21-3.el7 nil nil' from python helper\r\n[2022-12-07T12:01:14+00:00] TRACE: parsed #<Chef::Provider::Package::Yum::Version:0x00000000043a8cf8> from python helper\r\n[2022-12-07T12:01:14+00:00] TRACE: sending '{\"action\":\"whatavailable\",\"provides\":\"docker-ce-20.10.21-3.el7\"}' to python helper\r\n[2022-12-07T12:01:14+00:00] TRACE: got 'docker-ce 3:20.10.21-3.el7 x86_64' from python helper\r\n[2022-12-07T12:01:14+00:00] TRACE: discarding output on stderr\/stdout from python helper: Loading mirror speeds from cached hostfile\r\n * elrepo: ftp.nluug.nl\r\n * epel: ftp.fau.de\r\nExcluding 6 updates due to versionlock (use \"yum versionlock status\" to show them)\r\n\r\n[2022-12-07T12:01:14+00:00] TRACE: parsed docker-ce-3:20.10.21-3.el7.x86_64 from python helper\r\n[2022-12-07T12:01:14+00:00] TRACE: yum_package[docker-ce] docker-ce not installed, installing 3:20.10.21-3.el7.x86_64\r\n```\r\nIn case the epoch is given we do [some magic split up of the version spec](https:\/\/github.com\/chef\/chef\/blob\/64c4c5754ab729fd85bc1a6c3beaf1b3a950f627\/lib\/chef\/provider\/package\/yum\/python_helper.rb#L134) and hand it in into the [yum_helper.py](https:\/\/github.com\/chef\/chef\/blob\/64c4c5754ab729fd85bc1a6c3beaf1b3a950f627\/lib\/chef\/provider\/package\/yum\/python_helper.rb#L219) and [in these lines](https:\/\/github.com\/chef\/chef\/blob\/64c4c5754ab729fd85bc1a6c3beaf1b3a950f627\/lib\/chef\/provider\/package\/yum\/yum_helper.py#L96:L107) the magic happens. In the non-epoch case `docker-ce-20.10.21-3.el7` is searched which won't give any result as it's not installed. In case we gave an epoch [we first search for the full version parameters](https:\/\/github.com\/chef\/chef\/blob\/64c4c5754ab729fd85bc1a6c3beaf1b3a950f627\/lib\/chef\/provider\/package\/yum\/yum_helper.py#L105) and [if we don't find anything](https:\/\/github.com\/chef\/chef\/blob\/64c4c5754ab729fd85bc1a6c3beaf1b3a950f627\/lib\/chef\/provider\/package\/yum\/yum_helper.py#L106) we search only for [`docker-ce` and `x86_64`](https:\/\/github.com\/chef\/chef\/blob\/64c4c5754ab729fd85bc1a6c3beaf1b3a950f627\/lib\/chef\/provider\/package\/yum\/yum_helper.py#L107) which will return the old installed version and now we think it's installed already as there was no version specified.  \r\nAs I couldn't find an explanation what `whatinstalled` is supposed to return I'm not sure how to continue. To prevent different behavior I think the proper way is dropping the [`if statement`](https:\/\/github.com\/chef\/chef\/blob\/64c4c5754ab729fd85bc1a6c3beaf1b3a950f627\/lib\/chef\/provider\/package\/yum\/yum_helper.py#L106:L107) to have the same behavior no matter if you hand in a full version string as part of the package name or you hand in extra elements via variables. However again another option would be to define another case [in here](https:\/\/github.com\/chef\/chef\/blob\/64c4c5754ab729fd85bc1a6c3beaf1b3a950f627\/lib\/chef\/provider\/package.rb#L486).  \r\nI'm a bit afraid for modifying `yum_helper.py` due [to](https:\/\/github.com\/chef\/chef\/blob\/64c4c5754ab729fd85bc1a6c3beaf1b3a950f627\/lib\/chef\/provider\/package\/yum\/yum_helper.py#L5:L6) some [comments](https:\/\/github.com\/chef\/chef\/blob\/64c4c5754ab729fd85bc1a6c3beaf1b3a950f627\/lib\/chef\/provider\/package\/yum\/yum_helper.py#L93:L95).  Also I've no idea what the change will break.  \r\n@tpowell-progress maybe you have an idea or whom to ask for feedback (maybe the author of https:\/\/github.com\/chef\/chef\/pull\/6540).","I have also seen a similar issue where you can specify the version without epoch and release and the package installs the first run. Then subsequent runs it will reinstall the package.\nFor example.\n```ruby\nyum_package \"telegraf\" do\n    version \"1.28.5\"\n    action :install \nend\n```\nHowever, if you add release number to version then the package will install the first time and correctly not install on subsequent runs.\n\nFor example.\n```ruby\nyum_package \"telegraf\" do\n    version \"1.28.5-1\"\n    action :install \nend\n```\n\nThis leads me to believe that the yum.rb or yum_helper.py is incorrectly checking for the installed version or missing components of version when doing version comparisons.\n\nI believe the _correct_ behavior when specifying version without release number should be to throw an exception that the release has not been found. This is how the apt_package resource behaves."],"labels":["Backport: 17"]},{"title":"cookbook_file crashes when copying file ending on \".dll\" to a Windows 2012R2","body":"## Description\r\nWhen copying a \".dll\" file, the recipe crashes.\r\n\r\n## Chef Version\r\nTest system:\r\nWindows 2012R2 with chef-client-17.10.3-1-x64.msi on it.\r\n\r\nClient system (where chef-kitchen is executed):\r\nChef Workstation version: 22.6.973\r\nChef InSpec version: 4.56.20\r\nChef CLI version: 5.6.1\r\nChef Habitat version: 1.6.420\r\nTest Kitchen version: 3.2.2\r\nCookstyle version: 7.32.1\r\nChef Infra Client version: 17.10.0\r\n\r\n## Platform Version\r\n\r\nTest system:\r\nWindows 2012R2 with chef-client-17.10.3-1-x64.msi on it.\r\n\r\nClient system (where chef-kitchen is executed):\r\nChef Workstation version: 22.6.973\r\nChef InSpec version: 4.56.20\r\nChef CLI version: 5.6.1\r\nChef Habitat version: 1.6.420\r\nTest Kitchen version: 3.2.2\r\nCookstyle version: 7.32.1\r\nChef Infra Client version: 17.10.0\r\n\r\n## Replication Case\r\n1. Install Windows 2012R2 VHD from [Microsoft](https:\/\/go.microsoft.com\/fwlink\/p\/?linkid=2195588&clcid=0x409&culture=en-us&country=us)\r\n2. Activate Hyper-V on Windows 10 (21H2\/ OS Build 19044.1766)\r\n3. Create a new VM and attach the disk\r\n4. Use default switch (if connectivity is broken , create an internal one)\r\n5. Start the 2012R2, set a user and a password\r\n6. Upload and install the chef-client (chef-client-17.10.3-1-x64.msi) on the 2012R2\r\n7. Allow winrm from the client system (win10 21H2) over the IP:\r\n```\r\nSet-Item WSMan:\\localhost\\Client\\TrustedHosts -Value '172.26.121.*'\r\n```\r\n8.Test winrm connectivity\r\n```\r\n$cred = Get-Credential\r\nEnter-PSSession -Computername <VMIP> -Authentication Negotiate -Credential $cred\r\n```\r\n9. Create cookbook & recipe\r\n```\r\nchef generate cookbook mycookbook\r\ncd mycookbook\r\nchef generate recipe myrecipe\r\n```\r\n10. Create recipe like this:\r\n```\r\ncookbook_file 'mydllfile.dll' do\r\n  atomic_update              true\r\n  backup                     false\r\n  inherits                   true\r\n  mode                       '0777'\r\n  path                       'C:\\\\mydllfile.dll'\r\n  source                     'mydllfile.dll'\r\n  action                     :create\r\nend\r\n```\r\n11. Create kitchen's yml (replace IP, username and pass)\r\n```\r\n---\r\nprovisioner:\r\n  name: chef_zero\r\n  log_level: debug\r\n\r\n\r\nverifier:\r\n  name: inspec\r\n\r\n\r\nplatforms:\r\n  - name: windows-2012R2\r\n    os_type: windows\r\n    shell_type: powershell\r\n    transport:\r\n      name: winrm\r\n      elevated: true\r\n      username: 'user'\r\n      password: 'pass'\r\n      hostname: 'ip_of_VM'\r\n    driver:\r\n      box: windows-2012r2\r\n\r\n\r\nsuites:\r\n  - name: myrecipe\r\n    run_list:\r\n      - recipe[myrecipe]\r\n\r\n```\r\n12. Copy a dll file named \"mydllfile.dll\" into cookbook\/files\r\n13. Execute kitchen \r\n```\r\nkitchen converge -l debug\r\n```\r\n\r\n \r\n## Client Output\r\nhttps:\/\/gist.githubusercontent.com\/hunter86bg\/32b4163fe4d132125cd4fe241c6cdac2\/raw\/09a115c3c276fbdd7485ac71e21e422703a8e630\/cookbook_file%2520dll%2520crash\r\n\r\n## Stacktrace\r\n\r\n## backtrace\r\nD      ----------------------\r\nD      ------Backtrace-------\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:181:in `report_errors'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:172:in `run_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command\/action.rb:35:in `block in call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/3.0.0\/benchmark.rb:293:in `measure'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command\/action.rb:33:in `call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/cli.rb:52:in `perform'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/cli.rb:198:in `block (2 levels) in <class:CLI>'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor\/command.rb:27:in `run'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor\/invocation.rb:127:in `invoke_command'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor.rb:392:in `dispatch'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor\/base.rb:485:in `start'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/bin\/kitchen:11:in `block in <top (required)>'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/errors.rb:183:in `with_friendly_errors'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/bin\/kitchen:11:in `<top (required)>'\r\nD      C:\/opscode\/chef-workstation\/bin\/kitchen:408:in `load'\r\nD      C:\/opscode\/chef-workstation\/bin\/kitchen:408:in `<main>'\r\nD      ----End Backtrace-----\r\nD      -Composite Exception--\r\nD      Class: Kitchen::InstanceFailure\r\nD      Message: Converge failed on instance <mycookbook-windows-2012R2>.  Please see .kitchen\/logs\/mycookbook-windows-2012R2.log for more details\r\nD      ----------------------\r\nD      ------Backtrace-------\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:100:in `rescue in call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:99:in `call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:419:in `block in converge_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:563:in `synchronize_or_call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:524:in `block in action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/3.0.0\/benchmark.rb:293:in `measure'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:523:in `action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:414:in `converge_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:392:in `block (2 levels) in transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/lifecycle_hooks.rb:47:in `run_with_hooks'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:391:in `block in transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `each'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:139:in `converge'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `public_send'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `run_action_in_thread'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:166:in `block (2 levels) in run_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/logging-2.3.1\/lib\/logging\/diagnostic_context.rb:474:in `block in create_with_logging_context'\r\nD      ----End Backtrace-----\r\nD      ---Nested Exception---\r\nD      Class: Kitchen::ActionFailed\r\nD      Message: WinRM exited (1) for command: [$env:TEST_KITCHEN = \"1\"\r\n$env:PATH = try {\r\n[System.Environment]::GetEnvironmentVariable('PATH','Machine')\r\n} catch { $env:PATH }\r\n\r\n& $env:systemdrive\\opscode\\chef\\bin\\chef-client.bat --local-mode --config $env:TEMP\\kitchen\\client.rb --log_level debug --force-formatter --no-color --json-attributes $env:TEMP\\kitchen\\dna.json --chef-zero-port 8889 ; exit $LastExitCode]\r\nD      ----------------------\r\nD      ------Backtrace-------\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:100:in `rescue in call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:99:in `call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:419:in `block in converge_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:563:in `synchronize_or_call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:524:in `block in action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/3.0.0\/benchmark.rb:293:in `measure'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:523:in `action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:414:in `converge_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:392:in `block (2 levels) in transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/lifecycle_hooks.rb:47:in `run_with_hooks'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:391:in `block in transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `each'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:139:in `converge'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `public_send'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `run_action_in_thread'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:166:in `block (2 levels) in run_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/logging-2.3.1\/lib\/logging\/diagnostic_context.rb:474:in `block in create_with_logging_context'\r\nD      ----End Backtrace-----","comments":["Thank you for the detailed bug report! \r\n\r\nWe would like to understand what is the specific usecase that you are looking to address by copying the dll using chef?\r\nIs this a blocker for the work that you are doing or do you have a workaround in getting past this issue?","It seems that the workaround is to name the file as 'Myfile_dll' and then select that as source.\r\n\r\nThe use case is to deliver the NuGet Package Provider dll to systems behind firewall, so after that via chef deliver nuget packages locally and via powershell to create a local\/internal (behind firewall) Powershell Repo and install those powershell modules (for example IISAdministration)","As I was reporting multiple issues at once, I might have mixed the problems, so don't hesitate to ask if something looks odd.","Thank you for the context. We will check with product to understand the priority for this. Meanwhile if you have an opportunity to create a PR for the fix, we would be happy to review it and it would help expedite the process."],"labels":["Status: Needs Replication"]},{"title":"windows_task execution_time_limit crashes when defined in minutes \/ ISO8601 \/","body":"## Description\r\nWhen setting execution_time_limit in a  windows_task , the recipe crash.\r\n\r\n## Chef Version\r\nTest system:\r\nWindows 2012R2 with chef-client-17.10.3-1-x64.msi on it.\r\n\r\nClient system (where chef-kitchen is executed):\r\nChef Workstation version: 22.6.973\r\nChef InSpec version: 4.56.20\r\nChef CLI version: 5.6.1\r\nChef Habitat version: 1.6.420\r\nTest Kitchen version: 3.2.2\r\nCookstyle version: 7.32.1\r\nChef Infra Client version: 17.10.0\r\n\r\n## Platform Version\r\n\r\nTest system:\r\nWindows 2012R2 with chef-client-17.10.3-1-x64.msi on it.\r\n\r\nClient system (where chef-kitchen is executed):\r\nChef Workstation version: 22.6.973\r\nChef InSpec version: 4.56.20\r\nChef CLI version: 5.6.1\r\nChef Habitat version: 1.6.420\r\nTest Kitchen version: 3.2.2\r\nCookstyle version: 7.32.1\r\nChef Infra Client version: 17.10.0\r\n\r\n## Replication Case\r\n1. Install Windows 2012R2 VHD from [Microsoft](https:\/\/go.microsoft.com\/fwlink\/p\/?linkid=2195588&clcid=0x409&culture=en-us&country=us)\r\n2. Activate Hyper-V on Windows 10 (21H2\/ OS Build 19044.1766)\r\n3. Create a new VM and attach the disk\r\n4. Use default switch (if connectivity is broken , create an internal one)\r\n5. Start the 2012R2, set a user and a password\r\n6. Upload and install the chef-client (chef-client-17.10.3-1-x64.msi) on the 2012R2\r\n7. Allow winrm from the client system (win10 21H2) over the IP:\r\n```\r\nSet-Item WSMan:\\localhost\\Client\\TrustedHosts -Value '172.26.121.*'\r\n```\r\n8.Test winrm connectivity\r\n```\r\n$cred = Get-Credential\r\nEnter-PSSession -Computername <VMIP> -Authentication Negotiate -Credential $cred\r\n```\r\n9. Create cookbook & recipe\r\n```\r\nchef generate cookbook mycookbook\r\ncd mycookbook\r\nchef generate recipe myrecipe\r\n```\r\n10. Create recipe like this:\r\n```\r\ndirectory 'web_scripts' do\r\n  inherits                   true\r\n  mode                       '0777'\r\n  path                       'C:\\\\scripts\\\\web\\\\'\r\n  recursive                  true\r\n  action                     :create\r\nend\r\n\r\ncookbook_file 'mypowershell_script.ps1' do\r\n  atomic_update              true\r\n  backup                     false\r\n  inherits                   true\r\n  mode                       '0777'\r\n  path                       'C:\\\\scripts\\\\web\\\\mypowershell_script.ps1'\r\n  source                     'mypowershell_script.ps1'\r\n  action                     :create\r\n  notifies                   :create, 'directory[web_scripts]', :before\r\nend\r\n\r\nwindows_task 'webtask' do\r\n  user 'SYSTEM'\r\n  run_level :highest\r\n  frequency :daily\r\n  start_time '09:50'\r\n  execution_time_limit PT10M \r\n  command 'powershell.exe -ExecutionPolicy Bypass -File \"C:\\\\scripts\\\\web\\\\mypowershell_script.ps1\"'\r\n  guard_interpreter :powershell_script\r\n  force true\r\n  only_if 'Test-Path \"C:\\\\scripts\\\\web\\\\mypowershell_script.ps1\"'\r\n  # notifies :create, 'cookbook_file[mypowershell_script.ps1]', :before\r\nend\r\n```\r\n11. Create kitchen's yml (replace IP, username and pass)\r\n```\r\n---\r\nprovisioner:\r\n  name: chef_zero\r\n  log_level: debug\r\n\r\n\r\nverifier:\r\n  name: inspec\r\n\r\n\r\nplatforms:\r\n  - name: windows-2012R2\r\n    os_type: windows\r\n    shell_type: powershell\r\n    transport:\r\n      name: winrm\r\n      elevated: true\r\n      username: 'user'\r\n      password: 'pass'\r\n      hostname: 'ip_of_VM'\r\n    driver:\r\n      box: windows-2012r2\r\n\r\n\r\nsuites:\r\n  - name: myrecipe\r\n    run_list:\r\n      - recipe[myrecipe]\r\n\r\n```\r\n12. Create a file in cookbook_dir\/files that is named \"mypowershell_script.ps1\"\r\n13. Execute kitchen \r\n```\r\nkitchen converge -l debug\r\n```\r\n15. Verify the task on the  2012R2 system\r\n\r\n \r\n## Client Output\r\nhttps:\/\/gist.githubusercontent.com\/hunter86bg\/da95ceedd0b401ebf01872807841fb6d\/raw\/177a9637c1ccfe3d71e28c07465c2d682750d0ec\/windows_task%2520execution_time_limit%2520tracebacks%2520on%2520ISO8601%2520duration%2520format\r\n\r\n## Stacktrace\r\n\r\n## Backtrace\r\n```\r\nD      ----------------------\r\nD      ------Backtrace-------\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:181:in `report_errors'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:172:in `run_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command\/action.rb:35:in `block in call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/3.0.0\/benchmark.rb:293:in `measure'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command\/action.rb:33:in `call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/cli.rb:52:in `perform'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/cli.rb:198:in `block (2 levels) in <class:CLI>'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor\/command.rb:27:in `run'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor\/invocation.rb:127:in `invoke_command'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor.rb:392:in `dispatch'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor\/base.rb:485:in `start'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/bin\/kitchen:11:in `block in <top (required)>'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/errors.rb:183:in `with_friendly_errors'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/bin\/kitchen:11:in `<top (required)>'\r\nD      C:\/opscode\/chef-workstation\/bin\/kitchen:408:in `load'\r\nD      C:\/opscode\/chef-workstation\/bin\/kitchen:408:in `<main>'\r\nD      ----End Backtrace-----\r\nD      -Composite Exception--\r\nD      Class: Kitchen::InstanceFailure\r\nD      Message: Converge failed on instance <myrecipe-windows-2012R2>.  Please see .kitchen\/logs\/myrecipe-windows-2012R2.log for more details\r\nD      ----------------------\r\nD      ------Backtrace-------\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:100:in `rescue in call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:99:in `call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:419:in `block in converge_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:563:in `synchronize_or_call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:524:in `block in action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/3.0.0\/benchmark.rb:293:in `measure'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:523:in `action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:414:in `converge_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:392:in `block (2 levels) in transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/lifecycle_hooks.rb:47:in `run_with_hooks'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:391:in `block in transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `each'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:139:in `converge'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `public_send'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `run_action_in_thread'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:166:in `block (2 levels) in run_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/logging-2.3.1\/lib\/logging\/diagnostic_context.rb:474:in `block in create_with_logging_context'\r\nD      ----End Backtrace-----\r\nD      ---Nested Exception---\r\nD      Class: Kitchen::ActionFailed\r\nD      Message: WinRM exited (1) for command: [$env:TEST_KITCHEN = \"1\"\r\n$env:PATH = try {\r\n[System.Environment]::GetEnvironmentVariable('PATH','Machine')\r\n} catch { $env:PATH }\r\n\r\n& $env:systemdrive\\opscode\\chef\\bin\\chef-client.bat --local-mode --config $env:TEMP\\kitchen\\client.rb --log_level debug --force-formatter --no-color --json-attributes $env:TEMP\\kitchen\\dna.json --chef-zero-port 8889 ; exit $LastExitCode]\r\nD      ----------------------\r\nD      ------Backtrace-------\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:100:in `rescue in call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:99:in `call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:419:in `block in converge_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:563:in `synchronize_or_call'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:524:in `block in action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/3.0.0\/benchmark.rb:293:in `measure'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:523:in `action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:414:in `converge_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:392:in `block (2 levels) in transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/lifecycle_hooks.rb:47:in `run_with_hooks'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:391:in `block in transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `each'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `transition_to'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:139:in `converge'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `public_send'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `run_action_in_thread'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:166:in `block (2 levels) in run_action'\r\nD      C:\/opscode\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/logging-2.3.1\/lib\/logging\/diagnostic_context.rb:474:in `block in create_with_logging_context'\r\nD      ----End Backtrace-----\r\n```\r\n\r\nWorkaround:\r\nSet execution_time_limit in seconds (600).","comments":[],"labels":["Type: Bug","Triage: Confirmed","Status: Good First Issue","Backport: 17"]},{"title":"windows_task command's arguments are missing when \"notifies\" is defined","body":"## Description\r\nWhen setting \"notifies\" to a windows_task , the command arguments are not processed (missing)\r\n\r\n## Chef Version\r\nTest system:\r\nWindows 2012R2 with chef-client-17.10.3-1-x64.msi on it.\r\n\r\nClient system (where chef-kitchen is executed):\r\nChef Workstation version: 22.6.973\r\nChef InSpec version: 4.56.20\r\nChef CLI version: 5.6.1\r\nChef Habitat version: 1.6.420\r\nTest Kitchen version: 3.2.2\r\nCookstyle version: 7.32.1\r\nChef Infra Client version: 17.10.0\r\n\r\n## Platform Version\r\n\r\nTest system:\r\nWindows 2012R2 with chef-client-17.10.3-1-x64.msi on it.\r\n\r\nClient system (where chef-kitchen is executed):\r\nChef Workstation version: 22.6.973\r\nChef InSpec version: 4.56.20\r\nChef CLI version: 5.6.1\r\nChef Habitat version: 1.6.420\r\nTest Kitchen version: 3.2.2\r\nCookstyle version: 7.32.1\r\nChef Infra Client version: 17.10.0\r\n\r\n## Replication Case\r\n1. Install Windows 2012R2 VHD from [Microsoft](https:\/\/go.microsoft.com\/fwlink\/p\/?linkid=2195588&clcid=0x409&culture=en-us&country=us)\r\n2. Activate Hyper-V on Windows 10 (21H2\/ OS Build 19044.1766)\r\n3. Create a new VM and attach the disk\r\n4. Use default switch (if connectivity is broken , create an internal one)\r\n5. Start the 2012R2, set a user and a password\r\n6. Upload and install the chef-client (chef-client-17.10.3-1-x64.msi) on the 2012R2\r\n7. Allow winrm from the client system (win10 21H2) over the IP:\r\n```\r\nSet-Item WSMan:\\localhost\\Client\\TrustedHosts -Value '172.26.121.*'\r\n```\r\n8.Test winrm connectivity\r\n```\r\n$cred = Get-Credential\r\nEnter-PSSession -Computername 172.26.121.31 -Authentication Negotiate -Credential $cred\r\n```\r\n9. Create cookbook & recipe\r\n```\r\nchef generate cookbook mycookbook\r\ncd mycookbook\r\nchef generate recipe myrecipe\r\n```\r\n10. Create recipe like this:\r\n```\r\ndirectory 'web_scripts' do\r\n  inherits                   true\r\n  mode                       '0777'\r\n  path                       'C:\\\\scripts\\\\web\\\\'\r\n  recursive                  true\r\n  action                     :create\r\nend\r\n\r\ncookbook_file 'mypowershell_script.ps1' do\r\n  atomic_update              true\r\n  backup                     false\r\n  inherits                   true\r\n  mode                       '0777'\r\n  path                       'C:\\\\scripts\\\\web\\\\mypowershell_script.ps1'\r\n  source                     'mypowershell_script.ps1'\r\n  action                     :create\r\n  notifies                   :create, 'directory[web_scripts]', :before\r\nend\r\n\r\nwindows_task 'webtask' do\r\n  user 'SYSTEM'\r\n  run_level :highest\r\n  frequency :daily\r\n  start_time '09:50'\r\n  execution_time_limit 600 #This will be another bug, use integer only\r\n  command 'powershell.exe -ExecutionPolicy Bypass -File \"C:\\\\scripts\\\\web\\\\mypowershell_script.ps1\"'\r\n  guard_interpreter :powershell_script\r\n  force true\r\n  only_if 'Test-Path \"C:\\\\scripts\\\\web\\\\mypowershell_script.ps1\"'\r\n  notifies :create, 'cookbook_file[mypowershell_script.ps1]', :before\r\nend\r\n```\r\n11. Create kitchen's yml (replace IP, username and pass)\r\n```\r\n---\r\nprovisioner:\r\n  name: chef_zero\r\n  log_level: debug\r\n\r\n\r\nverifier:\r\n  name: inspec\r\n\r\n\r\nplatforms:\r\n  - name: windows-2012R2\r\n    os_type: windows\r\n    shell_type: powershell\r\n    transport:\r\n      name: winrm\r\n      elevated: true\r\n      username: 'user'\r\n      password: 'pass'\r\n      hostname: 'ip_of_VM'\r\n    driver:\r\n      box: windows-2012r2\r\n\r\n\r\nsuites:\r\n  - name: myrecipe\r\n    run_list:\r\n      - recipe[myrecipe]\r\n\r\n```\r\n12. Create a file in cookbook_dir\/files that is named \"mypowershell_script.ps1\"\r\n13. Execute kitchen \r\n```\r\nkitchen converge -l debug\r\n```\r\n15. Verify the task on the  2012R2 system\r\n\r\n \r\n## Client Output\r\nhttps:\/\/gist.githubusercontent.com\/hunter86bg\/792e9fd79028b5dd54faa091564446fd\/raw\/c106e7f0d959729fd9cad1edf9edcddfe1b07645\/gistfile1.txt\r\n\r\n## Stacktrace\r\nKitchen completes successfully, so no stacktraces available\r\n\r\nWorkaround:\r\nComment \"notifies\" section of the windows_task .","comments":[],"labels":["Status: Needs Replication"]},{"title":"User resource user.rb crashes with `Segmentation fault` when using GCP VM with OSLogin Enabled.","body":"## Description\r\nUser resource [user.rb](https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource\/user.rb) crashes with `Segmentation fault` when using GCP VM with OSLogin Enabled.\r\n\r\n## Chef Version\r\n```\r\n$ chef-client --version\r\nChef Infra Client: 16.17.4\r\n```\r\n\r\nAlso tested (same issue)\r\n```\r\nchef-client --version\r\nChef Infra Client: 17.10.3\r\n```\r\n\r\n## Platform Version\r\n```\r\n$ lsb_release -a\r\nNo LSB modules are available.\r\nDistributor ID:\tUbuntu\r\nDescription:\tUbuntu 20.04.4 LTS\r\nRelease:\t20.04\r\nCodename:\tfocal\r\n\r\n$ uname -r\r\n5.13.0-1024-gcp\r\n```\r\n\r\n## Replication Case\r\n1. Enable OSLogin on GCP Compute VM by setting metadata: `enable-oslogin  = \"True\"`\r\n2. Create a simple user create runbook:\r\n```\r\n$ cat user.rb\r\nuser 'bob'\r\n```\r\n3. Run `chef-solo` to apply code locally\r\n```\r\n$ chef-solo user.rb\r\n```\r\n\r\n## Client Output\r\n```\r\nRecipe: @recipe_files::\/root\/user.rb\r\n  * linux_user[bob] action create[2022-06-14T02:13:18+00:00] INFO: Processing linux_user[bob] action create (@recipe_files::\/root\/user.rb line 1)\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/provider\/user.rb:50: [BUG] Segmentation fault at 0x0000000000000000\r\nruby 2.7.4p191 (2021-07-07 revision a21a3b7d23) [x86_64-linux]\r\n\r\n-- Control frame information -----------------------------------------------\r\nc:0035 p:---- s:0174 e:000173 CFUNC  :getpwnam\r\nc:0034 p:0054 s:0169 e:000168 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/provider\/user.rb:50\r\nc:0033 p:0054 s:0163 e:000162 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/provider.rb:200\r\nc:0032 p:0008 s:0158 e:000157 BLOCK  \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource.rb:599\r\nc:0031 p:0028 s:0155 e:000154 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource.rb:626\r\nc:0030 p:0186 s:0150 e:000149 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource.rb:598\r\nc:0029 p:0063 s:0140 e:000139 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:74\r\nc:0028 p:0008 s:0131 e:000130 BLOCK  \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:108 [FINISH]\r\nc:0027 p:---- s:0127 e:000126 CFUNC  :each\r\nc:0026 p:0010 s:0123 e:000122 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:108\r\nc:0025 p:0017 s:0118 e:000117 BLOCK  \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:132\r\nc:0024 p:0010 s:0114 e:000113 BLOCK  \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/resource_list.rb:96\r\nc:0023 p:0077 s:0109 e:000108 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/stepable_iterator.rb:114\r\nc:0022 p:0015 s:0105 e:000104 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/stepable_iterator.rb:85\r\nc:0021 p:0009 s:0101 e:000100 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/stepable_iterator.rb:103\r\nc:0020 p:0015 s:0097 e:000096 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/stepable_iterator.rb:54\r\nc:0019 p:0027 s:0092 E:0002e0 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/resource_list.rb:94\r\nc:0018 p:0028 s:0088 e:000087 METHOD \/opt\/chef\/embedded\/lib\/ruby\/2.7.0\/forwardable.rb:235\r\nc:0017 p:0019 s:0081 E:000f48 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:130\r\nc:0016 p:0056 s:0076 e:000075 BLOCK  \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/client.rb:687 [FINISH]\r\nc:0015 p:---- s:0072 e:000071 CFUNC  :catch\r\nc:0014 p:0006 s:0067 e:000066 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/client.rb:682\r\nc:0013 p:0005 s:0062 e:000061 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/client.rb:706\r\nc:0012 p:0776 s:0057 e:000056 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/client.rb:286\r\nc:0011 p:0013 s:0050 E:0016e0 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application.rb:305\r\nc:0010 p:0063 s:0046 e:000045 BLOCK  \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application.rb:281\r\nc:0009 p:0006 s:0042 e:000041 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/local_mode.rb:42\r\nc:0008 p:0043 s:0038 e:000037 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application.rb:264\r\nc:0007 p:0142 s:0033 e:000032 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application\/base.rb:337\r\nc:0006 p:0023 s:0028 e:000027 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application.rb:67\r\nc:0005 p:0081 s:0022 e:000021 METHOD \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application\/solo.rb:60\r\nc:0004 p:0052 s:0016 e:000015 TOP    \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-bin-16.17.4\/bin\/chef-solo:24 [FINISH]\r\nc:0003 p:---- s:0013 e:000012 CFUNC  :load\r\nc:0002 p:1151 s:0008 E:001d70 EVAL   \/usr\/bin\/chef-solo:156 [FINISH]\r\nc:0001 p:0000 s:0003 E:001340 (none) [FINISH]\r\n\r\n-- Ruby level backtrace information ----------------------------------------\r\n\/usr\/bin\/chef-solo:156:in `<main>'\r\n\/usr\/bin\/chef-solo:156:in `load'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-bin-16.17.4\/bin\/chef-solo:24:in `<top (required)>'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application\/solo.rb:60:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application.rb:67:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application\/base.rb:337:in `run_application'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application.rb:264:in `run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/client.rb:286:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/client.rb:706:in `converge_and_save'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/client.rb:682:in `converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/client.rb:682:in `catch'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/client.rb:687:in `block in converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:130:in `converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/2.7.0\/forwardable.rb:235:in `execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/resource_list.rb:94:in `execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/stepable_iterator.rb:54:in `each_with_index'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/stepable_iterator.rb:103:in `iterate'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/stepable_iterator.rb:85:in `step'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/stepable_iterator.rb:114:in `call_iterator_block'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource_collection\/resource_list.rb:96:in `block in execute_each_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:132:in `block in converge'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:108:in `run_all_actions'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:108:in `each'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:108:in `block in run_all_actions'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/runner.rb:74:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource.rb:598:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource.rb:626:in `with_umask'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/resource.rb:599:in `block in run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/provider.rb:200:in `run_action'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/provider\/user.rb:50:in `load_current_resource'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.17.4\/lib\/chef\/provider\/user.rb:50:in `getpwnam'\r\n\r\n-- Machine register context ------------------------------------------------\r\n RIP: 0x00007fc9503b0afe RBP: 0x0000000001dfb440 RSP: 0x00007ffebfea0e98\r\n RAX: 0x0000000000000000 RBX: 0x00000000060ccd30 RCX: 0x0000000000000100\r\n RDX: 0x0000000000000000 RDI: 0x0000000000000000 RSI: 0x0000000000000000\r\n  R8: 0x00000000060cc0c0  R9: 0x0000000000000000 R10: 0x0000000000000015\r\n R11: 0x00007fc94ba68170 R12: 0x0000000000000002 R13: 0x0000000001e28e68\r\n R14: 0x00000000060cc0c0 R15: 0x00007fc94b65d330 EFL: 0x0000000000010283\r\n```\r\n\r\n## Observations \/ Notes\r\n\r\nThe real code we're using to create users has worked for years without issue.\r\nThis issue only recently started to happen a few days ago, and happens anytime we try to CREATE a user (updates are fine). \r\n\r\nThis issue goes away if we disable OSLogin.\r\nI've looked around their repo and didn't find any obvious answers to this issue.\r\nhttps:\/\/github.com\/GoogleCloudPlatform\/guest-agent \r\n\r\nIt looks like it's this block of code where we have issues:\r\nhttps:\/\/github.com\/chef\/chef\/blob\/d4c3b8ad111ec7ff6b32ebccf9edd1b6a2f9e8e2\/lib\/chef\/provider\/user.rb#L45-L55 \r\n\r\nI tried running a similar ruby test, but oddly it's fine:\r\n```\r\n$ cat debug.rb\r\nrequire 'etc'\r\n\r\nuser = 'fake_user'\r\n\r\nbegin\r\n  user_info = Etc.getpwnam(user)\r\nrescue ArgumentError\r\n  @user_exists = false\r\n  puts \"user #{user} does not exist\"\r\n  user_info = nil\r\nend\r\n\r\nif user_info\r\n  puts \"user #{user} is an existing user\"\r\nend\r\n\r\n\r\n$ \/opt\/chef\/embedded\/bin\/ruby debug.rb\r\nuser fake_user does not exist\r\n```\r\n\r\nI know this is a bit of a grey area between this being a chef bug, or a bug in the google guest-agent repo. I was hoping to ask here for input, but I'll open a google issue if needed. ","comments":["Jim, can you test something please: Inside that instance of Ubuntu, can you call `irb` and once inside that Ruby environment, call \"`Etc.getpwnam(some-user-name)`\" and see what happens?","Sure thing:\r\n```\r\n# irb\r\n\r\nirb(main):001:0> Etc.getpwnam('postgres')\r\n=> #<struct Etc::Passwd name=\"postgres\", passwd=\"x\", uid=300, gid=1024, gecos=\"PostgreSQL administrator\", dir=\"\/var\/lib\/postgresql\", shell=\"\/bin\/bash\">\r\n\r\nirb(main):002:0> Etc.getpwnam('fake_user')\r\nTraceback (most recent call last):\r\n        5: from \/opt\/chef\/embedded\/bin\/irb:23:in `<main>'\r\n        4: from \/opt\/chef\/embedded\/bin\/irb:23:in `load'\r\n        3: from \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/irb-1.2.6\/exe\/irb:11:in `<top (required)>'\r\n        2: from (irb):2\r\n        1: from (irb):2:in `getpwnam'\r\nArgumentError (can't find user for fake_user)\r\n```","Hi, I'm the maintainer of the OS Login client implementation for GCE. We have had some customer reports about this issue and would like to see if it can be resolved. So far it looks like loading chef's bundled openssl and libcrypto are at fault. \r\n\r\n\r\nRepro script:\r\n```\r\n#!\/opt\/opscode\/embedded\/bin\/ruby --disable-gems\r\n\r\nrequire 'rubygems'\r\nrequire 'openssl'\r\nrequire 'etc'\r\n\r\ninfo = Etc.getpwnam('fake_username')\r\nputs \"Got user #{info}\"\r\n```\r\n\r\nGdb stack trace on a Debian 11 VM with Chef 15:\r\n\r\n```\r\nReading symbols from \/opt\/opscode\/embedded\/bin\/ruby...\r\n(gdb) r .\/user.rb\r\nStarting program: \/opt\/opscode\/embedded\/bin\/ruby .\/user.rb\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"\/lib\/x86_64-linux-gnu\/libthread_db.so.1\".\r\nProgram received signal SIGSEGV, Segmentation fault.\r\n__strcmp_avx2 () at ..\/sysdeps\/x86_64\/multiarch\/strcmp-avx2.S:101\r\n101\t..\/sysdeps\/x86_64\/multiarch\/strcmp-avx2.S: No such file or directory.\r\n(gdb) bt\r\n#0  __strcmp_avx2 () at ..\/sysdeps\/x86_64\/multiarch\/strcmp-avx2.S:101\r\n#1  0x00007ffff30716c5 in lh_insert () from \/opt\/opscode\/embedded\/lib\/libcrypto.so.1.0.0\r\n#2  0x00007ffff2fbd781 in OBJ_NAME_add () from \/opt\/opscode\/embedded\/lib\/libcrypto.so.1.0.0\r\n#3  0x00007ffff1c6d60e in ?? () from \/lib\/x86_64-linux-gnu\/libcrypto.so.1.1\r\n#4  0x00007ffff1c88d39 in ?? () from \/lib\/x86_64-linux-gnu\/libcrypto.so.1.1\r\n#5  0x00007ffff764d34f in __pthread_once_slow (once_control=0x7ffff1dea830, init_routine=0x7ffff1c88d30) at pthread_once.c:116\r\n#6  0x00007ffff1cf4179 in CRYPTO_THREAD_run_once () from \/lib\/x86_64-linux-gnu\/libcrypto.so.1.1\r\n#7  0x00007ffff1c892eb in OPENSSL_init_crypto () from \/lib\/x86_64-linux-gnu\/libcrypto.so.1.1\r\n#8  0x00007ffff1e22011 in OPENSSL_init_ssl () from \/lib\/x86_64-linux-gnu\/libssl.so.1.1\r\n#9  0x00007ffff21998a0 in ?? () from \/lib\/x86_64-linux-gnu\/libcurl.so.4\r\n#10 0x00007ffff214c523 in ?? () from \/lib\/x86_64-linux-gnu\/libcurl.so.4\r\n#11 0x00007ffff214c768 in curl_easy_init () from \/lib\/x86_64-linux-gnu\/libcurl.so.4\r\n#12 0x00007ffff1132e0d in oslogin_utils::UrlEncode(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&) () from \/lib\/x86_64-linux-gnu\/libnss_oslogin.so.2\r\n#13 0x00007ffff112e69d in _nss_oslogin_getpwnam_r () from \/lib\/x86_64-linux-gnu\/libnss_oslogin.so.2\r\n#14 0x00007ffff79454f3 in __getpwnam_r (name=name@entry=0xbb2bd8 \"fake_liamh_google_com\", resbuf=resbuf@entry=0x7ffff7a3d4e0 <resbuf>, buffer=0xb395a0 \"sa_115817244443185942089\", \r\n    buflen=buflen@entry=1024, result=result@entry=0x7fffffffe0c0) at ..\/nss\/getXXbyYY_r.c:315\r\n#15 0x00007ffff7944e14 in getpwnam (name=0xbb2bd8 \"fake_liamh_google_com\") at ..\/nss\/getXXbyYY.c:134\r\n#16 0x00007ffff22a2e55 in etc_getpwnam (obj=<optimized out>, nam=12266440) at etc.c:222\r\n#17 0x00007ffff7c8663d in vm_call_cfunc_with_frame (empty_kw_splat=<optimized out>, cd=0x8f5b40, calling=<optimized out>, reg_cfp=0x7ffff744afa0, ec=0x603b40) at vm_insnhelper.c:2514\r\n#18 vm_call_cfunc (ec=0x603b40, reg_cfp=0x7ffff744afa0, calling=<optimized out>, cd=0x8f5b40) at vm_insnhelper.c:2539\r\n#19 0x00007ffff7ca0063 in vm_call_method (ec=0x603b40, cfp=0x7ffff744afa0, calling=<optimized out>, cd=<optimized out>) at vm_insnhelper.c:3057\r\n#20 0x00007ffff7c919f7 in vm_sendish (block_handler=0, method_explorer=<optimized out>, cd=0x8f5b40, reg_cfp=0x7ffff744afa0, ec=<optimized out>) at vm_insnhelper.c:4023\r\n#21 vm_exec_core (ec=<optimized out>, initial=initial@entry=0) at insns.def:801\r\n#22 0x00007ffff7c98077 in rb_vm_exec (ec=0x603b40, mjit_enable_p=mjit_enable_p@entry=1) at vm.c:1929\r\n#23 0x00007ffff7ca1540 in rb_iseq_eval_main (iseq=iseq@entry=0x7730d0) at vm.c:2179\r\n#24 0x00007ffff7b0f75a in rb_ec_exec_node (ec=ec@entry=0x603b40, n=n@entry=0x7730d0) at eval.c:278\r\n#25 0x00007ffff7b14d99 in ruby_run_node (n=0x7730d0) at eval.c:336\r\n#26 0x000000000040086b in main (argc=2, argv=0x7fffffffe668) at .\/main.c:50\r\n```\r\n\r\nAt this point all OS Login is doing is calling the `curl_easy_init()` function from libcurl. I would guess that there's an incompatibility between the system libssl and the embedded\/vendored libcrypto, but which is not usually exposed. The OS Login system contains an NSS user provider that involves making network lookups using libcurl. Ironically, SSL is not actually used.","This fails all installations of chef on GCE VMs with OS Login enabled, we tested versions 10-15. The failing step is typically '\/usr\/bin\/chef-server-ctl reconfigure'","Ping for status on this bug. It is currently a blocker for all users of Chef on google compute engine with OS Login enabled.","Hello @johnmccrae,\r\n\r\nCan you give us a status on this please ?\r\n\r\nThanks !","Ping for status please","+1 for a Status update?","Please someone @chef ?","@chef any status update? i think the label \"Needs replication\" can be removed b\/c of hopkiw's comment above (https:\/\/github.com\/chef\/chef\/issues\/12993#issuecomment-1201563536) and I can confirm the issue still exists with Chef 16, 17, and 18","For anyone who stumbles on this and is looking for a workaround, we ended up patching `Etc` with a library to avoid using the C-extensions when on a host with `oslogin` enabled.\r\n\r\nhttps:\/\/gist.github.com\/yacn\/15256fbfd7a4ec19568f009e4a0255c7","@yacn nice trick. It ended up speeding my migration to [teleport](https:\/\/goteleport.com\/) on my side :)"],"labels":["Status: Needs Replication","Platform: GCP","Status: Needs JIRA"]},{"title":"Chef-client is failing because longer cookbook name","body":"We are seeing the following error when executing test_int_server_services_cookbook cookbook on AIX. \r\n\r\n================================================================================\r\nChef encountered an error attempting to load the node data for \"node_name\"\r\n================================================================================\r\nUnexpected Error:\r\n-----------------\r\nChef::PolicyBuilder::Policyfile::ConfigurationError: Error loading policyfile from `policy_groups\/local\/policies\/test_int_server_services_cookbook': Net::HTTPServerException - 404 \"Not Found\"\r\nSystem Info:\r\n------------\r\nchef_version=16.6.14\r\nruby=ruby 2.7.2p137 (2020-10-01 revision 5445e04352) [powerpc-aix7.1.5.0]\r\nprogram_name=\/usr\/bin\/chef-client\r\nexecutable=\/opt\/chef\/bin\/chef-client\r\n\r\nThe test_int_server_services_cookbook cookbook works fine on Linux.\r\n\r\nNote If customer rename the cookbook to shorter name  test_services_cb then the chef-client runlist cookbook.\r\n\r\n*To Reproduce*\r\nOS Version: AIX 7.2\r\n\r\nChef Client: 16.6.14\r\n\r\nCreate the cookbook name similar :  test_int_server_services_cookbook \r\n\r\nRun the chef-client --local-mode --chef-license accept\r\n\r\n*Expected behavior*\r\n\r\nIt should apply the cookbook changes in the chef-client run .\r\n\r\n*Actual behavior*\r\n\r\nChef-client is failing because cookbook longer name (test_int_server_services_cookbook)\r\n\r\n","comments":["Needs replication - tested on Windows and Linux and cannot reproduce. ","One question - can someone extract out the full path to the filename in the local-mode cache? There is a small chance this is hitting an absolute filename limit on AIX"],"labels":["Status: Needs Replication"]},{"title":"ifconfig resource doesn't work on MacOS","body":"## Description\r\nifconfig on MacOS doesn't have --version option so ifconfig resource asks to install net-tools (it doesn't exist on Mac)\r\nhttps:\/\/github.com\/chef\/chef\/commit\/a073871748ea5d93b4f39d517447e56c6801414b\r\n\r\n## Chef Version\r\n14\r\n\r\n## Platform Version\r\nSystem Info:\r\n------------\r\nchef_version=14.0.202\r\nplatform=macos\r\nplatform_version=12.0.1\r\nruby=ruby 2.5.1p57 (2018-03-29 revision 63029) [x86_64-darwin15]\r\nprogram_name=\/usr\/local\/bin\/chef-client\r\nexecutable=\/opt\/chef\/bin\/chef-client\r\n\r\n\r\n## Replication Case\r\nUse ifconfig resource on MacOS\r\n\r\n## Client Output\r\n\r\nRuntimeError\r\n\r\nnet-tools not found - this is required for ifconfig\r\n\r\nResource Declaration:\r\n\r\nIn \/var\/chef\/cache\/cookbooks\/ph_network_mac\/recipes\/ipsec.rb\r\n\r\nifconfig OWN_IP do\r\n  device \"bridge0\"\r\n  mask \"255.255.255.0\"\r\n   onboot \"yes\"\r\n  notifies :run, \"execute[add route 10.0.0.0\/8]\", :immediately\r\nend\r\n\r\n\r\n\r\n","comments":["https:\/\/github.com\/chef\/chef\/blob\/cb0f07953e14bc4614beb90f69ba66483fea264c\/lib\/chef\/provider\/ifconfig.rb#L57-L62","Yuriy, we will triage this but we expect this to be corrected in the current release of Chef (Chef-18\/Chef-17, but NOT Chef-14)","Yes, sure, I understand. I just wanted to report that there is a bug in the upstream. Thanks!"],"labels":["Type: Bug","Focus: Desktop"]},{"title":"apt: Chef will install unrequested packages if the requested package is absent and has a pattern-like name","body":"## Description\r\n\r\nIf the `lua5.3` package is not available from the configured archives then this stanza will cause Chef to attempt to install every apt package which substring-matches \"lua5.3\" as a regex (and which matches the version):\r\n\r\n```rb\r\npackage 'lua5.3' do\r\n    version '5.3.3-1.1ubuntu2'\r\nend\r\n```\r\n\r\nWith the default Ubuntu archives, this is the failure mode (but our internal archives are filtered, so we actually saw Chef perform installations of incorrect packages, as all of the pattern-selected packages did have the requested version):\r\n\r\n```\r\n---- Begin output of [\"apt-get\", \"-q\", \"-y\", \"--allow-downgrades\", \"-o\", \"Dpkg::Options::=--force-confdef\", \"-o\", \"Dpkg::Options::=--force-confold\", \"install\", \"lua5.3=5.3.3-1.1ubuntu2\"] ----\r\nSTDOUT: Reading package lists...\r\nBuilding dependency tree...\r\nReading state information...\r\nSTDERR: E: Version '5.3.3-1.1ubuntu2' for 'lua5.3-rrd' was not found\r\nE: Version '5.3.3-1.1ubuntu2' for 'lua5.3-rrd-dev' was not found\r\n---- End output of [\"apt-get\", \"-q\", \"-y\", \"--allow-downgrades\", \"-o\", \"Dpkg::Options::=--force-confdef\", \"-o\", \"Dpkg::Options::=--force-confold\", \"install\", \"lua5.3=5.3.3-1.1ubuntu2\"] ----\r\nRan [\"apt-get\", \"-q\", \"-y\", \"--allow-downgrades\", \"-o\", \"Dpkg::Options::=--force-confdef\", \"-o\", \"Dpkg::Options::=--force-confold\", \"install\", \"lua5.3=5.3.3-1.1ubuntu2\"] returned 100\r\n```\r\n\r\nThe expected failure mode is:\r\n\r\n```\r\n  * apt_package[lua5.3] action install\r\n    * No candidate version available for lua5.3\r\n```\r\n\r\n## Chef Version\r\n\r\n```\r\n# chef-client --version\r\nChef Infra Client: 18.0.92\r\n```\r\n\r\n## Platform Version\r\n\r\nUbuntu 20.04\r\n\r\n## Replication Case\r\n\r\nRunning this recipe on a fresh 20.04 node reproduces the incorrect failure mode:\r\n\r\n```\r\nexecute 'disable_universe' do\r\n    command \"sed -i '\/universe\/d' \/etc\/apt\/sources.list\"\r\nend\r\n\r\napt_update\r\n\r\npackage 'lua5.3' do\r\n    version '5.3.3-1.1ubuntu2'\r\nend\r\n```\r\n\r\n## Client Output\r\n\r\nRelevant sections pasted inline above.\r\n\r\n## Stacktrace\r\n\r\nhttps:\/\/gist.github.com\/OddBloke\/a9680e4f91556c0b30f7e260a1de83df","comments":["I've spent some time investigating this, and I believe that the issue is that `apt-cache showpkg` will treat its arguments as `apt-get` does, including treating strings with pattern characters as patterns if the string is not a package name.\r\n\r\nchef-client calls it to determine if a package is virtual, and therefore needs handling differently: https:\/\/github.com\/chef\/chef\/blob\/f9f2b6fb6b4c6da3584bffe6880dfec25328c489\/lib\/chef\/provider\/package\/apt.rb#L219\r\n\r\nHowever, the code there assumes that `showpkg` will return a single package: this is not the case when `showpkg` is called with a pattern:\r\n\r\n```\r\n# apt-cache showpkg lua5.3 | grep Package:\r\nPackage: liblua5.3-dev\r\nPackage: liblua5.3-0-dbg\r\nPackage: liblua5.3-0\r\nPackage: lua5.3-rrd\r\nPackage: lua5.3-rrd-dev\r\n```\r\n\r\nSo: instead of detecting that `lua5.3` is not available, and erroring out, `chef` proceeds to attempt installation of the absent package (and then apt-get does the _same_ pattern matching, resulting in the incorrect failure mode because lua5.3-rrd isn't built from the same source package and so does not have the same version).","There are two potential solutions here:\r\n\r\n* if the `APT::Cmd::Pattern-Only` configuration option is set to true, then `apt-cache showpkg` does not parse `lua5.3` as a pattern (because that config means that only a total '^...$' match will be treated as a regex)\r\n* if the package being passed to `apt-cache showpkg` is wrapped in `^...$` then it will match the package name explicitly\r\n\r\nBoth of these would mean that `lua5.3` would correctly not be found, resulting in the correct error message being emitted.\r\n\r\nI'm planning to submit a PR for the latter: not all `apt` versions in supported Debian\/Ubuntu releases have the configuration option, so the former is a less universal fix.","There is a PR against this issue that requires some feedback\/update from @OddBloke. Can you please add your thoughts when you have a moment?","https:\/\/chefio.atlassian.net\/browse\/CHEF-1947 - This issue is planned to be looked into in this PI (Between May - July'23)"],"labels":["Status: Incomplete","Status: Adopted","Triage: Confirmed"]},{"title":"Knife: Bootstrap command does not recognise pem file for authentication(Ubuntu 22.04 LTS)","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nI am trying to bootstrap an ec2 ubuntu-22.04 instance like : `knife bootstrap ec2-18-222-21-218.us-east-2.compute.amazonaws.com -U ubuntu -i ~\/Downloads\/kasif-node.pem --sudo -N node1` .\r\nBut it is not authenticating via the pem file and is prompting for password and hence the bootstrap fails. \r\n(Note: the pem file is correct and i can ssh via it)\r\n\r\n## Chef Version\r\n\r\n<img width=\"500\" alt=\"Screenshot 2022-05-27 at 11 16 24 AM\" src=\"https:\/\/user-images.githubusercontent.com\/91519463\/170637935-78a0b515-ceda-4da7-8c3e-81b7354d7fa6.png\">\r\n\r\n\r\n## Platform Version\r\nUbuntu 22.04 LTS\r\n\r\n## Replication Case\r\n1. Launch an ec2 Ubuntu 22.04 LTS instance\r\n2. Try bootstrapping the instance with the pem file you used to launch the instance\r\n\r\n## Stacktrace\r\n![Screenshot 2022-05-24 at 2 01 56 PM](https:\/\/user-images.githubusercontent.com\/91519463\/170638307-50d84705-4abc-4e67-b861-cc84fab92a9c.png)\r\n\r\n## Alternative\r\nIf you really have to bootstrap Ubuntu 22.04 instance, then you can ssh in to the instance and set a password and use it in the knife bootstrap command\r\n\r\n## Note\r\nThis issue only exists with Ubuntu 22.04\r\nIt works as expected on Ubuntu 18 and Ubuntu 20","comments":["@kasif-adnan - can you confirm that you can directly ssh into that node and that works as expected? Can you also verify that this is the only key in your ssh cache? We want to eliminate some old crusty key being used accidentally.","I can confirm the same issue for latest chef version. Direct ssh into instance with this key works without any problems.\r\nsshd server log has following details:\r\n`sshd[2090]: userauth_pubkey: key type ssh-rsa not in PubkeyAcceptedAlgorithms [preauth]`","This is related to the net-ssh gem update to support the new ssh key algorithm changes for the latest RHEL 9+ and Ubuntu 22.04+ This will be resolved once this PR is merged #13338 for chef-client 18.x.x. Chef-client 17 is also getting a backport with PR #13332."],"labels":["Triage: Needs Information","Status: Needs Replication"]},{"title":"Chef::RunList.delete appears to implement delete_if, breaking Ruby::Array implementation","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nRuby::Array.delete always acts on itself, and only returns deleted items, returning nil if no deletion occurred.  Chef::RunList.delete acts on itself, but internally implements delete_if, always returning self regardless of operation.\r\n\r\nFundamentally this is a mis-implementation of Array.delete_if as RunList.delete.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nknife 17.4.38\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nUbuntu 21.10\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n```\r\nknife exec -E 'nodes.transform(\"hostname:*\"){|n| if n.run_list.delete(\"role[this_role_does_not_exist]\"); then puts \"deleted nonexistent role from node \" + n.name.to_s; end; }'\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\nRelevant output is that it will tell you it updated every single run_list, when that is not actually true.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":[],"labels":["Status: Needs Replication","Status: Needs JIRA"]},{"title":"win32-certstore updates broke the windows_certificate resource","body":"## Description\r\n\r\nrecently `win32-certstore` was [updated in the chef Gemfile.lock from v0.6.2 to v0.6.10][1]. The MINOR release (semver) of `win32-certstore` has a backwards incompatible change and should have been released as a major version change. The API change caused downstream problems to chef.\r\n\r\n[CI job with details][2]\r\n\r\n## Chef Version\r\n\r\nmain branch\r\n\r\n## Platform Version\r\n\r\nWindows 2019 and 2022\r\n\r\n## Replication Case\r\n\r\nUse `windows_certificate` from main branch build of chef infra client.\r\n\r\n## Client Output\r\n\r\n```text\r\n  * windows_certificate[c:\/mordor\/steveb.pfx] action create\r\n    \r\n    ================================================================================\r\n    Error executing action `create` on resource 'windows_certificate[c:\/mordor\/steveb.pfx]'\r\n    ================================================================================\r\n    \r\n    ArgumentError\r\n    -------------\r\n    wrong number of arguments (given 2, expected 1)\r\n    \r\n    Resource Declaration:\r\n    ---------------------\r\n    # In C:\/Users\/runneradmin\/.chef\/local-mode-cache\/cache\/cookbooks\/end_to_end\/recipes\/windows.rb\r\n    \r\n    164: windows_certificate \"c:\/mordor\/steveb.pfx\" do\r\n    165:   sensitive false # For debugging\r\n    166:   pfx_password \"1234\"\r\n    167:   action :create\r\n    168:   user_store true\r\n    169:   store_name \"MY\"\r\n    170: end\r\n    171: \r\n    \r\n    Compiled Resource:\r\n    ------------------\r\n    # Declared in C:\/Users\/runneradmin\/.chef\/local-mode-cache\/cache\/cookbooks\/end_to_end\/recipes\/windows.rb:164:in `from_file'\r\n    \r\n    windows_certificate(\"c:\/mordor\/steveb.pfx\") do\r\n      action [:create]\r\n      default_guard_interpreter :default\r\n      declared_type :windows_certificate\r\n      cookbook_name \"end_to_end\"\r\n      recipe_name \"windows\"\r\n      sensitive false\r\n      pfx_password \"1234\"\r\n      user_store true\r\n      store_name \"MY\"\r\n      source \"c:\/mordor\/steveb.pfx\"\r\n    end\r\n    \r\n    System Info:\r\n    ------------\r\n    chef_version=18.0.94\r\n    platform=windows\r\n    platform_version=10.0.20348\r\n    ruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x64-mingw32]\r\n    program_name=C:\/opscode\/chef\/bin\/chef-client\r\n    executable=C:\/opscode\/chef\/bin\/chef-client\r\n```\r\n\r\n## Stacktrace\r\n\r\n```text\r\n[2022-05-12T00:10:13+00:00] FATAL: ArgumentError: windows_certificate[c:\/mordor\/steveb.pfx] (end_to_end::windows line 164) had an error: ArgumentError: wrong number of arguments (given 2, expected 1)\r\nGenerated at 2022-05-12 00:10:13 +0000\r\nArgumentError: windows_certificate[c:\/mordor\/steveb.pfx] (end_to_end::windows line 164) had an error: ArgumentError: wrong number of arguments (given 2, expected 1)\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/win32-certstore-0.6.10\/lib\/win32\/certstore.rb:120:in `valid?'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource\/windows_certificate.rb:281:in `verify_cert'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource\/windows_certificate.rb:488:in `block in import_certificates'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource\/windows_certificate.rb:482:in `each'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource\/windows_certificate.rb:482:in `import_certificates'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource\/windows_certificate.rb:103:in `block in <class:WindowsCertificate>'\r\n(eval):2:in `block in action_create'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/provider.rb:304:in `instance_eval'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/provider.rb:304:in `compile_and_converge_action'\r\n(eval):2:in `action_create'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/provider.rb:245:in `run_action'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource.rb:601:in `block in run_action'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource.rb:628:in `with_umask'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource.rb:600:in `run_action'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/runner.rb:74:in `run_action'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/runner.rb:108:in `block in run_all_actions'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/runner.rb:108:in `each'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/runner.rb:108:in `run_all_actions'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/runner.rb:132:in `block in converge'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource_collection\/resource_list.rb:96:in `block in execute_each_resource'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:114:in `call_iterator_block'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:85:in `step'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:103:in `iterate'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:54:in `each_with_index'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/resource_collection\/resource_list.rb:94:in `execute_each_resource'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/3.0.0\/forwardable.rb:238:in `execute_each_resource'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/runner.rb:130:in `converge'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/client.rb:788:in `block in converge'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/client.rb:783:in `catch'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/client.rb:783:in `converge'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/client.rb:807:in `converge_and_save'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/client.rb:289:in `run'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/application.rb:264:in `run_chef_client'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/application\/base.rb:352:in `run_application'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-18.0.94-universal-mingw32\/lib\/chef\/application.rb:67:in `run'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-bin-18.0.94\/bin\/chef-client:25:in `<top (required)>'\r\nC:\/opscode\/chef\/bin\/chef-client:197:in `load'\r\nC:\/opscode\/chef\/bin\/chef-client:197:in `<main>'\r\n```\r\n\r\n[1]: https:\/\/github.com\/chef\/chef\/commit\/912a6a461e7be743431aeb22f68db11e90c5865f\r\n[2]: https:\/\/github.com\/chef\/chef\/runs\/6397725450?check_suite_focus=true","comments":["hi - could you kindly update the latest status on this issue? We see similar err from Chef v16.16.13 when trying to grant read-only permission to service account for private key. Thank you.\r\n\r\nwindows_certificate 'C:\\temp\\test.pfx' do\r\n  pfx_password         'test_password'\r\n  private_key_acl      [\"domain\\svc_acct\"]\r\nend\r\n\r\n>>>  .. action create (up to date) #without pk read-only permission granted\r\n\r\nwindows_certificate 'C:\\temp\\test.pfx' do\r\n  pfx_password         'test_password'\r\n  private_key_acl      [\"domain\\svc_acct\"]\r\n  action :acl_add\r\nend\r\n\r\n>>> [2023-02-10T03:12:12+00:00] FATAL: ArgumentError: windows_certificate[C:\\temp\\test.pfx] (cookbook::default line 1) had an error: ArgumentError: wrong number of arguments (given 2, expected 1)\r\n","Sorry for the delay in responding to this issue, The original issue has since been fixed in the [win32_certstore](https:\/\/github.com\/chef\/win32-certstore\/commit\/93ae085c1e035b23b5e59380f5de09dc3f07480c) repo.\r\n[Chef-18](https:\/\/www.chef.io\/downloads\/tools\/infra-client?v=18.1.0) uses 0.6.15 of win32-certstore that contains the fix.\r\nChef-17 is currently in works for getting shaped up for a release, the upcoming release will contain the fix for the issue.\r\nWe do not have an exact date for the release of Chef-17 yet."],"labels":["Type: Bug","Platform: Windows","Status: Adopted","Backport: 16","Backport: 17"]},{"title":"gem_package reports gem as installed when it is not.","body":"## Description\r\nI'm trying to install a gem with chef via `gem_package` but fail to do so on Ubuntu 22.04\r\n\r\n## Chef Version\r\n22.5.923\r\n\r\n## Platform Version\r\nUbuntu 22.04\r\n\r\n## Replication Case\r\nI have the following code in one of my recipes:\r\n\r\n```ruby\r\ngem_package \"bcrypt_pbkdf\" do\r\n    gem_binary \"\/usr\/bin\/gem\"\r\n    version \"~>1.1\"\r\n    action :install\r\nend\r\n```\r\n\r\n## Client Output\r\n\r\nThe gem is installed according to chef:\r\n\r\n```\r\n    lin-vm:   * gem_package[bcrypt_pbkdf] action install[2022-05-11T17:21:27+00:00] INFO: Processing gem_package[bcrypt_pbkdf] action install (lin-vm::ruby_gems line 20)\r\n    lin-vm: [2022-05-11T17:21:27+00:00] DEBUG: gem_package[bcrypt_pbkdf] is already installed - nothing to do\r\n    lin-vm:  (up to date)\r\n```\r\n\r\nBut checking for it shows that it is not there:\r\n\r\n```bash\r\nvagrant@test-vm:~$ gem list\r\n\r\n*** LOCAL GEMS ***\r\n\r\nabbrev (default: 0.1.0)\r\nbase64 (default: 0.1.0)\r\nbenchmark (default: 0.1.1)\r\nbigdecimal (default: 3.0.0)\r\nbundler (default: 2.2.22)\r\ncgi (default: 0.2.0)\r\ncsv (default: 3.1.9)\r\ndate (default: 3.1.0)\r\ndbm (default: 1.1.0)\r\ndebug (default: 0.1.0)\r\ndelegate (default: 0.2.0)\r\ndid_you_mean (default: 1.5.0)\r\ndigest (default: 3.0.0)\r\ndrb (default: 2.0.4)\r\nenglish (default: 0.7.1)\r\nerb (default: 2.2.0)\r\netc (default: 1.2.0)\r\nfcntl (default: 1.0.0)\r\nfiddle (default: 1.0.6)\r\nfileutils (default: 1.5.0)\r\nfind (default: 0.1.0)\r\nforwardable (default: 1.3.2)\r\ngdbm (default: 2.1.0)\r\ngetoptlong (default: 0.1.1)\r\nio-console (default: 0.5.7)\r\nio-nonblock (default: 0.1.0)\r\nio-wait (default: 0.1.0)\r\nipaddr (default: 1.2.2)\r\nirb (default: 1.3.5)\r\njson (default: 2.5.1)\r\nlogger (default: 1.4.3)\r\nmatrix (default: 0.3.1)\r\nminitest (5.14.2)\r\nmutex_m (default: 0.1.1)\r\nnet-ftp (default: 0.1.2)\r\nnet-http (default: 0.1.1)\r\nnet-imap (default: 0.1.1)\r\nnet-pop (default: 0.1.1)\r\nnet-protocol (default: 0.1.0)\r\nnet-smtp (default: 0.2.1)\r\nnet-telnet (0.1.1)\r\nnkf (default: 0.1.0)\r\nobserver (default: 0.1.1)\r\nopen-uri (default: 0.1.0)\r\nopen3 (default: 0.1.1)\r\nopenssl (default: 3.0.0)\r\noptparse (default: 0.1.0)\r\nostruct (default: 0.3.1)\r\npathname (default: 0.1.0)\r\npower_assert (1.2.0)\r\npp (default: 0.1.0)\r\nprettyprint (default: 0.1.0)\r\nprime (default: 0.1.2)\r\npstore (default: 0.1.1)\r\npsych (default: 3.3.0)\r\nracc (default: 1.5.1)\r\nrake (13.0.6, 13.0.3)\r\nrbs (1.0.4)\r\nrdoc (default: 6.3.1)\r\nreadline (default: 0.0.2)\r\nreadline-ext (default: 0.1.1)\r\nreline (default: 0.2.5)\r\nresolv (default: 0.2.0)\r\nresolv-replace (default: 0.1.0)\r\nrexml (3.2.5)\r\nrinda (default: 0.1.0)\r\nrss (0.2.9)\r\nrubygems-update (3.3.5)\r\nsecurerandom (default: 0.1.0)\r\nset (default: 1.0.1)\r\nshellwords (default: 0.1.0)\r\nsingleton (default: 0.1.1)\r\nstringio (default: 3.0.0)\r\nstrscan (default: 3.0.0)\r\nsyslog (default: 0.1.0)\r\ntempfile (default: 0.1.1)\r\ntest-unit (3.3.7)\r\ntime (default: 0.1.0)\r\ntimeout (default: 0.1.1)\r\ntmpdir (default: 0.1.2)\r\ntracer (default: 0.1.1)\r\ntsort (default: 0.1.0)\r\ntypeprof (0.12.0)\r\nun (default: 0.1.0)\r\nuri (default: 0.10.1)\r\nweakref (default: 0.1.1)\r\nxmlrpc (0.3.2)\r\nyaml (default: 0.1.1)\r\nzlib (default: 1.1.0)\r\n```\r\n\r\nThis issue appears with all gems that I try to install. Chef reports them to be already installed, but they are actually not there.\r\n\r\nAny suggestions as to what could be the issue?\r\n","comments":["Digging a bit further I found my gems to be installed here: `\/root\/.chefdk\/gem\/ruby\/3.0.0\/gems` with binaries linked to `\/root\/.chefdk\/gem\/ruby\/3.0.0\/bin\/`\r\n\r\nBut I would expect them to be installed here: `\/var\/lib\/gems\/3.0.0\/gems\/` and the binaries in `\/usr\/local\/bin\/`","Could you let us know if you are trying to run chef-client from workstation when you see this error or is there a separate install of chef-client, if so what is the version of chef-client that is being run on the system? \r\n\r\nHave you tried nuking the `\/root\/.chefdk` directory?","Hi @PrajaktaPurohit\r\n\r\nI'm running chef-client from my chef-workstation installation. The version of chef-client is the one shipped with workstation `22.5.923`.\r\n\r\nClearing the `\/root\/.chefdk\/` directory unfortunately did not work. The next chef run installed the gems again into this directory instead of to `\/var\/lib\/gems`.","chef-17.10.0 is the version of chef that is installed with workstation 22.5.923.","@fasmat Can you check both the Gem Path and the hard drive more broadly to see if that gem is lying around somewhere else? I'm curious why chef reports it installed but gem list isn't showing it. This is a new issue so we're a bit confused.","@johnmccrae\r\n\r\ninformation about used chef versions:\r\n\r\n```bash\r\nvagrant@test-vm:~$ chef --version\r\nChef Workstation version: 22.5.923\r\nTest Kitchen version: 3.2.2\r\nCookstyle version: 7.32.1\r\nChef Infra Client version: 17.10.0\r\nChef InSpec version: 4.56.20\r\nChef CLI version: 5.6.1\r\nChef Habitat version: 1.6.420\r\n```\r\n\r\nmy `gem environment` looks like this:\r\n\r\n```bash\r\nvagrant@test-vm:~$ sudo gem environment\r\nRubyGems Environment:\r\n  - RUBYGEMS VERSION: 3.3.5\r\n  - RUBY VERSION: 3.0.2 (2021-07-07 patchlevel 107) [x86_64-linux-gnu]\r\n  - INSTALLATION DIRECTORY: \/var\/lib\/gems\/3.0.0\r\n  - USER INSTALLATION DIRECTORY: \/root\/.local\/share\/gem\/ruby\/3.0.0\r\n  - RUBY EXECUTABLE: \/usr\/bin\/ruby3.0\r\n  - GIT EXECUTABLE: \/usr\/bin\/git\r\n  - EXECUTABLE DIRECTORY: \/usr\/local\/bin\r\n  - SPEC CACHE DIRECTORY: \/root\/.local\/share\/gem\/specs\r\n  - SYSTEM CONFIGURATION DIRECTORY: \/etc\r\n  - RUBYGEMS PLATFORMS:\r\n     - ruby\r\n     - x86_64-linux\r\n  - GEM PATHS:\r\n     - \/var\/lib\/gems\/3.0.0\r\n     - \/root\/.local\/share\/gem\/ruby\/3.0.0\r\n     - \/usr\/local\/lib\/ruby\/gems\/3.0.0\r\n     - \/usr\/lib\/ruby\/gems\/3.0.0\r\n     - \/usr\/lib\/x86_64-linux-gnu\/ruby\/gems\/3.0.0\r\n     - \/usr\/share\/rubygems-integration\/3.0.0\r\n     - \/usr\/share\/rubygems-integration\/all\r\n     - \/usr\/lib\/x86_64-linux-gnu\/rubygems-integration\/3.0.0\r\n  - GEM CONFIGURATION:\r\n     - :update_sources => true\r\n     - :verbose => true\r\n     - :backtrace => false\r\n     - :bulk_threshold => 1000\r\n  - REMOTE SOURCES:\r\n     - https:\/\/rubygems.org\/\r\n  - SHELL PATH:\r\n     - \/usr\/local\/sbin\r\n     - \/usr\/local\/bin\r\n     - \/usr\/sbin\r\n     - \/usr\/bin\r\n     - \/sbin\r\n     - \/bin\r\n     - \/snap\/bin\r\n```\r\n\r\n`gem_package` will install gems to `\/root\/.chefdk` even if `gem list` already lists those gems. It seems to completely ignore GEM PATHS and only check this location.\r\n\r\nI temporarily fixed my issue by replacing the following code in my recipe:\r\n\r\n```ruby\r\ngem_package \"bcrypt_pbkdf\" do\r\n    gem_binary \"\/usr\/bin\/gem\"\r\n    version \"~>1.1\"\r\n    action :install\r\nend\r\n```\r\n\r\nwith\r\n\r\n```ruby\r\nexecute \"installing gem bcrypt_pbkdf\" do\r\n    command \"gem install bcrpt_pbkdf --version '~>1.1'\"\r\n    not_if \"gem list bcrypt_pbkdf -i -v '~>1.1'\"\r\nend\r\n```\r\n\r\nwhich does exactly what I want to do: install a gem system wide for all users unless it is already installed."],"labels":["Triage: Needs Information","Status: Waiting on Contributor"]},{"title":"apt package version with wildcards doesn't work in version 17","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nIn version 15 of the chef client, I could do something like:\r\n\r\n```ruby\r\npackage \"mysql-client\" do\r\n  version \"5.7.*\"\r\nend\r\n```\r\nAnd it would  constrain the version of `mysql-client` to 5.7.*. However, in version 17 if I do this, I get  an error for: \"\"No version specified, and no candidate version available for mysql-client\" if it is already installed. Or \"No candidate version available for mysql-client\" if it isn't installed yet.\r\n\r\nIt seems that the provider is now checking that the version supplied matches one of the versions listed in `apt policy <pkg>` and doesn't account for wildcards.\r\n\r\n(Note this is running in ubuntu)\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n17.10.0\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nUbuntu 20.04\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\nOn an Ubuntu 20.04 box add the following apt repository:\r\n```\r\ndeb      [arch=amd64] http:\/\/repo.mysql.com\/apt\/ubuntu\/ bionic mysql-5.7\r\n```\r\n\r\nand run `apt update`. \r\n\r\nthen in a minimal chef setup create a recipe that includes:\r\n\r\n```\r\npackage \"mysql-client\" do\r\n  version \"5.7.*\"\r\nend\r\n\r\n```\r\n\r\nThen run with `chef-solo`. \r\n\r\n\r\n\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\nhttps:\/\/gist.github.com\/tmccombs\/fea9d6415e74957ee4c2a924be14023c\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n\r\n\r\nthe stacktrace file is empty. I'm not really sure why\r\n","comments":["You can see the logic here: https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/provider\/package\/apt.rb#L207. The list of valid versions are from `apt-cache policy` and the comparison is exact match.","Sure but in chef 16, using a wildcard works. And using a wildcard on the apt command line works with a wildcard. "],"labels":["Type: Bug","Status: Needs Replication"]},{"title":"AIX Chef Client 16.17.51 - 17.10.3 libarchive not found ffi-libarchive failure","body":"Internal issue [CHEF-644](https:\/\/chefio.atlassian.net\/browse\/CHEF-644)\r\n\r\n## Description\r\n\r\nSeeing below when testing Chef Infra Client: 16.17.51 on AIX (7.1 and 7.2) and it happens on all later chef-client versions tested as well\r\n\r\n```\r\nhostfoo # oslevel\r\n7.2.0.0\r\n\r\nhostfoo # chef-client --version\r\nffi-libarchive could not be loaded, libarchive is probably not installed on system, archive_file will not be available\r\nChef Infra Client: 16.17.51\r\n```\r\n\r\n## Replication Case\r\n\r\nSteps to reproduce the behaviour.\r\n\r\nStart chef-client 16, 17, 18 on An AIX 7.1 or 7.2 system.\r\nThe client will fail while trying to load the libarchive library that supports the `archive_file` resource\r\n\r\n## Client Output\r\n\r\n```\r\nbash-5.1# chef-client --version\r\n[2022-04-01T08:02:02-05:00] WARN: Please install an English UTF-8 locale for Chef to use, falling back to C locale and disabling UTF-8 support.\r\nChef: 14.15.6\r\n\r\nbash-5.1# chef-client --version\r\nChef Infra Client: 15.17.4\r\n\r\nbash-5.1# chef-client --version\r\nffi-libarchive could not be loaded, libarchive is probably not installed on system, archive_file will not be available\r\nChef Infra Client: 16.17.51\r\n\r\nbash-5.1# chef-client --version\r\nffi-libarchive could not be loaded, libarchive is probably not installed on system, archive_file will not be available\r\nChef Infra Client: 17.10.3\r\n\r\nbash-5.1# chef-client --version\r\nffi-libarchive could not be loaded, libarchive is probably not installed on system, archive_file will not be available\r\nChef Infra Client: 18.0.54\r\n\r\n```\r\n\r\n**Expected behavior**\r\n\r\n`archive_file` resource - https:\/\/docs.chef.io\/resources\/archive_file\/ - should work on all supported versions as outlined (see https:\/\/docs.chef.io\/platforms\/  and https:\/\/docs.chef.io\/versions\/)\r\n\r\n\r\n**Actual behavior**\r\n\r\n`archive_file` resource - https:\/\/docs.chef.io\/resources\/archive_file\/ - does not work on all supported versions, in this case namely AIX platform and chef-client 16.x, 17.x and 18.x\r\n\r\n**Associated GitHub Issue**\r\n\r\nhttps:\/\/github.com\/chef\/omnibus-software\/issues\/1566\r\n\r\n## Chef Version\r\nchef-client 16.x, 17.x and 18.x\r\n\r\n## Platform Version\r\nAIX (7.1 and 7.2)\r\n\n\n[CHEF-644]: https:\/\/chefio.atlassian.net\/browse\/CHEF-644?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","comments":["@sean-horn do we know for a fact that `15.17.4` works (making sure I'm reading the description correctly)? I'm looking to analyze diffs involved and want to confirm that I'm not comparing two bad versions.","Working on building the latest libarchive and it appears that it does not symlink to libarchive.so for AIX. Still researching why it breaks.","I built the [3.6.2 release version of libarchive](https:\/\/github.com\/libarchive\/libarchive\/releases\/tag\/v3.6.2) and built the following code\r\n\r\n```c\r\n#include \"..\/libarchive-3.6.2\/libarchive\/archive.h\"\r\n\r\n\r\nint main(int argc, char **argv) {\r\n        struct archive *a;\r\n        struct archive_entry *entry;\r\n        int r;\r\n\r\n        a = archive_read_new();\r\n        archive_read_support_filter_all(a);\r\n        archive_read_support_format_all(a);\r\n        r = archive_read_open_filename(a, \"archive.tar\", 10240); \/\/ Note 1\r\n        if (r != ARCHIVE_OK)\r\n          exit(1);\r\n\r\n        while (archive_read_next_header(a, &entry) == ARCHIVE_OK) {\r\n          printf(\"%s\\n\",archive_entry_pathname(entry));\r\n          archive_read_data_skip(a);  \/\/ Note 2\r\n        }\r\n        r = archive_read_free(a);  \/\/ Note 3\r\n        if (r != ARCHIVE_OK)\r\n          exit(1);\r\n}\r\n```\r\n\r\nAnd built it successfully with `cc -qlanglvl=extc1x test.c -o test ..\/libarchive-3.6.2\/.libs\/libarchive.a` after trying the other files in the `.libs` folder of `libarchive-3.6.2` and successfully built and loaded the library, and the executable was able to open an `archive.tar` in same directory."],"labels":["Type: Bug","Status: Adopted","Triage: Confirmed","Backport: 16","Backport: 17"]},{"title":"Locale resource executes locale-gen on every run","body":"## Description\r\nThe `locale` resource unnecessarily executes `locale-gen` on every chef run, which can be very costly on some systems.\r\n\r\nThis is caused by `define_resource_requirements` checking whether `locale-gen` is available by doing the following:\r\n\r\n```ruby\r\nrequirements.assert(:all_actions) do |a|\r\n  # RHEL\/CentOS type platforms don't have locale-gen\r\n  a.assertion { shell_out(\"locale-gen\") }\r\n  a.failure_message(Chef::Exceptions::ProviderNotFound, \"The locale resource requires the locale-gen tool\")\r\nend\r\n```\r\n\r\nThis is causing locale-gen to be executed, regenerating all installed locales on every Chef run.\r\n\r\n## Chef Version\r\n17.x\r\n\r\n## Platform Version\r\nUbuntu 20.04 LTS\r\n\r\n## Replication Case\r\n\r\nExecute `locale` resource like so:\r\n\r\n```\r\n  locale 'set locale' do\r\n    lang 'en_US.UTF-8'\r\n  end\r\n```\r\n\r\n## Client Output\r\n\r\n```\r\n[2022-04-29T08:38:57+00:00] DEBUG: Converging node log-ingest1.example.com\r\nRecipe: lsw-base::locale\r\n  * locale[set locale] action update[2022-04-29T08:38:57+00:00] INFO: Processing locale[set locale] action update (lsw-base::locale line 13)\r\nGenerating locales (this might take a while)...\r\n  en_AG.UTF-8... done\r\n  en_AU.UTF-8... done\r\n  en_BW.UTF-8... done\r\n  en_CA.UTF-8... done\r\n  en_DK.UTF-8... done\r\n  en_GB.UTF-8... done\r\n  en_HK.UTF-8... done\r\n  en_IE.UTF-8... done\r\n  en_IL.UTF-8... done\r\n  en_IN.UTF-8... done\r\n  en_NG.UTF-8... done\r\n  en_NZ.UTF-8... done\r\n  en_PH.UTF-8... done\r\n  en_SG.UTF-8... done\r\n  en_US.UTF-8... done\r\n  en_ZA.UTF-8... done\r\n  en_ZM.UTF-8... done\r\n  en_ZW.UTF-8... done\r\nGeneration complete.\r\n[2022-04-29T08:39:38+00:00] DEBUG: Skipping update of locale[set locale]: has not changed any of the specified properties lang=\"en_US.UTF-8\", lc_env={}.\r\n (up to date)\r\n```\r\n","comments":["Since all related PR's are merged ( #12833  #12904 #12905 ) and this issue is rather annoying or even causes problems (f.e. with PostgreSQL that suddenly gets its locale files pulled from underneath it on every Chef run), could you please roll a new stable release of infra client 16, 17 and 18 to fix this issue?","@PrajaktaPurohit can you help out?","Chef-16 release https:\/\/www.chef.io\/downloads\/tools\/infra-client?v=16.18.30 should have the fix.\r\nWe are currently in the process of getting the Chef-17 release out that will include the fix.\r\nChef-18 release https:\/\/www.chef.io\/downloads\/tools\/infra-client?v=18.0.185 and later should include the fix"],"labels":["Type: Bug","Backport: 16","Backport: 17"]},{"title":"mdadm (RAID) resource breaks with mdadm version 4.1.12, and higher","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n\r\nIn mdadm version 4.1.12, or higher, creating RAID arrays with metadata 0.90 superblock has been removed.\r\n\r\nWith the mdadm resource set to a 0.90 metadata superblock default:\r\n      * cannot create devices > 2Tb\/4Tb depending on kernel version\r\n      * mdadm version >=3.1.2 uses an implied default of 1.2, not 0.9. So Chef behaves differently than the underlying system API.\r\n\r\nMaybe there was a good reason, such as volume auto-detection on older kernels, or LILO support that this was added in as 0.90 over 10 years ago.\r\n\r\nIn the best case scenario, the default metadata version for the mdadm resource should be `nil`, or unset, to use the implied defaults of the underlying mdadm utility installed on the system. -OR- just update the resource to use the modern mdadm default of `metadata: 1.2`.\r\n\r\n[Kernel.org RAID Reference](https:\/\/raid.wiki.kernel.org\/index.php\/RAID_superblock_formats) for additional background information.\r\n\r\n## Chef Version\r\n\r\nThis bug affects all versions of Chef inclusive from 0.10.10.beta.1 to 18.0.92\r\n\r\n## Platform Version\r\n\r\nThis was discovered to affect Enterprise Linux 8.2+ variants.\r\n\r\n## Replication Case\r\n\r\nGiven the use of the `mdadm` resource,\r\nWhen `metadata: 0.90` is the implied default,\r\nAnd mdadm is version 4.1.12, or higher,\r\nThen there may be unexpected RAID creation failures.\r\n\r\n## Client Output\r\n\r\nThis is example mdadm output on a RHEL 8.x system with an affected version of mdadm. Issue could be worked around by downgrading mdadm.\r\n\r\n```\r\n# mdadm --create \/dev\/md0 --level 0 --chunk=64 --metadata=0.90 --raid-devices 4 \/dev\/sda \/dev\/sdb \/dev\/sdc \/dev\/sdd\r\nmdadm: 0.90 metadata does not support layouts for RAID0\r\n```\r\n\r\n## Stacktrace\r\nn\/a\r\n\r\n## Source Location\r\n\r\n[lib\/chef\/resource\/mdadm.rb#L100](https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource\/mdadm.rb#L100)","comments":[],"labels":["Type: Bug","Priority: Medium","Aspect: Integration","Platform: RHEL-like","Triage: Confirmed","Status: Needs Replication","Backport: 16","Backport: 17"]},{"title":"chef git resource fails when local tags differ from remote","body":"### Describe the Enhancement:\r\nAllow a way to pass optional git parameters to the git resource. In our case, since git 2.20, the default behaviour is not to clobber local tags however this causes a sync to fail on a repo of the remote tags have changed.\r\n\r\n### Describe the Need:\r\nInclude a `force` option that will allow the user to clobber local tags.\r\n\r\n### Current Alternative\r\nOur hacky way of fixing this is to pass the following environment variable along with the git resource:\r\n\r\n``` ruby\r\ngit 'some_directory' do\r\n  repository some_repo\r\n  revision master\r\n  action :sync\r\n  environment ({ 'GIT_CONFIG_PARAMETERS' => \"'remote.origin.fetch=+refs\/tags\/*:refs\/tags\/*'\" })\r\nend\r\n```\r\n\r\n### Can We Help You Implement This?:\r\nI'm pretty new to ruby and chef but happy to give it a shot!\r\n","comments":[],"labels":["Type: Bug","Status: Good First Issue"]},{"title":"`no implicit conversion from nil to integer` when enforcing idempotency in Test-Kitchen","body":"## Description\r\nAttempting to perform multiple converges and enforcing idempotency in Test-Kitchen results in an error:\r\n\r\n```\r\n\/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-bin-17.10.0\/bin\/chef-client:41:in `exit': no implicit conversion from nil to integer (TypeError)\r\n        from \/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-bin-17.10.0\/bin\/chef-client:41:in `<top (required)>'\r\n        from \/opt\/cinc\/bin\/chef-client:160:in `load'\r\n        from \/opt\/cinc\/bin\/chef-client:160:in `<main>'\r\n```\r\n\r\n## Chef Version\r\nCinc 17.10.0\r\n\r\n## Platform Version\r\nCentOS 7\r\n\r\n## Replication Case\r\nGenerate a cookbook, add this resource to the default recipe:\r\n\r\n```ruby\r\nexecute 'hello' do\r\n  command 'echo hello'\r\nend\r\n```\r\n\r\nModify the Chef provisioner to:\r\n\r\n```ruby\r\nprovisioner:\r\n  name: chef_infra\r\n  product_name: chef\r\n  enforce_idempotency: true\r\n  multiple_converge: 2\r\n```\r\n\r\n## Client Output\r\n```\r\nCinc Client, version 17.10.0\r\n       Patents: https:\/\/www.chef.io\/patents\r\n       Infra Phase starting\r\n       Using Policyfile 'multiple-converge' at revision 'eebb2d91e3e1ee59a560bd16f22b535387a62d6b789bd0490840a3f6149690ba'\r\n       Resolving cookbooks for run list: [\"multiple-converge::default@0.1.0 (bf74028)\"]\r\n       Synchronizing cookbooks:\r\n         - multiple-converge (0.1.0)\r\n       Installing cookbook gem dependencies:\r\n       Compiling cookbooks...\r\n       Loading Cinc Auditor profile files:\r\n       Loading Cinc Auditor input files:\r\n       Loading Cinc Auditor waiver files:\r\n       Converging 1 resources\r\n       Recipe: multiple-converge::default\r\n         * execute[hello] action run\r\n           - execute echo hello\r\n\r\n       Running handlers:\r\n       Running handlers complete\r\n       Infra Phase complete, 1\/1 resources updated in 03 seconds\r\n       Redirecting to cinc-client\r\n       Cinc Client, version 17.10.0\r\n       Patents: https:\/\/www.chef.io\/patents\r\n       Infra Phase starting\r\n       Using Policyfile 'multiple-converge' at revision 'eebb2d91e3e1ee59a560bd16f22b535387a62d6b789bd0490840a3f6149690ba'\r\n       Resolving cookbooks for run list: [\"multiple-converge::default@0.1.0 (bf74028)\"]\r\n       Synchronizing cookbooks:\r\n         - multiple-converge (0.1.0)\r\n       Installing cookbook gem dependencies:\r\n       Compiling cookbooks...\r\n       Loading Cinc Auditor profile files:\r\n       Loading Cinc Auditor input files:\r\n       Loading Cinc Auditor waiver files:\r\n       Converging 1 resources\r\n       Recipe: multiple-converge::default\r\n         * execute[hello] action run\r\n           - execute echo hello\r\n\r\n       Running handlers:\r\n       First chef run should have reached a converged state.\r\n       Resources updated in a second chef-client run:\r\n       - execute[hello]\r\n       \/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-bin-17.10.0\/bin\/chef-client:41:in `exit': no implicit conversion from nil to integer (TypeError)\r\n        from \/opt\/cinc\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-bin-17.10.0\/bin\/chef-client:41:in `<top (required)>'\r\n        from \/opt\/cinc\/bin\/chef-client:160:in `load'\r\n        from \/opt\/cinc\/bin\/chef-client:160:in `<main>'\r\nD      Cleaning up local sandbox in C:\/Users\/077009\/AppData\/Local\/Temp\/default-centos-7-sandbox-20220412-32604-v38reu\r\n>>>>>> ------Exception-------\r\n>>>>>> Class: Kitchen::ActionFailed\r\n>>>>>> Message: 1 actions failed.\r\n>>>>>>     Converge failed on instance <default-centos-7>.  Please see .kitchen\/logs\/default-centos-7.log for more details\r\n>>>>>> ----------------------\r\n>>>>>> Please see .kitchen\/logs\/kitchen.log for more details\r\n>>>>>> Also try running `kitchen diagnose --all` for configuration\r\n```\r\n\r\n## Stacktrace\r\n```\r\nD      ------Exception-------\r\nD      Class: Kitchen::ActionFailed\r\nD      Message: 1 actions failed.\r\n>>>>>>     Converge failed on instance <default-centos-7>.  Please see .kitchen\/logs\/default-centos-7.log for more details\r\nD      ----------------------\r\nD      ------Backtrace-------\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:181:in `report_errors'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:172:in `run_action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command\/action.rb:35:in `block in call'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/3.0.0\/benchmark.rb:293:in `measure'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command\/action.rb:33:in `call'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/cli.rb:52:in `perform'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/cli.rb:198:in `block (2 levels) in <class:CLI>'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor\/command.rb:27:in `run'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor\/invocation.rb:127:in `invoke_command'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor.rb:392:in `dispatch'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/thor-1.2.1\/lib\/thor\/base.rb:485:in `start'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/bin\/kitchen:11:in `block in <top (required)>'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/errors.rb:183:in `with_friendly_errors'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/bin\/kitchen:11:in `<top (required)>'\r\nD      C:\/cinc-project\/cinc-workstation\/bin\/kitchen:395:in `load'\r\nD      C:\/cinc-project\/cinc-workstation\/bin\/kitchen:395:in `<main>'\r\nD      ----End Backtrace-----\r\nD      -Composite Exception--\r\nD      Class: Kitchen::InstanceFailure\r\nD      Message: Converge failed on instance <default-centos-7>.  Please see .kitchen\/logs\/default-centos-7.log for more details\r\nD      ----------------------\r\nD      ------Backtrace-------\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:100:in `rescue in call'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:99:in `call'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:419:in `block in converge_action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:563:in `synchronize_or_call'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:524:in `block in action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/3.0.0\/benchmark.rb:293:in `measure'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:523:in `action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:414:in `converge_action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:392:in `block (2 levels) in transition_to'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/lifecycle_hooks.rb:47:in `run_with_hooks'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:391:in `block in transition_to'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `each'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `transition_to'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:139:in `converge'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `public_send'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `run_action_in_thread'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:166:in `block (2 levels) in run_action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/logging-2.3.0\/lib\/logging\/diagnostic_context.rb:474:in `block in create_with_logging_context'\r\nD      ----End Backtrace-----\r\nD      ---Nested Exception---\r\nD      Class: Kitchen::ActionFailed\r\nD      Message: SSH exited (1) for command: [sh -c '\r\nTEST_KITCHEN=\"1\"; export TEST_KITCHEN\r\nsudo -E \/opt\/cinc\/bin\/chef-client --local-mode --config \/tmp\/kitchen\/client.rb --log_level auto --force-formatter --no-color --json-attributes \/tmp\/kitchen\/dna.json --chef-zero-port 8889\r\n\r\n' && sh -c '\r\nTEST_KITCHEN=\"1\"; export TEST_KITCHEN\r\nsudo -E \/opt\/cinc\/bin\/chef-client --local-mode --config \/tmp\/kitchen\/client_no_updated_resources.rb --log_level auto --force-formatter --no-color --json-attributes \/tmp\/kitchen\/dna.json --chef-zero-port 8889\r\n']\r\nD      ----------------------\r\nD      ------Backtrace-------\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:100:in `rescue in call'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/provisioner\/base.rb:99:in `call'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:419:in `block in converge_action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:563:in `synchronize_or_call'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:524:in `block in action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/3.0.0\/benchmark.rb:293:in `measure'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:523:in `action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:414:in `converge_action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:392:in `block (2 levels) in transition_to'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/lifecycle_hooks.rb:47:in `run_with_hooks'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:391:in `block in transition_to'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `each'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:390:in `transition_to'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/instance.rb:139:in `converge'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `public_send'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:195:in `run_action_in_thread'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/test-kitchen-3.2.2\/lib\/kitchen\/command.rb:166:in `block (2 levels) in run_action'\r\nD      C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/logging-2.3.0\/lib\/logging\/diagnostic_context.rb:474:in `block in create_with_logging_context'\r\nD      ----End Backtrace-----\r\n```\r\n","comments":["This can be kicked over to the test-kitchen repo if it belongs there, but it looked like it was an issue on the Chef side."],"labels":["Type: Bug","Status: Good First Issue","Status: Needs Replication"]},{"title":"Create a functional tests for testing mounting of cifs shares.","body":"We currently have tests for the mount resource but nothing that test the cifs shares specifically.\r\n\r\nhttps:\/\/github.com\/chef\/chef\/pull\/11626 adds a fix and some unit tests for testing the cifs shares.\r\n\r\nAcceptance Criteria:\r\n- Add functional tests for testing mounting of cifs shares.","comments":["The functional tests can be added using test-kitchen."],"labels":["Aspect: Testing"]},{"title":"Provide better compliance test scheduling","body":"### Describe the Enhancement:\r\n<!---  What you are trying to achieve that you can't? -->\r\nNeed a way to better 'schedule' when compliance tests runs to help distribute compliance runs somewhat evenly across a 24 hour period. Would like to have the ability to specify the hour to run the compliance tests since scheduling via interval can result in runs being in sync with each other.\r\n\r\n### Describe the Need:\r\n<!---  What kind of user do you believe would utilize this enhancement, and how many users might want this functionality -->\r\nToday we are using `default['audit']['interval']['time'] = 1440` since we only want our compliance tests to run once a day.\r\nThe \"problem\" is if a large group of servers is patched at the same time (or a datacenter is off for >24 hours) and they are off for 24+ hours, then when all servers boot, the first run of chef-client on these servers would require running the compliance tests near the same time (since the last compliance run exceeds the 1440 minute interval time). Not so much an issue with the increased load on the Automate server, but more the impact on the servers\/applications themselves having the compliance tests running near the same time. Since any given node can't know when compliance tests have run on other nodes to try to calculate a distributed time to run the compliance tests, a possible solution is to have the ability to have an absolute time to run that is defined on each node\r\n\r\nFor example something like:\r\n`default['audit']['absolute']['enabled'] = true\r\ndefault['audit']['absolute']['hour'] = 23\r\ndefault['audit']['absolute']['minute'] = 30-59`\r\nwhich would say to run the compliance tests at the given hour (23 in my example) and in the minute range specified (30-59 in my example - assuming chef-client running every 30 minutes, we could eliminate the 'minute' option assuming that any run in the 0-29 minute range would be when to run the tests when the hour matches).\r\n\r\n### Current Alternative\r\n<!--- Is there a current alternative that you can utilize to workaround the lack of this enhancement -->\r\nTwo options:\r\n1111111111111111111111111111111111\r\nAssuming that there is some flag file on each node containing the timestamp of the last compliance run which 'interval' timing compares against, we could force compliance tests to run now by manually one-time artificially setting audit\/interval\/time=1 and then running chef-client (to update this timer flag) and then resetting the timer back to 1440 which would cause the next compliance run to be in 24 hours from this new\/last compliance run. So write a script to break the list of nodes into 24 groups (one per hour) and then every hour forcing compliance tests on that group of nodes. After 1 day, things would be distributed across 24 hours.\r\n\r\nThe only issue with this is when servers are patched, the timing will get all messed up causing compliance test runs to again be synchronized with each other.\r\n\r\n2222222222222222222222222222222222\r\nCould define the same attributes as mentioned above for each node and then have our own code to compare the given hour\/minute to the current hour\/minute to see if the time to run the compliance tests is met and if so then set audit\/compliance_phase=true (defaulting to false otherwise). So instead of adding this code into the functionality of compliance testing, the same code would be needed in our own cookbooks.\r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\n","comments":[],"labels":["Type: Enhancement"]},{"title":"Allow using methods defined in the body of a recipe inside the body of resources in that recipe","body":"### Describe the Enhancement:\r\nIn a recipe, i'd like to be able to do something like:\r\n\r\n```ruby\r\ndef my_service_config(description, args=\"\")\r\n  {\r\n    Unit: {\r\n      Description: description,\r\n    },\r\n    Service: {\r\n      Type: 'simple',\r\n      ExecStart: \"\/usr\/sbin\/my-service-script #{args}\",\r\n      Restart: 'on-failure',\r\n    }\r\n  }\r\nend\r\n\r\nsystemd_unit \"my-service.service\" do\r\n  content my_service_config(\"my description\", \"--some-flag\")\r\n  action :create\r\nend\r\n```\r\n\r\nCurrently, this results in an error that no `my_service_config` method can be found.\r\n\r\n### Describe the Need:\r\nSometimes, I have a helper method that I only need in a single recipe, and having to define a full library feels like overkill. And it can be a little weird if the library needs to have details that are specific to a recipe. \r\n\r\n### Current Alternative\r\nYou can define a library as described in https:\/\/docs.chef.io\/libraries\/ that has the helper method. But as I understand it, that would make the helper available to all recipes\/resources, and separates the helper method from the context of where it is used. There also aren't currently any examples of defining a method that can be used inside of a resource block.\r\n\r\nYou could use a local proc like:\r\n\r\n```\r\nmy_helper = Proc::new do |v1, v2|\r\n    # ...\r\nend\r\n```\r\n\r\nbut that is kind of awkward, and non-obvious.\r\n\r\nYou could call the method outside of the resource block like:\r\n\r\n```ruby\r\nmy_var = my_service_config(\"description\", \"--flag\")\r\nsystemd_unit \"my-service.service\" do\r\n    content my_var\r\n    action :create\r\nend\r\n```\r\n\r\nBut that is verbose, and again, non-obvious. \r\n\r\n\r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\n\r\nIdeally it would be possible to just refer to the method from the surround scope, but I\"m not sure how feasible that is. Perhaps more feasible, but slightly less conveninet would be if there was a `recipe` method available inside a resource block  that would allow you to do something like `recipe.my_service_config` inside the resource block.\r\n","comments":["To check: does unified mode support this? "],"labels":["Type: Enhancement","Aspect: UX","Status: Needs Replication"]},{"title":"chef_client_config resource doesn't generate data_collector.url and data_collector.token properly in client.rb","body":"## Description\r\nchef_client_config resource doesn't generate `data_collector.url` and `data_collector.token` properly in `client.rb`\r\n\r\n## Chef Version\r\nChef Client 17.9.52\r\n\r\n## Platform Version\r\nUbuntu 18.04.5 LTS\r\n\r\n## Replication Case\r\nMake a resource like this\r\n\r\n```\r\nchef_client_config 'tweak client.rb' do\r\n  chef_server_url 'https:\/\/api.chef.io\/organizations\/asdf_org'\r\n  chef_license 'accept'\r\n  data_collector_server_url 'https:\/\/chef-automate.test\/data-collector\/v0\/'\r\n  data_collector_token 'yDe3hNL-XIh_tcYsLgdVuOHe1nI='\r\nend\r\n```\r\n\r\n## Client Output\r\nYour run will show\r\n\r\n```\r\n+data_collector.server_url https:\/\/chef-automate.test\/data-collector\/v0\/\r\n+data_collector.token yDe3hNL-XIh_tcYsLgdVuOHe1nI=\r\n```\r\n\r\nAnd your `client.rb` will have\r\n\r\n```\r\ndata_collector.server_url https:\/\/chef-automate.test\/data-collector\/v0\/\r\ndata_collector.token yDe3hNL-XIh_tcYsLgdVuOHe1nI=\r\n```\r\n\r\nAnd your next run will say\r\n\r\n```\r\n[2022-03-24T21:49:55+00:00] FATAL: Configuration error SyntaxError: \/etc\/chef\/client.rb:7: unknown regexp options - chf\r\n...llector.server_url https:\/\/chef-automate.test\/data-collector...\r\n...                          ^~~~~\r\n\/etc\/chef\/client.rb:8: syntax error, unexpected local variable or method, expecting end-of-input\r\ndata_collector.token yDe3hNL-XIh_tcYsLgdVuOHe1nI=\r\n                     ^~~~~~~\r\n\r\n[2022-03-24T21:49:55+00:00] FATAL: Aborting due to error in '\/etc\/chef\/client.rb': \/etc\/chef\/client.rb:7: unknown regexp options - chf\r\n...llector.server_url https:\/\/chef-automate.test\/data-collector...\r\n...                          ^~~~~\r\n\/etc\/chef\/client.rb:8: syntax error, unexpected local variable or method, expecting end-of-input\r\ndata_collector.token yDe3hNL-XIh_tcYsLgdVuOHe1nI=\r\n                     ^~~~~~~\r\n```\r\n\r\nAnd then you'll be distraught because you wanted to show someone something and instead it's totally broken\r\n\r\n## Stacktrace","comments":["renders correctly with Chef 18.4.0"],"labels":["Status: Untriaged"]},{"title":"17.9.52 on AIX no way to specify the syslog facility (defaults to 'daemon')","body":"### Describe the Enhancement:\r\n<!---  What you are trying to achieve that you can't? -->\r\nCurrently setting 'log_location :syslog' works by sending output to syslog, but defaults to facility=daemon and it would be nice to be able to specify a different facility in case some other tool is also using 'daemon' (which would result in the log file containing mixed logs). Would be nice to be able to specify the facility to 'local0' .. 'local7' or some other available value to help keep logs from different services from getting mixed together\r\n\r\n### Describe the Need:\r\n<!---  What kind of user do you believe would utilize this enhancement, and how many users might want this functionality -->\r\nIn an environment where other agents are running and possibly also sending logs to facility=daemon, the logs from both chef and these other agents would get all mixed together. It would be nice to have more control over setting the syslog facility to help separate the logs from chef-client\r\n\r\n### Current Alternative\r\n<!--- Is there a current alternative that you can utilize to workaround the lack of this enhancement -->\r\nNone that I can see, especially on AIX. On AIX there is no ability to add string filtering to the syslog.conf file changing which log file matching patterns get sent to.\r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"guards silently no-op when passed falsy args","body":"## Description\r\nguards (e.g. `only_if`, `not_if`) silently no-op when passed falsy args.  We expect to need to either pass a string (for a command) or a block, or to get ArgumentError; but if you mistakenly pass a falsy parameter instead, chef silently drops the guard.\r\n\r\n## Chef Version\r\nConfirmed on 17.9.52\r\n\r\n## Platform Version\r\nCentOS 8\r\n\r\n## Replication Case\r\n```\r\nlog 'guards are fun' do\r\n  only_if false\r\nend\r\n```\r\n\r\n## Client Output\r\n```\r\nConverging 1 resources\r\nRecipe: base::guard_fun\r\n  * log[guards are fun] action write[2022-03-14T16:19:49-07:00] INFO: Processing log[guards are fun] action write (base::guard_fun line 1)\r\n[2022-03-14T16:19:49-07:00] INFO: guards are fun\r\n[2022-03-14T16:19:49-07:00] INFO: Chef Infra Client Run complete in 0.519109614 seconds\r\n```","comments":["The Conditional class seems to handle this properly; I think the issue stems from here:  https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource.rb#L380-L382  This method is used to both set and get the `only_if` instance var, and it decides if we need to set it by checking the args.  It's not obvious to me how to fix this aside from refactoring this into independent get and set methods.","The default value of command should be `NOT_PASSED`:\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/constants.rb#L19\r\n\r\nThen `command != NOT_PASSED` should be the check for if we're behaving like a setter.\r\n\r\nThen `only_if nil` works correctly as well."],"labels":["Status: Untriaged"]},{"title":"Add ability to NOT show compliance results when running chef-client","body":"### Describe the Enhancement:\r\n<!---  What you are trying to achieve that you can't? -->\r\nI'd like the ability for the new compliance phase to have a way to NOT display the compliance phase output\r\n\r\n### Describe the Need:\r\n<!---  What kind of user do you believe would utilize this enhancement, and how many users might want this functionality -->\r\nhttps:\/\/github.com\/chef\/chef\/issues\/11916 forced always outputting the compliance phase output and I'd like the ability to NOT output the compliance phase output. I'd like this to replicate the behavior of the old 'audit' cookbook which when chef-client ran compliance profiles it said it was running the tests but did NOT show the actual results from the tests. \r\n\r\nI understand the desire to be able to see the results when manually running 'chef-client' and that behavior should continue, but I'd like the ability to turn this compliance reporting off (with the results still sent up to Automate)\r\n\r\n### Current Alternative\r\n<!--- Is there a current alternative that you can utilize to workaround the lack of this enhancement -->\r\nNone other than teaching people to ignore the compliance phase output\r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\n","comments":["The current behavior seems at odds with this line in the docs \"Once turned on, the Compliance Phase always outputs its results in the CLI on manual runs. The output for automated runs is handled by [reporters](https:\/\/docs.chef.io\/chef_compliance_phase\/#reporters).\" which seems to indicate that the cli would only be forced on for manual runs but looking at my \/var\/log\/messages it's very clearly still outputting to cli for runs executed by systemd"],"labels":["Status: Untriaged"]},{"title":"Chef Client Installer not adding C:\\opscode\\chef\\embedded\\bin to path","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nThe chef client installer msi is not adding the Path _C:\\opscode\\chef\\embedded\\bin_ to the path environment variable during installation. The [documentation](https:\/\/docs.chef.io\/windows\/#path-system-variable) says this is done durring installation and that it is necessary to add  _C:\\opscode\\chef\\embedded\\bin_ to the path env variable.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n17.9.52.1\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nMicrosoft Windows [Version 10.0.19044.1288]\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\ninstall the msi and check the path env variable only _C:\\opscode\\chef\\bin_ is added to the path env variable. _C:\\opscode\\chef\\embedded\\bin_ is not added to the path env variable. \r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":[],"labels":["Status: Untriaged","Focus: Desktop"]},{"title":"Compliance phase 'quiet' option not working","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nExpectation is that by setting default['audit']['quiet']=true that when tests run, no output would show up, but still see results of running tests\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n17.9.52\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nRedHat 8.5 (x86_64)\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\nRun any compliance profiles while setting\r\ndefault['audit']['quiet']                    = true\r\ndefault['audit']['reporter']                 = 'chef-server-automate'\r\n\r\nand when chef-client is run manually and the tests run, chef-client shows you the test results instead of being 'quiet'.\r\n\r\nThe expectation is when tests run no output would be produced like was the case with the old 'audit' cookbook\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\nCompliance profile test results are being shown\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Setting default['audit']['waiver_file'] to empty file throws error","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nSetting default['audit']['waiver_file'] = '\/tmp\/waivers' and that file is empty (actually contains comments only) results in an error:\r\n\r\n[2022-03-08T10:48:27-07:00] ERROR: Cannot find parser for inputs file '\/tmp\/waivers'. Check to make sure file has the appropriate extension.\r\n\r\nIn our environment, all profiles and waivers are dynamically generated\/created based on various data_bags so sometimes the waivers file has content and other times not (does contain comments saying no waivers on that node) depending on the node. \r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nChef Infra Client, version 17.9.52\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nRedHat 8.5 (x86_64)\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\nCreate recipe with the following (or set per-node attributes):\r\nnode.default['audit']['compliance_phase'] = true\r\nnode.default['audit']['waiver_file'] = '\/tmp\/waivers'\r\n\r\nwhere the file '\/tmp\/waivers' exists but is empty (and\/or contains some comments).\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n[2022-03-08T10:50:06-07:00] ERROR: Chef InSpec has raised a runtime exception. Generating a minimal failed report.\r\n[2022-03-08T10:50:06-07:00] ERROR: Cannot find input file '\/tmp\/waivers'. Check to make sure file exists.\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\nNA\r\n","comments":["You need to try with `\/tmp\/waivers.yml` instead of `\/tmp\/waivers` and see if it reproduces.","Sorry. I tried to make my sample too simple since in my real case my waivers files was `\/var\/chef\/waivers.yml` and when it only contains comments (or is empty) it throws error:\r\n\r\n[2022-03-22T15:47:12-06:00] WARN: Secrets::YAML unable to parse \/var\/chef\/waivers.yml: invalid YAML or contents is not a Hash\r\n"],"labels":["Status: Untriaged"]},{"title":"Chef-client does not send data-collector logs when some deprecations are present","body":"## Description\r\n<!--- Briefly describe the issue -->\r\n\r\nWhen some deprecation warnings are present in a chef-client run, the run status will fail to transmit to Chef Automate (via chef-infra-server proxy).  \r\n\r\nWhile ultimately deprecated code should be fixed in cookbooks to resolve this problem - unfortunately when this condition happens that means that there will potentially be failures or deprecated code running on nodes and it will prevent the nodes from checking with report data to Chef Automate, so operators would not know that an error is present unless they notice that the nodes are not checking in or are running `chef-client` interactively.\r\n\r\nThe following deprecation warning results in error `rpc error: code = Internal desc = Unable to transform Run message to ChefClientRun: json: cannot unmarshal bool into Go struct field Deprecation.deprecations.message of type string` coming back from Automate (this shows in local trace log as well):\r\n\r\n```\r\n Running handlers:\r\nRunning handlers complete\r\n\r\nDeprecation warnings that must be addressed before upgrading to Chef Infra 18:\r\n\r\n  true at 1 location:\r\n    - \/var\/chef\/cache\/cookbooks\/test_cookbook\/recipes\/default.rb:15:in `block in from_file'\r\n   See https:\/\/docs.chef.io\/deprecations_property\/ for further details.\r\n\r\nInfra Phase complete, 5\/22 resources updated in 07 seconds\r\n[2022-03-04T19:46:01+00:00] WARN: Server returned error 500 for https:\/\/ec2-54-218-248-185.us-west-2.compute.amazonaws.com\/organizations\/a2local\/data-collector, retrying 1\/5 in 4s\r\n[2022-03-04T19:46:06+00:00] WARN: Server returned error 500 for https:\/\/ec2-54-218-248-185.us-west-2.compute.amazonaws.com\/organizations\/a2local\/data-collector, retrying 2\/5 in 5s\r\n```\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nTested with:\r\n16.17.51\r\n17.9.52\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\ntested with almalinux-8 and amazonlinux-2\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\nWrite a resource that is using a deprecated property.  In this instance, the `clean_headers` property has been deprecated.\r\n\r\n```ruby\r\nyum_repository 'some_repo' do\r\n  description 'some_repo'\r\n  mirrorlist 'http:\/\/mirror.centos.org\/centos\/7\/os\/x86_64\/'\r\n  make_cache false\r\n  gpgcheck false\r\n  enabled true\r\n  clean_headers true\r\n  action :add\r\nend\r\n```\r\n\r\nRunning `chef-client` will fail to send data to Chef Automate with this present:\r\n\r\n```plain\r\nRunning handlers:\r\nRunning handlers complete\r\n\r\nDeprecation warnings that must be addressed before upgrading to Chef Infra 18:\r\n\r\n  true at 1 location:\r\n    - \/var\/chef\/cache\/cookbooks\/test_cookbook\/recipes\/default.rb:15:in `block in from_file'\r\n   See https:\/\/docs.chef.io\/deprecations_property\/ for further details.\r\n\r\nInfra Phase complete, 5\/22 resources updated in 07 seconds\r\n[2022-03-04T19:46:01+00:00] WARN: Server returned error 500 for https:\/\/ec2-54-218-248-185.us-west-2.compute.amazonaws.com\/organizations\/a2local\/data-collector, retrying 1\/5 in 4s\r\n[2022-03-04T19:46:06+00:00] WARN: Server returned error 500 for https:\/\/ec2-54-218-248-185.us-west-2.compute.amazonaws.com\/organizations\/a2local\/data-collector, retrying 2\/5 in 5s\r\n```\r\n\r\n\r\nThis is an example of a deprecation warning that does not produce this issue -- when this deprecation happens the node data is sent correctly and no errors are observed on the client:\r\n\r\n```\r\n  The  resource in the yum cookbook should declare `unified_mode true` at 1 location:\r\n    - \/var\/chef\/cache\/cookbooks\/yum\/resources\/globalconfig.rb\r\n   See https:\/\/docs.chef.io\/deprecations_unified_mode\/ for further details.\r\n```\r\n\r\n","comments":["```\r\n  true at 1 location:\r\n    - \/var\/chef\/cache\/cookbooks\/test_cookbook\/recipes\/default.rb:15:in `block in from_file'\r\n   See https:\/\/docs.chef.io\/deprecations_property\/ for further details.\r\n```\r\n\r\nthat looks like a rendering problem with the deprecated property stuff where my guess would be that the JSON payload (which would be good to get the actual payload from -l trace or something to validate) looks like it is probably throwing a boolean `true` somewhere that the server-side is maybe expecting a string.  Or something that rhymes with that.\r\n","Yep it does look like it is dropping the Boolean `true` as the `message` here, where it it is expecting a string instead\r\n\r\nI used this resource sample:\r\n\r\n```ruby\r\nyum_repository 'some_repo' do\r\n  description 'some_repo'\r\n  mirrorlist 'http:\/\/mirror.centos.org\/centos\/7\/os\/x86_64\/'\r\n  make_cache false\r\n  gpgcheck false\r\n  enabled true\r\n  clean_headers true\r\n  action :add\r\nend\r\n```\r\n\r\nHere what the `deprecations` key of the body payload looks like that it is trying to send\r\n\r\n```json\r\n[\r\n  {\r\n    \"message\": true,\r\n    \"url\": \"https:\/\/docs.chef.io\/deprecations_property\/\",\r\n    \"location\": \"\/home\/ec2-user\/recipe.rb:7:in `block in from_file'\"\r\n  }\r\n]\r\n```\r\n\r\nIt is a bit trickier to see what this looks like for deprecation warnings that are not erroring out, but I do see in the run_context of one that it has an actual message string instead of a Boolean for the `message` and that is able to send to the data_collector without issue:\r\n\r\n```ruby\r\n@events=\r\n      #<Chef::EventDispatch::Dispatcher:0x000000000343b720\r\n       @in_call=true,\r\n       @subscribers=\r\n        [#<Chef::Formatters::Doc:0x000000000343bce8\r\n          @current_recipe=\"@recipe_files::\/home\/ec2-user\/recipe.rb\",\r\n          @deprecations=\r\n           {\"The inspec_gem resource in the audit cookbook should declare `unified_mode true`\"=>\r\n             {:url=>\"https:\/\/docs.chef.io\/deprecations_unified_mode\/\", :locations=>#<Set: {\"\/var\/chef\/cache\/cookbooks\/audit\/resources\/inspec_gem.rb\"}>}},\r\n```"],"labels":["Status: Untriaged"]},{"title":"knife: ask interactively for sudo password","body":"### Describe the Enhancement:\r\nI do not want to enter my sudo password as command line argument. When I enter it as command line argument it is readable by every other user on this computer via `pgrep`\/`htop`\/\u2026. I have no problem to enter my password interactively.\r\n\r\n### Describe the Need:\r\nAll users who login to a host via ssh and do not want to configure NOPASSWD for sudo.\r\n\r\n### Current Alternative\r\n* with questionable security: configure sudo with NOPASSWD\r\n* insecure way: ssh login as root\r\n\r\n### Can We Help You Implement This?:\r\nProbably not. Not enough time to gather the knowledge for Ruby + Erlang. Sorry. :-(","comments":["sudo password and `-P\/--connection-password` can be different passwords when sudo has `rootpw`, `targetpw` or `runaspw` set."],"labels":["Status: Needs Replication","Focus: knife"]},{"title":"dnf_package - CentOS 8.x, CentOS Stream 8.x and OEL 8.x - Chef 17.6.x -> 17.9.46 - Using Stale Cache","body":"We're seeing a very strange `dnf_package` downgrade when action `:upgrade` used.\r\n\r\nWe're seeing it on all of our CentOS Stream 8.x (converted from CentOS 8.x) and Oracle Enterprise Linux 8.x.\r\n\r\nWe use dnf_automate to automatically update packages nightly. Packages that dnf_automate updates are being downgraded by chef via a recipe for the same package with action `:upgrade`\r\n\r\nOn an impacted system, on the cli `dnf upgrade` will show a list of updates. If applied by `dnf upgrade` the next chef client run, downgrades the specifically chef managed package.\r\n\r\nRunning cli command `dnf clean all` or `dnf clean metadata` etc, do not fix chef client \r\n\r\nDeleting the contents of `\/var\/cache\/yum\/` fixes chef client immediately, running chef-client immediately upgrades the previously downgraded package since it now sees the newer version in the repo metadata it is reading\r\n\r\nOn a fixed system, this happens again when upstream repos to include an updated version of a package (thus updating the repo data\/metadata) we manage via chef.\r\n\r\nWhen I look at the contents for `\/var\/cache\/yum` it appears that dnf\/yum does leave cruft upon repo metadata changes. I'm suspecting that chef is reading the stale yum\/dnf cache when multiple revisions exist.\r\n\r\nI'm going to start reviewing the chef client source code to inspect how chef does it. but I wanted to open this so other who have seen this issue can help or find help.\r\n  ","comments":["Example of multiple cache directories\r\n```\r\n\/var\/cache\/yum\/$basearch\/$releasever # find * -maxdepth 0 -type d -ls\r\n   128637      4 drwxr-xr-x   3  root     root         4096 Feb  9 00:41 epel-177e8c6c18a8078d\r\n   128641      4 drwxr-xr-x   3  root     root         4096 Feb  5 05:23 epel-modular-5f82030b806654e5\r\n      113      4 drwxr-xr-x   3  root     root         4096 Jan 27 19:23 ol8_addons-22627099a7e91dd5\r\n   128658      4 drwxr-xr-x   3  root     root         4096 Jul 16  2021 ol8_addons-e013bc8362693c74\r\n   128667      4 drwxr-xr-x   3  root     root         4096 Jul 23  2021 ol8_appstream-0b1209121ae5d69b\r\n      122      4 drwxr-xr-x   3  root     root         4096 Feb  3 19:45 ol8_appstream-50575e0d2cd83745\r\n   128706      4 drwxr-xr-x   3  root     root         4096 Jul 17  2021 ol8_baseos_latest-e4c6155830ad002c\r\n   128678      4 drwxr-xr-x   3  root     root         4096 Jul 23  2021 ol8_latest-cbb06250ca5c3fa3\r\n      128      4 drwxr-xr-x   3  root     root         4096 Feb  3 19:45 ol8_latest-d4d11e719ca733ba\r\n   128649      4 drwxr-xr-x   3  root     root         4096 Jul 16  2021 ol8_UEK_latest-b1da638cdbc6845a\r\n       98      4 drwxr-xr-x   3  root     root         4096 Feb  3 19:45 ol8_UEK_latest-dd9cc536bf495c65\r\n```\r\n","I may have found something..  It appears that the dnf_package is not using the custom vars under \/etc\/dns\/vars.  If I run the dnf command manually it works fine. I modified the description to show the var $contentdir\r\n```dnf upgrade zip\r\nCentOS Linux centos:8 - AppStream                                                                           690 kB\/s | 8.4 MB     00:12    \r\nCentOS Linux centos:8 - BaseOS                                                                              750 kB\/s | 4.6 MB     00:06    ```\r\n\r\n```\r\n[2022-02-24T19:14:07+00:00] FATAL: RuntimeError: dnf_package[unzip] (vbrick_rev_analytics::linux line 9) had an error: RuntimeError: dnf-helper.py had stderr output:\r\n\r\nErrors during downloading metadata for repository 'appstream':\r\n  - Status code: 404 for http:\/\/linuxsoft.cern.ch\/centos-vault\/$contentdir\/8\/AppStream\/x86_64\/os\/repodata\/repomd.xml (IP: 188.184.100.74)\r\nTraceback (most recent call last):\r\n```"],"labels":["Priority: Medium","Platform: RHEL-like","Triage: Needs Information","Status: Needs Replication"]},{"title":"Compliance mode needs some functional\/integration testing","body":"Possibly this could go into the kitchen-tests?\r\n\r\nIf not we should run something that kicks off a chef-client against a cookbook with some compliance content and at least insert some debugging and validate that the internal datastructures are sound.","comments":["This should probably go into the spec\/integrations rather than kitchen-tests and should look somewhat like the other chef-client integration tests that do crazy things like testing unified_mode works and all the notifications tests.  Since the cli output from the compliance mode needs to be kind of trashed at some point that API won't be stable and probably shouldn't be relied upon.  We likely need to add some debugging to show what happened with inspec (maybe we could actually add some debug level logging to the compliance runner itself and run under -l debug or -l trace?) and then effectively grep to assert that we get the kind of output that we expect from the compliance run in the presence of profiles\/waivers\/inputs being present and that their behavior is correct (can also test failing the run when we implement that feature, etc)."],"labels":["Priority: Critical","Type: Chore","Focus: Compliance Phase"]},{"title":"The required property validations should not run on the current_resource or the after_resource only the new_resource","body":"Create a cookbook with the cron resource with sensitive true.\r\n\r\nClient execution will be erroring out with the message :\r\nFATAL: Chef::Exceptions::ValidationFailed: command is a required property\r\n\r\nAdditional context\r\nTried with chef-infra-client version 17.7.22, where the cron resource-related fix was there. But still same behavior.\r\n\r\n","comments":["This is probably because the cron doesn't exist when they're running it so its appropriate for the command in the current_resource to be nil, but for the new_resource that needs to be required, so somehow we really need to be able to say that required properties in the current_resource (and the after_resource) are not actually required and should never throw.   This needs to not be addressed by a one-off fix that attempts to only fix this one property on this one resource but to make the whole collection of issues go away.","This means that the property needs to \"know\" if it is attached to a current\/after resource or the new_resource which probably means threading some kind of state through (it may not be exactly which kind of resource it is attached to but a boolean flag to control required validations though).","(although the resource the property is attached to may already be threaded into the property and we might be able to hang a flag off of the resource)"],"labels":["Type: Bug","Triage: Confirmed","Priority: High"]},{"title":"windows_font resource fails when cookbook files are in a subdirectory","body":"## Description\r\nThe `windows_font` resource will attempt to copy a cookbook file using the `cookbook_file` resource if you do not include a `source` property. The font name is used to determine what file should be copied, but if the file is in a subdirectory, the resource will fail.\r\n\r\nI believe this is occurring because `windows_font` uses the full path to reference the font, but `cookbook_file` only creates the file itself, not the enclosing directories.\r\n\r\n## Chef Version\r\nchef_version=17.9.26\r\n\r\n## Platform Version\r\nplatform=windows\r\nplatform_version=10.0.19043\r\n\r\n## Replication Case\r\nPlace [a font file](https:\/\/fonts.google.com\/share?selection.family=Source%20Sans%20Pro) in a nested folder with a cookbook, then reference that file in a recipe.\r\n\r\nExample cookbook folder structure:\r\n```\r\nCOOKBOOK\r\n\u251c\u2500\u2500\u2500files\r\n\u2502   \u2514\u2500\u2500\u2500fonts\r\n\u2502       \u2514\u2500\u2500\u2500Source_Sans_Pro\r\n\u2502           \u2514\u2500\u2500\u2500SourceSansPro-Regular.ttf\r\n\u2514\u2500\u2500\u2500recipes\r\n    \u2514\u2500\u2500\u2500win_fonts.rb\r\n```\r\n\r\nExample recipe:\r\n```ruby\r\nwindows_font 'SourceSansPro-Regular.ttf' do\r\n  font_name 'fonts\\Source_Sans_Pro\\SourceSansPro-Regular.ttf'\r\nend\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n  * windows_font[SourceSansPro-Regular.ttf] action install\r\n    * cookbook_file[fonts\\Source_Sans_Pro\\SourceSansPro-Regular.ttf] action nothing (skipped due to action :nothing)\r\n    * cookbook_file[fonts\\Source_Sans_Pro\\SourceSansPro-Regular.ttf] action create\r\n      * Parent directory C:\\Users\\ddavis\\AppData\\Local\\Temp\\fonts\\Source_Sans_Pro does not exist.\r\n      ================================================================================\r\n      Error executing action `create` on resource 'cookbook_file[fonts\\Source_Sans_Pro\\SourceSansPro-Regular.ttf]'\r\n      ================================================================================\r\n\r\n      Chef::Exceptions::EnclosingDirectoryDoesNotExist\r\n      ------------------------------------------------\r\n      Parent directory C:\\Users\\ddavis\\AppData\\Local\\Temp\\fonts\\Source_Sans_Pro does not exist.\r\n\r\n      Resource Declaration:\r\n      ---------------------\r\n      # In C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.9.26-universal-mingw32\/lib\/chef\/resource\/windows_font.rb\r\n\r\n       69:             declare_resource(:cookbook_file, font_file) do\r\n       70:               action    :nothing\r\n       71:               cookbook  cookbook_name.to_s unless cookbook_name.nil?\r\n       72:               path      Chef::Util::PathHelper.join(ENV[\"TEMP\"], font_file)\r\n       73:             end.run_action(:create)\r\n       74:           end\r\n       75:         end\r\n\r\n      Compiled Resource:\r\n      ------------------\r\n      # Declared in C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.9.26-universal-mingw32\/lib\/chef\/resource\/windows_font.rb:69:in `retrieve_cookbook_font'\r\n\r\n      cookbook_file(\"fonts\\Source_Sans_Pro\\SourceSansPro-Regular.ttf\") do\r\n        action [:nothing]\r\n        default_guard_interpreter :default\r\n        declared_type :cookbook_file\r\n        cookbook_name \"cpe_windows\"\r\n        recipe_name \"win_fonts\"\r\n        source \"SourceSansPro-Regular.ttf\"\r\n        path \"C:\\\\Users\\\\ddavis\\\\AppData\\\\Local\\\\Temp\\\\fonts\\\\Source_Sans_Pro\\\\SourceSansPro-Regular.ttf\"\r\n        rights nil\r\n        deny_rights nil\r\n        cookbook \"cpe_windows\"\r\n      end\r\n\r\n      System Info:\r\n      ------------\r\n      chef_version=17.9.26\r\n      platform=windows\r\n      platform_version=10.0.19043\r\n      ruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x64-mingw32]\r\n      program_name=C:\/opscode\/chef\/bin\/chef-client\r\n      executable=C:\/opscode\/chef\/bin\/chef-client\r\n\r\n\r\n    ================================================================================\r\n    Error executing action `install` on resource 'windows_font[SourceSansPro-Regular.ttf]'\r\n    ================================================================================\r\n\r\n    Chef::Exceptions::EnclosingDirectoryDoesNotExist\r\n    ------------------------------------------------\r\n    cookbook_file[fonts\\Source_Sans_Pro\\SourceSansPro-Regular.ttf] (cpe_windows::win_fonts line 69) had an error: Chef::Exceptions::EnclosingDirectoryDoesNotExist: Parent directory C:\\Users\\ddavis\\AppData\\Local\\Temp\\fonts\\Source_Sans_Pro does not exist.\r\n\r\n    Resource Declaration:\r\n    ---------------------\r\n    # In c:\/users\/ddavis\/local-mode-cache\/cache\/cookbooks\/cpe_windows\/recipes\/win_fonts.rb\r\n\r\n      9:   windows_font 'SourceSansPro-Regular.ttf' do\r\n     10:     font_name 'fonts\\Source_Sans_Pro\\SourceSansPro-Regular.ttf'\r\n     11:   end\r\n     12:\r\n\r\n    Compiled Resource:\r\n    ------------------\r\n    # Declared in c:\/users\/ddavis\/local-mode-cache\/cache\/cookbooks\/cpe_windows\/recipes\/win_fonts.rb:9:in `from_file'\r\n\r\n    windows_font(\"SourceSansPro-Regular.ttf\") do\r\n      action [:install]\r\n      default_guard_interpreter :default\r\n      declared_type :windows_font\r\n      cookbook_name \"cpe_windows\"\r\n      recipe_name \"win_fonts\"\r\n      font_name \"fonts\\\\Source_Sans_Pro\\\\SourceSansPro-Regular.ttf\"\r\n    end\r\n\r\n    System Info:\r\n    ------------\r\n    chef_version=17.9.26\r\n    platform=windows\r\n    platform_version=10.0.19043\r\n    ruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x64-mingw32]\r\n    program_name=C:\/opscode\/chef\/bin\/chef-client\r\n    executable=C:\/opscode\/chef\/bin\/chef-client\r\n```\r\n\r\n## Stacktrace\r\nhttps:\/\/gist.github.com\/1dustindavis\/cbed3a5c4e8e3b915c3b6bef8aa2bd6e\r\n","comments":[],"labels":["Platform: Windows","Status: Untriaged","Focus: Desktop"]},{"title":"Rework chef_fs knife class to not require parallel_mapper","body":"The require on chef_utils\/parallel_map ends up requiring 181 different files that takes over 1 second on a very fast system. This is a significant part of just a basic `knife -h` command.\r\n\r\n```\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/abstract_executor_service.rb, concurrent\/errors, 0.0003030000000000532\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/concern\/logging.rb, logger, 0.010509999999999964\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/concern\/deprecation.rb, concurrent\/concern\/logging, 0.01078299999999996\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/abstract_executor_service.rb, concurrent\/concern\/deprecation, 0.011124000000000023\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/executor_service.rb, concurrent\/concern\/logging, 5.0000000000050004e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/abstract_executor_service.rb, concurrent\/executor\/executor_service, 0.0003680000000000627\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/utility\/engine, 0.00029799999999996496\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/abstract_object, 0.00027499999999988645\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/utility\/native_extension_loader.rb, concurrent\/utility\/engine, 6.000000000061512e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/utility\/native_extension_loader, 0.0003280000000000227\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/mri_object, 0.0003079999999999472\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/jruby_object, 0.0002609999999999557\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/rbx_object, 0.00025299999999997547\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/truffleruby_object, 0.00025199999999991896\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/object, 0.00042100000000008797\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/volatile, 0.00021800000000002373\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/abstract_lockable_object, 0.00026099999999998347\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/mutex_lockable_object, 0.000297000000000075\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/jruby_lockable_object, 0.00021100000000001673\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/rbx_lockable_object, 0.00028199999999994896\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/lockable_object, 0.0002489999999999437\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/condition, 0.00029399999999996096\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/synchronization.rb, concurrent\/synchronization\/lock, 0.00024399999999996647\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/abstract_executor_service.rb, concurrent\/synchronization, 0.039431999999999995\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/abstract_executor_service, 0.051613999999999965\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/cached_thread_pool.rb, concurrent\/utility\/engine, 2.9999999999752447e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/thread_pool_executor.rb, concurrent\/utility\/engine, 2.999999999947489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/ruby_thread_pool_executor.rb, thread, 0.011352000000000056\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/event.rb, thread, 0.00990399999999994\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/event.rb, concurrent\/synchronization, 7.999999999980245e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/ruby_thread_pool_executor.rb, concurrent\/atomic\/event, 0.010247000000000034\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/ruby_thread_pool_executor.rb, concurrent\/concern\/logging, 4.000000000004e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/ruby_executor_service.rb, concurrent\/executor\/abstract_executor_service, 6.000000000061512e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/ruby_executor_service.rb, concurrent\/atomic\/event, 1.0000000000287557e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/ruby_thread_pool_executor.rb, concurrent\/executor\/ruby_executor_service, 0.00042400000000003546\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/utility\/monotonic_time.rb, concurrent\/synchronization, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/ruby_thread_pool_executor.rb, concurrent\/utility\/monotonic_time, 0.00030799999999997496\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/thread_pool_executor.rb, concurrent\/executor\/ruby_thread_pool_executor, 0.022997000000000045\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/cached_thread_pool.rb, concurrent\/executor\/thread_pool_executor, 0.02324800000000002\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/cached_thread_pool, 0.023579000000000017\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/executor_service, 3.000000000086267e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/fixed_thread_pool.rb, concurrent\/utility\/engine, 3.999999999976245e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/fixed_thread_pool.rb, concurrent\/executor\/thread_pool_executor, 1.0000000000287557e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/fixed_thread_pool, 0.00034200000000009223\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/immediate_executor.rb, concurrent\/atomic\/event, 4.000000000004e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/immediate_executor.rb, concurrent\/executor\/abstract_executor_service, 2.999999999947489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/serial_executor_service.rb, concurrent\/executor\/executor_service, 1.0000000000287557e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/immediate_executor.rb, concurrent\/executor\/serial_executor_service, 0.00023800000000004373\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/immediate_executor, 0.0005339999999999789\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/indirect_immediate_executor.rb, concurrent\/executor\/immediate_executor, 5.999999999922734e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/atomic_reference.rb, concurrent\/synchronization, 2.999999999947489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/atomic_reference.rb, concurrent\/utility\/engine, 1.0000000000287557e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/atomic_reference.rb, concurrent\/atomic_reference\/numeric_cas_wrapper, 0.00023400000000001198\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/atomic_reference.rb, concurrent\/atomic_reference\/mutex_atomic, 0.00027299999999999547\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomics.rb, concurrent\/atomic\/atomic_reference, 0.0009800000000000086\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/mutex_atomic_boolean.rb, concurrent\/synchronization, 3.000000000086267e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/atomic_boolean.rb, concurrent\/atomic\/mutex_atomic_boolean, 0.0002780000000000282\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/atomic_boolean.rb, concurrent\/synchronization, 2.9999999999752447e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomics.rb, concurrent\/atomic\/atomic_boolean, 0.0005400000000000404\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/mutex_atomic_fixnum.rb, concurrent\/synchronization, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/mutex_atomic_fixnum.rb, concurrent\/utility\/native_integer, 0.0002870000000000372\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/atomic_fixnum.rb, concurrent\/atomic\/mutex_atomic_fixnum, 0.0006670000000000287\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/atomic_fixnum.rb, concurrent\/synchronization, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomics.rb, concurrent\/atomic\/atomic_fixnum, 0.0009249999999999536\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/cyclic_barrier.rb, concurrent\/synchronization, 5.000000000032756e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/cyclic_barrier.rb, concurrent\/utility\/native_integer, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomics.rb, concurrent\/atomic\/cyclic_barrier, 0.0003419999999999812\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/count_down_latch.rb, concurrent\/utility\/engine, 2.999999999947489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/mutex_count_down_latch.rb, concurrent\/synchronization, 6.000000000033756e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/mutex_count_down_latch.rb, concurrent\/utility\/native_integer, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/count_down_latch.rb, concurrent\/atomic\/mutex_count_down_latch, 0.0002709999999999102\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/count_down_latch.rb, concurrent\/atomic\/java_count_down_latch, 0.0002500000000000002\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomics.rb, concurrent\/atomic\/count_down_latch, 0.0007780000000000009\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomics.rb, concurrent\/atomic\/event, 3.0000000000585114e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/read_write_lock.rb, thread, 0.009739000000000053\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/read_write_lock.rb, concurrent\/atomic\/atomic_fixnum, 3.999999999976245e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/read_write_lock.rb, concurrent\/errors, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/read_write_lock.rb, concurrent\/synchronization, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomics.rb, concurrent\/atomic\/read_write_lock, 0.010292999999999913\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/reentrant_read_write_lock.rb, thread, 0.00987500000000005\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/reentrant_read_write_lock.rb, concurrent\/atomic\/atomic_reference, 4.999999999921734e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/reentrant_read_write_lock.rb, concurrent\/errors, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/reentrant_read_write_lock.rb, concurrent\/synchronization, 3.0000000000585114e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/thread_local_var.rb, concurrent\/utility\/engine, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/ruby_thread_local_var.rb, thread, 0.009908000000000056\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/abstract_thread_local_var.rb, concurrent\/constants, 0.00021200000000007324\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/ruby_thread_local_var.rb, concurrent\/atomic\/abstract_thread_local_var, 0.0005029999999999757\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/thread_local_var.rb, concurrent\/atomic\/ruby_thread_local_var, 0.01084999999999997\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/java_thread_local_var.rb, concurrent\/atomic\/abstract_thread_local_var, 6.9999999999514895e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/thread_local_var.rb, concurrent\/atomic\/java_thread_local_var, 0.0007729999999999959\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/reentrant_read_write_lock.rb, concurrent\/atomic\/thread_local_var, 0.01194800000000007\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomics.rb, concurrent\/atomic\/reentrant_read_write_lock, 0.022419000000000022\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/mutex_semaphore.rb, concurrent\/synchronization, 3.0000000000585114e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/mutex_semaphore.rb, concurrent\/utility\/native_integer, 3.0000000000585114e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/semaphore.rb, concurrent\/atomic\/mutex_semaphore, 0.00035899999999997045\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomic\/semaphore.rb, concurrent\/synchronization, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomics.rb, concurrent\/atomic\/semaphore, 0.0006200000000000649\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/atomics.rb, concurrent\/atomic\/thread_local_var, 3.000000000086267e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/simple_executor_service.rb, concurrent\/atomics, 0.03718000000000002\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/simple_executor_service.rb, concurrent\/executor\/executor_service, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/indirect_immediate_executor.rb, concurrent\/executor\/simple_executor_service, 0.03749500000000003\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/indirect_immediate_executor, 0.0377559999999999\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/java_executor_service, 0.0003460000000000407\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/java_single_thread_executor, 0.00030699999999991845\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/java_thread_pool_executor, 0.0003449999999999842\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/ruby_executor_service, 3.999999999976245e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/ruby_single_thread_executor.rb, concurrent\/executor\/ruby_thread_pool_executor, 4.999999999921734e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/ruby_single_thread_executor, 0.00023000000000003573\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/ruby_thread_pool_executor, 2.999999999947489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/cached_thread_pool, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/safe_task_executor.rb, concurrent\/synchronization, 4.999999999921734e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/safe_task_executor, 0.00025699999999992396\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/serial_executor_service, 2.999999999947489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/serialized_execution.rb, concurrent\/errors, 6.000000000033756e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/serialized_execution.rb, concurrent\/concern\/logging, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/serialized_execution.rb, concurrent\/synchronization, 9.999999999177334e-07\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/serialized_execution, 0.0003610000000000002\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/serialized_execution_delegator.rb, delegate, 0.009871000000000019\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/serialized_execution_delegator.rb, concurrent\/executor\/serial_executor_service, 3.999999999976245e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/serialized_execution_delegator.rb, concurrent\/executor\/serialized_execution, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/serialized_execution_delegator, 0.010137000000000007\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/single_thread_executor.rb, concurrent\/utility\/engine, 3.999999999976245e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/single_thread_executor.rb, concurrent\/executor\/ruby_single_thread_executor, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/single_thread_executor, 0.0003159999999999552\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/thread_pool_executor, 2.999999999947489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/scheduled_task.rb, concurrent\/constants, 6.999999999979245e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/scheduled_task.rb, concurrent\/errors, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/configuration.rb, thread, 0.009796999999999972\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/delay.rb, thread, 0.01001499999999994\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/concern\/obligation.rb, thread, 0.009773999999999977\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/concern\/obligation.rb, timeout, 0.011730999999999936\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/concern\/obligation.rb, concurrent\/atomic\/event, 6.999999999979245e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/concern\/obligation.rb, concurrent\/concern\/dereferenceable, 0.00031300000000006323\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/delay.rb, concurrent\/concern\/obligation, 0.022340999999999972\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/delay.rb, concurrent\/executor\/immediate_executor, 2.9999999999752447e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/delay.rb, concurrent\/synchronization, 2.9999999999752447e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/configuration.rb, concurrent\/delay, 0.03279800000000002\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/configuration.rb, concurrent\/errors, 3.0000000000585114e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/configuration.rb, concurrent\/atomic\/atomic_reference, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/configuration.rb, concurrent\/concern\/logging, 9.999999999177334e-07\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/configuration.rb, concurrent\/concern\/deprecation, 3.0000000000585114e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/configuration.rb, concurrent\/executor\/immediate_executor, 1.0000000000287557e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/configuration.rb, concurrent\/executor\/cached_thread_pool, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/utility\/processor_counter.rb, etc, 0.010665999999999981\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/utility\/processor_counter.rb, rbconfig, 0.009840999999999989\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/utility\/processor_counter.rb, concurrent\/delay, 2.9999999999752447e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/configuration.rb, concurrent\/utility\/processor_counter, 0.021028999999999992\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/scheduled_task.rb, concurrent\/configuration, 0.06414299999999992\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/ivar.rb, concurrent\/constants, 3.999999999976245e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/ivar.rb, concurrent\/errors, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/collection\/copy_on_write_observer_set.rb, concurrent\/synchronization, 2.9999999999752447e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/ivar.rb, concurrent\/collection\/copy_on_write_observer_set, 0.00034300000000009323\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/ivar.rb, concurrent\/concern\/obligation, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/collection\/copy_on_notify_observer_set.rb, concurrent\/synchronization, 4.000000000087267e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/concern\/observable.rb, concurrent\/collection\/copy_on_notify_observer_set, 0.00033099999999999796\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/concern\/observable.rb, concurrent\/collection\/copy_on_write_observer_set, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/ivar.rb, concurrent\/concern\/observable, 0.0005950000000000677\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/ivar.rb, concurrent\/synchronization, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/scheduled_task.rb, concurrent\/ivar, 0.001486000000000015\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/scheduled_task.rb, concurrent\/collection\/copy_on_notify_observer_set, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/scheduled_task.rb, concurrent\/utility\/monotonic_time, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/options.rb, concurrent\/configuration, 5.000000000032756e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/scheduled_task.rb, concurrent\/options, 0.00030700000000002947\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/timer_set.rb, concurrent\/scheduled_task, 0.06637499999999996\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/timer_set.rb, concurrent\/atomic\/event, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/collection\/non_concurrent_priority_queue.rb, concurrent\/utility\/engine, 5.999999999922734e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/collection\/non_concurrent_priority_queue.rb, concurrent\/collection\/java_non_concurrent_priority_queue, 0.0002899999999999292\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/collection\/non_concurrent_priority_queue.rb, concurrent\/collection\/ruby_non_concurrent_priority_queue, 0.00036100000000002797\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/timer_set.rb, concurrent\/collection\/non_concurrent_priority_queue, 0.0009389999999999676\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/timer_set.rb, concurrent\/executor\/executor_service, 2.9999999999752447e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/timer_set.rb, concurrent\/executor\/single_thread_executor, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executor\/timer_set.rb, concurrent\/options, 2.0000000000297558e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/executors.rb, concurrent\/executor\/timer_set, 0.06771800000000003\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/chef-utils-17.8.25\/lib\/chef-utils\/parallel_map.rb, concurrent\/executors, 0.19421800000000006\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/future.rb, thread, 0.009908\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/future.rb, concurrent\/constants, 4.999999999921734e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/future.rb, concurrent\/errors, 2.0000000000575113e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/future.rb, concurrent\/ivar, 2.9999999999752447e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/future.rb, concurrent\/executor\/safe_task_executor, 2.999999999947489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/concurrent-ruby-1.1.9\/lib\/concurrent-ruby\/concurrent\/future.rb, concurrent\/options, 1.999999999946489e-06\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/chef-utils-17.8.25\/lib\/chef-utils\/parallel_map.rb, concurrent\/future, 0.010291999999999996\r\n\/opt\/homebrew\/lib\/ruby\/gems\/3.0.0\/gems\/knife-17.9.9\/lib\/chef\/chef_fs\/knife.rb, chef-utils\/parallel_map, 0.20487299999999994\r\n```","comments":[],"labels":["Aspect: Performance","Focus: knife"]},{"title":"windows_feature_powershell does not install feature that has install state \"Removed\" when supplying source outside of explicit `source` property","body":"## Description\r\n`windows_feature_powershell` will only install features that have install state `Removed` when you explicitly pass `Source` to the resource.\r\n\r\nWe define source via the Registry at `HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Servicing` and not explicitly on the resource itself.\r\n\r\nhttps:\/\/docs.microsoft.com\/en-us\/windows\/win32\/w8cookbook\/-net-framework-4-5-is-default-and--net-framework-3-5-is-optional\r\n\r\nRelated: #9536\r\n\r\n## Chef Version\r\n`16.7.61`\r\n\r\n## Platform Version\r\nWindows Server 2016\r\n\r\n## Replication Case\r\nI'll get this\r\n\r\n## Client Output\r\n```\r\n* windows_feature_powershell[Web-Default-Doc, Web-Http-Errors, Web-Static-Content, Web-Http-Redirect, Web-Http-Logging, Web-Custom-Logging, Web-Log-Libraries, Web-Request-Monitor, Web-Http-Tracing, Web-Stat-Compression, Web-Dyn-Compression, Web-Filtering, Web-Basic-Auth, Web-Client-Auth, Web-Cert-Auth, Web-IP-Security, Web-Url-Auth, Web-Windows-Auth, Web-Net-Ext45, Web-AppInit, Web-ASP, Web-Asp-Net45, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Includes, Web-WebSockets, Web-Mgmt-Console, Web-Mgmt-Compat, Web-Scripting-Tools, Web-Mgmt-Service, NET-Framework-Core, NET-Framework-45-ASPNET, NET-WCF-HTTP-Activation45] action install[2021-12-20T23:12:08+00:00] INFO: Processing windows_feature_powershell[Web-Default-Doc, Web-Http-Errors, Web-Static-Content, Web-Http-Redirect, Web-Http-Logging, Web-Custom-Logging, Web-Log-Libraries, Web-Request-Monitor, Web-Http-Tracing, Web-Stat-Compression, Web-Dyn-Compression, Web-Filtering, Web-Basic-Auth, Web-Client-Auth, Web-Cert-Auth, Web-IP-Security, Web-Url-Auth, Web-Windows-Auth, Web-Net-Ext45, Web-AppInit, Web-ASP, Web-Asp-Net45, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Includes, Web-WebSockets, Web-Mgmt-Console, Web-Mgmt-Compat, Web-Scripting-Tools, Web-Mgmt-Service, NET-Framework-Core, NET-Framework-45-ASPNET, NET-WCF-HTTP-Activation45] action install (C:\/cinc-project\/cinc\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.7.61-universal-mingw32\/lib\/chef\/resource\/windows_feature.rb line 137)\r\n\r\n       [2021-12-20T23:12:08+00:00] DEBUG: Caching Windows features available via Get-WindowsFeature.\r\n\r\n       [2021-12-20T23:12:09+00:00] DEBUG: The powershell cache contains\r\n\r\n       {\"enabled\"=>[\"fileandstorage-services\", \"storage-services\", \"web-server\", \"web-webserver\", \"web-common-http\", \"web-default-doc\", \"web-http-errors\", \"web-static-content\", \"web-http-redirect\", \"web-health\", \"web-http-logging\", \"web-custom-logging\", \"web-log-libraries\", \"web-request-monitor\", \"web-http-tracing\", \"web-performance\", \"web-stat-compression\", \"web-dyn-compression\", \"web-security\", \"web-filtering\", \"web-basic-auth\", \"web-client-auth\", \"web-cert-auth\", \"web-ip-security\", \"web-url-auth\", \"web-windows-auth\", \"web-app-dev\", \"web-net-ext45\", \"web-appinit\", \"web-asp\", \"web-asp-net45\", \"web-isapi-ext\", \"web-isapi-filter\", \"web-includes\", \"web-websockets\", \"web-mgmt-tools\", \"web-mgmt-console\", \"web-mgmt-compat\", \"web-metabase\", \"web-scripting-tools\", \"web-mgmt-service\", \"net-framework-45-features\", \"net-framework-45-core\", \"net-framework-45-aspnet\", \"net-wcf-services45\", \"net-wcf-http-activation45\", \"net-wcf-tcp-portsharing45\", \"powershellroot\", \"powershell\", \"was\", \"was-process-model\", \"was-config-apis\", \"wow64-support\", \"xps-viewer\"], \"disabled\"=>[\"ad-certificate\", \"adcs-cert-authority\", \"adcs-enroll-web-pol\", \"adcs-enroll-web-svc\", \"adcs-web-enrollment\", \"adcs-device-enrollment\", \"adcs-online-cert\", \"ad-domain-services\", \"adfs-federation\", \"adlds\", \"adrms\", \"adrms-server\", \"adrms-identity\", \"devicehealthattestationservice\", \"dhcp\", \"dns\", \"fax\", \"file-services\", \"fs-fileserver\", \"fs-branchcache\", \"fs-data-deduplication\", \"fs-dfs-namespace\", \"fs-dfs-replication\", \"fs-resource-manager\", \"fs-vss-agent\", \"fs-iscsitarget-server\", \"iscsitarget-vss-vds\", \"fs-nfs-service\", \"fs-syncshareservice\", \"hostguardianservicerole\", \"hyper-v\", \"networkcontroller\", \"npas\", \"print-services\", \"print-server\", \"print-internet\", \"print-lpd-service\", \"remoteaccess\", \"directaccess-vpn\", \"routing\", \"web-application-proxy\", \"remote-desktop-services\", \"rds-connection-broker\", \"rds-gateway\", \"rds-licensing\", \"rds-rd-server\", \"rds-virtualization\", \"rds-web-access\", \"volumeactivation\", \"web-dir-browsing\", \"web-dav-publishing\", \"web-odbc-logging\", \"web-certprovider\", \"web-digest-auth\", \"web-net-ext\", \"web-asp-net\", \"web-cgi\", \"web-ftp-server\", \"web-ftp-service\", \"web-ftp-ext\", \"web-lgcy-mgmt-console\", \"web-lgcy-scripting\", \"web-wmi\", \"wds\", \"wds-deployment\", \"wds-transport\", \"updateservices\", \"updateservices-widdb\", \"updateservices-services\", \"updateservices-db\", \"net-framework-features\", \"net-http-activation\", \"net-non-http-activ\", \"net-wcf-msmq-activation45\", \"net-wcf-pipe-activation45\", \"net-wcf-tcp-activation45\", \"bits\", \"bits-iis-ext\", \"bits-compact-server\", \"bitlocker\", \"bitlocker-networkunlock\", \"branchcache\", \"nfs-client\", \"containers\", \"data-center-bridging\", \"direct-play\", \"enhancedstorage\", \"failover-clustering\", \"gpmc\", \"hostguardian\", \"diskio-qos\", \"web-whc\", \"internet-print-client\", \"ipam\", \"isns\", \"lpr-port-monitor\", \"managementodata\", \"server-media-foundation\", \"msmq\", \"msmq-services\", \"msmq-server\", \"msmq-directory\", \"msmq-http-support\", \"msmq-triggers\", \"msmq-multicasting\", \"msmq-routing\", \"msmq-dcom\", \"multipath-io\", \"multipoint-connector\", \"multipoint-connector-services\", \"multipoint-tools\", \"nlb\", \"networkvirtualization\", \"pnrp\", \"qwave\", \"cmak\", \"remote-assistance\", \"rdc\", \"rsat\", \"rsat-feature-tools\", \"rsat-smtp\", \"rsat-feature-tools-bitlocker\", \"rsat-feature-tools-bitlocker-remoteadmintool\", \"rsat-feature-tools-bitlocker-bdeaducext\", \"rsat-bits-server\", \"rsat-datacenterbridging-lldp-tools\", \"rsat-clustering\", \"rsat-clustering-mgmt\", \"rsat-clustering-powershell\", \"rsat-clustering-automationserver\", \"rsat-clustering-cmdinterface\", \"ipam-client-feature\", \"rsat-nlb\", \"rsat-shielded-vm-tools\", \"rsat-snmp\", \"rsat-storage-replica\", \"rsat-wins\", \"rsat-role-tools\", \"rsat-ad-tools\", \"rsat-ad-powershell\", \"rsat-adds\", \"rsat-ad-admincenter\", \"rsat-adds-tools\", \"rsat-adlds\", \"rsat-hyper-v-tools\", \"hyper-v-tools\", \"hyper-v-powershell\", \"rsat-rds-tools\", \"rsat-rds-gateway\", \"rsat-rds-licensing-diagnosis-ui\", \"rds-licensing-ui\", \"updateservices-rsat\", \"updateservices-api\", \"updateservices-ui\", \"rsat-adcs\", \"rsat-adcs-mgmt\", \"rsat-online-responder\", \"rsat-adrms\", \"rsat-dhcp\", \"rsat-dns-server\", \"rsat-fax\", \"rsat-file-services\", \"rsat-dfs-mgmt-con\", \"rsat-fsrm-mgmt\", \"rsat-nfs-admin\", \"rsat-networkcontroller\", \"rsat-npas\", \"rsat-print-services\", \"rsat-remoteaccess\", \"rsat-remoteaccess-mgmt\", \"rsat-remoteaccess-powershell\", \"rsat-va-tools\", \"wds-adminpack\", \"rpc-over-http-proxy\", \"setup-and-boot-event-collection\", \"simple-tcpip\", \"fs-smb1\", \"fs-smb1-client\", \"fs-smb1-server\", \"fs-smbbw\", \"smtp-server\", \"snmp-service\", \"snmp-wmi-provider\", \"softwareloadbalancer\", \"storage-replica\", \"telnet-client\", \"tftp-client\", \"fabricshieldedtools\", \"webdav-redirector\", \"biometric-framework\", \"windows-defender\", \"windows-identity-foundation\", \"windows-internal-database\", \"powershell-v2\", \"dsc-service\", \"powershell-ise\", \"windowspowershellwebaccess\", \"was-net-environment\", \"search-service\", \"windows-server-backup\", \"migration\", \"windowsstoragemanagementservice\", \"microsoft-windows-subsystem-linux\", \"windows-tiff-ifilter\", \"winrm-iis-ext\", \"wins\", \"wireless-networking\"], \"removed\"=>[\"net-framework-core\"]}\r\n\r\n       [2021-12-20T23:12:09+00:00] DEBUG: Windows features needing installation: none\r\n```","comments":["So it looks like an exception will be thrown if there are any features are to be installed that are removed and a source is not defined explicitly on the resource or on that registry path: https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource\/windows_feature_powershell.rb#L233\r\n\r\nSo with that, would it be appropriate just to remove the `if new_resource.source` at https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource\/windows_feature_powershell.rb#L149 ? Source must have already been defined explicitly or via registry or we would have already thrown an exception."],"labels":["Priority: Medium","Platform: Windows","Status: Untriaged","Focus: Desktop"]},{"title":"Update Chef-Powershell-Shim to use .net core 6","body":".net core 6 is now released. We should start including builds of it in the code soon. \r\n\r\n.NET Core 6.0 is the current shipping version of the windows framework. Systems will start using\/needing this version. We need to start incorporating a new version of the shim DLL's that is based on this version to take advantage of new features, security enhancements, and bug fixes","comments":[],"labels":["Priority: Medium","Platform: Windows","Focus: Desktop"]},{"title":"Chef-client doesn't add the cookbook ohai plugin path to Ohai","body":"## Description\r\nWhen using a non default location for chef configuration and using a cookbook including an ohai plugin the cookbook plugin is not included when reloading ohai\r\n\r\n## Chef Version\r\n17+\r\n\r\n## Platform Version\r\nAll platforms\r\n\r\n## Replication Case\r\n\r\n- Clone https:\/\/github.com\/jgh9\/ec2-tags-ohai-plugin\/tree\/adjust-dependencies-cleanup\r\n- Comment line 23 in default recipe https:\/\/github.com\/jgh9\/ec2-tags-ohai-plugin\/blob\/adjust-dependencies-cleanup\/recipes\/default.rb#L23\r\n- Run kitchen test\r\n\r\n## Kitchen verify Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\nEC2 Tags plugin\r\n         File \"\/opt\/node.json\"\r\n           is expected to exist\r\n         created-by\r\n           should be test-kitchen\r\n         example-tag\r\n           should be example\r\n         File \"\/opt\/node_after.json\"\r\n           is expected to exist\r\n         created-by\r\n           should be test-kitchen (FAILED - 1)\r\n         example-tag\r\n           should be example (FAILED - 2)\r\n```\r\n\r\n## Stacktrace\r\nNA\r\n\r\n## Resolution\r\n\r\nAdd `Ohai::Config[:ohai][:plugin_path].push Chef::Config[:ohai_segment_plugin_path] unless Ohai::Config[:ohai][:plugin_path].include?(Chef::Config[:ohai_segment_plugin_path])` at start of recipe.\r\n\r\n## Discutions\r\n\r\nWhere should Chef-Client do this configuration ? In Chef::Config or in run_ohai ?\r\n","comments":["Is the non-default configuration location relevant to this?  Is the problem just that when reloading ohai through the ohai resource that we're not properly reloading the ohai cookbook segment plugins?","Quoted from the thread in slack, the route cause is: \r\n\r\nOhai calls: `ChefConfig::Config.platform_specific_path(\"\/etc\/chef\/ohai\/plugins\")` BUT chef-client ohai plugin management does a copy to `#{config_dir}\/ohai\/plugins`, in the case of kitchen it is not in \/etc\/chef but in \/tmp\/kitchen.\r\n\r\nAt first load it works because chef-client calls `Ohai::System.new.run_additional_plugins(Chef::Config[:ohai_segment_plugin_path])` but in case of a reload by the resource it runs :`:Ohai::System.new.all_plugins ` and ohai_plugin_path gets back to default at \/etc\/chef\/ohai\/plugins and never gets loaded."],"labels":["Priority: Medium"]},{"title":"Properties marked with both `desired_state: false` and `sensitive: true` are not suppressed","body":"## Description\r\nIf you specify `desired_state: false` on a property that also has `sensitive: true` the resulting property is not suppressed in the resource reporter.\r\n\r\n## Chef Version\r\n`17.8.25`\r\n\r\n## Platform Version\r\nCentOS 8\r\n\r\n## Replication Case\r\nWith the following custom resource:\r\n\r\n```ruby\r\nunified_mode true\r\n\r\nproperty :suppressed_content, String,\r\n         sensitive: true\r\n\r\nproperty :unsuppressed_content, String,\r\n         desired_state: false,\r\n         sensitive: true\r\n\r\naction :config do\r\n  throw 'throw an error'\r\nend\r\n```\r\n\r\nAnd recipe:\r\n\r\n```ruby\r\ndesiredstate_test 'test' do\r\n  suppressed_content 'foo'\r\n  unsuppressed_content 'bar'\r\nend\r\n```\r\n\r\n## Client Output\r\n\r\n## Stacktrace\r\n```\r\nResource Declaration:\r\n---------------------\r\n# In \/tmp\/kitchen\/cache\/cookbooks\/desiredstate\/recipes\/default.rb\r\n\r\n  1: desiredstate_test 'test' do\r\n  2:   suppressed_content 'foo'\r\n  3:   unsuppressed_content 'bar'\r\n  4: end\r\n\r\nCompiled Resource:\r\n------------------\r\n# Declared in \/tmp\/kitchen\/cache\/cookbooks\/desiredstate\/recipes\/default.rb:1:in `from_file'\r\n\r\ndesiredstate_test(\"test\") do\r\n  action [:config]\r\n  default_guard_interpreter :default\r\n  declared_type :desiredstate_test\r\n  cookbook_name \"desiredstate\"\r\n  recipe_name \"default\"\r\n  suppressed_content \"*sensitive value suppressed*\"\r\n  unsuppressed_content \"bar\"\r\nend\r\n\r\nSystem Info:\r\n------------\r\nchef_version=17.8.25\r\nplatform=centos\r\nplatform_version=8.2.2004\r\nruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x86_64-linux]\r\nprogram_name=\/opt\/cinc\/bin\/cinc-client\r\nexecutable=\/opt\/cinc\/bin\/cinc-client\r\n```\r\n","comments":[],"labels":["Type: Bug","Priority: Medium","Status: Good First Issue"]},{"title":"Clean Up Stale Windows version and VBScript references ","body":"Chef Infra client contains several references to older Windows versions that we don't support \/ should not be supporting at this point and also contains VBscript code that could be used to download the chef-client with. That should be removed in favor of the existing code to use PowerShell. \n\nThe 2 offending files are:\n\nwindows-chef-client-msi.erb\nwindows_bootstrap_context.rb","comments":[],"labels":["Priority: Low","Platform: Windows","Type: Chore","Focus: Desktop"]},{"title":"Cron is not idempotent when minute\/hour are integers","body":"## Description\r\nCron is not idempotent when minute\/hour are integers\r\n\r\n## Chef Version\r\n16.2.44 and last one too\r\n\r\n## Platform Version\r\nubuntu\r\n\r\n## Replication Case\r\nFor instance:\r\n```\r\ncron 'the-cron' do\r\n\tminute 1\r\n\thour 1\r\n\tday '*'\r\n\tmonth '*'\r\n\tweekday '*'\r\n\tcommand \"echo 'aa'\"\r\n\tnotifies :run, \"bash[touch]\", :immediately\r\nend\r\n\r\nbash 'touch' do\r\n\taction :nothing\r\n\tignore_failure true\r\n\tcode \"touch \/tmp\/aaa\"\r\nend\r\n```\r\n bash[touch] will be executed at every chef client run\r\n\r\nChanging 1 to '1' in minute and in hour fix the problem\r\n\r\n\r\n","comments":[],"labels":["Type: Bug","Priority: Medium","Status: Good First Issue","Backport: 16"]},{"title":"Secret dsl should retrieve region from secret identifier if it is an ARN for AWS Secrets Manager","body":"### Describe the Enhancement:\r\nIt is possible to reference AWS Secrets Manager secrets via an ARN or the \"friendly\" name that is local to the region.\r\n\r\n```\r\n:secret_id (required, String) \u2014 Specifies the secret containing the version that you want to retrieve. You can specify either the Amazon Resource Name (ARN) or the friendly name of the secret.\r\nFor an ARN, we recommend that you specify a complete ARN rather than a partial **ARN.**\r\n```\r\n\r\nhttps:\/\/docs.aws.amazon.com\/sdk-for-ruby\/v3\/api\/Aws\/SecretsManager\/Client.html#get_secret_value-instance_method\r\n\r\nIf a region is not specified in the `secret` helper\r\n\r\n`secret(name: 'test1', service: :aws_secrets_manager)`\r\n\r\nThen it looks in a couple of spots for it\r\n\r\n```\r\n # @note ':region' is required configuration.  If it is not explicitly provided,\r\n  # and it is not available via global AWS config, we will pull it from node ohai data by default.\r\n  # If this isn't correct, you will need to explicitly override it.\r\n  # If it is not available via ohai data either (such as if you have the AWS plugin disabled)\r\n  # then the converge will fail with an error.\r\n```\r\n\r\nIf an ARN is passed in as the secret identifier it should extract and use the region contained within since it is definitive over any other values it would be attempting to \"discover\"\r\n\r\n`secret(name: 'arn:aws:secretsmanager:us-east-2:00000000000:secret:test1-LX12CM', service: :aws_secrets_manager)`\r\n\r\n### Describe the Need:\r\nWe need to support pulling AWS Secrets Manager secrets regardless of datacenter\/region so we plan to pass in the full secret ARN and use that as the definitive location for it. It saves effort by not having to also explicitly define the region in the configuration as well.\r\n\r\n### Current Alternative\r\nRegion should be explicitly passed into the configuration when we're passing the identifier to ensure it's going to pull from the appropriate region.\r\n\r\n### Can We Help You Implement This?:\r\nIf `name` was accessible within `Chef::SecretFetcher` this would be pretty straight forward to implement\r\n\r\n```ruby\r\ndef validate!\r\n  if Aws::ARNParser.arn?(name)\r\n    config[:region] = Aws::ARNParser.parse(name).region\r\n  else\r\n    config[:region] = config[:region] || Aws.config[:region] || run_context.node.dig(\"ec2\", \"region\")\r\n  end\r\n  if config[:region].nil?\r\n    raise Chef::Exceptions::Secret::ConfigurationInvalid.new(\"Missing required config for AWS secret fetcher: :region\")\r\n  end\r\nend\r\n```","comments":[],"labels":["Type: Enhancement","Priority: Medium"]},{"title":"Add the ability to enable NTFS folder compression on Windows","body":"### Describe the Enhancement:\r\nAdd ability to enable NTFS folder compression on a directory on Windows.\r\n\r\n### Describe the Need:\r\nEnabling compression on a logs folder for example will result in much lower actual disk utilization as it's able to compress the plaintext files contained within.\r\n\r\n### Current Alternative\r\nWe currently utilize the following WMI call to perform the compression on a directory\r\n\r\n```\r\npowershell_script 'compress_logs_folder' do\r\n  code <<-EOH\r\n  Invoke-WmiMethod -Path \"Win32_Directory.Name='#{$path}'\" -Name compress | Out-Null\r\n  EOH\r\n  not_if \"if(Get-Item -path '#{path}' | Where-Object {$PSItem.Attributes -match 'Compressed'}){$true}else{$false}\"\r\nend\r\n```\r\n\r\nYou could also achieve this via `compact \/c \/s:c:\\docs *`\r\n\r\nhttps:\/\/serverfault.com\/questions\/977673\/how-to-enable-ntfs-folder-compression-on-windows-server-core\r\n\r\n### Can We Help You Implement This?:\r\nHow would you like to see this implemented? My preference would be an additional windows-only property on `directory` with something like `compression true` rather than it's own resource.\r\n","comments":["Yeah I think this is probably fine to do as a windows-only property on the directory resource.\r\n\r\nThe description of course should very clearly point out that it is windows only since the documentation will wind up being displayed for all consumers of the directory resource docs.\r\n\r\nAt some point in the future if this API grows more hairs, then it might be good to break out a specific windows_directory resource which `provides :directory, platform: \"windows\"` similarly to how the package providers work, but certainly that's way out of scope for this change, but just something to keep in mind.  As this has been pretty stable for 10+ years though I suspect that is going to wind up being unnecessary..."],"labels":["Type: Enhancement","Platform: Windows","Focus: Desktop"]},{"title":"Add a resource for firewalld","body":"We have a pretty clear path to legacy firewall management with the iptables resources, but newer systems use the firewalld project so we need to make sure we create a resource for firewall management on these newer systems.\r\n\r\n- CentOS 7 and newer\r\n- Fedora 18 and newer\r\n- OpenSUSE Leap 15 and newer\r\n- Red Hat Enterprise Linux 7 and newer\r\n- SUSE Linux Enterprise 15 and newer","comments":["https:\/\/github.com\/sjsadowski\/firewalld-cookbook","FWIW I think https:\/\/github.com\/sous-chefs\/firewall also has some code for firewalld.","The abstraction of the firewall cookbook isn't something we want to move into Chef though. Firewalls are different and we should just embrace that. In the past when we've tried magical abstraction it's ended in sadness for everyone.","@tas50 yeah, I wouldn't recommend you do that either, but I wasn't sure if there was any code in there that might be useful for this too specifically on firewalld. I'm not suggesting you import that whole cookbook :)","I'll take a look to see if there's anything we can lift :)"],"labels":["Type: Enhancement","Epic","Priority: High"]},{"title":"Add the ability to add certs to the *system* trusted cert store","body":"Make sure that Chef can be used to easily manage certs trusted at the system level. Not to be confused with the Infra Client trusted cert resource.","comments":[],"labels":["Status: Untriaged","Epic"]},{"title":"systemd_unit resource needs functional testing","body":"This has become a hotspot\/painpoint resource.  It appears to have no functional testing, and is not referenced in the kitchen-tests anywhere so all we have is unit tests which are very GIGO.  The level of confidence of changes working is pretty low.  If we had functional tests which were tested on all our architectures we could ensure that the changes had real coverage and at least worked on the latest releases of rhel6\/7\/8 rather than relying on customers to be our break-fix CI pipeline.\r\n\r\nrelated issues:\r\n\r\n#12240\r\n#11742 \r\n#11735 \r\n#11433\r\n#9093 \r\n\r\nthis was all kicked off by #10921 i think\r\n\r\n\r\n","comments":[],"labels":["Priority: Critical","Type: Chore"]},{"title":"Bootstrapping testing improvements","body":"Ensure that bootstrapping is fully tested so that customers have confidence in bootstrapping:\n\n### Work to Do (probably needs work)\n\n- Linux Workstation to macOS\n- Linux Workstation to Windows using WinRM\n- Linux Workstation to Windows using SSH\n- Linux Workstation to Linux\n- Linux Workstation to AIX\n- Linux Workstation to Solaris\n- macOS Workstation to Linux\n- macOS Workstation to Windows\n- macOS Workstation to macOS\n- Windows Workstation to Windows\n- Windows Workstation to Linux\n- Windows Workstation to macOS\n- Linux Workstation to Linux system using sudo\n- Linux Workstation to Linux system using jump host\n\n","comments":[],"labels":["Epic"]},{"title":"Port windows_certificate_binding to core","body":"We should include the ability to bind a Windows Certificate Store cert to a port.\r\n\r\nSee https:\/\/github.com\/chef-cookbooks\/windows_certificate_binding\r\n\r\n### Work to be done\r\n\r\n- Find an expert on doing this and determine if we have the idea right in the cookbook\r\n- Add tests to the cookbook\r\n- Confirm with customers this approach works\r\n- Move it to core\r\n- Gate the cookbook resource so the core resource wins","comments":[],"labels":["Platform: Windows","Status: Untriaged","Epic","Focus: Desktop"]},{"title":"Client side MTLS support","body":"Infra Server now supports MTLS validation and the client supports authentication using MTLS, but we are missing the ability to configure a client for MTLS communication and the ability to migrate keys to MTLS configuration. This epic includes stories to build out MTLS support in the client. When this is complete it should be possible for an existing customer to prepare their clients for MTLS communication once the server config change is made.","comments":[],"labels":["Status: Untriaged","Epic"]},{"title":"chef_gem and gem_package show WARN when used","body":"## Description\r\n\r\nNot sure when I started seeing this, but I know it's in the latest version of Chef Infra Client (i.e. 17.7.29). I haven't pushed the boundaries of this one, but it seems to happen with any gem you install.\r\n\r\nIt seems to actually install the package, it's just complaining.\r\n\r\n## Chef Version\r\n\r\nv17.7.29\r\n\r\n## Platform Version\r\n\r\nRed Hat 7\r\n\r\n## Replication Case\r\n\r\nUse either `chef_gem` or `gem_package` in a recipe\r\n\r\n```ruby\r\ngem_package \"colorize\"\r\n```\r\n\r\n```ruby\r\nchef_gem \"colorize\"\r\n```\r\n\r\n## Client Output\r\n\r\n```\r\n         * gem_package[colorize] action install[2021-11-04T13:18:56-04:00] INFO: Processing gem_package[colorize] action install (<cookbook_name_redacted>::<recipe_name_redacted> line 22)\r\n       WARN: Unresolved or ambiguous specs during Gem::Specification.reset:\r\n             minitest (>= 5.1)\r\n             Available\/installed versions of this gem:\r\n             - 5.14.4\r\n             - 5.14.2\r\n```\r\n\r\n## Stacktrace\r\n\r\nN\/A\r\n","comments":["either we're shipping 2 versions of minitest when we shouldn't (i'm not sure we should be shipping minitest at all?) or else you've somehow installed two versions.\r\n\r\nthe way that we appbundle everything in chef-client is supposed to eliminate that from happening on our end.\r\n\r\ni can't recall exactly how that error message happens but it is incredibly bad for perf on windows when it happens and rubygems goes into some kind of scan-the-entire-world-for-gems mode that can add many minutes to simple knife commands, etc.","did you ever figure this one out?  i don't think this is a bug on our side that we can fix.","> did you ever figure this one out? i don't think this is a bug on our side that we can fix.\r\n\r\nI think this is some unusual issue stemming from us installing the `activesupport` gem via `metadata.rb` `gem` setting."],"labels":["Platform: Windows","Status: Untriaged"]},{"title":"`service` and `systemd_unit` resources attempt to mask an already-masked service","body":"## Description\r\nchef-client attempts to mask a service that is already masked, using both a `service` and `systemd_unit` resource. \r\n\r\nOnly seems to impact CentOS 7 systems, do not have the same issue on CentOS 8.\r\n\r\nThis issue does not occur on chef-client version 16.16.13, but seems to start in version 17.1.35.\r\n\r\n## Chef Version\r\n17.7.29\r\n\r\n## Platform Version\r\nCentOS Linux release 7.4.1708 (Core)\r\n\r\n## Replication Case\r\nUsing the `firewalld` service as an example:\r\n1. Stop, disable, and mask the `firewalld` service using `sudo systemctl stop firewalld`, `sudo systemctl disable firewalld` and `sudo systemctl mask firewalld`\r\n2. Confirm that the service is masked using `systemctl status firewalld`, the output should look like:\r\n\r\n```\r\n[username@server ~]$ systemctl status firewalld\r\n\u25cf firewalld.service\r\n   Loaded: masked (\/dev\/null; bad)\r\n   Active: inactive (dead)\r\n```\r\n\r\n3. create a new `test.rb` recipe with the following content:\r\n\r\n```\r\nservice 'firewalld' do\r\n  action :mask\r\nend\r\n```\r\n\r\nOR\r\n\r\n```\r\nsystemd_unit 'firewalld' do\r\n  action :mask\r\nend\r\n```\r\n\r\n4. Run this file using `sudo chef-client -z -W test.rb`\r\n5. The output of this dry-run should indicate that it \"would mask\" the `firewalld` service\r\n\r\n## Client Output\r\n\r\n```\r\n  * service[firewalld] action mask\r\n    * Service status not available. Assuming a prior action would have installed the service.\r\n    * Assuming status of not running.\r\n    - Would mask service service[firewalld]\r\n\r\n\r\n\r\n  * systemd_unit[firewalld.service] action mask\r\n    - Would masking unit: firewalld.service\r\n```\r\n\r\n\r\nThe debug output:\r\n\r\n```\r\n * systemd_unit[firewalld.service] action mask[2021-11-03T16:49:36-04:00] INFO: Processing systemd_unit[firewalld.service] action mask (redacted::redacted line 19)\r\n\r\n    - Would masking unit: firewalld.service\r\n\r\n\r\n\r\n  * service[firewalld] action mask[2021-11-03T16:49:37-04:00] INFO: Processing service[firewalld] action mask (redacted::redacted line 15)\r\n\r\n    * Service status not available. Assuming a prior action would have installed the service.\r\n    * Assuming status of not running.\r\n    - Would mask service service[firewalld]\r\n\r\n```\r\n","comments":["This problem still exists in Chef 17.9.42 and RHEL7","This is still a problem on Ubuntu 20.04.  chef-client will attempt to mask the service during every client run.  For example:\r\n\r\n>   * systemd_unit[systemd-journald-audit.socket] action mask\r\n    - masking unit: systemd-journald-audit.socket\r\n\r\nThe issue appears to be with how systemctl reports the unit status.\r\n\r\nA masked service shows the unit file status as \"bad\", not \"masked\".\r\n\r\n> root@A3520A-VM:\/etc\/systemd\/system# \/bin\/systemctl --system show  -p UnitFileState -p ActiveState systemd-journald-audit.socket\r\nActiveState=inactive\r\nUnitFileState=bad\r\n\r\nCompare this to the output of `is-enabled` which properly shows the unit as masked.\r\n\r\n>root@A3520A-VM:\/etc\/systemd\/system# systemctl is-enabled systemd-journald-audit.socket\r\nmasked"],"labels":["Status: Untriaged"]},{"title":"windows_user_privilege unable to manage privilege when there is an unresolved SID","body":"## Description\r\n<!--- Briefly describe the issue -->\r\n\r\nWhen attempting to use the `windows_user_privilege`, `:set` and `:clear` actions will fail with an exception if there is one or more unresolvable SID entries in the privilege which is being modified.\r\n\r\n### Cause \/ Background\r\nWhen operating in a multi-user environment, accounts which have been added to privileges are often removed  as part of normal operations.  When this happens, accounts which were assigned to a privilege remain attached to the privilege as an unresolvable SID entry.\r\n\r\nThe `windows_user_privilege` resource attempts to enumerate\/translate the SID entry of every object as part of the remove action which is called during `:set` and `:clear` and when this is attempted against a SID which cannot be resolved the following exception is raised:\r\n\r\n```plain\r\n================================================================================\r\nError executing action `set` on resource 'windows_user_privilege[SeNetworkLogonRight]'\r\n================================================================================\r\n           \r\nChef::Exceptions::Win32APIError\r\n-------------------------------\r\nNo mapping between account names and security IDs was done.\r\n---- Begin Win32 API output ----\r\nSystem Error Code: 1332\r\nSystem Error Message: No mapping between account names and security IDs was done.\r\n---- End Win32 API output ----\r\n```\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n16, 17\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nWindows Server 2012R2+\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\nReplicating this case is fairly easy to do -- the following resources run in sequence in a recipe will replicate in an instance how this problem appears from other sources or causes in the wild:\r\n\r\n```ruby\r\n# Add a user to the system\r\nuser 'testuser'\r\n\r\n# Update a privilege to include the new user account\r\nwindows_user_privilege 'SeNetworkLogonRight' do\r\n  privilege 'SeNetworkLogonRight'\r\n  users ['BUILTIN\\\\Administrators', 'NT AUTHORITY\\\\Authenticated Users', 'testuser']\r\n  action :set\r\nend\r\n\r\n# Remove the added test user\r\nuser 'testuser' do\r\n  action :remove\r\nend\r\n\r\n# Attempt to manage the same privilege and an exception will be raised when the resource attempts to remove `testuser` from the listing\r\nwindows_user_privilege 'SeNetworkLogonRight' do\r\n  privilege 'SeNetworkLogonRight'\r\n  users ['BUILTIN\\\\Administrators', 'NT AUTHORITY\\\\Authenticated Users']\r\n  action :set\r\nend\r\n```\r\n\r\nIf you example the current listing of members on the system after the above has been run, an unresolved SID will be present with the `SeNetworkLogonRight` privilege\r\n\r\n```plain\r\n Privilege                                 PrivilegeName                                                      Principal                                      \r\n---------                                 -------------                                                      ---------                                      \r\nSeNetworkLogonRight                       Access this computer from the network                              NT AUTHORITY\\Authenticated Users               \r\nSeNetworkLogonRight                       Access this computer from the network                              *S-1-5-21-2312810669-3765546686-1080071345-1000\r\nSeNetworkLogonRight                       Access this computer from the network                              BUILTIN\\Administrators \r\n```\r\n\r\nIt is impossible to use the `windows_user_privilege` now for this resource until the unresolved SID has been removed from the privilege by some other means\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```plain\r\nChef Infra Client, version 17.6.18\r\nPatents: https:\/\/www.chef.io\/patents\r\nInfra Phase starting\r\nCreating a new client identity for default-windows using the validator key.\r\nUsing Policyfile 'kitchen_ec2' at revision '1f699315e735c7cf45a8b4c8a8f8b7b8c362da6eeb07d7e643a7b730fccd2135'\r\nResolving cookbooks for run list: [\"kitchen_ec2::default@0.1.0 (74e5b49)\"]\r\nSynchronizing cookbooks:\r\n  - kitchen_ec2 (0.1.0)\r\n  - logrotate (3.0.4)\r\nInstalling cookbook gem dependencies:\r\nCompiling cookbooks...\r\nLoading Chef InSpec profile files:\r\nLoading Chef InSpec input files:\r\nLoading Chef InSpec waiver files:\r\nConverging 5 resources\r\nRecipe: kitchen_ec2::default\r\n  * windows_user[testuser] action create\r\n    - create user testuser\r\n  * windows_user_privilege[SeNetworkLogonRight] action set\r\n    - removing user 'BUILTIN\\Backup Operators' from privilege SeNetworkLogonRight\r\n    - removing user 'BUILTIN\\Users' from privilege SeNetworkLogonRight\r\n    - removing user 'Everyone' from privilege SeNetworkLogonRight\r\n    - adding user 'NT AUTHORITY\\Authenticated Users' to privilege SeNetworkLogonRight\r\n    - adding user 'EC2AMAZ-JLP2H7V\\testuser' to privilege SeNetworkLogonRight\r\n  * windows_user[testuser] action remove\r\n    - remove user testuser\r\n  * windows_user_privilege[SeNetworkLogonRight] action set\r\n    \r\n    ================================================================================\r\n    Error executing action `set` on resource 'windows_user_privilege[SeNetworkLogonRight]'\r\n    ================================================================================\r\n    \r\n    Chef::Exceptions::Win32APIError\r\n    -------------------------------\r\n    No mapping between account names and security IDs was done.\r\n    ---- Begin Win32 API output ----\r\n    System Error Code: 1332\r\n    System Error Message: No mapping between account names and security IDs was done.\r\n    ---- End Win32 API output ----\r\n    \r\n    Resource Declaration:\r\n    ---------------------\r\n    # In C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/kitchen_ec2\/recipes\/default.rb\r\n    \r\n    21: windows_user_privilege 'SeNetworkLogonRight' do\r\n    22:   privilege 'SeNetworkLogonRight'\r\n    23:   users ['BUILTIN\\\\Administrators', 'NT AUTHORITY\\\\Authenticated Users']\r\n    24:   action :set\r\n    25: end\r\n    26: \r\n    \r\n    Compiled Resource:\r\n    ------------------\r\n    # Declared in C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/kitchen_ec2\/recipes\/default.rb:21:in `from_file'\r\n    \r\n    windows_user_privilege(\"SeNetworkLogonRight\") do\r\n      action [:set]\r\n      default_guard_interpreter :default\r\n      declared_type :windows_user_privilege\r\n      cookbook_name \"kitchen_ec2\"\r\n      recipe_name \"default\"\r\n      privilege [\"SeNetworkLogonRight\"]\r\n      users [\"BUILTIN\\\\Administrators\", \"NT AUTHORITY\\\\Authenticated Users\"]\r\n      principal \"SeNetworkLogonRight\"\r\n    end\r\n    \r\n    System Info:\r\n    ------------\r\n    chef_version=17.6.18\r\n    platform=windows\r\n    platform_version=10.0.20348\r\n    ruby=ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x64-mingw32]\r\n    program_name=C:\/opscode\/chef\/bin\/chef-client\r\n    executable=C:\/opscode\/chef\/bin\/chef-client\r\n    \r\n\r\nRunning handlers:\r\n[2021-10-26T13:17:03+00:00] ERROR: Running exception handlers\r\nRunning handlers complete\r\n[2021-10-26T13:17:03+00:00] ERROR: Exception handlers complete\r\nInfra Phase failed. 3 resources updated in 45 seconds\r\n[2021-10-26T13:17:03+00:00] FATAL: Stacktrace dumped to C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/chef-stacktrace.out\r\n[2021-10-26T13:17:03+00:00] FATAL: ---------------------------------------------------------------------------------------\r\n[2021-10-26T13:17:03+00:00] FATAL: PLEASE PROVIDE THE CONTENTS OF THE stacktrace.out FILE (above) IF YOU FILE A BUG REPORT\r\n[2021-10-26T13:17:03+00:00] FATAL: ---------------------------------------------------------------------------------------\r\n[2021-10-26T13:17:03+00:00] FATAL: Chef::Exceptions::Win32APIError: windows_user_privilege[SeNetworkLogonRight] (kitchen_ec2::default line 21) had an error: Chef::Exceptions::Win32APIError: No mapping between account names and security IDs was done.\r\n---- Begin Win32 API output ----\r\nSystem Error Code: 1332\r\nSystem Error Message: No mapping between account names and security IDs was done.\r\n---- End Win32 API output ----\r\n\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n\r\n```plain\r\nGenerated at 2021-10-26 13:17:03 +0000\r\nChef::Exceptions::Win32APIError: windows_user_privilege[SeNetworkLogonRight] (kitchen_ec2::default line 21) had an error: Chef::Exceptions::Win32APIError: No mapping between account names and security IDs was done.\r\n---- Begin Win32 API output ----\r\nSystem Error Code: 1332\r\nSystem Error Message: No mapping between account names and security IDs was done.\r\n---- End Win32 API output ----\r\n\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/win32\/error.rb:81:in `raise!'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/win32\/security.rb:469:in `lookup_account_sid'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/win32\/security.rb:238:in `block (2 levels) in get_account_with_user_rights'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/win32\/security.rb:236:in `times'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/win32\/security.rb:236:in `block in get_account_with_user_rights'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/win32\/security.rb:668:in `with_lsa_policy'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/win32\/security.rb:228:in `get_account_with_user_rights'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource\/windows_user_privilege.rb:172:in `block (2 levels) in <class:WindowsUserPrivilege>'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource\/windows_user_privilege.rb:171:in `each'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource\/windows_user_privilege.rb:171:in `block in <class:WindowsUserPrivilege>'\r\n(eval):2:in `block in action_set'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/provider.rb:301:in `instance_eval'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/provider.rb:301:in `compile_and_converge_action'\r\n(eval):2:in `action_set'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/provider.rb:242:in `run_action'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource.rb:600:in `block in run_action'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource.rb:627:in `with_umask'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource.rb:599:in `run_action'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/runner.rb:74:in `run_action'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/runner.rb:108:in `block in run_all_actions'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/runner.rb:108:in `each'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/runner.rb:108:in `run_all_actions'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/runner.rb:132:in `block in converge'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource_collection\/resource_list.rb:96:in `block in execute_each_resource'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:114:in `call_iterator_block'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:85:in `step'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:103:in `iterate'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:54:in `each_with_index'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/resource_collection\/resource_list.rb:94:in `execute_each_resource'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/3.0.0\/forwardable.rb:238:in `execute_each_resource'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/runner.rb:130:in `converge'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/client.rb:686:in `block in converge'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/client.rb:681:in `catch'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/client.rb:681:in `converge'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/client.rb:705:in `converge_and_save'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/client.rb:285:in `run'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/application.rb:305:in `run_with_graceful_exit_option'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/application.rb:281:in `block in run_chef_client'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/local_mode.rb:42:in `with_server_connectivity'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/application.rb:264:in `run_chef_client'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/application\/base.rb:352:in `run_application'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.6.18-universal-mingw32\/lib\/chef\/application.rb:67:in `run'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-bin-17.6.18\/bin\/chef-client:25:in `<top (required)>'\r\nC:\/opscode\/chef\/bin\/chef-client:170:in `load'\r\nC:\/opscode\/chef\/bin\/chef-client:170:in `<main>'\r\n```","comments":[],"labels":["Platform: Windows","Status: Untriaged","Focus: Desktop"]},{"title":"`--profile-ruby` is broken on Chef Infra Client v17.x macOS releases","body":"## Description\r\n`chef-client --profile-ruby` does not work and complains that the `ruby-prof` gem is not available.\r\n\r\n## Chef Version\r\n`Chef Infra Client: 17.4.38`\r\n\r\n## Platform Version\r\nmacOS Big Sur - 11.6 (20G165) running on Intel-based MacBook (`x86_64`)\r\n\r\n## Replication Case\r\n1. Install Chef Infra Client v16.13.16\r\n2. Run `sudo chef-client --profile-ruby` (succeeds)\r\n3. Upgrade local installation of Chef Infra Client to v17.4.38\r\n4. Run `sudo chef-client --profile-ruby` (fails with error shown below in `Client Output` section)\r\n5. Upgrade local installation of Chef Infra Client to v17.6.18\r\n6. Run `sudo chef-client --profile-ruby` (fails with error shown below in `Client Output` section)\r\n7. Upgrade local installation of Chef Infra Client to v17.7.8 (development release)\r\n8. Run `sudo chef-client --profile-ruby` (fails with error shown below in `Client Output` section)\r\n\r\nv17.4.38:\r\n```\r\n$ sudo chef-client --version\r\nChef Infra Client: 17.4.38\r\n$ sudo chef-client --profile-ruby\r\n[2021-10-21T10:29:25+02:00] FATAL: RuntimeError: You must have the ruby-prof gem installed in order to use --profile-ruby: cannot load such file -- ruby-prof\r\n```\r\n\r\nv17.6.18:\r\n```\r\n$ sudo chef-client --version\r\nChef Infra Client: 17.6.18\r\n$ sudo chef-client --profile-ruby\r\n[2021-10-21T10:37:05+02:00] FATAL: RuntimeError: You must have the ruby-prof gem installed in order to use --profile-ruby: cannot load such file -- ruby-prof\r\n```\r\n\r\nv17.7.8 (development release):\r\n```\r\n$ sudo chef-client --version\r\nChef Infra Client: 17.7.8\r\n$ sudo chef-client --profile-ruby\r\n[2021-10-21T10:41:46+02:00] FATAL: RuntimeError: You must have the ruby-prof gem installed in order to use --profile-ruby: cannot load such file -- ruby-prof\r\n```\r\n\r\n## Client Output\r\nv17.4.38:\r\n```\r\n$ sudo chef-client -l debug --profile-ruby\r\n[2021-10-21T10:31:36+02:00] DEBUG: Reading products and relationships...\r\n[2021-10-21T10:31:36+02:00] DEBUG: Successfully read products and relationships\r\n[2021-10-21T10:31:36+02:00] DEBUG: Searching for the following licenses: [\"infra-client\", \"inspec\"]\r\n[2021-10-21T10:31:36+02:00] DEBUG: Found license chef_infra_client at \/etc\/chef\/accepted_licenses\/chef_infra_client\r\n[2021-10-21T10:31:36+02:00] DEBUG: Found license inspec at \/etc\/chef\/accepted_licenses\/inspec\r\n[2021-10-21T10:31:36+02:00] DEBUG: Missing licenses remaining: []\r\n[2021-10-21T10:31:36+02:00] DEBUG: All licenses present\r\n[2021-10-21T10:31:36+02:00] DEBUG: Running Ohai with the following configuration: {:plugin_path=>[\"\/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/ohai-17.5.2\/lib\/ohai\/plugins\", \"\/etc\/chef\/ohai\/plugins\", \"\/etc\/chef\/ohai\/plugins\"], :plugin=>{:shard_seed=>{:sources=>[:uuid]}}, :directory=>\"\/etc\/chef\/ohai\/plugins\", :log_location=>\"\/etc\/chef\/ohai\", :logger=>Chef::Log}\r\n[2021-10-21T10:31:36+02:00] FATAL: RuntimeError: You must have the ruby-prof gem installed in order to use --profile-ruby: cannot load such file -- ruby-prof\r\n```\r\n\r\nv17.6.18:\r\n```\r\n$ sudo chef-client -l debug --profile-ruby                                                1 err  2.5.1 rb  10:37:05 AM\r\n[2021-10-21T10:37:14+02:00] DEBUG: Reading products and relationships...\r\n[2021-10-21T10:37:14+02:00] DEBUG: Successfully read products and relationships\r\n[2021-10-21T10:37:14+02:00] DEBUG: Searching for the following licenses: [\"infra-client\", \"inspec\"]\r\n[2021-10-21T10:37:14+02:00] DEBUG: Found license chef_infra_client at \/etc\/chef\/accepted_licenses\/chef_infra_client\r\n[2021-10-21T10:37:14+02:00] DEBUG: Found license inspec at \/etc\/chef\/accepted_licenses\/inspec\r\n[2021-10-21T10:37:14+02:00] DEBUG: Missing licenses remaining: []\r\n[2021-10-21T10:37:14+02:00] DEBUG: All licenses present\r\n[2021-10-21T10:37:14+02:00] DEBUG: Running Ohai with the following configuration: {:plugin_path=>[\"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/ohai-17.6.0\/lib\/ohai\/plugins\", \"\/etc\/chef\/ohai\/plugins\", \"\/etc\/chef\/ohai\/plugins\"], :plugin=>{:shard_seed=>{:sources=>[:uuid]}}, :directory=>\"\/etc\/chef\/ohai\/plugins\", :log_location=>\"\/etc\/chef\/ohai\", :logger=>Chef::Log}\r\n[2021-10-21T10:37:14+02:00] FATAL: RuntimeError: You must have the ruby-prof gem installed in order to use --profile-ruby: cannot load such file -- ruby-prof\r\n```\r\n\r\nv17.7.8 (development release):\r\n```\r\n$ sudo chef-client -l debug --profile-ruby\r\n[2021-10-21T10:41:54+02:00] DEBUG: Reading products and relationships...\r\n[2021-10-21T10:41:54+02:00] DEBUG: Successfully read products and relationships\r\n[2021-10-21T10:41:54+02:00] DEBUG: Searching for the following licenses: [\"infra-client\", \"inspec\"]\r\n[2021-10-21T10:41:54+02:00] DEBUG: Found license chef_infra_client at \/etc\/chef\/accepted_licenses\/chef_infra_client\r\n[2021-10-21T10:41:54+02:00] DEBUG: Found license inspec at \/etc\/chef\/accepted_licenses\/inspec\r\n[2021-10-21T10:41:54+02:00] DEBUG: Missing licenses remaining: []\r\n[2021-10-21T10:41:54+02:00] DEBUG: All licenses present\r\n[2021-10-21T10:41:54+02:00] DEBUG: Running Ohai with the following configuration: {:plugin_path=>[\"\/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/ohai-17.7.1\/lib\/ohai\/plugins\", \"\/etc\/chef\/ohai\/plugins\", \"\/etc\/chef\/ohai\/plugins\"], :plugin=>{:shard_seed=>{:sources=>[:uuid]}}, :directory=>\"\/etc\/chef\/ohai\/plugins\", :log_location=>\"\/etc\/chef\/ohai\", :logger=>Chef::Log}\r\n[2021-10-21T10:41:54+02:00] FATAL: RuntimeError: You must have the ruby-prof gem installed in order to use --profile-ruby: cannot load such file -- ruby-prof\r\n```\r\n\r\n## Stacktrace\r\nN\/A\r\n","comments":["It appears that the embedded `ruby-prof` gem didn't make its way into the v17.x releases:\r\n```\r\n$ chef-client --version && ls \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems | grep prof\r\nChef Infra Client: 16.13.16\r\ndrwxr-xr-x    8 root  wheel   256B Apr  9  2021 ruby-prof-1.2.0\r\n```\r\n\r\n```\r\n$ chef-client --version && ls \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems | grep prof\r\nChef Infra Client: 17.7.8\r\ndrwxr-xr-x    8 root  wheel   256B Oct 14 21:54 typeprof-0.12.0\r\n```","https:\/\/github.com\/chef\/chef\/pull\/11491\r\n\r\n@tas50 felt fairly strongly that it wasn't used much and should be removed by default in order to shrink the size of the binary so that users would need to gem install it","So if I wanted to continue using `--profile-ruby`, how would I go about that?\r\n\r\nI attempted this but it didn't go as I would've expected it:\r\n```\r\n$ rvm use 3.0.2\r\nUsing \/Users\/chefaustin\/.rvm\/gems\/ruby-3.0.2\r\n$ sudo gem install --install-dir \/opt\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/ruby-prof-1.4.3 ruby-prof -v 1.4.3\r\nBuilding native extensions. This could take a while...\r\nSuccessfully installed ruby-prof-1.4.3\r\nParsing documentation for ruby-prof-1.4.3\r\nInstalling ri documentation for ruby-prof-1.4.3\r\nDone installing documentation for ruby-prof after 0 seconds\r\n1 gem installed\r\n$ sudo chef-client --profile-ruby\r\n[2021-10-29T12:17:12+02:00] FATAL: RuntimeError: You must have the ruby-prof gem installed in order to use --profile-ruby: cannot load such file -- ruby-prof\r\n```\r\n\r\nI've also attempted to install the gem to the system Ruby's gem dir as well as to `rvm`'s managed gem dir, all of these attempts failed.","@tpowell-progress suggested I make an issue for the loss of ruby-prof so we can have some discussion prior to ChefConf. I don't typically resurrect old issues, but rather than creating a duplicate issue, will carry on in here (apologies @ChefAustin ;-)\r\n\r\n> #11491\r\n> \r\n> @tas50 felt fairly strongly that it wasn't used much and should be removed by default in order to shrink the size of the binary so that users would need to gem install it\r\n\r\nI'd like chime in on this one and disagree with some evidence.\r\n\r\n> `It's a 5 meg gem on windows`\r\n\r\nI won't speak to the windows client, but I will for the `el8` build, where the infra client RPM nearly doubled from 16.8.0 to 18.2.7 (31MB to 61MB). A quick `du -h \/opt\/chef\/` shows installed size went from 117MB to 200MB. This is in large part to a regression that pulled in chefstyle (see #13927), as well as several caches that aren't cleared in the omnibus build. That's just the low-hanging fruit, and I suspect dealing with that will address whatever added space ruby-prof takes up. It might be worth asking if there's a hard cap (or should be one) for package and on-disk utilization, so that features aren't cut without being weighed against other space wins if this truly is an issue.  \r\n\r\n> ` and it serves very little value.`\r\n\r\nI've found at least a dozen performance issues with this functionality this year alone, several of which were in the Chef Client, and have been upstreamed. Most notable was a **big** CPU regression that had been hiding out since *Chef 12* with #13733.\r\n\r\nWhile the `--profile-ruby` flag wasn't great, having the ruby-prof gem installed with the client was. A better interface could have leveraged the event hooks so that you could pinpoint parts of the run, to reduce stacktrace noise and get more rapid feedback. It could also have  allowed different report classes and measurement modes to be used.\r\n\r\nTrue, not all customers are going to be profiling their code, but it's unlikely that you'll find customers that want their Chef runs to be slower, either. Chef Infra Client is a big sprawl-y thing covering multiple repositories\/gems, and it's not always clear when the problem is a \"my code\" one or a \"client code\" one.\r\n\r\nBy having users `gem install` it, you're requiring your users to have a compilation toolchain on any host where they may want this. In some environments that's basically a non-starter. It places additional maintenance burden on customers who've had access to the `ruby-prof` gem in the client since Chef 12.\r\n\r\nThis isn't a workstation matter like `rubocop` or `knife` getting moved to workstation - if I want to profile a host's Chef run, it has to be on that host.\r\n\r\nThis is getting long (sorry!), so I'll note that this feature removal was omitted from https:\/\/docs.chef.io\/release_notes_client and https:\/\/docs.chef.io\/chef_deprecations_client\/#all-deprecations","Since I'm getting @'d on this one I might as well chime in. I think the main customers concerned about package size are gone and omnibus bugs basically reverted all the package size wins, so one more isn't going to hurt at this point."],"labels":["Status: Untriaged","Focus: Desktop"]},{"title":"Cleanup how we install the windows event log DLL","body":"We should make it so this DLL works correctly in a gem install. Right now we move it into place in omnibus. This mirrors the work we've done with the PowerShell DLLs recently.","comments":[],"labels":["Platform: Windows","Type: Tech Debt"]},{"title":"Chef resource inspector should support cookbooks with libraries","body":"### Describe the Enhancement:\r\n`chef-resource-inspector` should run successfully against custom cookbooks. If there are specific configurations required to make it run successfully, maybe there should be additional cops added to cookstyle?\r\n\r\nThis works successfully against basic cookbooks such as `sous-chefs\\nscd`\r\n\r\n`cinc-resource-inspector \"C:\\git_workspace\\sous-chefs\\nscd\"`\r\n\r\nBut fails against others such as `sous-chefs\\tomcat`\r\n\r\n```\r\nC:\/git_workspace\/sous-chefs\/tomcat\/resources\/install.rb:20:in `class_from_file': uninitialized constant #<Class:0x0000011cd7943c58>::TomcatCookbook (NameError)\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/mixin\/from_file.rb:47:in `class_eval'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/mixin\/from_file.rb:47:in `class_from_file'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource\/lwrp_base.rb:55:in `build_from_file'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_inspector.rb:92:in `block in extract_cookbook'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_inspector.rb:90:in `each'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_inspector.rb:90:in `each_with_object'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_inspector.rb:90:in `extract_cookbook'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_inspector.rb:110:in `block in inspect'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_inspector.rb:108:in `each'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_inspector.rb:108:in `each_with_object'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_inspector.rb:108:in `inspect'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_inspector.rb:122:in `start'\r\n        from C:\/cinc-project\/cinc-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-bin-17.4.38\/bin\/cinc-resource-inspector:26:in `<top (required)>'\r\n        from C:\/cinc-project\/cinc-workstation\/bin\/cinc-resource-inspector:385:in `load'\r\n        from C:\/cinc-project\/cinc-workstation\/bin\/cinc-resource-inspector:385:in `<main>'\r\n```\r\n\r\nIf I were to guess, when the cookbook is evaluated and the resources loaded, there is no context of libraries so it runs into errors with any include statements.\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource_inspector.rb#L82\r\n\r\n### Describe the Need:\r\n`chef-resource-inspector` could be used against cookbooks to auto-generate documentation for custom resources.\r\n\r\n### Current Alternative\r\n<!--- Is there a current alternative that you can utilize to workaround the lack of this enhancement -->\r\n\r\n### Can We Help You Implement This?:\r\nIf there's any direction\/thoughts you have on what I could poke at, I'd be happy to try and dig into this some.\r\n","comments":[],"labels":["Status: Untriaged","Focus: Desktop"]},{"title":"The integration between the compliance phase in chef-client and inspec with reporters\/fetchers needs to be cleaned up","body":"We've built a pluggable reporter infrastructure in chef-client on top of the pluggable reporter infrastructure in inspec.\r\n\r\nThe chef-client reporter plugins should probably be actual inspec plugins.\r\n\r\nThe cli plugin for chef-client should be an inspec plugin which fires chef-client events (and a formatter that formats them).\r\n\r\nI get no visual output of waived tests at all either from the inspec cli plugin or the chef-client compliance cli plugin.\r\n\r\nThe compliance segment in cookbooks should probably support custom reporters and plugins (in addition to profiles, waivers and inputs).\r\n\r\nI don't know why it was all built this way, but I suspect it was either built by different teams who both built a plugin architecture or the plugging reporting output in inspec lagged somehow the need for pluggable reporters in the audit cookbook so it got built backwards.\r\n\r\nSome of the chef-client plugins inherited from the audit cookbooks should probably be pushed up into inspec itself.\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Windows Event Viewer is missing event\/formatter logs","body":"## Description\r\n\r\nWhen the Chef Infra Client is configured to log to the Windows Event Viewer you do not get any of the event logs, i.e.\r\n\r\nThis isn't totally true, I think you get whatever is in `Chef::EventLoggers::WindowsEventLogger` but it's missing a lot from what would normally be logged to a file or `STDOUT`.\r\n\r\nI'm honestly perplexed by the relationship between these types `Chef::EventLoggers`, `Chef::Formatters`, and `Chef::Log`\r\n\r\nI think the big missing ones are:\r\n\r\n- (skipped due to only if)\r\n- (up to date)\r\n- etc\r\n\r\nOther...\r\n\r\n- `@events.cookbook_sync_complete`\r\n- `@events.cookbook_sync_start(cookbook_count)`\r\n- `@events.library_load_start(count_files_by_segment(:libraries))`\r\n- `@events.removed_cookbook_file(cache_file)`\r\n- `@events.synchronized_cookbook(file.cookbook.name, file.cookbook)`\r\n- `@events.updated_cookbook_file(file.cookbook.name, cache_filename)`\r\n- `@run_context.events.resource_update_applied(new_resource, :create, \"execute the whyrun_safe_ruby_block #{new_resource.name}\")`\r\n- `events.converge_complete`\r\n- `events.converge_failed(e)`\r\n- `events.converge_start(run_context)`\r\n- `events.cookbook_gem_failed(e)`\r\n- `events.cookbook_gem_finished`\r\n- `events.cookbook_gem_start(cookbook_gems)`\r\n- `events.cookbook_resolution_complete(cookbook_hash)`\r\n- `events.cookbook_resolution_complete(cookbook_versions_by_name)`\r\n- `events.cookbook_resolution_failed(@expanded_run_list_with_versions, e)`\r\n- `events.cookbook_resolution_failed(run_list_with_versions_for_display, e)`\r\n- `events.cookbook_resolution_start(@expanded_run_list_with_versions)`\r\n- `events.cookbook_resolution_start(run_list_with_versions_for_display)`\r\n- `events.handler_executed(handler)`\r\n- `events.handlers_completed`\r\n- `events.handlers_start(exception_handlers.size)`\r\n- `events.handlers_start(report_handlers.size)`\r\n- `events.node_load_completed(node, @expanded_run_list_with_versions, Chef::Config)`\r\n- `events.node_load_completed(node, run_list_with_versions_for_display, Chef::Config)`\r\n- `events.node_load_failed(node_name, e, Chef::Config)`\r\n- `events.node_load_failed(node_name, e, config)`\r\n- `events.node_load_start(node_name, config)`\r\n- `events.ohai_completed(node)`\r\n- `events.policyfile_loaded(policy)`\r\n- `events.provider_requirement_failed(action, resource, @exception_type, @failure_message)`\r\n- `events.registration_start(node_name, config)`\r\n- `events.resource_action_start(self, action, notification_type, notifying_resource)`\r\n- `events.resource_bypassed(@new_resource, @action, self)`\r\n- `events.resource_current_state_load_bypassed(@new_resource, @action, @current_resource)`\r\n- `events.resource_current_state_loaded(@new_resource, @action, @current_resource)`\r\n- `events.resource_failed(self, action, e)`\r\n- `events.resource_failed_retriable(self, action, remaining_retries, e)`\r\n- `events.resource_skipped(self, action, conditional)`\r\n- `events.resource_up_to_date(@new_resource, @action)`\r\n- `events.resource_update_applied(@resource, @action, descriptions)`\r\n- `events.resource_update_progress(new_resource, size, total, progress_interval)`\r\n- `events.resource_updated(@new_resource, @action)`\r\n- `events.run_completed(node, run_status)`\r\n- `events.run_failed(run_error, run_status)`\r\n- `events.run_start(Chef::VERSION, run_status)`\r\n- `events.run_started(run_status)`\r\n- `events.skipping_registration(client_name, config)`\r\n- `events.stream_output(self, str, options)`\r\n- `events.whyrun_assumption(action, resource, @whyrun_message) if @whyrun_message`\r\n- `run_context.events.deprecation(deprecation, location)`\r\n\r\nThis list may not be totally accurate, I attempted to get an accurate list with the following commands:\r\n\r\n```shell\r\n$ ack def lib\/chef\/formatters\/doc.rb | strip | sed 's|def ||g; s|(.*||g' | sort | xargs | tr ' ' '|'\r\n\r\n# Put that into the ack statement below:\r\n$ ack 'events\\.(converge_complete|converge_failed|converge_start|cookbook_clean_complete;|end|cookbook_clean_start;|end|cookbook_gem_failed|cookbook_gem_finished|cookbook_gem_installing|cookbook_gem_start|cookbook_gem_using|cookbook_resolution_complete|cookbook_resolution_failed|cookbook_resolution_start|cookbook_sync_complete|cookbook_sync_start|deprecation|deprecations|elapsed_time|file_loaded|handler_executed|handlers_completed|handlers_start|indent|initialize|library_load_start|node_load_completed|node_load_failed|node_load_start|ohai_completed|output_record|policyfile_loaded|pretty_elapsed_time|provider_requirement_failed|recipe_load_complete;|end|registration_completed;|end|registration_start|removed_cookbook_file|require|chef-utils\/dist|unless|defined?|resource_action_start|resource_bypassed|resource_current_state_load_bypassed|resource_current_state_loaded|resource_failed|resource_failed_retriable|resource_skipped|resource_up_to_date|resource_update_applied|resource_update_progress|resource_updated|run_completed|run_failed|run_start|skipping_registration|stream_output|synchronized_cookbook|total_resources|unindent|updated_cookbook_file|whyrun_assumption)' lib -h |sort | strip | sed 's|^|- `|g; s|$|`|g ' | sort | uniq\r\n```\r\n\r\n## Chef Version\r\n\r\nv16.13.16\r\n\r\n## Platform Version\r\n\r\n- Windows Server 2019\r\n\r\n## Replication Case\r\n\r\n1. Configure chef-client to log to Windows Event Viewer\r\n\r\n   ```\r\n   # C:\/chef\/client.rb\r\n   log_location :win_evt\r\n   ```\r\n\r\n2. Run `chef-client` \r\n\r\n   ```shell\r\n   chef-client\r\n   ```\r\n\r\n3. Look at chef client logs in the Windows Event Viewer\r\n\r\n## Digging and Discovery\r\n\r\nAfter reviewing how all of this is built, I observed the following things:\r\n\r\n1. When using the :win_evt in the log_location, the `Chef::Client` class does not configure any formatters (`Chef::Formatters`).\r\n   - source: https:\/\/github.com\/chef\/chef\/blob\/bc5469bfe0e84b3c8195f6265686738ee5059d71\/lib\/chef\/client.rb#L338-L349\r\n   - The `output_path` is not `nil` or a `String`, but is an instance of `Chef::Log::WinEvt` -- therefore no formatter gets created.\r\n   - This may be possible to fix by adding another `#print` method to `Chef::Mixin::Unformatter` but golly that would be ugly because it would break up the chef formatter output into a bunch of tiny log entries and I don't think that would be that useful. Maybe using the `Chef::Formatters::Minimal` would be a decent compromise.","comments":[],"labels":["Platform: Windows","Status: Untriaged","Focus: Desktop"]},{"title":"New behavior in Windows 20H2 breaks Font installation methods","body":"\r\n\r\n## Description\r\nAccording to [this stackoverflow comment](https:\/\/stackoverflow.com\/questions\/60972345\/powershell-script-to-install-font-family) fonts are always installed into `~\\AppData\\Local\\Microsoft\\Windows\\Fonts` even in an elevated shell. I confirmed this on my machine and I can see that all the chef installed fonts are in that folder.\r\n\r\nSince chef still checks `c:\\windows\\fonts` for installed fonts, it re-installs all the fonts, but the main problem is that it triggers a dialog asking the user to confirm that they want to re-install the font, which stalls the chef run.\r\n\r\nOur chef version is a bit old but I checked the source code on main branch and the offending code is still there: https:\/\/github.com\/chef\/chef\/blob\/main\/lib\/chef\/resource\/windows_font.rb#L87-L90\r\n\r\nI managed to bypass the issue by commenting out line 90; which triggers the dialog.\r\n\r\n\r\n## Chef Version\r\n15.8.23\r\n\r\n## Platform Version\r\nPlatform: x64-mingw32\r\nWindows 20H2, 19042.1165\r\n\r\n## Replication Case\r\nI cannot create a complete example since I am not very familiar with chef. But here is the steps:\r\n\r\nCreate a cookbook to install some fonts.\r\nRun the cookbook the first time, it succeeds\r\nRun the cookbook the second time, it shows the dialog asking to confirm installation of the font.\r\n\r\n## Client Output\r\nI cannot share logs since they contain confidential information.\r\n","comments":["@salehqt can you confirm this on a newer release of the client. I believe we did some work on the resource since 15.8"],"labels":["Platform: Windows","Status: Untriaged","Focus: Desktop"]},{"title":"windows_update_setting resource keeps updating unset values","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nwindows_update_settings Resource keeps updating  resources that were not part of the recipe\r\n\r\n## Chef Version\r\nChef Infra Client, version 17.4.38\r\n\r\n## Platform Version\r\nWindows 10 x64\r\nChef Workstation version: 21.9.613\r\nCookstyle version: 7.24.1\r\nChef Infra Client version: 17.4.38\r\nChef InSpec version: 4.41.20\r\nChef CLI version: 5.4.2\r\nChef Habitat version: 1.6.351\r\nTest Kitchen version: 3.0.0\r\n\r\n## Replication Case\r\nCreate a recipe that contains the following:\r\n```\r\nwindows_update_settings 'Configure Windows Update' do\r\n  automatic_update_option 2\r\n  disable_automatic_updates true\r\n  action :set\r\nend\r\n```\r\nthen run it locally twice, you will see that the values for TargetGroup, WUServer, and WUStatusServer keep being set.\r\n\r\n## Client Output\r\n```\r\nRecipe: bpo::update\r\n  * windows_update_settings[Configure Windows Update] action set\r\n    * registry_key[HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate] action create\r\n      - set value {:name=>\"TargetGroup\", :type=>:string, :data=>nil}\r\n      - set value {:name=>\"WUServer\", :type=>:string, :data=>nil}\r\n      - set value {:name=>\"WUStatusServer\", :type=>:string, :data=>nil}\r\n    * registry_key[HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer] action create (up to date)\r\n    * registry_key[HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU] action create (up to date)\r\n ```\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":[],"labels":["Type: Bug","Platform: Windows","Focus: Desktop"]},{"title":"service defined with init script not enabled in systemd system when using Chef 17","body":"## Description\r\nI have a service (supervisord) defined through an init script and I'm trying to enable it using Chef 17.2.9, with\r\n```\r\nservice \"supervisord\" do\r\n  action :enable\r\nend\r\n```\r\n\r\nChef trace log reports that service is already enabled, while service is actually not enabled\r\n\r\ntrace log\r\n```\r\nRecipe: aws-parallelcluster::supervisor\r\n  * service[supervisord] action enable[2021-09-17T12:31:17+00:00] INFO: Processing service[supervisord] action enable (aws-parallelcluster::supervisor line 25)\r\n[2021-09-17T12:31:17+00:00] TRACE: Providers for generic service resource enabled on node include: [Chef::Provider::Service::Systemd, Chef::Provider::Service::Debian, Chef::Provider::Service::Invokercd, Chef::Provider::Service::Init]\r\n[2021-09-17T12:31:17+00:00] TRACE: Provider for action enable on resource service[supervisord] is Chef::Provider::Service::Systemd\r\nActiveState=active\r\nUnitFileState=generated\r\n[2021-09-17T12:31:17+00:00] DEBUG: service[supervisord] already enabled - nothing to do\r\n (up to date)\r\n```\r\n\r\nstatus command\r\n```\r\n$ sudo systemctl is-enabled supervisord\r\nsupervisord.service is not a native service, redirecting to systemd-sysv-install.\r\nExecuting: \/lib\/systemd\/systemd-sysv-install is-enabled supervisord\r\ndisabled\r\n```\r\n\r\nThis behavior was not present in version 16.13.16 (defining same service)\r\n\r\ntrace log\r\n```\r\nRecipe: aws-parallelcluster::supervisor\r\n  * service[supervisord] action enable[2021-09-17T12:30:52+00:00] INFO: Processing service[supervisord] action enable (aws-parallelcluster::supervisor line 25)\r\n[2021-09-17T12:30:52+00:00] TRACE: Providers for generic service resource enabled on node include: [Chef::Provider::Service::Systemd, Chef::Provider::Service::Debian, Chef::Provider::Service::Invokercd, Chef::Provider::Service::Init]\r\n[2021-09-17T12:30:52+00:00] TRACE: Provider for action enable on resource service[supervisord] is Chef::Provider::Service::Systemd\r\nsupervisord.service is not a native service, redirecting to systemd-sysv-install.\r\nExecuting: \/lib\/systemd\/systemd-sysv-install is-enabled supervisord\r\ndisabled\r\nsupervisord.service is not a native service, redirecting to systemd-sysv-install.\r\nExecuting: \/lib\/systemd\/systemd-sysv-install is-enabled supervisord\r\ndisabled\r\nsupervisord.service is not a native service, redirecting to systemd-sysv-install.\r\nExecuting: \/lib\/systemd\/systemd-sysv-install enable supervisord\r\n[2021-09-17T12:30:53+00:00] INFO: service[supervisord] enabled\r\n\r\n    - enable service service[supervisord]\r\n```\r\n\r\nstatus command\r\n```\r\n$ sudo systemctl is-enabled supervisord\r\nsupervisord.service is not a native service, redirecting to systemd-sysv-install.\r\nExecuting: \/lib\/systemd\/systemd-sysv-install is-enabled supervisord\r\nenabled\r\n```\r\n\r\nI think the problem was introduced by this change  https:\/\/github.com\/chef\/chef\/commit\/61441313843055d16a28c8ab5e71e04cb71ba7a3\r\nbecause the function to check if service is enabled is\r\n\r\n```\r\n  def is_enabled?\r\n    # See https:\/\/github.com\/systemd\/systemd\/blob\/master\/src\/systemctl\/systemctl-is-enabled.c\r\n    # Note: enabled-runtime is excluded because this is volatile, and the state of enabled-runtime\r\n    # specifically means that the service is not enabled\r\n    %w{enabled static generated alias indirect}.include?(systemd_service_status[\"UnitFileState\"])\r\n  end\r\n```\r\n\r\nwhile the `systemd_service_status` function output is\r\n\r\n```\r\n$ \/bin\/systemctl --system show -p UnitFileState -p ActiveState supervisord\r\nActiveState=active\r\nUnitFileState=generated\r\n```\r\n\r\nso service is seen as enabled because `UnitFileState=generated` but the service is actually not enabled\r\n\r\n```\r\n$ sudo systemctl is-enabled supervisord\r\nsupervisord.service is not a native service, redirecting to systemd-sysv-install.\r\nExecuting: \/lib\/systemd\/systemd-sysv-install is-enabled supervisord\r\ndisabled\r\n```\r\n\r\nFollowing is the output of `systemctl --system show` while the service is still in disabled state\r\n```\r\n$ \/bin\/systemctl --system show supervisord\r\nType=forking\r\nRestart=no\r\nNotifyAccess=none\r\nRestartUSec=100ms\r\nTimeoutStartUSec=5min\r\nTimeoutStopUSec=5min\r\nTimeoutAbortUSec=5min\r\nRuntimeMaxUSec=infinity\r\nWatchdogUSec=0\r\nWatchdogTimestampMonotonic=0\r\nRootDirectoryStartOnly=no\r\nRemainAfterExit=yes\r\nGuessMainPID=no\r\nSuccessExitStatus=5 6\r\nMainPID=0\r\nControlPID=0\r\nFileDescriptorStoreMax=0\r\nNFileDescriptorStore=0\r\nStatusErrno=0\r\nResult=success\r\nReloadResult=success\r\nCleanResult=success\r\nUID=[not set]\r\nGID=[not set]\r\nNRestarts=0\r\nOOMPolicy=stop\r\nExecMainStartTimestampMonotonic=0\r\nExecMainExitTimestampMonotonic=0\r\nExecMainPID=0\r\nExecMainCode=0\r\nExecMainStatus=0\r\nExecStart={ path=\/etc\/init.d\/supervisord ; argv[]=\/etc\/init.d\/supervisord start ; ignore_errors=no ; start_time=[Fri 2021-09-17 13:29:35 UTC] ; stop_time=[Fri 2021-09-17 13:29:37 UTC] ; pid=11545 ; code=exited ; status=0 }\r\nExecStartEx={ path=\/etc\/init.d\/supervisord ; argv[]=\/etc\/init.d\/supervisord start ; flags= ; start_time=[Fri 2021-09-17 13:29:35 UTC] ; stop_time=[Fri 2021-09-17 13:29:37 UTC] ; pid=11545 ; code=exited ; status=0 }\r\nExecStop={ path=\/etc\/init.d\/supervisord ; argv[]=\/etc\/init.d\/supervisord stop ; ignore_errors=no ; start_time=[n\/a] ; stop_time=[n\/a] ; pid=0 ; code=(null) ; status=0\/0 }\r\nExecStopEx={ path=\/etc\/init.d\/supervisord ; argv[]=\/etc\/init.d\/supervisord stop ; flags= ; start_time=[n\/a] ; stop_time=[n\/a] ; pid=0 ; code=(null) ; status=0\/0 }\r\nSlice=system.slice\r\nControlGroup=\/system.slice\/supervisord.service\r\nMemoryCurrent=107732992\r\nCPUUsageNSec=[not set]\r\nEffectiveCPUs=\r\nEffectiveMemoryNodes=\r\nTasksCurrent=5\r\nIPIngressBytes=[no data]\r\nIPIngressPackets=[no data]\r\nIPEgressBytes=[no data]\r\nIPEgressPackets=[no data]\r\nIOReadBytes=18446744073709551615\r\nIOReadOperations=18446744073709551615\r\nIOWriteBytes=18446744073709551615\r\nIOWriteOperations=18446744073709551615\r\nDelegate=no\r\nCPUAccounting=no\r\nCPUWeight=[not set]\r\nStartupCPUWeight=[not set]\r\nCPUShares=[not set]\r\nStartupCPUShares=[not set]\r\nCPUQuotaPerSecUSec=infinity\r\nCPUQuotaPeriodUSec=infinity\r\nAllowedCPUs=\r\nAllowedMemoryNodes=\r\nIOAccounting=no\r\nIOWeight=[not set]\r\nStartupIOWeight=[not set]\r\nBlockIOAccounting=no\r\nBlockIOWeight=[not set]\r\nStartupBlockIOWeight=[not set]\r\nMemoryAccounting=yes\r\nDefaultMemoryLow=0\r\nDefaultMemoryMin=0\r\nMemoryMin=0\r\nMemoryLow=0\r\nMemoryHigh=infinity\r\nMemoryMax=infinity\r\nMemorySwapMax=infinity\r\nMemoryLimit=infinity\r\nDevicePolicy=auto\r\nTasksAccounting=yes\r\nTasksMax=37558\r\nIPAccounting=no\r\nUMask=0022\r\nLimitCPU=infinity\r\nLimitCPUSoft=infinity\r\nLimitFSIZE=infinity\r\nLimitFSIZESoft=infinity\r\nLimitDATA=infinity\r\nLimitDATASoft=infinity\r\nLimitSTACK=infinity\r\nLimitSTACKSoft=8388608\r\nLimitCORE=infinity\r\nLimitCORESoft=0\r\nLimitRSS=infinity\r\nLimitRSSSoft=infinity\r\nLimitNOFILE=524288\r\nLimitNOFILESoft=1024\r\nLimitAS=infinity\r\nLimitASSoft=infinity\r\nLimitNPROC=125195\r\nLimitNPROCSoft=125195\r\nLimitMEMLOCK=65536\r\nLimitMEMLOCKSoft=65536\r\nLimitLOCKS=infinity\r\nLimitLOCKSSoft=infinity\r\nLimitSIGPENDING=125195\r\nLimitSIGPENDINGSoft=125195\r\nLimitMSGQUEUE=819200\r\nLimitMSGQUEUESoft=819200\r\nLimitNICE=0\r\nLimitNICESoft=0\r\nLimitRTPRIO=0\r\nLimitRTPRIOSoft=0\r\nLimitRTTIME=infinity\r\nLimitRTTIMESoft=infinity\r\nOOMScoreAdjust=0\r\nNice=0\r\nIOSchedulingClass=0\r\nIOSchedulingPriority=0\r\nCPUSchedulingPolicy=0\r\nCPUSchedulingPriority=0\r\nCPUAffinity=\r\nCPUAffinityFromNUMA=no\r\nNUMAPolicy=n\/a\r\nNUMAMask=\r\nTimerSlackNSec=50000\r\nCPUSchedulingResetOnFork=no\r\nNonBlocking=no\r\nStandardInput=null\r\nStandardInputData=\r\nStandardOutput=journal\r\nStandardError=inherit\r\nTTYReset=no\r\nTTYVHangup=no\r\nTTYVTDisallocate=no\r\nSyslogPriority=30\r\nSyslogLevelPrefix=yes\r\nSyslogLevel=6\r\nSyslogFacility=3\r\nLogLevelMax=-1\r\nLogRateLimitIntervalUSec=0\r\nLogRateLimitBurst=0\r\nSecureBits=0\r\nCapabilityBoundingSet=cap_chown cap_dac_override cap_dac_read_search cap_fowner cap_fsetid cap_kill cap_setgid cap_setuid cap_setpcap cap_linux_immutable cap_net_bind_service cap_net_broadcast cap_net_admin cap_net_raw cap_ipc_lock cap>\r\nAmbientCapabilities=\r\nDynamicUser=no\r\nRemoveIPC=no\r\nMountFlags=\r\nPrivateTmp=no\r\nPrivateDevices=no\r\nProtectKernelTunables=no\r\nProtectKernelModules=no\r\nProtectKernelLogs=no\r\nProtectControlGroups=no\r\nPrivateNetwork=no\r\nPrivateUsers=no\r\nPrivateMounts=no\r\nProtectHome=no\r\nProtectSystem=no\r\nSameProcessGroup=no\r\nUtmpMode=init\r\nIgnoreSIGPIPE=no\r\nNoNewPrivileges=no\r\nSystemCallErrorNumber=0\r\nLockPersonality=no\r\nRuntimeDirectoryPreserve=no\r\nRuntimeDirectoryMode=0755\r\nStateDirectoryMode=0755\r\nCacheDirectoryMode=0755\r\nLogsDirectoryMode=0755\r\nConfigurationDirectoryMode=0755\r\nTimeoutCleanUSec=infinity\r\nMemoryDenyWriteExecute=no\r\nRestrictRealtime=no\r\nRestrictSUIDSGID=no\r\nRestrictNamespaces=no\r\nMountAPIVFS=no\r\nKeyringMode=private\r\nProtectHostname=no\r\nKillMode=process\r\nKillSignal=15\r\nRestartKillSignal=15\r\nFinalKillSignal=9\r\nSendSIGKILL=yes\r\nSendSIGHUP=no\r\nWatchdogSignal=6\r\nId=supervisord.service\r\nNames=supervisord.service\r\nRequires=system.slice sysinit.target\r\nWants=network-online.target supervisord.target\r\nConflicts=shutdown.target\r\nBefore=shutdown.target supervisord.target\r\nAfter=system.slice basic.target sysinit.target network-online.target systemd-journald.socket remote-fs.target nss-lookup.target\r\nDocumentation=man:systemd-sysv-generator(8)\r\nDescription=LSB: Start\/stop supervisor\r\nLoadState=loaded\r\nActiveState=active\r\nSubState=running\r\nFragmentPath=\/run\/systemd\/generator.late\/supervisord.service\r\nSourcePath=\/etc\/init.d\/supervisord\r\nUnitFileState=generated\r\nUnitFilePreset=enabled\r\nStateChangeTimestamp=Fri 2021-09-17 13:29:37 UTC\r\nStateChangeTimestampMonotonic=12163544517\r\nInactiveExitTimestamp=Fri 2021-09-17 13:29:35 UTC\r\nInactiveExitTimestampMonotonic=12162411997\r\nActiveEnterTimestamp=Fri 2021-09-17 13:29:37 UTC\r\nActiveEnterTimestampMonotonic=12163544517\r\nActiveExitTimestamp=Fri 2021-09-17 12:41:00 UTC\r\nActiveExitTimestampMonotonic=9247103248\r\nInactiveEnterTimestamp=Fri 2021-09-17 12:41:00 UTC\r\nInactiveEnterTimestampMonotonic=9247113862\r\nCanStart=yes\r\nCanStop=yes\r\nCanReload=no\r\nCanIsolate=no\r\nStopWhenUnneeded=no\r\nRefuseManualStart=no\r\nRefuseManualStop=no\r\nAllowIsolate=no\r\nDefaultDependencies=yes\r\nOnFailureJobMode=replace\r\nIgnoreOnIsolate=no\r\nNeedDaemonReload=no\r\nJobTimeoutUSec=infinity\r\nJobRunningTimeoutUSec=infinity\r\nJobTimeoutAction=none\r\nConditionResult=yes\r\nAssertResult=yes\r\nConditionTimestamp=Fri 2021-09-17 13:29:35 UTC\r\nConditionTimestampMonotonic=12162410715\r\nAssertTimestamp=Fri 2021-09-17 13:29:35 UTC\r\nAssertTimestampMonotonic=12162410715\r\nTransient=no\r\nPerpetual=no\r\nStartLimitIntervalUSec=10s\r\nStartLimitBurst=5\r\nStartLimitAction=none\r\nFailureAction=none\r\nSuccessAction=none\r\nInvocationID=ae1fb9de2f2a4fb482fe2a22d6f96433\r\nCollectMode=inactive\r\n```\r\n\r\n\r\n## Chef Version\r\nNot working in v17.2.9\r\nWas working in v16.13.16\r\n\r\n## Platform Version\r\nUbuntu18 and Ubuntu20\r\n\r\n","comments":["I just ran into this same issue.  Thanks @lukeseawalker for your detailed writeup.  For now, I ended up just creating a monkey patch that sets all the `is_<active|enabled|masked|indirect>?` methods back to their previous definition before the breaking change was introduced in https:\/\/github.com\/chef\/chef\/commit\/61441313843055d16a28c8ab5e71e04cb71ba7a3\r\n\r\nHopefully this can get fixed upstream at some point. It seems like using `systemctl --system show some.service` to check if a service is enabled does not work for non native services that are using systemd-sysv-install.  So I'm not sure what the correct fix could be except for going back to the old command.","I think a similar issue was reported here: https:\/\/github.com\/chef\/chef\/issues\/11979\r\n\r\nThere's also an open PR for reverting it back to the previous behavior, but there's no recent activity: https:\/\/github.com\/chef\/chef\/pull\/11980\r\n\r\nUpdate: Correction, the referenced issue, although similar, is for the `systemd_unit` resource instead of `service`, so not exactly the same after all.  The PR would not solve this issue unfortunately.","I'm facing the same issue with [GDRCopy](https:\/\/github.com\/NVIDIA\/gdrcopy) service on Ubuntu.\r\n\r\nRecipe:\r\n```\r\nservice node['cluster']['nvidia']['gdrcopy']['service'] do\r\n    action %i(enable start)\r\n    supports status: true\r\n  end\r\n```\r\n\r\nLog:\r\n```\u00a0\r\nRecipe: ...\r\n  * service[gdrdrv] action enable (up to date)\r\n  * service[gdrdrv] action start\r\n    - start service service[gdrdrv]\r\n```\r\nCheck\r\n```\u00a0\r\n$ sudo systemctl is-enabled gdrdrv\r\ngdrdrv.service is not a native service, redirecting to systemd-sysv-install.\r\nExecuting: \/lib\/systemd\/systemd-sysv-install is-enabled gdrdrv\r\ndisabled\r\n\r\n$ \/bin\/systemctl --system show -p UnitFileState -p ActiveState gdrdrv\r\nActiveState=active\r\nUnitFileState=generated\r\n```\r\nTo workaround this issue I had to use an explicit `execute` command:\r\n```\u00a0\r\n execute \"enable #{node['cluster']['nvidia']['gdrcopy']['service']} service\" do\r\n    command \"systemctl enable #{node['cluster']['nvidia']['gdrcopy']['service']}\"\r\n  end\r\n```\r\n"],"labels":["Type: Regression","Backport: 17"]},{"title":"Akeyless iam auth support","body":"Now that we have the akeyless secrets helper support in place we need to extend this to allow using AWS iam auth in the helper. This can be done in akeyless but requires API calls to their main service to get a token. We need to investigate the difficulty of doing this.","comments":[],"labels":["Aspect: Security","Triage: Feature Request","Epic","Focus: Secrets"]},{"title":"Excessive error message context","body":"## Description\r\n\r\nChef-client 17.4.38 provides 519MB of context information in the terminal on some failures in our environment.\r\n\r\nSince I use the open source cinc I filed a bug there first. They wanted me to file it upstream.  https:\/\/gitlab.com\/cinc-project\/distribution\/client\/-\/issues\/37. I repeat the information here:\r\n\r\n## Chef Version\r\n\r\n$ chef-client --version\r\nRedirecting to cinc-client\r\nCinc Client: 17.4.38\r\n\r\n## Platform Version\r\n\r\nDebian 11, fresh, updated install on a VM.\r\n\r\n## Replication Case\r\n\r\nI was fixing a php related recipe and made a mistake, I sent a reload notification to a execute resource:\r\n\r\n```\r\nRecipe: php::default\r\n  * execute[phpenmod timezone] action reload\r\n\r\n================================================================================\r\n    Error executing action `reload` on resource 'execute[phpenmod \r\ntimezone]'\r\n================================================================================\r\n```\r\n\r\nThe resulting error message started like this:\r\n\r\n```\r\n   NoMethodError\r\n    -------------\r\n    undefined method `action_reload' for \r\n#<Chef::Provider::Execute:0x0000559fb8683af0 \r\n@new_resource=<execute[phpenmod timezone] @name: \"phpenmod timezone\" \r\n@before: nil @params: {} @provider: nil @allowed_actions: [:nothing, \r\n:run] @action: [:nothing] @updated: false @updated_by_last_action: \r\nfalse @source_line: \r\n\"\/var\/cache\/chef\/cookbooks\/php\/recipes\/default.rb:45:in `from_file'\" \r\n@guard_interpreter: nil @default_guard_interpreter: :execute \r\n@elapsed_time: 0 @command: \"phpenmod timezone\" @is_guard_interpreter: \r\nfalse @declared_type: :execute @cookbook_name: \"php\" @recipe_name: \r\n\"default\" @domain: nil @user: nil>, @action=:reload, \r\n@current_resource=nil, @after_resource=nil, \r\n@run_context=#<Chef::RunContext:0x0000559fb52263c0 \r\n@events=#<Chef::EventDispatch::Dispatcher:0x\r\n```\r\n\r\nwhich seems reasonable.  But then it went on a bit.  I had to capture to a file:\r\n\r\n```\r\n# ls -l --si foo.log\r\n-rw-r--r-- 1 root root 519M aug.  26 14:39 foo.log\r\n```\r\n\r\n## Client Output\r\n\r\nSee above. I cannot provide the full log because it's unreasonable to vet for security issues.\r\n\r\n## Stacktrace\r\n\r\nSee above.\r\n","comments":["```\r\nlog_level          :warn\r\n```\r\nbtw","Yeah this is massive and across the board.  I've fixed it for a few new objects that I'm writing in #11904 but the approach there needs to be extracted into some kind of mixin\/DSL with probably a slightly nicer API than the rage-code one I threw together in that PR and then applied more generally.\r\n\r\nFundamentally its just because the run_context and\/or node tends to be an instance variable off of most objects and the inspect() method will iterate recursively through all instance variables and all their instances variables which inevitably prints the whole node object and resource collection.\r\n\r\nAnyone who wants to try to fix this one should probably talk to me first about exactly what I want to see in a design\/PR. "],"labels":["Status: Untriaged"]},{"title":"chef_client_config needs to include support for ssl_client_cert and ssl_client_key","body":"To support MTLS we need to elevate the `ssl_client_cert` and `ssl_client_key` and properties. This could be as simple as adding these with nil defaults or if we want to enable some magic we can make these properties automatically add to the client config if the files exist on disk. I'm open to debate on either of those approaches, but either way we need to make sure MTLS config on the client side is simple.","comments":[],"labels":["Aspect: Security","Triage: Feature Request","Focus: MTLS"]},{"title":"knife bootstrap needs to setup nodes for MTLS","body":"As we rollout MTLS we need to ensure that new nodes can be bootstrapped to use MTLS. This means knife bootstrap for both *nix and windows systems needs to be able to generate a client.rb file with `ssl_client_cert`\/`ssl_client_key` set and with the necessary key and cert on disk.","comments":[],"labels":["Aspect: Security","Triage: Feature Request","Focus: MTLS"]},{"title":"Develop a resource that converts an existing client.pem setup to one capable of MTLS","body":"```\r\nAs a Chef administrator\r\nI would like a way to programmatically setup nodes to use MTLS\r\nso that I can migrate existing systems to MTLS using Chef\r\n```\r\n\r\nCurrently, we have the ability to enable cert validation on the Infra Server and we have the ability to use the cert chain on the client, but we don't have a way to get existing clients setup for MTLS communication. We need to provide users with the tools in chef recipes to setup the x509 cert\/pem files given their existing client.pem and a CA cert.\r\n\r\n## Potential Look \/ Feel\r\n\r\nThis should be considered a high level idea. Change what you need.\r\n\r\n```ruby\r\nchef_client_mtls_cert_migration 'setup node mtls certs' do\r\n  ca_cert 'ABC123_I_AM_CERT_STRING'\r\nend\r\n```\r\n\r\n## Requirements\r\n\r\n- Resource is marked sensitive to prevent logs from containing the cert contents\r\n- takes ca cert either as string or as path on disk\r\n- has a property for specifying the client.pem location which defaults to the right location based on OS as determined by chef-config\r\n- Outputs cert and key to the default location\r\n","comments":["this seems fine.  the resource name is a mouthful, but i see the general sense of it.  `chef_client_mtls_conversion` is the only thing i can come up with as an alternative that maintains it in the `chef_client_*` \"namespace\" of resource prefixes.","The name should be part of that \"change what you need\" comment. If someone has some magical name I'm for it."],"labels":["Aspect: Security","Triage: Feature Request","Focus: MTLS"]},{"title":"`windows_certificate`  resource's `:delete` action (when no cert present) fails on v17 client","body":"## Description\r\nThe issue I am seeing is with the `windows_certificate` resource. Specifically, the issue occurs when one tries to `:delete` a certificate in the `'ROOT'` certificate store (but other cert stores may be affected as well) when the certificate does not exist. Rather than Chef client proceeding with the run (because it doesn\u2019t need to do anything with the certificate [because it does not exist]), the client run fails with `ArgumentError: Unable to retrieve the certificate (ArgumentError)`. \r\n\r\n## Chef Version\r\n- Fails on v17.4.38\r\n- Fails on v17.0.242\r\n- Succeeds on v16.14.1\r\n- Succeeds on v16.13.16\r\n\r\n## Platform Version\r\nMicrosoft Windows 10 21H1 (OS Build 19043.1202)\r\n\r\n## Replication Case\r\nUse `windows_certificate` resource (supply `source` thumbprint, and `store_name` of `'ROOT'` to attempt deletion of a certificate which does not exist in the store.\r\n\r\n## Client Output\r\n**Failure case (v17.0.242):**\r\n```\r\nchef (17.0.242)> recipe_mode\r\nirb: warn: can't alias ls from irb_ls.\r\nchef:recipe > windows_certificate 'Remove SennCom Certificate - ROOT' do\r\nchef:recipe >   source '1990649205b55eab5d692e9edb1be0ddd3b037de'\r\nchef:recipe >   action :delete\r\nchef:recipe >   store_name 'ROOT'\r\nchef:recipe (17.0.242)> end\r\n => <windows_certificate[Remove SennCom Certificate - ROOT] @name: \"Remove SennCom Certificate - ROOT\" @before: nil @params: {} @provider: nil @allowed_actions: [:nothing, :create, :acl_add, :delete, :fetch, :verify] @action: [:delete] @updated: false @updated_by_last_action: false @source_line: \"(irb#1):1:in `<main>'\" @guard_interpreter: nil @default_guard_interpreter: :default @elapsed_time: 0 @declared_type: :windows_certificate @cookbook_name: nil @recipe_name: nil @source: \"1990649205b55eab5d692e9edb1be0ddd3b037de\" @store_name: \"ROOT\">\r\nchef:recipe (17.0.242)> run_chef\r\n[2021-09-03T14:04:39+02:00] INFO: Processing windows_certificate[Remove SennCom Certificate - ROOT] action delete ((irb#1) line 1)\r\n\r\n================================================================================\r\nError executing action `delete` on resource 'windows_certificate[Remove SennCom Certificate - ROOT]'\r\n================================================================================\r\n\r\nArgumentError\r\n-------------\r\nUnable to retrieve the certificate\r\n\r\nResource Declaration:\r\n---------------------\r\n\r\n\r\nCompiled Resource:\r\n------------------\r\n# Declared in (irb#1):1:in `<main>'\r\n\r\nwindows_certificate(\"Remove SennCom Certificate - ROOT\") do\r\n  action [:delete]\r\n  default_guard_interpreter :default\r\n  declared_type :windows_certificate\r\n  source \"1990649205b55eab5d692e9edb1be0ddd3b037de\"\r\n  store_name \"ROOT\"\r\nend\r\n\r\nSystem Info:\r\n------------\r\nchef_version=17.0.242\r\nplatform=windows\r\nplatform_version=10.0.19043\r\nruby=ruby 3.0.1p64 (2021-04-05 revision 0fb782ee38) [x64-mingw32]\r\nprogram_name=C:\/opscode\/chef\/bin\/chef-shell\r\nexecutable=C:\/opscode\/chef\/embedded\/lib\/ruby\/3.0.0\/irb\/ext\/multi-irb.rb\r\n\r\n[2021-09-03T14:04:40+02:00] INFO: Running queued delayed notifications before re-raising exception\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/win32-certstore-0.6.2\/lib\/win32\/certstore\/store_base.rb:96:in `cert_get': windows_certificate[Remove SennCom Certificate - ROOT] ((irb#1) line 1) had an error: ArgumentError: Unable to retrieve the certificate (ArgumentError)\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/win32-certstore-0.6.2\/lib\/win32\/certstore.rb:78:in `get'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/resource\/windows_certificate.rb:199:in `fetch_cert'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/resource\/windows_certificate.rb:132:in `block in <class:WindowsCertificate>'\r\n        from (eval):2:in `block in action_delete'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/provider.rb:276:in `instance_eval'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/provider.rb:276:in `compile_and_converge_action'\r\n        from (eval):2:in `action_delete'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/provider.rb:217:in `run_action'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/resource.rb:599:in `block in run_action'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/resource.rb:626:in `with_umask'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/resource.rb:598:in `run_action'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/resource_collection\/resource_list.rb:96:in `block in execute_each_resource'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:114:in `call_iterator_block'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:85:in `step'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:103:in `iterate'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.0.242-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:54:in `each_with_index'\r\n        ... 4 levels...\r\nchef:recipe (17.0.242)> exit\r\n```\r\n\r\nFailure case (v17.4.38):\r\n```\r\nchef (17.4.38)> recipe_mode\r\nirb: warn: can't alias ls from irb_ls.\r\nchef:recipe > windows_certificate 'Remove SennCom Certificate - ROOT' do\r\nchef:recipe >   source '1990649205b55eab5d692e9edb1be0ddd3b037de'\r\nchef:recipe >   action :delete\r\nchef:recipe >   store_name 'ROOT'\r\nchef:recipe (17.4.38)> end\r\n => <windows_certificate[Remove SennCom Certificate - ROOT] @name: \"Remove SennCom Certificate - ROOT\" @before: nil @params: {} @provider: nil @allowed_actions: [:nothing, :create, :acl_add, :delete, :fetch, :verify] @action: [:delete] @updated: false @updated_by_last_action: false @source_line: \"(irb#1):1:in `<main>'\" @guard_interpreter: nil @default_guard_interpreter: :default @elapsed_time: 0 @declared_type: :windows_certificate @cookbook_name: nil @recipe_name: nil @source: \"1990649205b55eab5d692e9edb1be0ddd3b037de\" @store_name: \"ROOT\">\r\nchef:recipe (17.4.38)> run_chef\r\n[2021-09-03T10:48:26+02:00] INFO: Processing windows_certificate[Remove SennCom Certificate - ROOT] action delete ((irb#1) line 1)\r\n\r\n================================================================================\r\nError executing action `delete` on resource 'windows_certificate[Remove SennCom Certificate - ROOT]'\r\n================================================================================\r\n\r\nArgumentError\r\n-------------\r\nUnable to retrieve the certificate\r\n\r\nResource Declaration:\r\n---------------------\r\n\r\n\r\nCompiled Resource:\r\n------------------\r\n# Declared in (irb#1):1:in `<main>'\r\n\r\nwindows_certificate(\"Remove SennCom Certificate - ROOT\") do\r\n  action [:delete]\r\n  default_guard_interpreter :default\r\n  declared_type :windows_certificate\r\n  source \"1990649205b55eab5d692e9edb1be0ddd3b037de\"\r\n  store_name \"ROOT\"\r\nend\r\n\r\nSystem Info:\r\n------------\r\nchef_version=17.4.38\r\nplatform=windows\r\nplatform_version=10.0.19043\r\nruby=ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x64-mingw32]\r\nprogram_name=C:\/opscode\/chef\/bin\/chef-shell\r\nexecutable=C:\/opscode\/chef\/embedded\/lib\/ruby\/3.0.0\/irb\/ext\/multi-irb.rb\r\n\r\n[2021-09-03T10:48:26+02:00] INFO: Running queued delayed notifications before re-raising exception\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/win32-certstore-0.6.2\/lib\/win32\/certstore\/store_base.rb:96:in `cert_get': windows_certificate[Remove SennCom Certificate - ROOT] ((irb#1) line 1) had an error: ArgumentError: Unable to retrieve the certificate (ArgumentError)\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/win32-certstore-0.6.2\/lib\/win32\/certstore.rb:78:in `get'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource\/windows_certificate.rb:199:in `fetch_cert'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource\/windows_certificate.rb:132:in `block in <class:WindowsCertificate>'\r\n        from (eval):2:in `block in action_delete'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/provider.rb:301:in `instance_eval'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/provider.rb:301:in `compile_and_converge_action'\r\n        from (eval):2:in `action_delete'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/provider.rb:242:in `run_action'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource.rb:600:in `block in run_action'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource.rb:627:in `with_umask'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource.rb:599:in `run_action'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_collection\/resource_list.rb:96:in `block in execute_each_resource'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:114:in `call_iterator_block'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:85:in `step'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:103:in `iterate'\r\n        from C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.4.38-universal-mingw32\/lib\/chef\/resource_collection\/stepable_iterator.rb:54:in `each_with_index'\r\n        ... 4 levels...\r\nchef:recipe (17.4.38)>\r\n```\r\n\r\n**Success case (16.13.16):**\r\n```\r\nchef (16.13.16)> recipe_mode\r\nchef:recipe > windows_certificate 'Remove SennCom Certificate - ROOT' do\r\nchef:recipe > source '1990649205b55eab5d692e9edb1be0ddd3b037de'\r\nchef:recipe > action :delete\r\nchef:recipe > store_name 'ROOT'\r\nchef:recipe (16.13.16)> end\r\n => <windows_certificate[Remove SennCom Certificate - ROOT] @name: \"Remove SennCom Certificate - ROOT\" @before: nil @params: {} @provider: nil @allowed_actions: [:nothing, :create, :acl_add, :delete, :fetch, :verify] @action: [:delete] @updated: false @updated_by_last_action: false @source_line: \"(irb#1):1:in `irb_binding'\" @guard_interpreter: nil @default_guard_interpreter: :default @elapsed_time: 0 @declared_type: :windows_certificate @cookbook_name: nil @recipe_name: nil @source: \"1990649205b55eab5d692e9edb1be0ddd3b037de\" @store_name: \"ROOT\">\r\nchef:recipe (16.13.16)> run_chef\r\n[2021-09-03T11:00:05+02:00] INFO: Processing windows_certificate[Remove SennCom Certificate - ROOT] action delete ((irb#1) line 1)\r\n[2021-09-03T11:00:05+02:00] DEBUG: Certificate not found\r\n => true\r\nchef:recipe (16.13.16)>\r\n```\r\n\r\n**Success case (16.14.1):**\r\n```\r\nchef (16.14.1)> recipe_mode\r\nchef:recipe > windows_certificate 'Remove SennCom Certificate - ROOT' do\r\nchef:recipe > source '1990649205b55eab5d692e9edb1be0ddd3b037de'\r\nchef:recipe > action :delete\r\nchef:recipe > store_name 'ROOT'\r\nchef:recipe (16.14.1)> end\r\n => <windows_certificate[Remove SennCom Certificate - ROOT] @name: \"Remove SennCom Certificate - ROOT\" @before: nil @params: {} @provider: nil @allowed_actions: [:nothing, :create, :acl_add, :delete, :fetch, :verify] @action: [:delete] @updated: false @updated_by_last_action: false @source_line: \"(irb#1):1:in `irb_binding'\" @guard_interpreter: nil @default_guard_interpreter: :default @elapsed_time: 0 @declared_type: :windows_certificate @cookbook_name: nil @recipe_name: nil @source: \"1990649205b55eab5d692e9edb1be0ddd3b037de\" @store_name: \"ROOT\">\r\nchef:recipe (16.14.1)> run_chef\r\n[2021-09-03T14:15:37+02:00] INFO: Processing windows_certificate[Remove SennCom Certificate - ROOT] action delete ((irb#1) line 1)\r\n[2021-09-03T14:15:37+02:00] DEBUG: Certificate not found\r\n[2021-09-03T14:15:37+02:00] INFO: Processing windows_certificate[Remove SennCom Certificate - ROOT] action delete ((irb#1) line 1)\r\n[2021-09-03T14:15:38+02:00] DEBUG: Certificate not found\r\n => true\r\n```","comments":["I am thinking this might possibly stem from upgrading `win32-certstore` from `v.03` to `v0.5`.\r\n\r\nSpecifically, it looks like the `:delete` action relies upon `fetch_cert` [[1](https:\/\/github.com\/chef\/chef\/blob\/b91d99f16947b82d09217079f5423b5c7cd0962c\/lib\/chef\/resource\/windows_certificate.rb#L131-L141)] which in turn relies upon the `win32-certstore` Gem's `get` function [[2]](https:\/\/github.com\/chef\/chef\/blob\/b91d99f16947b82d09217079f5423b5c7cd0962c\/lib\/chef\/resource\/windows_certificate.rb#L193-L201) which calls to `cert_get` [[3]](https:\/\/github.com\/chef\/win32-certstore\/blob\/133e49768b66b57d602c39ff1400064b499dfa2b\/lib\/win32\/certstore.rb#L74-L79) which raises the `ArgumentError` when the certificate is unable to be found [[4]](https:\/\/github.com\/chef\/win32-certstore\/blob\/133e49768b66b57d602c39ff1400064b499dfa2b\/lib\/win32\/certstore\/store_base.rb#L90-L102).\r\n\r\nThis new `raise` logic was introduced in this [PR](https:\/\/github.com\/chef\/win32-certstore\/pull\/79) but I don't think it was realized that the `windows_certificate` resource's `:delete` action relies upon this method and, subsequently, the upstream code will need to handle that exception if the calling resource's action is `:delete`.","I think I might have found a solution for this issue by modifying the `:delete` action definition to:\r\n```\r\naction :delete, description: \"Deletes a certificate.\" do\r\n  begin\r\n    cert_obj = fetch_cert\r\n  rescue ArgumentError => e\r\n    raise e unless e.message == \"Unable to retrieve the certificate\"\r\n  else\r\n    if cert_obj\r\n      converge_by(\"Deleting certificate #{new_resource.source} from Store #{new_resource.store_name}\") do\r\n        delete_cert\r\n      end\r\n    end\r\n  end\r\nend\r\n```\r\nGiven that both `validate_thumprint` and `cert_get` return `ArgumentError` we need to differentiate between a _true_ failure (an `ArgumentError` returned by `validate_thumbprint`) and a _false_ failure (an `ArgumentError` returned by the conditional `if` block within `cert_get`'s definition) to determine whether or not to rescue the exception (in the instance that the certificate requested for deletion has already been deleted) or continue raising the exception up the stack (in the instance that the thumbprint does not validate, and resulting in a failed Chef run).\r\n\r\nOpen to alternative approaches but this seems sane-ish to me.","If there was a certificate_exists check in the lib then it shouldn't be throwing an exception for the arguments given IMO","I'm not sure why this was closed out prior to actually being fixed in a Chef Infra Client release. This problem is still impacting v17.10.3 because of at least two things:\r\n\r\n1. There hasn't been a release of win32-certstore with the fixes published to [rubygems.org](https:\/\/rubygems.org\/gems\/win32-certstore)\r\n2. chef infra client hasn't updated it's `Gemfile.lock`\r\n\r\n\/cc @johnmccrae","> I'm not sure why this was closed out prior to actually being fixed in a Chef Infra Client release. This problem is still impacting v17.10.3 because of at least two things:\n> \n> \n> \n> 1. There hasn't been a release of win32-certstore with the fixes published to [rubygems.org](https:\/\/rubygems.org\/gems\/win32-certstore)\n> \n> 2. chef infra client hasn't updated it's `Gemfile.lock`\n> \n> \n> \n> \/cc @johnmccrae\n\nAgreed. I've mentioned it to our Customer Success representatives over the past months and it never gained traction. I gave up.  "],"labels":["Type: Bug","Platform: Windows","Status: Untriaged","Focus: Desktop"]},{"title":"Log messages when allow \/ deny list for attributes is set makes no sense","body":"Chef Infra Client finished, 2\/787 resources updated in 24 seconds\r\n[2021-08-27T11:26:50-07:00] INFO: Allowing automatic node attributes for save.\r\n[2021-08-27T11:26:50-07:00] INFO: Allowing default node attributes for save.\r\n[2021-08-27T11:26:50-07:00] INFO: Allowing normal node attributes for save.\r\n[2021-08-27T11:26:50-07:00] INFO: Allowing override node attributes for save.\r\n\r\nThese messages aren't helpful in their current form.","comments":[],"labels":["Status: Untriaged"]},{"title":"Store Infra Client client.pem contents in the macOS Keychain","body":"I just realized we didn't actually have an issue for this even though it's on our roadmap for H2 2021.\r\n\r\nOnce we're done with moving client.pem contents into the Windows Certificate Store as the default we need to do the same on macOS hosts with the keychain. This requires logic in the client to read a predefined keychain location by default and to set this up during bootstrap with validation.pem files or via knife.","comments":["@tas50 Is this still something that is planned?","I'm no longer with Chef so I don't know where this sits in the product roadmap","Dustin, this has been archived for now. We still think this is important but want to finish some work against the Windows Certificate store. After that we will reevaluate and reprioritize. ","@johnmccrae just checking in to see if this is still on the roadmap, thanks!"],"labels":["Aspect: Security","Triage: Feature Request","Epic","Focus: Desktop"]},{"title":"The dscl group provider needs to not mutate the new_resource.gid","body":"It mutates it here:\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/627eb152ee532e138cb4f934f55d5cb311b1cbbf\/lib\/chef\/provider\/group\/dscl.rb#L64\r\n\r\nAnd here:\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/627eb152ee532e138cb4f934f55d5cb311b1cbbf\/lib\/chef\/provider\/group\/dscl.rb#L102\r\n\r\nThat needs to be removed so that the desired state on the new resource can get reused and is not changed by the provider.  For example, reusing the same resource object and calling the add action twice should call get_free_gid twice to get successive free gids and not memoize the free gid on the new_resource object.","comments":[],"labels":["Status: Untriaged","Focus: Desktop"]},{"title":"Add a way to deprecate an action with replacement","body":"We have the `deprecated_property_alias` method for aliasing actions with an alias, but we lack the ability to handle this for actions.\r\n\r\n1) Add `deprecated_action_alias`\r\n2) Make sure resource reporter does not include the deprecated actions","comments":[],"labels":["Type: Deprecation","Triage: Feature Request"]},{"title":"Chocolatey package provider doesn't allow downgrades when specifying version","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nWhen specifying a version for a chocolatey package, you can only roll forward, not back, because the invocation to `choco.exe` lacks the `--allow-downgrade` or `--force` flag.  It should probably either set `--allow-downgrade` every time or the provider should support `allow_downgrade` as an option (like, e.g., the yum package provider).\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nThis is true on master (and reading code, probably since the provider was introduced)\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nWindows 10 1803 (but should repeat on any Windows install)\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n1. Install a newer version of a package outside of chef\r\n2. Attempt to run `chef-client`\r\n3. error (pasted below)\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\nThe package name has been changed for illustrative purposes.\r\n\r\n```\r\nChocolatey installed 0\/1 packages. 1 packages failed.\r\n See the log for details (C:\\ProgramData\\chocolatey\\logs\\chocolatey.log).\r\n\r\nFailures\r\n - some-windows-package - A newer version of some-windows-package (v20210812.092429) is already installed.\r\n Use --allow-downgrade or --force to attempt to install older versions, or use side by side to allow multiple versions.\r\nSTDERR:\r\n---- End output of [\"C:\\\\ProgramData\\\\chocolatey\/bin\/choco.exe\", \"install\", \"-y\", \"--version\", \"20210810.135405\", \"some-windows-package\"] ----\r\nRan [\"C:\\\\ProgramData\\\\chocolatey\/bin\/choco.exe\", \"install\", \"-y\", \"--version\", \"20210810.135405\", \"some-windows-package\"] returned 1\r\n[2021-08-12 18:42:11 +0100] INFO chefctl.rb: chef-client.bat failed with exit code 1, check log output!\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\nN\/A","comments":["Reading code again this morning I realized that I can pass in arbitrary options to `choco.exe` using the `options` field, so I did that for now, but that's more of a workaround than a fix."],"labels":["Type: Bug","Platform: Windows","Focus: Desktop"]},{"title":"knife ssh exits with an error when selectively targeting hosts with \"on hostname; command\"","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nWhen trying to run commands in a knife ssh interactive session, commands against all hosts work as expected. When targeting specific hosts, there is an error that exits the ssh knife interactive session.\r\n\r\n## Chef Version\r\nThe version bundled inside chef-workstation 21.8.555\r\n```\r\n\u276f knife --version\r\nChef Infra Client: 17.3.48\r\n```\r\n\r\n## Platform Version\r\nMacOS Big Sur 11.5.1\r\n\r\n## Replication Case\r\n1. open a `knife ssh interactive` session with more than one host\r\n2. select a single host for a command with the `on` functionality, for example: `on 10.2.2.2; hostname`\r\n3. When the command is done, the interactive session will end with a ruby stacktrace of an error.\r\n\r\n## Client Output\r\nFull Debug output in this gist: https:\/\/gist.github.com\/komealy\/e0b3d8e703fea87da9c795fcc64f249b\r\n\r\n## Stacktrace\r\n```\r\nERROR: knife encountered an unexpected error\r\nThis may be a bug in the 'ssh' knife command or plugin\r\nPlease collect the output of this command with the `-VVV` option before filing a bug report.\r\nException: NoMethodError: undefined method `close' for \r\n#<Net::SSH::Multi::Subsession:0x00007fb24aac2610 @master=#<Net::SSH::Multi::Session:0x00007fb24ad63428 @server_list=#<Net::SSH::Multi::ServerList:0x00007fb24ad63388 @list=[\r\n#<Net::SSH::Multi::Server:0x71c komealy@10.3.4.51>, #<Net::SSH::Multi::Server:0x730 komealy@10.3.4.145>, \r\n#<Net::SSH::Multi::Server:0x744 komealy@10.3.140.201>,#<Net::SSH::Multi::Server:0x758 komealy@10.3.2.157>, \r\n#<Net::SSH::Multi::Server:0x76c komealy@10.3.85.95>, #<Net::SSH::Multi::Server:0x780 komealy@10.3.68.243>, \r\n#<Net::SSH::Multi::Server:0x794 komealy@10.3.3.101>, #<Net::SSH::Multi::Server:0x7a8 komealy@10.3.113.254>]>, \r\n@groups={}, @gateway=nil, @open_groups=[], @connect_threads=[], @on_error=#<Proc:0x00007fb24ad63518 \/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/knife-17.4.18\/lib\/chef\/knife\/ssh.rb:150>, \r\n@default_user=\"krisomealy\", @open_connections=1, @pending_sessions=[], @session_mutex=#<Thread::Mutex:0x00007fb24ad63130>, @concurrent_connections=10>, @servers=[#<Net::SSH::Multi::Server:0x780 komealy@10.3.68.243>]>\r\n```","comments":[],"labels":["Type: Bug","Focus: knife ssh"]},{"title":"Update Knife Bootstrap code to eliminate all vbscript","body":"the windows_bootstrap_context.rb file has a method called win_wget that uses wscript to do work on remote windows nodes. That needs to go away immediately. Also the fallback_install_task_command method looks like it needs to be sanitized and move to PowerShell_exec as well. ","comments":["Hi @johnmccrae,\r\n\r\nI have done some analysis on this issue and found that there are two methods `win_wget` and `win_wget_ps` in `windows_bootstrap_context.rb` seems like both of them are having the same functionality. and is getting called here  https:\/\/github.com\/chef\/chef\/blob\/main\/knife\/lib\/chef\/knife\/bootstrap\/templates\/windows-chef-client-msi.erb#L35. Just wanted to confirm before removing is PS completely supported by all windows versions we support so removing VS script will be completely safe? looks like it would be safe to remove VBScript as per [PowerShell support](https:\/\/docs.microsoft.com\/en-us\/powershell\/scripting\/windows-powershell\/install\/windows-powershell-system-requirements?view=powershell-7.1) & Chef [Client OS support ](https:\/\/docs.chef.io\/platforms\/#chef-infra-client)\r\n\r\nThe second thing regarding sanitizing the `fallback_install_task_command` method can you please describe a little what exactly we like to sanitize here and how are we going to use it in PowerShell_exec?\r\n\r\n","Hi, PowerShell is supported by default on all current versions of Windows. There are 2 versions of PowerShell - Windows PowerShell and PowerShell Core (aka just called PowerShell). Removing the vbscript is safe. \r\n\r\nThe fallback command seems really hard to read, I'd rewrite that in PowerShell. It's much cleaner and easier to understand","@johnmccrae can you also clarify on how we can use  `fallback_install_task_command` in `PowerShell_exec` its looks here we are just passing the scripts to run it through `PowerShell_exec`. Moving that method here, how will we going to use it for `PowerShell_exec` . Or may be we can move it into one module and call it in bootstrap by passing it to  `powershell_exec!` method like we have done other places?","update on this issue.\r\nI have done the part where we need to convert the VB to Powershell script [ref](https:\/\/github.com\/snehaldwivedi\/script\/blob\/main\/fallback_install_task_command.ps1). Now facing issue as it not recognizing PowerShell script directly in the knife, gives following error \r\n```\r\n\r\nC:\\Users\\Administrator\\Documents>Wait-Event -SourceIdentifier chefclientinstalldone -Timeout 600\r\nC:\\Users\\Administrator\\Documents> if(ERRORLEVEL -eq 1)\r\ncmd.exe : 'installation' is not recognized as an internal or external command,\r\n+ CategoryInfo : NotSpecified: ('installation' ...ternal command,:String) [], RemoteException\r\n+ FullyQualifiedErrorId : NativeCommandError\r\noperable program or batch file.'detected' is not recognized as an internal or external command,operable program or batch file.'$MSIERRORCODE' is not recognized as an internal or external command,operable program or batch file.'Write-Warning'...\r\n\r\n```\r\nTo make this work I have tried using PowerShell_exec (by requiring as well as by moving related files to the knife) but it keeps on  giving `Exception: NoMethodError: undefined method 'ffi_lib' for FFI:Module`. if we use the [standard](https:\/\/www.rubydoc.info\/github\/ffi\/ffi\/FFI\/Library) FFI library it works but as its overridden in chef its not able to found some methods. \r\n\r\nMy suggestion is to bifercate it into smaller issues as adding powershell to knife will require time. Or if there is any other solution through which Powershell script can work please let me know?\r\n","I have converted `fallback_install_task_command` VB script https:\/\/github.com\/chef\/chef\/blob\/main\/knife\/lib\/chef\/knife\/core\/windows_bootstrap_context.rb#L361 to PS script https:\/\/github.com\/snehaldwivedi\/script\/blob\/main\/fallback_install_task.ps1. This PS script is working perfectly fine if I run it directly on the windows remote node but it doesn't work in this `fallback_install_task_command` method tried different scenarios. Can anyone suggest something on why PowerShell is not getting executed on windows host when trying to execute it as part of the bootstrap command? \r\n<img width=\"910\" alt=\"PS bootstarp\" src=\"https:\/\/user-images.githubusercontent.com\/62747690\/144549033-92113767-c853-4889-a8e6-cc11704d3324.PNG\">\r\n\r\n\r\n","Hi, in your error window it shows you passing a PowerShell block to cmd.exe. Where\/how is PowerShell being called please?","Hi @johnmccrae,\r\n\r\nI have  tried  to send a powershell block to execute using `<<EOH` tags as it was working for VB script, but does not look like it gets executed.  \r\nFor detailed flow of this:\r\nthese `EOH` tags are under `fallback_install_task_command`  which is called under [install_chef](https:\/\/github.com\/chef\/chef\/blob\/main\/knife\/lib\/chef\/knife\/core\/windows_bootstrap_context.rb#L275)  method . And this is called through [windows-chef-client-msi.erb](https:\/\/github.com\/chef\/chef\/blob\/main\/knife\/lib\/chef\/knife\/bootstrap\/templates\/windows-chef-client-msi.erb#L197).\r\n\r\nPlease let me know if there is some other way to execute it?"],"labels":["Platform: Windows","Type: Tech Debt","Focus: knife bootstrap"]},{"title":"Skip data collector when we can't hit the server entirely","body":"Right now if you can't connect to the Infra Server entirely the error message is terrible. It's terrible in part because data collect then tries to run and fails for all the same reasons. When we can't get to the server at the begging of the run we shouldn't be running data collection.\r\n\r\n```\r\nStarting Chef Infra Client, version 17.3.48\r\nPatents: https:\/\/www.chef.io\/patents\r\nCreating a new client identity for tester using the validator key.\r\n[2021-07-31T04:37:20+00:00] ERROR: SSL Validation failure connecting to host: ec2-34-209-179-183.us-west-2.compute.amazonaws.com - SSL_connect returned=1 errno=0 state=error: certificate verify failed (self signed certificate)\r\n\r\n================================================================================\r\nChef encountered an error attempting to create the client \"tester\"\r\n================================================================================\r\n\r\nSystem Info:\r\n------------\r\nchef_version=17.3.48\r\nruby=ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux]\r\nprogram_name=\/usr\/bin\/chef-client\r\nexecutable=\/opt\/chef\/bin\/chef-client\r\n\r\n\r\nRunning handlers:\r\n[2021-07-31T04:37:20+00:00] ERROR: Running exception handlers\r\nRunning handlers complete\r\n[2021-07-31T04:37:20+00:00] ERROR: Exception handlers complete\r\nChef Infra Client failed. 0 resources updated in 12 seconds\r\n[2021-07-31T04:37:20+00:00] WARN: Failed to read the private key \/etc\/chef\/client.pem: #<Errno::ENOENT: No such file or directory @ rb_sysopen - \/etc\/chef\/client.pem>\r\n[2021-07-31T04:37:20+00:00] WARN: Error while reporting run start to Data Collector. URL: https:\/\/ec2-34-209-179-183.us-west-2.compute.amazonaws.com\/tim\/data-collector Exception: No HTTP Code -- I cannot read \/etc\/chef\/client.pem, which you told me to use to sign requests!\r\n[2021-07-31T04:37:20+00:00] WARN: Failed to read the private key \/etc\/chef\/client.pem: #<Errno::ENOENT: No such file or directory @ rb_sysopen - \/etc\/chef\/client.pem>\r\n[2021-07-31T04:37:20+00:00] WARN: Error while reporting run start to Data Collector. URL: https:\/\/ec2-34-209-179-183.us-west-2.compute.amazonaws.com\/tim\/data-collector Exception: No HTTP Code -- I cannot read \/etc\/chef\/client.pem, which you told me to use to sign requests!\r\n[2021-07-31T04:37:20+00:00] FATAL: Stacktrace dumped to \/var\/chef\/cache\/chef-stacktrace.out\r\n[2021-07-31T04:37:20+00:00] FATAL: Please provide the contents of the stacktrace.out file if you file a bug report\r\n[2021-07-31T04:37:20+00:00] FATAL: OpenSSL::SSL::SSLError: SSL Error connecting to https:\/\/ec2-34-209-179-183.us-west-2.compute.amazonaws.com\/tim\/clients - SSL_connect returned=1 errno=0 state=error: certificate verify failed (self signed certificate)\r\n```\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"validation.pem bootstrap on windows needs to use certificate store","body":"## Description\r\nIn order to support all scenarios of client.pem content being stored in the Windows Certificate Store we need to make sure that node bootstrap with a validation.pem file works as well.\r\n\r\nWhen chef-client is run and a validation.pem file is present the client.pem should optionally be created in the Windows Certificate Store. This will eventually become the default, but for now this will be controlled via a CLI flag.","comments":[],"labels":["Status: Untriaged","Focus: Desktop"]},{"title":"platform_helpers.rb uses WMI to test if Windows Node is domain joined","body":"## Description\r\nplatform_helpers.rb uses WMI to test if a Windows Node is domain joined. Lines 46 - 54. This should be updated to use CIM instead since WMI is deprecated.\r\n\r\n## Chef Version\r\nAll current versions\r\n\r\n## Platform Version\r\nWindows any\r\n\r\n## Replication Case\r\nLook at the code\r\n\r\n","comments":[],"labels":["Platform: Windows","Type: Chore","Focus: Desktop"]},{"title":"Skip Running handlers: logging if none exist.","body":"Right now we log this for most users w\/o a handler:\r\n\r\n```\r\nRunning handlers:\r\n```\r\n\r\nThis is totally pointless for 99.9% of users that don't have a handler. Just skip it if there's nothing to run.","comments":["We should probably nuke this one too if nothing is done:\r\n\r\n```Installing Cookbook Gems:```","Hi @tas50 could you please elaborate on where these lines show up? i.e. chef client run or any specific tool?","This is output when the chef-client itself is run."],"labels":["Status: Untriaged"]},{"title":"windows_service not setting password correctly. ","body":"\r\n\r\n## Description\r\non first run on some systems i have found the password is not setting correctly. my block is as follows\r\n```\r\n\r\nwindows_service 'Check_MK_Agent' do\r\n  action :configure\r\n  run_as_user node['SwyxMonitoring']['username']\r\n  run_as_password node['SwyxMonitoring']['psw']\r\n  notifies :run, 'batch[restartCheckMK]', :immediately\r\nend\r\n```\r\n\r\nafter this has actioned it then triggers a restart of that service which complains with a log on error. I have printed the attributes to console to ensure correct values are being passed and even copying the password which was printed to the log directly into the service it works. just not via chef. IT eventually does start working on some machines but annoying when im rolling this out to several nodes.\r\n\r\none note to add. both the username and psw attributes are override attributes set in the environment for the node as follows\r\n![image](https:\/\/user-images.githubusercontent.com\/6854643\/124371921-65646380-dc7e-11eb-895b-1187845533cb.png)\r\n\r\n\r\n## Chef Version\r\nStarting Chef Client, version 14.15.6\r\n\r\n## Platform Version\r\nwindows 6.3.9600. and also windows 10.0.14393.\r\n\r\n## Replication Case\r\nusually on first several runs will not set right but will need to manually change the service user to make it pick it up again\r\n\r\n## Client Output\r\n![image](https:\/\/user-images.githubusercontent.com\/6854643\/124371983-e4599c00-dc7e-11eb-8f12-321a9629c7cf.png)\r\n\r\n```\r\n\r\n```\r\n\r\n## Stacktrace\r\n\r\n[chef-stacktrace.txt](https:\/\/github.com\/chef\/chef\/files\/6759322\/chef-stacktrace.txt)\r\n","comments":["I am also having an issue with the run_as_password parameter from the windows_service resource not applying as expected. We have our secrets stored in Vaults. Our security team requires service account passwords be rotated annually.\r\n\r\nThe expected behavior is Chef ensures the service is configured with the defined password. Updating the password in the Vault and then running chef should update the configuration of the service to use the defined password.\r\n\r\nThe actual behavior is Chef does not ensure the password is correct if the service is already configured with the defined run_as_username. Updating the password in the Vault does not cause Chef to reconfigure the service. The service must be set to run as a different username for Chef to update the service configuration.\r\n\r\nPlease update the resource to actually ensure the defined run_as_password is configured."],"labels":["Platform: Windows","Status: Untriaged","Focus: Desktop"]},{"title":"Systemd services can't be enabled or disabled in a chroot environment with Chef 17","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nUsing Chef 17 it's no longer possible to manage Systemd services within a chroot environment (e.g. in RHEL Kickstart post scripts) anymore.\r\n\r\n```\r\nRecipe: chrony_ii::service\r\n  * service[chrony-daemon] action enable\r\n\r\n  ================================================================================\r\n  Error executing action `enable` on resource 'service[chrony-daemon]'\r\n  ================================================================================\r\n\r\n  Chef::Exceptions::Service\r\n  -------------------------\r\n  '\/usr\/bin\/systemctl show' not reporting status for chronyd!\r\n\r\n  Resource Declaration:\r\n  ---------------------\r\n  # In \/var\/chef\/cache\/cookbooks\/chrony_ii\/recipes\/service.rb\r\n\r\n   29: service 'chrony-daemon' do\r\n   30:   service_name value_for_platform_family(\r\n   31:     'rhel' => 'chronyd',\r\n   32:     'amazon' => 'chronyd',\r\n   33:     'debian' => 'chrony'\r\n   34:   )\r\n   35:   supports restart: true, status: true, reload: true\r\n   36:   action %i[enable start]\r\n   37: end\r\n```\r\n\r\nWith Chef 17 the `systemd_service_status` method was introduced which uses `systemctl show` to determine the current state of the service (https:\/\/github.com\/chef\/chef\/blob\/master\/lib\/chef\/provider\/service\/systemd.rb#L83).\r\nHowever unlike the previously used `is-enabled` for example, `systemctl show` refuses to run in a chrooted environment as the Systemd daemon runs outside of that environment.\r\n\r\n```\r\n[anaconda root@kstest ~]# chroot \/mnt \/sysroot\r\n[anaconda root@kstest \/]# systemctl show chronyd\r\nRunning in chroot, ignoring request: show\r\n```\r\n\r\n## Chef Version\r\n17.0 and higher\r\n\r\n## Platform Version\r\nCentOS 8 (and any RHEL derivative using Kickstart)\r\n\r\n## Replication Case\r\nIn a Kickstart configuration provide a `%post --interpreter=\/bin\/bash` section that installs Chef Infra 17, configures it and runs `chef-client` with for example `chrony_ii::default` (https:\/\/supermarket.chef.io\/cookbooks\/chrony_ii) on the run list.\r\n\r\n## Client Output\r\nSee description","comments":["This bug is also present in CentOS 7 during Kickstart post-install:\r\n    ================================================================================\r\n    Error executing action `restart` on resource 'service[sshd]'\r\n    ================================================================================\r\n\r\n    Chef::Exceptions::Service\r\n    -------------------------\r\n    '\/usr\/bin\/systemctl show' not reporting status for sshd!\r\n\r\nChef::Exceptions::MultipleFailures: Chef::Exceptions::MultipleFailures\r\n\/opt\/chef-17.8.25\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.8.25\/lib\/chef\/provider\/service\/systemd.rb:96:in `systemd_service_status'\r\n>>>> Caused by Chef::Exceptions::Service: '\/usr\/bin\/systemctl show' not reporting status for sshd!\r\n\/opt\/chef-17.8.25\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.8.25\/lib\/chef\/provider\/service\/systemd.rb:96:in `systemd_service_status'\r\n\r\n    System Info:\r\n    ------------\r\n    chef_version=17.8.25\r\n    platform=centos\r\n    platform_version=7.9.2009\r\n    ruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x86_64-linux]\r\n    program_name=\/opt\/chef\/bin\/chef-client\r\n    executable=\/opt\/chef-17.8.25\/bin\/chef-client\r\n","Is there any update ? ","Hello,\r\n\r\nI've noticed that bug remains in chef-client 18.2\r\n\r\n\u00c9tienne Mollet\r\n\r\nLe lun. 5 juin 2023 \u00e0 10:11, Sameer Jethvani ***@***.***> a\r\n\u00e9crit :\r\n\r\n> Is there any update ?\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https:\/\/github.com\/chef\/chef\/issues\/11750#issuecomment-1576308418>, or\r\n> unsubscribe\r\n> <https:\/\/github.com\/notifications\/unsubscribe-auth\/AJAQE3L7NM2INBMSOHSAB4LXJWIEXANCNFSM47HOCVCQ>\r\n> .\r\n> You are receiving this because you are subscribed to this thread.Message\r\n> ID: ***@***.***>\r\n>\r\n","We are having this same problem on chef-client 18.2.7.\r\n\r\nOur kickstart script can't run any service resources without failing.."],"labels":["Platform: Linux","Status: Untriaged"]},{"title":"systemd enable service don't work well with templated services","body":"## Description\r\n\r\nAssume you have a service with a template: `app@.service`.\r\nIt doesn't work when you want to enable `app@1.service` and `app@2.service`.\r\n\r\nOnly the `app@1.service` is enabled.\r\nThe `app@2.service` is not enabled while the resource says up to date.\r\n\r\nThis bug was introduced by #10925\r\nThe `UnitFileState` of the unit is `enabled` when one of the templated services is enabled.\r\n\r\nrelated to #11735\r\n\r\n## Chef Version\r\n\r\n17.2.29\r\n\r\n## Platform Version\r\n\r\nCentOS 7\r\n\r\n## Replication Case\r\n\r\n```ruby\r\nsystemd_unit 'app@.service' do\r\n  content <<-EOH\r\n[Unit]\r\nDescription = my app #%i\r\nAfter = network.target\r\n\r\n[Service]\r\nExecStart = sh -c 'echo %i; sleep 3600'\r\n\r\n[Install]\r\nWantedBy = multi-user.target\r\nEOH\r\nend\r\n\r\nservice 'app@1' do\r\n  action :enable\r\nend\r\n\r\nservice 'app@2' do\r\n  action :enable\r\nend\r\n```\r\n\r\n## Client Output\r\n\r\n```\r\n* systemd_unit[app@.service] action create\r\n* service[app@1] action enable\r\n* service[app@2] action enable (up to date)\r\n```\r\n","comments":[],"labels":["Platform: Linux","Status: Untriaged"]},{"title":"systemd_unit with mask action don't become converged state.","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\n```ruby\r\nsystemd_unit 'my-app.service' do\r\n  action :mask\r\nend\r\n```\r\nnever become up to date state even if the unit is already masked.\r\n\r\nThis bug was introduced by #10925\r\n\r\nThe `UnitFileState` of masked unit is `bad` not `masked`.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nChef 17.2.29\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nCentOS 7\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\n```ruby\r\nsystemd_unit 'tuned.service' do\r\n  action :mask\r\nend\r\n```\r\n\r\nRun these codes twice. You cannot see up to date state in second run.\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```bash\r\n$ systemctl status tuned.service\r\n\u25cf tuned.service - Dynamic System Tuning Daemon\r\n   Loaded: loaded (\/usr\/lib\/systemd\/system\/tuned.service; enabled; vendor preset: enabled)\r\n   Active: active (running) since Tue 2021-06-22 04:52:15 JST; 9h ago\r\n     Docs: man:tuned(8)\r\n           man:tuned.conf(5)\r\n           man:tuned-adm(8)\r\n Main PID: 963 (tuned)\r\n   CGroup: \/system.slice\/tuned.service\r\n           \u2514\u2500963 \/usr\/bin\/python2 -Es \/usr\/sbin\/tuned -l -P\r\n\r\n$ sudo chef-apply recipe.rb\r\nRecipe: (chef-apply cookbook)::(chef-apply recipe)\r\n  * systemd_unit[tuned.service] action mask\r\n    - masking unit: tuned.service\r\n\r\n$ systemctl status tuned.service\r\n\u25cf tuned.service\r\n   Loaded: masked (\/dev\/null; bad)\r\n   Active: active (running) since Tue 2021-06-22 04:52:15 JST; 9h ago\r\n Main PID: 963 (tuned)\r\n   CGroup: \/system.slice\/tuned.service\r\n           \u2514\u2500963 \/usr\/bin\/python2 -Es \/usr\/sbin\/tuned -l -P\r\n\r\n$ sudo chef-apply recipe.rb\r\nRecipe: (chef-apply cookbook)::(chef-apply recipe)\r\n  * systemd_unit[tuned.service] action mask\r\n    - masking unit: tuned.service\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":["Hi,\r\nWhen we are trying to upgrade chef on our system from 16.18.0 to 17.x (tried both v17.0.242 & v17.10.3) meeting same issue, Even though systemd service is masked, chef's idempotency is not identifying it, and hence masking is executed on every run however unmasking is not at all getting called and its always up to date.\r\n\r\n    System Info:\r\n    ------------\r\n    chef_version=17.10.3\r\n    platform=centos\r\n    platform_version=7.9.2009\r\n    ruby=ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x86_64-linux]\r\n    program_name=\/usr\/bin\/chef-client\r\n    executable=\/opt\/chef\/bin\/chef-client\r\n    \r\n![image](https:\/\/user-images.githubusercontent.com\/13515573\/174584523-54a28d7a-2468-469e-ae0c-a5f41dd52155.png)\r\n@neha-p6 any expected date for this fix to be released. Any help appreciated."],"labels":["Type: Bug","Platform: Linux","Status: Untriaged","Type: Escalation"]},{"title":"The way that unified_mode immediate notifications work should be a first-class citizen","body":"I should have invented a new notification for unified_mode rather than hacking up :immediately to do what I wanted and then just mapped :immediately onto that when running in unified_mode.\r\n\r\nIt can be used in non-unified_mode in recipe context to delay a notification until the resource is declared, which is very useful compared to our all-or-nothing do-it-right-now or do-it-way-at-the-end.\r\n\r\nSo if you decouple user creation from later recipes that consume events that the users were created or not, you want to loop over a huge pile of user resources. then only fire off one ohai reload, then later you've got some recipe where you want to be able to say \"if user alice was added sometime in this run, then i want to update and run now\".  You don't want to fire immediately off the user resources, because you don't want 100 ohai reloads firing.  You also probably don't want to promote the later recipe to running immediately as soon as the user resource to add alice fires.\r\n\r\nYou want to manage all the users first.  If any of them were update you want to reload ohai once.  Then when you get to the recipe that matters you want to fire resources there only if alice was added this run.\r\n\r\n```\r\nlist_of_all_my_users.each do |username|\r\n  user username do\r\n    notifies :reload, \"ohai[reload]\", :parsetime\r\n  end\r\nend\r\n\r\nohai \"reload\" do\r\n  action :nothing\r\nend\r\n\r\n[... much later ...]\r\n\r\nexecute \"do something if alice was created\" do\r\n  subscribes :run, \"user[alice]\", :parsetime\r\nend\r\n```\r\n\r\nThis is basically what I built with unified_mode and putting that code into a unified_mode sub-resource nearly works, except the notifications to the ohai resource aren't properly de-duped (which I'd argue is a bug and they should be).\r\n\r\nThis would also clarify some of the magic in the unified_mode behavior by giving it a name.  It may need a better name than `:parsetime`.\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Identify and remediate unfiltered node attributes sent to external systems","body":"In doing the work for #10895 , I took a quick look through and found other situations that we allow unfiltered node attributes to exit the system.   \r\n\r\nOne such example is `handlers\/json_file.rb` which uses  RunStatus.to_h`.  `RunStatus` includes the node object which will not filter when `to_h` is invoked.\r\n\r\nLet's spend some cycles  going through the code base and finding  other places that don't respect attribute block\/allowlist rules. ","comments":[],"labels":["Aspect: Security","Status: Untriaged"]},{"title":"RemoteFile::SFTP Custom Port Implementation Broken","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nRemoteFile::SFTP breaks when using custom ports\r\nhttps:\/\/github.com\/chef\/chef\/blob\/9f6f9a9681611ce71fd6e541c88e228a0e095abc\/lib\/chef\/provider\/remote_file\/sftp.rb#L62-L65\r\n\r\nNet::SFTP does not support parsing the port from the host string. It needs passed in as a separate arg\r\nhttps:\/\/github.com\/net-ssh\/net-sftp#label-SYNOPSIS-3A\r\n\r\nNormally this wouldn't be an issue if you're just using port 22 but if you've got Just-In Time (port closed until requested open) enabled on a Linux SFTP server to protect SSH it makes sense to host SFTP on a separate port so SFTP is always available.\r\n\r\nThe following changes fix my issue (although full disclosure haven't tested the normal test case without specifying the port in the URI). Port method changed because in this scenario we need a fallback when port isn't specified in the URI. Same code can be used used to monkey patch with a chef library. Side note, I couldn't figure out how to use Refinements with Chef in case someone reading this knows, I'd be interested.\r\n\r\n```ruby\r\nclass Chef\r\n  class Provider\r\n    class RemoteFile\r\n      class SFTP\r\n        def port\r\n          @uri.port || 22\r\n        end\r\n\r\n        def sftp\r\n          @sftp ||= Net::SFTP.start(hostname, user, { password: pass, port: port })\r\n        end\r\n      end\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n## Chef Version\r\nLatest\r\n\r\n## Platform Version\r\nWindows\r\n\r\n## Replication Case\r\nCreate SFTP URI with custom port [per the official docs](https:\/\/docs.chef.io\/resources\/remote_file\/)\r\n```ruby\r\nremote_file some_path do\r\n  source 'sftp:\/\/user:pass@server:2222\/some\/path'\r\nend\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\nChef-client produces the following error but I had to use pry to try replicating what was producing it. Port is not included with the hostname when default port is used which is the only reason code works.\r\n\r\n```\r\n# What I suspect the code is doing\r\npry(main)> Addrinfo.getaddrinfo(\"server:2222\", 22)\r\nSocketError: getaddrinfo: No such host is known\r\n```","comments":["Suggested labels: Low Priority, Good First Issue"],"labels":["Status: Untriaged","Focus: Desktop"]},{"title":"Can't inspect installed choco packages without an ohai plugin","body":"### Describe the Enhancement:\r\n<!---  What you are trying to achieve that you can't? -->\r\nI would like to be able to see the state of packages currently installed a Windows system by chocolatey without having to rely on anything external, like an ohai plugin.\r\n\r\n### Describe the Need:\r\n<!---  What kind of user do you believe would utilize this enhancement, and how many users might want this functionality -->\r\nI have some cross-platform library code that inspects the current state of installed packages that I am extending to work on Windows.  On a platform that uses `yum` or `dnf`, I can use their `python_helper` library to inspect the current list of installed packages.  As the code is today, the chocolatey provider lacks anything similar: it has an `installed_packages` method, but it is private and, as an instance method, isn't suitable for use in outside libraries even if just flipped to public.\r\n\r\n### Current Alternative\r\n<!--- Is there a current alternative that you can utilize to workaround the lack of this enhancement -->\r\nWhen the chocolatey ohai plugin is installed, this information is available in `node['chocolatey']`, but this has two drawbacks:\r\n\r\n1. Requires the chocolatey ohai plugin to be available and installed (which it might not be), whereas the chocolatey package provider is always available\r\n2. The state of packages may have changed since ohai gathered data, which would force me to write a block to reload ohai\r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\nI have a change that converts the chocolatey package provider's `installed_packages` method from a private instance method to a public class method, and as the PR template requests, I'm filing this issue in preparation for a PR.","comments":["This needs to not be done as a chocolatey one-off.  We need a consistent API for accessing installed and candidate versions of packages across all the different package providers.  The helpers need to go into chef-utils and they need to work across all the major package providers (apt\/yum\/zypper\/rpm\/deb\/homebrew\/gem\/chocolatey)","This data also needs to get exposed in Ohai so that we can send it to reporting. It's not something we currently collect and that's a gap.","And people need to stop poking at the python_helper libraries, those shouldn't even be a public API really and their use needs to go away and be replaced.  The whole python helper should be an implementation detail.\r\n\r\nThe new API should be something like `def installed_package(package_name, resource_name = :package)` to get the current package along with `candidate_package` and probably `def installed_package?(package_name, constraint, resource_name = :package)` and similarly `candidate_package?` for asking if the installed or candidate satisfies a constraint.  But that's just off the top of my head.\r\n\r\nAnd yeah, we should update ohai as well, but that's the wrong API to use due to the need to reload the plugin after every package update to get accurate info."],"labels":["Platform: Windows","Focus: Desktop"]},{"title":"DSL method for generating explicit lookup path","body":"### Describe the Enhancement:\r\nSometimes I want to specify an explicit lookup path for a resource when I don't want to use the default file specificity, which includes platform and platform_version. For instance, I might want to use a file that is looked up by environment.\r\n<!---  What you are trying to achieve that you can't? -->\r\n\r\n### Describe the Need:\r\nThis is intermediate to advanced Chef usage that would be useful to those who want to lay out files and templates by something other than platform.\r\n<!---  What kind of user do you believe would utilize this enhancement, and how many users might want this functionality -->\r\n\r\n### Current Alternative\r\n<!--- Is there a current alternative that you can utilize to workaround the lack of this enhancement -->\r\nI can either list an explicit lookup path for each resource I want to use or write a simple library method to do the same thing. \r\n\r\nWithout this, I might write\r\n```\r\ncookbook_file 'whatever.txt' do\r\n  source ['\/path1\/path2\/whatever.txt', '\/path1\/whatever.txt', '\/default\/whatever.txt', '\/whatever.txt']\r\nend\r\n```\r\n\r\nI often implement a method that lets me write:\r\n```\r\ncookbook_file 'whatever.txt' do\r\n  source lookup_path('whatever', 'path1' ,path2')\r\nend\r\n```\r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\nThe biggest help I need is some advice for where to put this! chef-utils doesn't seem quite the right place, but I couldn't find any other natural fit for it.\r\n\r\nWhat I'd really like is a mechanism to override https:\/\/github.com\/chef\/chef\/blob\/e86942d64dee5c8f3a08453a23d93ca702b0792c\/lib\/chef\/cookbook_version.rb#L388-L436 with a list of preferences for the whole of the convergence, so that I can just use `source 'whatever.txt'` and get the lookup path I want.\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Store Infra Client client.pem contents in the Windows Certificate Store","body":"As an operator, I want to store the client.pem contents in a secure location\r\nso that it cannot be discovered by others.\r\n\r\nAs a security team I want the ensure that no certificates are stored on disk,\r\nso that systems are compliant with audits\r\n\r\n## Acceptance Criteria\r\n\r\n-[ ] A new config option 'migrate_key_to_keystore' to migrate keys to system certificate stores if they are found on disk\r\n-[ ] The option would default to false today and be set to true some time in the future\r\n-[ ] The option could be set via CLI flag as well in chef-client\r\n-[ ] Knife bootstrap with a --store-key-in-keystore set the migrate_key_to_keystore flag in the client.rb so that the first run moves the key\r\n\r\n## Other Notes\r\n\r\nThis implements the Windows side of the Aha Idea https:\/\/chef.aha.io\/ideas\/ideas\/CHEF-I-30","comments":["Waiting on a code review","Here are the work items I see that we need to perform\r\n1) Update the chef-config gem to reflect the new option to migrate from disk\r\n2) Update the registration code to intercept calls to Registration (first time run) and substitute a call into the cert store to retrieve the key if it's there. \r\n3) Add an additional option to the registration code to import the key into the certstore if the flag is set. This might need a review, I don't know that trapping the call to Registration and using that to install a cert is the correct spot for that. \r\n4) Update the HTTP\/Authenticator code to retrieve the cert from the store under normal circumstances. This work has been done already, but need to verify impact of the new code being added via step 3 and ensure consistency of calling conventions and naming objects. \r\n5) Import the \"knife ssl fetch\" code to the client.rb to return the SSL cert. This is needed to wrap the client.pem with to create a valid p12\/pfx object with.\r\n6) Extensive testing and updates to Unit, and Functional testing as this has the probability to adversely affect performance and general usage"],"labels":["Epic"]},{"title":"zypper_package generates incorrect command when using \"source\"","body":"## Description\r\nI use zypper_package for installing a local package on SLES 12 SP5. It generates incorrect command that doesn't work. Correct manual command works and installs the package.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\n\r\n## Replication Case\r\n```\r\nzypper_package(\"splunk\") do\r\n        package_name \"splunk\"\r\n        action [:install]\r\n        default_guard_interpreter :default\r\n        declared_type :package\r\n        cookbook_name \"chef-splunk\"\r\n        source \"\/tmp\/chef-zero009157613\/local-mode-cache\/cache\/splunk-8.0.1-6db836e2fb9e-linux-2.6-x86_64.rpm\"\r\n        version \"8.0.1\"\r\nend\r\n```\r\n\r\n## Client Output\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n[2021-05-28T09:36:37+00:00] FATAL: Mixlib::ShellOut::ShellCommandFailed: splunk_installer[splunk] (chef-splunk::install_server line 22) had an error: Mixlib::ShellOut::ShellCommandFailed: zypper_package[splunk] (\/tmp\/chef-zero009157613\/local-mode-cache\/cache\/cookbooks\/chef-splunk\/resources\/splunk_installer.rb line 65) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '104'\r\n---- Begin output of [\"zypper\", \"--non-interactive\", \"install\", \"--auto-agree-with-licenses\", \"splunk=8.0.1\"] ----\r\nSTDOUT: Loading repository data...\r\nReading installed packages...\r\n'splunk=8.0.1' not found in package names. Trying capabilities.\r\nSTDERR: No provider of 'splunk=8.0.1' found.\r\n---- End output of [\"zypper\", \"--non-interactive\", \"install\", \"--auto-agree-with-licenses\", \"splunk=8.0.1\"] ----\r\nRan [\"zypper\", \"--non-interactive\", \"install\", \"--auto-agree-with-licenses\", \"splunk=8.0.1\"] returned 104\r\nexit status 1\r\n\r\n```\r\n\r\nRemoving \"version\" causes other error:\r\n```\r\nzypper_package[splunk] (\/tmp\/chef-zero238880284\/local-mode-cache\/cache\/cookbooks\/chef-splunk\/resources\/splunk_installer.rb line 65) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '3'\r\n    ---- Begin output of [\"zypper\", \"--non-interactive\", \"install\", \"--auto-agree-with-licenses\"] ----\r\n    STDOUT: install (in) [options] &lt;capability|rpm_file_uri&gt; ...\r\n    \r\n    Install packages with specified capabilities or RPM files with specified\r\n    location. A capability is NAME[.ARCH][OP&lt;VERSION&gt;], where OP is one\r\n    of &lt;, &lt;=, =, &gt;=, &gt;.\r\n```\r\nBut still, as far as I can see, the problem is the same: package path is not passed to zypper.\r\n\r\n## Stacktrace\r\nWill be added if necessary.\r\n","comments":[],"labels":["Status: Untriaged"]},{"title":"Additional Windows SID ","body":"### Describe the Enhancement:\r\nAdd 'NT SERVICE\\WdiHostService'  with SID  '*S-1-5-80-3139157870-2983391045-3678747466-658725712-1809340420' to the well known sid list chef\/lib\/chef\/win32\/security\/sid.rb\r\n\r\n### Describe the Need:\r\nCIS standards include a control to manage the Windows User Rights Assignment (Profile System Performance (SeSystemProfilePrivilege)) that requests the standard to be set to Administrators and NT SERVICE\/WdiHostService. While this behavior is the Windows default, it is not possible to use the `windows_user_privilege` resource and pass this account into it.  So if the desire is to use Chef and this resource to manage this URA in a continual state, it is not possible at this time.\r\n\r\nCurrently the attempt to use this results in a Windows error:\r\n```\r\n            50: windows_user_privilege \"Ensure 'Profile system performance' is set to '#{desc_value}'\" do\r\n            51:   privilege 'SeSystemProfilePrivilege'\r\n            52:   users ['Administrators', 'NT SERVICE\\WdiHostService']\r\n            53:   action :set\r\n            54: end\r\n```\r\n```\r\n       ---- Begin Win32 API output ----\r\n       System Error Code: 1332\r\n       System Error Message: No mapping between account names and security IDs was done.\r\n       ---- End Win32 API output ----\r\n       \r\n       C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.1.35-universal-mingw32\/lib\/chef\/win32\/error.rb:81:in `raise!'\r\n       C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.1.35-universal-mingw32\/lib\/chef\/win32\/security.rb:447:in `lookup_account_name'\r\n       C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.1.35-universal-mingw32\/lib\/chef\/resource\/windows_user_privilege.rb:167:in `block (2 levels) in <class:WindowsUserPrivilege>'\r\n       C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.1.35-universal-mingw32\/lib\/chef\/resource\/windows_user_privilege.rb:166:in `each'\r\n       C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/3.0.0\/gems\/chef-17.1.35-universal-mingw32\/lib\/chef\/resource\/windows_user_privilege.rb:166:in `block in <class:WindowsUserPrivilege>'\r\n       (eval):2:in `block in action_set'\r\n```\r\n\r\n\r\n### Current Alternative\r\nCurrent alternatives would be to continue to use the current LWRP we are using to manage User Rights Assignments configurations for this particular privilege.\r\n\r\n### Can We Help You Implement This?:\r\nI would be open to attempting to submit the fix for this, however I am unsure if it is as simple as adding the account\/SID to the chef\/lib\/chef\/win32\/security\/sid.rb as well as this account being a sub-account of NT SERVICE, I wasn't sure how it could be translated with the spaces and slashes in this case.\r\n","comments":[],"labels":["Platform: Windows","Focus: Desktop"]},{"title":"Make sure Chef is ready for Bundler 3.0","body":"Bundler 3.x changes some of the helpers and commands used by Bundler. We need to make sure our overall usage of bundler works with 3.x so we can continue to ship chef on the latest ruby\/bundler releases. Here's a post with a nice breakdown of changes. https:\/\/bundler.io\/v2.1\/whats_new.html","comments":[],"labels":["Type: Chore"]},{"title":"windows_package - (notifies\/subscribes) Updating from 15.15.1 (works) -> 16.13.16 (fails) - Resource is not download source url .msi prior to trying installation","body":"This works 100% in 15.15.1 (plus historic 14, 13)\r\nNow working through code, validating 16.13.16 in TK. Getting error. \r\n\r\n```\r\n         * windows_package[VCI-StatsdCollector] action install\r\n           * remote_file[C:\\Users\\vagrant\\AppData\\Local\\Temp\\kitchen\\cache\\package\\VCI-StatsdCollector-1.2.5.msi] action create\r\n             - Would create new file C:\\Users\\vagrant\\AppData\\Local\\Temp\\kitchen\\cache\\package\\VCI-StatsdCollector-1.2.5.msi\r\n             - Would change dacl\r\n             - Would change owner\r\n             - Would change group\r\n\r\n           ================================================================================\r\n           Error executing action `install` on resource 'windows_package[VCI-StatsdCollector]'\r\n           ================================================================================\r\n\r\n           Errno::ENOENT\r\n           -------------\r\n           No such file or directory @ rb_sysopen - C:\\Users\\vagrant\\AppData\\Local\\Temp\\kitchen\\cache\\package\\VCI-StatsdCollector-1.2.5.msi\r\n\r\n           Resource Declaration:\r\n           ---------------------\r\n           # In C:\/Users\/vagrant\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/vci_statsd_collector\/recipes\/packages.rb\r\n\r\n            19: windows_package 'VCI-StatsdCollector' do\r\n            20:   action :install\r\n            21:   extend VciHelperCookbook::VciChefMedia\r\n            22:   source \"http:\/\/#{vci_chef_media_www}\/VCI-StatsdCollector\/VCI-StatsdCollector-#{node['vci_statsd_collector']['version']}.msi\"\r\n            23:   version node['vci_statsd_collector']['version']\r\n            24:   checksum node['vci_statsd_collector']['checksum']\r\n            25:   notifies :stop, 'service[VCI-StatsdCollector]', :before\r\n            26: end\r\n\r\n           Compiled Resource:\r\n           ------------------\r\n           # Declared in C:\/Users\/vagrant\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/vci_statsd_collector\/recipes\/packages.rb:19:in `from_file'\r\n\r\n           windows_package(\"VCI-StatsdCollector\") do\r\n             package_name \"VCI-StatsdCollector\"\r\n             action [:install]\r\n             default_guard_interpreter :default\r\n             declared_type :windows_package\r\n             cookbook_name \"vci_statsd_collector\"\r\n             recipe_name \"packages\"\r\n             source \"http:\/\/www.media.service.yvr1.consul\/VCI-StatsdCollector\/VCI-StatsdCollector-1.2.5.msi\"\r\n             version \"1.2.5\"\r\n             checksum \"0d1eb13f22429c223ded08c3076f4c868313bb26317c52354e3e715475ab0fd4\"\r\n           end\r\n\r\n           System Info:\r\n           ------------\r\n           chef_version=16.13.16\r\n           platform=windows\r\n           platform_version=6.3.9600\r\n           ruby=ruby 2.7.3p183 (2021-04-05 revision 6847ee089d) [x64-mingw32]\r\n           program_name=C:\/opscode\/chef\/bin\/chef-client\r\n           executable=C:\/opscode\/chef\/bin\/chef-client\r\n\r\n\r\n       Running handlers:\r\n       [2021-05-06T21:24:32+00:00] ERROR: Running exception handlers\r\n       Running handlers complete\r\n       [2021-05-06T21:24:32+00:00] ERROR: Exception handlers complete\r\n       Chef Infra Client failed. 1 resources updated in 09 seconds\r\n       [2021-05-06T21:24:33+00:00] FATAL: Stacktrace dumped to C:\/Users\/vagrant\/AppData\/Local\/Temp\/kitchen\/cache\/chef-stacktrace.out\r\n       [2021-05-06T21:24:33+00:00] FATAL: Please provide the contents of the stacktrace.out file if you file a bug report\r\n       [2021-05-06T21:24:33+00:00] FATAL: Errno::ENOENT: windows_package[VCI-StatsdCollector] (vci_statsd_collector::packages line 19) had an error: Errno::ENOENT: No such file or directory @ rb_sysopen - C:\\Users\\vagrant\\AppData\\Local\\Temp\\kitchen\\cache\\package\\VCI-StatsdCollector-1.2.5.msi\r\n```","comments":["I'm doing the process of elimination. It appears I may have a legacy community cookbook that is breaking this. I'll update this issue and close if needed.","Looks like it is the adding of \r\n```notifies :stop, 'service[VCI-StatsdCollector]', :before```\r\nthat is messing up this resource in chef 16.13.16+\r\nremoving it , the resource works fine\r\nadding \r\n```subscribes :stop, 'windows_package[VCI-StatsdCollector]', :before``` \r\nto `service[VCI-StatsdCollector]` has the same result.\r\n","@lamont-granquist I believe I've narrowed this down to our use of `notifies`\r\nRemoving the `notifies` makes the issue stop.\r\nAs I mentioned above, another resource subscribing to windows_package with (:before) also causes chef 16 windows_package to fail to download remote urls prior to installation \r\n","@knightorc could you please confirm if this is seen on chef-client or chef-workstation? based on the logs, it appears to be chef-client but we would like to double check. also, a little more detail in the repro steps will help us diagnose and fix the issue.","@vkarve-chef This is via chef-client in Test Kitchen. ","So what you're saying is that there's a bug in windows_package with `:before` notifications and that windows_package is not why-run safe and throws?\r\n\r\nAh yeah its failing in \"Would change ...\" stuff so that resource is running in why-run mode.\r\n\r\nThe stacktrace.out would still be useful"],"labels":["Type: Regression","Platform: Windows","Status: Untriaged","Focus: Desktop"]},{"title":"Add template support to `systemd_unit`","body":"Creating from #11402\r\n\r\n### Describe the Enhancement:\r\nI would like to be able to specify a template (and required configurations) when defining a systemd unit file with `systemd_unit`.\r\n\r\n### Describe the Need:\r\nWhen dealing with complex systemd unit files within a custom resource, it would be useful to be able to expose the ability to override the contents via a template file rather than a string or hash.\r\n\r\nIn the instance of sous-chefs\/tomcat since we are providing a unit file with sensible defaults and expose the ability to override that template to the user, we cannot currently utilize the `systemd_unit` resource and instead fall back to managing the unit file directly with `template` and interacting with systemd with `execute`\r\n\r\nhttps:\/\/github.com\/sous-chefs\/tomcat\/pull\/358#discussion_r492897903\r\n\r\n### Current Alternative\r\nAs demonstrated in the above cookbook, we are managing the unit file directly with `template` rather than utilizing the `systemd_unit` resource.\r\n\r\n### Can We Help You Implement This?:\r\nThis is a reasonable request or does it add too much complexity to the resource?\r\n\r\nIn terms of implementation, I was thinking something like the following.\r\n\r\nAddition of properties such as these added to `systemd_unit`:\r\n\r\n```ruby\r\nproperty :template_source, String,\r\n  description: \"The location of a template file. By default, #{ChefUtils::Dist::Infra::CLIENT} looks for a template file in the \/templates directory of a cookbook.\"\r\n\r\nproperty :template_cookbook, [String, Hash],\r\n  description: \"The cookbook in which a file is located (if it is not located in the current cookbook). The default value is the current cookbook.\",\r\n  desired_state: false\r\n\r\nproperty :template_variables, [String, Hash],\r\n  description:  \"The variables property of the template resource can be used to reference a partial template file by using a Hash.\",\r\n  default: {}\r\n\r\nproperty :template_local, [ TrueClass, FalseClass ],\r\n  default: false, desired_state: false,\r\n  description: \"Load a template from a local path. By default, the #{ChefUtils::Dist::Infra::CLIENT} loads templates from a cookbook's \/templates directory. When this property is set to true, use the source property to specify the path to a template on the local node.\"\r\n```\r\n\r\nFrom there I believe there just needs to be logic within `manage_unit_file` to detect `content` usage vs `template_source` and then use the `template` resource from there.\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/master\/lib\/chef\/provider\/systemd_unit.rb#L259","comments":["The middle two (template_cookbook and template_variables) are exactly what I want to see.  The template_source and template_local seem like they're trying to solve a much broader issue outside the scope of fixing systemd_unit to use templates and one that affects all template resources and for one thing just don't come up often at all, and probably demands a more centralized fix that isn't specific to the systemd_unit problem.","`template_source` would probably be more accurately called `template_name` since we need to know what the filename we're looking for in the cookbook.\r\n\r\nI'd still like to be able to source the template file from outside of a cookbook, so would either need `template_local` or maybe just the ability to support `file:\/\/` or similar on `template_name` ?","On the topic of a more centralized fix, that's why I was initially leaning towards a template helper in #11402 that simply generates the content since that would more readily expose this type of functionality in other scenarios without having to explicitly build it into each resource.","What would need to happen there is a proposal to fix the whole file provider interface, since file, cookbook_file, template and remote_file are four resources for managing files that are scattered around the UI with no consistency.  It should be possible to feed cookbook_files or template into the file provider as a source and to render them.  It would also be useful to do things like pull down URLs that were erb templates and render them with variables into files locally.  Picking arbitrary files out of arbitrary segments of a cookbook to deploy as a template or cookbook_file should also be made possible.  There was an issue in the old ticket system about this and the work in 11.6.0 to clean up the file providers was supposed to be work towards that ultimate goal.\r\n\r\nBut that's building a chunk of a nuclear reactor and it has nothing to do with systemd_unit tests and that isn't a problem you need to solve here with something that slapped on this PR that can't be widely re-used and then produces a public API which doesn't really solve the core issue and needs to be maintained going forwards and blocks the ultimate construction of the right API."],"labels":["Platform: Linux","Triage: Feature Request","Focus: Resources"]},{"title":"Chef-Client installer on Windows should NOT have version name as part of name","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nChef-Client installation on windows can not be validated following chef's own idempotence principles. The package name contains the version name, this breaks testing \r\n\r\n## Chef Version\r\nChef-client v14 and onwards\r\n\r\n## Platform Version\r\nWindows 2016, 2019\r\n\r\n## Replication Case\r\nInstall chef-client on windows\r\nOpen add\/remove programs\r\nLook at chef-client package name\r\n\r\n## Client Output\r\nThe following test will always fail:\r\n\r\n```\r\n  describe package('Chef Client') do\r\n    it { should be_installed }\r\n    its('version') {should eq '12.21.31-1-x64'}\r\n  end\r\n```\r\n\r\n\r\nHave to explicitly specify version, which will fail as soon as chef is updated.\r\n```\r\n  describe package('Chef Client v14.14.25') do\r\n    it { should be_installed }\r\n    its('version') {should eq '12.21.31-1-x64'}\r\n  end\r\n```\r\n\r\n## Stacktrace\r\n    [PASS]  System Package Chef Client v14.14.25 is expected to be installed\r\n     [FAIL]  System Package Chef Client v14.14.25 version is expected to eq \"12.21.31-1-x64\"\r\n\r\n     expected: \"12.21.31-1-x64\"\r\n          got: \"14.14.25.1\"","comments":["@vinyar, Here we are little confused with the actual expectations with those specs running. If we have installed the chef-client and we know the version so we can write the exact test case including the version test as mentioned here:\r\n\r\n```\r\ndescribe package('Chef Client v14.14.25') do\r\n    it { should be_installed }\r\n    its('version') {should eq '14.14.25-x64'}\r\n  end    \r\n```\r\n\r\nBut later on, if we remove the version name from package and the package is upgraded so the test case with static version specified will always fail.\r\n\r\nMy question here is why we are hardcoding the version of the package in the test case? This will need to change every time we are upgrading the package.","@ashwin-msys  - the expectation is that version of the package is not part of the name. \r\n\r\nExpectation: Chef-client application should be called `'chef client` in add-remove program, windows registry, and so on.\r\n\r\nDiscussion:\r\nOpen `add\/remove programs` on windows, and look at every application you have installed. \r\nWhat you will notice is that none of the applications have version name as part of the name.\r\n\r\nEach application has a property. So, as I pointed out above, your test case is not name dependent, it's property dependent.\r\nThis is the exact behavior that should be implemented. \r\n\r\n```\r\n  describe package('Chef Client') do\r\n    it { should be_installed }\r\n    its('version') {should eq '12.21.31-1-x64'}\r\n  end\r\n```\r\n\r\nConsider this - I want to know if chef-client is installed, and I don't care what version. How are you going to go about it?\r\n\r\nThe expected test is:\r\n```\r\n  describe package('Chef Client') do\r\n    it { should be_installed }\r\n  end\r\n```\r\n","Bump"],"labels":["Aspect: Packaging","Platform: Windows"]},{"title":"Chef openssl_x509_certificate do not check existing certificate properties to update it","body":"## Description\r\nI recently attempted to switch to the relatively new `openssl_x509_certificate` resource from an old, custom resource I made to manage self-signed certificates in a testing environment.\r\n\r\nHowever, in its current state it seems hardly usable: the generated certificate is never updated when I change properties (for instance adding an alternative subject or updating the CA certificate).\r\nI maybe missed something, but after looking briefly to the resource sources in the Chef repository, it seems that the current behavior is to never generate a certificate if one already exists, *except* in the case of a renewal due to short expiring current certificate.\r\n\r\nMy use case is maybe quite unusual, but I would expect the certificate to be re-generated if *any* of its internal properties change between two runs of Chef client (from `country` to `subject_alt_name` or the signing CA).\r\nIs the current behavior the expected one?\r\n\r\n## Chef Version\r\nChef 16.10.17\r\n\r\n## Replication Case\r\n1. Create a minimal `openssl_x509_certificate` with just a single `subject_alt_name` item\r\n2. Run Chef on a machine\r\n3. Add another item in `subject_alt_name`\r\n4. Run Chef again and check the certificate\r\n","comments":[],"labels":["Type: Bug","Priority: Low","Focus: Resources"]},{"title":"package provider action `:upgrade` should work with Ubuntu","body":"### Describe the Enhancement:\r\n<!---  What you are trying to achieve that you can't? -->\r\nWhen I declare a `package` resource in my recipe, it is smart enough to determine that my chef node is an Ubuntu server. It then proceeds to use the `apt_package` resource to do an upgrade; however, the `upgrade` action is not supported by `apt_package`. Instead of intelligently changing the provider to `dpkg_package`, chef client fails and throws an error. Ironically, the error informs me that I should use the `dpkg_package` resource to perform an `upgrade` action.\r\n\r\nThe installer is downloaded via `remote_file` before I get to the package resource, declared below. My cookbook is used on ubuntu, rhel, oel, and amazon linux chef clients. So, I don't want to specify different `*_package` providers, like `yum_package` on rhel and `dpkg_package` on ubuntu with some guards. Seems rather clunky code. Instead, the package resource should be able to meet my needs, except it fails on ubuntu.\r\n\r\n```\r\npackage 'falcon-sensor' do\r\n  action :upgrade\r\n  source falcon_sensor_pkg['local_file']\r\nend\r\n```\r\n\r\n### Describe the Need:\r\n<!---  What kind of user do you believe would utilize this enhancement, and how many users might want this functionality -->\r\nIt seems odd to me that the chef client doesn't just do this automatically for me -- use `apt_package` for most cases, but if `action :upgrade` is provided to the `package` resource, then it should automatically use the `dpkg_package` resource under the covers.\r\n\r\nThe chef run fails with this error:\r\n```\r\n           * apt package provider cannot handle source property. Use dpkg provider instead\r\n           ================================================================================\r\n           Error executing action `upgrade` on resource 'apt_package[falcon-sensor]'\r\n           ================================================================================\r\n           \r\n           Chef::Exceptions::Package\r\n           -------------------------\r\n           apt package provider cannot handle source property. Use dpkg provider instead\r\n           \r\n           Resource Declaration:\r\n           ---------------------\r\n           # In \/tmp\/kitchen\/cache\/cookbooks\/linux_base\/recipes\/falcon_sensor.rb\r\n           \r\n            44: package 'falcon-sensor' do\r\n            45:   action :upgrade\r\n            46:   source falcon_sensor_pkg['local_file']\r\n            47: end\r\n            48: \r\n\r\n```\r\nThe first line indicates to me that chef thinks I should use the dpkg provider instead to perform an upgrade.\r\n\r\n### Current Alternative\r\n<!--- Is there a current alternative that you can utilize to workaround the lack of this enhancement -->\r\nI have to add a workaround to my package resource to explicitly give it the proper provider to perform an upgrade.\r\n\r\n```\r\npackage 'falcon-sensor' do\r\n  action :upgrade\r\n  source falcon_sensor_pkg['local_file']\r\n  provider Chef::Provider::Package::Dpkg if platform?('ubuntu')\r\nend\r\n```\r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\n","comments":["So this should not be implemented as the apt_package resource calling dpkg or dpkg_package to do the install (we would need code in the apt package provider itself similar to yum's `resolve_source_to_version_obj` that calls dpkg to get the package version number).\r\n\r\nThis should be done through using the `use_package_name_for_source` subclass directive, and implemented using `apt -sourcepath` so that dependency resolution happens for the deb.  This is similar to how yum+rpm package providers work.\r\n\r\nTL;DR:  make it work like yum_package does."],"labels":["Type: Enhancement","Priority: Low","Platform: Debian-like","Focus: Resources"]},{"title":"ERROR: Chef::Exceptions::ValidationFailed: Property chef_environment's value 2021.02.16 does not match regular expression \/^[\\-[:alnum:]_]+$\/","body":"## Description\r\nknife node show <node_name> not working as expected and fails with error \r\nERROR: Chef::Exceptions::ValidationFailed: Property chef_environment's value 2021.02.16 does not match regular expression \/^[\\-[:alnum:]_]+$\/\r\n\r\n## Chef Version\r\n20.12.205\r\n\r\n## Platform Version\r\nMacOS\r\n\r\n## Replication Case\r\nI have set chef policy for a node - knife node policy set node_name '2021.02.16' 'policy_name'. When I did knife node show throwing me above mentioned error.\r\n\r\n","comments":["I got the hack and it worked. It was unable to identify the policy_group if It has dot(.) in policy_group. regex: \/^[\\-[:alnum:]_ .]+$\/\r\n\r\n### Updated this file sudo vi \/opt\/chef-workstation\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.8.14\/lib\/chef\/node.rb\r\n     \r\ndef chef_environment(arg = nil)\r\n      set_or_return(\r\n        :chef_environment,\r\n        arg,\r\n        { regex: \/^[\\-[:alnum:]_.]+$\/, kind_of: String }\r\n      )\r\n    end","Is it because of the errant space in your command:\r\n\r\n```\r\nknife node policy set node_name ' 2021.02.16' 'policy_name'.\r\n```\r\n\r\nThe name being \"<SPACE>2021...\" ?","My bad, I Mistakenly added while editing. It fails because I have used dot in policy_group '2021.02.16', Existing regex cannot parse.\r\n\r\nbefore:\r\n{ regex: \/^[-[:alnum:]_]+$\/, kind_of: String }\r\n\r\nafter:\r\n{ regex: \/^[-[:alnum:]_.]+$\/, kind_of: String }\r\n","I ran into this issue today after creating a policy group with a `.` in it and then setting a node to that group. Now all knife operations fail with \r\n`ERROR: Chef::Exceptions::ValidationFailed: Property chef_environment's value policy.group does not match regular expression \/^[\\-[:alnum:]_]+$\/`\r\nthis includes `edit`, `policy set`, and `delete` commands so I can't even recreate the node to fix it. It would be great if this issue could be addressed with higher priority. If a `.` is not a valid character in a policy group name, I would expect there to be validation when creating the group to prevent this."],"labels":["Type: Bug","Priority: Medium","Focus: knife"]},{"title":"Create a helper for fetching values from AWS Parameter Store","body":"While not often thought of as a \"secrets manager\" the AWS SSM Parameter Store is a pretty capable general-purpose key\/value store that also has IAM based access control. This makes it a great secrets manager for many and also a nice place to store configuration options if they need them accessible by other AWS services or don't want to put them directly into their Chef Infra Server.\r\n\r\nThe AWS cookbook has a resource to get\/set these parameters, which is functional, but rather odd since it's a resource that fetches into the node state. We really just want a helper for fetching (not setting) that behaves similarly to the resource, but fetch directly w\/o messing with the node.\r\n\r\nHere's the current resource:\r\nhttps:\/\/github.com\/sous-chefs\/aws#aws_ssm_parameter_store\r\n\r\nMore information on SSM Parameter Store:\r\nhttps:\/\/docs.aws.amazon.com\/systems-manager\/latest\/userguide\/systems-manager-parameter-store.html\r\n\r\nLooking at the current API it seems like we can probably consolidate things a bit. We currently have a `get`, `get_parameters`, and `get_parameters_by_path` action on the resource. We may be able to get away with either specifying a direct path to the parameter in which case we return a string, or a  path above that where we'd return a hash of all the keys and values.\r\n\r\nAlso we should just also perform the function of the `with_decryption` property.\r\n\r\n## Definition of Done\r\n\r\n- Helper method for accessing ssm_parameter_store roughly matching the capabilities of the existing chef resource\r\n- Documentation on docs.chef.io\r\n- Helpers included in the chef vscode plugin via the method -> YARD -> vscode automation","comments":["So if not pulling down into node state, will there not be any form of caching? I'd be concerned at least with `get_parameters_by_path` depending on how many parameters there are if you are fetching on every access. "],"labels":["Aspect: Security"]},{"title":"Chef Infra needs a way to provide secure credentials in the client.rb","body":"### Describe the Enhancement:\r\n<!---  What you are trying to achieve that you can't? -->\r\nWhen specifying the `rubygems_url`, `http_proxy`, or `https_proxy` values in Chef Infra client's client.rb file, it seems that the only way to provide authentication credentials (e.g., to a private rubygems repo), is to embed the username and password in the URL, like `https:\/\/myuser:mypass@private.rubygems.repo`. This is not ideal, as the file could be read by anyone without changing the mode to `640` or stricter. For example, the `chef-client::config` recipe sets the permissions on the client.rb wide open: https:\/\/github.com\/chef-cookbooks\/chef-client\/blob\/master\/recipes\/config.rb#L83\r\n\r\n### Describe the Need:\r\n<!---  What kind of user do you believe would utilize this enhancement, and how many users might want this functionality -->\r\nStoring credentials in the client.rb file is not secure.\r\n\r\n### Current Alternative\r\n<!--- Is there a current alternative that you can utilize to workaround the lack of this enhancement -->\r\nThe best we can do today is setting the file mode to 640 or stricter, but it would be optimal to have a better way to provide the credentials to the Chef client.\r\n\r\n### Can We Help You Implement This?:\r\n<!---  The best way to ensure your enhancement is built is to help implement the enhancement yourself. If you're interested in helping out we'd love to give you a hand to make this possible. Let us know if there's something you need. -->\r\n","comments":[],"labels":["Aspect: Security","Triage: Feature Request"]},{"title":"dnf package resource version comparison failures, part 3","body":"As a follow up to #10950, I found another dnf faiulre for `:purge` and `:remove` package resources, also caused by a comparison between `current_version` and `new_version`.  Here's some chef debug output for an rpm which is failing to be removed:\r\n\r\n```\r\nProcessing dnf_package[fb-mysql-server-5.6.35-202010141616.prod] action purge (fb_mysql::fb_mysql_server_rpm line 85)\r\nProviders for generic dnf_package resource enabled on node include: [Chef::Provider::Package::Dnf]\r\nProvider for action purge on resource dnf_package[fb-mysql-server-5.6.35-202010141616.prod] is Chef::Provider::Package::Dnf\r\nsending '{\"action\":\"whatinstalled\",\"provides\":\"fb-mysql-server-5.6.35-202010141616.prod\"}' to python helper\r\ngot 'fb-mysql-server-5.6.35-202010141616.prod 0:5.6.35-202010141616.prod x86_64' from python helper\r\nparsed fb-mysql-server-5.6.35-202010141616.prod-0:5.6.35-202010141616.prod.x86_64 from python helper\r\nsending '{\"action\":\"whatinstalled\",\"provides\":\"fb-mysql-server-5.6.35-202010141616.prod\",\"version\":\"5.6.35\",\"release\":\"202010141616.prod\"}' to python helper\r\ngot 'fb-mysql-server-5.6.35-202010141616.prod 0:5.6.35-202010141616.prod x86_64' from python helper\r\nparsed fb-mysql-server-5.6.35-202010141616.prod-0:5.6.35-202010141616.prod.x86_64 from python helper\r\n```\r\n\r\nIt's worth pointing out that this package has its version and release information also embedded into its name. <Pause for cringing.> The removal fails when `removing_package?` calls `have_any_matching_version?` because equality comparisons fail for the following version strings:\r\n```\r\ncurrent_version_array: [\"0:5.6.35-202010141616.prod.x86_64\"]\r\nnew_version_array: [\"5.6.35-202010141616.prod\"]\r\n```","comments":["The failure mode is that the package doesn't get removed."],"labels":["Platform: RHEL-like","Focus: Resources"]},{"title":"apt_repository.run_action and execute don't mix well","body":"## Description\r\n\r\n```\r\napt_repository('apt.postgresql.org').run_action(:add)\r\nexecute 'as other user' do\r\n  command 'echo foo'\r\n  user 'foo'\r\nend\r\n```\r\n\r\nresults in:\r\n```\r\n\/opt\/chef\/embedded\/lib\/ruby\/2.6.0\/fileutils.rb:1277:in `open': Permission denied @ dir_initialize - \/tmp\/.gpg20210127-21969-1km22p1 (Errno::EACCES)\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/2.6.0\/fileutils.rb:1277:in `children'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/2.6.0\/fileutils.rb:1277:in `entries'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/2.6.0\/fileutils.rb:1473:in `postorder_traverse'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/2.6.0\/fileutils.rb:758:in `remove_entry'\r\n>>\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-15.6.10\/lib\/chef\/provider\/apt_repository.rb:204:in `block in install_key_from_uri'\r\n>>\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/mixlib-shellout-3.0.7\/lib\/mixlib\/shellout\/unix.rb:321:in `fork'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/mixlib-shellout-3.0.7\/lib\/mixlib\/shellout\/unix.rb:321:in `fork_subprocess'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/mixlib-shellout-3.0.7\/lib\/mixlib\/shellout\/unix.rb:97:in `run_command'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/mixlib-shellout-3.0.7\/lib\/mixlib\/shellout.rb:270:in `run_command'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-15.6.10\/lib\/chef\/mixin\/shell_out.rb:170:in `shell_out_command'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-15.6.10\/lib\/chef\/mixin\/shell_out.rb:129:in `shell_out_compacted!'\r\n\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-15.6.10\/lib\/chef\/mixin\/shell_out.rb:64:in `shell_out!'\r\n>>\tfrom \/opt\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/chef-15.6.10\/lib\/chef\/provider\/execute.rb:58:in `block in action_run'\r\n....\r\n```\r\n\r\ndue to the `at_exit` call here: https:\/\/github.com\/chef\/chef\/blob\/2900361916aa884ad8d54e98228aa3406964e8a3\/lib\/chef\/resource\/apt_repository.rb#L259\r\n\r\nThe execute as other user forks, and when terminating seems to also want to delete that directory, but probably as the user specified, which does not have permission to do it.\r\n\r\n\r\n## Chef Version\r\n\r\nI'm using chef 15.6.10, but the culprit line is present in chef 17 as well.\r\n\r\n## Platform Version\r\n\r\nubuntu 20.04\r\n\r\n","comments":["Correction: it happens without the run action as well. Workaround use sudo in the command...","Hi, I tried running the recipe with sudo privilege and with uri option in the apt_repository and the recipe is running fine.\r\nAlso, execute recipe seems to works good in combination with apt_repository along with sudo privileges too. Hereby pasting the recipe below. Please let me know incase of any issues with the recipe\r\n\r\napt_repository 'postgresql' do\r\n  uri 'apt.postgresql.org'\r\n  action :add\r\nend\r\nexecute 'as other user' do\r\n  command 'echo foo'\r\n  user 'foo'\r\nend\r\n"],"labels":["Type: Bug","Platform: Debian-like","Focus: Resources"]},{"title":"Chef client not saving host key data when verify method is accept_new","body":"https:\/\/github.com\/chef\/chef\/blob\/master\/lib\/chef\/knife\/bootstrap.rb#L626\r\n\r\nThis does not happen because ssh is invoked with ssh_host_key \/dev\/null:\r\n\r\n```\r\nDEBUG: [SSH] using options {:user_known_hosts_file=>\"\/dev\/null\", :port=>22, :compression=>false, :compression_level=>0, :keepalive=>true, :keepalive_interval=>60, :timeout=>60, :auth_methods=>[\"none\", \"publickey\"], :keys_only=>true, :keys=>[\"\/home\/akos\/.ssh\/id_rsa\"], :password=>\"<hidden>\", :forward_agent=>true, :non_interactive=>true, :append_all_supported_algorithms=>true, :verify_host_key=>:always}\r\n```","comments":["What is the status on this issue ? Is it fixed in later chef versions or still open ?","This issue is still open. We would be happy to review a PR. Currently checking with product for when this can be prioritized. Thank you for your interest :)","I open a similar issue for inspec\/train: https:\/\/github.com\/inspec\/train\/issues\/740\r\nand yes, please fix this line as well:\r\nhttps:\/\/github.com\/chef\/chef\/blob\/main\/knife\/lib\/chef\/knife\/ssh.rb#L305\r\n"],"labels":["Type: Bug","Focus: knife bootstrap"]},{"title":"Multiline LegalNoticeText in Windows causes warnings in compliance phase","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nWhen using a multiline text in the registry key `HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\LegalNoticeText` (meaning we have newline characters in the string value of the registry key\", It causes a large set of warnings to appear during the compliance phase of the chef-client run. It might affect the audit cookbook as well, but I haven't tested with older versions of chef-client.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nSeen in stable releases of chef client 16.8 and 16.9\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nWindows 2016\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\nRun chef-client in kitchen with audit attributes set to run an inspec profile.  I had my kitchen setup to allow the compliance phase to pull from my automate server.  This should result in output like this:\r\n\r\n  ```\r\n       Running handlers:\r\n       Running handlers complete\r\n       Chef Infra Client finished, 12\/417 resources updated in 07 seconds\r\n       [2021-01-08T15:16:33+00:00] WARN: Secrets::YAML unable to parse c:\/\/chef\/\/waivers.yml: invalid YAML or contents is not a Hash\r\n       Downloading files from <default-windows2016>\r\n       Finished converging <default-windows2016> (0m31.81s).\r\n  ```\r\n\r\nHowever, if you set a multiline value in the appropriate registry key using this resource (for instance):\r\n\r\n  ```ruby\r\n  registry_key 'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System' do\r\n    values [\r\n      { name: 'LegalNoticeText', type: :string, data: \"Only authorised users are allowed to access this computer.\\n So get off this system if you shouldn't be here!\" },\r\n    ]\r\n    recursive true\r\n    action :create\r\n  end\r\n```\r\n\r\nThis will result in the following warnings during the compliance phase of your chef client run:\r\n\r\n  ```\r\n Running handlers:\r\n       Running handlers complete\r\n       Chef Infra Client finished, 13\/417 resources updated in 07 seconds\r\n       [2021-01-08T15:18:03+00:00] WARN: Secrets::YAML unable to parse c:\/\/chef\/\/waivers.yml: invalid YAML or contents is not a Hash\r\n       W, [2021-01-08T15:18:03.624337 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.630185 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.632249 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.634663 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.640974 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.644839 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.969008 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.972999 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.975755 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.978528 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.986831 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.294477 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.297362 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.299609 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.301636 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.303968 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.306243 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.308368 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.310576 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.312736 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.314965 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.324491 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.355311 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.367024 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.369637 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.372182 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.374582 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.383421 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.392854 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.395600 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.402624 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.410366 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.420130 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.430965 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.435689 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.441205 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.447218 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.463167 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.473172 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.480074 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.500018 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.512039 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.515209 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.526304 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.527991 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.531256 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.534011 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.536871 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.540747 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.543824 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.546349 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:09.327274 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       Downloading files from <default-windows2016>\r\n       Finished converging <default-windows2016> (0m32.64s).\r\n```\r\n\r\nIf you modify the registry key again without the `\\n` newline symbol, the warnings will go away:\r\n\r\n  ```ruby\r\n  registry_key 'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System' do\r\n    values [\r\n      { name: 'LegalNoticeText', type: :string, data: \"Only authorized users are allowed to access this computer.\" },\r\n    ]\r\n    recursive true\r\n    action :create\r\n  end\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\nI'm truncating the full resource list in the running log, but this is a basic CIS level 2 cookbook we're using, and only a few resources are actually engaging other than this one, but I've verified that this is the resource that causes this error.\r\n\r\n```\r\n-----> Converging <default-windows2016>...\r\n       Preparing files for transfer\r\n       Installing cookbooks for Policyfile \/Users\/davin\/Downloads\/Nestlewindowsbase\/windowsbase\/Policyfile.rb using `chef install`\r\n       Installing cookbooks from lock\r\n       Installing windowsbase 0.1.5\r\n       Preparing dna.json\r\n       Exporting cookbook dependencies from Policyfile \/var\/folders\/mg\/2q9zf4wn7_760r_qnjq65t1w0000gp\/T\/default-windows2016-sandbox-20210108-60610-1wap4va...\r\n       Exported policy 'windowsbase' to \/var\/folders\/mg\/2q9zf4wn7_760r_qnjq65t1w0000gp\/T\/default-windows2016-sandbox-20210108-60610-1wap4va\r\n       \r\n       To converge this system with the exported policy, run:\r\n         cd \/var\/folders\/mg\/2q9zf4wn7_760r_qnjq65t1w0000gp\/T\/default-windows2016-sandbox-20210108-60610-1wap4va\r\n         chef-client -z\r\n       Removing non-cookbook files before transfer\r\n       Preparing validation.pem\r\n       Preparing client.rb\r\n-----> Chef installation detected (install only if missing)\r\n       Transferring files to <default-windows2016>\r\n       Starting Chef Infra Client, version 16.9.16\r\n       Patents: https:\/\/www.chef.io\/patents\r\n       Using policy 'windowsbase' at revision '1ca8f1582e20d71fc3e4e3216c29d002d61560f166c63510a8bc91bafd8ee984'\r\n       resolving cookbooks for run list: [\"windowsbase::default@0.1.5 (3b1162b)\"]\r\n       Synchronizing Cookbooks:\r\n         - windowsbase (0.1.5)\r\n       Installing Cookbook Gems:\r\n       Compiling Cookbooks...\r\n       Converging 415 resources\r\n       Recipe: windowsbase::account_and_local_policies\r\n         * registry_key[HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System] action create\r\n           - set value {:name=>\"LegalNoticeText\", :type=>:string, :data=>\"Only authorised users are allowed to access this computer.\\n So get off this system if you shouldn't be here!\"}\r\nRunning handlers:\r\n       Running handlers complete\r\n       Chef Infra Client finished, 13\/417 resources updated in 07 seconds\r\n       [2021-01-08T15:18:03+00:00] WARN: Secrets::YAML unable to parse c:\/\/chef\/\/waivers.yml: invalid YAML or contents is not a Hash\r\n       W, [2021-01-08T15:18:03.624337 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.630185 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.632249 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.634663 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.640974 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.644839 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.969008 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.972999 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.975755 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.978528 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:03.986831 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.294477 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.297362 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.299609 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.301636 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.303968 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.306243 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.308368 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.310576 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.312736 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.314965 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.324491 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.355311 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.367024 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.369637 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.372182 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.374582 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.383421 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.392854 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.395600 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.402624 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.410366 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.420130 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.430965 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.435689 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.441205 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.447218 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.463167 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.473172 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.480074 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.500018 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.512039 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.515209 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.526304 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.527991 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.531256 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.534011 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.536871 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.540747 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.543824 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:08.546349 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       W, [2021-01-08T15:18:09.327274 #2816]  WARN -- : You are setting a key that conflicts with a built-in method Hashie::Mash#So get off this system if you shouldn't be here! defined in Hashie::Mash. This can cause unexpected behavior when accessing the key as a property. You can still access the key via the #[] method.\r\n       Downloading files from <default-windows2016>\r\n       Finished converging <default-windows2016> (0m32.64s).\r\n-----> Test Kitchen is finished. (0m33.60s)\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":[],"labels":["Type: Bug","Platform: Windows","Focus: Compliance Phase"]},{"title":"ZD : powershell_script resource not honoring parameters while using Job-Start for background process","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nAs customer is describing the issue :\r\n\r\nI am using a simple code below to run a powershell script that takes 2 parameters as a background job.\r\npowershell_script 'test_install' do\r\ncode \"Start-Job -ScriptBlock {#{script_dir}\\test.ps1 $args} -ArgumentList 'one', 'two'\"\r\nend\r\n\r\nThe above code runs without any errors but is not passing the parameters to the script. However If I run the same code via powershell console as a command it works fine. Is there a bug around this. I can see there was a fix around the above behaviour which was done in powershell in October 2019: MicrosoftDocs\/PowerShell-Docs#4944\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nChef Infra Client v16.4.38\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\npowershell_script 'test_install' do\r\ncode \"Start-Job -ScriptBlock {#{script_dir}\\test.ps1 $args} -ArgumentList 'one', 'two'\"\r\nend\r\n\r\nThe above code runs without any errors but is not passing the parameters to the script. However If I run the same code via powershell console as a command it works fine. Is there a bug around this. I can see there was a fix around the above behaviour which was done in powershell in October 2019: MicrosoftDocs\/PowerShell-Docs#4944\r\n\r\n## Expected behavior\r\n\r\nParameters should get passed to the script.\r\n\r\n## Actual behavior\r\n\r\nDoesn't pass parameters to script\r\n\r\n## Additional context\r\n\r\nRunning code \"Start-Job -ScriptBlock { c:\\\\test\\\\.chef\\\\local-mode-cache\\\\cache\\\\was_scripts\\\\WASFixPacksInstall_Win.ps1 'install', 'CRQ123456' }\" also not passing the parameters.","comments":[],"labels":["Type: Bug","Platform: Windows"]},{"title":"Add test for `knife bootstrap --forward-agent`","body":"We need to make sure that we test setting up train connection with the :forward_agent option. This is the chef side of resolving the issue brought up in this PR:\r\n\r\nhttps:\/\/github.com\/inspec\/train\/pull\/649","comments":[],"labels":["Aspect: Testing","Focus: knife bootstrap"]},{"title":"Unified Mode on by default for Custom Resources (in Chef-18)","body":"This needs to be done in phases.\r\n\r\nFor Chef 17 we need to get more aggressive about cookbooks needing to declare unifed_mode one way or the other.  Since we have so much Chef-12 concerns and sous-chefs have still never EOL'd Chef 12, that means we need to support Chef 12, that means we must have a cop that enforces at least:\r\n\r\n```\r\nunified_mode false if respond_to?(:unified_mode)\r\n```\r\n\r\nWhich is terrible, but without hard dropping Chef-12 support we can't do anything else.\r\n\r\nWe should also warn on users not setting unified_mode on resources one way or the other in Chef 15 + Chef 16 + Chef 17 (XXX: maybe not Chef-15 since not all the internal resources are unified_mode there)","comments":["@chef\/chef-infra-approvers this can be closed now. Sous have basically dropped support for anything pre-15.3"],"labels":["Type: Enhancement"]},{"title":"Allow client key to be retrieved from the windows certificate store","body":"## Background\r\n\r\nThis is the first portion of our larger effort to remove client.pem files from disk where possible.\r\n\r\nIn this initial implementation, we will add the ability to fetch client.pem content from the Windows Certificate Store as the default behavior with configuration values to specify specifics.\r\n\r\n----\r\n\r\n## Acceptance Criteria\r\n\r\n- When running the `chef-client` CLI the client.pem will be fetched in the following order\r\n  - MY store at the Local System level\r\n  - Local disk at the existing location\r\n- The key will be identified in the store using the Chef Infra Client and the node name, allowing us to have multiple nodes managed by a single node in the future\r\n- Documentation\r\n","comments":["https:\/\/github.com\/chef\/chef\/pull\/12426"],"labels":["Aspect: Security","Platform: Windows","Triage: Feature Request","Epic"]},{"title":"Support Installing chef on non-C drive","body":"We have hard coded `c:\\` as the root install location in a few spots which can cause problems if a user installs chef on a drive other than C. Many enterprises do not want to install software on C and we should make this a supported and bug free scenario.","comments":[],"labels":["Aspect: Packaging","Platform: Windows","Triage: Feature Request"]},{"title":"Documentation Automation","body":"As an operator,\nI want accurate resource documentation on docs.chef.io,\nSo that I can utilize new resources in Infra Client releases with confidence\n\n### Work to be done\n\nCurrently, we have partial automation around the generation of resource documentation on docs.chef.io. This automation is generated via extensions to the resource DSL, a rake task that converts the DSL to yaml files, and manual syncing between these yaml files and the yaml files in the chef-web-docs repository. \n\nThis is not complete automation for net-new resources or for the many legacy resources in the chef repository.  Many resource properties defined outside the DSL need to be updated so that documentation can be generated for these resources. Additionally, resource actions need to be something we can document in the DSL. With that complete net-new resources could be 100% documented and the time spent manually syncing between the automated documentation and the chef-web-docs repository could be reduced.\n\n### Acceptance Criteria:\n\n- Action descriptions can be generated automatically and are generated for all existing resources using the rake task\n- Previously undocumented properties are generated via the rake task","comments":[],"labels":["Epic"]},{"title":"Remove support for chef-solo legacy mode","body":"## Description\r\n\r\nRemoving Chef Solo legacy mode moves us to a single code path for executing Chef Infra Client runs and reduces overall complexity\/maintenance burdens. From a user perspective, there are simply too many ways to run the Chef Infra Client and we need to finalize this deprecation and just remove the legacy mode.\r\n","comments":[],"labels":["Type: Chore","Type: Breaking Change","Focus: Chef Solo"]},{"title":"Cannot install snap_package with --classic option","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nAttempting to install a snap package that requires `--classic` always fails. I also currently can only use `:upgrade` (not `:install`) from https:\/\/github.com\/chef\/chef\/issues\/10537.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nChef Infra Client, version 15.13.8\r\n\r\nConfirmed this happens in `16.6.14` in Test Kitchen as well.\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nUbuntu 18.04\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\n```ruby\r\nsnap_package 'amazon-ssm-agent' do\r\n  options '--classic'\r\n  action :upgrade\r\nend\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n* snap_package[amazon-ssm-agent] action upgrade[2020-11-02T16:48:24+00:00] INFO: Processing snap_package[amazon-ssm-agent] action upgrade (wo-common::ssm_agent line 10)\r\n\r\n\r\n           ================================================================================\r\n           Error executing action `upgrade` on resource 'snap_package[amazon-ssm-agent]'\r\n           ================================================================================\r\n\r\n           RuntimeError\r\n           ------------\r\n           status: Bad Request, kind: snap-needs-classic, message: snap \"amazon-ssm-agent\" requires classic confinement\r\n\r\n           Resource Declaration:\r\n           ---------------------\r\n           # In \/var\/tmp\/kitchen\/cache\/cookbooks\/wo-common\/recipes\/ssm_agent.rb\r\n\r\n            10: snap_package 'amazon-ssm-agent' do\r\n            11:   options '--classic'\r\n            12:   action :upgrade\r\n            13: end\r\n            14:\r\n\r\n           Compiled Resource:\r\n           ------------------\r\n           # Declared in \/var\/tmp\/kitchen\/cache\/cookbooks\/wo-common\/recipes\/ssm_agent.rb:10:in `from_file'\r\n\r\n           snap_package(\"amazon-ssm-agent\") do\r\n             package_name \"amazon-ssm-agent\"\r\n             action [:upgrade]\r\n             default_guard_interpreter :default\r\n             declared_type :snap_package\r\n             cookbook_name \"wo-common\"\r\n             recipe_name \"ssm_agent\"\r\n             options [\"--classic\"]\r\n           end\r\n\r\n           System Info:\r\n           ------------\r\n           chef_version=15.13.8\r\n           platform=ubuntu\r\n           platform_version=18.04\r\n           ruby=ruby 2.6.6p146 (2020-03-31 revision 67876) [x86_64-linux]\r\n           program_name=\/opt\/chef\/bin\/chef-client\r\n           executable=\/opt\/chef\/bin\/chef-client\r\n```","comments":["This will be looked at in https:\/\/github.com\/chef\/chef\/issues\/10591","I checked the code in https:\/\/github.com\/chef\/chef\/blob\/53941c50cf1ec88fa4076d046bfc6a456d7f1d18\/lib\/chef\/provider\/package\/snap.rb#L342, the way to specify '--classic' option should be\r\n```\r\nsnap_package 'amazon-ssm-agent' do\r\n  options 'classic'\r\n  action :upgrade\r\nend\r\n```\r\n\r\nAt least that works for me"],"labels":["Triage: Feature Request","Platform: Debian-like","Focus: Resources"]},{"title":"Why run mode and therefore before notifications are broken across many resources and load_current_resource does not fire in why run mode","body":"See for example:\r\n\r\nhttps:\/\/github.com\/chef\/chef\/issues\/8556\r\n\r\nThis is a widespread problem which hampers the ability to use before notifications outside of package or file and possibly a few other resources.\r\n\r\nIn general it is advised to never use before notifications other than for the stop-the-service-before-a-package-resource idiom.  Instead prefer to write recipes\/resources such that straightforwards forwards notifications without before notifications does the work correctly.\r\n\r\nThe fact that load_current_resource does not fire in why-run seems to cripple the entire idea of why-run mode.  I believe this was done because many load_current_resource methods were not why-run safe, but that renders it totally useless (how can you determine idempotency without loading the current state to compare to the desired state?).  The first step in fixing this would likely be enabling load_current_resource in why-run mode, but this would be a breaking change, and would likely break many internal core chef resources in why-run mode.\r\n\r\nThis should also be used as a roll-up issue for all the broken why run reports to avoid littering the issue tracker, known broken resources so far:\r\n\r\n- archive_file\r\n- systemd service\r\n","comments":["I found a simple workaround to allow using the `:before` timer that works with archive_file, perhaps others:\r\n\r\n```\r\n  archive_file 'ze_archive' do\r\n    *snip*\r\n    # Why-run mode doesn't work with archive_file, it just runs anyways.\r\n    # This little hack works around it.\r\n    action whyrun_mode? ? :nothing : :extract\r\n  end\r\n```\r\n\r\nIn other words the DSL exposes `whyrun_mode?` so behaviour can be altered based on it's value, at least in the context of a custom resource. Hopefully this helps someone."],"labels":["Type: Breaking Change","Epic"]},{"title":"Move fips? from chef-config to chef-utils","body":"### Describe the Enhancement:\r\nWe should move fips? from chef-config into chef-utils. We can make the chef-config method backwards compatible for now, but this sort of thing belongs in the chef-utils going forward.","comments":[],"labels":["Type: Chore"]},{"title":"ArgumentError in snap provider","body":"This a simple one. Snap provider [calls](https:\/\/github.com\/chef\/chef\/blob\/22da1bce7cc6b002dc602870a7bc8c4ad6e508d9\/lib\/chef\/provider\/package\/snap.rb#L69) `install_snaps(names)`, while the signature of `install_snaps` is [`(names, versions)`](https:\/\/github.com\/chef\/chef\/blob\/master\/lib\/chef\/provider\/package\/snap.rb#L268), i.e. one argument is passed instead of two and that results in ArgumentError.\r\n\r\nI guess it's just passing `versions` argument down in place referenced by first link.\r\n\r\nChef Infra Client 15.14.0, Ubuntu 20.04.1, resource triggering this:\r\n\r\n```\r\nsnap_package 'microk8s' do\r\n  options '--classic'\r\n  version 'v1.19.2'\r\nend\r\n```\r\n","comments":["Same here... ","Seeing the same here with \r\n\r\n```ruby\r\nsnap_package 'hello-world' do\r\n  action :install\r\nend\r\n```\r\n\r\nUsing `action :upgrade` seems to work but isn't always ideal."],"labels":["Type: Bug","Platform: Linux","Platform: Debian-like","Focus: Resources"]},{"title":"Convert default_guard_interpreter to be a real property","body":"## Description\r\n\r\nThis behaves like a property to the user, but under the hood, it is implemented as a method. We should convert this to a property to allow automated documentation to work as expected and to simplify the code for future maintenance.","comments":[],"labels":["Type: Chore","documentation"]},{"title":"Misc cleanup to the chef_client_config resource","body":"It's shipped, but there are a few things that should get cleaned up for the next release:\r\n\r\n- policy_file or policy_group being set requires the other to be set so enforce that.\r\n- Fill in the missing descriptions\r\n- Validate the handler hash structure to give friendly error messages\r\n- Add an example of using additional_config to put in arbitrary ruby (should we do this?)","comments":[],"labels":["Type: Enhancement","Focus: Resources"]},{"title":"ZD : Chef v15 windows_task resource incorrectly schedules OnStart task if TimeZone is changed within the same Chef run","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nChanging TZ of the Windows system in Chef v15 correctly adjusts system time, but is not reflected in the current chef-client run context.\r\nIf the same chef-client run schedules a windows_task to execute OnStart, the Activate time for the task is set using TZ of chef-client run, not the actual system TZ.\r\nIn the situation when TZ changes West (say UTC to EDT [-04:00]), the task will only be able to activate a number of hours into the future, not on the nearest system restart.\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\nChef 16\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\nSteps to reproduce the behaviour.\r\n\r\n   1.  Verify current timezone on Windows is UTC (tzutil \/g)\r\n\r\n   2. Execute following Chef cookbook\r\n\r\n```\r\npowershell_script \"Dateline Standard Time PS1\" do\r\n        code 'Set-TimeZone -Id \"Dateline Standard Time\"'\r\nend\r\n\r\npowershell_script \"Timezone after\" do\r\n        code 'Get-TimeZone'\r\nend\r\n\r\nwindows_task 'chef-client domain join reboot' do\r\n        task_name 'chef-client domain join reboot'\r\n        user 'SYSTEM'\r\n        command 'C:\\opscode\\chef\\embedded\\bin\\chef-client\"'\r\n        run_level :highest\r\n        frequency :onstart\r\n        action :create\r\nend\r\n```\r\n   3. Confirm scheduled task is created\r\n   4. Verify task properties and confirm Active time\/date is in the future compared to the current system time\r\n   5. If the system is now rebooted, the task won't trigger as it's set to activate in (TZ offset) hours\r\n\r\n## Expected behavior\r\n\r\nWindows task scheduled as OnStart will trigger on next restart, regardless of TZ changes on the system\r\n\r\n## Actual behavior\r\n\r\nOnStart scheduled task has activation time in system clock TZ at the point in time when chef-client run started, regardless of any changes to TZ during the run\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":["On `chefv16.3.45` below is the output : \r\n```\r\nPS C:\\Users\\Administrator> chef-client -zl info  C:\\Users\\Administrator\\win-task-recipe.rb\r\n\r\n[2021-02-12T11:02:27+00:00] WARN: No config file found or specified on command line. Using command line options instead.\r\n\r\n[2021-02-12T11:02:27+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming C:\/Users\/Adminis\r\ntrator.\r\n[2021-02-12T11:02:29+00:00] INFO: Started Chef Infra Zero at chefzero:\/\/localhost:1 with repository at C:\/Users\/Administ\r\nrator (One version per cookbook)\r\nStarting Chef Infra Client, version 16.3.45\r\n[2021-02-12T11:02:29+00:00] INFO: *** Chef Infra Client 16.3.45 ***\r\n[2021-02-12T11:02:29+00:00] INFO: Platform: x64-mingw32\r\n[2021-02-12T11:02:29+00:00] INFO: Chef-client pid: 992\r\n[2021-02-12T11:02:38+00:00] INFO: Run List is []\r\n[2021-02-12T11:02:38+00:00] INFO: Run List expands to []\r\n[2021-02-12T11:02:38+00:00] INFO: Starting Chef Infra Client Run for EC2AMAZ-3VIPM8U.us-east-2.compute.internal\r\n[2021-02-12T11:02:38+00:00] INFO: Running start handlers\r\n[2021-02-12T11:02:38+00:00] INFO: Start handlers complete.\r\nresolving cookbooks for run list: []\r\n[2021-02-12T11:02:38+00:00] INFO: Loading cookbooks []\r\nSynchronizing Cookbooks:\r\nInstalling Cookbook Gems:\r\nCompiling Cookbooks...\r\n[2021-02-12T11:02:38+00:00] WARN: Node EC2AMAZ-3VIPM8U.us-east-2.compute.internal has an empty run list.\r\nConverging 3 resources\r\nRecipe: @recipe_files::C:\/Users\/Administrator\/win-task-recipe.rb\r\n  * powershell_script[Dateline Standard Time PS1] action run[2021-02-12T11:02:38+00:00] INFO: Processing powershell_scri\r\npt[Dateline Standard Time PS1] action run (@recipe_files::C:\/Users\/Administrator\/win-task-recipe.rb line 1)\r\n[2021-02-12T11:02:39+00:00] INFO: powershell_script[Dateline Standard Time PS1] ran successfully\r\n\r\n    - execute \"C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoLogo -NonInteractive -NoProfile -ExecutionP\r\nolicy Bypass -InputFormat None -File \"C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/2\/chef-script20210212-992-1hqab4m.ps1\"\r\n  * powershell_script[Timezone after] action run[2021-02-12T11:02:39+00:00] INFO: Processing powershell_script[Timezone\r\nafter] action run (@recipe_files::C:\/Users\/Administrator\/win-task-recipe.rb line 5)\r\n\r\n    [execute]\r\n\r\n              Id                         : Dateline Standard Time\r\n              DisplayName                : (UTC-12:00) International Date Line West\r\n              StandardName               : Dateline Standard Time\r\n              DaylightName               : Dateline Daylight Time\r\n              BaseUtcOffset              : -12:00:00\r\n              SupportsDaylightSavingTime : False\r\n\r\n[2021-02-12T11:02:40+00:00] INFO: powershell_script[Timezone after] ran successfully\r\n    - execute \"C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoLogo -NonInteractive -NoProfile -ExecutionP\r\nolicy Bypass -InputFormat None -File \"C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/2\/chef-script20210212-992-alzj1m.ps1\"\r\n  * windows_task[chef-client domain join reboot] action create[2021-02-12T11:02:40+00:00] INFO: Processing windows_task[\r\nchef-client domain join reboot] action create (@recipe_files::C:\/Users\/Administrator\/win-task-recipe.rb line 9)\r\n\r\n    - windows_task[chef-client domain join reboot] task created\r\n[2021-02-12T11:02:40+00:00] INFO: Chef Infra Client Run complete in 2.2072793 seconds\r\n\r\nRunning handlers:\r\n[2021-02-12T11:02:40+00:00] INFO: Running report handlers\r\nRunning handlers complete\r\n[2021-02-12T11:02:40+00:00] INFO: Report handlers complete\r\nChef Infra Client finished, 3\/3 resources updated in 10 seconds\r\n\r\nPS C:\\Users\\Administrator> chef-client -v\r\nChef Infra Client: 16.3.45\r\nPS C:\\Users\\Administrator>\r\n\r\n```\r\n## Recipe\r\n\r\n```\r\npowershell_script \"Dateline Standard Time PS1\" do\r\n        code 'Set-TimeZone -Id \"Dateline Standard Time\"'\r\nend\r\n\r\npowershell_script \"Timezone after\" do\r\n        code 'Get-TimeZone'\r\nend\r\n\r\nwindows_task 'chef-client domain join reboot' do\r\n        task_name 'chef-client domain join reboot'\r\n        user 'SYSTEM'\r\n        command 'C:\\opscode\\chef\\embedded\\bin\\chef-client'\r\n        run_level :highest\r\n        frequency :onstart\r\n        action :create\r\nend\r\n```","when it is set to :onstart the windows_task resource is using `::Win32::TaskScheduler::AT_SYSTEMSTART` so i'm a bit confused as to what we need to do here with timezones...  i'd need to see what the proposal is here to fix it.","Hi @lamont-granquist We've also checked that this bug is generic when related to `windows_task` and for different frequencies other than `:onstart`. Basically timestamp here in console log message like `[2021-02-12T11:02:29+00:00] INFO: *** Chef Infra Client 16.3.45 ***` is updated from https:\/\/github.com\/chef\/mixlib-log\/blob\/v2.0.0\/lib\/mixlib\/log\/logger.rb#L52 but when we execute the recipe as above where `Timezone`  is changed in chef run it doesn't update as soon as timezone is changed like from `[2021-02-12T**_11_**:02:29+00:00] INFO: *** Chef Infra Client 16.3.45` ===>> `[2021-02-12T**_23_**:02:29+00:00] INFO: *** Chef Infra Client 16.3.45`. So was just trying to update it using `utc_offset` from `Time Class` by code \r\n```\r\nt1 = Time.now\r\nt2 = t1 + t1.utc_offset\r\n```\r\nhere in https:\/\/github.com\/chef\/mixlib-log\/blob\/v2.0.0\/lib\/mixlib\/log\/logger.rb#L52 in order to fix the issue but it is not working though. Any suggestion would be helpful here.\r\n\r\nThanks!!","This is also an issue in geo-locations with summer\/winter time zones. When this changes it causes more machines to run in an hour than is typically scheduled, causing issues upstream in the Infra Server. this is because windows_task is used within the chef_client_cookbook and chef_client_scheduled_task Resource"],"labels":["Type: Bug","Platform: Windows","Focus: Resources"]},{"title":"Missing support of locale Resource on RHEL 7+","body":"## Description\r\nCurrently Chef does not provide setting `\/etc\/locale.conf` on RHEL\/CentOS version 7+ using the locale resource. Only Debian and Windows is supported.\r\n\r\n## Chef Version\r\nChef 15+\r\n\r\n## Platform Version\r\nDistribution: RHEL\/CentOS\r\nPlatform Version: 7+\r\n\r\n## Replication Case\r\n```\r\nlocale 'set system locale' do\r\n  lang 'en_US.UTF-8'\r\nend\r\n```\r\n\r\n## Client Output\r\n```\r\n* locale[update system locale] action update\r\n  * The locale resource is not supported on platform family: rhel\r\n  ================================================================================\r\n  Error executing action `update` on resource 'locale[update system locale]'\r\n  ================================================================================\r\n\r\n  Chef::Exceptions::ProviderNotFound\r\n  ----------------------------------\r\n  The locale resource is not supported on platform family: rhel\r\n```","comments":["+1"],"labels":["Platform: RHEL-like","Triage: Feature Request","Focus: Resources"]},{"title":"Build_essential resource does not work on macos with muliple packages","body":"## Description\r\nThe build_essential resource does not install the command line tools on macos. There are no errors or failure notices. In evaluating this further, it also appears that part of the problem is Apple. While testing this earlier today, I could see 3 possible download options and I was able to download Xcode-12.0. But much later in the day the list had dropped to one choice and you get errors trying to download it manually. \r\n\r\n## Chef Version\r\n16.5.77\r\n\r\n## Platform Version\r\nmacos 10.15.7\r\n\r\n## Replication Case\r\n```ruby\r\n  build_essential 'Install Command Line Tools' do\r\n    action :install\r\n  end\r\n```\r\n\r\n## Client Output\r\nNo client output other than the normal CCR output saying it was installed. Verify it was not installed by logging into your Kitchen node and typing \"git\". You'll get an error back telling you the xcode tools need to be installed.\r\n\r\nDebug output below, notice it tries to install the Update- version which doesn't actually work\r\n\r\n```\r\n         * build_essential[Install Command Line Tools] action install[2020-10-02T17:32:18-07:00] INFO: Processing build_essential[Install Command Line Tools] action install (\/tmp\/kitchen\/cache\/cookbooks\/desktop-config\/resources\/macos_homebrew_installer.rb line 28)\r\n       objc[1844]: Class AMSupportURLConnectionDelegate is implemented in both \/System\/Library\/PrivateFrameworks\/EmbeddedOSInstall.framework\/Versions\/A\/EmbeddedOSInstall (0x11576ecc0) and \/System\/Library\/PrivateFrameworks\/OSPersonalization.framework\/Versions\/A\/OSPersonalization (0x115588090). One of the two will be used. Which one is undefined.\r\n       Software Update Tool\r\n       \r\n       Finding available software\r\n       Software Update found the following new or updated software:\r\n       * Label: macOS Catalina 10.15.7 Update- \r\n       \tTitle: macOS Catalina 10.15.7 Update, Version:  , Size: 4667570K, Recommended: YES, Action: restart, \r\n       \r\n             * execute[install Xcode Command Line tools] action run[2020-10-02T17:32:32-07:00] INFO: Processing execute[install Xcode Command Line tools] action run (\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.7.0\/gems\/chef-16.0.287\/lib\/chef\/resource\/build_essential.rb line 149)\r\n       \r\n        [execute] objc[1858]: Class AMSupportURLConnectionDelegate is implemented in both \/System\/Library\/PrivateFrameworks\/EmbeddedOSInstall.framework\/Versions\/A\/EmbeddedOSInstall (0x11c96ecc0) and \/System\/Library\/PrivateFrameworks\/OSPersonalization.framework\/Versions\/A\/OSPersonalization (0x11c788090). One of the two will be used. Which one is undefined.\r\n                  : No such update\r\n                  No updates are available.\r\n                  Software Update Tool\r\n                  \r\n       [2020-10-02T17:32:33-07:00] INFO: execute[install Xcode Command Line tools] ran successfully\r\n        - execute               # create the placeholder file that's checked by CLI updates' .dist code\r\n                      # in Apple's SUS catalog\r\n                      touch \/tmp\/.com.apple.dt.CommandLineTools.installondemand.in-progress\r\n                      # install it\r\n                      softwareupdate -i \"\" --verbose\r\n                      # Remove the placeholder to prevent perpetual appearance in the update utility\r\n                      rm -f \/tmp\/.com.apple.dt.CommandLineTools.installondemand.in-progress\r\n```\r\n\r\nWhile testing this today, I got 2 distinct sets of output from the Vagrant node by running softwareupdate --list. Output 1 shows the output from early today. The first two options are not workable - I don't want the beta and the 10.15.7 Update- package throws an error. \r\n\r\n## Command Line Output 1\r\n```bash\r\nvagrant@default-macos-chef16 ~ % softwareupdate --list\r\nobjc[2608]: Class AMSupportURLConnectionDelegate is implemented in both \/System\/Library\/PrivateFrameworks\/EmbeddedOSInstall.framework\/Versions\/A\/EmbeddedOSInstall (0x114468cc0) and \/System\/Library\/PrivateFrameworks\/OSPersonalization.framework\/Versions\/A\/OSPersonalization (0x114282090). One of the two will be used. Which one is undefined.\r\nSoftware Update Tool\r\n\u200b\r\nFinding available software\r\nSoftware Update found the following new or updated software:\r\n* Label: Command Line Tools beta 5 for Xcode-12.0\r\n\tTitle: Command Line Tools beta 5 for Xcode, Version: 12.0, Size: 442912K, Recommended: YES, \r\n* Label: macOS Catalina 10.15.7 Update- \r\n\tTitle: macOS Catalina 10.15.7 Update, Version:  , Size: 4667570K, Recommended: YES, Action: restart, \r\n* Label: Command Line Tools for Xcode-12.0\r\n\tTitle: Command Line Tools for Xcode, Version: 12.0, Size: 429595K, Recommended: YES, \r\nvagrant@default-macos-chef16 ~ %\r\n```\r\n\r\n## Command Line Output 2\r\n```bash\r\nvagrant@default-macos-chef16 ~ % softwareupdate -i 'macOS Catalina 10.15.7 Update-'\r\nobjc[1360]: Class AMSupportURLConnectionDelegate is implemented in both \/System\/Library\/PrivateFrameworks\/EmbeddedOSInstall.framework\/Versions\/A\/EmbeddedOSInstall (0x11ba0ccc0) and \/System\/Library\/PrivateFrameworks\/OSPersonalization.framework\/Versions\/A\/OSPersonalization (0x11b826090). One of the two will be used. Which one is undefined.\r\nSoftware Update Tool\r\n\u200b\r\nmacOS Catalina 10.15.7 Update-: No such update\r\nNo updates are available.\r\nvagrant@default-macos-chef16 ~ % exit\r\nConnection to 127.0.0.1 closed.\r\n```\r\nWhen attempting to install the \"macOS Catalina 10.15.7 Update-\" package I get an error back from Apple saying \"No such update\" which appears to be what is happening with the build_essential resource. \r\n\r\n## Recommended Solutions\r\n\r\n* Allow users to specify the tools they want to install. In this case I am trying to get the Xcode-12.0 command line tools. If I can get a proper list from `softwareupdate --list` I would like to be able to specify the exact update.\r\n\r\n* Better output if I try to install an update and get back `No Such Update`. It will help in troubleshooting\r\n\r\n* In the case where there are several install options, it would be good to log that with an error or warning so the admin can do something about that. ","comments":[],"labels":["Platform: macOS","Focus: Resources"]},{"title":"`windows_user` resource requires plaintext passwords","body":"## Description\r\nThe `windows_user` resource requires plain text passwords. The docs seem to imply it accepts crypted passwords (see [docs bug](https:\/\/github.com\/chef\/chef-web-docs\/issues\/2663)) I filed, but in fact, it does not and the [tests](https:\/\/github.com\/chef\/chef\/blob\/ebd04152f0310280c397ef4a269753cf34ef1c37\/spec\/unit\/provider\/user\/windows_spec.rb#L62) seem to reveal it actually takes a plain-text password.\r\n\r\n`net user` doesn't - afaict accept non-plain-text passwords, but it looks like the [dsc user resource](https:\/\/docs.microsoft.com\/en-us\/powershell\/scripting\/dsc\/reference\/resources\/windows\/userresource) can take credentials which old \"secure strings\"... so... there's *probably* a path here. Probably. OK ... it's windows. Maybe. :)\r\n\r\n## Chef Version\r\n15.9.7\r\n\r\n## Platform Version\r\nWindows 10\r\n\r\n","comments":["@mwrock Any thoughts?","Definitely a docs bug. The `NetUserSetInfo` api we call to edit user info only accepts a plain text string.","Closing this out here based on the comment from @mwrock ","@tas50 as it stands the docs are incosistent, sure, but this is still a code bug. There are other APIs that we could use instead of NetUserSetInfo, right @mwrock ?","Not that I am aware of @jaymzh. There is also `NetUserChangePassword` but that also takes plain text.","all of these accept a `Credential` - is it possible to somehow create and export an encrypted credential string and pass that in?","There are Powershell cmdlets that accept a `credential` argument. Those cmdlets will store the password as a `SecureString` but internally they will decrypt to plain text and call .Net APIs which will then call native APIs to set the password. As far as I know, there is no native windows api that will take an encrypted password. The best we could do I think is allow users to encrypt the password and then decrypt it in the ruby and pass that to the native method.","@mwrock \r\n\r\nSo, it looks like you can export `SecureString`s as `EncryptedString`s, and then convert them back and use them to set passwords:\r\n\r\n```\r\nPS C:\\> $Secure = Read-Host -AsSecureString\r\nPS C:\\> $Secure\r\nSystem.Security.SecureString\r\nPS C:\\> $Encrypted = ConvertFrom-SecureString -SecureString $Secure\r\nPS C:\\> $Encrypted\r\n01000000d08c9ddf0115d1118c7a00c04fc297eb010000001a114d45b8dd3f4aa11ad7c0abdae98000000000\r\n02000000000003660000a8000000100000005df63cea84bfb7d70bd6842e7efa79820000000004800000a000\r\n000010000000f10cd0f4a99a8d5814d94e0687d7430b100000008bf11f1960158405b2779613e9352c6d1400\r\n0000e6b7bf46a9d485ff211b9b2a2df3bd6eb67aae41\r\nPS C:\\> $Secure2 = ConvertTo-SecureString -String $Encrypted\r\nPS C:\\> $Secure2\r\nSystem.Security.SecureString\r\n```\r\n\r\nFrom:\r\nhttps:\/\/docs.microsoft.com\/en-us\/powershell\/module\/microsoft.powershell.security\/convertto-securestring?view=powershell-7.1\r\n\r\nSo we **should** be able to accept an encrypted string just the way we do on Linux, no?","Seems worth investigating. In the end, the ruby is going to need to unencrypt the password to feed to the underlying windows api. I don't think we would want to be delegating to powershell for these conversions but I'm sure we could discover and call the underlying APIs that powershell is using. One thing to watch out fore is that SecureStrings are encrypted by default with a machine based key. So a SecureString generated on one machine cannot be decrypted on another. However, I know there are `key` and `securekey` args where you can pass your own key. I have not worked much with those but its worth a look.","Actually I don't think that's true. `new-localuser` accept a SecureString. So we just need a way to pass around SecureStrings. Encrypted with MachineKey obviously wouldn't work, but I can't find how EncryptedStrings are encrypted\/generated.\r\n\r\nIt amazes me there's no one-way-hash for passwords on Windows. :\/"],"labels":["Type: Enhancement","Platform: Windows","Focus: Resources","Focus: Desktop"]},{"title":"`no implicit conversion of FFI::MemoryPointer into Integer` when you specify `uid`","body":"This seems a lot like this bug from forever ago: https:\/\/github.com\/chef\/chef\/issues\/4024\r\n\r\n## Description\r\nthe `user` resource on windows blows up with `no implicit conversion of FFI::MemoryPointer into Integer` if you specify `uid`.\r\n\r\nIf you remove `uid`, then it works fine.\r\n\r\n## Chef Version\r\n15.9.7\r\n\r\n## Platform Version\r\nWindows 10\r\n\r\n## Replication Case\r\n\r\n```\r\nuser 'dude' do\r\n  uid \"8019\"\r\nend\r\n```\r\n\r\nAnd it will blow up.\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\nTypeError\r\n---------\r\nno implicit conversion of FFI::MemoryPointer into Integer\r\n\r\nResource Declaration:\r\n---------------------\r\n# In C:\/chef\/cache\/cookbooks\/fb_users\/resources\/default.rb\r\n\r\n109:     user username do\r\n110:       uid mapinfo['uid']\r\n111:       # the .to_i here is important - if the usermap accidentally\r\n112:       # quotes the gid, then it will try to look up a group named \"142\"\r\n113:       # or whatever.\r\n114:       #\r\n115:       # We explicityly pass in a GID here instead of a name to ensure that      \r\n116:       # as GIDs are moving, we get the intended outcome.\r\n117:       unless node.windows?\r\n118:         gid ::FB::Users::GID_MAP[pgroup]['gid'].to_i\r\n119:       shell info['shell'] || node['fb_users']['user_defaults']['shell']\r\n120:       manage_home manage_homedir\r\n121:       home homedir\r\n122:       comment mapinfo['comment'] if mapinfo['comment']\r\n123:       password pass if pass\r\n124:       end\r\n125:       action :create\r\n\r\nCompiled Resource:\r\n------------------\r\n# Declared in C:\/chef\/cache\/cookbooks\/fb_users\/resources\/default.rb:109:in `block (2 \r\nlevels) in class_from_file'\r\n\r\nwindows_user(\"someuser\") do\r\n  action [:create]\r\n  default_guard_interpreter :default\r\n  declared_type :user\r\n  cookbook_name \"fb_users\"\r\n  uid \"8019\"\r\nend\r\n```\r\n","comments":["@jaymzh Any chance you can see if this is an issue on 16.6 as well?","Oh I hadn't seen this. Thanks!","I still get this on 16.7.61","Oh. If we `.to_i` it works. We should coerce this properly"],"labels":["Type: Bug","Platform: Windows"]},{"title":"Resource \"windows_user_privilege\" Does Not Work as Documented","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nUsing the `windows_user_privilege` resource as documented results in a validation error.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n16.3.45\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nWindows Server 2019\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n```ruby\r\nwindows_user_privilege 'Administrators' do\r\n  privilege %w(SeAssignPrimaryTokenPrivilege SeIncreaseQuotaPrivilege)\r\nend\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\n================================================================================\r\nError executing action `add` on resource 'windows_user_privilege[Administrators]'\r\n================================================================================\r\n\r\nChef::Exceptions::ValidationFailed\r\n----------------------------------\r\nOption privilege's value [\"SeSecurityPrivilege\", \"SeBackupPrivilege\", \"SeRestorePrivilege\", \"SeSystemtimePrivilege\", \"SeShutdownPrivilege\", \"SeRemoteShutdownPrivilege\", \"SeTakeOwnershipPrivilege\", \"SeDebugPrivilege\", \"SeSystemEnvironmentPrivilege\", \"SeSystemProfilePrivilege\", \"SeProfileSingleProcessPrivilege\", \"SeIncreaseBasePriorityPrivilege\", \"SeLoadDriverPrivilege\", \"SeCreatePagefilePrivilege\", \"SeIncreaseQuotaPrivilege\", \"SeUndockPrivilege\", \"SeManageVolumePrivilege\", \"SeImpersonatePrivilege\", \"SeCreateGlobalPrivilege\", \"SeTimeZonePrivilege\", \"SeCreateSymbolicLinkPrivilege\", \"SeChangeNotifyPrivilege\", \"SeDelegateSessionUserImpersonatePrivilege\", \"SeInteractiveLogonRight\", \"SeNetworkLogonRight\", \"SeBatchLogonRight\", \"SeRemoteInteractiveLogonRight\"] Option privilege must include any of the: [\"SeTrustedCredManAccessPrivilege\", \"SeNetworkLogonRight\", \"SeTcbPrivilege\", \"SeMachineAccountPrivilege\", \"SeIncreaseQuotaPrivilege\", \"SeInteractiveLogonRight\", \"SeRemoteInteractiveLogonRight\", \"SeBackupPrivilege\", \"SeChangeNotifyPrivilege\", \"SeSystemtimePrivilege\", \"SeTimeZonePrivilege\", \"SeCreatePagefilePrivilege\", \"SeCreateTokenPrivilege\", \"SeCreateGlobalPrivilege\", \"SeCreatePermanentPrivilege\", \"SeCreateSymbolicLinkPrivilege\", \"SeDebugPrivilege\", \"SeDenyNetworkLogonRight\", \"SeDenyBatchLogonRight\", \"SeDenyServiceLogonRight\", \"SeDenyInteractiveLogonRight\", \"SeDenyRemoteInteractiveLogonRight\", \"SeEnableDelegationPrivilege\", \"SeRemoteShutdownPrivilege\", \"SeAuditPrivilege\", \"SeImpersonatePrivilege\", \"SeIncreaseWorkingSetPrivilege\", \"SeIncreaseBasePriorityPrivilege\", \"SeLoadDriverPrivilege\", \"SeLockMemoryPrivilege\", \"SeBatchLogonRight\", \"SeServiceLogonRight\", \"SeSecurityPrivilege\", \"SeRelabelPrivilege\", \"SeSystemEnvironmentPrivilege\", \"SeManageVolumePrivilege\", \"SeProfileSingleProcessPrivilege\", \"SeSystemProfilePrivilege\", \"SeUndockPrivilege\", \"SeAssignPrimaryTokenPrivilege\", \"SeRestorePrivilege\", \"SeShutdownPrivilege\", \"SeSyncAgentPrivilege\", \"SeTakeOwnershipPrivilege\"]!\r\n\r\nResource Declaration:\r\n---------------------\r\n# In C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/enable_elevated_shell\/recipes\/enable_elevated_shell.rb\r\n\r\n  1: windows_user_privilege 'Administrators' do\r\n  2:   privilege %w(SeAssignPrimaryTokenPrivilege SeIncreaseQuotaPrivilege)\r\n  3: end\r\n  4: \r\n\r\nCompiled Resource:\r\n------------------\r\n# Declared in C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/env_common\/recipes\/enable_elevated_shell.rb:1:in `from_file'\r\n\r\nwindows_user_privilege(\"Administrators\") do\r\n  action [:add]\r\n  default_guard_interpreter :default\r\n  declared_type :windows_user_privilege\r\n  cookbook_name \"env_common\"\r\n  recipe_name \"enable_elevated_shell\"\r\n  privilege [\"SeAssignPrimaryTokenPrivilege\", \"SeIncreaseQuotaPrivilege\"]\r\n  principal \"Administrators\"\r\nend\r\n\r\nSystem Info:\r\n------------\r\nchef_version=16.3.45\r\nplatform=windows\r\nplatform_version=10.0.17763\r\nruby=ruby 2.7.1p83 (2020-03-31 revision a0c7c23c9c) [x64-mingw32]\r\nprogram_name=C:\/opscode\/chef\/bin\/chef-client\r\nexecutable=C:\/opscode\/chef\/bin\/chef-client\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":["@jeremyciak user has to be mentioned in block like follows\r\n\r\n```\r\nwindows_user_privilege 'Remote interactive logon' do\r\n  privilege      'SeDenyRemoteInteractiveLogonRight'\r\n  users          ['Builtin\\Guests', 'NT AUTHORITY\\Local Account']\r\n  action         :add\r\nend\r\n```\r\nCould you please try that and let us know ?","@Vasu1105 have you actually tried that syntax and has it worked for you? I believe I have tried that previously without success. I will run another test in a bit. Maybe it's a Windows Server 2019 thing? I wouldn't think so though...","@jeremyciak that syntax should work as far as I know and that's what the doc also says https:\/\/docs.chef.io\/resources\/windows_user_privilege\/#syntax. I agree but that the Validation failed should not come on the previlege part though. But that would be different case. ","@Vasu1105 When I try this exact block you provided, or even a few different combinations of users with the `SeDenyRemoteInteractiveLogonRight` privilege it works:\r\n\r\n```ruby\r\nwindows_user_privilege 'Remote interactive logon' do\r\n  privilege      'SeDenyRemoteInteractiveLogonRight'\r\n  users          ['Builtin\\Guests', 'NT AUTHORITY\\Local Account']\r\n  action         :add\r\nend\r\n```\r\n\r\nWhat I am finding in further testing is that the resource does not seem to support the usage of either the `SeAssignPrimaryTokenPrivilege` or `SeIncreaseQuotaPrivilege` privileges. I ran the following scenarios:\r\n\r\n```ruby\r\nwindows_user_privilege 'Assign primary token privilege' do\r\n  privilege 'SeAssignPrimaryTokenPrivilege'\r\n  users     ['BUILTIN\\Administrators']\r\n  action    :add\r\nend\r\n```\r\n```ruby\r\nwindows_user_privilege 'Assign primary token privilege' do\r\n  privilege 'SeAssignPrimaryTokenPrivilege'\r\n  users     ['BUILTIN\\Guests']\r\n  action    :add\r\nend\r\n```\r\n```ruby\r\nwindows_user_privilege 'Increase quota privilege' do\r\n  privilege 'SeIncreaseQuotaPrivilege'\r\n  users     ['BUILTIN\\Administrators']\r\n  action    :add\r\nend\r\n```\r\n```ruby\r\nwindows_user_privilege 'Increase quota privilege' do\r\n  privilege 'SeIncreaseQuotaPrivilege'\r\n  users     ['BUILTIN\\Guests']\r\n  action    :add\r\nend\r\n```\r\n\r\nI always got something like this:\r\n\r\n```\r\n================================================================================\r\nError executing action `add` on resource 'windows_user_privilege[Assign primary token privilege]'\r\n================================================================================\r\n       \r\nChef::Exceptions::Win32APIError\r\n-------------------------------\r\nNo mapping between account names and security IDs was done.\r\n---- Begin Win32 API output ----\r\nSystem Error Code: 1332\r\nSystem Error Message: No mapping between account names and security IDs was done.\r\n---- End Win32 API output ----\r\n       \r\nResource Declaration:\r\n---------------------\r\n# In C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/env_common\/recipes\/enable_elevated_shell.rb\r\n       \r\n12: windows_user_privilege 'Assign primary token privilege' do\r\n13:   privilege 'SeAssignPrimaryTokenPrivilege'\r\n14:   users     ['BUILTIN\\Administrators']\r\n15:   action    :add\r\n16: end\r\n       \r\nCompiled Resource:\r\n------------------\r\n# Declared in C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/env_common\/recipes\/enable_elevated_shell.rb:12:in `from_file'\r\n       \r\nwindows_user_privilege(\"Assign primary token privilege\") do\r\n    action [:add]\r\n    default_guard_interpreter :default\r\n    declared_type :windows_user_privilege\r\n    cookbook_name \"env_common\"\r\n    recipe_name \"enable_elevated_shell\"\r\n    privilege [\"SeAssignPrimaryTokenPrivilege\"]\r\n    users [\"BUILTIN\\\\Administrators\"]\r\n    principal \"Assign primary token privilege\"\r\nend\r\n       \r\nSystem Info:\r\n------------\r\nchef_version=16.3.45\r\nplatform=windows\r\nplatform_version=10.0.14393\r\nruby=ruby 2.7.1p83 (2020-03-31 revision a0c7c23c9c) [x64-mingw32]\r\nprogram_name=C:\/opscode\/chef\/bin\/chef-client\r\nexecutable=C:\/opscode\/chef\/bin\/chef-client\r\n```\r\n\r\n### EDIT:\r\n\r\nWhen I run the following block (with an array of privileges supplied):\r\n\r\n```ruby\r\nwindows_user_privilege 'Enable elevated shell' do\r\n  privilege %w(SeAssignPrimaryTokenPrivilege SeIncreaseQuotaPrivilege)\r\n  users     ['BUILTIN\\Administrators']\r\n  action    :add\r\nend\r\n```\r\n\r\nI get the same type of error:\r\n\r\n```\r\n================================================================================\r\nError executing action `add` on resource 'windows_user_privilege[Enable elevated shell]'\r\n================================================================================\r\n       \r\nChef::Exceptions::Win32APIError\r\n-------------------------------\r\nNo mapping between account names and security IDs was done.\r\n---- Begin Win32 API output ----\r\nSystem Error Code: 1332\r\nSystem Error Message: No mapping between account names and security IDs was done.\r\n---- End Win32 API output ----\r\n       \r\nResource Declaration:\r\n---------------------\r\n# In C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/env_common\/recipes\/enable_elevated_shell.rb\r\n       \r\n12: windows_user_privilege 'Enable elevated shell' do\r\n13:   privilege %w(SeAssignPrimaryTokenPrivilege SeIncreaseQuotaPrivilege)\r\n14:   users     ['BUILTIN\\Administrators']\r\n15:   action    :add\r\n16: end\r\n       \r\nCompiled Resource:\r\n------------------\r\n# Declared in C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/env_common\/recipes\/enable_elevated_shell.rb:12:in `from_file'\r\n       \r\nwindows_user_privilege(\"Enable elevated shell\") do\r\n    action [:add]\r\n    default_guard_interpreter :default\r\n    declared_type :windows_user_privilege\r\n    cookbook_name \"env_common\"\r\n    recipe_name \"enable_elevated_shell\"\r\n    privilege [\"SeAssignPrimaryTokenPrivilege\", \"SeIncreaseQuotaPrivilege\"]\r\n    users [\"BUILTIN\\\\Administrators\"]\r\n    principal \"Enable elevated shell\"\r\nend\r\n       \r\nSystem Info:\r\n------------\r\nchef_version=16.3.45\r\nplatform=windows\r\nplatform_version=10.0.17763\r\nruby=ruby 2.7.1p83 (2020-03-31 revision a0c7c23c9c) [x64-mingw32]\r\nprogram_name=C:\/opscode\/chef\/bin\/chef-client\r\nexecutable=C:\/opscode\/chef\/bin\/chef-client\r\n```\r\n\r\n### **This** is the resource block that yields a validation error:\r\n\r\n```ruby\r\nwindows_user_privilege 'BUILTIN\\Administrators' do\r\n  privilege %w(SeAssignPrimaryTokenPrivilege SeIncreaseQuotaPrivilege)\r\n  action    :add\r\nend\r\n```\r\n\r\nHere is the error:\r\n\r\n```\r\n================================================================================\r\nError executing action `add` on resource 'windows_user_privilege[BUILTIN\\Administrators]'\r\n================================================================================\r\n       \r\nChef::Exceptions::ValidationFailed\r\n----------------------------------\r\nOption privilege's value [\"SeSecurityPrivilege\", \"SeBackupPrivilege\", \"SeRestorePrivilege\", \"SeSystemtimePrivilege\", \"SeShutdownPrivilege\", \"SeRemoteShutdownPrivilege\", \"SeTakeOwnershipPrivilege\", \"SeDebugPrivilege\", \"SeSystemEnvironmentPrivilege\", \"SeSystemProfilePrivilege\", \"SeProfileSingleProcessPrivilege\", \"SeIncreaseBasePriorityPrivilege\", \"SeLoadDriverPrivilege\", \"SeCreatePagefilePrivilege\", \"SeIncreaseQuotaPrivilege\", \"SeUndockPrivilege\", \"SeManageVolumePrivilege\", \"SeImpersonatePrivilege\", \"SeCreateGlobalPrivilege\", \"SeTimeZonePrivilege\", \"SeCreateSymbolicLinkPrivilege\", \"SeChangeNotifyPrivilege\", \"SeDelegateSessionUserImpersonatePrivilege\", \"SeInteractiveLogonRight\", \"SeNetworkLogonRight\", \"SeBatchLogonRight\", \"SeRemoteInteractiveLogonRight\"] Option privilege must include any of the: [\"SeTrustedCredManAccessPrivilege\", \"SeNetworkLogonRight\", \"SeTcbPrivilege\", \"SeMachineAccountPrivilege\", \"SeIncreaseQuotaPrivilege\", \"SeInteractiveLogonRight\", \"SeRemoteInteractiveLogonRight\", \"SeBackupPrivilege\", \"SeChangeNotifyPrivilege\", \"SeSystemtimePrivilege\", \"SeTimeZonePrivilege\", \"SeCreatePagefilePrivilege\", \"SeCreateTokenPrivilege\", \"SeCreateGlobalPrivilege\", \"SeCreatePermanentPrivilege\", \"SeCreateSymbolicLinkPrivilege\", \"SeDebugPrivilege\", \"SeDenyNetworkLogonRight\", \"SeDenyBatchLogonRight\", \"SeDenyServiceLogonRight\", \"SeDenyInteractiveLogonRight\", \"SeDenyRemoteInteractiveLogonRight\", \"SeEnableDelegationPrivilege\", \"SeRemoteShutdownPrivilege\", \"SeAuditPrivilege\", \"SeImpersonatePrivilege\", \"SeIncreaseWorkingSetPrivilege\", \"SeIncreaseBasePriorityPrivilege\", \"SeLoadDriverPrivilege\", \"SeLockMemoryPrivilege\", \"SeBatchLogonRight\", \"SeServiceLogonRight\", \"SeSecurityPrivilege\", \"SeRelabelPrivilege\", \"SeSystemEnvironmentPrivilege\", \"SeManageVolumePrivilege\", \"SeProfileSingleProcessPrivilege\", \"SeSystemProfilePrivilege\", \"SeUndockPrivilege\", \"SeAssignPrimaryTokenPrivilege\", \"SeRestorePrivilege\", \"SeShutdownPrivilege\", \"SeSyncAgentPrivilege\", \"SeTakeOwnershipPrivilege\"]!\r\n       \r\nResource Declaration:\r\n---------------------\r\n# In C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/env_common\/recipes\/enable_elevated_shell.rb\r\n       \r\n12: windows_user_privilege 'BUILTIN\\Administrators' do\r\n13:   privilege %w(SeAssignPrimaryTokenPrivilege SeIncreaseQuotaPrivilege)\r\n14:   action    :add\r\n15: end\r\n       \r\nCompiled Resource:\r\n------------------\r\n# Declared in C:\/Users\/ADMINI~1\/AppData\/Local\/Temp\/kitchen\/cache\/cookbooks\/env_common\/recipes\/enable_elevated_shell.rb:12:in `from_file'\r\n       \r\nwindows_user_privilege(\"BUILTIN\\Administrators\") do\r\n    action [:add]\r\n    default_guard_interpreter :default\r\n    declared_type :windows_user_privilege\r\n    cookbook_name \"env_common\"\r\n    recipe_name \"enable_elevated_shell\"\r\n    privilege [\"SeAssignPrimaryTokenPrivilege\", \"SeIncreaseQuotaPrivilege\"]\r\n    principal \"BUILTIN\\\\Administrators\"\r\nend\r\n       \r\nSystem Info:\r\n------------\r\nchef_version=16.3.45\r\nplatform=windows\r\nplatform_version=10.0.14393\r\nruby=ruby 2.7.1p83 (2020-03-31 revision a0c7c23c9c) [x64-mingw32]\r\nprogram_name=C:\/opscode\/chef\/bin\/chef-client\r\nexecutable=C:\/opscode\/chef\/bin\/chef-client\r\n```","Still running into this issue with this code block\r\n\r\n```\r\nwindows_user_privilege 'Deny log on as a batch job' do\r\n  privilege      'SeDenyBatchLogonRight'\r\n  users           ['BUILTIN\\Guests']\r\n  action         :add\r\nend\r\n```\r\n\r\nError as follows:\r\n```\r\n\r\n================================================================================\r\n    Error executing action 'add' on resource 'windows_user_privilege[Deny log on as a batch job]'\r\n    ================================================================================\r\n\r\n    Chef::Exceptions::Win32APIError\r\n    -------------------------------\r\n    No mapping between account names and security IDs was done.\r\n    ---- Begin Win32 API output ----\r\n    System Error Code: 1332\r\n    System Error Message: No mapping between account names and security IDs was done.\r\n    ---- End Win32 API output ----\r\n```\r\n\r\nHave I missed something? Trying to add the SID for 'Guests' to that security policy didnt work either","@tas50, Is there an update on this?","I have a requirement of using well known SIDs instead of usernames. Is this a supported scenario?\r\n\r\nhttps:\/\/docs.microsoft.com\/en-us\/troubleshoot\/windows-server\/identity\/security-identifiers-in-windows","I am facing below error using this resource with chef 17.1.35\r\n\r\nwindows_user_privilege 'set logon as a service right' do\r\n  privilege %w(SeServiceLogonRight)\r\n  users [\"#{service_account}\"]\r\n  sensitive true\r\n  action :nothing\r\nend\r\n\r\n           Chef::Exceptions::ValidationFailed\r\n           ----------------------------------\r\n           privilege is a required property\r\n\r\n\r\nAnyone know how to resolve? You can clearly see that I have set the privilege property.","I ran into this same issue and found out that the correct **principal** needs to be passed in. This is not documented other than saying that the default value for the principal is the resource blocks name. \r\n\r\nAfter doing some research, I found that the **principal** is the **Access Control Special Identity**. \r\n\r\nYou can find them here [Special Identities](https:\/\/docs.microsoft.com\/en-us\/windows\/security\/identity-protection\/access-control\/special-identities).\r\n\r\nI believe that clarification in the documentation on this subject is needed."],"labels":["Type: Bug","Platform: Windows","Focus: Resources","Status: Needs JIRA"]},{"title":"Add support for PowerShell Core on Non-Windows Machines","body":"### Describe the Enhancement:\r\nAdd support for executing PowerShell Core-supported resources on Non-Windows Machines once #10330 is completed.\r\n\r\n### Describe the Need:\r\nAllows for code re-use when utilizing PowerShell across platforms.\r\n\r\n### Current Alternative\r\nN\/A\r\n","comments":[],"labels":["Platform: Unix-like","Triage: Feature Request","Focus: Resources"]},{"title":"Replace Time.now with Benchmark.realtime in the code","body":"As recently discovered Benchmark.realtime works fine on Windows (may or may not actually produce realtime timing, but it falls back to something no worse than Time.now at least) so we should use that everywhere.  It isn't very important to do in our spec tests, but it might affect customers running the code across many thousands of servers.  It can't hurt using it everywhere though.","comments":[],"labels":["Type: Enhancement","Priority: Low"]},{"title":"Add \"getting started\" docs for new contributors","body":"While discussing #10360 in today's triage meeting it came up that documentation on how to get started with development, especially around testing, does not currently exist.\r\n\r\nTesting is mentioned in multiple places in the existing documentation:\r\n* https:\/\/github.com\/chef\/chef\/blob\/master\/CONTRIBUTING.md#pull-request-requirements\r\n* https:\/\/github.com\/chef\/chef-oss-practices\/blob\/master\/contributors\/guide\/collaborative-dev.md#testing\r\n* https:\/\/github.com\/chef\/chef-oss-practices\/blob\/master\/contributors\/guide\/pull-requests.md#the-testing-and-merge-workflow\r\n* https:\/\/github.com\/chef\/chef-oss-practices\/blob\/master\/contributors\/guide\/pull-requests.md#5-test\r\n\r\nThere is also documentation on how to build the gem which has some overlap with testing, but it assumes a level of familiarity with ruby: https:\/\/github.com\/chef\/chef\/blob\/master\/docs\/dev\/how_to\/building_and_installing.md#building-the-gem\r\n\r\nThe need is not for a document that details how and why to write tests, but the nuts and bolts of getting started with running the existing tests. Potential topics would include:\r\n\r\n* Installing ruby with a ruby version manager to get a known working version and avoid the problems of using system ruby.\r\n* Installing the deps with bundler and friends.\r\n* How to run the different types of tests (unit vs integration).\r\n\r\nDoes something like this already exist and just needs to be surfaced better?","comments":[],"labels":["documentation"]},{"title":"Anything that uses `remote_file` under the hood should expose `ssl_verify_mode`","body":"### Describe the Enhancement:\r\n\r\nWe recently added `ssl_verify_mode` to `remote_file`. But there's no way to pass that through things like `windows_package`. We should expose that.\r\n\r\n### Describe the Need:\r\n\r\nSame as the other need - being able to handle internal servers with self-signed certs.\r\n\r\n","comments":["Tagging this for the sustaining backlog. ","Turns out there *is* a way to do this already, at least for windows_package - there's a `remote_file_attributes` property which works great! That completely solves my problem, but looking through the code base I see a few that don't have this feature: `cab_package`, and `zypper_repository`. \r\n\r\n`packages\/deb.rb` uses `remote_file`, but there's no deb_package, and I don't see that `dpkg_package` allows URLs, so I'm not quite clear where the entry point for that one is."],"labels":["Aspect: Security","Triage: Feature Request","Focus: Resources"]},{"title":"windows_path doesn't effect ISE","body":"# Description\r\n\r\nThis is somewhere between a bug and a enhancement request.\r\n\r\nThe `windows_path` resource is - at least it seems to me - somewhat useless on modern systems, because it sets the *old* kind of path which is not applicable to powershell or anything that leverages the so-called \"ISE\" framework. I think.\r\n\r\nIf you use `windows_path` to add an element to the path then pop open powershell and do `echo $env:Path`, it will not be there. If you dig up wherever `cmd.exe` is and do `echo %PATH%`, it *will* be there. How can this be? Well [this page](https:\/\/devblogs.microsoft.com\/scripting\/understanding-the-six-powershell-profiles\/) was the closest thing to an explanation I've found... it talks through the 6 different profiles - 3 types that affect \"classic\" stuff and then 3 types for \"ISE\" environments.\r\n\r\nAgain, Windows is not my strong-suit, and I could be missing things. But based on this I think it'd be useful if `windows_path` could set ISE paths.\r\n\r\n## Chef Version\r\n15 and 16, various versions.\r\n\r\n## Platform Version\r\nWindows 10, Windows Server 2016\r\n\r\n","comments":["I don't know how you set your path and all, but does your problem persist after a reboot?","@gaelcolas it's something-something WMI queries? https:\/\/github.com\/chef\/chef\/blob\/f05dc3618241eaac5755b9904fc9ceb43e59a455\/lib\/chef\/provider\/windows_env.rb#L199\r\n\r\nFTR reboot does not help. Though, honestly, if I have to *reboot a production system* to *add something to the search path for the system*, we've already failed. It's not a kernel parameter, it's just a default for an environment variable.\r\n\r\nAs far as I can tell from my research, the old places path goes are seen by 'classic' applications like cmd.exe and friends. Powershell or anything that falls under ISE use new paths, but I could be totally wrong.","There is really just one definitive set of environment variables on windows. The set has 2 scopes. A \"system\" (or machine) and \"user\" scope. Foe the `PATH` variable, the \"user\" scope paths are appended to the \"system\" scoped paths to form the complete `PATH` for a given process environment.\r\n\r\nLooking at the Chef resources, it looks like chef uses WMI to set the path at the \"user\" scope. This will update the variable in the Windows registry which is the authoritative location for all \"persistent\" environment variables. \"Persistent\" meaning that the variable is expected to be available to any process at startup. However, this will not export the value into the current process or shell. Maybe that is where the problem is occurring here? Once the converge completes, assuming you are running `chef-client` in a Powershell ISE environment, the `PATH` variable would look exactly the same as it did before `chef-client` ran. You would need to close the ISE and reopen to see the new value.\r\n\r\nEven if you simple set `$env:PATH` using a `powershell` resource, it would not impact the `PATH` of the current ISE shell since that is the parent process of the chef process and would therefore not inherit any environment changes.\r\n\r\nThis all said, I might be completely misunderstanding your scenario. It would be helpful to get a more detailed set of repro steps to understand what you are seeing @jaymzh.","That sounds about right. How does one set the \"system\" scope? I can send a PR to fix it.\r\n","Going over the code again it looks like I missed a key point, the variable is scoped to the `<SYSTEM>` user which effectively scopes it for everyone.\r\n\r\nI'm not certain what your repro steps are but assuming you were in an ISE environment and converged a `windows_path` resource. I would not expect the environment to change until you closed and reopened the ISE."],"labels":["Type: Bug","Platform: Windows","Focus: Resources"]},{"title":"`archive_file` should support excluding file\/folders on extraction","body":"### Describe the Enhancement:\r\nAdditional parameter on `archive_file` to allow defining exclusions when extracting an archive\r\n\r\n### Describe the Need:\r\nRelated to #10229, in the example of extracting a Tomcat tar, currently in [sous-chef\/tomcat tar is utilized to extract the Apache Tomcat archive excluding particular directory paths within based on parameter values on the resource](https:\/\/github.com\/sous-chefs\/tomcat\/blob\/master\/resources\/install.rb#L107).\r\n\r\nIdeally something like this could be specified:\r\n\r\n```ruby\r\narchive_file 'apache-tomcat-9.0.37.tar.gz' do\r\n  destination '\/tomcat-9.0.37'\r\n  exclude ['*webapps\/examples*','*webapps\/ROOT*','*webapps\/docs*']\r\nend\r\n```","comments":[],"labels":["Triage: Feature Request","Focus: Resources"]},{"title":"Incorrect casing on change_users and full_users for windows_share causes access to be revoked and regranted every run.","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nWhen using the `windows_share` resource, if the `full_users`, `change_users` or `read_users` differ only by case, Chef will revoke access for all users to the Windows share and then re-grant access.\r\n\r\nThe username casing returned by the underlying PowerShell (`Get-SmbShareAccess`) is dependent on the casing that a user signed into Windows server as, so Chef revoking and re-granting access does not change the casing of the username returned on the next run. As Windows is case insensitive for usernames, the casing of the usernames cannot be guaranteed.\r\n\r\nIn our case, this caused a Windows service to lose access to a share every 15 minutes, meaning that any process involving the share that took longer than 15 minutes would fail. To resolve this we ensured that the windows service was running with a user account in uppercase and ensured chef expected the username in uppercase. This necessitated a restart of Windows Server for the casing change to be reflected by `Get-SmbShareAccess`.\r\n\r\n## Chef Versions\r\nchef-client 14.2.0\r\nchef-client 16.3.45\r\n\r\n## Platform Versions\r\n - Windows Server 2016\r\n - Windows Server 2019\r\n\r\n## Replication Case\r\n - Run a windows service as a user account in lowercase.\r\n - Create a chef recipe which includes a `windows_share` resource. Specify the windows service user in uppercase.\r\n - Run the cookbook multiple times. Access will be revoked then re-granted each time.\r\n\r\n## Client Output\r\n```\r\nDEBUG: Running 'Get-SmbShareAccess -Name \"example\" | Select-Object AccountName,AccessControlType,AccessRight | ConvertTo-Json' to determine share permissions state'\r\nDEBUG: The Get-SmbShareAccess results were [{\"AccountName\":  \"AD\\\\USERNAME\",\"AccessControlType\":  0,\"AccessRight\":  1}]\r\nDEBUG: The current resource was not nil so we will update an existing share\r\nDEBUG: Running 'Set-SmbShare -Name 'example' -Description 'Example Share' -Force' to update the share\r\nDEBUG: Running 'Revoke-SmbShareAccess -Name 'example' -AccountName \"AD\\USERNAME\"\" -Force' to revoke share permissions\r\nDEBUG: Running 'Grant-SmbShareAccess -Name 'example' -AccountName \"AD\\username\"\" -Force -AccessRight full' to update the share permissions\r\n```\r\n\r\n## Stacktrace\r\nNo error is thrown.","comments":["Probably needs replication on Chef 16 since I know we've fixed idempotency issues in some resource due to incorrect casing.","> Probably needs replication on Chef 16 since I know we've fixed idempotency issues in some resource due to incorrect casing.\r\n\r\nPotentially this PR for username casing with Windows Services: https:\/\/github.com\/chef\/chef\/pull\/8981 ? Regardless will attempt to replicate in Chef 16.","> Probably needs replication on Chef 16 since I know we've fixed idempotency issues in some resource due to incorrect casing.\r\n\r\nI have replicated this in Chef 16.3.45, same issue as 14.2.0."],"labels":["Type: Bug","Platform: Windows","Status: Needs Replication","Focus: Resources","Focus: Desktop"]},{"title":"Add new 'systemd_timesyncd' resource","body":"[systemd-timesyncd](https:\/\/www.freedesktop.org\/software\/systemd\/man\/systemd-timesyncd.service.html) is a service that has been added to `systemd` for synchronizing the system clock across the network with a remote Network Time Protocol server and is included in most recent Linux distributions. Similar to `ntpd` or `chrony` yet simpler in the implementation, it is considered sufficient for most Linux machines' time synchronization requirements. \r\n\r\n## Motivation\r\nAs a user, I want a built-in resource for configuring Linux time synchronization which is required for proper Chef client\/server interaction.\r\n\r\n## Specification\r\nThis resource will write out a `\/etc\/systemd\/timesyncd.conf` for configuration and supports the actions `enable` and `start` the `systemd-timesyncd.service`.\r\n```\r\nsystemd_timesyncd 'Configure systemd_timesyncd as a client' do\r\n    ntp ['10.0.0.1']\r\n    fallbackntp ['0.arch.pool.ntp.org','1.arch.pool.ntp.org']\r\n    rootdistancemaxsec 5\r\n    pollintervalminsec 32\r\n    pollintervalmaxsec 2048\r\n    action [:enable, :start]\r\nend\r\n```\r\nThe properties map to the options listed in the [timesyncd.conf](https:\/\/www.freedesktop.org\/software\/systemd\/man\/timesyncd.conf.html#Options) documentation.\r\n\r\n- `ntp`: A space-separated list of NTP server host names or IP addresses. During runtime this list is combined with any per-interface NTP servers acquired from systemd-networkd.service. systemd-timesyncd will contact all configured system or per-interface servers in turn until one is found that responds. When the empty string is assigned, the list of NTP servers is reset, and all assignments prior to this one will have no effect. This setting defaults to an empty list.\r\n- `fallbackntp`: A space-separated list of NTP server host names or IP addresses. During runtime this list is combined with any per-interface NTP servers acquired from systemd-networkd.service. systemd-timesyncd will contact all configured system or per-interface servers in turn until one is found that responds. When the empty string is assigned, the list of NTP servers is reset, and all assignments prior to this one will have no effect. This setting defaults to an empty list.\r\n- `rootdistancemaxsec`: Maximum acceptable root distance. Takes a time value (in seconds). Defaults to 5 seconds.\r\n- `pollintervalminsec`, `pollintervalmaxsec`: The minimum and maximum poll intervals for NTP messages. Each setting takes a time value (in seconds). PollIntervalMinSec= must not be smaller than 16 seconds. PollIntervalMaxSec= must be larger than PollIntervalMinSec=. PollIntervalMinSec= defaults to 32 seconds, and PollIntervalMaxSec= defaults to 2048 seconds.\r\n\r\n## Example Implementation\r\nI've been using my own [timesyncd cookbook](https:\/\/github.com\/mattray\/timesyncd-cookbook) for several months, I'll continue refactoring and testing with it to match the proposed implementation.","comments":["Ship it!","Take a look at https:\/\/github.com\/mattray\/systemd_timesyncd-cookbook","It silently fails if you have ntpd or chrony installed, should I make it complain or fail in those use cases or is that just something the user shouldn't have done? It enables and starts, but stops immediately because those other tools are providing network time services.","How exactly does it fail if one of the other systems is running?","It deactivates the service. If you run `systemctl status systemd-timesyncd` it reports\r\n```\r\nJul 02 17:22:47 ndnd systemd[1]: Condition check resulted in Network Time Synchronization being skipped.\r\n```\r\nThe service has been enabled and started, but then stopped. `timedatactl status` also reports that\r\n```\r\nSystem clock synchronized: no\r\n              NTP service: active\r\n```\r\nas opposed to \r\n```\r\nSystem clock synchronized: yes\r\n              NTP service: active\r\n```\r\nwhen systemd-timesyncd is managing the time","FWIW the next run of the chef-client won't change anything, since the service is working as expected according to systemd.The clock is being managed, just not by systemd-timesyncd, so it's not an issue. I found this on a machine that was running ntpd from a previous cookbook that I'd removed long ago and discovered while debugging this cookbook.","Awesome! \r\n![tenor-250538280](https:\/\/user-images.githubusercontent.com\/24568\/87108528-837eca00-c29d-11ea-84b6-d39b1c1abb9a.gif)\r\n","The only concern i have about validating it started correctly is that it may lead to some kind of 'start; sleep 3; validate' kind of code.  If you can write a look where it checks every 100ms or so until it passes, with a reasonable timeout that'd be okay.  Honestly not sure I'd care if you just checked without any kind of delay, chef-client is already a CPU-grinder.\r\n\r\nThen just have properties (with desired_state: false) to turn off the checks since that's the kind of thing that'll go wrong sooner or later due to edge conditions.","I'm happy to leave it alone and assume users won't have chrony and\/or ntpd running at the same time.\r\n\r\nAre the next steps for me to prepare it as a Chef patch?","Cut a PR for chef\/chef and we can start review from there."],"labels":["Platform: Linux","Triage: Feature Request","Focus: Resources"]},{"title":"knife bootstrap lacks debug messages","body":"If you run knife bootstrap with -VVV you only get debug messages from the winrm gem. We need to add debug messaging here so that users can open support tickets and give us proper information.","comments":[],"labels":["Aspect: UX","Focus: knife bootstrap"]},{"title":"powershell_package_source - Add Support for Private PS Repositories","body":"### Describe the Enhancement:\r\nI would like to register a private PowerShell repository via Chef. Doing that natively in PowerShell requires the use of the -Credential parameter with the Register-PSRepository cmdlet. After looking over the code it appears the section that builds the Register-PSRepository command (https:\/\/github.com\/chef\/chef\/blob\/3ce10c6d89728fc566709383d74b41df8dd01fd2\/lib\/chef\/resource\/powershell_package_source.rb#L129) doesn't currently provide a way to utilize that parameter.\r\n\r\n### Describe the Need:\r\nWe build custom PowerShell modules and host them on a private feed in a hosted instance of MyGet. Any organization or individual utilizing a private feed that requires authentication to register to would benefit from this enhancement.\r\n\r\n### Current Alternative\r\nI believe the current alternative would be to register the private PowerShell repository via the powershell_script resource, or outside of Chef manually another way.\r\n\r\n### Can We Help You Implement This?:\r\nThis would be a first contribution for me so an understanding of how challenging this would be to implement would be helpful. From looking at the code it seems the general plan of attack would be:\r\n* Add a property for credential\r\n* Add a line in the \"build_ps_repository_command\" definition for the -Credential parameter\r\n* Create any appropriate tests\r\n","comments":[],"labels":["Priority: Medium","Platform: Windows","Triage: Feature Request","Focus: Resources"]},{"title":"knife bootstrap --bootstrap-version does not work if existing client is installed","body":"If you bootstrap a node that already has the chef-client package installed and you specify the version to bootstrap you would expect that the new version would be installed if they don't match. Instead we just continue on with the existing version even though that doesn't match what the user asked for:\r\n\r\n```\r\nknife bootstrap ubuntu@1.2.3.4 -U ubuntu --sudo --node-name myhost --ssh-identity-file ~\/.ssh\/id_rsa --bootstrap-version 16.2.26\r\nConnecting to 1.2.3.4\r\nThe authenticity of host '1.2.3.4 ()' can't be established.\r\nfingerprint is SHA256:1234\r\n\r\nAre you sure you want to continue connecting\r\n? (Y\/N) y\r\nConnecting to 1.2.3.4\r\nPerforming legacy client registration with the validation key at \/Users\/tsmith\/.chef\/tim_smith-validator.pem...\r\n                                                                                                        Delete your validation key in order to use your user credentials for client registration instead.\r\nBootstrapping 1.2.3.4\r\n [13.59.181.157] -----> Existing Chef Infra Client installation detected\r\n [13.59.181.157] Starting the first Chef Infra Client Client run...\r\n [13.59.181.157] Starting Chef Infra Client, version 16.0.199","comments":["I think this is like a 6-7 year bug and I had arguments with people about fixing it ages ago.  I thought that the bootstrap should just always reinstall the asked for version to obliterate any local changes anyone might have tampered with, but people object to that a lot on the basis of wanting things to be fast.  The result would be that you'd have to do parsing of the version and version comparisons correctly in bash on the target machine (at least the way that bootstrap worked at the time).  Since that was hard the frog just boiled.","I'm not opposed to just reinstalling each time, but at a minimum, if you say 17 and you're on 13, we better install 17.","On Linux you can set `--bootstrap-install-command` and it'll [skip the check for an existing chef install](https:\/\/github.com\/chef\/chef\/blob\/v17.3.48\/knife\/lib\/chef\/knife\/bootstrap\/templates\/chef-full.erb#L171-L173).\r\n\r\nMaybe something like:\r\n```\r\n--bootstrap-install-command 'curl -fsSL https:\/\/omnitruck.chef.io\/install.sh | sudo bash -s -- -v 17.3.48'\r\n```\r\n\r\nHowever, that won't work on Windows, [where it skips the custom install command if it's already installed](https:\/\/github.com\/chef\/chef\/blob\/v17.3.48\/knife\/lib\/chef\/knife\/bootstrap\/templates\/windows-chef-client-msi.erb#L111-L120). You could use a different bootstrap erb template though."],"labels":["Focus: knife bootstrap"]},{"title":"Sudo error during bootstrap is not helpful","body":"If you specify --sudo when bootstrapping and it fails because the user doesn't have sudo privs or what not you'll get this:\r\n\r\n```\r\nERROR: Train::UserError: Sudo failed: sudo: a terminal is required to read the password; either use the -S option to read from standard input or configure an askpass helper\r\n```\r\n\r\nThat's not helpful since it's a train error. We should rescue that and provide better output if we can.","comments":["I'm having this same issue. I got farther by enabling root on the far box and allowing it to ssh in but now i've run into other issues. ","@tas50 This issue can be closed as it was related to https:\/\/app.zenhub.com\/workspace\/o\/chef\/chef\/issues\/11359, please check"],"labels":["Aspect: UX","Focus: knife bootstrap"]},{"title":"Policyfile cookbooks should have their cookbook contents validated against the SHA","body":"We've got a SHA of the cookbook, ideally we should check it and barf if it doesn't match.\r\n\r\nThis may cause issues when the SHA sometimes changes in major versions in chef-dk\/chef-ws, i think, so definitely we at least need to be able to turn this off -- for the case where someone has upgraded their chef-dk\/chef-ws but hasn't updated their chef-clients yet.","comments":[],"labels":["Type: Enhancement","Priority: Low"]},{"title":"windows_task resource doesn't work with gMSA","body":"### Describe the Enhancement:\r\nI want to run a scheduled task using a group managed service account (as chef-client on windows!)\r\n### Describe the Need:\r\nSome companies still use group managed service account in windows, if they want to install chef-client as scheduled tasks they can't since the windows_task resource gives the following error:\r\n`ArgumentError: Password is required for non-system users`\r\nThe reason is the password field that needs to be kept blank\r\n### Current Alternative\r\nThe alternative is to create a new recipe that creates the scheduled task using the powershell commands\r\n","comments":["Any update on the issue? Registering my interest."],"labels":["Priority: Low","Platform: Windows","Focus: Desktop"]},{"title":"Make sure we have a functional test for windows package installs","body":"We shipped Chef Infra Client 16 with a critical bug in package installation. This exposed a lack of functional testing for package installs. We currently do this all with unit tests and the way those are mocked didn't exercise the broken code path.","comments":["Also could put this in `kitchen-tests\/cookbooks\/end_to_end\/recipes\/windows.rb` now, and have the end-to-end test in the verify\/private pipeline cover it."],"labels":["Aspect: Testing"]},{"title":"Change knife's subcommand load to use require and not Kernel.load","body":"This means we get a pile of constant redefine warnings in specs and probably causes other odd issues:\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/master\/lib\/chef\/knife\/core\/subcommand_loader.rb#L86\r\n\r\nFigure out if we need to do this and figure out if we're loading Kernel.load in other places (hint the answer is yes)","comments":[],"labels":["Priority: Medium","Type: Chore","Focus: knife"]},{"title":"apt purges are not idempotent","body":"## Description\r\n\r\nWhen apt does a `purge`, if any package in the list is installed, it tries to uninstall them all, cfengine2 style.\r\n\r\n## Chef Version\r\n15.9.17\r\n\r\n## Platform Version\r\nUbuntu 18.04\r\n\r\n## Replication Case\r\n```ruby\r\nunwanted = [\r\n  'whoopsie',\r\n  'rtkit',\r\n  'speech-dispatcher',\r\n  'speech-dispatcher-audio-plugins',\r\n  'kerneloops-daemon',\r\n  'puppetlabs-release-pc1',\r\n  'puppet',\r\n  'landscape-common',\r\n  'landscape-client',\r\n  'avahi-autoipd',\r\n  'avahi-daemon',\r\n]\r\n\r\npackage unwanted do\r\n  action :purge\r\nend\r\n```\r\n\r\n## Client Output\r\n\r\n```\r\n---- Begin output of [\"apt-get\", \"-q\", \"-y\", \"purge\", \"whoopsie\", \"rtkit\", \"speech-dispatcher\", \"speech-dispatcher-audio-plugins\", \"kerneloops\", \"puppetlabs-release-pc1\", \"puppet\", \"landscape-common\", \"landscape-client\", \"avahi-autoipd\", \"avahi-daemon\"] ----\r\nSTDOUT: Reading package lists...\r\nBuilding dependency tree...\r\nReading state information...\r\nSTDERR: E: Unable to locate package puppetlabs-release-pc1\r\n---- End output of [\"apt-get\", \"-q\", \"-y\", \"purge\", \"whoopsie\", \"rtkit\", \"speech-dispatcher\", \"speech-dispatcher-audio-plugins\", \"kerneloops\", \"puppetlabs-release-pc1\", \"puppet\", \"landscape-common\", \"landscape-client\", \"avahi-autoipd\", \"avahi-daemon\"] ----\r\nRan [\"apt-get\", \"-q\", \"-y\", \"purge\", \"whoopsie\", \"rtkit\", \"speech-dispatcher\", \"speech-dispatcher-audio-plugins\", \"kerneloops\", \"puppetlabs-release-pc1\", \"puppet\", \"landscape-common\", \"landscape-client\", \"avahi-autoipd\", \"avahi-daemon\"] returned 100\r\n```\r\n\r\nIn this case one of the packages (`landscape-common`) was there so it needed to be removed, however, it tried uninstalling all of them as you can see above. Turns out that one of those packages isn't on the repos and thus apt barfed.\r\n\r\n```\r\n# dpkg -l 'whoopsie' 'rtkit' 'speech-dispatcher' 'speech-dispatcher-audio-plugins' 'kerneloops-daemon' 'puppetlabs-release-pc1' 'puppet' 'landscape-common' 'landscape-client'\r\nDesired=Unknown\/Install\/Remove\/Purge\/Hold\r\n| Status=Not\/Inst\/Conf-files\/Unpacked\/halF-conf\/Half-inst\/trig-aWait\/Trig-pend\r\n|\/ Err?=(none)\/Reinst-required (Status,Err: uppercase=bad)\r\n||\/ Name                                                                    Version                                  Architecture                             Description\r\n+++-=======================================================================-========================================-========================================-===================================================================================================================================================\r\nii  landscape-common                                                        18.01-0ubuntu3.4                         amd64                                    Landscape administration system client - Common files\r\ndpkg-query: no packages found matching whoopsie\r\ndpkg-query: no packages found matching rtkit\r\ndpkg-query: no packages found matching speech-dispatcher\r\ndpkg-query: no packages found matching speech-dispatcher-audio-plugins\r\ndpkg-query: no packages found matching kerneloops-daemon\r\ndpkg-query: no packages found matching puppetlabs-release-pc1\r\ndpkg-query: no packages found matching puppet\r\ndpkg-query: no packages found matching landscape-client\r\n```\r\n\r\n","comments":[],"labels":["Platform: Linux","Focus: Resources"]},{"title":"Chef initiated reboot results in fatal log messages.","body":"Hello,\r\n\r\nRebooting a node via the `reboot` resource results in a FATAL message being printed along with the path to the stacktrace. This can cause users to think there is a problem that requires investigation.\r\n\r\nExample:\r\n\r\n```\r\n  * reboot[app_requires_reboot] action request_reboot[2020-05-04T20:09:11+02:00] WARN: Reboot requested:'app_requires_reboot'\r\n    - request a system reboot to occur if the run succeeds\r\n\r\n\r\nRunning handlers:\r\nRunning handlers complete\r\nChef Infra Client finished, 1\/1 resources updated in 17 seconds\r\n[2020-05-04T20:09:12+02:00] WARN: Rebooting server at a recipe's request. Details: {:delay_mins=>0, :reason=>\"Need to reboot when the run completes successfully.\", :timestamp=>2020-05-04 20:09:11 +0200, :requested_by=>\"app_requires_reboot\"}\r\n\r\nRunning handlers:\r\n[2020-05-04T20:09:12+02:00] ERROR: Running exception handlers\r\nRunning handlers complete\r\n[2020-05-04T20:09:12+02:00] ERROR: Exception handlers complete\r\nChef Infra Client failed. 1 resources updated in 17 seconds\r\n[2020-05-04T20:09:12+02:00] FATAL: Stacktrace dumped to C:\/chef\/cache\/chef-stacktrace.out\r\n[2020-05-04T20:09:12+02:00] FATAL: Please provide the contents of the stacktrace.out file if you file a bug report\r\n[2020-05-04T20:09:12+02:00] FATAL: Chef::Exceptions::Reboot: Rebooting server at a recipe's request. Details: {:delay_mins=>0, :reason=>\"Need to reboot when the run completes successfully.\", :timestamp=>2020-05-04 20:09:11 +0200, :requested_by=>\"app_requires_reboot\"}\r\n```\r\n\r\nAs this is a controlled reboot or termination of the chef-client (e.g. when performing chef-client upgrades), this shouldn't print a message containing \"FATAL\" or \"Exception\".\r\n\r\nCould this please be changed to a more user friendly message when Chef is rebooting the server or terminating the chef-client process as per a recipe's instruction.","comments":["this is brutal... makes me second guess my provisions everytime!"],"labels":["Priority: Low"]},{"title":"Many core resources need to be converted to use the Chef 16 after_resource","body":"Old resources like the file and service resource probably need to have a load_after_resource hook added to do things \"manually\".  Everything else that can be converted to a custom resource and have a `load_current_value` correctly added to them should.\r\n\r\nUntil this is completely this will cause issues in reporting.  Particularly the abuse of the new_resource as the after_resource in old reporting results in information being overwritten if resources are re-used as in #9792.\r\n\r\n","comments":[],"labels":["Type: Chore","Epic","Focus: Resources"]},{"title":"Change node attributes to convert symbol values to strings","body":"We convert symbols to strings already in Mash\/VividMash.  Since everything we do gets rendered to JSON and back that means symbols are also never valid as values in node attributes.  It is also impossible to set a symbol value from a policyfile (or role or environment).  These are not bugs, they are design requirements.\r\n\r\nAfter this cookstyle rule bakes for at least a year or more:\r\n\r\nhttps:\/\/github.com\/chef\/cookstyle\/issues\/615\r\n\r\nWe should change convert_value in the Mash class to convert symbols to strings (which should deep stringify even hash injections via the `#[]=` operator (i think).\r\n\r\nThat may break some remaining use cases, but allowing strings to continue to be written to node attributes is just pushing buggy code around.  The buggy cookbooks all need to take their node attributes and properly `to_sym` their values wherever symbols are needed.","comments":["(this will continually generate background radiation of bug reports against policyfiles being unable to set symbols until it gets fixed)"],"labels":["Priority: Medium","Type: Breaking Change"]},{"title":"Rubygems gem_package needs to support multipackage","body":"#9721 reminded me that it still does not take multipackage, it will not be easy because that thing is a mess.","comments":[],"labels":["Priority: Medium","Triage: Feature Request","Focus: Resources"]},{"title":"Add apt_unattended_upgrades resource","body":"### Core Chef Resource Checklist\r\n\r\nBefore suggesting a resource for inclusion please make sure your suggestion meets these criteria for resources built into Chef:\r\n - [ ] Automates an operating system component that ships by default on systems such as authentication, raid, disk partitions, firewalls, containers, or virtualization systems.\r\n - [ ] Does not attempt automate 3rd party applications such as database, web, or application servers, which are best suited for cookbooks due to their fast moving nature.\r\n\r\n### Describe the resource:\r\nThis would control the apt unattended upgrades functionality.\r\n\r\n### Why should this be included out of the box?:\r\nThis is one of the last reasons to use the apt cookbook. I'd love to deprecate that cookbook\r\n\r\n### What operating systems would it run on?\r\nDebian\r\n\r\n### Current cookbook implementation:\r\napt","comments":[],"labels":["Triage: Feature Request","Focus: Resources"]},{"title":"Add a resource for chrony","body":"### Core Chef Resource Checklist\r\n\r\nBefore suggesting a resource for inclusion please make sure your suggestion meets these criteria for resources built into Chef:\r\n - [ ] Automates an operating system component that ships by default on systems such as authentication, raid, disk partitions, firewalls, containers, or virtualization systems.\r\n - [ ] Does not attempt automate 3rd party applications such as database, web, or application servers, which are best suited for cookbooks due to their fast moving nature.\r\n\r\n### Describe the resource:\r\nThis would manage chronyd config and enabling\/starting the service.\r\n\r\n### Why should this be included out of the box?:\r\nSetting time is one of the first things you try to automate and this is the way to do it on RHEL\r\n\r\n### What operating systems would it run on?\r\nRHEL\r\n\r\n### Current cookbook implementation:\r\nchronyd","comments":[],"labels":["Triage: Feature Request","Focus: Resources"]},{"title":"Add a resource for managing the motd","body":"### Core Chef Resource Checklist\r\n\r\nBefore suggesting a resource for inclusion please make sure your suggestion meets these criteria for resources built into Chef:\r\n - [ ] Automates an operating system component that ships by default on systems such as authentication, raid, disk partitions, firewalls, containers, or virtualization systems.\r\n - [ ] Does not attempt automate 3rd party applications such as database, web, or application servers, which are best suited for cookbooks due to their fast moving nature.\r\n\r\n### Describe the resource:\r\nA resource that would allow you to set the content of the system's MTOD\r\n\r\n### Why should this be included out of the box?:\r\nA lot of organizations want to set a security warning here and we should make that super simple.\r\n\r\n### What operating systems would it run on?\r\nLinux at least","comments":["@tas50 I think there are two potential used cases for motd.\r\n\r\n1. Providing the content inline with the resource for the motd (give a simple motd)\r\n2. Providing a path to a file or template with the content for the motd (complex motd)\r\n\r\n\r\nExample of providing a simple motd\r\n```ruby\r\nmotd 'message name' do\r\n  content \"This is a secure system. blah blah blah\"\r\n  action :create # default action; other action :delete\r\nend\r\n```\r\n\r\nExample of providing  a source for a more complex motd\r\n\r\n```ruby\r\nmotd 'message name' do\r\n  provide_source true # set to true to pass template\/file (defaults to false)\r\n  cookbook 'current_cookbook' # defaults to current cookbook\r\n  source 'path\/to\/template.erb'\r\n  action :create # default action; other action :delete\r\nend\r\n\r\n```","@tas50 simple motd resource functional for linux + windows: [https:\/\/github.com\/devopsdina\/motd](https:\/\/github.com\/devopsdina\/motd)\r\n\r\nJust need help moving this into core! ","You should be able to skip the provide_source bit and just use the source if a source is set. Other than that the design in the docs here lookos good to me.","@tas50 Simple and Complex motd should be working now: [https:\/\/github.com\/devopsdina\/motd](https:\/\/github.com\/devopsdina\/motd)\r\n\r\nTested with the latest chef client (16.2), with the new resource changes [https:\/\/docs.chef.io\/release_notes\/#breaking-change-in-resources](https:\/\/docs.chef.io\/release_notes\/#breaking-change-in-resources), and backwards down to chef 14\r\n\r\n"],"labels":["Triage: Feature Request","Focus: Resources"]},{"title":"Add a resolv_conf resource to core","body":"### Core Chef Resource Checklist\r\n\r\nBefore suggesting a resource for inclusion please make sure your suggestion meets these criteria for resources built into Chef:\r\n - [ ] Automates an operating system component that ships by default on systems such as authentication, raid, disk partitions, firewalls, containers, or virtualization systems.\r\n - [ ] Does not attempt automate 3rd party applications such as database, web, or application servers, which are best suited for cookbooks due to their fast moving nature.\r\n\r\n### Describe the resource:\r\nA resource that manages the contents of resolv_conf\r\n\r\n### Why should this be included out of the box?:\r\nIt's a pretty important thing to manage on boxes\r\n\r\n### What operating systems would it run on?\r\nDebian\r\n\r\n### Current cookbook implementation:\r\nwe have a cookbook, but it doesn't support the .d form fo things","comments":[],"labels":["Triage: Feature Request","Focus: Resources"]},{"title":"Add NTPd resource to core","body":"### Core Chef Resource Checklist\r\n\r\nBefore suggesting a resource for inclusion please make sure your suggestion meets these criteria for resources built into Chef:\r\n - [x] Automates an operating system component that ships by default on systems such as authentication, raid, disk partitions, firewalls, containers, or virtualization systems.\r\n - [x] Does not attempt automate 3rd party applications such as database, web, or application servers, which are best suited for cookbooks due to their fast moving nature.\r\n\r\n### Describe the resource:\r\nThis woudl be a resource for setting up NTPd on a host. It would handle the config via properties passed by the user and it would start\/enable the service. It wouldn't manage chronyd or any other NTP type services. Just NTP\r\n\r\n### Why should this be included out of the box?:\r\nThis is a super common thing that people want to do and it should just work out of the box.\r\n\r\n### What operating systems would it run on?\r\nLinux and potentially Solaris\/AIX.\r\n\r\n### Current cookbook implementation:\r\nntp","comments":[],"labels":["Triage: Feature Request","Focus: Resources"]},{"title":"Add resources for managing ZFS volumes","body":"### Core Chef Resource Checklist\r\n\r\nBefore suggesting a resource for inclusion please make sure your suggestion meets these criteria for resources built into Chef:\r\n - [x] Automates an operating system component that ships by default on systems such as authentication, raid, disk partitions, firewalls, containers, or virtualization systems.\r\n - [x] Does not attempt automate 3rd party applications such as database, web, or application servers, which are best suited for cookbooks due to their fast moving nature.\r\n\r\n### Describe the resource:\r\nThis would be a resource for managing zpools and volumes\r\n\r\n### Why should this be included out of the box?:\r\nIt's a system level thing and it should just work.\r\n\r\n### What operating systems would it run on?\r\nLinux \/ Solaris\r\n\r\n### Current cookbook implementation:\r\n???","comments":[],"labels":["Triage: Feature Request","Focus: Resources"]},{"title":"Knife Profiles credentials file method only works in user's home directory","body":"I think this is a bug since we can't even teach knife profiles if we can use user-created repos. We cant afford students to mess up their ~\/.chef contents when training. \r\n\r\nWe can only get the credentials file method to work if everything is setup in my home directory, (not in a new repo) thus utilizing the .chef dir in my home dir. But then we started evaluating the risks of students mucking around in their ~\/.chef dir.\r\n\r\nCan you please make the credential file method look within its current working directory for the .chef dir so we can have students create a safe repo to configure knife to use profile please?\r\n","comments":[],"labels":["Focus: knife"]},{"title":"printer resource should have the ability to set a default paper size","body":"### Platform Details\r\nWindows 10\r\n\r\n### Scenario:\r\nwould like the ability to set a default paper size when I configure a printer\r\nsome thing like \r\n```\r\nwindows_printer 'Magic Printer' do\r\n  driver_name 'HP LaserJet 500 color MFP M570 PCL6 Class Driver'\r\n  location 'Basement'\r\n  ipv4_address '10.0.0.10'\r\n  papersize 'A4'\r\nend\r\n```\r\n\r\n### Current work around is in PowerShell\r\n```\r\nwindows_printer 'MagicPrinter' do\r\n  driver_name 'HP LaserJet 500 color MFP M570 PCL6 Class Driver'\r\n  location 'Basement'\r\n  ipv4_address '10.0.0.10'\r\n  action :create\r\n  notifies :run, 'powershell_script[Set_Papersize_MagicPrinter_to_A4]'  \r\nend\r\n```\r\n```\r\npowershell_script 'Set_Papersize_MagicPrinter_to_A4' do\r\n  code <<-EOH\r\n  Set-PrintConfiguration -PaperSize A4 -PrinterName MagicPrinter\r\n  EOH\r\nend\r\n```\r\n","comments":[],"labels":["Platform: Windows","Triage: Feature Request","Focus: Resources"]},{"title":"remote_file: Convert use_conditional_get and source to properties","body":"We can do all the validation we need for these with native properties and we'll get automatic documentation.","comments":[],"labels":["Priority: Low","Type: Chore","documentation"]},{"title":"Convert guard_interpreter to be a true property","body":"The guard guard_interpreter value set on resources is a set_or_return currently when it should just be a property. ","comments":[],"labels":["Priority: Low","Type: Chore","documentation"]},{"title":"The knife config options need to support deprecating options","body":"We have decent deprecated options now for mixlib-cli:\r\n\r\nhttps:\/\/github.com\/chef\/chef\/commit\/0422329dd1e68e67cf67dd0b8ca341852d0b89e4\r\n\r\nThe problem is that introduced both the accessor `config_value` for trying to merge deprecated config values, and that suffers from access through `config[:new_value]` to be broken, requiring all the code to be written like `config_value(:new_value, :old_value, \"default\")` everywhere consistently or else bugs would be created.\r\n\r\nWe probably want a class method written injected into the Knife subcommands so that they can declare deprecated mixlib-config options, then have the merge_configs function in the knife superclass take the deprecated options, along with any default or any proc to convert values and, then fix `config[:new_value]` correctly.  Removing the need for `config_value` entirely.\r\n\r\nIdeally we need some convergence into mixlib-config and mixlib-cli, but I'd be happy enough to just have knife handle it correctly for a start.","comments":[],"labels":["Focus: knife"]},{"title":"Add systemd time validation to the chef_client_systemd_timer resource","body":"We  really want to make sure that folks input valid time values for these timers. If they put in bad data our systemd_unit validation will actually pass. It turns out that `systemd-analyze verify` which we run will throw error warnings to the shell, but doesn't fail if the time values are bad:\r\n\r\n```\r\nroot@timnas2:\/home\/tsmith# systemd-analyze verify \/etc\/systemd\/system\/chef-client.timer\r\n[\/etc\/systemd\/system\/chef-client.timer:8] Failed to parse timer value, ignoring: 1mi\r\nroot@timnas2:\/home\/tsmith# echo $?\r\n0\r\n```","comments":[],"labels":["Type: Enhancement","Platform: Linux","Focus: Resources"]},{"title":"Add the ability to kill long running chef-client processes in chef_client_systemd_timer","body":"systemd gives you the ability to kill long-running timers. We should probably set this up since sometimes chef-client runs hang and this causes issues for our customers. If we killed them automatically after 25 minutes that would be fine for 99.9% of folks. ","comments":["yes, this, please.","very much needed request it is."],"labels":["Triage: Feature Request","Aspect: UX"]},{"title":"Add chef-utils helper for the systemd version","body":"systemd has evolved over the years and it's important to know what version you're on so you can use the right capabilities. It would be really nice to have a systemd_version helper that would output the version installed.\r\n\r\nThis can be determined via `systemctl --version` which has output like this:\r\n\r\nUbuntu 20.04:\r\n```\r\nsystemd 245 (245.2-1ubuntu2)\r\n+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD +IDN2 -IDN +PCRE2 default-hierarchy=hybrid\r\n```\r\n\r\nRHEL 7\r\n```\r\nsystemd 219\r\n+PAM +AUDIT +SELINUX +IMA -APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ -LZ4 -SECCOMP +BLKID +ELFUTILS +KMOD +IDN\r\n```","comments":[],"labels":["Platform: Linux","Triage: Feature Request","Aspect: UX"]},{"title":"rhsm_register in 14.x unable to register with RHSM","body":"## Description\r\n\r\nRHSM_Register appears to be failing when registering new hosts to RHSM from RH, and it may be related to IBM killing a URL RH maintained for a long time.\r\n\r\n## Chef Version\r\n14.12.9  (baked into template; updating is a chicken\/egg issue at least)\r\n\r\n## Platform Version\r\nrhel 7\r\n\r\n## Replication Case\r\n```\r\n  rhsm_register node[:hostname] do\r\n    activation_key      node.run_state['rhsm']['actikey']\r\n    force               false\r\n    install_katello_agent node.read(:install_katello_agent)||false\r\n    organization        node.run_state['rhsm']['org']\r\n  end.run_action(:register)\r\n```\r\n.. which looks like this in execution:\r\n\r\n```\r\nvsphere_virtual_machine.sat02(chef):     rhsm_register(\"sat02\") do\r\nvsphere_virtual_machine.sat02(chef):       action [:nothing]\r\nvsphere_virtual_machine.sat02(chef):       default_guard_interpreter :default\r\nvsphere_virtual_machine.sat02(chef):       declared_type :rhsm_register\r\nvsphere_virtual_machine.sat02(chef):       cookbook_name \"linux-rhsm\"\r\nvsphere_virtual_machine.sat02(chef):       recipe_name \"_register\"\r\nvsphere_virtual_machine.sat02(chef):       activation_key [\"valid_key\"]\r\nvsphere_virtual_machine.sat02(chef):       organization \"90210\"\r\nvsphere_virtual_machine.sat02(chef):       satellite_host \"xmlrpc.rhn.redhat.com\"\r\nvsphere_virtual_machine.sat02(chef):       install_katello_agent false\r\nvsphere_virtual_machine.sat02(chef):       only_if { #code block }\r\nvsphere_virtual_machine.sat02(chef):     end\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\nvsphere_virtual_machine.sat02(chef):   * rhsm_register[sat02] action register\r\nvsphere_virtual_machine.sat02(chef):     * yum_package[subscription-manager] action install\r\nvsphere_virtual_machine.sat02(chef):  (up to date)\r\nvsphere_virtual_machine.sat02(chef):     * remote_file[\/var\/chef\/cache\/katello-package.rpm] action create\r\nvsphere_virtual_machine.sat02(chef): [2020-03-26T23:27:36+00:00] WARN: remote_file[\/var\/chef\/cache\/katello-package.rpm] cannot be downloaded from http:\/\/xmlrpc.rhn.redhat.com\/pub\/katello-ca-consumer-latest.noarch.rpm: 404 \"Not Found\"\r\n```\r\n\r\nIt's trying to download a cert kit, and IBM removed it.  The URL's busted.  There is no new URL.\r\n> Please note all old RHN URLs are deprecated and removed. Follow below steps[sic] to register systems to the portal and to install Satellite 6.\r\n\r\n[monkey-hitting-buttons non-automated simplistic commands and FAQ followed the statement.  There was nothing below the steps, despite suggestion there would be]\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":["Hi @tas50 and @btm,\r\n\r\nIn order to reproduce this issue there are some information required, \r\nThere are certain parameters required to write the recipe for example\r\n\r\nsatellite_host\r\norganization \r\n\r\nFor these parameters do we have any setup ready or how can I proceed?\r\n\r\nPlease suggest your thoughts.","RHSM_register resource, steps that I followed:\r\n\r\n1. Register with RedHat developers portal. [click here](https:\/\/developers.redhat.com\/)\r\n\r\n2. Once I had the developer subscription, go to download the KVM image ie. [rhel 8](https:\/\/access.redhat.com\/downloads\/content\/479\/ver=\/rhel---8\/8.2\/x86_64\/product-software)\r\n\r\n3. Follow the 'guestfish' directions (ref: https:\/\/access.redhat.com\/discussions\/664843) to change the root password:\r\n\r\n - Note that on Ubuntu `sudo apt install libguestfs-tools` to get `guestfish`, then use guestfish via sudo to change the password. the image has no password by default for root (not a blank password, no password, because whatever)\r\n\r\nOR\r\n\r\n - Use `virt-customize` to change the root password:\r\n\r\n - `sudo virt-customize -a rhel-8.2-update-2-x86_64-kvm.qcow2 --root-password password:PASSWORD --uninstall cloud-init`\r\n - Open virt-mananger`sudo virt-manager`\r\n - After selecting rhel-8 VM for booting and login into provided image root password.\r\n\r\n4. rhel has `subscription-manager` to manage the subscriptions \r\n - `subscription-manager register --username <username> --password <password> --auto-attach`\r\n\r\n\r\nNote: After a successful subscription using the developer license account satellite server is not enabled to use, we required to have a satellite server running. The blocker here to the required account which includes the satellite server.\r\n\r\nRef: https:\/\/access.redhat.com\/discussions\/3351011\r\n"],"labels":["Type: Bug","Platform: RHEL-like"]},{"title":"archive_file needs to accept accept remote files similar to poise_archive","body":"### Describe the Enhancement:\r\npoise_archive allowed the user to set the source as a remote file. We should handle this same scenario since that's one of the most common archive scenarios. This allows us to migrate users off poise_archive more easily.\r\n\r\n### Describe the Need:\r\n\r\nAdd missing behavior from https:\/\/github.com\/poise\/poise-archive\n\nAha! Link: https:\/\/chef.aha.io\/features\/SH-117","comments":[],"labels":["Triage: Feature Request","Focus: Resources"]},{"title":"client.d files override command-line arguments","body":"## Description\r\n\r\nIt seems that options in `client.d` files (but *not* `client.rb`) **override** command-line arguements.\r\n\r\n## Chef Version\r\n14.14.29\r\n\r\n## Platform Version\r\nUbuntu 16.04 and Ubuntu 18.04\r\n\r\n## Replication Case\r\n\r\nAdd `log_level :info` to `\/etc\/chef\/client.d\/test` and then run chef-client with `-l debug` ... and it will actually only log info.\r\n\r\nHowever move that configuration to `\/etc\/chef\/client.rb` and then `-l debug` works as expected.\r\n\r\n","comments":["@lamont-granquist any chance your config change resolved this?"],"labels":["Type: Bug","Priority: Critical"]},{"title":"rhsm_register resource creates high load on Red Hat Satellite","body":"## Description\r\nthe `rhsm_register` resource seems to create quite a bit of load on a Red Hat Satellite server when a large number of machines are registered to it.  It seems that when running a `subscription-manager status` this generates several tasks on the satellite that can cause load to spike when a large number of hosts are doing it all at once.  We reached out to Red Hat to help investigate the problem, and they seemed to point to this as being the culprit.  \r\n\r\n## Chef Version\r\n15.4.45\r\n\r\n## Platform Version\r\nRHEL7\r\n\r\nPlease let me know if you need and data or testing from me.  I realize that satellite is a pretty niche thing, so I will be more than happy to help or contribute to get this resolved.\r\n","comments":["Here is some more information:\r\n\r\n* When running `subscription-manager status` on a node, this will reach out to the satellite server and run a `Katello::Host::Update` on the satellite.  Process does several things on the backend.\r\n\r\n* when running `subscription-manager repos --list-enabled`, this also reaches out to the satellite and runs `Katello::Host::Update` on the satellite.\r\n\r\nAs you can see, if you have several nodes running these process, especially multiple times if you are enabling multiple repos, this could cause the number of tasks to build up on the satellite, increasing the load.  I am trying to see if Red Hat can provide any type of cache data that can be reviewed on the node vs having to reach out to the satellite all of the time.  Seems silly to me that has to do this.","Here is more information.  I saw the following displayed when running the `rhsm_subscribe` resource when it actually executed:\r\n\r\n```\r\n      [execute] Internal Server Error): Required lock is already taken by other running tasks.\r\n                Please inspect their state, fix their errors and resume them.\r\n\r\n                Required lock: update\r\n                Conflicts with tasks:\r\n                  https:\/\/REDACTED\/foreman_tasks\/tasks\/304c096b f4e6 407c 84a5 a0af02ee7b5b\r\n\r\n                Successfully attached a subscription for: Enterprise Linux Extra Packages\r\n```\r\n\r\nThe way I am doing the subscription attachment is I am looping through an array of subscription IDs.  Maybe not ideal, but not sure how else it should be done since you can't pass an array to the resource itself.\r\n\r\nAs far as checking subscription, we could possible use `subscription-manager list` to get the status of the subscription, as this shows the consumed base Red Hat subscription and seems to pull the data from scratch.\r\n\r\nThe best option for reviewing the repos that are enabled at this point seems to be to read through the `\/etc\/yum.repos.d\/redhat.repo` file that gets generated when a system is subscribed.","It might make sense for us to just trust the contents of command \/etc\/yum\/pluginconf.d\/rhnplugin.conf and add a new action to force_register aka hit the server each time."],"labels":["Type: Bug","Priority: Low","Platform: RHEL-like","Focus: Resources"]},{"title":"ACL update with directory resource not working as expected in chef 15","body":"## Description\r\nCurrently we are migrating a cookbook implemented in chef 12.12.15 to chef 15.5.17.\r\nThere is a json file where it's defined the directory permissions for windows users.\r\nIn version 12, after processing this permissions file, the result was a Test01 folder placed in C:\\\\Temp with the full control permission assigned to System and to Administrators.\r\nHowever, in version 15, each time we execute directory resource with create action to the same directory, the permission is reset only for the right that is set as attribute for that call. Which means the permission is being overwritten instead of being updated as expected.\r\nAs a result, we now have a Test01 folder placed in C:\\\\Temp with the full control permission assigned ONLY to Administrators.\r\nIn chef documentation for both, version 12 or version 15, the description of the create action says: \"If a directory already exists (but does not match), update that directory to match.\"\r\nSo, which behavior is correct? How can I make it work as it was in chef 12?\r\n\r\n## Chef Version\r\n15.5.17\r\n\r\n## Platform Version\r\nWindows Server 2012R2\r\n\r\n## Replication Case\r\n\r\nPermission file:\r\n```\r\n{\r\n    \"C:\\\\Temp\\\\Test01\": {\r\n        \"InheritPermissions\": false,\r\n        \"Permissions\": {\r\n            \"NT AUTHORITY\\\\SYSTEM\": [\r\n                \"FullControl\"\r\n            ],\r\n            \"BUILTIN\\\\Administrators\": [\r\n                \"FullControl\"\r\n            ]\r\n        }\r\n    }\r\n}\r\n```\r\nThe application reads the file and, for each pair of user + permission, it executes the following:\r\n```\r\ndirectory folder_name do\r\n  action :create\r\n  recursive true\r\n  rights permission, group_name\r\n  inherits inherit false\r\n  not_if <<-EOH\r\n\t((Get-Acl \"#{folder_name}\").Access | Select-Object IdentityReference, FileSystemRights | Where-Object { $_.IdentityReference -eq \"#{group_name}\" -and $_.FileSystemRights -like \"*#{permission}*\" }) -eq $null\r\n  EOH\r\nend\r\n```\r\n\r\n","comments":[],"labels":["Priority: Medium","Platform: Windows","Status: Needs Replication","Focus: Resources"]},{"title":"windows_share is not idempotent when using local groups","body":"## Description\r\nThe resource `windows_share` is not idempotent when using local groups\r\n\r\n## Chef Version\r\n`14.12.9`\r\n\r\n## Platform Version\r\nWindows 2016\r\n\r\n## Replication Case\r\n```\r\ndirectory 'C:\\foo' do\r\n  recursive true\r\n  rights :modify, \"#{node['hostname']}\\\\mygroup\"\r\nend\r\n\r\nwindows_share 'foo' do\r\n  path            'C:\\foo'\r\n  read_users      \"#{node['hostname']}\\\\mygroup\"\r\n  change_users    \"#{node['hostname']}\\\\mygroup\"\r\nend\r\n\r\n```\r\n\r\n## Client Output\r\n```\r\n* directory[C:\\foo] action create (up to date)\r\n         * windows_share[foo] action create\r\n           - update foo\r\n           -   set change_users to [\"WIN-4EVKS4M49GI\\\\mygroup\"] (was [\"mygroup\"])\r\n           -   set read_users   to [\"WIN-4EVKS4M49GI\\\\mygroup\"] (was [\"mygroup\"])\r\n```\r\n\r\nIt appears that the return is bringing back just the group name where the set has to have the server name for local groups to work.\r\n","comments":[],"labels":["Priority: Low","Platform: Windows","Status: Needs Replication","Focus: Resources","Focus: Desktop"]},{"title":"Have dnf_package support modular\/appstream installs","body":"### Describe the Enhancement:\r\nI'd like to see the dnf_package resource support modules\/appstreams for RHEL 8+ and fedora\r\n\r\n### Describe the Need:\r\nWell modules\/appstreams solve a large need for users who want to use RHEL\/fedora but want most things stable and a few things changed to a newer version. A good example here is PHP, if you just use the built in version of PHP in RHEL you are locked into the stone age pretty quickly. modules\/appstreams solve this by allowing newer versions (supported by RHEL if you pay them) of PHP to be installed.\r\n\r\n### Current Alternative\r\nexecute I supose: execute 'yum -y module install php:7.3\/devel' etc. \r\n\r\n### Can We Help You Implement This?:\r\nWell yes you can. ","comments":["Have you tried `dnf_package \"php:7.3\/devel\"` and what does that do?  (and what relevant logging comes out if you use -l trace)?","Well with just dnf_package \"php:7.3\/devel\" you get this: No candidate version available for php:7.3\/devel\r\n\r\nAbusing options like so:\r\ndnf_package \"php:7.3\/devel\" do\r\n  options 'module'\r\nend\r\nCreates the command:\r\n`dnf module -y install php:7.3\/devel`\r\nWhich looks a little funny but will actually work from the CLI, chef outputs the same result. My suspicion, uninvestigated at this point, is that the python helper is catching this issue. But this is based off of my knowledge of yum_package, dnf_package may be entirely different. \r\n\r\nI also have to warn that this is being tested on chef infra 14, because of the licensing changes I can't test on chef infra 15.\r\n","ah i see i missed the module bit of `yum module install`","and yeah this would take surgery to the python helper to know anything about modules","this should probably be considered blocked on #9013 since any work done to the dnf_package provider to support additional features will only make doing that work exponentially harder.","I'd like to revisit this now that #9013 was closed.\r\n\r\nI think it might be useful to also create a new resource called ``dnf_module`` as users sometimes need to enable\/disable modules such as what's described [here](https:\/\/www.percona.com\/doc\/percona-server\/LATEST\/installation\/yum_repo.html).\r\n\r\nLooking at the help for ``dnf module --help``, you can see the following actions:\r\n```\r\n  <modular command>     disable: disable a module with all its streams\r\n                        enable: enable a module stream\r\n                        info: print detailed information about a module\r\n                        install: install a module profile including its packages\r\n                        list: list all module streams, profiles and states\r\n                        provides: list modular packages\r\n                        remove: remove installed module profiles and their packages\r\n                        repoquery: list packages belonging to a module\r\n                        reset: reset a module\r\n                        update: update packages associated with an active stream\r\n```\r\nThe backend actually creates\/manages files under ``\/etc\/dnf\/modules.d`` similar to yum repos. I'm not sure if this resource should directly manage those files or do it via ``dnf module`` commands.\r\n\r\nI'm also not sure how this would tie in directly into the ``dnf_package`` resource.","I think for this specific use case you'd want to do something like this:\r\n```ruby\r\ndnf_module 'php:7.3' do\r\n  action :enable\r\nend\r\n\r\npackage 'php-devel'\r\n```\r\nPerhaps it might make sense to have ``:enable`` be the default action. Here's what it looks like from the CLI if you do it manually:\r\n```\r\n$ dnf module enable php:7.3\r\nLast metadata expiration check: 0:00:32 ago on Mon 03 Aug 2020 05:36:22 PM UTC.\r\nDependencies resolved.\r\n=======================================================================================================================\r\n Package                     Architecture               Version                      Repository                   Size\r\n=======================================================================================================================\r\nEnabling module streams:\r\n httpd                                                  2.4\r\n nginx                                                  1.14                                                          \r\n php                                                    7.3                                                           \r\n\r\nTransaction Summary\r\n=======================================================================================================================\r\n\r\nIs this ok [y\/N]: y\r\nComplete!\r\n```","Yeah `dnf_package` is about installing a package or an array of single packages.  Installing modules should go into a different resource.  Single Responsibility Principle and the dnf_package provider is already overly complicated for what it does and does not need more functionality surgically bolted onto it.","+1","FWIW we implemented this recently in the yum cookbook:\r\n\r\nhttps:\/\/github.com\/sous-chefs\/yum\/blob\/main\/resources\/dnf_module.rb\r\n\r\nIf this resource looks good, we can see about making a PR to make it a native resource.","Hello @ramereth , the new `dnf_module` resource is quite good, do you know if there is any plan to make it a native resource?","@Annih none that I'm aware of but I'm sure a PR would be a good start.","I would also be interested in a dnf_module resource be in the chef proper."],"labels":["Platform: RHEL-like","Triage: Feature Request","Focus: Resources"]},{"title":"Improve knife private key not found message","body":"The current message doesn't tell you how \/ where to fix this or point you to any documents offering help. This is one of the first things people will run into and we should write some docs to help them out.","comments":[],"labels":["Type: Enhancement","Priority: Low","Aspect: UX","Focus: knife"]},{"title":"Directory resource should remove files and replace with a directory","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\n\r\nThe `directory` resource only checks path existence and permissions, not that the resource target actually is a directory.  Thus, the replication recipe below, which creates (1) a file and then (2) a directory at the same path succeeds and leaves a file behind, when it should (non-idempotently) end up with a directory at that path.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n```\r\nlindon$ chef-client --version\r\nChef Infra Client: 15.6.10\r\nlindon$ \r\n```\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\n```\r\nlindon$ cat \/etc\/centos-release\r\nCentOS Linux release 7.7.1908 (Core)\r\nlindon$ \r\n```\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\nThe following self-contained recipe demonstrates the bug:\r\n```\r\nfile '\/var\/tmp\/test-chef-bug' do\r\n  mode '0755'\r\n  owner 'root'\r\n  group node['root_group']\r\n  content 'test'\r\n  action :create\r\nend\r\n\r\ndirectory '\/var\/tmp\/test-chef-bug' do\r\n  mode '0755'\r\n  owner 'root'\r\n  group node['root_group']\r\n  action :create\r\nend\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n```\r\nlindon$ sudo chef-client\r\nStarting Chef Infra Client, version 15.6.10\r\n[...]\r\nChef Infra Client finished, 8\/475 resources updated in 13 seconds\r\nlindon$ ls -l \/var\/tmp\/test-chef-bug \r\n-rwxr-xr-x. 1 root root 4 Dec 17 20:02 \/var\/tmp\/test-chef-bug\r\nlindon$ \r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\nNo stack trace -- chef-client run completes without error.","comments":["If I'm reading this right, I think it was a pretty easy fix? My attached PR just adjusts the create\/delete action blocks from evaluating `unless File.exist?` to `unless File.directory?`","That was my read, too \u2014 just making sure I\u2019m not missing some reason this was done this way. \n\nJim Wise\njwise@draga.com\n\nSent from my iPhone.\nDigital signature available upon request. \n\n> On Dec 22, 2019, at 00:54, Skippy <notifications@github.com> wrote:\n> \n> \ufeff\n> If I'm reading this right, I think it was a pretty easy fix? My attached PR just adjusts the create\/delete action blocks from evaluating unless File.exist? to unless File.directory?\n> \n> \u2014\n> You are receiving this because you authored the thread.\n> Reply to this email directly, view it on GitHub, or unsubscribe.\n","@lamont-granquist just wanted to confirm as per the name of the issue, do you want here to remove files if created with same name and then create a directory and vice versa? OR it should create both if the recipe is as given in the description?","I think it should be an error if a file with the same name exists \u2014 it\u2019s easy enough to remove a file if that\u2019s intentional, but if we remove a file, that could lose something which was meant to be mv\u2019ed into the directory we are now creating.\n-- \n\t\t\t\tJim Wise\n\t\t\t\t***@***.***\n\n\n\n\n\n> On Jun 3, 2021, at 05:33, Snehal Dwivedi ***@***.***> wrote:\n> \n> \n> @lamont-granquist <https:\/\/github.com\/lamont-granquist> just wanted to confirm do you want here to remove files if created with same name and then create a directory & vice versa? OR it should create both if the recipe is as given in the description?\n> \n> \u2014\n> You are receiving this because you authored the thread.\n> Reply to this email directly, view it on GitHub <https:\/\/github.com\/chef\/chef\/issues\/9175#issuecomment-853731646>, or unsubscribe <https:\/\/github.com\/notifications\/unsubscribe-auth\/AABJD3U2XVEKMYHDP7T5WILTQ5D55ANCNFSM4J4DZ5UQ>.\n> \n\n","@jimwise It sounds fine to me also and I was also working in the same way but the name of the issue `Directory resource should remove files and replace with a directory` describes something else so just waiting for confirmation to move forward.","Yup.  It\u2019s been a while \u2014 have given this more thought since then. :-)\n-- \n\t\t\t\tJim Wise\n\t\t\t\t***@***.***\n\n\n\n\n\n> On Jun 7, 2021, at 10:04, Snehal Dwivedi ***@***.***> wrote:\n> \n> \n> @jimwise <https:\/\/github.com\/jimwise> It sounds fine to me also and I was also working in the same way but the name of the issue Directory resource should remove files and replace with a directory describes something else so just waiting for confirmation to move forward.\n> \n> \u2014\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub <https:\/\/github.com\/chef\/chef\/issues\/9175#issuecomment-855958124>, or unsubscribe <https:\/\/github.com\/notifications\/unsubscribe-auth\/AABJD3V54IELVRLPUWDWIATTRTGW5ANCNFSM4J4DZ5UQ>.\n> \n\n","@lamont-granquist can you please confirm which way we should move forward. Like as @jimwise mention removing files can lose something important. So we can add a msg like a file or a directory already exists or can create both (not sure if it's possible will need to check)?","Still waiting for @lamont-granquist 's thoughts, but I would expect in this case that it would fail in the second resource because the path exists and it is not of the expected type (dir).  Otherwise, I agree we risk overwriting \/losing data. \r\n\r\nFor a parallel example, if our recipe looks like this: \r\n\r\n```\r\ndirectory \"\/tmp\/test-link\"\r\n\r\nlink \"\/tmp\/test-link\" do\r\n  to \"\/usr\"\r\nend\r\n\r\n```\r\n\r\nThe result is: \r\n\r\n```\r\n    Errno::EISDIR\r\n    -------------\r\n    Is a directory @ apply2files - \/tmp\/test-link\r\n\r\n```\r\n","@marcparadise So if I have understood correctly, then I shall move forward to remove the file and create a directory?"],"labels":["Type: Bug","Priority: Low","Triage: Feature Request"]},{"title":"We should copy some of the property_types from the docker cookbook into core (Boolean)","body":"Heh they've already been deleted there.  Some of them are terrible but Boolean at least would be useful:\r\n\r\nhttps:\/\/github.com\/chef-cookbooks\/docker\/blob\/f5cb21656f7d5608cb8ca0af888325a2481d4a71\/libraries\/docker_base.rb#L44-L47\r\n\r\nNeed to audit how the property_type API works and how Boolean is wired up and make sure that isn't going to cause issues if e.g. ruby introduces a Boolean class into core.  Some more thought needs to go into it than just copying the code into core.","comments":[],"labels":["Type: Enhancement","Aspect: UX"]},{"title":"PolicyBuilder complains about run_list being set in JSON data even though run_list is not set. ","body":"## Reoccurence https:\/\/github.com\/chef\/chef\/issues\/3557\r\n## Description\r\nWhen bootstrapping a node using the -j or --json-attribute-file options to pass JSON containing `policy_name` and `policy_group` definitions but no run_list definition,  Chef::PolicyBuilder::Policyfile complains that setting the run_list in JSON data is unsupported.\r\nThis internally set a empty runlist in first-boot attribute which leads to above issue.\r\n\r\n## Chef Version\r\n14.14.29\r\n\r\n## Platform Version\r\nUbuntu18\r\n\r\n## Replication Case\r\nCreate a json file with value as ` { \"policy_group\": \"azuregrp\", \"policy_name\": \"azurepolicy\" } `\r\nTry to bootstrap a fresh node by command `knife bootstrap <IP-Address>  -x \"azure\" -P \"<PASSWORD>\" --json-attribute-file \/etc\/chef\/bootattr.json -c \"\/etc\/chef\/knife.rb\" --sudo`\r\n\r\n## Client Output\r\n\r\n```\r\nUnexpected Error:\r\n Chef::PolicyBuilder::Policyfile::UnsupportedFeature: Policyfile does not support setting the run_list in json data.\r\n\r\n```\r\n\r\n## Stacktrace\r\n\r\n```\r\nGenerated at 2019-12-11 09:43:06 +0000\r\nChef::PolicyBuilder::Policyfile::UnsupportedFeature: Policyfile does not support setting the run_list in json data.\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/policy_builder\/policyfile.rb:107:in `initialize'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/policy_builder\/dynamic.rb:155:in `new'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/policy_builder\/dynamic.rb:155:in `select_implementation'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/policy_builder\/dynamic.rb:74:in `load_node'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/client.rb:472:in `load_node'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/client.rb:267:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/application.rb:303:in `run_with_graceful_exit_option'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/application.rb:279:in `block in run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/local_mode.rb:44:in `with_server_connectivity'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/application.rb:261:in `run_chef_client'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/application\/client.rb:449:in `run_application'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/lib\/chef\/application.rb:66:in `run'\r\n\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.14.29\/bin\/chef-client:25:in `<top (required)>'\r\n\/usr\/bin\/chef-client:81:in `load'\r\n\r\n```\r\n","comments":["I am having the same issue. Where do we specify the runlist, if we dont specify it in the policy file?\r\n\r\nChef::PolicyBuilder::Policyfile::UnsupportedFeature: Policyfile does not support setting the run_list in json data.\r\n\r\n{\r\n\r\n\"revision_id\": \"...\",\r\n\r\n\"name\": \"customapp\",\r\n\r\n\"run_list\": [\r\n\r\n\"recipe[customapp::default]\"\r\n],\r\n\r\n\"included_policy_locks\": [\r\n\r\n],\r\n\r\n\"cookbook_locks\": {\r\n\r\n\"customapp\": {\r\n\r\n  \"version\": \"0.1.0\",\r\n\r\n  \"identifier\": \"----\",\r\n\r\n  \"dotted_decimal_identifier\": \"...\",\r\n\r\n  \"source\": \".\",\r\n\r\n  \"cache_key\": null,\r\n\r\n  \"scm_info\": {\r\n\r\n    \"scm\": \"git\",\r\n\r\n    \"remote\": null,\r\n\r\n    \"revision\": null,\r\n\r\n    \"working_tree_clean\": true,\r\n\r\n    \"published\": false,\r\n\r\n    \"synchronized_remote_branches\": [\r\n\r\n    ]\r\n\r\n  },\r\n\r\n  \"source_options\": {\r\n\r\n    \"path\": \".\"\r\n\r\n  }\r\n\r\n},\r\n\r\n\"my_base_xx\": {\r\n\r\n  \"version\": \"0.1.0\",\r\n\r\n  \"identifier\": \"fddfdf\",\r\n\r\n  \"dotted_decimal_identifier\": \"zzzz\",\r\n\r\n  \"source\": \"..\/windows_base_prod\",\r\n\r\n  \"cache_key\": null,\r\n\r\n  \"scm_info\": {\r\n\r\n    \"scm\": \"git\",\r\n\r\n    \"remote\": null,\r\n\r\n    \"revision\": null,\r\n\r\n    \"working_tree_clean\": true,\r\n\r\n    \"published\": false,\r\n\r\n    \"synchronized_remote_branches\": [\r\n\r\n    ]\r\n\r\n  },\r\n\r\n  \"source_options\": {\r\n\r\n    \"path\": \"..\/my_base_xx\"\r\n\r\n  }\r\n\r\n}\r\n},\r\n\r\n\"default_attributes\": {\r\n\r\n},\r\n\r\n\"override_attributes\": {\r\n\r\n},\r\n\r\n\"solution_dependencies\": {\r\n\r\n\"Policyfile\": [\r\n\r\n  [\r\n\r\n    \"customapp\",\r\n\r\n    \">= 0.0.0\"\r\n\r\n  ],\r\n\r\n  [\r\n\r\n    \"my_base_xx\",\r\n\r\n    \">= 0.0.0\"\r\n\r\n  ]\r\n\r\n],\r\n\r\n\"dependencies\": {\r\n\r\n  \"customapp (0.1.0)\": [\r\n\r\n    [\r\n\r\n      \"my_base_xx\",\r\n\r\n      \">= 0.0.0\"\r\n\r\n    ]\r\n\r\n  ],\r\n\r\n  \"my_base_xx (0.1.0)\": [\r\n\r\n  ]\r\n\r\n}\r\n}\r\n\r\n}\r\n\r\n"],"labels":["Type: Bug","Priority: Low","Focus: knife bootstrap"]},{"title":"windows_service resource spams warnings about CDPUserSvc from win32-service gem","body":"## Description\r\n<!--- Briefly describe the issue -->\r\nSame issue as https:\/\/github.com\/chef\/chef\/issues\/7335\r\nAlso referenced in https:\/\/github.com\/chef\/chef\/issues\/8497\r\n\r\nAny use of the `windows_service` resource will spam the stdout of the chef-client run with the following warnings:\r\n\r\n```\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/win32-service-2.1.4\/lib\/win32\/service.rb:1086:in `rescue in block in services': WARNING: Failed to retrieve description for the CDPUserSvc_2180253 service. (StructuredWarnings::StandardWarning)\r\n\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.6.0\/gems\/win32-service-2.1.4\/lib\/win32\/service.rb:1146:in `rescue in block in services': WARNING: Unable to retrieve failure actions for the CDPUserSvc_2180253 service (StructuredWarnings::StandardWarning)\r\n```\r\n\r\nThis doesn't appear to have a functional impact on chef-client, but it makes the whole of chef's output very difficult to parse at times.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n14.0.202 and 15.5.17\r\n\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nWindows server 2008R2, 2012R2, and 2016.\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\nInvoke any `windows_service` resource and execute it. The warnings occur during the compile phase.\r\n","comments":[],"labels":["Priority: Medium","Platform: Windows","Focus: Resources"]},{"title":"apt_package doesn't understand `purge` properly","body":"## Description\r\n\r\nIf a package is uninstalled but not purged, i.e. in `rc` state, and you have a purge rule for it, it'll do nothing, thinking it's already removed. However if the action is `:purge`, it should run the purge on it.\r\n\r\n## Chef Version\r\n14.14.29-1\r\n\r\n## Platform Version\r\nUbuntu 18.04\r\n\r\n## Replication Case\r\n\r\nRemove a package with configuration files then make a chef rule to purge it.\r\n\r\n## Client Output\r\n\r\n```\r\n[2019-12-03T12:10:37-08:00] INFO: Processing apt_package[linux-image-4.15.0-20-generic] action purge (vcrs_kernels::default line 54)\r\n[2019-12-03T12:10:37-08:00] TRACE: Providers for generic apt_package resource enabled on node include: [Chef::Provider::Package::Apt]\r\n[2019-12-03T12:10:37-08:00] TRACE: Provider for action purge on resource apt_package[linux-image-4.15.0-20-generic] is Chef::Provider::Package::Apt\r\n[2019-12-03T12:10:37-08:00] TRACE: apt_package[linux-image-4.15.0-20-generic] installed version for linux-image-4.15.0-20-generic is (none)\r\n[2019-12-03T12:10:37-08:00] TRACE: apt_package[linux-image-4.15.0-20-generic] candidate version for linux-image-4.15.0-20-generic is 4.15.0-20.21\r\n```\r\n\r\nBut notice:\r\n\r\n```\r\nroot@hardwired:~# dpkg -l linux-image-4.15.0-20-generic\r\nDesired=Unknown\/Install\/Remove\/Purge\/Hold\r\n| Status=Not\/Inst\/Conf-files\/Unpacked\/halF-conf\/Half-inst\/trig-aWait\/Trig-pend\r\n|\/ Err?=(none)\/Reinst-required (Status,Err: uppercase=bad)\r\n||\/ Name                                                                                                 Version                                                 Architecture                                            Description\r\n+++-====================================================================================================-=======================================================-=======================================================-==============================================================================================================================================================================================================\r\nrc  linux-image-4.15.0-20-generic                                                                        4.15.0-20.21                                            amd64                                                   Signed kernel image generic\r\n```\r\n","comments":["https:\/\/github.com\/chef\/chef\/issues\/3699#issuecomment-142666627\r\n\r\nthis is actually hard, since it will require invasive changes in the communication between the provider and the superclass.","same here.. how can the status of the main `apt` and `yum` package resources be in a \"horrible mess... needs cleanup before new features...\" since **2015** and 4 years since this is still \"actually hard\"?\r\n\r\nThose are two building blocks of resources... Is Chef still actively developed? feels like an abandoned project"],"labels":["Type: Bug","Priority: Medium","Triage: Confirmed","Focus: Resources"]},{"title":"Implement a way to get outputs from `execute`","body":"### Describe the Enhancement:\r\nIn various customer projects I have seen the need to execute commands and work with their return values. Sometimes it is an API token, sometimes the return value of a binary which is later used in curl requests.\r\n\r\n### Describe the Need:\r\nUsers who need to access the output from other tools or remote systems (in Target Mode).\r\n\r\n### Current Alternative:\r\nWriting custom resources which use `shell_out!` or writing to a file which is read later on.\r\n\r\n### Can We Help You Implement This?:\r\nThe main discussion point is probably where to export the data to, the existing Chef AWS cookbook's `ssm_parameter_store` resource uses `node.run_state` as a temporary scratch space.\r\n\r\nFrom then, adding an `exports` property to the `execute` resource and parsing stdout via regex is pretty easy.\r\n\r\nBy using `export`, the functionality should be inherited from all resources derived from it.\r\n\r\nThe functionality should probably be seen as being on an advanced level, because it needs understanding of some desired state functionality (if the execute resource is not run as it has a guard applied, the output will not exist).\r\n\r\nI am using an implementation of this in some projects already and would love to make a PR if the functionality is wanted and using `node.run_state` is accepted. Feedback appreciated","comments":["The `ssm_parameter_store` should not have used the node.run_state as scratch space.  I am 1000% opposed to extending that bad pattern, and I probably shouldn't have allowed that PR to go in without changing that.\r\n\r\nYou also need to include a more compelling use case here, because if you're just trying to run a command and parse the output of it, then you absolutely should never use an execute resource and should use `shell_out`.\r\n\r\nIf you look at how every single package resource is written they use shell_out's to grab various bits of data about what packages are available or installed or whatever.  And prior to unified_mode being a thing it would have been awful to even consider rewriting those as execute resources by mixing up compile+converge mode.  So my gut is that this is a philosophical issue where users believe that they've heard that they need to use chef resources everywhere, when actually they need to learn when chef resources are appropriate and when they are not.\r\n\r\nI'm not entirely opposed to pulling information out of resources, but it needs a much better use case that isn't one where its obvious that trying to pull information out of resources is clearly the poorer choice than just doing the programming imperatively.  The resource should really be doing something that changes the running state of the system (and scribbling on a private file in the file_cache_path or tempfile or something like that is NOT something that I consider to be the \"running state of the system\" when its just an intermediate state of remote information which has been pulled locally for data massaging.  It needs to be something which is consumed by the O\/S or applications on the system, if it is just state that chef creates so that chef consumes it, then it is not the running state.","(the http_resource is another awful example -- the right answer there is to use Chef::HTTP::Simple directly in \"imperative mode\" just like using shell_out -- what might made that experience better is just a helper around that injected as a method into the DSL)","@lamont-granquist Is going to leave some additional thoughts here from our triage today","Yeah I think I've relented, but the correct way of doing this is using a `state_property` on the new_resource which is loaded by the provider.  It is possible that we need another kind of property to document this stuff correctly while making it clear that these are not to be set, but are consumed.  Now that we have unified_mode this would work reasonably well, before it would be horrible."],"labels":["Triage: Feature Request","Type: Design Proposal"]},{"title":"Group resource errors with duplicate user names","body":"I recently encountered some unexpected behavior with a cookbook that manages group membership for some of my hosts. It might be a good idea to do some input validation to remove duplicate entries and protect users from themselves.\r\n\r\n# Describe the problem\r\nWhen passing a list of users to add to a group, if there are any duplicates in the list, Chef encounters a Windows 1378 error. (User already in group)\r\n\r\n## Software Version\r\nOS: Windows 2019, Windows 2016\r\nChef: 14.7.17\r\n\r\n## Replication Case\r\ndefault['group_manager'] << 'contoso\\\\testuser'\r\ndefault['group_manager'] << 'contoso\\\\testuser'\r\n\r\naction_class do\r\n  def admins_res\r\n    node['group_manager'].each do |local_group, domain_user|\r\n      group local_group do\r\n        members domain_user\r\n        append true\r\n      end\r\n    end\r\n  end\r\nend\r\n\r\n## Stacktrace\r\n<details><summary>Chef run failure caused by duplicate users<\/summary>\r\n```\r\n      ================================================================================\r\n      Error executing action `create` on resource 'group[Administrators]'\r\n      ================================================================================\r\n      \r\n      ArgumentError\r\n      -------------\r\n      The specified account name is already a member of the group.\r\n      ---- Begin Win32 API output ----\r\n      System Error Code: 1378\r\n      System Error Message: The specified account name is already a member of the group.\r\n      ---- End Win32 API output ----\r\n      \r\n      Resource Declaration:\r\n      ---------------------\r\n      # In C:\/chef\/cache\/cookbooks\/group_manager\/resources\/group_manager.rb\r\n      \r\n       19:       group local do\r\n       20:         members domain\r\n       21:         append true\r\n       22:       end\r\n       23:     end\r\n       24:   end\r\n      \r\n      Compiled Resource:\r\n      ------------------\r\n      # Declared in C:\/chef\/cache\/cookbooks\/group_manager\/resources\/group_manager.rb:19:in 'block in admins_res'\r\n      \r\n      group(\"Administrators\") do\r\n        action [:create]\r\n        default_guard_interpreter :default\r\n        declared_type :group\r\n        cookbook_name \"group_manager\"\r\n        members [\"contoso\\\\admins\", \"contoso\\\\security_admins\", \"contoso\\\\security_admins\"]\r\n        append true\r\n        excluded_members []\r\n      end\r\n      \r\n      System Info:\r\n      ------------\r\n      chef_version=14.7.17\r\n      platform=windows\r\n      platform_version=10.0.14393\r\n      ruby=ruby 2.5.3p105 (2018-10-18 revision 65156) [x64-mingw32]\r\n      program_name=C:\/opscode\/chef\/bin\/chef-client\r\n      executable=C:\/opscode\/chef\/bin\/chef-client\r\n<\/details>\r\n\r\n## Possible Solution\r\nTo fix my users, I simply added a \".uniq\" to the array being passed to the members property. \r\n       20:         members domain.uniq\r\n\r\nSomething similar might be added as input validation on the resource side.","comments":[],"labels":["Type: Bug","Platform: Windows","Focus: Resources"]},{"title":"systemd_unit should create files in \/lib\/systemd\/system so that they can be mask'd","body":"When \/lib\/systemd\/system exist, it should be used instead of \/etc\/systemd\/service to create unit files, and a symlink should be setup in \/etc\/systemd\/service instead -- so that mask\/unmask works properly:\r\n\r\nhttps:\/\/fedoramagazine.org\/systemd-masking-units\/\r\n\r\nResearch needs to be done to determine if all systemd units support this or not?  Also there might be some convenient systemd api to just do-the-right-thing when given a file to install as a unit file so we don't have to worry about handling this?  Where possible we should call systemctl api's to do things rather than manually wire it up in the filesystem ourselves since this will be more likely to be future-proof.\r\n","comments":["i don't see the use-case here. \r\n\r\nif you want to neutralize a unit, you're either targeting a chef-managed unit (in \/etc), in which case you can neutralize the unit by deleting it (or not creating it in the first place), or you are targeting a vendor-managed, package-provided unit (\/lib), in which case you can neutralize it with systemd_units mask action.\r\n\r\nedit to add: mixing user-managed and vendor-managed unit files in \/lib is a Bad Idea(TM), and the whole reason multiple unit search paths (with an ordered hierarchy favoring user-managed paths) exist is to avoid it.","The use case is disabling the `chef-client` service itself.  In some circumstances, I need to stop Chef from managing a server, in which case I want it to be clear that was a purposeful action.  Simply stopping the service doesn't communicate any intent, whereas masking the service not only prevents the service from being started manually or at boot, but also demonstrates the service is intentionally stopped.\r\n\r\nSee https:\/\/github.com\/chef-cookbooks\/chef-client\/issues\/615 for more details.","i see. the best (read correct) solution for this would be for the chef package to ship some systemd units (installed to \/lib\/systemd\/system) for running it as a service\/timer-triggered job, which the chef-client cookbook could then enable\/disable and use drop-ins to customize."],"labels":["Type: Enhancement","Priority: Medium","Focus: Resources"]},{"title":"linux_user: when modifying a users' homedir, tries to create it even if it exists","body":"## Description\r\n\r\nWhen `linux_user` modifies a user to set it's homedir, if that homedir exists, it tries to create it, fails, and fails the run.\r\n\r\nIt looks like this is from passing -m always\r\n\r\n## Chef Version\r\n14.13.11\r\n\r\n## Platform Version\r\nUbuntu 18.04\r\n\r\n## Replication Case\r\nsetup a user. change it's homedir to something that exists.\r\n\r\n## Client Output\r\n```\r\n---- Begin output of [\"usermod\", \"-d\", \"\/var\/lib\/openvpn\/chroot\", \"-m\", \"nm-openvpn\"]\r\n ----\r\nSTDOUT: \r\nSTDERR: usermod: directory \/var\/lib\/openvpn\/chroot exists\r\n---- End output of [\"usermod\", \"-d\", \"\/var\/lib\/openvpn\/chroot\", \"-m\", \"nm-openvpn\"] -\r\n---\r\nRan [\"usermod\", \"-d\", \"\/var\/lib\/openvpn\/chroot\", \"-m\", \"nm-openvpn\"] returned 12\r\n```\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":["Based on what I know about the \"usermod\" command, that message is purely informational and should not be evaluating the \"<x> directory already exists\" message as an error. The manpage of usermod specifically addresses what happens if the passed \"-d\" directory already exists: https:\/\/linux.die.net\/man\/8\/usermod \r\n\r\nChef is not actually attempting to re-create the directory, it is simply reading the resulting message as an error when the directory already exists. \r\n\r\n```\r\n[root@dev ~]# useradd test_user\r\n[root@dev ~]# mkdir \/home\/test_user\r\nmkdir: cannot create directory \u2018\/home\/test_user\u2019: File exists\r\n[root@dev ~]# mkdir \/home\/new_test_user_dir\r\n[root@dev ~]# usermod -d \/home\/new_test_user_dir -m test_user\r\nusermod: directory \/home\/new_test_user_dir exists\r\n[root@dev ~]# echo $?\r\n12\r\n```","Yeah, it's def `usermod`. But the question is can we handle this better. The man page doesn't list the exit codes, but if 12 is unique to this, then we could set the allowed exit codes to `[0,12]`.","Yeah I agree. I haven't actively contributed to this project before, but I'll take a crack at it. ","For reference, the entry reference in usermod that corresponds to code 12: https:\/\/github.com\/shadow-maint\/shadow\/blob\/b49712ed328ded0cd8161542ca13cf5d4cf55e5f\/src\/usermod.c#L92\r\n\r\n\"\/* unable to complete home dir move *\/\"","Created branch on my fork\r\nhttps:\/\/github.com\/skippyj\/chef\/commit\/768d0f18a091622902e7eefcb6b2f68bc17d3145"],"labels":["Type: Bug","Priority: Low","Focus: Resources"]},{"title":"knife ssl check mismatched cert error message is not helpful","body":"I burned a ton of time after hitting this one. It seems like a common getting started error with Chef that we should really handle better. If you spin up a node in EC2 it ends up with the cert being signed by the internal hostname and you can't use that self signed cert with knife. The solution it to update the API URL in the server config and reconfigure, but good luck finding anything online to tell you that. We should expand this error message to point to some sort of help documentation otherwise users are going to just drop off here after they can't get the server and knife to talk w\/o turning off SSL verification.\r\n\r\n```$knife ssl check\r\nConnecting to host 34.213.52.123:443\r\nERROR: The SSL cert is signed by a trusted authority but is not valid for the given hostname\r\nERROR: You are attempting to connect to:   '34.213.52.1233'\r\nERROR: The server's certificate belongs to 'ip-172-31-25-123.us-west-2.compute.internal'```","comments":[],"labels":["Aspect: UX","Focus: knife","documentation"]},{"title":"knife bootstrap failed with ssh_agent_signing enabled in config.rb","body":"## Description\r\nWhen `ssh_agent_signing` is enabled in `config.rb`, `knife bootstrap` will result in authentication error. However, turning off `ssh_agent_signing` and using a RSA private key in `client_key` work totally fine.\r\n\r\n## Chef Version\r\n14.14.25 as well as 15.4.45\r\n\r\n## Platform Version\r\nDebian 10.1 Buster\r\n\r\n## Replication Case\r\nEnable `ssh_agent_signing` in `config.rb` as following, and run a validatorless bootstrap for some node.\r\n```ruby\r\nclient_key        \"#{ENV['HOME']}\/.chef\/my-public-key.pem\"\r\nssh_agent_signing true\r\n```\r\n\r\n## Client Output\r\n```\r\n$ knife bootstrap 172.18.248.35 -N chef-test-1 -U root -r 'recipe[chef-client]' -V\r\nConnecting to 172.18.248.35\r\nThe authenticity of host '172.18.248.35 ()' can't be established.\r\nfingerprint is SHA256:hHtoY5Qa0mo+0W+6BBPH+OAgOJ+M0Xw\/19GwCwr2eIE.\r\n\r\nAre you sure you want to continue connecting\r\n? (Y\/N) y\r\nConnecting to 172.18.248.35\r\nCreating new client for chef-test-1\r\nCreating new node for chef-test-1\r\nERROR: Mixlib::Authentication::AuthenticationError: Unable to sign request with ssh-agent. Make sure your key is loaded with ssh-add: Net::SSH::Authentication::AgentError agent could not sign data with requested identity)\r\n```\r\n\r\n## Bug Trace\r\nThis bugs happens in `Chef::Knife::Bootstrap::ClientBuilder`. When bootstrapping a new node, a new client key is created and assigned to its rest API object.\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/566c08e697b1aef312def2150a59c8c651edb982\/lib\/chef\/knife\/bootstrap\/client_builder.rb#L196-L198\r\n\r\nSince the client key is newly generated with private part, this `ServerAPI` object should not use SSH agent to sign its request. However there is no way to tell `ServerAPI` not to enable SSH agent signing during initialization. It always accepts the configured value.\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/566c08e697b1aef312def2150a59c8c651edb982\/lib\/chef\/server_api.rb#L32-L41","comments":["Hey @shanyungyang thanks for reporting the issue.\r\n\r\nWe have added ssh-agent support from chef-14.2+ onwards.\r\n\r\nCould you please go through the blog https:\/\/discourse.chef.io\/t\/chef-client-14-2-0-released\/13160 if you missing something?\r\n","@vsingh-msys the problem here is that validatorless bootstrapping is being used and the generated client is the one that will be sent to the remote host.  It has just been created on the client and we don't publish that into the ssh-agent.  It gets used, however, by the validatorless bootstrapping to setup the node via that Chef::ServerAPI object.  That one particular ServerAPI object needs to never do ssh-agent signing.","Hi @vsingh-msys \r\n\r\nYes I think my ssh-agent setup is correct, since every knife sub-command works fine except bootstrap.","Got it :+1:  thanks!"],"labels":["Priority: Medium","Focus: knife bootstrap"]},{"title":"knife cookbook upload and probably knife upload cookbook do not validate presence of metadata.json\/metadata.rb or validate important fields exist","body":"The way knife cookbook upload\/upload cookbooks should behave is:\r\n\r\n1.  use the metadata.json if present\r\n2.  use the metadata.rb if present (generate the metadata.json)\r\n3.  raise if none of them are present\r\n4.  validate the name field was parsed from the metadata (throw if not)\r\n5.  validate the version field was parsed from the metadata (throw if not)\r\n\r\nright now a cookbook without any metadata can be uploaded to a chef-zero server and will get a name of `null` and a version of `\"0.0.0\"`.  the chef-server fails validation on the metadata.name being `null`, but we should catch that client-side.","comments":[],"labels":["Type: Bug","Priority: Medium","Focus: knife"]},{"title":"Git resource revision property cannot be commit revision","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nGit resource fails to clone if a commit is specified as the `revision` property. \r\n\r\n## Chef Version\r\n15.3.14\r\n\r\n## Platform Version\r\nUbuntu 16.04\r\n\r\n## Replication Case\r\n1. Create recipe with the following resource, with a commit (and **not** a tag\/branch) specified as the revision.\r\n```\r\ngit \"\/spdlog\" do\r\n    action :sync\r\n    repository \"https:\/\/github.com\/gabime\/spdlog\"\r\n    revision \"f85a086\"\r\nend\r\n```\r\n2. Run the above recipe.\r\n3. Sync with the git repository fails.\r\n\r\n## Client Output\r\n```\r\nChef::Exceptions::UnresolvableGitReference\r\n------------------------------------------\r\nUnable to parse SHA reference for 'f85a086' in repository 'https:\/\/github.com\/gabime\/spdlog'. Verify your (case-sensitive) repository URL and revision.\r\n`git ls-remote 'https:\/\/github.com\/gabime\/spdlog' 'f85a086*'` output: \r\n```","comments":["what if you use the full sha reference and not the abbreviated one?","It does not seem to work either:\r\n\r\n```\r\n\u279c git ls-remote 'https:\/\/github.com\/gabime\/spdlog' '66964161070a5c4474c7b73893821b84bd4e43fb'\r\n```","\r\nI tested the issue with latest chef version and found the recipe is running successfully with full sha reference (40 characters long git revision id). Please refer to the screenshot attached for reference.\r\n\r\n![spdlog_recipe](https:\/\/user-images.githubusercontent.com\/83069519\/130012856-e4c5561e-08ac-4f5d-9cd4-1580948effda.png)\r\n\r\n![spdlog_recipe_running](https:\/\/user-images.githubusercontent.com\/83069519\/130012890-a3642ad3-e47f-4dd1-b5ec-b7eb386e1b05.png)\r\n"],"labels":["Type: Bug","Focus: SCM Resources","Focus: Resources"]},{"title":"subscribes does not validate the resource spec","body":"## Description\r\nWhen missing a closing `]` at a subscription, the subscription will be silently ignored. While notifies checks the syntax and raises an error.\r\n\r\n## Chef Version\r\nchef-client 12.22.5 but also in `master` not fixed\r\n\r\n## Platform Version\r\nUbuntu 16.04\r\n\r\n## Replication Case\r\n```ruby\r\n# ensure we always get a changed resource\r\nfile '\/tmp\/blubb' do\r\n  action :delete\r\nend\r\n\r\nfile '\/tmp\/blubb' do\r\n  action :create\r\nend\r\n\r\n# subcribing resource\r\nfile '\/tmp\/mark' do\r\n  action :nothing\r\n  subscribes :create, 'file[\/tmp\/blubb', :immediately\r\nend\r\n```\r\n\r\n## Client Output\r\n```\r\nRecipe: (chef-apply cookbook)::(chef-apply recipe)\r\n  * file[\/tmp\/blubb] action delete (up to date)\r\n  * file[\/tmp\/blubb] action create\r\n    - create new file \/tmp\/blubb\r\n  * file[\/tmp\/mark] action nothing (skipped due to action :nothing)\r\n```\r\n`\/tmp\/mark` is not created and there is no error raised.\r\n","comments":["Think this is a dup, although I couldn't turn it up with a quick search."],"labels":["Type: Enhancement","Priority: Low"]},{"title":"Resource `git` actions `checkout` and `sync` abend in a Dokken environment: no \/dev\/tty","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\n<!--- Briefly describe the issue -->\r\nResource `git` actions `checkout` and `sync` abend in a Dokken environment: no \/dev\/tty\r\n \r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n```\r\nChef Development Kit Version: 3.11.3\r\nchef-client version: 14.13.11\r\ndelivery version: master (9d07501a3b347cc687c902319d23dc32dd5fa621)\r\nberks version: 7.0.8\r\nkitchen version: 1.25.0\r\ninspec version: 3.9.3\r\n```\r\n## Platform Version\r\n<!--- Tell us which operating system distribution and version chef-client is running on. -->\r\nUbuntu 18.04\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\nWhen Dokken testing the git resource as follows:\r\n\r\n```\r\n33:   git \"Install #{new_resource.name} plugin\" do\r\n34:     destination ::File.join(root_path, 'plugins', new_resource.name)\r\n35:     repository new_resource.git_url\r\n36:     reference new_resource.git_ref\r\n37:     user new_resource.user if new_resource.user\r\n38:     action :checkout\r\n39:   end\r\n40: end\r\n```\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\n\r\nI encounter an issue as described on [SO](https:\/\/stackoverflow.com\/a\/57458443\/152860).\r\n\r\nThe error is:\r\n\r\n```\r\n* git[Install julia-build plugin] action checkout\r\n\r\n================================================================================\r\nError executing action `checkout` on resource 'git[Install julia-build plugin]'\r\n================================================================================\r\n\r\nMixlib::ShellOut::ShellCommandFailed\r\n------------------------------------\r\nExpected process to exit with [0], but received '128'\r\n---- Begin output of git ls-remote \"https:\/\/github.com\/jlenv\/jlenv-build.git\" \"master*\" ----\r\nSTDOUT: \r\nSTDERR: fatal: could not read Username for 'https:\/\/github.com': No such device or address\r\n---- End output of git ls-remote \"https:\/\/github.com\/jlenv\/jlenv-build.git\" \"master*\" ----\r\nRan git ls-remote \"https:\/\/github.com\/jlenv\/jlenv-build.git\" \"master*\" returned 128\r\n\r\n```\r\nI was able to test and confirm that in the Dokken environment:\r\n```\r\necho ahoj > \/dev\/tty\r\nbash: \/dev\/tty: No such device or address\r\n```\r\n\r\nIt appears the issue is [here](https:\/\/github.com\/chef\/chef\/blob\/7558c414030d082194d0d2b5f74279ce151517e9\/lib\/chef\/provider\/git.rb#L298)?\r\n\r\nThis appears to be confirmed by the fact that the git unit specs [require (stub) `tty?` to return true](https:\/\/github.com\/chef\/chef\/blob\/master\/spec\/unit\/provider\/git_spec.rb#L23).\r\nIf this is not going to be fixed, then at least the resource should abend with an error message that a tty is required.\r\n\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\nAs Above.\r\n","comments":["I believe the correct way to accomplish this is `git show-ref --quiet --verify <ref> >\/dev\/null 2>&1`, redirecting stderr and stdout to `\/dev\/null` and returning the result depending on the exit code?\r\n\r\nBefore I sink more of my time. Would you accept a pull request implementing this approach?\r\n","yeah although `2>&1` is a bash-ism and it needs to work if the shell is tcsh, and probably needs to work on windows as well.\r\n\r\nif there's a way to pass the moral equivalent of ssh's `-n` argument to git that would be better rather than trying to convince mixlib-shellout to wire up \/dev\/null in a shel-portable-fashion and do <something that i couldn't guess> on windows, which is probably going to be a lot harder.","@lamont-granquist thanks for looking at this.\r\nAgreed.  I've been thinking about this a little more.  \r\n\r\nThe absence of a TTY is the default in many of my chef-automated use cases i.e. cloud server setup's, containers, etc.  \r\nFrom my perspective (and reading around), issues such as this one are circumvented by:\r\n\r\n1. using vagrant, \r\n1. passing docker a `--device` or \r\n1. avoiding such stdout\/stderror parsing recipes.  \r\n\r\nIn my case I'm making more use of dokken, and here I can't sidestep the git resource.\r\n\r\nRather than piping to stdout and stderr it seems the more generic approach is to send the data to files and read it from there. \r\n\r\n**Question:** Is there an example of the best-practice Chef way to write\/read temp files in a recipe?\r\n**Answer:** Use the `live_stdout`\/`live_stderr` in mixlib's `shell_out(...)` as `StringIO.new` instances.\r\n\r\nIn this case the process would be `git show-ref --quiet --verify` to get the result\/return code.  \r\nIf the return indicates verified then read in the output file generated.\r\n\r\nThis (no tty) seems to be an issue more widespread than the `git` resource?"],"labels":["Type: Bug","Aspect: Stability","Focus: SCM Resources","Focus: Resources"]},{"title":"Ohai resource: reloading a specific plugin which is marked as \"optional\" is ignored","body":"## Description\r\nRunning the example from https:\/\/docs.chef.io\/resource_ohai.html fails with chef-client >= 14.\r\n\r\n## Chef Version\r\nTested with 15.2.20 and 14.13.11\r\n\r\n## Platform Version\r\nUbuntu 18.04\r\n\r\n## Replication Case\r\nCreate a cookbook with a recipe containing the example code from the ohai resource. On the first run, when the new user is actually created, the ruby code block fails. With 13.12.14 the code runs without error.\r\n\r\n## Client Output\r\n\r\n\r\n```\r\n  * ruby_block[just an example] action run[2019-08-22T10:41:48+00:00] INFO: Processing ruby_block[just an example] action run (xion_prometheus::test line 13)\r\n\r\n\r\n    ================================================================================\r\n    Error executing action `run` on resource 'ruby_block[just an example]'\r\n    ================================================================================\r\n\r\n    NoMethodError\r\n    -------------\r\n    undefined method `[]' for nil:NilClass\r\n\r\n    Cookbook Trace:\r\n    ---------------\r\n    \/var\/chef\/cache\/cookbooks\/tests\/recipes\/test.rb:16:in `block (2 levels) in from_file'\r\n\r\n    Resource Declaration:\r\n    ---------------------\r\n    # In \/var\/chef\/cache\/cookbooks\/tests\/recipes\/test.rb\r\n\r\n     13: ruby_block 'just an example' do\r\n     14:   block do                                                                                                                                                                \r\n     15:     # These variables will now have the new values\r\n     16:     puts node['etc']['passwd']['daemonuser']['uid']                                                                                                 \r\n     17:     puts node['etc']['passwd']['daemonuser']['gid']\r\n     18:   end\r\n     19: end                                                                        \r\n                                                                          \r\n    Compiled Resource:                                                              \r\n    ------------------\r\n    # Declared in \/var\/chef\/cache\/cookbooks\/tests\/recipes\/test.rb:13:in `from_file'\r\n                 \r\n    ruby_block(\"just an example\") do      \r\n      action [:run]\r\n      default_guard_interpreter :default\r\n      declared_type :ruby_block\r\n      cookbook_name \"tests\"                                                              \r\n      recipe_name \"test\"\r\n      block #<Proc:0x0000000004c08448@\/var\/chef\/cache\/cookbooks\/tests\/recipes\/test.rb:14>\r\n      block_name \"just an example\"\r\n    end                                                           \r\n\r\n    System Info:                        \r\n    ------------\r\n    chef_version=15.2.20                                   \r\n    platform=ubuntu                                                                                                                                          \r\n    platform_version=18.04                                  \r\n    ruby=ruby 2.6.3p62 (2019-04-16 revision 67580) [x86_64-linux]\r\n    program_name=\/usr\/bin\/chef-client                                               \r\n    executable=\/opt\/chef\/bin\/chef-client\r\n```\r\n","comments":["That looks like a glibc caching issue, this is probably not fixable without reimplementing Etc.getpwnam to bypass glibc (and thereby NSS, NIS, LDAP, etc).  You can look at your NSS settings and if you're using nscd or not and try to tweak things to remove the caching, but this is probably a dup of #3552 or #3100 or related issues like #2894 or #4829.","@lamont-granquist all those other issues are pretty old and don't look related to me. Note that the code works fine with chef-client < 14, simply by downgrading the chef pkg on the same machine, so it certainly looks to be fixable within chef-client code. FWIW `nsswitch.conf` lists `compat systemd` for both passwd and group.\r\n\r\nFinally, even if this turned out to be an unavoidable issue in what I think is a pretty common environment, IMO that should be noted in the corresponding documentation.","More debugging shows that the reload does work when I remove the `plugin` attribute from the ohai resource, triggering a complete reload.\r\n\r\nAfter reading the code, it seems that this is caused by this patch https:\/\/github.com\/chef\/ohai\/commit\/48c29a3a729f43334a890142dbba9584791bc99e , which marks the passwd plugin as optional and thus not triggered by the reload action, which according to the debug output is executed with `:run_all_plugins=>false`. I'm not sure how plugins got selected as optionial, maybe just switch passwd back to non-optional? Or change the ohai resource in chef to set `:run_all_plugins=>true`?","The passwd plugin is optional for good reasons, it walks LDAP\/AD on systems that have that setup and causes horrible performance issues.\r\n\r\nIt sounds like the bug here is just that when you pass an optional plugin as the plugin to run in the ohai resource that it doesn't run that plugin, even though you've specified it.\r\n\r\nAnd we wouldn't want to set run_all_plugins to true because if someone does not have the passwd plugin enabled because of AD\/LDAP then a simple reload to the ohai resource should never load those plugins which are optional\/disabled.  That would blow up all kinds of systems to just always force that to true in the resource.\r\n\r\nI suppose we could also raise if the plugin is currently disabled - the theory being that if someone has that disabled then you don't want to enable that plugin without some kind of positive action on the part of the user."],"labels":["Type: Bug","Focus: Resources"]},{"title":"We need a better REST object model","body":"We need a base class \/ base model for all REST objects (Chef::Role, Chef::Environment, Chef::Node those REST objects)\r\n\r\nWe need consistent validation at the very least:  #6803 #5086 #2731\r\n\r\nWe should also be able to have a more DSL-ey way to define the different serialization formats and have a consistent API around all the to_json\/to_hash\/to_whatever things.","comments":[],"labels":["Type: Enhancement"]},{"title":"`chocolatey_package` timeout should default to the Chocolatey `commandExecutionTimeoutSeconds` config setting","body":"### Describe the Enhancement:\r\nThe `chocolatey_package` resource does not honor the `commandExecutionTimeoutSeconds` choco config setting, instead relying on a Chef-internal 900 second timeout by default.\r\n\r\n### Describe the Need:\r\nEspecially because we can set the client options with the `chocolatey_config` resource, including the `commandExecutionTimeoutSeconds` setting, it becomes confusing when trying to troubleshoot why your package install suddenly bombs out at 900 seconds when the default choco timeout is 2700 seconds, and recommended to be 14400 for enterprises.\r\n\r\n### Current Alternative\r\nSet `timeout` on all `chocolatey_package` resources. This seems redundant though when we have set a client default.\r\n\r\n### Can We Help You Implement This?:\r\nIf this is met positively I would love to take a crack at implementing this.\r\n","comments":["yeah you can give that a shot, the way it picks up the timeout value from shell_out is a bit magical, and you need to not affect any global behavior and keep the changes isolated to the chocolatey package resource."],"labels":["Priority: Low","Platform: Windows","Triage: Feature Request","Focus: Resources"]},{"title":"yum_repository is not importing gpg keys as stated in the documentation","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nIn the documentation, it is stated that for the yum_repository provider gpgkey option, that \"If this option is set, Yum will automatically import the key from the specified URL.\"\r\n\r\nInvestigation shows that this is not the case and I cannot find evidence that Chef is downloading GPG keys in the source code.\r\n\r\n## Chef Version\r\nChef: 14.13.11\r\n\r\n## Platform Version\r\nRedhat 7.6\r\n\r\n## Replication Case\r\nMinimal Chef recipe:\r\n\r\n```\r\nyum_repository 'epel' do\r\n  action :create\r\n  description 'Fedora EPEL Repository'\r\n  metalink 'https:\/\/mirrors.fedoraproject.org\/metalink?repo=epel-7&arch=$basearch'\r\n  failovermethod 'priority'\r\n  gpgcheck true\r\n  gpgkey 'http:\/\/download.fedoraproject.org\/pub\/epel\/RPM-GPG-KEY-EPEL'\r\n  enabled true\r\nend\r\n```\r\n\r\nChecking the imported rpm keys afterwards will not show the gpg keys added to the system.\r\n\r\n```\r\n[vagrant@default-centos-7 ~]$ rpm -q gpg-pubkey --qf '%{NAME}-%{VERSION}-%{RELEASE}\\t%{SUMMARY}\\n'\r\ngpg-pubkey-f4a80eb5-53a7ff4b    gpg(CentOS-7 Key (CentOS 7 Official Signing Key) <security@centos.org>)\r\n```\r\n\r\nReproduced in CentOS on Vagrant, and in a 'real' server running RHEL. Both version 7.6.\r\n","comments":["Seems like that property was never implemented at all"],"labels":["Priority: Medium","Platform: RHEL-like","Focus: Resources"]},{"title":"Chef::Provider::Service::Systemd provider has define_resource_requirements check that requires load_current_resource and therefore fails in why-run mode","body":"CHEF CLIENT BUG:  Service resource giving invalid message in why-run mode and its not able to determine the status of the service:\r\n      *** Service status not available. Assuming a prior action would have installed the service.\r\n      * Assuming status of not running.** \r\n____________________________________________________________________________________________\r\n## Description\r\n\r\nIn default recipe, we have called the service resource with attributes as shown below :\r\nservice 'crond' do\r\n    provider ::Chef::Provider::Service::Systemd if RHEL_7_OR_HIGHER\r\n    action [:start, :enable]\r\nend\r\n  \r\n  where, RHEL_7_OR_HIGHER is boolean value. RHEL_7_OR_HIGHER will be true if RHEL version is 7 or higher else it's false.\r\n  \r\n  When executing policy in why-run mode, facing the below issue :\r\n  \r\n  For action start & enable for crod service, we are getting warning\/message as below and its not able to determine the service status :\r\n    \" * Service status not available. Assuming a prior action would have installed the service.\r\n      * Assuming status of not running. \" \r\n  in both the cases.\r\n  i.e 1. when crond service is already started or enabled on node(This means node is already in 'complaint\/up-to-date' state)\r\n      2. when service is not started or enabled on node(This means node is currently in 'non-complaint' state, & respective deviation is getting generated) \r\n\t  \r\n  ** The service resource is not able to find the status of the 'currently sunning service', and showing the above failure message?**\r\n  \t  \r\n\r\n____________________________________________________________________________________________\r\n## Chef Version\r\nChef-client: 12.12.13  \r\n____________________________________________________________________________________________\r\n## Platform Version\r\nRed Hat Enterprise Linux Server release 7.5 (Maipo)\r\n\r\n\r\n____________________________________________________________________________________________\r\n## Replication Case\r\nreplicate your problem by executing below resource \r\n\r\n  service 'crond' do\r\n    provider ::Chef::Provider::Service::Systemd if RHEL_7_OR_HIGHER\r\n    action [:start, :enable]\r\n  end\r\n\r\n____________________________________________________________________________________________\r\n## Client Output\r\n<!--- the chef-client output -->\r\n\r\nService status on the system: \r\n[root@test1234]# systemctl status crond\r\n\u25cf crond.service - Command Scheduler\r\n   Loaded: loaded (\/usr\/lib\/systemd\/system\/crond.service; enabled; vendor preset: enabled)\r\n   Active: active (running) since Wed 2019-05-15 11:59:24 IST; 23h ago\r\n Main PID: 29870 (crond)\r\n   CGroup: \/system.slice\/crond.service\r\n           \u2514\u250029870 \/usr\/sbin\/crond -n\r\n\r\nMay 15 11:59:24 test123 systemd[1]: Started Command Scheduler.\r\nMay 15 11:59:24 test123 systemd[1]: Starting Command Scheduler...\r\nMay 15 11:59:24 test123 crond[29870]: (CRON) INFO (RANDOM_DELAY will be scaled with factor 55% if used.)\r\nMay 15 11:59:24 test123 crond[29870]: (root) BAD FILE MODE (\/etc\/cron.d\/0hourly)\r\nMay 15 11:59:24 test123 crond[29870]: (CRON) INFO (running with inotify support)\r\nMay 15 11:59:24 test123 crond[29870]: (CRON) INFO (@reboot jobs will be run at computer's startup.)\r\n\r\n\r\n\r\n- In Why-run mode: getting the below deviation\r\n\r\n  * service[crond] action start[2019-05-13T11:19:31+05:30] INFO: Processing service[crond] action start\r\n    * Service status not available. Assuming a prior action would have installed the service.\r\n    * Assuming status of not running.\r\n     (up to date)\r\n  \r\n  * service[crond] action enable[2019-05-13T11:19:31+05:30] INFO: Processing service[crond] action enable \r\n    * Service status not available. Assuming a prior action would have installed the service.\r\n    * Assuming status of not running.\r\n     (up to date)\r\n\r\nEven if the service status is active (running) i.e. '(up to date)'. Why we getting the below 2 warning\/deviation messages, what is the purpose of adding it into the why-run only. \r\n    * Service status not available. Assuming a prior action would have installed the service.\r\n    * Assuming status of not running.\r\n____________________________________________________________________________________________\r\n## Stacktrace\r\nWe are refering the below files, debugged the below files stacktrace output, got below mentioned logs by debugging below files:\r\n\r\n\/chef-12.12.13\/lib\/chef\/provider\/service\/simple.rb ( We are getting the message from this file in method \u2018shared_resource_requirements\u2019 in why-run mode, not getting the purpose of adding this message )\r\n\r\n\/chef-12.12.13\/lib\/chef\/provider\/service.rb\r\n\/chef-12.12.13\/lib\/chef\/resource\/service.rb\r\n\/chef-12.12.13\/lib\/chef\/provider\/service\/systemd.rb\r\n____________________________________________________________________________________________\r\nI added some print statements in above file for debugging, Logs are as below\r\n___________________________________________________________________________________________\r\n\r\n  * yum_package[cronie] action install\"CMD status :--- pid 16047 exit 0\"\r\n\"define_resource_requirements is getting calling from \/chef\/provider.rb\"\r\n (up to date)\r\n  * service[crond] action start\"\"\r\n\"in \/chef\/provider\/service\/systemd.rb-- systemd current resource: \"\r\n\"is_active method in \/chef\/provider\/service\/systemd.rb\"\r\n\"options: {}\"\r\n\"args: --system\"\r\n\"\/usr\/bin\/systemctl --system is-active crond --quiet\"\r\n\"CMD status :--- pid 16052 exit 0\"\r\n\"getting current resource status in \/chef\/provider\/service\/systemd.rb\"\r\ntrue\r\n\"CMD status :--- pid 16055 exit 0\"\r\n\"CMD status :--- pid 16058 exit 0\"\r\n\"here in load_current_resource in \/chef\/provider\/service\/systemd.rb\"\r\n<service[crond] @name: \"crond\" @noop: nil @before: nil @params: {} @provider: nil @allowed_actions: [:nothing, :enable, :disable, :start, :stop, :restart, :reload, :mask, :unmask] @action: [:nothing] @updated: false @updated_by_last_action: false @supports: {:restart=>nil, :reload=>nil, :status=>nil} @ignore_failure: false @retries: 0 @retry_delay: 2 @source_line: nil @guard_interpreter: nil @default_guard_interpreter: :default @elapsed_time: 0 @sensitive: false @service_name: \"crond\" @enabled: true @running: true @masked: false @parameters: nil @pattern: \"crond\" @start_command: nil @stop_command: nil @status_command: nil @restart_command: nil @reload_command: nil @init_command: nil @priority: nil @timeout: nil @run_levels: nil @user: nil>\r\n\"define_resource_requirements is getting calling from \/chef\/provider.rb\"\r\n\"-----------------in shared resource requirements \/chef\/provider\/service.rb-------------\"\r\n\"--------\"\r\n\"I am printing the message from in \/chef\/provider\/service\/simple.rb\"\r\n\" define_resource_requirements in \/chef\/provider\/service\/systemd.rb :----- #<Chef::Mixin::WhyRun::ResourceRequirements:0x00564f43ac1438>\"\r\n\"--#<Chef::Mixin::WhyRun::ResourceRequirements::Assertion:0x00564f43aab7a0>--status_check_success in \/chef\/provider\/service\/systemd.rb-----------------------true-----------------\"\r\n\"Status command in \/chef\/provider\/service\/systemd.rb: \"\r\nnil\r\n\"Failed to determine status of service[crond], using command .\"\r\n\r\n    * Service status not available. Assuming a prior action would have installed the service.\r\n    * Assuming status of not running.\"______ in action_start \/chef\/provider\/service.rb _________\"\r\n\"load_new_resource_state: \"\r\n\"--- in new resource state --- \\n before\"\r\nnil\r\n\"after\"\r\ntrue\r\n\r\n     (up to date)\r\n  * service[crond] action enable\"\"\r\n\"in \/chef\/provider\/service\/systemd.rb-- systemd current resource: \"\r\n\"is_active method in \/chef\/provider\/service\/systemd.rb\"\r\n\"options: {}\"\r\n\"args: --system\"\r\n\"\/usr\/bin\/systemctl --system is-active crond --quiet\"\r\n\"CMD status :--- pid 16061 exit 0\"\r\n\"getting current resource status in \/chef\/provider\/service\/systemd.rb\"\r\ntrue\r\n\"CMD status :--- pid 16064 exit 0\"\r\n\"CMD status :--- pid 16067 exit 0\"\r\n\"here in load_current_resource in \/chef\/provider\/service\/systemd.rb\"\r\n<service[crond] @name: \"crond\" @noop: nil @before: nil @params: {} @provider: nil @allowed_actions: [:nothing, :enable, :disable, :start, :stop, :restart, :reload, :mask, :unmask] @action: [:nothing] @updated: false @updated_by_last_action: false @supports: {:restart=>nil, :reload=>nil, :status=>nil} @ignore_failure: false @retries: 0 @retry_delay: 2 @source_line: nil @guard_interpreter: nil @default_guard_interpreter: :default @elapsed_time: 0 @sensitive: false @service_name: \"crond\" @enabled: true @running: true @masked: false @parameters: nil @pattern: \"crond\" @start_command: nil @stop_command: nil @status_command: nil @restart_command: nil @reload_command: nil @init_command: nil @priority: nil @timeout: nil @run_levels: nil @user: nil>\r\n\"define_resource_requirements is getting calling from \/chef\/provider.rb\"\r\n\"-----------------in shared resource requirements \/chef\/provider\/service.rb-------------\"\r\n\"--------\"\r\n\"I am printing the message from in \/chef\/provider\/service\/simple.rb\"\r\n\" define_resource_requirements in \/chef\/provider\/service\/systemd.rb :----- #<Chef::Mixin::WhyRun::ResourceRequirements:0x00564f3ef12730>\"\r\n\"--#<Chef::Mixin::WhyRun::ResourceRequirements::Assertion:0x00564f3ef1c0a0>--status_check_success in \/chef\/provider\/service\/systemd.rb-----------------------true-----------------\"\r\n\"Status command in \/chef\/provider\/service\/systemd.rb: \"\r\nnil\r\n\"Failed to determine status of service[crond], using command .\"\r\n\r\n    * Service status not available. Assuming a prior action would have installed the service.\r\n    * Assuming status of not running.\"______ in action_enable \/chef\/provider\/service.rb _________\"\r\n\"load_new_resource_state: \"\r\n\"--- in new resource state --- \\n before\"\r\ntrue\r\n\"after\"\r\ntrue\r\n\r\n     (up to date)\r\n____________________________________________________________________________________________\r\n","comments":["this line should be entirely unnecessary and may be the cause of some of the problem:\r\n\r\n```\r\n provider ::Chef::Provider::Service::Systemd if RHEL_7_OR_HIGHER\r\n```\r\n\r\nchef should be able to figure that out on its own.   and generally injecting the `provider` argument and bypassing the provider resolver is going to cause bugs. ","I get the same warning on all systems that have systemd: debian 8\/9, ubuntu 16\/18, centos 7\r\n\r\n```\r\n  * service[bind9] action enable\r\n    * Service status not available. Assuming a prior action would have installed the service.\r\n    * Assuming status of not running.\r\n     (up to date)\r\n  * service[bind9] action enable (up to date)\r\n  * service[bind9] action start\r\n    * Service status not available. Assuming a prior action would have installed the service.\r\n    * Assuming status of not running.\r\n     (up to date)\r\n```\r\n```\r\nexecute 'named-checkconf' do\r\n  action :nothing\r\nend\r\n\r\nservice 'bind9' do\r\n  action [:enable, :start]\r\n  notifies :run, 'execute[named-checkconf]', :before\r\nend\r\n```\r\n\r\nUPDATE: The warning appears only if there is a notify with timer \"before\". ","Bumping this up as it is still happening under Chef 16 when using a `:before` notify to trigger a service test before a service restart.\r\n\r\nThe service action is duplicated in the Chef run and does perform the correct action after triggering this message so I guess it's just a cosmetic issue and looking at the source is relayed to using `why_run` to allow the notified resource to run 'before' the notifying resource run at a guess.","The problem is that the check here:\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/4d3b847aee1b917bb139862c623e9633d180fb31\/lib\/chef\/provider\/service\/systemd.rb#L72\r\n\r\nRelies on code in load_current_resource running which is not enabled in why-run mode:\r\n\r\nhttps:\/\/github.com\/chef\/chef\/blob\/4d3b847aee1b917bb139862c623e9633d180fb31\/lib\/chef\/provider\/service\/systemd.rb#L42\r\n\r\n"],"labels":["Priority: Low","Platform: Linux","Focus: Resources"]},{"title":"windows_service resource prints ruby warnings from win32-service gem","body":"<!--- Provide a general summary of the issue in the Title above -->\r\n\r\n# Describe the problem\r\nThis issue was very similar to https:\/\/github.com\/chef\/chef\/issues\/7335.\r\nPlease note that issues reported here was indeed different. #7335 did fix the warning message addressed in the ticket. These warning reported here in this ticket were different and required new fix(es).\r\n\r\n## Software Version\r\nchef-client 14.12.9\r\n\r\n## Replication Case\r\nUse windows_service resource to invoke\/start WinQuic service\r\n\r\n## Stacktrace\r\n<!--- If there are related error messages or stacktraces, please include the output in the details section and code block below. Feel free to copy and paste the details section for multiple output examples. Or if there is already a Gist with the output, include a link to it. -->\r\n<details><Warning messages> <!-- Please see the following warning messages --> <\/summary>\r\n\r\n```\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/win32-service-2.1.4\/lib\/win32\/service.rb:1086:in 'rescue in block in services' : WARNING: Failed to retrieve description for the WinQuic service. (StructuredWarnings::StandardWarning)\r\n```\r\n\r\n```\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/win32-service-2.1.4\/lib\/win32\/service.rb:1146:in 'rescue in block in services' : WARNING: Unable to retrieve failure actions for the WinQuic service (StructuredWarnings::StandardWarning)\r\n```\r\n<\/details>\r\n\r\n## Possible Solution\r\n<!--- If you already have ideas about how to solve the issue, add them here. -->\r\n","comments":["\ud83d\udc4d  Windows Server 2019","I'm also seeing this on a Windows Server 2019 Datacenter box running Chef 14.7.17.\r\n\r\n```\r\n* windows_service[FOO] action enable[2019-11-14T23:00:49+00:00] INFO: Processing windows_service[FOO] action enable (C:\/chef\/cache\/cookbooks\/FOO\/resources\/FOO.rb line 190)\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/win32-service-1.0.1\/lib\/win32\/service.rb:1086:in `rescue in block in services' : WARNING: Failed to retrieve description for the WinQuic service. (StructuredWarnings::StandardWarning)C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/win32-service-1.0.1\/lib\/win32\/service.rb:1099:in `rescue in block in services' : WARNING: Unable to get delayed auto start information for the WinQuic service (StructuredWarnings::StandardWarning)C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/win32-service-1.0.1\/lib\/win32\/service.rb:1157:in `rescue in block in services' : WARNING: Unable to retrieve failure actions for the WinQuic service (StructuredWarnings::StandardWarning) (up to date)\r\n```","Got the same issue on Windows 2019 Datacenter using Chef Client 15.3.14\r\n\/win32-service-2.1.4\/lib\/win32\/service.rb:1146:in `rescue in block in services': WARNING: Unable to retrieve failure actions for the WinQuic service (StructuredWarnings::StandardWarning)","When running a kitchen converge on local VMware-hosted Windows 2016 server i got this error:\r\n```\r\n$$$$$$ Exception calling \"Read\" with \"3\" argument(s): \"Offset and length were out of bounds for the array or count is greater than the number of elements from index to the end of the source collection.\"\r\nAt line:100 char:11\r\n$$$$$$ +       if ($fs.Read($bytes, 0, $fs.Length) -gt 0) {\r\n$$$$$$ +           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException\r\n    + FullyQualifiedErrorId : ArgumentException\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/win32-service-2.1.4\/lib\/win32\/service.rb:1086:in `rescue in block in services' : WARNING: Failed to retrieve description for the CDPUserSvc_2a371 service. (StructuredWarnings::StandardWarning)C:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/win32-service-2.1.4\/lib\/win32\/service.rb:1146:in `rescue in block in services' : WARNING: Unable to retrieve failure actions for the CDPUserSvc_2a371 service (StructuredWarnings::StandardWarning)\r\n\r\n```\r\n\r\nI am on a Mac using\r\n**macos** Big Sur 11.2.3. and **Chef Workstation** version: 21.2.303, **Test kitchen** version: 2.10.0\r\n\r\nKitchen converge did not always fail with that error, but I noticed VMware Tools needed updating so ran that, few reboots later and then kc worked without an error at all. Time will tell.","well nothing is being done nor written. is there a way to disable those warnings just? "],"labels":["Platform: Windows","Focus: Resources","Focus: Desktop"]},{"title":"Update bootstrap to use mixlib-install","body":"### Current Process\r\n\r\n1) Bootstrap template (chef-full or windows-chef-client-msi.erb)\r\n   contains platform-specific methods for downloading the chef client.\r\n   It is rendered locally and uploaded to the target host.\r\n2) The rendered script is run on the target host:\r\n  a) check for any installed version of Chef.\r\n  b) If missing, download chef-client and install it.\r\n  c) run initial converge.\r\n\r\n### New Process\r\n\r\nWe'll move the download\/install behaviors out of the bootstrap\r\ntemplate and into the bootstrap command using mixlib-install.\r\n\r\n1) Generate the remote install command and using mixlib install:\r\n  a) `Mixlib::Install.new(options).install_command`\r\n  b) Populate mixlib-install `options` using data available from the bootstrap TrainConnector; they are documented in the\r\n     [mixlib-install](https:\/\/github.com\/chef\/mixlib-install) README.md.\r\n  c) Ensure that `install_strategy` is set to `once` to preserve the existing behavior\r\n     of not installing Chef Infra Client if it is already installed.\r\n  d) Proxy configuration must be supplied to ensure the generated script follows proxy rules. These are set via `install_command_options`.\r\n2) Prior to generating the template, use `connection.upload_file_content` to upload\r\n   the install command as a script\r\n3) Notify the human that we're installing chef, then run the uploaded script\r\n4) Render bootstrap template, upload and execute as today.\r\n\r\nThe bootstrap templates will have installation-related behaviors\r\nremoved from them.\r\n\r\n### New CLI Options\r\n* `--bootstrap-[no-]install` - skip the installation step. Defaults to true. When false, skip the install. The corresponding key `bootstrap_install` will be supported in config as well so that it can be defaulted in user settings. \r\n* `--bootstrap-metadata-url` - this probably needs a better name. If  present this is provided as an override_url to `mixlib-cli` to ensure  that the customer's preferred omnitruck metadata API URL is used.  \r\n\r\nThe corresponding config keys will be supported in config (knife.rb)\r\n\r\n## Downstream Impact\r\n\r\n* customer custom bootstrap templates - these will already have their own logic for installing.  `--bootstrap-no-install` is intended to mitigate this \r\n* plugins that override or extend bootstrap behavior - this is less clear.  None of the public API is modified, but this adds new behavior that occurs when  Bootstrap#run is invoked.  ","comments":["We need to consider users that have forked the chef-full bootstrap template to run custom commands as part of the install process. Is it enough if bootstrap had pre-install\/post-install hooks of some other kind, or would the change have to be in mixlib-install?"," Ideally we'd split all of stuff in bootstrap template into hookable steps, though that's beyond scope of this change. \r\n\r\nOutside of that, if someone does have a forked template using the `--bootstrap-no-install` flag would suppress the install behavior - so their existing template wouldn't be required to change. ","One thing that'll stil be a problem is usage of a custom package download URL - that means we will still have to maintain the scripts that know how to download things on unix\/windows (wget.vbs, do_download() from download.sh).  ","mixlib-install isn't compatible with the more fully-omnitruck'd method in knife bootstrap right now because of the way that mixlib-install bypasses all of the platform mapping code that was in omnitruck, which means that this is 100% definitely a breaking change (unless mixlib-install got changed)."],"labels":["Type: Enhancement","Aspect: Integration","Type: Breaking Change","Focus: knife bootstrap"]},{"title":"Windows_ad_join resource was broken for cross domain authentication","body":"## Description\r\nIf the \"domain_user\" 's domain differs from the the domain it is joining this resource will fail.  Before #7906 you could pass the domain\\user. Now the command expects user and appends the domain to the powershell command. \r\n\r\nThis is an issue for larger companies with multiple domains.\r\n\r\n## Chef Version\r\nChef_version >= 14.8.12 \r\n\r\n## Platform Version\r\nWindows\r\n\r\n## Replication Case\r\nFor domain_user pass a user \"domain\"\\user with a differing \"domain\" then the domain the machine is joining.\r\n\r\nExample\r\n```\r\n   windows_ad_join <domain_A> do\r\n    domain_password      join_pass\r\n    domain_user          domain_B\\maier\r\n    ou_path              join_oupath\r\n    reboot               :delayed\r\n    sensitive            false\r\n   end\r\n```\r\n\r\n## Client Output\r\n```\r\nFailed to join the domain <OUR_DOMAIN>: Add-Computer : Computer '<hostname>' failed to join domain '<OUR_DOMAIN>' from its \r\ncurrent workgroup 'WORKGROUP' with following error message: The user name or password is \r\nincorrect.\r\nAt line:1 char:181\r\n+ ... com\",$pswd);Add-Computer -DomainName <OUR_DOMAIN> -Cred ...\r\n+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : OperationStopped: (<hostname>:String) [Add-Computer], InvalidOpera \r\n   tionException\r\n    + FullyQualifiedErrorId : FailToJoinDomainFromWorkgroup,Microsoft.PowerShell.Commands.AddComp \r\n   uterCommand\r\n```\r\n\r\n## Stacktrace\r\n```\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.10.9-universal-mingw32\/lib\/chef\/resource\/windows_ad_join.rb:80:in `block (2 levels) in <class:WindowsAdJoin>'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.10.9-universal-mingw32\/lib\/chef\/mixin\/why_run.rb:51:in `add_action'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.10.9-universal-mingw32\/lib\/chef\/provider.rb:227:in `converge_by'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.10.9-universal-mingw32\/lib\/chef\/resource\/windows_ad_join.rb:74:in `block in <class:WindowsAdJoin>'\r\n(eval):2:in `block in action_join'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.10.9-universal-mingw32\/lib\/chef\/provider.rb:236:in `instance_eval'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.10.9-universal-mingw32\/lib\/chef\/provider.rb:236:in `compile_and_converge_action'\r\n(eval):2:in `action_join'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.10.9-universal-mingw32\/lib\/chef\/provider.rb:182:in `run_action'\r\nC:\/opscode\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.10.9-universal-mingw32\/lib\/chef\/resource.rb:578:in `run_action'\r\n```","comments":["@earlmaier Could you please check this on latest version. Looks like this issue is already addressed as part of this fix - [#9370](https:\/\/github.com\/chef\/chef\/pull\/9370), please change your recipe accordingly and let me know if you still facing the issue.\r\n","This doesn't fix the issue,  it still appending the wrong domain to the\nuser.  The user is of a higher domain the the domain the machine is being\njoined to is of a sub domain.  Example the user is part of the domain Earth\nand the machine is Part of the domain North America. (hope that helps...)\n\nThanks,\n\nEarl\n\nOn Wed, Sep 15, 2021 at 6:10 AM antima-gupta ***@***.***>\nwrote:\n\n> @earlmaier <https:\/\/github.com\/earlmaier> Could you please check this on\n> latest version. Looks like this issue is already addressed as part of this\n> fix - #9370 <https:\/\/github.com\/chef\/chef\/pull\/9370>, please change your\n> recipe accordingly and let me know if you still facing the issue.\n>\n> \u2014\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https:\/\/github.com\/chef\/chef\/issues\/8436#issuecomment-919885429>, or\n> unsubscribe\n> <https:\/\/github.com\/notifications\/unsubscribe-auth\/AAIFCWYZCSSEWI7J2NQMIH3UCBWKZANCNFSM4HJMLVZA>\n> .\n> Triage notifications on the go with GitHub Mobile for iOS\n> <https:\/\/apps.apple.com\/app\/apple-store\/id1477376905?ct=notification-email&mt=8&pt=524675>\n> or Android\n> <https:\/\/play.google.com\/store\/apps\/details?id=com.github.android&referrer=utm_campaign%3Dnotification-email%26utm_medium%3Demail%26utm_source%3Dgithub>.\n>\n>\n","@earlmaier Can you provide some detail i.e. example recipe which you tried and Stacktrace?","I will get back to you, would like to somewhere here to review the\nstacktrace to make sure all sensitive material is stripped....\n\nOn Fri, Sep 17, 2021 at 1:31 AM antima-gupta ***@***.***>\nwrote:\n\n> @earlmaier <https:\/\/github.com\/earlmaier> Can you provide some detail\n> i.e. example recipe which you tried and Stacktrace?\n>\n> \u2014\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https:\/\/github.com\/chef\/chef\/issues\/8436#issuecomment-921511449>, or\n> unsubscribe\n> <https:\/\/github.com\/notifications\/unsubscribe-auth\/AAIFCW4UAPALYWA37CH5LHLUCLHEHANCNFSM4HJMLVZA>\n> .\n> Triage notifications on the go with GitHub Mobile for iOS\n> <https:\/\/apps.apple.com\/app\/apple-store\/id1477376905?ct=notification-email&mt=8&pt=524675>\n> or Android\n> <https:\/\/play.google.com\/store\/apps\/details?id=com.github.android&referrer=utm_campaign%3Dnotification-email%26utm_medium%3Demail%26utm_source%3Dgithub>.\n>\n>\n"],"labels":["Priority: Medium","Platform: Windows","Focus: Resources","Focus: Desktop"]},{"title":"The chef-solo binstubs need to use the Chef::Application::Client class","body":"We really need to look at inverting the way that we invoke the Chef::Application::Solo class and then trampoline out of that into Chef::Application::Client when we are in zolo mode and not legacy chef-solo.  Instead we should invoke Chef::Application::Client and then only trampoline out when we are in legacy mode, making legacy-mode the special handling case.\r\n\r\nThis means that command line parsing will have to be made consistent between the classes (and is probably a good thing -- reducing code duplication and interface drift between the two classes).  The Chef::Application::Solo class should also likely have its CLI arguments removed, and all the code duplication should really get removed as much as possible.\r\n\r\nIn the end it would be best to have only Chef::Application::Client exist with special-casing around the legacy mode operation of chef-solo (although its also legacy and at some point we should deprecate that behavior, but that requires fixing the perf issues in ChefFS).","comments":["See #8361, #8360 and #6375","Listed as breaking change since ultimately Chef::Application::Solo going away as a class ","Also #8138 is related","#8744 is work towards fixing this"],"labels":["Type: Breaking Change","Focus: Chef Solo"]},{"title":"Chef solo with --user drops permissions after it has created artifacts","body":"## Description\r\nWhen using `chef-solo --user foo --recipe-url` the cache directory (and others) has to be preconfigured to be owned by 'foo'.\r\n\r\n## Chef Version\r\n14.11.21\r\n\r\n## Platform Version\r\nUbuntu Linux 18.04.2\r\n\r\n## Replication Case\r\nfrom @teknofire:\r\n\r\ncreate \/tmp\/solo.rb:\r\n```\r\nfile_cache_path \"\/tmp\/chef-solo\/cache\/\"\r\nfile_backup_path \"\/tmp\/chef-solo\/backup\/\"\r\ncookbook_path \"\/tmp\/chef-solo\/recipes\/cookbooks\/\"\r\nlog_level :info\r\n```\r\nthen run:\r\n```\r\nchef-solo --format doc --recipe-url https:\/\/github.com\/teknofire\/chef-solo-test\/releases\/download\/v1.0\/chef-solo.tar.gz --user opscode --override-runlist 'recipe[testing]' --config \/tmp\/solo.rb \r\n```\r\n\r\n## Client Output\r\n```\r\n[2019-04-11T16:48:57-04:00] INFO: About to change privilege to opscode\r\n[2019-04-11T16:48:57-04:00] INFO: Started chef-zero at chefzero:\/\/localhost:1 with repository at \/tmp\/chef-solo\/recipes\r\n  One version per cookbook\r\n\r\n[2019-04-11T16:48:57-04:00] FATAL: Errno::EACCES: Permission denied @ dir_s_mkdir - \/tmp\/chef-solo\/cache\r\n```\r\n","comments":["This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.","This fairly bad broke chef-solo by implicitly moving the Dir.chdir(\"\/\") early:\r\n\r\n```\r\n% chef-solo -c .\/solo.rb file.rb\r\n[2019-09-10T14:47:49-07:00] WARN: *****************************************\r\n[2019-09-10T14:47:49-07:00] WARN: Did not find config file: \/solo.rb. Using command line options instead.\r\n[2019-09-10T14:47:49-07:00] WARN: *****************************************\r\n[2019-09-10T14:47:49-07:00] FATAL: Invalid arguments are not supported by the chef-client: \"file.rb\"\r\n```\r\n\r\nCorrect behavior:\r\n\r\n```\r\n% chef-solo -c .\/solo.rb file.rb\r\nStarting Chef Infra Client, version 15.3.11\r\nresolving cookbooks for run list: [\"test::test\"]\r\nSynchronizing Cookbooks:\r\n  - test (0.0.1)\r\nInstalling Cookbook Gems:\r\nCompiling Cookbooks...\r\nfoo\r\nConverging 0 resources\r\nOhai! I have started a converge.\r\n\r\nRunning handlers:\r\nRunning handlers complete\r\nChef Infra Client finished, 0\/0 resources updated in 05 seconds\r\n```"],"labels":["Type: Bug"]},{"title":"Windows permissions convergence on every run due to lack of Synchronize permission support","body":"## Description\r\nWithin our chef cookbooks on Windows, we need to include the synchronize permission on our directories, which is not currently an option for the windows file\/directory resources. To get around this, we are using the bitmask to set those permissions to give us a bit more granular control over what permissions are set.\r\n\r\nThe problem is that we end up with those resources converging on every run of the chef client, keeping our cookbooks from being idempotent.\r\n\r\nI've included below in the replication section a cookbook that can be spun up in the kitchen environment that replicates the issue we are seeing.\r\n\r\n## Chef Version\r\nChef Client: Exists in both 14.10.9-1 and 13.6.0, and i'm guessing anything in between\r\n\r\n## Platform Version\r\nOS: Windows server 2016 (happens in Windows server 2012 and 2008r2 as well)\r\nChef Client: Tested in both 14.10.9-1 and 13.6.0\r\n\r\n## Replication Case\r\nI've created a public cookbook that simulates what we are accomplishing that can be run in test-kitchen with the vagrant plugin.\r\n\r\n[Perms-Cookbook](https:\/\/github.com\/bm7150\/perms-cookbook)\r\n\r\nJust download and run kitchen converge multiple times (was never able to get the multiple_converge option to work in my kitchen.yml, might be a local issue though). You can see during the directory task `- change dacl` appears each time.\r\n\r\n## Client Output\r\nLink to gist with relevant output:\r\n\r\n[Client-Output](https:\/\/gist.github.com\/bm7150\/5c0b41067ab43212800568f8a7aff1bd)","comments":[],"labels":["Platform: Windows","Triage: Feature Request","Focus: Resources","Focus: Desktop"]},{"title":"Snap Track support in the snap_package resource","body":"### Describe the Enhancement:\r\nSupport the concept of snap tracks as defined on [`snapcraft.io`](https:\/\/snapcraft.io\/blog\/snaps-add-flexibility-with-tracks). Likely via the addition of a new `track` property on the resource. The `node` snap is used as an example in this request, but this isn't limited in scope to that particular snap.\r\n\r\n### Describe the Need:\r\nOne of the snaps we're using is `node`, and it's not possible with the current implementation to install any of the `stable` channels from this list, because the `latest` track is [hardcoded](https:\/\/github.com\/chef\/chef\/blob\/2d9aaaa000e3973435e715d5ff45309a0674b50d\/lib\/chef\/provider\/package\/snap.rb#L313), and as shown below, the only channel on the `latest` track of this snap is `edge`.\r\n\r\n```sh\r\n$ curl -sS --unix-socket \/run\/snapd.socket 'http:\/\/host\/v2\/find?name=node' \\\r\n  | jq '.result[0].channels | keys'\r\n[\r\n  \"10\/stable\",\r\n  \"6\/stable\",\r\n  \"8\/stable\",\r\n  \"9\/stable\",\r\n  \"latest\/edge\"\r\n]\r\n```\r\n\r\n### Current Alternative\r\n\r\nUsing the `execute` resource to fire the typical CLI commands, using a library to monkey patch the existing resource, or rolling one's own RP, none of which are a great UX.\r\n\r\n### Can We Help You Implement This?:\r\n\r\nThe API exposes valid tracks for a snap, so hopefully this would be not too much more than a case of mirroring the current implementation's approach to channels, with potential scope to factor out commonalities. An API example for fetching tracks is provided below:\r\n\r\n```sh\r\n$ curl -sS --unix-socket \/run\/snapd.socket 'http:\/\/host\/v2\/find?name=node' \\\r\n  | jq '.result[0].tracks'\r\n[\r\n  \"latest\",\r\n  \"10\",\r\n  \"9\",\r\n  \"8\",\r\n  \"6\"\r\n]\r\n```\r\n","comments":["@tas50 would it be possible to get a `Status: Untriaged` label on this so it gets caught in the next review sweep please?"],"labels":["Triage: Feature Request","Platform: Debian-like","Focus: Resources"]},{"title":"knife upload should warn if nothing was uploaded","body":"# Description\r\n\r\n`knife upload` does not print a warning when nothing was uploaded.\r\n\r\n# ChefDK Version\r\n\r\nChef Workstation: 0.2.43\r\n\r\n# Platform Version\r\n\r\n4.19.13-1-MANJARO Linux\r\n\r\n# Replication Case\r\n\r\nRun `knife upload myCookbook`. Everything looks fine although the user probably did something wrong.\r\n\r\n# Stacktrace\r\n```\r\n[chef-repo]$ knife upload myCookbook\r\nUsing deployment: testdeployment01\r\n```\r\n","comments":["@jbaumcloud I'm going to move this issue to the chef repo itself since that's where knife upload comes from.","Thanks :)"],"labels":["Aspect: UX","Focus: knife"]},{"title":"Deprecation: Remove osc_compat and repo_mode of \"everything\"","body":"We still have compatibility with existing Chef 11 server behavior within chef-client. We should remove this support at this point and only support chef-zero in Chef Server 12+ org style mode.","comments":["I'm guessing you mean we support both \/organization\/<ORGNAME>\/<some_resource> (enterprise chef and chef server 12) and \/<some_resource> (open source chef 11) api endpoints. I think we should be good to deprecate support for the latter. ","Well it's not going to happen with Chef 15, but we can get this throwing an error and then remove it in Chef 16."],"labels":["Type: Chore","Type: Deprecation"]},{"title":"Improved event handler APIs","body":"### Describe the Enhancement:\r\n\r\nSeveral fixes\/additions to the event handlers would be really useful:\r\n\r\n## ohai_complete missing\r\n:ohai_complete exists but not :ohai_start - can we get start time?\r\n\r\n## deprecation improvements\r\n* :deprecation requires one to do a work to format it the way Chef will. So you can't just:\r\n\r\n```\r\non :deprecation do |dep|\r\n  # do thing with dep.message\r\nend\r\n```\r\n\r\nInstead you have to \r\n```\r\non :deprecation do |dep|\r\n  dep_warn = \"#{dep.message.to_s} (CHEF-#{dep.id})#{dep.location}.\"\r\n  # do thing with dep_warn\r\nend\r\n```\r\n\r\nIt'd be nice if `dep` had a `formatted_message` or some-such like exceptions have `formatted_exception`.\r\n\r\n# warnings\r\nthere is no `:warning` - we should be able to do work on warnings :)\r\n","comments":[],"labels":["Priority: Low"]},{"title":"Console output shows extra info","body":"<!---\r\n!!!!!! NOTE: CHEF CLIENT BUGS ONLY !!!!!!\r\n\r\nThis issue tracker is for the code contained within this repo -- `chef-client`, base `knife` functionality (not\r\nplugins), `chef-apply`, `chef-solo`, `chef-client -z`, etc.\r\n\r\n* Requests for new or alternative functionality should be made to [feedback.chef.io](https:\/\/feedback.chef.io\/forums\/301644-chef-product-feedback\/category\/110832-chef-client)\r\n* [Chef Server issues](https:\/\/github.com\/chef\/chef-server\/issues\/new)\r\n* [ChefDK issues](https:\/\/github.com\/chef\/chef-dk\/issues\/new)\r\n* Cookbook Issues (see the https:\/\/github.com\/chef-cookbooks repos or search [Supermarket](https:\/\/supermarket.chef.io) or GitHub\/Google)\r\n\r\n-->\r\n\r\n## Description\r\nIn 14.5.33 when `chef-client` is run interactively in a terminal the output looked like this: \r\n\r\n```\r\nRecipe: base::init\r\n  * ohai_hint[ec2] action create\r\n    * directory[\/etc\/chef\/ohai\/hints] action create (up to date)\r\n    * file[\/etc\/chef\/ohai\/hints\/ec2.json] action create (up to date)\r\n     (up to date)\r\n```\r\n\r\nAfter upgrading to 14.6.47 and also 14.7.17, the output now shows \"INFO Processing\" on the same line:\r\n\r\n```\r\nRecipe: base::init\r\n  * ohai_hint[ec2] action create[2018-12-07T22:01:39+00:00] INFO: Processing ohai_hint[ec2] action create (base::init line 14)\r\n\r\n    * directory[\/etc\/chef\/ohai\/hints] action create[2018-12-07T22:01:39+00:00] INFO: Processing directory[\/etc\/chef\/ohai\/hints] action create (\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.6.47\/lib\/chef\/resource\/ohai_hint.rb line 43)\r\n (up to date)\r\n    * file[\/etc\/chef\/ohai\/hints\/ec2.json] action create[2018-12-07T22:01:39+00:00] INFO: Processing file[\/etc\/chef\/ohai\/hints\/ec2.json] action create (\/opt\/chef\/embedded\/lib\/ruby\/gems\/2.5.0\/gems\/chef-14.6.47\/lib\/chef\/resource\/ohai_hint.rb line 48)\r\n (up to date)\r\n     (up to date)\r\n```\r\n\r\nI have this logging config in `\/etc\/chef\/client.d\/logging.rb`:\r\n\r\n```\r\nlog_level :info\r\nlog_location Chef::Log::Syslog.new(\"chef-client\", ::Syslog::LOG_DAEMON)\r\n```\r\n\r\nIf I remove the `log_level` the output looks like it did in 14.5. I also did not encounter this with the same config on Chef 12.\r\n\r\n## Chef Version\r\n<!--- Tell us which version of chef-client you are using (see below for Server+ChefDK bugs). -->\r\n14.6.47+\r\n\r\n## Platform Version\r\n<!--- Tell us which Operating System distribution and version chef-client is running on. -->\r\nAmazon Linux 2018.03\r\n\r\n## Replication Case\r\n<!--- Tell us what steps to take to replicate your problem.  See [How to create a Minimal, Complete, and Verifiable example](https:\/\/stackoverflow.com\/help\/mcve)\r\nfor information on how to create a good replication case. -->\r\n\r\nRun `chef-client` in an SSH terminal.\r\n\r\n## Client Output\r\n<!--- The relevant output of the chef-client run or a link to a gist of the entire run, if there is one.\r\n\r\nThe debug output (chef-client -l debug) may be useful, but please link to a gist, or truncate it. -->\r\n\r\nSee above.\r\n\r\n\r\n## Stacktrace\r\n<!--- Please include the stacktrace.out output or link to a gist of it, if there is one. -->\r\n","comments":["probably #7698 which went into 14.6.36","actually that looks more or less entirely correct based on what you told the log system to do.   is it fixed if you use `log_level :auto`?","and what is showing up in the syslog when you try different values of `log_level`, and how did it behave before (and what is the desired behavior)?","If I set `log_level :auto`, the interactive terminal output looks good - like pre-14.6.36 output. However, nothing is logged to syslog. With `log_level :auto`, when the daemon runs non-interactively the INFO logging I'd expect is logged to syslog. ","Any update on this issue? In `14.5.33` when using `:auto` (to fix the problem with double lines stuck together) and `log_location = \/var\/log\/file.txt`, the chef-client is showing the log while executing manually, on interactive terminal. However, when it runs non-interactively as daemon (systemd service) then nothing appears in `\/var\/log\/file.txt`. And according to [documentation](https:\/\/docs.chef.io\/config_rb_client.html):\r\n\r\n```\r\nlog_level\r\nThe level of logging to be stored in a log file. Possible levels: :auto (default), :debug, :info, :warn, :error, or :fatal. Default value: :warn (when a terminal is available) or :info (when a terminal is not available).\r\n```\r\n\r\nit should behave as if `:info` was set, when there is no terminal available. Or am I wrong? How to remove double lines problem while still getting logs logged according to `log_location` setting?","@eheydrick is this still an issue for you?","@tas50 nothing new to report here, still running same version and config with the same output.","Note to self: Next time in Seattle take Eric's laptop and upgrade his chef client."],"labels":["Status: Waiting on Contributor"]},{"title":"Securable needs to use properties for resource self documentation","body":"Our securable mixin (https:\/\/github.com\/chef\/chef\/blob\/master\/lib\/chef\/mixin\/securable.rb) does not currently use properties, which means these don't show up in any sort of resource documentation. We need to convert them to properties and probably add some better validation error messages as well since they have massive regexes that will fail validation with no explanation.","comments":[],"labels":["Priority: Medium","Type: Chore","documentation"]},{"title":"powershell_script resource should be available on linux systems","body":"### Describe the Enhancement:\r\nAllow powershel_script resource to be used on linux systems where powershell_core is installed.\r\n\r\n### Describe the Need:\r\nI'm making a cookbooks, that could be executed on both linux & windows platform.\r\nWithin these cookbooks I offten need to execute some small scripts. On windows it is powershell_scripts and on linux I'm forced to use bash.\r\nIt is possible nowdays to have powershell core installed on Linux. When it is installed it should be possible to execute powershell_script resource on linux systems direcly.\r\n\r\n### Current Alternative\r\nThere is no alternative - to use powershell scripts on Linux I need to encapsulate them in bash scripts\r\n\r\n### Can We Help You Implement This?:\r\nI'm a good Ruby developer, but know nothing about how chef is implemented.","comments":["Should this utilize the existing `powershell_script` resource with added support for Powershell Core (which may cause confusion on the Windows side where both core and full are installed?) Or should a new `powershellcore_script` resource be created?","From my needs - run the same cookbook on windows and linux it should the same resource, that will be available on both OSes."],"labels":["Platform: Linux","Triage: Feature Request","Focus: Resources"]},{"title":"Add windows_license resource to Chef","body":"### Core Chef Resource Checklist\r\n\r\nBefore suggesting a resource for inclusion please make sure your suggestion meets these criteria for resources built into Chef:\r\n - [x] Automates an operating system component that ships by default on systems such as authentication, raid, disk partitions, firewalls, containers, or virtualization systems.\r\n - [x] Does not attempt automate 3rd party applications such as database, web, or application servers, which are best suited for cookbooks due to their fast moving nature.\r\n\r\n### Describe the resource:\r\nApplies a windows license. This is a routine operation which normally involves running `slmgr.vbs`.\r\n\r\n### Why should this be included out of the box?:\r\nApplying a license to windows server installations is a routine operation.\r\n\r\n### What operating systems would it run on?\r\nWindows\r\n\r\n### Current cookbook implementation:\r\nNone as of yet.\r\n","comments":["Design Proposal\r\n\r\nWhile there are a number of possible scenarios for activation, there are two main use cases that make up the majority of the actual activation tasks:\r\n1. MAK activation, i.e. direct activation of a windows system.\r\n2. KMS activation, using a remote server to facilitate the activation.\r\n\r\nSpecification\r\n\r\nI think the resource could be designed with one action, `:activate` and one property, `product_key`. If a product key is provided, install the product key, then activate. If no product key is specified, activate against KMS. The KMS option assumes that the user has their KMS servers configured properly and the appropriate DNS entries are available for auto-discovery.\r\n\r\nOnce a system is activated, it's not normally necessary to re-activate so the initial version of this resource would check the output of `slmgr.vbs \/dli` for `License Status:` to determine if it should converge or not.\r\n\r\nExample\r\n\r\n```windows_license 'Activate Windows' do\r\n  action :activate\r\n  product_key xxxxx-xxxxx-xxxxx-xxxxx-xxxxx\r\nend```","Would we want to support using non-default KMS servers? If I'm reading this right the default is to created a SRV record on the domain, but you can override that if you want to either activate against a different server or don't have DNS setup like that.","I think we'd eventually want to add several options for it. I'm looking at it at the MVP level and making some assumptions. Setting the DNS entries is part of the normal process when you setup a KMS server so the majority of folks will have them.","@tas50 I thought this through a little more and found a way to add some more options relatively easy.\r\n\r\nAvailable properties:\r\n* `product_key` - Full key in `xxxxx-xxxxx-xxxxx-xxxxx-xxxxx` format\r\n* `skms_server` - Specify the KMS FQDN\r\n* `skms_port` - Port for KMS server (defaults to 1688)\r\n* `skms_domain` - Specify domain to use for KMS DNS lookup\r\n\r\nAvailable actions (all actions call `slmgr`):\r\n* `:activate` - Use `\/ato` option, include `\/ipk product_key` and kms options if specified.\r\n* `:clear` - Use `\/cpky` to clear product key from the registry (prevents disclosure attacks)\r\n* `:rearm` - Use `\/rearm` to reset the licensing status of the machine\r\n\r\nI built the base of it in a cookbook here: https:\/\/github.com\/jmassardo\/windows_license"],"labels":["Platform: Windows","Triage: Feature Request","Focus: Resources","Focus: Desktop"]},{"title":"Add winrm_listener_config resource to chef","body":"### Core Chef Resource Checklist\r\n\r\nBefore suggesting a resource for inclusion please make sure your suggestion meets these criteria for resources built into Chef:\r\n - [x] Automates an operating system component that ships by default on systems such as authentication, raid, disk partitions, firewalls, containers, or virtualization systems.\r\n - [x] Does not attempt automate 3rd party applications such as database, web, or application servers, which are best suited for cookbooks due to their fast moving nature.\r\n\r\n### Describe the resource:\r\nThe winrm_config resource would allow you to configure winrm settings on a host.\r\n\r\n### Why should this be included out of the box?:\r\nWinRM is something that just about every Windows admin needs to configure. We should help make that super easy so you can bootstrap a node and WinRM just works.\r\n\r\n### What operating systems would it run on?\r\nWindows\r\n\r\n### Current cookbook implementation:\r\nhttps:\/\/github.com\/criteo-cookbooks\/winrm-config and https:\/\/github.com\/sous-chefs\/winrm","comments":["I've started work to clean up the Sous Chefs resource with proper idempotency. With a few days of work we should be able to ship this in Chef 15."],"labels":["Platform: Windows","Triage: Feature Request","Focus: Resources","Focus: Desktop"]},{"title":"Add logrotate resource to chef-client","body":"### Core Chef Resource Checklist\r\n\r\nBefore suggesting a resource for inclusion please make sure your suggestion meets these criteria for resources built into Chef:\r\n - [x] Automates an operating system component that ships by default on systems such as authentication, raid, disk partitions, firewalls, containers, or virtualization systems.\r\n - [x] Does not attempt automate 3rd party applications such as database, web, or application servers, which are best suited for cookbooks due to their fast moving nature.\r\n\r\n### Describe the resource:\r\nThis would allow you to configure log rotation on services and apps\r\n\r\n### Why should this be included out of the box?:\r\nlog rotate is a core OS function to make sure services like chef have properly rotated logs. It's something you often want to do and we should make it happen out of the box.\r\n\r\n### What operating systems would it run on?\r\nLinux\r\n\r\n### Current cookbook implementation:\r\nhttps:\/\/github.com\/stevendanna\/logrotate","comments":[],"labels":["Platform: Unix-like","Triage: Feature Request","Focus: Resources"]},{"title":"Add macos_keychain resource to chef-client","body":"### Core Chef Resource Checklist\r\n\r\nBefore suggesting a resource for inclusion please make sure your suggestion meets these criteria for resources built into Chef:\r\n - [x] New functionality includes testsAutomates an operating system component that ships by default on systems such as authentication, raid, disk partitions, firewalls, containers, or virtualization systems.\r\n - [x] New functionality includes testsDoes not attempt automate 3rd party applications such as database, web, or application servers, which are best suited for cookbooks due to their fast moving nature.\r\n\r\n### Describe the resource:\r\nThis resource will allow you to add or remove keychains on macos systems\r\n\r\n### Why should this be included out of the box?:\r\nThis is a pretty core part of macos that you'd want for managing end user systems\r\n\r\n### What operating systems would it run on?\r\nmacos\r\n\r\n### Current cookbook implementation:\r\nhttps:\/\/github.com\/Microsoft\/macos-cookbook\/blob\/master\/resources\/keychain.rb","comments":[],"labels":["Platform: macOS","Triage: Feature Request","Focus: Resources","Focus: Desktop"]},{"title":"Powershell Add-AppxPackage not working for standard user (only admin)","body":"Hopefully this is the right place (sorry if its not). I am currently trying to side load an appx (UWP) in test kitchen. However it does not work for a standard user. When I set it to an admin account, it works (but that only installs the app for that admin user - I need it installed for a deescalated user). I suspect this is a bug in remote Powershell?\r\n\r\n**Output:**\r\n```ruby\r\nSTDERR: C:\\Users\\....\\AppData\\Local\\Temp\\chef-script20181023-3108-f0qjq7.ps1 : Win32 internal error \"Access is denied\" 0x5 \r\n       \r\n       occurred while reading the console output buffer. Contact Microsoft Customer Support Services.\r\n```\r\n\r\n**Code:**\r\n```ruby\r\npowershell_script 'Install Appx' do\r\n     code 'Add-AppxPackage Example_1.0.0.0.appx'\r\n     cwd 'C:\\...'\r\n     user \"standardUserHere\"\r\n     password \"password\"\r\n     sensitive false\r\nend\r\n```\r\n\r\nEdit: The command also works on the box itself when I login as the standard user and it copy into powershell","comments":["@jeremy-qik Can you provide the relevant parts of your kitchen.yml file?  Are you running this with `elevated: true` in your winrm transport?  Have you tried running your code directly on the target machine rather than remotely over a winrm connection, also have you tried shelling out to `runas \/user standarduser` then running `powershell -command Add-AppxPackage` etc. to see if that makes any difference?","Hi @stuartpreston \r\n\r\nThanks for you response.\r\nI have tried logging in as the standard user and running the commands in powershell manually and it works. \r\n\r\n---\r\nIf I change the user running in power shell to the admin (non elevated in the powershell_script it works).\r\n\r\ne.g.\r\n```\r\npowershell_script 'Install Appx' do\r\n     code 'Add-AppxPackage Example_1.0.0.0.appx'\r\n     cwd 'C:\\...'\r\n     user \"adminUser\"\r\n     password \"adminPassword\"\r\n     sensitive false\r\nend\r\n```\r\n\r\n---\r\n\r\n**Runas**\r\n```\r\nPS C:\\Users\\adminUser> runas \/user:'standardUser' \u201cpowershell\u201d\r\nrunas \/user:'standardUser' powershell\r\nEnter the password for standardUser:\r\nAttempting to start powershell as user \"DESKTOP-...\\standardUser\" ...\r\n```\r\n(in the new Window that popped up)\r\n```\r\nPS C:\\Windows\\system32> whoami\r\ndesktop-...\\standardUser\r\n...(cd to dir)\u2026\r\nPS C:\\Dir> Add-AppxPackage Example_1.0.0.0_x64.appx\r\n```\r\nAnd it works (`Get-AppxPackage -Name *Example*` reports app successfully installed) \r\n\r\n---\r\n\r\n**.kitchen.yml**\r\n```\r\n---\r\ndriver:\r\n  name: vagrant\r\n  communicator: winrm\r\n\r\nprovisioner:\r\n  name: chef_zero\r\n  always_update_cookbooks: true\r\n  #log_level: info\r\n\r\nverifier:\r\n  name: inspec\r\n\r\ntransport:\r\n  name: winrm\r\n  guest: windows\r\n  elevated: true\r\n\r\nplatforms:\r\n  - name: windows\r\n    os_type: windows\r\n    driver:\r\n      box: image_name_here\r\n    driver_config:\r\n      username: adminUser\r\n      password: adminPass\r\n\r\nsuites:\r\n  - name: default\r\n    data_bags_path: \"test\/integration\/data_bags\"\r\n    run_list:\r\n    - recipe[...]\r\n    verifier:\r\n    inspec_tests:\r\n        - test\/integration\/default\r\n```\r\n\r\nI have tried various other configs permutations this morning to try and fix the issue and no luck (such as removing the elevated).\r\n\r\n---\r\n\r\n**Versions**\r\n\r\n```\r\n$ chef --version\r\nChef Development Kit Version: 3.2.30\r\nchef-client version: 14.4.56\r\ndelivery version: master (6862f27aba89109a9630f0b6c6798efec56b4efe)\r\nberks version: 7.0.6\r\nkitchen version: 1.23.2\r\ninspec version: 2.2.70\r\n```\r\n\r\n```\r\n$vagrant --version\r\nVagrant 2.0.4\r\n```\r\n\r\n```\r\nVirtualbox: 5.2.18\r\n```","That is strange, as when you run with `elevated: true` Test Kitchen will create a scheduled task on the remote computer.  So this should mimic exactly Chef Client running as the specified user on the target machine.  Though usually Chef Client is running as System if installed as a Scheduled Task or even the Windows Service so perhaps you could try with adding:\r\n\r\n```yml\r\nelevated_username: System\r\nelevated_password: null\r\n```\r\nUnderneath the existing `elevated: true` setting in your transport.","I tried adding (below) but same issue. I also tried placing the elevated_username\/elevated_password under driver_config as well\r\n\r\n```\r\n---\r\ndriver:\r\n  name: vagrant\r\n  communicator: winrm\r\n\r\nprovisioner:\r\n  name: chef_zero\r\n  always_update_cookbooks: true\r\n  #log_level: info\r\n\r\nverifier:\r\n  name: inspec\r\n\r\ntransport:\r\n  name: winrm\r\n  guest: windows\r\n  elevated: true\r\n  elevated_username: System\r\n  elevated_password: null\r\n\r\nplatforms:\r\n  - name: windows\r\n    os_type: windows\r\n    driver:\r\n      box: image_name_here\r\n    driver_config:\r\n      username: adminUser\r\n      password: adminPass\r\n\r\nsuites:\r\n  - name: default\r\n    data_bags_path: \"test\/integration\/data_bags\"\r\n    run_list:\r\n    - recipe[...]\r\n    verifier:\r\n    inspec_tests:\r\n        - test\/integration\/default\r\n```\r\n\r\n```\r\nSTDOUT: \r\n       STDERR: C:\\Windows\\Temp\\chef-script20181024-5088-ld3fe7.ps1 : Win32 internal error \"Access is denied\" 0x5 occurred while \r\n       \r\n       reading the console output buffer. Contact Microsoft Customer Support Services.\r\n       \r\n       \r\n       ---- End output of \"C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -InputFormat None -File \"C:\/Windows\/Temp\/chef-script20181024-5088-ld3fe7.ps1\" ----\r\n```","If you have a look into your tempdir on the remote machine there should be a kitchen folder containing all your cookbooks.  Does the powershell_script execute correctly if you use chef-apply?  Trying to figure out if it's really a Chef Client problem or just a PowerShell one because it's over winrm.","I am having a look at the scripts now.\r\n\r\nI did notice that Chef calls Powershell 1 (`C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe`) . I thought it might be related, but does not appear to be the case.\r\n\r\nI made a test and got some output (not sure if its helpful). Has a little more info.\r\n\r\n```\r\nbatch 'App Install' do\r\n    code <<-EOH\r\n        powershell -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -InputFormat None -Command \"Add-AppxPackage -Path \\\u201dc:\/test\/Example_1.0.0.0_x64.appx\\\"\"\r\n    EOH\r\n    cwd \"c:\/test\"\r\n    user \u201cstandardUser\u201d\r\n    password \u201cstandardUserPassword\u201d\r\n    sensitive false\r\nend\r\n```\r\n\r\n```\r\n[2018-10-24T15:52:20+01:00] FATAL: Mixlib::ShellOut::ShellCommandFailed: batch[App Install] (app::install line 47) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '1'\r\n       ---- Begin output of \"C:\\Windows\\system32\\cmd.exe\" \/c \"C:\/Windows\/Temp\/chef-script20181024-3296-195dfql.bat\" ----\r\n       STDOUT: C:\\Test\\Example_1.0.0.0_x64>powershell -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -InputFormat None -Command \"Add-AppxPackage -Path \u201cC:\/test\/Example_1.0.0.0_x64.appx\"\"\r\n       STDERR: Add-AppxPackage : Win32 internal error \"Access is denied\" 0x5 occurred while reading the console output buffer. \r\n       \r\n       Contact Microsoft Customer Support Services.\r\n       \r\n       At line:1 char:1\r\n       \r\n       + Add-AppxPackage -Path C:\\Test\\Example_1.0.0.0_x64...\r\n       \r\n       + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n       \r\n           + CategoryInfo          : ReadError: (:) [Add-AppxPackage], HostException\r\n       \r\n           + FullyQualifiedErrorId : ReadConsoleOutput,Microsoft.Windows.Appx.PackageManager.Commands.AddAppxPackageCommand\r\n       ---- End output of \"C:\\Windows\\system32\\cmd.exe\" \/c \"C:\/Windows\/Temp\/chef-script20181024-3296-195dfql.bat\" ----\r\n       Ran \"C:\\Windows\\system32\\cmd.exe\" \/c \"C:\/Windows\/Temp\/chef-script20181024-3296-195dfql.bat\" returned 1\r\n```","Testing Running the Powershell script manually.\r\n\r\n**Chef**\r\nNote: I added the sleep to keep the ps1 in the `C:\\Windows\\Temp` directory. Chef seems to delete them after the run completes.\r\n\r\n```\r\npowershell_script 'App Install' do\r\n    code <<-EOH\r\n        sleep 20\r\n        Add-AppxPackage -Path \"#{app_installer_full_path}\/Example_1.0.0.0_x64.appx\"\r\n    EOH\r\n    user \"standardUser\"\r\n    password \"standardPass\"\r\n    sensitive false\r\nend\r\n```\r\n\r\n---\r\n\r\n**Run output**\r\n```\r\n       Running handlers:\r\n       [2018-10-24T17:10:46+01:00] ERROR: Running exception handlers\r\n       Running handlers complete\r\n       [2018-10-24T17:10:46+01:00] ERROR: Exception handlers complete\r\n       Chef Client failed. 0 resources updated in 44 seconds\r\n       [2018-10-24T17:10:46+01:00] FATAL: Stacktrace dumped to C:\/Users\/\u2026\/AppData\/Local\/Temp\/kitchen\/cache\/chef-stacktrace.out\r\n       [2018-10-24T17:10:46+01:00] FATAL: Please provide the contents of the stacktrace.out file if you file a bug report\r\n       [2018-10-24T17:10:46+01:00] FATAL: Mixlib::ShellOut::ShellCommandFailed: powershell_script[App Install] (recipe::app-install line 31) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '1'\r\n       ---- Begin output of \"C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -InputFormat None -File \"C:\/Windows\/Temp\/chef-script20181024-6304-1aoo602.ps1\" ----\r\n       STDOUT: \r\n       STDERR: C:\\Windows\\Temp\\chef-script20181024-6304-1aoo602.ps1 : Win32 internal error \"Access is denied\" 0x5 occurred while \r\n       \r\n       reading the console output buffer. Contact Microsoft Customer Support Services.\r\n       \r\n       \r\n       ---- End output of \"C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -InputFormat None -File \"C:\/Windows\/Temp\/chef-script20181024-6304-1aoo602.ps1\" ----\r\n       Ran \"C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -InputFormat None -File \"C:\/Windows\/Temp\/chef-script20181024-6304-1aoo602.ps1\" returned 1\r\n$$$$$$         + CategoryInfo          : NotSpecified: (:) [Write-Error], WriteErrorException\r\n$$$$$$         + FullyQualifiedErrorId : Microsoft.PowerShell.Commands.WriteErrorException,chef-script20181024-6304-1aoo602.ps1\r\n$$$$$$     + CategoryInfo          : NotSpecified: (:) [Write-Error], WriteErrorException\r\n$$$$$$     + FullyQualifiedErrorId : Microsoft.PowerShell.Commands.WriteErrorException,chef-script20181024-6304-1aoo602.ps1\r\n```\r\n\r\n---\r\n\r\n**Running the script on the machine**\r\nNote: From the admin account\r\nNote: I copied the Powershell files from C:\\Windows\\Temp to C:\\Test\r\n\r\n```\r\nWindows PowerShell\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nPS C:\\Users\\AdminUser> runas \/user:\u2019standardUser\u2019 powershell\r\n```\r\n\r\n\r\n```\r\nWindows PowerShell\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nPS C:\\Windows\\system32> cd c:\/Test\r\nPS C:\\Test> ls\r\n\r\n\r\n    Directory: C:\\Test\r\n\r\n\r\nMode                LastWriteTime         Length Name\r\n----                -------------         ------ ----\r\n-a----       24\/10\/2018     17:10           2460 chef-script20181024-6304-1aoo602.ps1\r\n-a----       24\/10\/2018     17:10            137 chef_powershell_script-user-code20181024-6304-1tdp3ts.ps1\r\n-a----       24\/10\/2018     17:09            448 winrm-elevated-shell-75ba627d-55b9-4902-a780-4623623a0ee2.ps1\r\n\r\n\r\nPS C:\\Test> whoami\r\ndesktop-rnv1bpf\\standardUser\r\n\r\nPS C:\\Test> & \"C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -InputFormat None -File \"C:\/Test\/chef-script20181024-6304-1aoo602.ps1\"\r\n```\r\n\r\n---\r\n\r\n**Testing shows it has installed (using)**\r\n```\r\nPS C:\\Users\\Admin> Get-AppxPackage -AllUsers -Name *example*\r\n```\r\n","**Testing the recipe manually**\r\n\r\n```\r\nPS C:\\Users\\Admin> chef-apply C:\\Users\\Admin\\AppData\\Local\\Temp\\kitchen\\cookbooks\\app\\recipes\\app-install.rb\r\nRecipe: (chef-apply cookbook)::(chef-apply recipe)\r\n  * powershell_script[App Install] action run\r\n    - execute \"C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -InputFormat None -File \"C:\/Users\/Admin\/AppData\/Local\/Temp\/chef-script20181024-8004-12dpfwp.ps1\"\r\n```\r\n\r\n```\r\nget-appxpackage -allusers -name *example*\r\n```\r\nShows it has installed.\r\n\r\nSo I guess this is not a Chef issue and is a WinRM issue? If so where do I go to report this? :)\r\nI might have to see if I can test this on a real machine (not using Kitchen - I guess this means it will not use WinRM and possibly work). Only other thing I can think of, is it ","Mm, well in theory that's good and shows that beyond Test Kitchen your recipe is likely to work.  It possibly points to a Local Security Policy that Admin has that System does not.  Have you tried setting the elevated user to Admin and seeing if that works?  Otherwise, yes it does sound as if there's some WinRM oddity here.","I exported the Group Policy as XML and HTML for both users. Its not something I am very familiar with but I could not see any differences that could explain this (except for the admin policy part).\r\n\r\n```\r\nPS C:\\Users\\Admin> gpresult \/USER \"admin\" \/H \"C:\\\\admin.html\"\r\nPS C:\\Users\\Admin> gpresult \/USER \"standardUser\" \/H \"C:\\\\standardUser.html\"\r\n```\r\n\r\n```\r\nPS C:\\Users\\Admin> gpresult \/USER \"admin\" \/X \"C:\\\\admin.xml\"\r\nPS C:\\Users\\Admin> gpresult \/USER \"standardUser\" \/X \"C:\\\\standardUser.xml\"\r\n```\r\n\r\n---\r\n\r\nI also have tried.\r\n\r\n```\r\n$ vagrant winrm --command \"whoami\"\r\ndesktop-...\\admin\r\n\r\n$ vagrant winrm --command \"chef-apply C:\\\\Users\\\\Admin\\\\AppData\\\\Local\\\\Temp\\\\kitchen\\\\cookbooks\\\\app\\\\recipes\\\\app-install.rb\"\r\n```\r\n\r\nAnd it fails with the same error message\r\n\r\n```\r\n STDOUT: \r\n    STDERR: C:\\Users\\Admin\\AppData\\Local\\Temp\\chef-script20181025-1196-thz0dc.ps1 : Win32 internal error \"Access is denied\" 0x5 \r\n\r\n    occurred while reading the console output buffer. Contact Microsoft Customer Support Services.\r\n\r\n        + CategoryInfo          : NotSpecified: (:) [Write-Error], WriteErrorException\r\n\r\n        + FullyQualifiedErrorId : Microsoft.PowerShell.Commands.WriteErrorException,chef-script20181025-1196-thz0dc.ps1\r\n    ---- End output of \"C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -InputFormat None -File \"C:\/Users\/Admin\/AppData\/Local\/Temp\/chef-script20181025-1196-thz0dc.ps1\" ----\r\n    Ran \"C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -InputFormat None -File \"C:\/Users\/Admin\/AppData\/Local\/Temp\/chef-script20181025-1196-thz0dc.ps1\" returned 1\r\n```","How about wherher the standardUser has a profile created already at the point this is executed?  Beyond that I'm out of ideas I'm afraid.  It does seem to be a WinRM-related issue at this point and not something we can address in Chef.","Thanks for your help @stuartpreston . Yeah it is an interesting issue! I have logged in as the standard user, to make sure the profile is created etc.\r\nI finally found a workaround. Its far from ideal, but it might help in pin pointing the issue.\r\n\r\n```\r\nfile \"c:\/app-install.ps1\" do\r\n    content <<-EOH\r\n        cd -path \"C:\/Test\"\r\n\r\n        Add-AppxPackage Example_1.0.0.0_x64.appx -DependencyPath \"Dependencies\\\\x64\\\\A.appx\",\"Dependencies\\\\x64\\\\B.appx\",\"Dependencies\\\\x64\\\\C.appx\"\r\n    EOH\r\nend\r\n```\r\n\r\n```\r\npowershell_script 'App Install' do\r\n    code <<-EOH\r\n        $username = 'standardUser'\r\n        $password = 'passwordHere'\r\n\r\n        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force\r\n        $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword\r\n\r\n        Start-Process -NoNewWindow -Wait -FilePath \"C:\/Windows\/System32\/WindowsPowerShell\/v1.0\/powershell.exe\" -ArgumentList \"-ExecutionPolicy Bypass -File c:\/app-install.ps1\" -Credential $credential\r\n    EOH\r\n    user \"standardUser\"\r\n    password \"passwordHere\"\r\nend\r\n```\r\n\r\nInterestingly if I remove the `-Credential $credential` part it does not work!\r\nNote: I am open to any other (better) idea's","Incase someone else finds this. I thought it might be related to the `-NoProfile` when powershell_script runs, but I tried (below) with no luck\r\n\r\n```\r\nfile \"c:\/app-install.ps1\" do\r\n    content <<-EOH\r\n        cd -path \"C:\/Test\"\r\n\r\n        Add-AppxPackage Example_1.0.0.0_x64.appx -DependencyPath \"Dependencies\\\\x64\\\\A.appx\",\"Dependencies\\\\x64\\\\B.appx\",\"Dependencies\\\\x64\\\\C.appx\"\r\n    EOH\r\nend\r\n```\r\n\r\n```\r\nexecute 'App Install' do\r\n    command \"powershell.exe -NoLogo -NonInteractive -ExecutionPolicy Bypass -InputFormat None -File c:\/app-install.ps1\"\r\n    user \"standardUser\"\r\n    password \"standardPass\"\r\n    cwd \"c:\/Test\"\r\n    #elevated true\r\n    sensitive false\r\nend\r\n```","I have also raised the issue https:\/\/windowsserver.uservoice.com\/forums\/301869-powershell\/suggestions\/35869084-add-appxpackage-chef-winrm-errors-message","I'm not sure if this will apply to your problem or not, but I've just managed to resolve a similar issue (with `Install-WindowsFeature` rather than `Add-AppxPackage`), by disabling the progress bar display beforehand:\r\n\r\n```powershell\r\n$ProgressPreference = \"SilentlyContinue\"\r\n```\r\n\r\nMight be worth a try.","@ryanfitzsimon your work around worked for me.\r\n\r\nThis issue first started happening for us when building based on Windows Server 2019 (never had issues with 2016).\r\n\r\nWe also had to add the $ProgressPreferenc to scripts that used `Invoke-WebRequest`. Basically anything with powershell that tries to show a fancy progress bar blew up."],"labels":["Platform: Windows"]},{"title":"Fix usage of #to_h and #to_hash across our object models","body":"Most objects that aren't really hash like shouldn't implement #to_hash at all.\r\n\r\nObjects like DataBagItem which really are a wrapper around a Hash (which does delegate all its methods to Hash) should implement #to_hash but should return the actual inner @raw_data hash.  Returning the serialized version of the data bag with the json_class, etc is incorrect.  I think we should likely implement a #for_json that returns the serialized hash version which #to_json should call consistently.  Then many not-actually-hash-like objects would drop #to_hash entirely, they would have a #to_h which was aliased to #for_json.  Other actually-hash-like objects would have #to_hash and #to_h that would be aliased together, while #for_json was the serialized version.\r\n\r\nSee #7697 and #7691\r\n\r\n","comments":[],"labels":["Priority: Low","Type: Tech Debt"]}]